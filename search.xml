<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Embedded Programming with the GNU Toolchain</title>
      <link href="/2024/10/17/GNUToolchain/"/>
      <url>/2024/10/17/GNUToolchain/</url>
      
        <content type="html"><![CDATA[<blockquote><p>Origin online url: <a href="https://www.bravegnu.org/gnu-eprog/">https://www.bravegnu.org/gnu-eprog/</a></p><p>github repo: <a href="https://github.com/bravegnu/gnu-eprog/blob/master/gnu-eprog.asciidoc">https://github.com/bravegnu/gnu-eprog/blob/master/gnu-eprog.asciidoc</a></p></blockquote><h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>GNUå·¥å…·é“¾è¶Šæ¥è¶Šå¤šåœ°è¢«ç”¨äºæ·±åº¦åµŒå…¥å¼è½¯ä»¶å¼€å‘ã€‚è¿™ç§ç±»å‹çš„è½¯ä»¶å¼€å‘ä¹Ÿè¢«ç§°ä¸ºç‹¬ç«‹Cç¼–ç¨‹å’Œè£¸æœºCç¼–ç¨‹ã€‚ç‹¬ç«‹Cç¼–ç¨‹å¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼Œå¤„ç†è¿™äº›é—®é¢˜éœ€è¦å¯¹GNUå·¥å…·é“¾æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚GNUå·¥å…·é“¾çš„æ‰‹å†Œæä¾›äº†å…³äºå·¥å…·é“¾çš„æå¥½ä¿¡æ¯ï¼Œä½†ä»å·¥å…·é“¾çš„è§’åº¦ï¼Œè€Œä¸æ˜¯é—®é¢˜çš„è§’åº¦ã€‚å¥½å§ï¼Œæ— è®ºå¦‚ä½•ï¼Œæ‰‹å†Œåº”è¯¥æ˜¯è¿™æ ·å†™çš„ã€‚ç»“æœæ˜¯å¸¸è§é—®é¢˜çš„ç­”æ¡ˆåˆ†æ•£åœ¨å„å¤„ï¼ŒGNUå·¥å…·é“¾çš„æ–°ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘ã€‚</p><p>æœ¬æ•™ç¨‹è¯•å›¾é€šè¿‡ä»é—®é¢˜çš„è§’åº¦è§£é‡Šå·¥å…·æ¥å¼¥åˆå·®è·ã€‚å¸Œæœ›è¿™èƒ½è®©æ›´å¤šäººèƒ½å¤Ÿä½¿ç”¨ GNU å·¥å…·é“¾è¿›è¡ŒåµŒå…¥å¼é¡¹ç›®å¼€å‘ã€‚</p><p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œä½¿ç”¨Qemuæ¨¡æ‹ŸåŸºäºARMçš„åµŒå…¥å¼ç³»ç»Ÿã€‚æœ‰äº†è¿™ä¸ªï¼Œæ‚¨å¯ä»¥åœ¨èˆ’é€‚çš„æ¡Œé¢ä¸Šå­¦ä¹ GNUå·¥å…·é“¾ï¼Œè€Œæ— éœ€æŠ•èµ„ç¡¬ä»¶ã€‚æœ¬æ•™ç¨‹æœ¬èº«ä¸æ•™æˆARMæŒ‡ä»¤é›†ã€‚å®ƒåº”è¯¥ä¸å…¶ä»–ä¹¦ç±å’Œåœ¨çº¿æ•™ç¨‹ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ARM Assembler - <a href="http://www.heyrick.co.uk/assembler/">http://www.heyrick.co.uk/assembler/</a></li><li>ARMæ±‡ç¼–ç¨‹åº-<a href="http://www.heyrick.co.uk/assembler/">http://www.heyrick.co.uk/assembler/</a></li><li>ARM Assembly Language Programming - <a href="http://www.arm.com/miscPDFs/9658.pdf">http://www.arm.com/miscPDFs/9658.pdf</a></li><li>ARMæ±‡ç¼–è¯­è¨€ç¼–ç¨‹-<a href="http://www.arm.com/miscPDFs/9658.pdf">http://www.arm.com/miscPDFs/9658.pdf</a></li></ul><p>ä½†ä¸ºäº†æ–¹ä¾¿è¯»è€…ï¼Œé™„å½•ä¸­åˆ—å‡ºäº†å¸¸ç”¨çš„ARMæŒ‡ä»¤ã€‚é¡ºåºçœ‹æ–‡ä¸­ä»£ç æ—¶ï¼Œæœ‰ arm æŒ‡ä»¤ä¸æ¸…æ¥šå¯ä»¥è·³è½¬åˆ°é™„å½•æŸ¥çœ‹ã€‚</p><hr><h2 id="2-Setting-up-the-ARM-Lab"><a href="#2-Setting-up-the-ARM-Lab" class="headerlink" title="2. Setting up the ARM Lab"></a>2. Setting up the ARM Lab</h2><p>æœ¬èŠ‚ä»‹ç»å¦‚ä½•åœ¨ä½ çš„ç”µè„‘ä¸Šä½¿ç”¨ Qemu å’Œ GNU å·¥å…·é“¾è®¾ç½®ä¸€ä¸ªç®€å•çš„ ARM å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚Qemu æ˜¯ä¸€æ¬¾å¯ä»¥æ¨¡æ‹Ÿå¤šç§æœºå™¨ï¼ˆåŒ…æ‹¬åŸºäº ARM çš„æœºå™¨ï¼‰çš„æœºå™¨æ¨¡æ‹Ÿå™¨ã€‚ä½ å¯ä»¥ç¼–å†™ ARM æ±‡ç¼–ç¨‹åºï¼Œä½¿ç”¨ GNU å·¥å…·é“¾è¿›è¡Œç¼–è¯‘ï¼Œå¹¶åœ¨ Qemu ä¸­æ‰§è¡Œå’Œæµ‹è¯•è¿™äº›ç¨‹åºã€‚</p><h3 id="2-1-Qemu-ARM"><a href="#2-1-Qemu-ARM" class="headerlink" title="2.1. Qemu ARM"></a>2.1. Qemu ARM</h3><p>Qemu å°†ç”¨äºæ¨¡æ‹Ÿæ¥è‡ª Gumstix çš„åŸºäº PXA255 çš„ <em>connex</em> å¼€å‘æ¿ã€‚è¦è¿è¡Œæœ¬æ•™ç¨‹ï¼Œä½ éœ€è¦è‡³å°‘ 0.9.1 ç‰ˆæœ¬çš„ Qemuã€‚</p><p>PXA255 å¤„ç†å™¨å…·æœ‰ç¬¦åˆ ARMv5TE æŒ‡ä»¤é›†çš„ ARM æ ¸å¿ƒã€‚PXA255 è¿˜åŒ…å«å¤šä¸ªç‰‡ä¸Šå¤–è®¾ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œå°†ä»‹ç»å…¶ä¸­çš„ä¸€äº›å¤–è®¾ã€‚.</p><h3 id="2-2-Installing-Qemu-in-Debian"><a href="#2-2-Installing-Qemu-in-Debian" class="headerlink" title="2.2. Installing Qemu in Debian"></a>2.2. Installing Qemu in Debian</h3><p>This tutorial requires qemu version 0.9.1 or above. The qemu package available in Debian Squeeze&#x2F;Wheezy, meets this requirement. Install <code>qemu</code> using <code>apt-get</code>.</p><blockquote><p>Ubuntu 22.04 ä¸Šæµ‹è¯•ï¼Œåç»­ä½¿ç”¨çš„ï¼Œåº”è¯¥é€šè¿‡ <code>apt install qemu-system-arm</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install qemu-system-arm</span><br></pre></td></tr></table></figure><h3 id="2-3-Installing-GNU-Toolchain-for-ARM"><a href="#2-3-Installing-GNU-Toolchain-for-ARM" class="headerlink" title="2.3. Installing GNU Toolchain for ARM"></a>2.3. Installing GNU Toolchain for ARM</h3><ol><li><p>Folks at CodeSourcery (part of Mentor Graphics) have been kind enough to make GNU toolchains available for various architectures. Download the GNU toolchain for ARM, available from from <a href="http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/">http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/</a></p><blockquote><p>â›” ä¸Šè¯‰é“¾æ¥æ—©å·²å¤±æ•ˆï¼Œå®˜æ–¹å·¥å…·é“¾ä¸‹è½½åœ°å€ï¼š<a href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads%E3%80%82">https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloadsã€‚</a></p><p>ä¸è¿‡ä¸Šé¢é“¾æ¥ä¸‹è½½çš„å·¥å…·é“¾ä¹Ÿæœ‰é—®é¢˜ï¼Œéƒ¨åˆ†å·¥å…·é“¾æ¥å¼‚å¸¸ã€‚æ”¹ç”¨ <a href="https://github.com/sophgo/host-tools">https://github.com/sophgo/host-tools</a> ä¸‹çš„å·¥å…·é“¾ã€‚</p></blockquote></li><li><p>Extract the tar archive, to <code>~/toolchains</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> ~/toolchains</span><br><span class="line">$ <span class="built_in">cd</span> ~/toolchains</span><br><span class="line">$ tar -jxf ~/downloads/arm-2008q1-126-arm-linux-gnueabihf-i686-pc-linux-gnu.tar.bz2</span><br></pre></td></tr></table></figure></li><li><p>Add the toolchain to your <code>PATH</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=/home/yogurt/Documents/sophgo/host-tools/gcc/gcc-linaro-6.3.1-2017.05-x86_64_arm-linux-gnueabihf/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure></li><li><p>You might want to add the previous line to your <code>.bashrc</code>.</p></li></ol><hr><h2 id="3-Hello-ARM"><a href="#3-Hello-ARM" class="headerlink" title="3. Hello ARM"></a>3. Hello ARM</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•æ±‡ç¼–ä¸€ä¸ªç®€å•çš„ ARM ç¨‹åºï¼Œå¹¶åœ¨ç”± Qemu æ¨¡æ‹Ÿçš„è£¸æœº connex å¼€å‘æ¿ä¸Šè¿›è¡Œæµ‹è¯•ã€‚</p><p>æ±‡ç¼–ç¨‹åºçš„æºæ–‡ä»¶ç”±ä¸€ç³»åˆ—è¯­å¥ç»„æˆï¼Œæ¯è¡Œä¸€æ¡è¯­å¥ã€‚æ¯æ¡è¯­å¥çš„æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label:    instruction         @ comment</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸‰ä¸ªéƒ¨åˆ†éƒ½æ˜¯å¯é€‰çš„ã€‚</p><ul><li><p>ğŸ“Œ <code>label</code>: æ ‡ç­¾æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹å¼ï¼Œ<strong>ç”¨äºæŒ‡ä»£å†…å­˜ä¸­æŒ‡ä»¤çš„ä½ç½®</strong>ã€‚æ ‡ç­¾å¯ä»¥åœ¨ä»»ä½•åœ°å€å¯ä»¥å‡ºç°çš„åœ°æ–¹ä½¿ç”¨ï¼Œä¾‹å¦‚ä½œä¸ºåˆ†æ”¯æŒ‡ä»¤çš„æ“ä½œæ•°ã€‚æ ‡ç­¾åç§°åº”ç”±å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼ˆ<code>_</code>ï¼‰å’Œç¾å…ƒç¬¦å·ï¼ˆ<code>$</code>ï¼‰ç»„æˆã€‚</p><blockquote><p>The label is a convenient way to refer to the location of the instruction in memory. The label can be used where ever an address can appear, for example as an operand of the branch instruction. The label name should consist of alphabets, digits, <code>_</code> and <code>$</code>.</p></blockquote></li><li><p>ğŸ“ <code>comment</code>: æ³¨é‡Šä»¥ <code>@</code> å¼€å§‹ï¼Œ<code>@</code> åå‡ºç°çš„å­—ç¬¦å°†è¢«å¿½ç•¥ã€‚</p></li><li><p>ğŸ“œ <code>instruction</code>: å¯ä»¥æ˜¯ ARM æŒ‡ä»¤æˆ–æ±‡ç¼–æŒ‡ä»¤ã€‚æ±‡ç¼–æŒ‡ä»¤æ˜¯ç»™æ±‡ç¼–å™¨çš„å‘½ä»¤ï¼ŒğŸ’¡ğŸ’¡ <strong>æ±‡ç¼–æŒ‡ä»¤æ€»æ˜¯ä»¥ <code>.</code>ï¼ˆå¥ç‚¹ï¼‰å¼€å¤´</strong>ã€‚</p><blockquote><p>The <code>instruction</code> could be an ARM instruction or an assembler directive. Assembler directives are commands to the assembler. Assembler directives always start with a <code>.</code> (period).</p></blockquote></li></ul><blockquote><p>ğŸ’¡ğŸ’¡ æ³¨æ„åç»­åŒºåˆ†æ±‡ç¼–æŒ‡ä»¤ä¸ ARM æŒ‡ä»¤ï¼ï¼ï¼</p></blockquote><p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ ARM æ±‡ç¼–ç¨‹åºï¼Œç”¨äºå°†ä¸¤ä¸ªæ•°å­—ç›¸åŠ ï¼š</p><p><strong>Listing 1. Adding Two Numbers</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">start:                       @ Label, not really required</span><br><span class="line">        mov   r0, #5         @ Load register r0 with the value 5</span><br><span class="line">        mov   r1, #4         @ Load register r1 with the value 4</span><br><span class="line">        add   r2, r1, r0     @ Add r0 and r1 and store in r2</span><br><span class="line"></span><br><span class="line">stop:   b stop               @ Infinite loop to stop execution</span><br></pre></td></tr></table></figure><p><code>.text</code> æ˜¯ä¸€ä¸ª<strong>æ±‡ç¼–æŒ‡ä»¤</strong>ï¼Œè¡¨ç¤ºæ¥ä¸‹æ¥çš„æŒ‡ä»¤åº”è¢«æ±‡ç¼–åˆ°ä»£ç æ®µï¼Œè€Œä¸æ˜¯ <code>.data</code> æ®µã€‚å…³äºæ®µçš„å†…å®¹å°†åœ¨åé¢çš„æ•™ç¨‹ä¸­è¯¦ç»†ä»‹ç»ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The `.text` is an assembler directive, which says that the following instructions</span><br><span class="line">have to be assembled into the code section, rather than the `.data` section.</span><br><span class="line">Sections will be covered in detail, later in the tutorial.</span><br></pre></td></tr></table></figure><h3 id="3-1-Building-the-Binary"><a href="#3-1-Building-the-Binary" class="headerlink" title="3.1. Building the Binary"></a>3.1. Building the Binary</h3><p>å°†ä¸‹é¢çš„ç¨‹åºä¿å­˜åˆ°ä¸€ä¸ªåä¸º <code>add.s</code> çš„æ–‡ä»¶ä¸­ã€‚è¦æ±‡ç¼–è¯¥æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ GNU å·¥å…·é“¾çš„æ±‡ç¼–å™¨ <code>as</code>ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o add.o add.s</span><br></pre></td></tr></table></figure><p><code>-o</code>é€‰é¡¹æŒ‡å®šè¾“å‡º æ–‡ä»¶åã€‚</p><blockquote><p>äº¤å‰å·¥å…·é“¾æ€»æ˜¯ä»¥ç›®æ ‡æ¶æ„çš„å‰ç¼€å‘½åï¼Œä»¥é¿å…ä¸ä¸»æœºå·¥å…·é“¾çš„åç§°å†²çªã€‚ä¸ºäº†å¯è¯»æ€§ï¼Œæ–‡æœ¬ä¸­å°†ä¸å¸¦å‰ç¼€åœ°æåŠè¿™äº›å·¥å…·ã€‚</p></blockquote><p>è¦ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ GNU å·¥å…·é“¾ä¸­çš„é“¾æ¥å™¨ <code>ld</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x0 -o add.elf add.o</span><br><span class="line">arm-linux-gnueabihf-ld: warning: cannot find entry symbol _start; defaulting to 0000000000000000</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒåŒæ ·åœ°ï¼Œ<code>-o</code> é€‰é¡¹ç”¨äºæŒ‡å®šè¾“å‡ºæ–‡ä»¶åã€‚<code>-Ttext=0x0</code> æŒ‡å®šäº†æ ‡ç­¾ <code>text</code> åº”è¢«åˆ†é…çš„åœ°å€ï¼Œä½¿å¾—æŒ‡ä»¤ä»åœ°å€ <code>0x0</code> å¼€å§‹ã€‚è¦æŸ¥çœ‹å„ä¸ªæ ‡ç­¾çš„åœ°å€åˆ†é…ï¼Œå¯ä»¥ä½¿ç”¨ <code>nm</code> å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Here again, the `-o` option specifies the output filename.</span></span><br><span class="line"><span class="comment"># The `-Ttext=0x0`, specifies that addresses should be assigned to the labels,</span></span><br><span class="line"><span class="comment"># such that the instructions were starting from address `0x0`.</span></span><br><span class="line"><span class="comment"># To view the address assignment for various labels, the `nm` command can be used as shown below.</span></span><br><span class="line"></span><br><span class="line">$ arm-linux-gnueabihf-nm add.elf</span><br><span class="line">00010010 T __bss_end__</span><br><span class="line">00010010 T _bss_end__</span><br><span class="line">00010010 T __bss_start</span><br><span class="line">00010010 T __bss_start__</span><br><span class="line">00010010 T _edata</span><br><span class="line">00010010 T __end__</span><br><span class="line">00010010 T _end</span><br><span class="line">00000000 t start</span><br><span class="line">0000000c t stop</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„æ ‡ç­¾ <code>start</code> å’Œ <code>stop</code> çš„åœ°å€åˆ†é…ã€‚<code>start</code> çš„åœ°å€è¢«åˆ†é…ä¸º <code>0x0</code>ï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ ‡ç­¾ã€‚<code>stop</code> æ ‡ç­¾åœ¨ 3 æ¡æŒ‡ä»¤ä¹‹åã€‚æ¯æ¡æŒ‡ä»¤å ç”¨ 4 å­—èŠ‚ï¼Œå› æ­¤ <code>stop</code> è¢«åˆ†é…çš„åœ°å€æ˜¯ 12ï¼ˆ<code>0xC</code>ï¼‰ã€‚</p><p>ä½¿ç”¨ä¸åŒçš„åŸºåœ°å€è¿›è¡Œé“¾æ¥å°†å¯¼è‡´æ ‡ç­¾è¢«åˆ†é…åˆ°ä¸åŒçš„åœ°å€é›†ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Note the address assignment for the labels `start` and `stop`. The address assigned</span></span><br><span class="line"><span class="comment"># for `start` is `0x0`. Since it is the label of the first instruction.</span></span><br><span class="line"><span class="comment"># The label `stop` is after 3 instructions. Each instructions is 4 bytes.</span></span><br><span class="line"><span class="comment"># Hence `stop` is assigned an address `12` (`0xC`).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linking with a different base address for the instructions will result in</span></span><br><span class="line"><span class="comment"># a different set of addresses being assigned to the labels.</span></span><br><span class="line"></span><br><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x20000000 -o add.elf add.o</span><br><span class="line">$ arm-linux-gnueabihf-nm add.elf</span><br><span class="line">... clip ...</span><br><span class="line">20000000 t start</span><br><span class="line">2000000c t stop</span><br></pre></td></tr></table></figure><p><code>ld</code> åˆ›å»ºçš„è¾“å‡ºæ–‡ä»¶æ ¼å¼ç§°ä¸º <code>ELF</code>ã€‚æœ‰å¤šç§æ–‡ä»¶æ ¼å¼å¯ç”¨äºå­˜å‚¨å¯æ‰§è¡Œä»£ç ã€‚ELF æ ¼å¼åœ¨æœ‰æ“ä½œç³»ç»Ÿæ—¶è¿è¡Œè‰¯å¥½ï¼Œä½†ç”±äºæˆ‘ä»¬å°†è¦åœ¨è£¸æœºä¸Šè¿è¡Œç¨‹åºï¼Œå› æ­¤éœ€è¦å°†å…¶è½¬æ¢ä¸ºä¸€ç§æ›´ç®€å•çš„æ–‡ä»¶æ ¼å¼ï¼Œç§°ä¸º <code>binary</code> æ ¼å¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The output file created by `ld` is in a format called `ELF`. Various file formats are available</span><br><span class="line"> for storing executable code. The ELF format works fine when you have an OS around,</span><br><span class="line"> but since we are going to run the program on bare metal,</span><br><span class="line"> we will have to convert it to a simpler file format called the `binary` format.</span><br></pre></td></tr></table></figure><p><code>binary</code> æ ¼å¼çš„æ–‡ä»¶åŒ…å«ä»ç‰¹å®šå†…å­˜åœ°å€å¼€å§‹çš„è¿ç»­å­—èŠ‚ã€‚è¯¥æ–‡ä»¶ä¸­ä¸å­˜å‚¨ä»»ä½•å…¶ä»–é™„åŠ ä¿¡æ¯ã€‚<strong>è¿™å¯¹äº Flash çƒ§å½•å·¥å…·æ¥è¯´éå¸¸æ–¹ä¾¿</strong>ï¼Œå› ä¸ºç¼–ç¨‹æ—¶åªéœ€å°†æ–‡ä»¶ä¸­çš„æ¯ä¸ªå­—èŠ‚å¤åˆ¶åˆ°ä»æŒ‡å®šåŸºåœ°å€å¼€å§‹çš„è¿ç»­åœ°å€ä¸­å³å¯ã€‚</p><blockquote><p>æœ‰ç‚¹åƒçƒ§å½•å›ºä»¶æ—¶ï¼Œæå‰å°†å›ºä»¶æ‰“åŒ…ä¸ºçš„æ•´åŒ…å·¥å…·ã€‚</p></blockquote><p>GNU å·¥å…·é“¾ä¸­çš„ <code>objcopy</code> å‘½ä»¤å¯ç”¨äºåœ¨ä¸åŒçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ä»¥ä¸‹æ˜¯è¯¥å‘½ä»¤çš„ä¸€ç§å¸¸è§ç”¨æ³•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A file in `binary` format contains consecutive bytes from a specific memory address.</span></span><br><span class="line"><span class="comment"># No other additional information is stored in the file. This is convenient for Flash programming tools,</span></span><br><span class="line"><span class="comment"># since all that has to be done when programming is to copy each byte in the file,</span></span><br><span class="line"><span class="comment"># to consecutive address starting from a specified base address in memory.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The GNU toolchainâ€™s `objcopy` command can be used to convert between different object file formats.</span></span><br><span class="line"><span class="comment"># A common usage of the command is given below.</span></span><br><span class="line"></span><br><span class="line">objcopy -O &lt;output-format&gt; &lt;in-file&gt; &lt;out-file&gt;</span><br></pre></td></tr></table></figure><p>å°†<code>add.elf</code>è½¬æ¢ä¸º <code>binary</code> æ ¼å¼ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-objcopy -O binary add.elf add.bin</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥æ–‡ä»¶çš„å¤§å°ã€‚è¯¥æ–‡ä»¶æ­£å¥½æ˜¯16ä¸ªå­—èŠ‚ã€‚å› ä¸ºæœ‰4æ¡æŒ‡ä»¤ï¼Œæ¯æ¡æŒ‡ä»¤å ç”¨4ä¸ªå­—èŠ‚ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al add.bin</span><br><span class="line">-rw-r--r-- 1 vijaykumar vijaykumar 16 2008-10-03 23:56 add.bin</span><br></pre></td></tr></table></figure><h3 id="3-2-Executing-in-Qemu"><a href="#3-2-Executing-in-Qemu" class="headerlink" title="3.2. Executing in Qemu"></a>3.2. Executing in Qemu</h3><p>å½“ ARM å¤„ç†å™¨å¤ä½æ—¶ï¼Œå®ƒä»åœ°å€ <code>0x0</code> å¼€å§‹æ‰§è¡Œã€‚åœ¨ connex å¼€å‘æ¿ä¸Šï¼Œ16MB çš„ Flash å­˜å‚¨å™¨ä½äºåœ°å€ <code>0x0</code>ã€‚Flash å¼€å§‹å¤„çš„æŒ‡ä»¤å°†è¢«æ‰§è¡Œã€‚</p><p>å½“ <code>qemu</code> æ¨¡æ‹Ÿ connex å¼€å‘æ¿æ—¶ï¼Œå¿…é¡»æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†è¢«è§†ä¸º Flash å­˜å‚¨å™¨ã€‚Flash æ–‡ä»¶æ ¼å¼éå¸¸ç®€å•ã€‚è¦ä» Flash ä¸­çš„åœ°å€ X è·å–å­—èŠ‚ï¼Œ<code>qemu</code> ä»æ–‡ä»¶çš„åç§»é‡ X è¯»å–å­—èŠ‚ã€‚å®é™…ä¸Šï¼Œè¿™ä¸äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼æ˜¯ç›¸åŒçš„ã€‚</p><p>ä¸ºäº†åœ¨æ¨¡æ‹Ÿçš„ Gumstix connex å¼€å‘æ¿ä¸Šæµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª 16MB çš„æ–‡ä»¶æ¥è¡¨ç¤º Flashã€‚æˆ‘ä»¬ä½¿ç”¨ <code>dd</code> å‘½ä»¤ä» <code>/dev/zero</code> å¤åˆ¶ 16MB çš„é›¶å­—èŠ‚åˆ°æ–‡ä»¶ <code>flash.bin</code>ã€‚æ•°æ®ä»¥ 4K å—çš„å½¢å¼å¤åˆ¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=flash.bin bs=4096 count=4096</span><br></pre></td></tr></table></figure><p>ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† <code>add.bin</code> æ–‡ä»¶å¤åˆ¶åˆ° Flash çš„å¼€å¤´ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=add.bin of=flash.bin bs=4096 conv=notrunc</span><br></pre></td></tr></table></figure><p>è¿™ç›¸å½“äºå°†<code>bin</code>æ–‡ä»¶çƒ§å½•åˆ°é—ªå­˜ä¸Šã€‚</p><p>åœ¨å¤ä½åï¼Œå¤„ç†å™¨å°†ä»åœ°å€ <code>0x0</code> å¼€å§‹æ‰§è¡Œï¼Œç¨‹åºä¸­çš„æŒ‡ä»¤å°†è¢«æ‰§è¡Œã€‚è°ƒç”¨ <code>qemu</code> çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br></pre></td></tr></table></figure><p><code>-M connex</code> é€‰é¡¹æŒ‡å®šè¦æ¨¡æ‹Ÿçš„æœºå™¨ä¸º <code>connex</code>ã€‚<code>-pflash</code> é€‰é¡¹æŒ‡å®š <code>flash.bin</code> æ–‡ä»¶è¡¨ç¤º Flash å­˜å‚¨å™¨ã€‚<code>-nographic</code> è¡¨ç¤ºä¸éœ€è¦å›¾å½¢æ˜¾ç¤ºçš„æ¨¡æ‹Ÿã€‚<code>-serial /dev/null</code> æŒ‡å®š connex å¼€å‘æ¿çš„ä¸²å£è¿æ¥åˆ° <code>/dev/null</code>ï¼Œä»¥ä¾¿ä¸¢å¼ƒä¸²å£æ•°æ®ã€‚</p><p>ç³»ç»Ÿæ‰§è¡ŒæŒ‡ä»¤åï¼Œä¼šåœ¨ <code>stop: b stop</code> æŒ‡ä»¤å¤„æ— é™å¾ªç¯ã€‚è¦æŸ¥çœ‹å¯„å­˜å™¨çš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ <code>qemu</code> çš„ç›‘è§†å™¨æ¥å£ã€‚ç›‘è§†å™¨æ¥å£æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç•Œé¢ï¼Œé€šè¿‡å®ƒå¯ä»¥æ§åˆ¶æ¨¡æ‹Ÿçš„ç³»ç»Ÿå¹¶æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€‚å½“ <code>qemu</code> ä»¥ä¸Šè¿°å‘½ä»¤å¯åŠ¨æ—¶ï¼Œç›‘è§†å™¨æ¥å£å°†é€šè¿‡ <code>qemu</code> çš„æ ‡å‡†è¾“å…¥&#x2F;è¾“å‡ºæä¾›ã€‚</p><p>è¦æŸ¥çœ‹å¯„å­˜å™¨çš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨<code>info registers</code>ç›‘è§†å™¨å‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br><span class="line">WARNING: Image format was not specified <span class="keyword">for</span> <span class="string">&#x27;flash.bin&#x27;</span> and probing guessed raw.</span><br><span class="line">         Automatically detecting the format is dangerous <span class="keyword">for</span> raw images, write operations on block 0 will be restricted.</span><br><span class="line">         Specify the <span class="string">&#x27;raw&#x27;</span> format explicitly to remove the restrictions.</span><br><span class="line">QEMU 6.2.0 monitor - <span class="built_in">type</span> <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> more information</span><br><span class="line">(qemu) info registers</span><br><span class="line">R00=00000005 R01=00000004 R02=00000009 R03=00000000</span><br><span class="line">R04=00000000 R05=00000000 R06=00000000 R07=00000000</span><br><span class="line">R08=00000000 R09=00000000 R10=00000000 R11=00000000</span><br><span class="line">R12=00000000 R13=00000000 R14=00000000 R15=0000000c</span><br><span class="line">PSR=400001d3 -Z-- A svc32</span><br><span class="line">FPSCR: 00000000</span><br><span class="line">(qemu)</span><br></pre></td></tr></table></figure><p>è¯·æ³¨æ„å¯„å­˜å™¨ <code>R02</code> çš„å€¼ã€‚è¯¥å¯„å­˜å™¨åŒ…å«åŠ æ³•çš„ç»“æœï¼Œåº”è¯¥ä¸é¢„æœŸå€¼ 9 ç›¸ç¬¦ã€‚</p><h3 id="3-3-More-Monitor-Commands"><a href="#3-3-More-Monitor-Commands" class="headerlink" title="3.3. More Monitor Commands"></a>3.3. More Monitor Commands</h3><p>ä¸€äº›æœ‰ç”¨çš„<code>qemu</code>ç›‘æ§å‘½ä»¤ åˆ—åœ¨ä¸‹è¡¨ä¸­ã€‚</p><table><thead><tr><th>Command</th><th>Purpose</th></tr></thead><tbody><tr><td></td><td></td></tr><tr><td><code>help</code></td><td>List available commands</td></tr><tr><td><code>quit</code></td><td>Quits the emulator</td></tr><tr><td><code>xp /fmt addr</code></td><td>Dump ç‰©ç†å†…å­˜ä¸­ <code>addr</code> å¤„çš„å†…å®¹</td></tr><tr><td><code>system_reset</code></td><td>Reset the system.</td></tr></tbody></table><p><code>xp</code> å‘½ä»¤éœ€è¦æ›´å¤šçš„è§£é‡Šã€‚<code>/fmt</code> ä½œä¸ºå‚æ•°æŒ‡å®šå†…å­˜å†…å®¹çš„æ˜¾ç¤ºæ–¹å¼ã€‚<code>fmt</code> çš„è¯­æ³•ä¸º <code>&lt;count&gt;&lt;format&gt;&lt;size&gt;</code>ã€‚</p><ul><li><p><code>count</code>: è¡¨ç¤ºè¦æ˜¾ç¤ºçš„ <code>item</code> æ•°é‡ï¼Œä¾‹å¦‚è¦æ˜¾ç¤º 4 ä¸ªå­—èŠ‚å¯ä»¥å†™ä¸º <code>4</code></p></li><li><p><code>format</code>: æŒ‡å®šæ˜¾ç¤ºæ ¼å¼ã€‚<code>x</code> ä»£è¡¨åå…­è¿›åˆ¶ï¼Œ<code>d</code>ä»£è¡¨æœ‰ç¬¦å·åè¿›åˆ¶ï¼Œ <code>u</code>ä»£è¡¨æ— ç¬¦å·åè¿›åˆ¶ï¼Œ<code>o</code>ä»£è¡¨å…«è¿›åˆ¶ï¼Œ<code>c</code>ä»£è¡¨ charå’Œ<code>i</code>ç”¨äºasmæŒ‡ä»¤ã€‚</p></li><li><p><code>size</code>: è¡¨ç¤ºæ¯ä¸ª <code>item</code> çš„å¤§å°ï¼Œ<code>b</code>è¡¨ç¤º8ä½ï¼Œ<code>h</code>è¡¨ç¤º 16ä½ï¼Œ<code>w</code>ä»£è¡¨32ä½ <code>g</code>ä¸º64ä½ã€‚</p></li></ul><p>è¿™ä¸ª <code>xp</code> å‘½ä»¤ä½¿ç”¨ <code>i</code> æ ¼å¼å¯ä»¥ç”¨äºåæ±‡ç¼–å†…å­˜ä¸­å­˜åœ¨çš„æŒ‡ä»¤ã€‚å¦‚è¦åæ±‡ç¼–ä½äº <code>0x0</code> çš„æŒ‡ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ <code>xp</code> å‘½ä»¤ï¼Œ<code>fmt</code> æŒ‡å®šä¸º <code>4iw</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(qemu) xp /4iw 0x0</span><br><span class="line">0x00000000:  mov        r0, <span class="comment">#5  ; 0x5</span></span><br><span class="line">0x00000004:  mov        r1, <span class="comment">#4  ; 0x4</span></span><br><span class="line">0x00000008:  add        r2, r1, r0</span><br><span class="line">0x0000000c:  b  0xc</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼š</p><ul><li><code>4</code> æŒ‡å®šè¦æ˜¾ç¤º 4 ä¸ª <code>item</code>ã€‚</li><li><code>i</code> æŒ‡å®šè¿™äº›é¡¹ç›®å°†ä»¥æŒ‡ä»¤å½¢å¼æ‰“å°ï¼ˆæ˜¯çš„ï¼Œè¿™ä¸ªå‘½ä»¤å†…ç½®äº†åæ±‡ç¼–åŠŸèƒ½ï¼ï¼‰ã€‚</li><li><code>w</code> æŒ‡å®šæ¯ä¸ªé¡¹ç›®çš„å¤§å°ä¸º 32 ä½ã€‚</li></ul><p>è¯¥å‘½ä»¤çš„è¾“å‡ºå°†æ˜¾ç¤ºä»åœ°å€ <code>0x0</code> å¼€å§‹çš„ 4 æ¡æŒ‡ä»¤çš„åæ±‡ç¼–ç»“æœã€‚</p><hr><h2 id="4-More-Assembler-Directives"><a href="#4-More-Assembler-Directives" class="headerlink" title="4. More Assembler Directives"></a>4. More Assembler Directives</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°ä¸€äº›å¸¸ç”¨çš„<strong>æ±‡ç¼–æŒ‡ä»¤</strong>ï¼Œå¹¶ä½¿ç”¨ä¸¤ä¸ªç¤ºä¾‹ç¨‹åºè¿›è¡Œè¯´æ˜ã€‚</p><blockquote><p>ğŸ’¡ğŸ’¡ <strong>æ±‡ç¼–æŒ‡ä»¤æ€»æ˜¯ä»¥ <code>.</code> å¼€å¤´</strong>ã€‚</p></blockquote><ol><li>ä¸€ä¸ªè®¡ç®—æ•°ç»„æ€»å’Œçš„ç¨‹åº</li><li>ä¸€ä¸ªè®¡ç®—å­—ç¬¦ä¸²é•¿åº¦çš„ç¨‹åº</li></ol><h3 id="4-1-Sum-an-Array"><a href="#4-1-Sum-an-Array" class="headerlink" title="4.1. Sum an Array"></a>4.1. Sum an Array</h3><p>ä»¥ä¸‹ä»£ç å¯¹ä¸€ä¸ªå­—èŠ‚æ•°ç»„è¿›è¡Œæ±‚å’Œï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>r3</code> ä¸­ã€‚</p><p><strong>Listing 2. Sum an Array</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">entry:  b start                 @ Skip over the data</span><br><span class="line">arr:    .byte 10, 20, 25        @ Read-only array of bytes</span><br><span class="line">eoa:                            @ Address of end of array + 1</span><br><span class="line"></span><br><span class="line">        .align</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =eoa          @ r0 = &amp;eoa</span><br><span class="line">        ldr   r1, =arr          @ r1 = &amp;arr</span><br><span class="line">        mov   r3, #0            @ r3 = 0</span><br><span class="line">loop:   ldrb  r2, [r1], #1      @ r2 = *r1++</span><br><span class="line">        add   r3, r2, r3        @ r3 += r2</span><br><span class="line">        cmp   r1, r0            @ if (r1 != r2)</span><br><span class="line">        bne   loop              @    goto loop</span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure><p>è¯¥ä»£ç å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„<strong>æ±‡ç¼–æŒ‡ä»¤</strong>â€”â€”<code>.byte</code> å’Œ <code>.align</code>ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™äº›æ±‡ç¼–æŒ‡ä»¤çš„æè¿°ã€‚</p><h4 id="4-1-1-byte-Directive"><a href="#4-1-1-byte-Directive" class="headerlink" title="4.1.1. .byte Directive"></a>4.1.1. <code>.byte</code> Directive</h4><p><code>.byte</code> çš„å­—èŠ‚å¤§å°å‚æ•°<strong>åœ¨å†…å­˜ä¸­è¢«ç»„è£…æˆè¿ç»­çš„å­—èŠ‚</strong>ã€‚è¿˜æœ‰ç±»ä¼¼çš„æŒ‡ä»¤ <code>.2byte</code> å’Œ <code>.4byte</code> åˆ†åˆ«ç”¨äºå­˜å‚¨ 16 ä½å€¼å’Œ 32 ä½å€¼ã€‚ä¸€èˆ¬çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The byte sized arguments of `.byte` are assembled into consecutive bytes in memory.</span><br><span class="line">There are similar directives `.2byte` and `.4byte` for storing 16 bit values and 32 bit values, respectively.</span><br><span class="line">The general syntax is given below.</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.byte   exp1, exp2, ...</span><br><span class="line">.2byte  exp1, exp2, ...</span><br><span class="line">.4byte  exp1, exp2, ...</span><br></pre></td></tr></table></figure><p>å‚æ•°å¯ä»¥æ˜¯ç®€å•çš„æ•´æ•°å­—é¢é‡ï¼Œå¯ä»¥ç”¨äºŒè¿›åˆ¶ï¼ˆä»¥ <code>0b</code> æˆ– <code>0B</code> ä¸ºå‰ç¼€ï¼‰ã€å…«è¿›åˆ¶ï¼ˆä»¥ <code>0</code> ä¸ºå‰ç¼€ï¼‰ã€åè¿›åˆ¶æˆ–åå…­è¿›åˆ¶ï¼ˆä»¥ <code>0x</code> æˆ– <code>0X</code> ä¸ºå‰ç¼€ï¼‰è¡¨ç¤ºã€‚æ•´æ•°ä¹Ÿå¯ä»¥ç”¨å­—ç¬¦å¸¸é‡è¡¨ç¤ºï¼ˆå­—ç¬¦ç”¨å•å¼•å·æ‹¬èµ·æ¥ï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å°†ä½¿ç”¨å­—ç¬¦çš„ ASCII å€¼ã€‚</p><p>å‚æ•°è¿˜å¯ä»¥æ˜¯<strong>ç”±å­—é¢é‡å’Œå…¶ä»–ç¬¦å·æ„æˆçš„ C è¡¨è¾¾å¼</strong>ã€‚ä¸‹é¢ç»™å‡ºäº†ç¤ºä¾‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The arguments could be simple integer literal, represented as binary (prefixed by `0b` or `0B`),</span><br><span class="line">octal (prefixed by `0`), decimal or hexadecimal (prefixed by `0x` or `0X`).</span><br><span class="line">The integers could also be represented as character constants (character surrounded by single quotes),</span><br><span class="line">in which case the ASCII value of the character will be used.</span><br><span class="line"></span><br><span class="line">The arguments could also be C expressions constructed out of literals and other symbols. Examples are shown below.</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pattern:  .byte 0b01010101, 0b00110011, 0b00001111</span><br><span class="line">npattern: .byte npattern - pattern</span><br><span class="line">halpha:   .byte &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;</span><br><span class="line">dummy:    .4byte 0xDEADBEEF</span><br><span class="line">nalpha:   .byte &#x27;Z&#x27; - &#x27;A&#x27; + 1</span><br></pre></td></tr></table></figure><h4 id="4-1-2-align-Directive"><a href="#4-1-2-align-Directive" class="headerlink" title="4.1.2. .align Directive"></a>4.1.2. <code>.align</code> Directive</h4><p>ARM è¦æ±‚<strong>æŒ‡ä»¤</strong>å¿…é¡»ä½äº 32 ä½å¯¹é½çš„å†…å­˜ä½ç½®ã€‚æŒ‡ä»¤ä¸­çš„ 4 ä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€åº”è¯¥æ˜¯ 4 çš„å€æ•°ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸€è¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ <code>.align</code> æŒ‡ä»¤æ’å…¥å¡«å……å­—èŠ‚ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªå­—èŠ‚åœ°å€ä¸º 4 çš„å€æ•°ã€‚è¿™ä»…åœ¨ä»£ç ä¸­æ’å…¥æ•°æ®å­—èŠ‚æˆ–åŠå­—æ—¶éœ€è¦ã€‚</p><blockquote><p>ğŸ’¡ğŸ’¡æ³¨æ„æ˜¯ arm æŒ‡ä»¤ï¼Œä¸æ˜¯æ•°æ®ï¼ˆæˆ–è€…è¯´æ ‡ç­¾ï¼‰ï¼Œä¹Ÿä¸æ˜¯ <strong>æ±‡ç¼–æŒ‡ä»¤</strong>ï¼ˆä¸ç„¶ .align æœ¬èº«å°±å¾—å…ˆå¯¹é½æ‰èƒ½ä½¿ç”¨äº†ï¼‰ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ARM requires that the instructions be present in 32-bit aligned memory locations.</span><br><span class="line">The address of the first byte, of the 4 bytes in an instruction, should be a multiple of 4.</span><br><span class="line">To adhere to this, the `.align` directive can be used to insert padding bytes</span><br><span class="line">till the next byte address will be a multiple of 4.</span><br><span class="line">This is required only when data bytes or half words are inserted within code.</span><br></pre></td></tr></table></figure><h3 id="4-2-String-Length"><a href="#4-2-String-Length" class="headerlink" title="4.2. String Length"></a>4.2. String Length</h3><p>ä»¥ä¸‹ä»£ç è®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¹¶å°†é•¿åº¦å­˜å‚¨åœ¨å¯„å­˜å™¨ <code>r1</code> ä¸­ã€‚</p><p><strong>Listing 3. String Length</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">        b start</span><br><span class="line"></span><br><span class="line">str:    .asciz &quot;Hello World&quot;</span><br><span class="line"></span><br><span class="line">        .equ   nul, 0</span><br><span class="line"></span><br><span class="line">        .align</span><br><span class="line">start:  ldr   r0, =str          @ r0 = &amp;str</span><br><span class="line">        mov   r1, #0</span><br><span class="line"></span><br><span class="line">loop:   ldrb  r2, [r0], #1      @ r2 = *(r0++)</span><br><span class="line">        add   r1, r1, #1        @ r1 += 1</span><br><span class="line">        cmp   r2, #nul          @ if (r2 != nul)</span><br><span class="line">        bne   loop              @    goto loop</span><br><span class="line"></span><br><span class="line">        sub   r1, r1, #1        @ r1 -= 1</span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure><p>è¯¥ä»£ç å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„æ±‡ç¼–æŒ‡ä»¤â€”â€”<code>.asciz</code> å’Œ <code>.equ</code>ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™äº›æ±‡ç¼–æŒ‡ä»¤çš„æè¿°ã€‚</p><h4 id="4-2-1-asciz-Directive"><a href="#4-2-1-asciz-Directive" class="headerlink" title="4.2.1. .asciz Directive"></a>4.2.1. <code>.asciz</code> Directive</h4><p><code>.asciz</code> æŒ‡ä»¤æ¥å—å­—ç¬¦ä¸²å­—é¢é‡ä½œä¸ºå‚æ•°ã€‚<strong>å­—ç¬¦ä¸²å­—é¢é‡æ˜¯ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦åºåˆ—</strong>ã€‚è¿™äº›å­—ç¬¦ä¸²å­—é¢é‡è¢«ç»„è£…åˆ°è¿ç»­çš„å†…å­˜ä½ç½®ã€‚æ±‡ç¼–ç¨‹åºä¼šè‡ªåŠ¨åœ¨æ¯ä¸ªå­—ç¬¦ä¸²åæ’å…¥ä¸€ä¸ª <code>nul</code> å­—ç¬¦ï¼ˆ<code>\0</code> å­—ç¬¦ï¼‰ã€‚</p><p><code>.ascii</code> æŒ‡ä»¤ä¸ <code>.asciz</code> ç›¸åŒï¼Œä½†<strong>æ±‡ç¼–ç¨‹åºä¸ä¼šåœ¨æ¯ä¸ªå­—ç¬¦ä¸²åæ’å…¥ <code>nul</code> å­—ç¬¦</strong>ã€‚</p><blockquote><p>â›”â›”â›” æ³¨æ„äºŒè€…åŒºåˆ«ã€‚</p></blockquote><h4 id="4-2-2-equ-Directive"><a href="#4-2-2-equ-Directive" class="headerlink" title="4.2.2. .equ Directive"></a>4.2.2. <code>.equ</code> Directive</h4><p>æ±‡ç¼–ç¨‹åºç»´æŠ¤ä¸€ä¸ªç§°ä¸ºç¬¦å·è¡¨çš„ç»“æ„ã€‚ç¬¦å·è¡¨å°†æ ‡ç­¾åç§°æ˜ å°„åˆ°åœ°å€ã€‚<strong>æ¯å½“æ±‡ç¼–ç¨‹åºé‡åˆ°æ ‡ç­¾å®šä¹‰æ—¶ï¼Œå®ƒä¼šåœ¨ç¬¦å·è¡¨ä¸­åˆ›å»ºä¸€ä¸ªæ¡ç›®</strong>ã€‚æ¯å½“æ±‡ç¼–ç¨‹åºé‡åˆ°æ ‡ç­¾å¼•ç”¨æ—¶ï¼Œå®ƒä¼šç”¨ç¬¦å·è¡¨ä¸­å¯¹åº”çš„åœ°å€æ›¿æ¢è¯¥æ ‡ç­¾ã€‚</p><p>ğŸ’¡ğŸ’¡<strong>ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤ <code>.equ</code>ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å‘ç¬¦å·è¡¨ä¸­æ’å…¥æ¡ç›®ï¼Œå°†åç§°æ˜ å°„åˆ°ä¸ä¸€å®šæ˜¯åœ°å€çš„å€¼</strong>ã€‚æ¯å½“æ±‡ç¼–ç¨‹åºé‡åˆ°è¿™äº›åç§°æ—¶ï¼Œå®ƒä¼šç”¨ç›¸åº”çš„å€¼æ›¿æ¢å®ƒä»¬ã€‚è¿™äº›åç§°å’Œæ ‡ç­¾åç§°ç»Ÿç§°ä¸º<strong>ç¬¦å·åç§°</strong>ã€‚</p><p>è¯¥æŒ‡ä»¤çš„ä¸€èˆ¬è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The assembler maintains something called a symbol table. The symbol table maps label names to addresses.</span><br><span class="line">Whenever the assembler encounters a label definition, the assembler makes an entry in the symbol table.</span><br><span class="line">And whenever the assembler encounters a label reference, it replaces the label by the corresponding</span><br><span class="line">address from the symbol table.</span><br><span class="line"></span><br><span class="line">Using the assembler directive `.equ`, it is also possible to manually insert entries in the symbol table,</span><br><span class="line">to map names to values, which are not necessarily addresses. Whenever the assembler encounters these names,</span><br><span class="line">it replaces them by their corresponding values. These names and label names are together called symbol names.</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.equ name, expression</span><br></pre></td></tr></table></figure><ul><li><code>name</code> æ˜¯ä¸€ä¸ªç¬¦å·åç§°ï¼Œå…¶é™åˆ¶ä¸æ ‡ç­¾åç§°ç›¸åŒã€‚</li><li><code>expression</code> å¯ä»¥æ˜¯ç®€å•çš„å­—é¢é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¦‚ <code>.byte</code> æŒ‡ä»¤ä¸­æ‰€è§£é‡Šçš„è¡¨è¾¾å¼ã€‚</li></ul><blockquote><p>ä¸ <code>.byte</code> æŒ‡ä»¤ä¸åŒï¼Œ<code>.equ</code> æŒ‡ä»¤æœ¬èº«å¹¶ä¸åˆ†é…ä»»ä½•å†…å­˜ã€‚å®ƒä»¬åªæ˜¯åˆ›å»ºç¬¦å·è¡¨ä¸­çš„æ¡ç›®ã€‚</p></blockquote><h2 id="5-Using-RAM"><a href="#5-Using-RAM" class="headerlink" title="5. Using RAM"></a>5. Using RAM</h2><p>Flash å­˜å‚¨å™¨ä¸­å­˜å‚¨çš„å‰é¢çš„ç¤ºä¾‹ç¨‹åºæ˜¯ä¸€ç§ EEPROMã€‚å®ƒæ˜¯ä¸€ç§æœ‰ç”¨çš„äºŒçº§å­˜å‚¨ï¼Œç±»ä¼¼äºç¡¬ç›˜ï¼Œä½†åœ¨ Flash ä¸­å­˜å‚¨å˜é‡å¹¶ä¸æ–¹ä¾¿ã€‚å˜é‡åº”å­˜å‚¨åœ¨ RAM ä¸­ï¼Œä»¥ä¾¿å¯ä»¥è½»æ¾ä¿®æ”¹ã€‚</p><p>Connex æ¿å…·æœ‰ 64 MB çš„ RAMï¼Œä»åœ°å€ <code>0xA0000000</code> å¼€å§‹ï¼Œå¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨å˜é‡ã€‚Connex æ¿çš„å†…å­˜æ˜ å°„å¯ä»¥å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><strong>Figure 1. Memory Map</strong></p><p><img src="/../images/GNUToolchain/flash-ram-mm.png" alt="Memory Map"></p><p>éœ€è¦è¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œä»¥å°†å˜é‡æ”¾ç½®åœ¨è¯¥åœ°å€ã€‚è¦ç†è§£éœ€è¦åšä»€ä¹ˆï¼Œå°±å¿…é¡»äº†è§£æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨çš„è§’è‰²ã€‚</p><blockquote><p>ä¸ªäººç†è§£ï¼šæ±‡ç¼–å™¨å°†å•ä¸ªæ–‡ä»¶è§£é‡Šä¸ºæœºå™¨æŒ‡ä»¤ã€‚é“¾æ¥å™¨å°†è¿™äº›æœºå™¨æŒ‡ä»¤ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p></blockquote><h2 id="6-Linker"><a href="#6-Linker" class="headerlink" title="6. Linker"></a>6. Linker</h2><p>åœ¨ç¼–å†™å¤šæ–‡ä»¶ç¨‹åºæ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶ä¼šå•ç‹¬æ±‡ç¼–æˆç›®æ ‡æ–‡ä»¶ã€‚é“¾æ¥å™¨å°†è¿™äº›ç›®æ ‡æ–‡ä»¶ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><p><strong>Figure 2. Role of the Linker</strong></p><p><img src="/../images/GNUToolchain/linker.png" alt="Role of the Linker"></p><p>åœ¨åˆå¹¶ç›®æ ‡æ–‡ä»¶æ—¶ï¼Œ<strong>é“¾æ¥å™¨</strong>æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li>Symbol Resolution ç¬¦å·è§£æ</li><li>Relocation é‡å®šä½</li></ol><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»è¿™äº›æ“ä½œã€‚</p><h3 id="6-1-Symbol-Resolution"><a href="#6-1-Symbol-Resolution" class="headerlink" title="6.1. Symbol Resolution"></a>6.1. Symbol Resolution</h3><p>åœ¨å•æ–‡ä»¶ç¨‹åºä¸­ï¼Œåœ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶æ—¶ï¼Œæ±‡ç¼–å™¨å°†æ‰€æœ‰æ ‡ç­¾çš„å¼•ç”¨æ›¿æ¢ä¸ºç›¸åº”çš„åœ°å€ã€‚ä½†åœ¨å¤šæ–‡ä»¶ç¨‹åºä¸­ï¼Œå¦‚æœå­˜åœ¨å¯¹å…¶ä»–æ–‡ä»¶ä¸­å®šä¹‰çš„æ ‡ç­¾çš„å¼•ç”¨ï¼Œæ±‡ç¼–å™¨å°†è¿™äº›å¼•ç”¨æ ‡è®°ä¸ºâ€œ<strong>æœªè§£å†³</strong>â€ã€‚å½“è¿™äº›ç›®æ ‡æ–‡ä»¶è¢«ä¼ é€’ç»™é“¾æ¥å™¨æ—¶ï¼Œé“¾æ¥å™¨ä»å…¶ä»–ç›®æ ‡æ–‡ä»¶ä¸­ç¡®å®šè¿™äº›å¼•ç”¨çš„å€¼ï¼Œå¹¶ä½¿ç”¨æ­£ç¡®çš„å€¼ä¿®è¡¥ä»£ç ã€‚</p><blockquote><p>æƒ³æƒ³åŠ¨æ€åº“çš„ä¾‹å­ï¼Œæ¿ç«¯è¿è¡Œç¨‹åºæ—¶æ‰å»ä½¿ç”¨é“¾æ¥å™¨è¿›è¡Œé“¾æ¥ï¼Œè€Œæ±‡ç¼–å™¨ä»…åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ã€‚é“¾æ¥å™¨ä¹Ÿå¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ï¼Œé™æ€é“¾æ¥ <code>-static</code>ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In a single file program, while producing the object file, all references to labels are replaced by</span><br><span class="line">their corresponding addresses by the assembler. But in a multi-file program, if there are any references</span><br><span class="line">to labels defined in another file, the assembler marks these references as &quot;unresolved&quot;.</span><br><span class="line">When these object files are passed to the linker, the linker determines the values for</span><br><span class="line">these references from the other object files, and patches the code with the correct values.</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ¼”ç¤ºé“¾æ¥å™¨æ‰§è¡Œçš„<strong>ç¬¦å·è§£æ</strong>ï¼Œæ•°ç»„æ±‚å’Œç¤ºä¾‹è¢«åˆ†ä¸ºä¸¤ä¸ªæ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶å°†è¢«æ±‡ç¼–ï¼Œå¹¶æ£€æŸ¥å®ƒä»¬çš„ç¬¦å·è¡¨ï¼Œä»¥æ˜¾ç¤ºæœªè§£å†³å¼•ç”¨çš„å­˜åœ¨ã€‚</p><p>æ–‡ä»¶ <code>sum-sub.s</code> åŒ…å« <code>sum</code> å­ç¨‹åºï¼Œè€Œæ–‡ä»¶ <code>main.s</code> ä½¿ç”¨æ‰€éœ€çš„å‚æ•°è°ƒç”¨è¯¥å­ç¨‹åºã€‚æ–‡ä»¶çš„æºä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><strong>Listing 4. <code>main.s</code> - Subroutine Invocation</strong> å­ç¨‹åºè°ƒç”¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">        b start                 @ Skip over the data</span><br><span class="line">arr:    .byte 10, 20, 25        @ Read-only array of bytes</span><br><span class="line">eoa:                            @ Address of end of array + 1</span><br><span class="line"></span><br><span class="line">        .align</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =arr          @ r0 = &amp;arr</span><br><span class="line">        ldr   r1, =eoa          @ r1 = &amp;eoa</span><br><span class="line"></span><br><span class="line">        bl    sum               @ Invoke the sum subroutine</span><br><span class="line"></span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure><p>**Listing 5. <code>sum-sub.s</code> - Subroutine Definition **å­ç¨‹åºå®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        @ Args</span><br><span class="line">        @ r0: Start address of array</span><br><span class="line">        @ r1: End address of array</span><br><span class="line">        @</span><br><span class="line">        @ Result</span><br><span class="line">        @ r3: Sum of Array</span><br><span class="line"></span><br><span class="line">        .global sum</span><br><span class="line"></span><br><span class="line">sum:    mov   r3, #0            @ r3 = 0</span><br><span class="line">loop:   ldrb  r2, [r0], #1      @ r2 = *r0++    ; Get array element</span><br><span class="line">        add   r3, r2, r3        @ r3 += r2      ; Calculate sum</span><br><span class="line">        cmp   r0, r1            @ if (r0 != r1) ; Check if hit end-of-array</span><br><span class="line">        bne   loop              @    goto loop  ; Loop</span><br><span class="line">        mov   pc, lr            @ pc = lr       ; Return when done</span><br></pre></td></tr></table></figure><p>å…³äº <code>.global</code> æŒ‡ä»¤éœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ‰€æœ‰åœ¨å‡½æ•°å¤–éƒ¨å£°æ˜çš„å˜é‡å¯¹å…¶ä»–æ–‡ä»¶å¯è§ï¼Œç›´åˆ°æ˜ç¡®å£°æ˜ä¸º <code>static</code>ã€‚<br><strong>ä½†</strong>åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œæ‰€æœ‰æ ‡ç­¾éƒ½æ˜¯ <code>static</code>ï¼ˆå³æœ¬åœ°æ–‡ä»¶çš„ï¼‰ï¼Œç›´åˆ°æ˜ç¡®å£°æ˜å®ƒä»¬åº”è¯¥å¯¹å…¶ä»–æ–‡ä»¶å¯è§ï¼Œä½¿ç”¨ <code>.global</code> æŒ‡ä»¤ã€‚</p><p>è¿™äº›æ–‡ä»¶è¢«æ±‡ç¼–ï¼Œå¹¶ä½¿ç”¨ <code>nm</code> å‘½ä»¤æŸ¥çœ‹ç¬¦å·è¡¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o main.o main.s</span><br><span class="line">$ arm-linux-gnueabihf-as -o sum-sub.o sum-sub.s</span><br><span class="line">$ arm-linux-gnueabihf-nm main.o</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa <span class="comment"># æ³¨æ„çœ‹è¿™é‡Œå¹¶æ²¡æœ‰å¯¹é½ï¼Œå›é¡¾ä¸Šé¢ `.align` æŒ‡ä»¤</span></span><br><span class="line">00000008 t start</span><br><span class="line">00000018 t stop</span><br><span class="line">         U <span class="built_in">sum</span></span><br><span class="line">$ arm-linux-gnueabihf-nm sum-sub.o</span><br><span class="line">00000004 t loop</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br></pre></td></tr></table></figure><p>å…³æ³¨ç¬¬äºŒåˆ—ä¸­çš„å­—æ¯ï¼Œå®ƒæŒ‡å®šäº†ç¬¦å·ç±»å‹ã€‚<code>t</code> è¡¨ç¤ºç¬¦å·åœ¨æ–‡æœ¬æ®µä¸­å®šä¹‰ã€‚<code>u</code> è¡¨ç¤ºç¬¦å·æœªå®šä¹‰ã€‚**:fire: å¤§å†™å­—æ¯è¡¨ç¤ºç¬¦å·æ˜¯** <code>.global</code>ã€‚</p><p>æ˜¾ç„¶ï¼Œç¬¦å· <code>sum</code> åœ¨ <code>sum-sub.o</code> ä¸­å®šä¹‰ï¼Œåœ¨ <code>main.o</code> ä¸­å°šæœªè§£æã€‚å½“é“¾æ¥å™¨è¢«è°ƒç”¨æ—¶ï¼Œç¬¦å·å¼•ç”¨å°†è¢«è§£æï¼Œå¹¶ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p><h3 id="6-2-Relocation"><a href="#6-2-Relocation" class="headerlink" title="6.2. Relocation"></a>6.2. Relocation</h3><p>Relocation is the process of changing addresses already assigned to labels. This will also involve patching up all label references to reflect the newly assigned address. Primarily, relocation is performed for the following two reasons:</p><p>é‡å®šä½æ˜¯æ›´æ”¹å·²åˆ†é…ç»™æ ‡ç­¾çš„åœ°å€çš„è¿‡ç¨‹ã€‚è¿™ä¹Ÿæ¶‰åŠä¿®è¡¥æ‰€æœ‰æ ‡ç­¾å¼•ç”¨ä»¥åæ˜ æ–°åˆ†é…çš„åœ°å€ã€‚ä¸»è¦ï¼Œé‡å®šä½æ˜¯å‡ºäºä»¥ä¸‹ä¸¤ä¸ªåŸå› ï¼š</p><ol><li>Section Merging æ®µåˆå¹¶</li><li>Section Placement æ®µæ”¾ç½®</li></ol><p>To understand the process of relocation, an understanding of the concept of sections is essential.</p><p>è¦ç†è§£é‡å®šä½çš„è¿‡ç¨‹ï¼Œå¿…é¡»ç†è§£æ®µçš„æ¦‚å¿µã€‚</p><p>Code and data have different run time requirements. For example code can be placed in read-only memory, and data might require read-write memory. It would be convenient, if code and data is <strong>not</strong> interleaved. For this purpose, programs are divided into sections. Most programs have at least two sections, <code>.text</code> for code and <code>.data</code> for data. Assembler directives <code>.text</code> and <code>.data</code>, are used to switch back and forth between the two sections.</p><p>ä»£ç å’Œæ•°æ®åœ¨è¿è¡Œæ—¶æœ‰ä¸åŒçš„è¦æ±‚ã€‚ä¾‹å¦‚ï¼Œä»£ç å¯ä»¥æ”¾ç½®åœ¨åªè¯»å†…å­˜ä¸­ï¼Œè€Œæ•°æ®å¯èƒ½éœ€è¦è¯»å†™å†…å­˜ã€‚å¦‚æœä»£ç å’Œæ•°æ®<strong>ä¸</strong>äº¤é”™æ”¾ç½®ï¼Œå°†ä¼šæ›´æ–¹ä¾¿ã€‚ä¸ºæ­¤ï¼Œç¨‹åºè¢«åˆ†ä¸ºä¸åŒçš„æ®µã€‚å¤§å¤šæ•°ç¨‹åºè‡³å°‘æœ‰ä¸¤ä¸ªæ®µï¼Œ<code>.text</code> ç”¨äºä»£ç ï¼Œ<code>.data</code> ç”¨äºæ•°æ®ã€‚æ±‡ç¼–æŒ‡ä»¤ <code>.text</code> å’Œ <code>.data</code> ç”¨äºåœ¨è¿™ä¸¤ä¸ªæ®µä¹‹é—´åˆ‡æ¢ã€‚</p><p>It helps to imagine each section as a bucket. When the assembler hits a section directive, it puts the code&#x2F;data following the directive in the selected bucket. Thus the code&#x2F;data that belong to particular section appear in contiguous locations. The following figures show how the assembler re-arranges data into sections.</p><p>æƒ³è±¡æ¯ä¸ªæ®µéƒ½æ˜¯ä¸€ä¸ªæ¡¶ã€‚å½“æ±‡ç¼–å™¨é‡åˆ°æ®µæŒ‡ä»¤æ—¶ï¼Œå®ƒä¼šå°†æ®µæŒ‡ä»¤åé¢çš„ä»£ç &#x2F;æ•°æ®æ”¾å…¥æ‰€é€‰çš„æ¡¶ä¸­ã€‚å› æ­¤ï¼Œå±äºç‰¹å®šæ®µçš„ä»£ç &#x2F;æ•°æ®ä¼šå‡ºç°åœ¨è¿ç»­çš„ä½ç½®ã€‚ä»¥ä¸‹å›¾æ˜¾ç¤ºäº†æ±‡ç¼–å™¨å¦‚ä½•å°†æ•°æ®é‡æ–°æ’åˆ—åˆ°æ®µä¸­ã€‚</p><p><strong>Figure 3. Sections</strong></p><p><img src="/../images/GNUToolchain/sections.png" alt="Sections"></p><p>Now that we have an understanding of sections, let us look into the primary reasons for which relocation is performed.</p><p>ç°åœ¨æˆ‘ä»¬ç†è§£äº†æ®µçš„æ¦‚å¿µï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹é‡å®šä½çš„ä¸»è¦åŸå› ã€‚</p><h4 id="6-2-1-Section-Merging"><a href="#6-2-1-Section-Merging" class="headerlink" title="6.2.1. Section Merging"></a>6.2.1. Section Merging</h4><p>When dealing with multi-file programs, the sections with the same name (example <code>.text</code>) might appear, in each file. The linker is responsible for merging sections from the input files, into sections of the output file. By default, the sections, with the same name, from each file is placed contiguously and the label references are patched to reflect the new address.</p><p>å¤„ç†å¤šæ–‡ä»¶ç¨‹åºæ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸­å¯èƒ½å‡ºç°åŒåçš„æ®µï¼ˆä¾‹å¦‚ <code>.text</code>ï¼‰ã€‚é“¾æ¥å™¨è´Ÿè´£å°†è¾“å…¥æ–‡ä»¶ä¸­çš„ç›¸åŒåç§°çš„æ®µåˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶çš„æ®µä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥è‡ªæ¯ä¸ªæ–‡ä»¶çš„åŒåæ®µè¢«è¿ç»­æ”¾ç½®ï¼Œæ ‡ç­¾å¼•ç”¨ä¹Ÿä¼šä¿®è¡¥ä»¥åæ˜ æ–°åœ°å€ã€‚</p><p>The effects of section merging can be seen by looking at the symbol table of the object files and the corresponding executable file. The multi-file sum of array program can be used to illustrate section merging. The symbol table of the object files <code>main.o</code> and <code>sum-sub.o</code> and the symbol table of the executable file <code>sum.elf</code> is shown below.</p><p>å¯ä»¥é€šè¿‡æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œçœ‹åˆ°æ®µåˆå¹¶çš„æ•ˆæœã€‚å¯ä»¥ä½¿ç”¨å¤šæ–‡ä»¶çš„æ•°ç»„æ±‚å’Œç¨‹åºæ¥è¯´æ˜æ®µåˆå¹¶çš„è¿‡ç¨‹ã€‚ç›®æ ‡æ–‡ä»¶ <code>main.o</code> å’Œ <code>sum-sub.o</code> çš„ç¬¦å·è¡¨ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶ <code>sum.elf</code> çš„ç¬¦å·è¡¨å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm main.o</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000018 t stop</span><br><span class="line">         U <span class="built_in">sum</span></span><br><span class="line">$ arm-linux-gnueabihf-nm sum-sub.o</span><br><span class="line">00000004 t loop â¶</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x0 -o sum.elf main.o sum-sub.o</span><br><span class="line">$ arm-linux-gnueabihf-nm sum.elf</span><br><span class="line">...</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000018 t stop</span><br><span class="line">00000028 t loop â¶</span><br><span class="line">00000024 T <span class="built_in">sum</span></span><br></pre></td></tr></table></figure><ol><li><p>The <code>loop</code> symbol has address <code>0x4</code> in <code>sum-sub.o</code>, and <code>0x28</code> in <code>sum.elf</code>, since the <code>.text</code> section of <code>sum-sub.o</code> is placed right after the <code>.text</code> section of <code>main.o</code>.</p><p>è¯¥<code>loop</code>ç¬¦å·çš„åœ°å€<code>0x4</code>åœ¨<code>sum-sub.o</code>ï¼Œ<code>0x28</code>åœ¨ <code>sum.elf</code>oçš„<code>.text</code>éƒ¨åˆ†<code>sum-sub.o</code>å³è¾¹ åœ¨main. oçš„<code>.text</code>éƒ¨åˆ†<code>main.o</code>ã€‚</p></li></ol><h4 id="6-2-2-Section-Placement"><a href="#6-2-2-Section-Placement" class="headerlink" title="6.2.2. Section Placement"></a>6.2.2. Section Placement</h4><p>å½“ç¨‹åºè¢«æ±‡ç¼–æ—¶ï¼Œæ¯ä¸ªæ®µè¢«å‡å®šä»åœ°å€ 0 å¼€å§‹ã€‚å› æ­¤ï¼Œæ ‡ç­¾ç›¸å¯¹äºæ®µçš„èµ·å§‹ä½ç½®åˆ†é…å€¼ã€‚å½“æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºæ—¶ï¼Œè¯¥æ®µè¢«æ”¾ç½®åœ¨æŸä¸ªåœ°å€ Xã€‚æ‰€æœ‰åœ¨è¯¥æ®µå†…å®šä¹‰çš„æ ‡ç­¾çš„å¼•ç”¨éƒ½å°†å¢åŠ  Xï¼Œä»¥ä½¿å®ƒä»¬æŒ‡å‘æ–°ä½ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">When a program is assembled, each section is assumed to start from address 0. And thus labels are assigned values relative to start of the section. When the final executable is created, the section is placed at some address X. And all references to the labels defined within the section, are incremented by X, so that they point to the new location.</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªæ®µåœ¨å†…å­˜ä¸­ç‰¹å®šä½ç½®çš„æ”¾ç½®ä»¥åŠå¯¹æ®µä¸­æ ‡ç­¾çš„æ‰€æœ‰å¼•ç”¨çš„ä¿®è¡¥ï¼Œç”±é“¾æ¥å™¨å®Œæˆã€‚</p><p>The placement of each section at a particular location in memory and the patching of all references to the labels in the section, is done by the linker.</p><p>å¯ä»¥é€šè¿‡æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œçœ‹åˆ°æ®µæ”¾ç½®çš„æ•ˆæœã€‚å¯ä»¥ä½¿ç”¨å•æ–‡ä»¶çš„æ•°ç»„æ±‚å’Œç¨‹åºæ¥è¯´æ˜æ®µæ”¾ç½®çš„è¿‡ç¨‹ã€‚ä¸ºäº†æ›´æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬å°†æŠŠ .text æ®µæ”¾ç½®åœ¨åœ°å€ 0x100ã€‚</p><p>The effects of section placement can be seen by looking at the symbol table of the object file and the corresponding executable file. The single file sum of array program can be used to illustrate section placement. To make things clearer, we will place the <code>.text</code> section at address <code>0x100</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o sum.o sum.s</span><br><span class="line">$ arm-linux-gnueabihf-nm -n sum.o</span><br><span class="line">00000000 t entry â¶</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000014 t loop</span><br><span class="line">00000024 t stop</span><br><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x100 -o sum.elf sum.o â·</span><br><span class="line">$ arm-linux-gnueabihf-nm -n sum.elf</span><br><span class="line">00000100 t entry â¸</span><br><span class="line">00000104 t arr</span><br><span class="line">00000107 t eoa</span><br><span class="line">00000108 t start</span><br><span class="line">00000114 t loop</span><br><span class="line">00000124 t stop</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><a href="https://www.bravegnu.org/gnu-eprog/linker.html#CO2-1">â¶</a> | The address for labels are assigned starting from <code>0</code> within a section. æ®µå†…æ ‡ç­¾çš„åœ°å€ä» 0 å¼€å§‹åˆ†é…ã€‚ |<br>| <a href="https://www.bravegnu.org/gnu-eprog/linker.html#CO2-2">â·</a> | When the executable is created the linker is instructed to place the text section at address <code>0x100</code>. å½“å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºæ—¶ï¼Œé“¾æ¥å™¨è¢«æŒ‡ç¤ºå°†æ–‡æœ¬æ®µæ”¾ç½®åœ¨åœ°å€ 0x100ã€‚ |<br>| <a href="https://www.bravegnu.org/gnu-eprog/linker.html#CO2-3">â¸</a> | The address for labels in the <code>.text</code> section are re-assigned starting from <code>0x100</code>, and all label references will be patched to reflect this. <code>.text</code> æ®µä¸­çš„æ ‡ç­¾çš„åœ°å€è¢«é‡æ–°åˆ†é…ï¼Œèµ·å§‹åœ°å€ä¸º 0x100ï¼Œæ‰€æœ‰æ ‡ç­¾å¼•ç”¨å°†è¢«ä¿®è¡¥ä»¥åæ˜ æ­¤æ›´æ”¹ã€‚ |</p><p>The process of section merging and placement is shown in the following figure.</p><p>æ®µåˆå¹¶å’Œæ”¾ç½®çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><strong>Figure 4. Section Merging and Placement</strong></p><p><img src="/../images/GNUToolchain/relocation.png" alt="Section Merging and Placement"></p><hr><h2 id="7-Linker-Script-File"><a href="#7-Linker-Script-File" class="headerlink" title="7. Linker Script File"></a>7. Linker Script File</h2><p>As mentioned in the previous section, section merging and placement is done by the linker. The programmer can control how the sections are merged, and at what locations they are placed in memory through a linker script file. A very simple linker script file, is shown below.</p><p>å¦‚ä¸Šä¸€èŠ‚æ‰€è¿°ï¼ŒèŠ‚åˆå¹¶å’Œæ”¾ç½®æ˜¯ç”±é“¾æ¥å™¨å®Œæˆçš„ã€‚ç¨‹åºå‘˜å¯ä»¥é€šè¿‡é“¾æ¥å™¨è„šæœ¬æ–‡ä»¶æ§åˆ¶éƒ¨åˆ†çš„åˆå¹¶æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬åœ¨å†…å­˜ä¸­çš„ä½ç½®ã€‚ä¸€ä¸ªéå¸¸ç®€å•çš„é“¾æ¥å™¨è„šæœ¬æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><strong>Listing 6. Basic linker script</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123; â¶</span><br><span class="line">        . = 0x00000000; â·</span><br><span class="line">        .text : &#123; â¸</span><br><span class="line">                abc.o (.text);</span><br><span class="line">                def.o (.text);</span><br><span class="line">        &#125; â¹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>The <code>SECTIONS</code> command is the most important linker command, it specifies how the sections are to be merged and at what location they are to be placed.<br>è¯¥<code>SECTIONS</code>å‘½ä»¤æ˜¯æœ€é‡è¦çš„é“¾æ¥å™¨ å‘½ä»¤ï¼Œå®ƒæŒ‡å®šå¦‚ä½•åˆå¹¶éƒ¨åˆ†ä»¥åŠåˆå¹¶åˆ°ä»€ä¹ˆä½ç½® å®ƒä»¬è¦æ”¾ç½®çš„ä½ç½®ã€‚</li><li>Within the block following the <code>SECTIONS</code> command, the <code>.</code> (period) represents the location counter. The location is always initialised to <code>0x0</code>. It can be modified by assigning a new value to it. Setting the value to <code>0x0</code> at the beginning is superfluous.<br>åœ¨åé¢çš„å—å†… <code>SECTIONS</code>å‘½ä»¤ä¸­ï¼Œ<code>.</code>ï¼ˆå¥ç‚¹ï¼‰è¡¨ç¤ºä½ç½®è®¡æ•°å™¨ ä½ç½®æ€»æ˜¯åˆå§‹åŒ–ä¸º<code>0x0</code>ã€‚ å¯ä»¥é€šè¿‡ä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°å€¼æ¥ä¿®æ”¹å®ƒã€‚è®¾ç½® å¼€å¤´<code>0x0</code>çš„å€¼æ˜¯ å¤šä½™çš„ã€‚</li><li>This part of the script specifies that, the <code>.text</code> section from the input files <code>abc.o</code> and <code>def.o</code> should go to the <code>.text</code> section of the output file.<br>è„šæœ¬çš„è¿™ä¸€éƒ¨åˆ†æŒ‡å®š è¾“å…¥ä¸­çš„<code>.text</code>éƒ¨åˆ† æ–‡ä»¶<code>abc.o</code>å’Œ<code>def.o</code>åº”è¯¥è½¬åˆ°è¾“å‡ºæ–‡ä»¶çš„<code>.text</code>éƒ¨åˆ†ã€‚</li></ol><p>The linker script can be further simplified and generalised by using the wild card character <code>*</code> instead of individually specifying the file names.</p><p>é“¾æ¥å™¨è„šæœ¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›ä¸€æ­¥ç®€åŒ–å’Œæ¦‚æ‹¬ ä½¿ç”¨é€šé…ç¬¦<code>*</code> è€Œä¸æ˜¯å•ç‹¬æŒ‡å®šæ–‡ä»¶åã€‚</p><p><strong>Listing 7. Wildcard in linker scripts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123; * (.text); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>If the program contains both <code>.text</code> and <code>.data</code> sections, the <code>.data</code> section merging and location can be specified as shown below.</p><p>å¦‚æœç¨‹åºåŒæ—¶åŒ…å«<code>.text</code> å’Œ<code>.data</code>éƒ¨åˆ†ï¼Œ<code>.data</code>éƒ¨åˆ†åˆå¹¶å’Œä½ç½®å¯ä»¥æ˜¯ æŒ‡å®šå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p><strong>Listing 8. Multiple sections in linker scripts</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">         . = 0x00000000;</span><br><span class="line">         .text : &#123; * (.text); &#125;</span><br><span class="line"></span><br><span class="line">         . = 0x00000400;</span><br><span class="line">         .data : &#123; * (.data); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Here, the <code>.text</code> section is located at <code>0x0</code> and <code>.data</code> is located at <code>0x400</code>. Note that, if the location counter is not assigned a different value, the <code>.text</code> and <code>.data</code> sections will be located at adjacent memory locations.</p><p>åœ¨è¿™é‡Œï¼Œ<code>.text</code>éƒ¨åˆ†ä½äº at<code>0x0</code>å’Œ<code>.data</code>ä½äº<code>0x400</code>ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœä½ç½®è®¡æ•°å™¨ä¸æ˜¯ åˆ†é…äº†ä¸åŒçš„å€¼ï¼Œ<code>.text</code> å’Œ<code>.data</code>éƒ¨åˆ†å°†ä½äº ç›¸é‚»çš„å†…å­˜ä½ç½®ã€‚</p><h3 id="7-1-Linker-Script-Example"><a href="#7-1-Linker-Script-Example" class="headerlink" title="7.1. Linker Script Example"></a>7.1. Linker Script Example</h3><p>To demonstrate the use of linker scripts, we will use the linker script shown in <a href="https://www.bravegnu.org/gnu-eprog/lds.html#linker1">Listing 8, â€œMultiple sections in linker scriptsâ€</a> to control the placement of a programâ€™s <code>.text</code> and <code>.data</code> section. We will use a slightly modified version of the sum of array program for this purpose. The code is shown below.</p><p>ä¸ºäº†æ¼”ç¤ºé“¾æ¥å™¨è„šæœ¬çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é“¾æ¥å™¨ è„šæœ¬å¦‚<a href="https://www.bravegnu.org/gnu-eprog/lds.html#linker1">æ¸…å•8æ‰€ç¤ºï¼Œâ€œé“¾æ¥å™¨è„šæœ¬ä¸­çš„å¤šä¸ªéƒ¨åˆ†â€</a>æ¥æ§åˆ¶ ç¨‹åº<code>.text</code>å’Œ<code>.data</code> éƒ¨åˆ†ã€‚æˆ‘ä»¬å°†ä½¿ç”¨æ€»å’Œçš„ç¨å¾®ä¿®æ”¹çš„ç‰ˆæœ¬ ç”¨äºæ­¤ç›®çš„çš„æ•°ç»„ç¨‹åºã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        .data</span><br><span class="line">arr:    .byte 10, 20, 25        @ Read-only array of bytes</span><br><span class="line">eoa:                            @ Address of end of array + 1</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =eoa          @ r0 = &amp;eoa</span><br><span class="line">        ldr   r1, =arr          @ r1 = &amp;arr</span><br><span class="line">        mov   r3, #0            @ r3 = 0</span><br><span class="line">loop:   ldrb  r2, [r1], #1      @ r2 = *r1++</span><br><span class="line">        add   r3, r2, r3        @ r3 += r2</span><br><span class="line">        cmp   r1, r0            @ if (r1 != r2)</span><br><span class="line">        bne   loop              @    goto loop</span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure><p>The only change here is that the array is now in the <code>.data</code> section. Also note that the nasty branch instruction to skip over the data is also not required, since the linker script will place the <code>.text</code> section and <code>.data</code> section appropriately. As a result, statements can be placed in the program, in any convenient way, and the linker script will take care of placing the sections correctly in memory.</p><p>è¿™é‡Œå”¯ä¸€çš„å˜åŒ–æ˜¯æ•°ç»„ç°åœ¨åœ¨ <code>.data</code>éƒ¨åˆ†ã€‚è¿˜è¦æ³¨æ„ è®¨åŒçš„åˆ†æ”¯æŒ‡ä»¤è·³è¿‡æ•°æ®ä¹Ÿä¸æ˜¯ å¿…éœ€ï¼Œå› ä¸ºé“¾æ¥å™¨è„šæœ¬å°†é€‚å½“åœ°æ”¾ç½®<code>.text</code>éƒ¨åˆ†å’Œ<code>.data</code>éƒ¨åˆ†ã€‚ç»“æœï¼Œ è¯­å¥å¯ä»¥ä»¥ä»»ä½•æ–¹ä¾¿çš„æ–¹å¼æ”¾ç½®åœ¨ç¨‹åºä¸­ï¼Œå¹¶ä¸” é“¾æ¥å™¨è„šæœ¬å°†è´Ÿè´£æ­£ç¡®æ”¾ç½®éƒ¨åˆ† åœ¨è®°å¿†ä¸­ã€‚</p><p>When the program is linked, the linker script is passed as an input to the linker, as shown in the following command.</p><p>é“¾æ¥ç¨‹åºæ—¶ï¼Œé“¾æ¥å™¨è„šæœ¬ä½œä¸ºè¾“å…¥ä¼ é€’ç»™é“¾æ¥å™¨ï¼Œå¦‚ä»¥ä¸‹å‘½ä»¤æ‰€ç¤ºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o sum-data.o sum-data.s</span><br><span class="line">$ arm-linux-gnueabihf-ld -T sum-data.lds -o sum-data.elf sum-data.o</span><br></pre></td></tr></table></figure><p>The option <code>-T sum-data.lds</code> specifies that <code>sum-data.lds</code> is to be used as the linker script. Dumping the symbol table, will provide an insight into how the sections are placed in memory.</p><p>é€‰é¡¹ <code>-T sum-data.lds</code> æŒ‡å®š <code>sum-data.lds</code> å°†è¢«ç”¨ä½œé“¾æ¥è„šæœ¬ã€‚è½¬å‚¨ç¬¦å·è¡¨å¯ä»¥è®©æˆ‘ä»¬äº†è§£å„ä¸ªæ®µæ˜¯å¦‚ä½•æ”¾ç½®åœ¨å†…å­˜ä¸­çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm -n sum-data.elf</span><br><span class="line">00000000 t start</span><br><span class="line">0000000c t loop</span><br><span class="line">0000001c t stop</span><br><span class="line">00000400 d arr</span><br><span class="line">00000403 d eoa</span><br></pre></td></tr></table></figure><p>From the symbol table it is obvious that the <code>.text</code> is placed starting from address <code>0x0</code> and <code>.data</code> section is placed starting from address <code>0x400</code>.</p><p>ä»ç¬¦å·è¡¨ä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡º<code>.text</code>æ˜¯ä»åœ°å€<code>0x0</code>å’Œ<code>.data</code>éƒ¨åˆ†å¼€å§‹æ”¾ç½®çš„ ä»åœ°å€<code>0x400</code>å¼€å§‹æ”¾ç½®ã€‚</p><h2 id="8-Data-in-RAM-Example"><a href="#8-Data-in-RAM-Example" class="headerlink" title="8. Data in RAM, Example"></a>8. Data in RAM, Example</h2><p>Now that we know, how to write linker scripts, we will attempt to write a program, and place the <code>.data</code> section in RAM.</p><p>The add program is modified to load two values from RAM, add them and store the result back to RAM. The two values and the space for result is placed in the <code>.data</code> section.</p><p><strong>Listing 9. Add Data in RAM</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">        .data</span><br><span class="line">val1:   .4byte 10               @ First number</span><br><span class="line">val2:   .4byte 30               @ Second number</span><br><span class="line">result: .4byte 0                @ 4 byte space for result</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">        .align</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =val1         @ r0 = &amp;val1</span><br><span class="line">        ldr   r1, =val2         @ r1 = &amp;val2</span><br><span class="line"></span><br><span class="line">        ldr   r2, [r0]          @ r2 = *r0</span><br><span class="line">        ldr   r3, [r1]          @ r3 = *r1</span><br><span class="line"></span><br><span class="line">        add   r4, r2, r3        @ r4 = r2 + r3</span><br><span class="line"></span><br><span class="line">        ldr   r0, =result       @ r0 = &amp;result</span><br><span class="line">        str   r4, [r0]          @ *r0 = r4</span><br><span class="line"></span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure><p>When the program is linked, the linker script shown below is used.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123; * (.text); &#125;</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        .data : &#123; * (.data); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The dump of the symbol table of <code>.elf</code> is shown below.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm -n add-mem.elf</span><br><span class="line">00000000 t start</span><br><span class="line">0000001c t stop</span><br><span class="line">a0000000 d val1</span><br><span class="line">a0000001 d val2</span><br><span class="line">a0000002 d result</span><br></pre></td></tr></table></figure><p>The linker script seems to have solved the problem of placing the <code>.data</code> section in RAM. But wait, the solution is not complete yet!</p><h3 id="8-1-RAM-is-Volatile"><a href="#8-1-RAM-is-Volatile" class="headerlink" title="8.1. RAM is Volatile!"></a>8.1. RAM is Volatile!</h3><p>RAM is volatile memory, and hence it is not possible to directly make the data available in RAM, on power up.</p><p>All code and data <strong>should</strong> be stored in Flash before power-up. On power-up, a startup code is supposed to copy the data from Flash to RAM, and then proceed with the execution of the program. So the programâ€™s <code>.data</code> section has two addresses, a <strong>load address</strong> in Flash and a <strong>run-time address</strong> in RAM.</p><blockquote><p>ğŸ’¡TIP</p><p>In <code>ld</code> parlance, the load address is called LMA (Load Memory Address), and the run-time address is called VMA (Virtual Memory Address.).</p></blockquote><p>The following two modifications have to be done, to make the program work correctly.</p><ol><li>The linker script has to be modified to specify both the load address and the run-time address, for the <code>.data</code> section.</li><li>A small piece of code should copy the <code>.data</code> section from Flash (load address) to RAM (run-time address).</li></ol><h3 id="8-2-Specifying-Load-Address"><a href="#8-2-Specifying-Load-Address" class="headerlink" title="8.2. Specifying Load Address"></a>8.2. Specifying Load Address</h3><p>The run-time address is what that should be used for determining the address of labels. In the previous linker script, we have specified the run-time address for the <code>.data</code> section. The load address is not explicitly specified, and defaults to the run-time address. This is OK, with the previous examples, since the programs were executed directly from Flash. But, if data is to be placed in RAM during execution, the load address should correspond to Flash and the run-time address should correspond to RAM.</p><p>A load address different from the run-time address can be specified using the <code>AT</code> keyword. The modified linker script is shown below.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123; * (.text); &#125;</span><br><span class="line">        etext = .; â¶</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        .data : AT (etext) &#123; * (.data); &#125; â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th><a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#CO4-1">â¶</a></th><th>Symbols can be created on the fly within the <code>SECTIONS</code> command by assigning values to them. Here <code>etext</code> is assigned the value of the location counter at that position. <code>etext</code> contains the address of the next free location in Flash right after all the code. This will be used later on to specify where the <code>.data</code> section is to be placed in Flash. Note that <code>etext</code> itself will not be allocated any memory, it is just an entry in the symbol table.</th></tr></thead><tbody><tr><td><a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#CO4-2">â·</a></td><td>The <code>AT</code> keyword specifies the load address of the <code>.data</code> section. An address or symbol (whose value is a valid address) could be passed as argument to <code>AT</code>. Here the load address of <code>.data</code> is specified as the location right after all the code in Flash.</td></tr></tbody></table><h3 id="8-3-Copying-data-to-RAM"><a href="#8-3-Copying-data-to-RAM" class="headerlink" title="8.3. Copying .data to RAM"></a>8.3. Copying <code>.data</code> to RAM</h3><p>To copy the data from Flash to RAM, the following information is required.</p><ol><li>Address of data in Flash (<code>flash_sdata</code>)</li><li>Address of data in RAM (<code>ram_sdata</code>)</li><li>Size of the <code>.data</code> section. (<code>data_size</code>)</li></ol><p>With this information the data can be copied from Flash to RAM using the following code snippet.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        ldr   r0, =flash_sdata</span><br><span class="line">        ldr   r1, =ram_sdata</span><br><span class="line">        ldr   r2, =data_size</span><br><span class="line"></span><br><span class="line">copy:</span><br><span class="line">        ldrb  r4, [r0], #1</span><br><span class="line">        strb  r4, [r1], #1</span><br><span class="line">        subs  r2, r2, #1</span><br><span class="line">        bne   copy</span><br></pre></td></tr></table></figure><p>The linker script can be slightly modified to provide these information.</p><p><strong>Listing 10. Linker Script with Section Copy Symbols</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123;</span><br><span class="line">              * (.text);</span><br><span class="line">        &#125;</span><br><span class="line">        flash_sdata = .; â¶</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        ram_sdata = .; â·</span><br><span class="line">        .data : AT (flash_sdata) &#123;</span><br><span class="line">              * (.data);</span><br><span class="line">        &#125;;</span><br><span class="line">        ram_edata = .; â¸</span><br><span class="line">        data_size = ram_edata - ram_sdata; â¹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><thead><tr><th><a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#CO5-1">â¶</a></th><th>Start of data in Flash is right after all the code in Flash.</th></tr></thead><tbody><tr><td><a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#CO5-2">â·</a></td><td>Start of data in RAM is at the base address of RAM.</td></tr><tr><td><a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#CO5-3">â¸</a> <a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#CO5-4">â¹</a></td><td>Obtaining the size of data is not straight forward. The data size is calculated from the difference in the start of data in RAM and the end of data in RAM. Yes, simple expressions are allowed within the linker script.</td></tr></tbody></table><p>The add program with data copied to RAM from Flash is listed below.</p><p><strong>Listing 11. Add Data in RAM (with copy)</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">        .data</span><br><span class="line">val1:   .4byte 10               @ First number</span><br><span class="line">val2:   .4byte 30               @ Second number</span><br><span class="line">result: .space 4                @ 1 byte space for result</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line"></span><br><span class="line">        ;; Copy data to RAM.</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =flash_sdata</span><br><span class="line">        ldr   r1, =ram_sdata</span><br><span class="line">        ldr   r2, =data_size</span><br><span class="line"></span><br><span class="line">copy:</span><br><span class="line">        ldrb  r4, [r0], #1</span><br><span class="line">        strb  r4, [r1], #1</span><br><span class="line">        subs  r2, r2, #1</span><br><span class="line">        bne   copy</span><br><span class="line"></span><br><span class="line">        ;; Add and store result.</span><br><span class="line">        ldr   r0, =val1         @ r0 = &amp;val1</span><br><span class="line">        ldr   r1, =val2         @ r1 = &amp;val2</span><br><span class="line"></span><br><span class="line">        ldr   r2, [r0]          @ r2 = *r0</span><br><span class="line">        ldr   r3, [r1]          @ r3 = *r1</span><br><span class="line"></span><br><span class="line">        add   r4, r2, r3        @ r4 = r2 + r3</span><br><span class="line"></span><br><span class="line">        ldr   r0, =result       @ r0 = &amp;result</span><br><span class="line">        str   r4, [r0]          @ *r0 = r4</span><br><span class="line"></span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure><p>The program is assembled and linked using the linker script listed in <a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#linker2">Listing 10, â€œLinker Script with Section Copy Symbolsâ€</a>. The program is executed and tested within Qemu.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br><span class="line">(qemu) xp /4dw 0xA0000000</span><br><span class="line">a0000000:         10         30         40          0</span><br></pre></td></tr></table></figure><blockquote><p>Note:<br>In a real system with an SDRAM, the memory should not be accessed right-away. The memory controller will have to be initialised before performing a memory access. Our code works because the simulated memory does not require the memory controller to be initialised.</p></blockquote><h2 id="9-Exception-Handling"><a href="#9-Exception-Handling" class="headerlink" title="9. Exception Handling"></a>9. Exception Handling</h2><p>The examples given so far have a major bug. The first 8 words in the memory map are reserved for the exception vectors. When an exception occurs the control is transferred to one these 8 locations. The exceptions and their exception vector addresses are show in the following table.</p><p><strong>Table 1. Exception Vector Addresses</strong></p><table><thead><tr><th>Exception</th><th>Address</th></tr></thead><tbody><tr><td>Reset</td><td>0x00</td></tr><tr><td>Undefined Instruction</td><td>0x04</td></tr><tr><td>Software Interrupt (SWI)</td><td>0x08</td></tr><tr><td>Prefetch Abort</td><td>0x0C</td></tr><tr><td>Data Abort</td><td>0x10</td></tr><tr><td>Reserved, not used</td><td>0x14</td></tr><tr><td>IRQ</td><td>0x18</td></tr><tr><td>FIQ</td><td>0x1C</td></tr></tbody></table><p>These locations are supposed to contain a branch that will transfer control the appropriate exception handler. In the examples we have seen so far, we havenâ€™t inserted branch instructions at the exception vector addresses. We got away without issues since these exceptions did not occur. All the above programs can be fixed, by linking them with the following assembly code.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        .section &quot;vectors&quot;</span><br><span class="line">reset:  b     start</span><br><span class="line">undef:  b     undef</span><br><span class="line">swi:    b     swi</span><br><span class="line">pabt:   b     pabt</span><br><span class="line">dabt:   b     dabt</span><br><span class="line">        nop</span><br><span class="line">irq:    b     irq</span><br><span class="line">fiq:    b     fiq</span><br></pre></td></tr></table></figure><p>Only the reset exception is vectored to a different address <code>start</code>. All other exceptions are vectored to the same address. So if any exception other that reset occurs, the processor will be spinning in the same location. The exception can then be identified by looking at the value of <code>pc</code> through a debugger (the monitor interface in our case).</p><p>To ensure that these instruction are placed at the exception vector addresses, the linker script should look something like below.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123;</span><br><span class="line">                * (vectors);</span><br><span class="line">                * (.text);</span><br><span class="line">                ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Notice how the <code>vectors</code> section is placed before all other code, ensuring that the <code>vectors</code> is located at address starting from 0x0.</p><h2 id="10-C-Startup"><a href="#10-C-Startup" class="headerlink" title="10. C Startup"></a>10. C Startup</h2><p>It is not possible to directly execute C code, when the processor comes out of reset. Since, unlike assembly language, C programs need some basic pre-requisites to be satisfied. This section will describe the pre-requisites and how to meet the pre-requisites.</p><p>We will take the example of C program that calculates the sum of an array as an example. And by the end of this section, we will be able to perform the necessary setup, transfer control to the C code and execute it.</p><p><strong>Listing 12. Sum of Array in C</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static int arr[] = &#123; 1, 10, 4, 5, 6, 7 &#125;;</span><br><span class="line">static int sum;</span><br><span class="line">static const int n = sizeof(arr) / sizeof(arr[0]);</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">        int i;</span><br><span class="line"></span><br><span class="line">        for (i = 0; i &lt; n; i++)</span><br><span class="line">                sum += arr[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Before transferring control to C code, the following have to be setup correctly.</p><ol><li>Stack</li><li>Global variables<ol><li>Initialized</li><li>Uninitialized</li></ol></li><li>Read-only data</li></ol><h3 id="10-1-Stack"><a href="#10-1-Stack" class="headerlink" title="10.1. Stack"></a>10.1. Stack</h3><p>C uses the stack for storing local (auto) variables, passing function arguments, storing return address, etc. So it is essential that the stack be setup correctly, before transferring control to C code.</p><p>Stacks are highly flexible in the ARM architecture, since the implementation is completely left to the software. For people not familiar with the ARM architecture a overview is provided in <a href="https://www.bravegnu.org/gnu-eprog/arm-stacks.html">Appendix C, <em>ARM Stacks</em></a>.</p><p>To make sure that code generated by different compilers is interroperable, ARM has created the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042a/IHI0042A_aapcs.pdf">ARM Architecture Procedure Call Standard (AAPCS)</a>. The register to be used as the stack pointer and the direction in which the stack grows is all dictated by the AAPCS. According to the AAPCS, <strong>register <code>r13</code></strong> is to be used as the stack pointer. Also the stack should be <strong>full-descending</strong>.</p><p>One way of placing global variables and the stack is shown in the following diagram.</p><p><strong>Figure 5. Stack Placement</strong></p><p><img src="/../images/GNUToolchain/stack.png" alt="stack.png"></p><p>So all that has to be done in the startup code is to point <code>r13</code> at the highest RAM address, so that the stack can grow downwards (towards lower addresses). For the <code>connex</code> board this can be acheived using the following ARM instruction.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr sp, =0xA4000000</span><br></pre></td></tr></table></figure><p>Note that the the assembler provides an alias <code>sp</code> for the <code>r13</code> register.</p><table><thead><tr><th><img src="/../images/GNUToolchain/note.png" alt="[Note]"></th><th>Note</th></tr></thead><tbody><tr><td>The address <code>0xA4000000</code> itself does not correspond to RAM. The RAM ends at <code>0xA3FFFFFF</code>. But that is OK, since the stack is <strong>full</strong>-descending, during the first push the stack pointer will be decremented first and the value will be stored.</td><td></td></tr></tbody></table><h3 id="10-2-Global-Variables"><a href="#10-2-Global-Variables" class="headerlink" title="10.2. Global Variables"></a>10.2. Global Variables</h3><p>When C code is compiled, the compiler places initialized global variables in the <code>.data</code> section. So just as with the assembly, the <code>.data</code> has to be copied from Flash to RAM.</p><p>The C language guarantees that all uninitialized global variables will be initialized to zero. When C programs are compiled, a separate section called <code>.bss</code> is used for uninitialized variables. Since the value of these variables are all zeroes to start with, they do not have to be stored in Flash. Before transferring control to C code, the memory locations corresponding to these variables have to be initialized to zero.</p><h3 id="10-3-Read-only-Data"><a href="#10-3-Read-only-Data" class="headerlink" title="10.3. Read-only Data"></a>10.3. Read-only Data</h3><p>GCC places global variables marked as <code>const</code> in a separate section, called <code>.rodata</code>. The <code>.rodata</code> is also used for storing string constants.</p><p>Since contents of <code>.rodata</code> section will not be modified, they can be placed in Flash. The linker script has to modified to accomodate this.</p><h3 id="10-4-Startup-Code"><a href="#10-4-Startup-Code" class="headerlink" title="10.4. Startup Code"></a>10.4. Startup Code</h3><p>Now that we know the pre-requisites we can create the linker script and the startup code. The linker script <a href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#linker2">Listing 10, â€œLinker Script with Section Copy Symbolsâ€</a> is modified to accomodate the following.</p><ol><li><code>.bss</code> section placement</li><li><code>vectors</code> section placement</li><li><code>.rodata</code> section placement</li></ol><p>The <code>.bss</code> is placed right after <code>.data</code> section in RAM. Symbols to locate the start of <code>.bss</code> and end of <code>.bss</code> are also created in the linker script. The <code>.rodata</code> is placed right after <code>.text</code> section in Flash. The following diagram shows the placement of the various sections.</p><p><strong>Figure 6. Section Placement</strong></p><p><img src="/../images/GNUToolchain/csections.png" alt="csections.png"></p><p><strong>Listing 13. Linker Script for C code</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123;</span><br><span class="line">              * (vectors);</span><br><span class="line">              * (.text);</span><br><span class="line">        &#125;</span><br><span class="line">        .rodata : &#123;</span><br><span class="line">              * (.rodata);</span><br><span class="line">        &#125;</span><br><span class="line">        flash_sdata = .;</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        ram_sdata = .;</span><br><span class="line">        .data : AT (flash_sdata) &#123;</span><br><span class="line">              * (.data);</span><br><span class="line">        &#125;</span><br><span class="line">        ram_edata = .;</span><br><span class="line">        data_size = ram_edata - ram_sdata;</span><br><span class="line"></span><br><span class="line">        sbss = .;</span><br><span class="line">        .bss : &#123;</span><br><span class="line">             * (.bss);</span><br><span class="line">        &#125;</span><br><span class="line">        ebss = .;</span><br><span class="line">        bss_size = ebss - sbss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>The startup code has the following parts</p><ol><li>exception vectors</li><li>code to copy the <code>.data</code> from Flash to RAM</li><li>code to zero out the <code>.bss</code></li><li>code to setup the stack pointer</li><li>branch to main</li></ol><p><strong>Listing 14. C Startup Assembly</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">        .section &quot;vectors&quot;</span><br><span class="line">reset:  b     start</span><br><span class="line">undef:  b     undef</span><br><span class="line">swi:    b     swi</span><br><span class="line">pabt:   b     pabt</span><br><span class="line">dabt:   b     dabt</span><br><span class="line">        nop</span><br><span class="line">irq:    b     irq</span><br><span class="line">fiq:    b     fiq</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">start:</span><br><span class="line">        @@ Copy data to RAM.</span><br><span class="line">        ldr   r0, =flash_sdata</span><br><span class="line">        ldr   r1, =ram_sdata</span><br><span class="line">        ldr   r2, =data_size</span><br><span class="line"></span><br><span class="line">        @@ Handle data_size == 0</span><br><span class="line">        cmp   r2, #0</span><br><span class="line">        beq   init_bss</span><br><span class="line">copy:</span><br><span class="line">        ldrb   r4, [r0], #1</span><br><span class="line">        strb   r4, [r1], #1</span><br><span class="line">        subs   r2, r2, #1</span><br><span class="line">        bne    copy</span><br><span class="line"></span><br><span class="line">init_bss:</span><br><span class="line">        @@ Initialize .bss</span><br><span class="line">        ldr   r0, =sbss</span><br><span class="line">        ldr   r1, =ebss</span><br><span class="line">        ldr   r2, =bss_size</span><br><span class="line"></span><br><span class="line">        @@ Handle bss_size == 0</span><br><span class="line">        cmp   r2, #0</span><br><span class="line">        beq   init_stack</span><br><span class="line"></span><br><span class="line">        mov   r4, #0</span><br><span class="line">zero:</span><br><span class="line">        strb  r4, [r0], #1</span><br><span class="line">        subs  r2, r2, #1</span><br><span class="line">        bne   zero</span><br><span class="line"></span><br><span class="line">init_stack:</span><br><span class="line">        @@ Initialize the stack pointer</span><br><span class="line">        ldr   sp, =0xA4000000</span><br><span class="line"></span><br><span class="line">        bl    main</span><br><span class="line"></span><br><span class="line">stop:   b     stop</span><br></pre></td></tr></table></figure><p>To compile the code, it is not necessary to invoke the assembler, compiler and linker individually. <code>gcc</code> is intelligent enough to do that for us.</p><p>As promised before, we will compile and execute the C code shown in <a href="https://www.bravegnu.org/gnu-eprog/c-startup.html#csum">Listing 12, â€œSum of Array in Câ€</a>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-gcc -nostdlib -o csum.elf -T csum.lds csum.c startup.s</span><br></pre></td></tr></table></figure><p>The <code>-nostdlib</code> option is used to specify that the standard C library should not be linked in. A little extra care has to be taken when the C library is linked in. This is discussed in <a href="https://www.bravegnu.org/gnu-eprog/c-library.html">Section 11, â€œUsing the C Libraryâ€</a>.</p><p>A dump of the symbol table will give a better picture of how things have been placed in memory.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm -n csum.elf</span><br><span class="line">00000000 t reset        â¶</span><br><span class="line">00000004 A bss_size</span><br><span class="line">00000004 t undef</span><br><span class="line">00000008 t swi</span><br><span class="line">0000000c t pabt</span><br><span class="line">00000010 t dabt</span><br><span class="line">00000018 A data_size</span><br><span class="line">00000018 t irq</span><br><span class="line">0000001c t fiq</span><br><span class="line">00000020 T main</span><br><span class="line">00000090 t start        â·</span><br><span class="line">000000a0 t copy</span><br><span class="line">000000b0 t init_bss</span><br><span class="line">000000c4 t zero</span><br><span class="line">000000d0 t init_stack</span><br><span class="line">000000d8 t stop</span><br><span class="line">000000f4 r n            â¸</span><br><span class="line">000000f8 A flash_sdata</span><br><span class="line">a0000000 d arr          â¹</span><br><span class="line">a0000000 A ram_sdata</span><br><span class="line">a0000018 A ram_edata</span><br><span class="line">a0000018 A sbss</span><br><span class="line">a0000018 b sum          âº</span><br><span class="line">a000001c A ebss</span><br></pre></td></tr></table></figure><table><thead><tr><th><a href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-1">â¶</a></th><th><code>reset</code> and the rest of the exception vectors are placed starting from <code>0x0</code>.</th></tr></thead><tbody><tr><td><a href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-2">â·</a></td><td>The assembly code is placed right after the 8 exception vectors (<code>8 * 4 = 32 = 0x20</code>).</td></tr><tr><td><a href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-3">â¸</a></td><td>The read-only data <code>n</code>, is placed in Flash after the code.</td></tr><tr><td><a href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-4">â¹</a></td><td>The initialized data <code>arr</code>, an array of 6 integers, is placed at the start of RAM <code>0xA0000000</code>.</td></tr><tr><td><a href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-5">âº</a></td><td>The uninitialized data <code>sum</code> is placed after the array of 6 integers. (<code>6 * 4 = 24 = 0x18</code>)</td></tr></tbody></table><p>To execute the program, convert the program to <code>.bin</code> format, execute in Qemu, and dump the <code>sum</code> variable located at <code>0xA0000018</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-objcopy -O binary csum.elf csum.bin</span><br><span class="line">$ dd if=csum.bin of=flash.bin bs=4096 conv=notrunc</span><br><span class="line">$ qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br><span class="line">(qemu) xp /6dw 0xa0000000</span><br><span class="line">a0000000:          1         10          4          5</span><br><span class="line">a0000010:          6          7</span><br><span class="line">(qemu) xp /1dw 0xa0000018</span><br><span class="line">a0000018:         33</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Assembler </category>
          
      </categories>
      
      
        <tags>
            
            <tag> arm </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹</title>
      <link href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/"/>
      <url>/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="ç¼–è¯‘æµç¨‹è¯´æ˜"><a href="#ç¼–è¯‘æµç¨‹è¯´æ˜" class="headerlink" title="ç¼–è¯‘æµç¨‹è¯´æ˜"></a>ç¼–è¯‘æµç¨‹è¯´æ˜</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. source build/envsetup_soc.shï¼ˆè®¾ç½®ç¯å¢ƒå˜é‡ï¼‰</span></span><br><span class="line">yogurt@s:v4.2.x$ <span class="built_in">source</span> build/envsetup_soc.sh</span><br><span class="line">  -------------------------------------------------------------------------------------------------------</span><br><span class="line">    Usage:</span><br><span class="line">    (1) menuconfig - Use menu to configure your board.</span><br><span class="line">        ex: $ menuconfig</span><br><span class="line"></span><br><span class="line">    (2) defconfig <span class="variable">$CHIP_ARCH</span> - List EVB boards(<span class="variable">$BOARD</span>) by CHIP_ARCH.</span><br><span class="line">       ** cv181x ** -&gt; [<span class="string">&#x27;cv181x&#x27;</span>, <span class="string">&#x27;cv1823a&#x27;</span>, <span class="string">&#x27;cv1821a&#x27;</span>, <span class="string">&#x27;cv1820a&#x27;</span>, <span class="string">&#x27;cv1811h&#x27;</span>, <span class="string">&#x27;cv1811ha&#x27;</span>, <span class="string">&#x27;cv1812ha&#x27;</span>, <span class="string">&#x27;cv1811c&#x27;</span>, <span class="string">&#x27;cv1810c&#x27;</span>, <span class="string">&#x27;cv1810ca&#x27;</span>, <span class="string">&#x27;cv1812h&#x27;</span>, <span class="string">&#x27;cv1812cp&#x27;</span>, <span class="string">&#x27;cv1813h&#x27;</span>, <span class="string">&#x27;cv1813ha&#x27;</span>]</span><br><span class="line">       ** cv180x ** -&gt; [<span class="string">&#x27;cv180x&#x27;</span>, <span class="string">&#x27;cv1800b&#x27;</span>, <span class="string">&#x27;cv1800c&#x27;</span>, <span class="string">&#x27;cv1801b&#x27;</span>, <span class="string">&#x27;cv1801c&#x27;</span>, <span class="string">&#x27;cv180zb&#x27;</span>]</span><br><span class="line">        ex: $ defconfig cv183x</span><br><span class="line"></span><br><span class="line">    (3) defconfig <span class="variable">$BOARD</span> - Choose EVB board settings.</span><br><span class="line">        ex: $ defconfig cv1835_wevb_0002a</span><br><span class="line">        ex: $ defconfig cv1826_wevb_0005a_spinand</span><br><span class="line">        ex: $ defconfig cv181x_fpga_c906</span><br><span class="line">  -------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ä½¿ç”¨ defconfig é€‰å®šæ¿å¡é…ç½®</span></span><br><span class="line">yogurt@s:v4.2.x$ defconfig cv1811c_wevb_0006a_emmc</span><br><span class="line"> Run defconfig <span class="keyword">function</span></span><br><span class="line">Loaded configuration <span class="string">&#x27;/home/yogurt/Documents/sophgo/v4.2.x/build/boards/cv181x/cv1811c_wevb_0006a_emmc/cv1811c_wevb_0006a_emmc_defconfig&#x27;</span></span><br><span class="line">Configuration saved to <span class="string">&#x27;.config&#x27;</span></span><br><span class="line">Loaded configuration <span class="string">&#x27;.config&#x27;</span></span><br><span class="line">Minimal configuration saved to <span class="string">&#x27;/home/yogurt/Documents/sophgo/v4.2.x/build/.defconfig&#x27;</span></span><br><span class="line">~/Documents/sophgo/v4.2.x/build ~/Documents/sophgo/v4.2.x</span><br><span class="line">~/Documents/sophgo/v4.2.x</span><br><span class="line"></span><br><span class="line">====== Environment Variables =======</span><br><span class="line"></span><br><span class="line">  PROJECT: cv1811c_wevb_0006a_emmc, DDR_CFG=ddr3_1866_x16</span><br><span class="line">  CHIP_ARCH: CV181X, DEBUG=0</span><br><span class="line">  SDK VERSION: musl_riscv64, RPC=0</span><br><span class="line">  ATF options: ATF_KEY_SEL=default, BL32=1</span><br><span class="line">  Linux <span class="built_in">source</span> folder:linux_5.10, Uboot <span class="built_in">source</span> folder: u-boot-2021.10</span><br><span class="line">  CROSS_COMPILE_PREFIX: riscv64-unknown-linux-musl-</span><br><span class="line">  ENABLE_BOOTLOGO: 0</span><br><span class="line">  Flash layout xml: /home/yogurt/Documents/sophgo/v4.2.x/build/boards/cv181x/cv1811c_wevb_0006a_emmc/partition/partition_emmc.xml</span><br><span class="line">  Support EMMC large part size: n</span><br><span class="line">  Sensor tuning bin: gcore_gc4653</span><br><span class="line">  Output path: /home/yogurt/Documents/sophgo/v4.2.x/install/soc_cv1811c_wevb_0006a_emmc</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. è¿è¡Œ build_all å¼€å§‹ç¼–è¯‘</span></span><br><span class="line">yogurt@s:v4.2.x$ build_all</span><br></pre></td></tr></table></figure><ol><li>ğŸ¾è®¾ç½®ç¯å¢ƒå˜é‡ï¼šä¸»è¦æ˜¯æä¾›ç›¸å…³ <code>shell</code> å‡½æ•°ï¼Œæ¯”å¦‚ <code>defconfig</code>, <code>menuconfig</code>, <code>build_kernel</code>, <code>build_uboot</code>, <code>build_all</code> ç­‰ï¼Œç»™ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨ã€‚</li><li>ğŸ¾é€‰å®šæ¿å¡é…ç½®ï¼šä¸åŒæ¿å¡ä¼šæœ‰ä¸åŒçš„é…ç½®ï¼ŒåŒ…å«ï¼š<ol><li>ğŸŒ± è®¾å¤‡æ ‘</li><li>ğŸŒ± linux kernel é…ç½®</li><li>ğŸŒ± uboot é…ç½®</li><li>ğŸŒ± flash åˆ†åŒºè¡¨</li><li>ğŸŒ± å†…å­˜å¸ƒå±€</li><li>ğŸŒ± å…¶ä»–é…ç½®</li></ol></li><li>ğŸ¾å¼€å§‹ç¼–è¯‘ï¼šå¯ä»¥è¿è¡Œ <code>build_all</code> ç¼–è¯‘å®Œæ•´ SDKï¼Œä¹Ÿå¯ä»¥è¿è¡Œ <code>build_uboot</code>&#x2F;<code>build_kernel</code> ç­‰ç¼–è¯‘å•ä¸ªæ¨¡å—ã€‚</li></ol><p>ğŸ“Œ å¯¹æ­£å¸¸å¯åŠ¨ç³»ç»Ÿæ¥è¯´ï¼Œéœ€è¦ç¼–è¯‘å¾—åˆ°çš„æ–‡ä»¶æœ‰ï¼š</p><ul><li><code>fip.bin/fip_spl.bin</code>ï¼š<code>Bootloader</code>ï¼ŒåŒ…å« <code>fsbl</code>, <code>opensbi</code>(riscv only), <code>u-boot</code>ï¼›</li><li><code>boot.&#123;flash_type&#125;</code>ï¼š<code>Linux</code> å†…æ ¸ï¼›</li><li><code>rootfs.&#123;flash_type&#125;</code>ï¼šå¤§æ ¸ç”¨çš„æ–‡ä»¶ç³»ç»Ÿï¼›</li><li><code>yoc.bin</code>ï¼šå°æ ¸ Alios çš„å›ºä»¶ã€‚</li></ul><table><thead><tr><th>æ–‡ä»¶å¤¹</th><th>ç¼–è¯‘å‘½ä»¤</th><th>ç”Ÿæˆæ–‡ä»¶</th></tr></thead><tbody><tr><td><code>fsbl</code></td><td><code>build_uboot</code></td><td><code>bl2.bin</code> -&gt; <code>fip.bin</code></td></tr><tr><td><code>opensbi</code></td><td><code>build_uboot</code></td><td><code>fw_dynamic.bin</code>  + <code>ddr_param.bin</code> -&gt; <code>fip.bin</code></td></tr><tr><td><code>u-boot-2021.10</code></td><td><code>build_uboot</code></td><td><code>u-boot-raw_spl.bin</code> &#x2F; <code>u-boot-raw.bin</code> -&gt; <code>fip.bin</code></td></tr><tr><td><code>cvi_alios</code></td><td><code>build_uboot</code> æˆ– <code>build_alios</code> å•ç‹¬ç¼–è¯‘</td><td><code>yoc.bin</code>  -&gt; <code>fip.bin</code></td></tr><tr><td><code>linux_5.10</code></td><td><code>build_kernel(arm)</code>&#x2F;<code>build_opensbi_kernel(riscv)</code></td><td><code>boot.xxx</code> å†…æ ¸</td></tr><tr><td><code>ramdisk</code></td><td><code>pack_rootfs</code></td><td><code>rootfs.xxx</code> æ–‡ä»¶ç³»ç»Ÿ</td></tr><tr><td><code>ramdisk</code></td><td><code>build_ramboot</code></td><td><code>ramboot</code> ç”¨åš <code>recovery</code></td></tr></tbody></table><p>ä¸‹é¢ä»¥ <code>cv1811c_wevb_0006a_emmc</code> æ¿å¡ä¸ºä¾‹ï¼Œåˆ†æä¸Šè¯‰å„ä¸ªæ–‡ä»¶çš„ç¼–è¯‘æµç¨‹ã€‚</p><h2 id="v4-2-x-ç¼–è¯‘æµç¨‹"><a href="#v4-2-x-ç¼–è¯‘æµç¨‹" class="headerlink" title="v4.2.x ç¼–è¯‘æµç¨‹"></a>v4.2.x ç¼–è¯‘æµç¨‹</h2><p><img src="/./images/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/v4.2.x-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B.svg" alt="v4.2.x ç¼–è¯‘æµç¨‹"></p>]]></content>
      
      
      <categories>
          
          <category> Cvitek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> fsbl </tag>
            
            <tag> opensbi </tag>
            
            <tag> uboot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cvitek SDK ç¼–è¯‘ç¯å¢ƒ</title>
      <link href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/"/>
      <url>/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/</url>
      
        <content type="html"><![CDATA[<h2 id="SDK-ä¸‹è½½"><a href="#SDK-ä¸‹è½½" class="headerlink" title="SDK ä¸‹è½½"></a>SDK ä¸‹è½½</h2><p>åˆ©ç”¨ sophpi ä¸­çš„è„šæœ¬ä¸‹è½½ SDK åˆ°å½“å‰ç›®å½•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> -b sg200x-evb git@github.com:sophgo/sophpi.git</span><br></pre></td></tr></table></figure><p>sophpi ä¸­çš„è„šæœ¬æ˜¯å°†éœ€è¦çš„ä»“åº“æ‹‰å–åˆ°å½“å‰ç›®å½•ï¼Œä¸ºäº†åŒºåˆ†ï¼Œä¸“é—¨æ–°å»º v4.1.x ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> v4.1.x &amp;&amp; <span class="built_in">cd</span> v4.1.x</span><br><span class="line"></span><br><span class="line">../sophpi/scripts/repo_clone.sh --gitclone ../sophpi/scripts/subtree.xml</span><br></pre></td></tr></table></figure><p>å¦‚éœ€ä½¿ç”¨åŒç³»ç»Ÿå¿«å¯åˆ†æ”¯ï¼Œåˆ™ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> v4.2.x &amp;&amp; <span class="built_in">cd</span> v4.2.x</span><br><span class="line"></span><br><span class="line">../sophpi/scripts/repo_clone.sh --gitclone ../sophpi/scripts/subtree_cv18xx-v4.2.x.xml</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ™ƒå¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š</p><ol><li>æ²¡æœ‰æƒé™æ‹‰å–ä»“åº“ã€‚<br>sophpi çš„è„šæœ¬ä¸­æ˜¯ç”¨çš„ git clone ssh@xxx èµ°çš„ sshï¼Œéœ€è¦é…ç½®å¥½ ssh keyï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚<br>å¯ä»¥æ›¿æ¢ xml ä¸­çš„ <a href="mailto:&#x67;&#x69;&#x74;&#64;&#103;&#105;&#x74;&#104;&#117;&#98;&#46;&#99;&#x6f;&#x6d;">&#x67;&#x69;&#x74;&#64;&#103;&#105;&#x74;&#104;&#117;&#98;&#46;&#99;&#x6f;&#x6d;</a>:sophgo&#x2F; ä¸º <a href="https://github.com/sophgo/">https://github.com/sophgo/</a></li></ol></blockquote><h2 id="v4-1-x-ç¼–è¯‘ç¯å¢ƒé…ç½®"><a href="#v4-1-x-ç¼–è¯‘ç¯å¢ƒé…ç½®" class="headerlink" title="v4.1.x ç¼–è¯‘ç¯å¢ƒé…ç½®"></a>v4.1.x ç¼–è¯‘ç¯å¢ƒé…ç½®</h2><blockquote><p>ä¸‹é¢ä»¥ ubuntu 22.04 ä¸ºä¾‹ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y pkg-config build-essential ninja-build automake autoconf libtool wget curl git gcc libssl-dev bc slib squashfs-tools android-sdk-libsparse-utils android-sdk-ext4-utils jq cmake python3-distutils tclsh scons parallel ssh-client tree python3-dev python3-pip device-tree-compiler libssl-dev ssh cpio squashfs-tools fakeroot libncurses5 flex bison</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ™ƒå¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š</p><ol><li><p>æ‰¾ä¸åˆ°è½¯ä»¶åŒ… android-sdk-ext4-utils</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y android-sdk-ext4-utils</span><br></pre></td></tr></table></figure><p> ubuntu 20.04 å¯èƒ½æ‰¾ä¸åˆ°è¯¥è½¯ä»¶åŒ…</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â¯ sudo apt-get install -y android-sdk-ext4-utils</span><br><span class="line"></span><br><span class="line">æ­£åœ¨è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨... å®Œæˆ</span><br><span class="line">æ­£åœ¨åˆ†æè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»æ ‘... å®Œæˆ</span><br><span class="line">æ­£åœ¨è¯»å–çŠ¶æ€ä¿¡æ¯... å®Œæˆ</span><br><span class="line">E: æ— æ³•å®šä½è½¯ä»¶åŒ… android-sdk-ext4-utils</span><br></pre></td></tr></table></figure><p> è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š</p><p> wget <a href="http://mirrors.kernel.org/ubuntu/pool/universe/a/android-platform-system-extras/android-sdk-ext4-utils_8.1.0+r23-2_amd64.deb">http://mirrors.kernel.org/ubuntu/pool/universe/a/android-platform-system-extras/android-sdk-ext4-utils_8.1.0+r23-2_amd64.deb</a></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install android-libcutils android-libext4-utils android-libselinux android-libsepol</span><br><span class="line"></span><br><span class="line">sudo dpkg -i android-sdk-ext4-utils_8.1.0+r23-2_amd64.deb</span><br></pre></td></tr></table></figure></li><li><p>åœ¨æ‰§è¡Œ source build&#x2F;cvisetup.sh æ—¶å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/proc/self/fd/17:9: athena2_board_sel: assignment to invalid subscript range</span><br></pre></td></tr></table></figure><p> ï¼ˆå…¶ä¸­ 17:9 å¯èƒ½æ˜¯å…¶ä»–æ•°å­—ï¼‰</p><p> cvisetup.sh è„šæœ¬æœªæ‰§è¡ŒæˆåŠŸã€‚æ‰§è¡Œ defconfig cv1812h_wevb_0007a_emmc_huashan ç»“æœå¦‚ä¸‹ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â¯ defconfig cv1812h_wevb_0007a_emmc</span><br><span class="line"> Run  <span class="keyword">function</span></span><br><span class="line">_call_kconfig_script:11: no such file or directory: /mnt/e/wsl/v4.1.0.3/v4.1.0.3_source/build/scripts/.py</span><br></pre></td></tr></table></figure><p> åŸå› ï¼šä½¿ç”¨çš„ shell å¹¶é bashã€‚ä¸”å‡º invalid subcript rangeï¼ˆä¸‹æ ‡èŒƒå›´é—®é¢˜ï¼‰å¯èƒ½æ˜¯ä½¿ç”¨ zsh æ‰§è¡Œ shell è„šæœ¬å¯¼è‡´çš„ã€‚zsh æ•°ç»„çš„ä¸‹æ ‡ç´¢ä» 1 å¼€å§‹ï¼Œä¸ bash ä¸åŒï¼ˆbash ä» 0 å¼€å§‹ï¼‰ã€‚<br> æ›´å¤šè®¨è®ºè¯·å‚è€ƒï¼š<a href="https://unix.stackexchange.com/questions/562561/bash-script-throws-assignment-to-invalid-subscript-range-when-running-from-zsh">https://unix.stackexchange.com/questions/562561/bash-script-throws-assignment-to-invalid-subscript-range-when-running-from-zsh</a></p><p> è§£å†³æ–¹æ³•ï¼šç»ˆç«¯é”®å…¥ bashï¼Œåœ¨ bash ç¯å¢ƒä¸‹æ‰§è¡Œsource build&#x2F;cvisetup.sh</p></li><li><p>æ‰¾ä¸åˆ° pythonã€‚</p><p> &#x2F;bin&#x2F;sh: 1: python: not found</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">ln</span> -s /usr/bin/python3 /usr/bin/python</span><br></pre></td></tr></table></figure></li><li><p><strong>python åº“ç¼ºå°‘</strong></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">/home/yogurt/Documents/sophgo/v4.1.x/cvi_mpi/modules/isp/common/toolJsonGenerator</span><br><span class="line">Updated 0 paths from the index</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/home/yogurt/Documents/sophgo/v4.1.x/cvi_mpi/modules/isp/common/toolJsonGenerator/hFile2json.py&quot;</span>, line 5, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from jinja2 import Template</span><br><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;jinja2&#x27;</span></span><br><span class="line">Updated 1 path from the index</span><br><span class="line"><span class="built_in">cat</span>: pqtool_definition.json: No such file or directory</span><br><span class="line">the json file is a invalid, error is : Expecting value: line 1 column 1 (char 0)!!!</span><br><span class="line">make[3]: *** [Makefile:11: all] Error 255</span><br><span class="line">make[3]: Leaving directory <span class="string">&#x27;/home/yogurt/Documents/sophgo/v4.1.x/cvi_mpi/modules/isp/cv181x&#x27;</span></span><br><span class="line">make[2]: *** [Makefile:8: all] Error 1</span><br><span class="line">make[2]: Leaving directory <span class="string">&#x27;/home/yogurt/Documents/sophgo/v4.1.x/cvi_mpi/modules/isp&#x27;</span></span><br><span class="line">make[1]: *** [Makefile:18: all] Error 1</span><br><span class="line">make[1]: Leaving directory <span class="string">&#x27;/home/yogurt/Documents/sophgo/v4.1.x/cvi_mpi/modules&#x27;</span></span><br><span class="line">make: *** [Makefile:35: module] Error 2</span><br><span class="line"> build middleware failed !!</span><br></pre></td></tr></table></figure><p> è§£å†³æ–¹æ³•ï¼šæ‰§è¡Œ <code>pip install jinja2</code></p></li></ol></blockquote><h2 id="v4-2-x-x2F-Alios-ç¼–è¯‘"><a href="#v4-2-x-x2F-Alios-ç¼–è¯‘" class="headerlink" title="v4.2.x&#x2F;Alios ç¼–è¯‘"></a>v4.2.x&#x2F;Alios ç¼–è¯‘</h2><blockquote><p>ä¸‹é¢ä»¥ ubuntu 22.04 ä¸ºä¾‹ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¼šæœ‰å·®å¼‚ã€‚</p><p>v4.2.x åœ¨ v4.1.x çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å°æ ¸ alios çš„ç¼–è¯‘ç¯å¢ƒé…ç½®ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install yoctools -i https://pypi.tuna.tsinghua.edu.cn/simple/</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Cvitek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Cvitek </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux sysfs</title>
      <link href="/2024/09/24/Linux-sysfs/"/>
      <url>/2024/09/24/Linux-sysfs/</url>
      
        <content type="html"><![CDATA[<blockquote><p>chatgpt translate from <a href="https://www.kernel.org/doc/Documentation/filesystems/sysfs.txt">https://www.kernel.org/doc/Documentation/filesystems/sysfs.txt</a></p></blockquote><h3 id="sysfs-å†…æ ¸å¯¹è±¡å¯¼å‡ºçš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#sysfs-å†…æ ¸å¯¹è±¡å¯¼å‡ºçš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="sysfs - å†…æ ¸å¯¹è±¡å¯¼å‡ºçš„æ–‡ä»¶ç³»ç»Ÿ"></a>sysfs - å†…æ ¸å¯¹è±¡å¯¼å‡ºçš„æ–‡ä»¶ç³»ç»Ÿ</h3><p>Patrick Mochel <a href="mailto:&#109;&#111;&#x63;&#x68;&#101;&#108;&#64;&#x6f;&#115;&#x64;&#108;&#46;&#x6f;&#114;&#x67;">&#109;&#111;&#x63;&#x68;&#101;&#108;&#64;&#x6f;&#115;&#x64;&#108;&#46;&#x6f;&#114;&#x67;</a></p><p>Mike Murphy <a href="mailto:&#109;&#x61;&#x6d;&#x75;&#x72;&#112;&#104;&#64;&#99;&#115;&#46;&#x63;&#x6c;&#x65;&#109;&#115;&#x6f;&#x6e;&#x2e;&#x65;&#x64;&#x75;">&#109;&#x61;&#x6d;&#x75;&#x72;&#112;&#104;&#64;&#99;&#115;&#46;&#x63;&#x6c;&#x65;&#109;&#115;&#x6f;&#x6e;&#x2e;&#x65;&#x64;&#x75;</a></p><h3 id="ä»€ä¹ˆæ˜¯-sysfs"><a href="#ä»€ä¹ˆæ˜¯-sysfs" class="headerlink" title="ä»€ä¹ˆæ˜¯ sysfs:"></a>ä»€ä¹ˆæ˜¯ sysfs:</h3><p><strong>sysfs æ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæœ€åˆåŸºäº ramfsã€‚å®ƒæä¾›äº†ä¸€ç§å°†å†…æ ¸æ•°æ®ç»“æ„ã€å…¶å±æ€§åŠå…¶ä¹‹é—´çš„é“¾æ¥å¯¼å‡ºåˆ°ç”¨æˆ·ç©ºé—´çš„æ–¹æ³•</strong>ã€‚</p><p>sysfs æœ¬è´¨ä¸Šä¸ kobject åŸºç¡€ç»“æ„ç´§å¯†ç›¸å…³ã€‚è¯·é˜…è¯» <code>Documentation/core-api/kobject.rst</code> ä»¥è·å–æœ‰å…³ kobject æ¥å£çš„æ›´å¤šä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sysfs is a ram-based filesystem initially based on ramfs. It provides</span><br><span class="line">a means to export kernel data structures, their attributes, and the</span><br><span class="line">linkages between them to userspace.</span><br><span class="line"></span><br><span class="line">sysfs is tied inherently to the kobject infrastructure. Please read</span><br><span class="line">Documentation/core-api/kobject.rst for more information concerning the kobject</span><br><span class="line">interface.</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-sysfs"><a href="#ä½¿ç”¨-sysfs" class="headerlink" title="ä½¿ç”¨ sysfs"></a>ä½¿ç”¨ sysfs</h3><p>å¦‚æœå®šä¹‰äº† <code>CONFIG_SYSFS</code>ï¼Œsysfs æ€»æ˜¯è¢«ç¼–è¯‘è¿›å»ã€‚ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤è®¿é—®å®ƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysfs is always compiled in if CONFIG_SYSFS is defined. You can access</span><br><span class="line">it by doing::</span><br><span class="line"></span><br><span class="line">    mount -t sysfs sysfs /sys</span><br></pre></td></tr></table></figure><h3 id="ç›®å½•åˆ›å»º"><a href="#ç›®å½•åˆ›å»º" class="headerlink" title="ç›®å½•åˆ›å»º"></a>ç›®å½•åˆ›å»º</h3><p>æ¯å½“ä¸€ä¸ª kobject æ³¨å†Œåˆ°ç³»ç»Ÿä¸­æ—¶ï¼Œä¼šåœ¨ sysfs ä¸­ä¸ºå…¶åˆ›å»ºä¸€ä¸ªç›®å½•ã€‚è¯¥ç›®å½•æ˜¯åœ¨ kobject çš„çˆ¶å¯¹è±¡çš„å­ç›®å½•ä¸­åˆ›å»ºçš„ï¼Œè¿™å‘ç”¨æˆ·ç©ºé—´è¡¨è¾¾äº†å†…éƒ¨å¯¹è±¡çš„å±‚æ¬¡ç»“æ„ã€‚sysfs ä¸­çš„é¡¶çº§ç›®å½•ä»£è¡¨å¯¹è±¡å±‚æ¬¡ç»“æ„çš„å…±åŒç¥–å…ˆï¼›å³å¯¹è±¡æ‰€å±çš„å­ç³»ç»Ÿã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">For every kobject that is registered with the system, a directory is</span><br><span class="line">created for it in sysfs. That directory is created as a subdirectory</span><br><span class="line">of the kobject&#x27;s parent, expressing internal object hierarchies to</span><br><span class="line">userspace. Top-level directories in sysfs represent the common</span><br><span class="line">ancestors of object hierarchies; i.e. the subsystems the objects</span><br><span class="line">belong to.</span><br></pre></td></tr></table></figure><h3 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h3><p>å±æ€§å¯ä»¥ä»¥æ–‡ä»¶ç³»ç»Ÿä¸­çš„å¸¸è§„æ–‡ä»¶å½¢å¼å¯¼å‡ºç»™ kobjectã€‚sysfs å°†æ–‡ä»¶ I&#x2F;O æ“ä½œè½¬å‘ç»™ä¸ºè¿™äº›å±æ€§å®šä¹‰çš„æ–¹æ³•ï¼Œä»è€Œæä¾›è¯»å†™å†…æ ¸å±æ€§çš„æ–¹æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Attributes can be exported for kobjects in the form of regular files in</span><br><span class="line">the filesystem. Sysfs forwards file I/O operations to methods defined</span><br><span class="line">for the attributes, providing a means to read and write kernel</span><br><span class="line">attributes.</span><br></pre></td></tr></table></figure><p>å±æ€§åº”è¯¥æ˜¯ ASCII æ–‡æœ¬æ–‡ä»¶ï¼Œæœ€å¥½æ¯ä¸ªæ–‡ä»¶åªåŒ…å«ä¸€ä¸ªå€¼ã€‚å°½ç®¡å¦‚æ­¤ï¼ŒåŒ…å«å¤šä¸ªåŒç±»å‹å€¼çš„æ•°ç»„ä¹Ÿæ˜¯å¯ä»¥æ¥å—çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Attributes should be ASCII text files, preferably with only one value</span><br><span class="line">per file. It is noted that it may not be efficient to contain only one</span><br><span class="line">value per file, so it is socially acceptable to express an array of</span><br><span class="line">values of the same type.</span><br></pre></td></tr></table></figure><p>æ··åˆç±»å‹ã€è¡¨è¾¾å¤šè¡Œæ•°æ®ä»¥åŠè¿›è¡ŒèŠ±å“¨çš„æ•°æ®æ ¼å¼åŒ–æ˜¯è¢«å¼ºçƒˆåå¯¹çš„ã€‚è¿™äº›åšæ³•å¯èƒ½ä¼šè®©ä½ åœ¨å…¬å¼€åœºåˆå—åˆ°ç¾è¾±ï¼Œå¹¶ä¸”ä½ çš„ä»£ç å¯èƒ½ä¼šåœ¨æ²¡æœ‰é€šçŸ¥çš„æƒ…å†µä¸‹è¢«é‡å†™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Mixing types, expressing multiple lines of data, and doing fancy</span><br><span class="line">formatting of data is heavily frowned upon. Doing these things may get</span><br><span class="line">you publicly humiliated and your code rewritten without notice.</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå±æ€§å®šä¹‰éå¸¸ç®€å•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">An attribute definition is simply::</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>                    * name;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span>*<span class="title">owner</span>;</span></span><br><span class="line">    <span class="type">umode_t</span>                 mode;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">sysfs_create_file</span><span class="params">(<span class="keyword">struct</span> kobject * kobj, <span class="type">const</span> <span class="keyword">struct</span> attribute * attr)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">sysfs_remove_file</span><span class="params">(<span class="keyword">struct</span> kobject * kobj, <span class="type">const</span> <span class="keyword">struct</span> attribute * attr)</span>;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªè£¸å±æ€§ä¸åŒ…å«è¯»å–æˆ–å†™å…¥å±æ€§å€¼çš„æ–¹æ³•ã€‚å­ç³»ç»Ÿè¢«é¼“åŠ±ä¸ºç‰¹å®šå¯¹è±¡ç±»å‹å®šä¹‰è‡ªå·±çš„å±æ€§ç»“æ„å’ŒåŒ…è£…å‡½æ•°ï¼Œä»¥æ·»åŠ å’Œåˆ é™¤å±æ€§ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A bare attribute contains no means to read or write the value of the</span><br><span class="line">attribute. Subsystems are encouraged to define their own attribute</span><br><span class="line">structure and wrapper functions for adding and removing attributes for</span><br><span class="line">a specific object type.</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œé©±åŠ¨æ¨¡å‹å®šä¹‰äº† <code>struct device_attribute</code> å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">For example, the driver model defines <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> <span class="title">like</span>:</span>:</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span><span class="title">attr</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">    <span class="type">char</span> *buf);</span><br><span class="line">    <span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">device_create_file</span><span class="params">(<span class="keyword">struct</span> device *, <span class="type">const</span> <span class="keyword">struct</span> device_attribute *)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">device_remove_file</span><span class="params">(<span class="keyword">struct</span> device *, <span class="type">const</span> <span class="keyword">struct</span> device_attribute *)</span>;</span><br></pre></td></tr></table></figure><p>å®ƒè¿˜å®šä¹‰äº†ç”¨äºå®šä¹‰è®¾å¤‡å±æ€§çš„è¾…åŠ©å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">It also defines this helper <span class="keyword">for</span> defining device attributes::</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> DEVICE_ATTR(_name, _mode, _show, _store) \</span></span><br><span class="line"><span class="meta">    struct device_attribute dev_attr_##_name = __ATTR(_name, _mode, _show, _store)</span></span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼Œå£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">For example, declaring::</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="title function_">DEVICE_ATTR</span><span class="params">(foo, S_IWUSR | S_IRUGO, show_foo, store_foo)</span>;</span><br></pre></td></tr></table></figure><p>ç­‰åŒäºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">is equivalent to doing::</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> <span class="title">dev_attr_foo</span> =</span> &#123;</span><br><span class="line">    .attr = &#123;</span><br><span class="line">    .name = <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    .mode = S_IWUSR | S_IRUGO,</span><br><span class="line">    &#125;,</span><br><span class="line">    .show = show_foo,</span><br><span class="line">    .store = store_foo,</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>include/linux/kernel.h</code> ä¸­æåˆ°â€œOTHER_WRITABLE? é€šå¸¸è¢«è®¤ä¸ºæ˜¯ä¸€ä¸ªåä¸»æ„ã€‚â€æ‰€ä»¥å°è¯•ä¸ºæ‰€æœ‰äººè®¾ç½®ä¸€ä¸ªå¯å†™çš„ sysfs æ–‡ä»¶å°†å¤±è´¥ï¼Œå¹¶ä¼šæ¢å¤ä¸ºåªè¯»æ¨¡å¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Note as stated in include/linux/kernel.h <span class="string">&quot;OTHER_WRITABLE?  Generally</span></span><br><span class="line"><span class="string">considered a bad idea.&quot;</span> so trying to <span class="built_in">set</span> a sysfs file writable <span class="keyword">for</span></span><br><span class="line">everyone will fail reverting to RO mode <span class="keyword">for</span> <span class="string">&quot;Others&quot;</span>.</span><br></pre></td></tr></table></figure><p>å¯¹äºå¸¸è§æƒ…å†µï¼Œ<code>sysfs.h</code> æä¾›äº†ä¾¿æ·çš„å®æ¥ç®€åŒ–å±æ€§å®šä¹‰ï¼Œä½¿ä»£ç æ›´ç®€æ´å’Œæ˜“è¯»ã€‚ä¸Šè¿°æƒ…å†µå¯ä»¥ç®€åŒ–ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">For the common cases sysfs.h provides convenience macros to make</span><br><span class="line">defining attributes easier as well as making code more concise and</span><br><span class="line">readable. The above <span class="keyword">case</span> could be shortened to:</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> <span class="title">dev_attr_foo</span> =</span> __ATTR_RW(foo);</span><br></pre></td></tr></table></figure><p>å¯ç”¨æ¥å®šä¹‰åŒ…è£…å‡½æ•°çš„è¾…åŠ©å‡½æ•°åˆ—è¡¨å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">the list of helpers available to define your wrapper function is:</span><br><span class="line"></span><br><span class="line">__ATTR_RO(name):</span><br><span class="line"> assumes default name_show and mode 0444</span><br><span class="line">__ATTR_WO(name):</span><br><span class="line"> assumes a name_store only and is restricted to mode</span><br><span class="line">                 0200 that is root write access only.</span><br><span class="line">__ATTR_RO_MODE(name, mode):</span><br><span class="line">         fore more restrictive RO access currently</span><br><span class="line">                 only use case is the EFI System Resource Table</span><br><span class="line">                 (see drivers/firmware/efi/esrt.c)</span><br><span class="line">__ATTR_RW(name):</span><br><span class="line">         assumes default name_show, name_store and setting</span><br><span class="line">                 mode to 0644.</span><br><span class="line">__ATTR_NULL:</span><br><span class="line">         which sets the name to NULL and is used as end of list</span><br><span class="line">                 indicator (see: kernel/workqueue.c)</span><br></pre></td></tr></table></figure><h3 id="å­ç³»ç»Ÿç‰¹å®šçš„å›è°ƒ"><a href="#å­ç³»ç»Ÿç‰¹å®šçš„å›è°ƒ" class="headerlink" title="å­ç³»ç»Ÿç‰¹å®šçš„å›è°ƒ"></a>å­ç³»ç»Ÿç‰¹å®šçš„å›è°ƒ</h3><p>å½“å­ç³»ç»Ÿå®šä¹‰ä¸€ä¸ªæ–°çš„å±æ€§ç±»å‹æ—¶ï¼Œå®ƒå¿…é¡»å®ç°ä¸€ç»„ sysfs æ“ä½œï¼Œç”¨äºå°†è¯»å†™è°ƒç”¨è½¬å‘ç»™å±æ€§æ‰€æœ‰è€…çš„ <code>show</code> å’Œ <code>store</code> æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Subsystem-Specific Callbacks</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">When a subsystem defines a new attribute type, it must implement a</span><br><span class="line"><span class="built_in">set</span> of sysfs operations <span class="keyword">for</span> forwarding read and write calls to the</span><br><span class="line">show and store methods of the attribute owners::</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> sysfs_ops &#123;</span><br><span class="line">    <span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> kobject *, <span class="keyword">struct</span> attribute *, <span class="type">char</span> *);</span><br><span class="line">    <span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> kobject *, <span class="keyword">struct</span> attribute *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>[å­ç³»ç»Ÿåº”è¯¥å·²ç»å®šä¹‰äº†ä¸€ä¸ª <code>struct kobj_type</code> ä½œä¸ºæ­¤ç±»å‹çš„æè¿°ç¬¦ï¼Œ<code>sysfs_ops</code> æŒ‡é’ˆå­˜å‚¨åœ¨å…¶ä¸­ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… kobject æ–‡æ¡£ã€‚]</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[ Subsystems should have already defined a struct kobj_type as a</span><br><span class="line">descriptor for this type, which is where the sysfs_ops pointer is</span><br><span class="line">stored. See the kobject documentation for more information. ]</span><br></pre></td></tr></table></figure><p>å½“æ–‡ä»¶è¢«è¯»å–æˆ–å†™å…¥æ—¶ï¼Œsysfs è°ƒç”¨é€‚å½“çš„æ–¹æ³•ã€‚è¯¥æ–¹æ³•ç„¶åå°†é€šç”¨çš„ <code>struct kobject</code> å’Œ <code>struct attribute</code> æŒ‡é’ˆè½¬æ¢ä¸ºé€‚å½“çš„æŒ‡é’ˆç±»å‹ï¼Œå¹¶è°ƒç”¨ç›¸å…³çš„æ–¹æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">When a file is read or written, sysfs calls the appropriate method</span><br><span class="line">for the type. The method then translates the generic struct kobject</span><br><span class="line">and struct attribute pointers to the appropriate pointer types, and</span><br><span class="line">calls the associated methods.</span><br></pre></td></tr></table></figure><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">To illustrate::</span><br><span class="line"></span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> to_dev_attr(_attr) container_of(_attr, struct device_attribute, attr)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">dev_attr_show</span><span class="params">(<span class="keyword">struct</span> kobject *kobj, <span class="keyword">struct</span> attribute *attr,</span></span><br><span class="line"><span class="params"><span class="type">char</span> *buf)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> *<span class="title">dev_attr</span> =</span> to_dev_attr(attr);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> =</span> kobj_to_dev(kobj);</span><br><span class="line">    <span class="type">ssize_t</span> ret = -EIO;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dev_attr-&gt;show)</span><br><span class="line">    ret = dev_attr-&gt;show(dev, dev_attr, buf);</span><br><span class="line">    <span class="keyword">if</span> (ret &gt;= (<span class="type">ssize_t</span>)PAGE_SIZE) &#123;</span><br><span class="line">    printk(<span class="string">&quot;dev_attr_show: %pS returned bad count\n&quot;</span>,</span><br><span class="line">    dev_attr-&gt;show);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><h3 id="è¯»å–-x2F-å†™å…¥å±æ€§æ•°æ®"><a href="#è¯»å–-x2F-å†™å…¥å±æ€§æ•°æ®" class="headerlink" title="è¯»å–&#x2F;å†™å…¥å±æ€§æ•°æ®"></a>è¯»å–&#x2F;å†™å…¥å±æ€§æ•°æ®</h3><p>è¦è¯»å–æˆ–å†™å…¥å±æ€§ï¼Œå¿…é¡»åœ¨å£°æ˜å±æ€§æ—¶æŒ‡å®š <code>show()</code> æˆ– <code>store()</code> æ–¹æ³•ã€‚æ–¹æ³•ç±»å‹åº”è¯¥åƒä¸ºè®¾å¤‡å±æ€§å®šä¹‰çš„é‚£æ ·ç®€å•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Reading/Writing Attribute Data</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">To read or write attributes, show() or <span class="title function_">store</span><span class="params">()</span> methods must be</span><br><span class="line">specified when declaring the attribute. The method types should be as</span><br><span class="line">simple as those defined <span class="keyword">for</span> device attributes::</span><br><span class="line"></span><br><span class="line">    <span class="title function_">ssize_t</span> <span class="params">(*show)</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr, <span class="type">char</span> *buf)</span>;</span><br><span class="line">    <span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count);</span><br></pre></td></tr></table></figure><p>æ¢å¥è¯è¯´ï¼Œå®ƒä»¬åº”è¯¥åªæ¥æ”¶ä¸€ä¸ªå¯¹è±¡ã€ä¸€ä¸ªå±æ€§å’Œä¸€ä¸ªç¼“å†²åŒºä½œä¸ºå‚æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IOW, they should take only an object, an attribute, and a buffer as parameters.</span><br></pre></td></tr></table></figure><p>sysfs åˆ†é…ä¸€ä¸ªå¤§å°ä¸º <code>PAGE_SIZE</code> çš„ç¼“å†²åŒºå¹¶å°†å…¶ä¼ é€’ç»™è¯¥æ–¹æ³•ã€‚sysfs å°†å¯¹æ¯æ¬¡è¯»å–æˆ–å†™å…¥è°ƒç”¨è¯¥æ–¹æ³•ä¸€æ¬¡ã€‚è¿™è¿«ä½¿æ–¹æ³•å®ç°éµå¾ªä»¥ä¸‹è¡Œä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sysfs allocates a buffer of size (PAGE_SIZE) and passes it to the</span><br><span class="line">method. Sysfs will call the method exactly once for each read or</span><br><span class="line">write. This forces the following behavior on the method</span><br><span class="line">implementations:</span><br></pre></td></tr></table></figure><ul><li>åœ¨ <code>read(2)</code> è°ƒç”¨æ—¶ï¼Œ<code>show()</code> æ–¹æ³•åº”è¯¥å¡«æ»¡æ•´ä¸ªç¼“å†²åŒºã€‚è¯·è®°ä½ï¼Œä¸€ä¸ªå±æ€§åº”è¯¥åªå¯¼å‡ºä¸€ä¸ªå€¼æˆ–ç±»ä¼¼å€¼çš„æ•°ç»„ï¼Œå› æ­¤è¿™ä¸åº”è¯¥å¤ªæ˜‚è´µã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- On read(2), the show() method should fill the entire buffer.</span><br><span class="line">  Recall that an attribute should only be exporting one value, or an</span><br><span class="line">  array of similar values, so this shouldn&#x27;t be that expensive.</span><br></pre></td></tr></table></figure><ul><li>è¿™å…è®¸ç”¨æˆ·ç©ºé—´ä»»æ„åœ°å¯¹æ•´ä¸ªæ–‡ä»¶è¿›è¡Œéƒ¨åˆ†è¯»å–å’Œå‰å‘æŸ¥æ‰¾ã€‚å¦‚æœç”¨æˆ·ç©ºé—´å›åˆ°é›¶ä½ç½®æˆ–ä½¿ç”¨åç§»é‡ä¸º <code>0</code> çš„ <code>pread(2)</code>ï¼Œ<code>show()</code> æ–¹æ³•å°†å†æ¬¡è¢«è°ƒç”¨ï¼Œé‡æ–°å¡«å……ç¼“å†²åŒºã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">This allows userspace to do partial reads and forward seeks</span><br><span class="line">arbitrarily over the entire file at will. If userspace seeks back to</span><br><span class="line">zero or does a pread(2) with an offset of &#x27;0&#x27; the show() method will</span><br><span class="line">be called again, rearmed, to fill the buffer.</span><br></pre></td></tr></table></figure><ul><li>åœ¨ <code>write(2)</code> è°ƒç”¨æ—¶ï¼Œsysfs æœŸæœ›åœ¨ç¬¬ä¸€æ¬¡å†™å…¥æ—¶ä¼ é€’æ•´ä¸ªç¼“å†²åŒºã€‚ç„¶å sysfs å°†æ•´ä¸ªç¼“å†²åŒºä¼ é€’ç»™ <code>store()</code> æ–¹æ³•ã€‚åœ¨å­˜å‚¨æ—¶ï¼Œæ•°æ®åä¼šæ·»åŠ ä¸€ä¸ªç»ˆæ­¢ç©ºå­—ç¬¦ã€‚è¿™ä½¿å¾—åƒ <code>sysfs_streq()</code> è¿™æ ·çš„å‡½æ•°å¯ä»¥å®‰å…¨ä½¿ç”¨ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- On write(2), sysfs expects the entire buffer to be passed during the</span><br><span class="line">  first write. Sysfs then passes the entire buffer to the store() method.</span><br><span class="line">  A terminating null is added after the data on stores. This makes</span><br><span class="line">  functions like sysfs_streq() safe to use.</span><br></pre></td></tr></table></figure><ul><li>åœ¨å†™å…¥ sysfs æ–‡ä»¶æ—¶ï¼Œç”¨æˆ·ç©ºé—´è¿›ç¨‹åº”è¯¥é¦–å…ˆè¯»å–æ•´ä¸ªæ–‡ä»¶ï¼Œä¿®æ”¹å®ƒå¸Œæœ›æ›´æ”¹çš„å€¼ï¼Œç„¶åå°†æ•´ä¸ªç¼“å†²åŒºå†™å›ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">When writing sysfs files, userspace processes should first read the</span><br><span class="line">entire file, modify the values it wishes to change, then write the</span><br><span class="line">entire buffer back.</span><br></pre></td></tr></table></figure><ul><li>å±æ€§æ–¹æ³•å®ç°åº”è¯¥åœ¨è¯»å–å’Œå†™å…¥å€¼æ—¶æ“ä½œç›¸åŒçš„ç¼“å†²åŒºã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Attribute method implementations should operate on an identical</span><br><span class="line">buffer when reading and writing values.</span><br></pre></td></tr></table></figure><p>å…¶ä»–æ³¨æ„äº‹é¡¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Other notes:</span><br></pre></td></tr></table></figure><ul><li><strong>å†™å…¥ä¼šå¯¼è‡´ <code>show()</code> æ–¹æ³•é‡æ–°æ¿€æ´»ï¼Œæ— è®ºå½“å‰æ–‡ä»¶ä½ç½®å¦‚ä½•</strong>ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- Writing causes the show() method to be rearmed regardless of current</span><br><span class="line">  file position.</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨æ­£å¸¸è¿ç»­ <code>read</code> è¯»å–çš„æ—¶å€™ï¼Œ<code>show()</code> æ–¹æ³•çš„è°ƒç”¨è¡Œä¸ºå–å†³äºè¯»å–çš„æ–¹å¼å’Œæ–‡ä»¶ä½ç½®ã€‚</p><p>åœ¨ sysfs ä¸­ï¼Œæ¯æ¬¡ <code>read</code> æ“ä½œéƒ½ä¼šè°ƒç”¨ <code>show()</code> æ–¹æ³•æ¥å¡«å……ç¼“å†²åŒºã€‚å…·ä½“è¡Œä¸ºå¦‚ä¸‹ï¼š</p><ol><li><strong>é¦–æ¬¡è¯»å–</strong>ï¼šå½“ä½ ç¬¬ä¸€æ¬¡è¯»å– sysfs æ–‡ä»¶æ—¶ï¼Œ<code>show()</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œå¡«å……ç¼“å†²åŒºã€‚</li><li><strong>è¿ç»­è¯»å–</strong>ï¼šå¦‚æœè¯»å–æ“ä½œæ²¡æœ‰æ”¹å˜æ–‡ä»¶åç§»é‡ï¼ˆå³è¿ç»­è¯»å–ï¼‰ï¼Œé‚£ä¹ˆ <code>show()</code> æ–¹æ³•ä¸ä¼šè¢«å†æ¬¡è°ƒç”¨ã€‚ç¼“å†²åŒºä¸­çš„æ•°æ®ä¼šè¢«ç›´æ¥è¿”å›ï¼Œç›´åˆ°ç¼“å†²åŒºçš„æ•°æ®è¢«è¯»å–å®Œæ¯•ã€‚</li><li><strong>é‡æ–°è¯»å–</strong>ï¼šå¦‚æœæ–‡ä»¶åç§»é‡è¢«æ”¹å˜ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·ç©ºé—´ç¨‹åºé€šè¿‡ <code>lseek</code> è°ƒç”¨å°†æ–‡ä»¶æŒ‡é’ˆç§»åŠ¨åˆ°æ–‡ä»¶å¼€å¤´ï¼‰ï¼Œå†æ¬¡è¯»å–æ—¶ï¼Œ<code>show()</code> æ–¹æ³•ä¼šè¢«é‡æ–°è°ƒç”¨ï¼Œé‡æ–°å¡«å……ç¼“å†²åŒºã€‚</li></ol></blockquote><ul><li>ç¼“å†²åŒºçš„é•¿åº¦æ€»æ˜¯ <code>PAGE_SIZE</code> å­—èŠ‚ã€‚åœ¨ i386 ä¸Šï¼Œè¿™ä¸ªå€¼æ˜¯ 4096ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- The buffer will always be PAGE_SIZE bytes in length. On i386, this</span><br><span class="line">  is 4096.</span><br></pre></td></tr></table></figure><ul><li><code>show()</code> æ–¹æ³•åº”è¿”å›å¡«å……åˆ°ç¼“å†²åŒºä¸­çš„å­—èŠ‚æ•°ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- show() methods should return the number of bytes printed into the</span><br><span class="line">  buffer.</span><br></pre></td></tr></table></figure><ul><li><code>show()</code> æ–¹æ³•åœ¨æ ¼å¼åŒ–è¿”å›ç»™ç”¨æˆ·ç©ºé—´çš„å€¼æ—¶åº”ä»…ä½¿ç”¨ <code>sysfs_emit()</code> æˆ– <code>sysfs_emit_at()</code>ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- show() should only use sysfs_emit() or sysfs_emit_at() when formatting</span><br><span class="line">  the value to be returned to user space.</span><br></pre></td></tr></table></figure><ul><li><code>store()</code> æ–¹æ³•åº”è¿”å›ç¼“å†²åŒºä¸­ä½¿ç”¨çš„å­—èŠ‚æ•°ã€‚å¦‚æœæ•´ä¸ªç¼“å†²åŒºéƒ½å·²ä½¿ç”¨ï¼Œåªè¿”å› <code>count</code> å‚æ•°ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- store() should return the number of bytes used from the buffer. If the</span><br><span class="line">  entire buffer has been used, just return the count argument.</span><br></pre></td></tr></table></figure><ul><li><code>show()</code> æˆ– <code>store()</code> æ–¹æ³•æ€»æ˜¯å¯ä»¥è¿”å›é”™è¯¯ã€‚å¦‚æœæœ‰ä¸€ä¸ªé”™è¯¯å€¼ä¼ å…¥ï¼Œè¯·åŠ¡å¿…è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- show() or store() can always return errors. If a bad value comes</span><br><span class="line">  through, be sure to return an error.</span><br></pre></td></tr></table></figure><ul><li>ä¼ é€’ç»™æ–¹æ³•çš„å¯¹è±¡å°†é€šè¿‡ sysfs å¼•ç”¨è®¡æ•°å…¶åµŒå…¥å¯¹è±¡å›ºå®šåœ¨å†…å­˜ä¸­ã€‚ç„¶è€Œï¼Œè¯¥å¯¹è±¡ä»£è¡¨çš„ç‰©ç†å®ä½“ï¼ˆä¾‹å¦‚è®¾å¤‡ï¼‰å¯èƒ½ä¸å­˜åœ¨ã€‚å¦‚æœå¿…è¦ï¼Œè¯·ç¡®ä¿æœ‰ä¸€ç§æ–¹æ³•æ¥æ£€æŸ¥è¿™ä¸€ç‚¹ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- The object passed to the methods will be pinned in memory via sysfs</span><br><span class="line">  referencing counting its embedded object. However, the physical</span><br><span class="line">  entity (e.g. device) the object represents may not be present. Be</span><br><span class="line">  sure to have a way to check this, if necessary.</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªéå¸¸ç®€å•ï¼ˆä¸”å¤©çœŸçš„ï¼‰è®¾å¤‡å±æ€§å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">A very <span class="title function_">simple</span> <span class="params">(and naive)</span> implementation of a device attribute is::</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">show_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span></span><br><span class="line"><span class="params">    <span class="type">char</span> *buf)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">return</span> scnprintf(buf, PAGE_SIZE, <span class="string">&quot;%s\n&quot;</span>, dev-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">store_name</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count)</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="built_in">snprintf</span>(dev-&gt;name, <span class="keyword">sizeof</span>(dev-&gt;name), <span class="string">&quot;%.*s&quot;</span>,</span><br><span class="line">    (<span class="type">int</span>)min(count, <span class="keyword">sizeof</span>(dev-&gt;name) - <span class="number">1</span>), buf);</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="title function_">DEVICE_ATTR</span><span class="params">(name, S_IRUGO, show_name, store_name)</span>;</span><br></pre></td></tr></table></figure><p>ï¼ˆæ³¨æ„ï¼ŒçœŸå®å®ç°ä¸å…è®¸ç”¨æˆ·ç©ºé—´è®¾ç½®è®¾å¤‡çš„åç§°ã€‚ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(Note that the real implementation doesn&#x27;t allow userspace to set the</span><br><span class="line">name for a device.)</span><br></pre></td></tr></table></figure><h3 id="é¡¶çº§ç›®å½•å¸ƒå±€"><a href="#é¡¶çº§ç›®å½•å¸ƒå±€" class="headerlink" title="é¡¶çº§ç›®å½•å¸ƒå±€"></a>é¡¶çº§ç›®å½•å¸ƒå±€</h3><p>sysfs ç›®å½•ç»“æ„æš´éœ²äº†å†…æ ¸æ•°æ®ç»“æ„çš„å…³ç³»ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Top Level Directory Layout</span><br><span class="line">~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">The sysfs directory arrangement exposes the relationship of kernel</span><br><span class="line">data structures.</span><br></pre></td></tr></table></figure><p>é¡¶çº§ sysfs ç›®å½•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">The top level sysfs directory looks like::</span><br><span class="line"></span><br><span class="line">    block/</span><br><span class="line">    bus/</span><br><span class="line">    class/</span><br><span class="line">    dev/</span><br><span class="line">    devices/</span><br><span class="line">    firmware/</span><br><span class="line">    net/</span><br><span class="line">    fs/</span><br></pre></td></tr></table></figure><p><code>devices/</code> åŒ…å«è®¾å¤‡æ ‘çš„æ–‡ä»¶ç³»ç»Ÿè¡¨ç¤ºã€‚å®ƒç›´æ¥æ˜ å°„åˆ°å†…æ ¸è®¾å¤‡æ ‘ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>struct device</code> çš„å±‚æ¬¡ç»“æ„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">devices/ contains a filesystem representation of the device tree. It maps</span><br><span class="line">directly to the internal kernel device tree, which is a hierarchy of</span><br><span class="line">struct device.</span><br></pre></td></tr></table></figure><p><code>bus/</code> åŒ…å«å„ç§æ€»çº¿ç±»å‹çš„æ‰å¹³ç›®å½•å¸ƒå±€ã€‚æ¯ä¸ªæ€»çº¿çš„ç›®å½•åŒ…å«ä¸¤ä¸ªå­ç›®å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bus/ contains flat directory layout of the various bus types in the</span><br><span class="line">kernel. Each bus&#x27;s directory contains two subdirectories::</span><br><span class="line"></span><br><span class="line">devices/</span><br><span class="line">drivers/</span><br></pre></td></tr></table></figure><p><code>devices/</code> åŒ…å«ç³»ç»Ÿä¸­å‘ç°çš„æ¯ä¸ªè®¾å¤‡çš„ç¬¦å·é“¾æ¥ï¼ŒæŒ‡å‘è®¾å¤‡åœ¨æ ¹ç›®å½•ä¸‹çš„ç›®å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">devices/ contains symlinks for each device discovered in the system</span><br><span class="line">that point to the device&#x27;s directory under root/.</span><br></pre></td></tr></table></figure><p><code>drivers/</code> åŒ…å«æ¯ä¸ªè®¾å¤‡é©±åŠ¨ç¨‹åºçš„ç›®å½•ï¼Œè¿™äº›é©±åŠ¨ç¨‹åºæ˜¯ä¸ºè¯¥æ€»çº¿ä¸Šçš„è®¾å¤‡åŠ è½½çš„ï¼ˆè¿™å‡è®¾é©±åŠ¨ç¨‹åºä¸ä¼šè·¨å¤šä¸ªæ€»çº¿ç±»å‹ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">drivers/ contains a directory for each device driver that is loaded</span><br><span class="line">for devices on that particular bus (this assumes that drivers do not</span><br><span class="line">span multiple bus types).</span><br></pre></td></tr></table></figure><p><code>fs/</code> åŒ…å«ä¸€äº›æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ã€‚ç›®å‰ï¼Œæ¯ä¸ªå¸Œæœ›å¯¼å‡ºå±æ€§çš„æ–‡ä»¶ç³»ç»Ÿå¿…é¡»åœ¨ <code>fs/</code> ä¸‹åˆ›å»ºè‡ªå·±çš„å±‚æ¬¡ç»“æ„ï¼ˆå‚è§ <code>./fuse.txt</code> äº†è§£ç¤ºä¾‹ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fs/ contains a directory for some filesystems.  Currently each</span><br><span class="line">filesystem wanting to export attributes must create its own hierarchy</span><br><span class="line">below fs/ (see ./fuse.txt for an example).</span><br></pre></td></tr></table></figure><p><code>dev/</code> åŒ…å«ä¸¤ä¸ªç›®å½• <code>char/</code> å’Œ <code>block/</code>ã€‚åœ¨è¿™ä¸¤ä¸ªç›®å½•ä¸­ï¼Œæœ‰åä¸º <code>&lt;major&gt;:&lt;minor&gt;</code> çš„ç¬¦å·é“¾æ¥ã€‚è¿™äº›ç¬¦å·é“¾æ¥æŒ‡å‘ç»™å®šè®¾å¤‡çš„ sysfs ç›®å½•ã€‚<code>/sys/dev</code> æä¾›äº†ä¸€ç§ä» <code>stat(2)</code> æ“ä½œçš„ç»“æœå¿«é€ŸæŸ¥æ‰¾è®¾å¤‡çš„ sysfs æ¥å£çš„æ–¹æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dev/ contains two directories char/ and block/. Inside these two</span><br><span class="line">directories there are symlinks named &lt;major&gt;:&lt;minor&gt;.  These symlinks</span><br><span class="line">point to the sysfs directory for the given device.  /sys/dev provides a</span><br><span class="line">quick way to lookup the sysfs interface for a device from the result of</span><br><span class="line">a stat(2) operation.</span><br></pre></td></tr></table></figure><p>æ›´å¤šæœ‰å…³é©±åŠ¨æ¨¡å‹ç‰¹å®šåŠŸèƒ½çš„ä¿¡æ¯å¯ä»¥åœ¨ <code>Documentation/driver-api/driver-model/</code> ä¸­æ‰¾åˆ°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">More information can driver-model specific features can be found in</span><br><span class="line">Documentation/driver-api/driver-model/.</span><br></pre></td></tr></table></figure><h3 id="å½“å‰æ¥å£"><a href="#å½“å‰æ¥å£" class="headerlink" title="å½“å‰æ¥å£"></a>å½“å‰æ¥å£</h3><p>ä»¥ä¸‹æ¥å£å±‚ç›®å‰å­˜åœ¨äº sysfs ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Current Interfaces</span><br><span class="line">~~~~~~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">The following interface layers currently exist in sysfs:</span><br></pre></td></tr></table></figure><h4 id="è®¾å¤‡ï¼ˆinclude-linux-device-hï¼‰"><a href="#è®¾å¤‡ï¼ˆinclude-linux-device-hï¼‰" class="headerlink" title="è®¾å¤‡ï¼ˆinclude/linux/device.hï¼‰"></a>è®¾å¤‡ï¼ˆ<code>include/linux/device.h</code>ï¼‰</h4><p>ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">devices (include/linux/device.h)</span><br><span class="line">--------------------------------</span><br><span class="line">Structure::</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">device_attribute</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span><span class="title">attr</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">    <span class="type">char</span> *buf);</span><br><span class="line">    <span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_attribute *attr,</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *buf, <span class="type">size_t</span> count);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Declaring::</span><br><span class="line"></span><br><span class="line">    DEVICE_ATTR(_name, _mode, _show, _store);</span><br></pre></td></tr></table></figure><p>åˆ›å»º&#x2F;åˆ é™¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Creation/Removal::</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">device_create_file</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="keyword">struct</span> device_attribute * attr)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">device_remove_file</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="type">const</span> <span class="keyword">struct</span> device_attribute * attr)</span>;</span><br></pre></td></tr></table></figure><h4 id="æ€»çº¿é©±åŠ¨ç¨‹åºï¼ˆinclude-linux-device-hï¼‰"><a href="#æ€»çº¿é©±åŠ¨ç¨‹åºï¼ˆinclude-linux-device-hï¼‰" class="headerlink" title="æ€»çº¿é©±åŠ¨ç¨‹åºï¼ˆinclude/linux/device.hï¼‰"></a>æ€»çº¿é©±åŠ¨ç¨‹åºï¼ˆ<code>include/linux/device.h</code>ï¼‰</h4><p>ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">bus <span class="title function_">drivers</span> <span class="params">(include/linux/device.h)</span></span><br><span class="line">------------------------------------</span><br><span class="line">Structure::</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> bus_attribute &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span>        <span class="title">attr</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> bus_type *, <span class="type">char</span> * buf);</span><br><span class="line">    <span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> bus_type *, <span class="type">const</span> <span class="type">char</span> * buf, <span class="type">size_t</span> count);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Declaring::</span><br><span class="line"></span><br><span class="line">    <span class="type">static</span> <span class="title function_">BUS_ATTR_RW</span><span class="params">(name)</span>;</span><br><span class="line">    <span class="type">static</span> <span class="title function_">BUS_ATTR_RO</span><span class="params">(name)</span>;</span><br><span class="line">    <span class="type">static</span> <span class="title function_">BUS_ATTR_WO</span><span class="params">(name)</span>;</span><br></pre></td></tr></table></figure><p>åˆ›å»º&#x2F;åˆ é™¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Creation/Removal::</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">bus_create_file</span><span class="params">(<span class="keyword">struct</span> bus_type *, <span class="keyword">struct</span> bus_attribute *)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">bus_remove_file</span><span class="params">(<span class="keyword">struct</span> bus_type *, <span class="keyword">struct</span> bus_attribute *)</span>;</span><br></pre></td></tr></table></figure><h4 id="è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆinclude-linux-device-hï¼‰"><a href="#è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆinclude-linux-device-hï¼‰" class="headerlink" title="è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆinclude/linux/device.hï¼‰"></a>è®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆ<code>include/linux/device.h</code>ï¼‰</h4><p>ç»“æ„ä½“ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">device <span class="title function_">drivers</span> <span class="params">(include/linux/device.h)</span></span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">Structure::</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> driver_attribute &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">attribute</span>        <span class="title">attr</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> device_driver *, <span class="type">char</span> * buf);</span><br><span class="line">    <span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> device_driver *, <span class="type">const</span> <span class="type">char</span> * buf,</span><br><span class="line">    <span class="type">size_t</span> count);</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>å£°æ˜ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Declaring::</span><br><span class="line"></span><br><span class="line">    DRIVER_ATTR_RO(_name)</span><br><span class="line">    DRIVER_ATTR_RW(_name)</span><br></pre></td></tr></table></figure><p>åˆ›å»º&#x2F;åˆ é™¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Creation/Removal::</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="title function_">driver_create_file</span><span class="params">(<span class="keyword">struct</span> device_driver *, <span class="type">const</span> <span class="keyword">struct</span> driver_attribute *)</span>;</span><br><span class="line">    <span class="type">void</span> <span class="title function_">driver_remove_file</span><span class="params">(<span class="keyword">struct</span> device_driver *, <span class="type">const</span> <span class="keyword">struct</span> driver_attribute *)</span>;</span><br></pre></td></tr></table></figure><h3 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h3><p>sysfs ç›®å½•ç»“æ„å’Œæ¯ä¸ªç›®å½•ä¸­çš„å±æ€§å®šä¹‰äº†å†…æ ¸ä¸ç”¨æˆ·ç©ºé—´ä¹‹é—´çš„ ABIã€‚å¯¹äºä»»ä½• ABI æ¥è¯´ï¼Œç¡®ä¿å…¶ç¨³å®šæ€§å’Œæ­£ç¡®æ–‡æ¡£åŒ–æ˜¯éå¸¸é‡è¦çš„ã€‚æ‰€æœ‰æ–°çš„ sysfs å±æ€§å¿…é¡»åœ¨ <code>Documentation/ABI</code> ä¸­è¿›è¡Œæ–‡æ¡£åŒ–ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… <code>Documentation/ABI/README</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Documentation</span><br><span class="line">~~~~~~~~~~~~~</span><br><span class="line"></span><br><span class="line">The sysfs directory structure and the attributes in each directory define an</span><br><span class="line">ABI between the kernel and user space. As for any ABI, it is important that</span><br><span class="line">this ABI is stable and properly documented. All new sysfs attributes must be</span><br><span class="line">documented in Documentation/ABI. See also Documentation/ABI/README for more</span><br><span class="line">information.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> sysfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux USB functionfs</title>
      <link href="/2024/09/22/Linux-USBfunctionfs/"/>
      <url>/2024/09/22/Linux-USBfunctionfs/</url>
      
        <content type="html"><![CDATA[<blockquote><p>translate from <a href="https://www.kernel.org/doc/html/v6.1/usb/functionfs.html">https://www.kernel.org/doc/html/v6.1/usb/functionfs.html</a></p></blockquote><h1 id="FunctionFS-å¦‚ä½•å·¥ä½œ"><a href="#FunctionFS-å¦‚ä½•å·¥ä½œ" class="headerlink" title="FunctionFS å¦‚ä½•å·¥ä½œ"></a>FunctionFS å¦‚ä½•å·¥ä½œ</h1><p>ä»å†…æ ¸çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå…·æœ‰ä¸€äº›ç‹¬ç‰¹è¡Œä¸ºçš„å¤åˆåŠŸèƒ½ã€‚åªæœ‰åœ¨ç”¨æˆ·ç©ºé—´é©±åŠ¨ç¨‹åºé€šè¿‡å†™å…¥æè¿°ç¬¦å’Œå­—ç¬¦ä¸²æ³¨å†Œåï¼Œå®ƒæ‰èƒ½è¢«æ·»åŠ åˆ° USB é…ç½®ä¸­ï¼ˆç”¨æˆ·ç©ºé—´ç¨‹åºå¿…é¡»æä¾›ä¸å†…æ ¸çº§å¤åˆåŠŸèƒ½åœ¨æ·»åŠ åˆ°é…ç½®ä¸­æ—¶æä¾›çš„ç›¸åŒä¿¡æ¯ï¼‰ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">From kernel point of view it is just a composite function with some</span><br><span class="line">unique behaviour.  It may be added to an USB configuration only after</span><br><span class="line">the user space driver has registered by writing descriptors and</span><br><span class="line">strings (the user space program has to provide the same information</span><br><span class="line">that kernel level composite functions provide when they are added to</span><br><span class="line">the configuration).</span><br></pre></td></tr></table></figure><p>è¿™ç‰¹åˆ«æ„å‘³ç€å¤åˆåˆå§‹åŒ–å‡½æ•°å¯èƒ½ä¸ä¼šåœ¨ init éƒ¨åˆ†ï¼ˆå³å¯èƒ½ä¸ä¼šä½¿ç”¨ __init æ ‡ç­¾ï¼‰ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">This in particular means that the composite initialisation functions</span><br><span class="line">may not be in init section (ie. may not use the __init tag).</span><br></pre></td></tr></table></figure><p>ä»ç”¨æˆ·ç©ºé—´çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œå½“æŒ‚è½½æ—¶ä¼šæä¾›ä¸€ä¸ª â€œep0â€ æ–‡ä»¶ã€‚ç”¨æˆ·ç©ºé—´é©±åŠ¨ç¨‹åºéœ€è¦å‘è¯¥æ–‡ä»¶å†™å…¥æè¿°ç¬¦å’Œå­—ç¬¦ä¸²ã€‚å®ƒä¸éœ€è¦æ‹…å¿ƒç«¯ç‚¹ã€æ¥å£æˆ–å­—ç¬¦ä¸²ç¼–å·ï¼Œè€Œåªéœ€æä¾›æè¿°ç¬¦ï¼Œå¦‚åŒè¯¥åŠŸèƒ½æ˜¯å”¯ä¸€çš„ï¼ˆç«¯ç‚¹å’Œå­—ç¬¦ä¸²ç¼–å·ä» 1 å¼€å§‹ï¼Œæ¥å£ç¼–å·ä» 0 å¼€å§‹ï¼‰ã€‚FunctionFS æ ¹æ®éœ€è¦æ›´æ”¹å®ƒä»¬ï¼Œå¹¶å¤„ç†åœ¨ä¸åŒé…ç½®ä¸­ç¼–å·ä¸åŒçš„æƒ…å†µã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">From user space point of view it is a file system which when</span><br><span class="line">mounted provides an &quot;ep0&quot; file.  User space driver need to</span><br><span class="line">write descriptors and strings to that file.  It does not need</span><br><span class="line">to worry about endpoints, interfaces or strings numbers but</span><br><span class="line">simply provide descriptors such as if the function was the</span><br><span class="line">only one (endpoints and strings numbers starting from one and</span><br><span class="line">interface numbers starting from zero).  The FunctionFS changes</span><br><span class="line">them as needed also handling situation when numbers differ in</span><br><span class="line">different configurations.</span><br></pre></td></tr></table></figure><p>å½“æè¿°ç¬¦å’Œå­—ç¬¦ä¸²è¢«å†™å…¥åï¼Œâ€œep#â€æ–‡ä»¶ä¼šå‡ºç°ï¼ˆæ¯ä¸ªå£°æ˜çš„ç«¯ç‚¹å¯¹åº”ä¸€ä¸ªï¼‰ï¼Œç”¨äºå¤„ç†å•ä¸ªç«¯ç‚¹ä¸Šçš„é€šä¿¡ã€‚åŒæ ·ï¼ŒFunctionFS è´Ÿè´£å®é™…ç¼–å·å’Œé…ç½®æ›´æ”¹ï¼ˆè¿™æ„å‘³ç€ â€œep1â€ æ–‡ä»¶å¯èƒ½å®é™…ä¸Šæ˜ å°„åˆ°ï¼ˆä¾‹å¦‚ï¼‰ç«¯ç‚¹ 3ï¼ˆå½“é…ç½®æ›´æ”¹æ—¶å¯èƒ½æ˜ å°„åˆ°ç«¯ç‚¹ 2ï¼‰ï¼‰ã€‚â€ep0â€ ç”¨äºæ¥æ”¶äº‹ä»¶å’Œå¤„ç†è®¾ç½®è¯·æ±‚ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">When descriptors and strings are written &quot;ep#&quot; files appear</span><br><span class="line">(one for each declared endpoint) which handle communication on</span><br><span class="line">a single endpoint.  Again, FunctionFS takes care of the real</span><br><span class="line">numbers and changing of the configuration (which means that</span><br><span class="line">&quot;ep1&quot; file may be really mapped to (say) endpoint 3 (and when</span><br><span class="line">configuration changes to (say) endpoint 2)).  &quot;ep0&quot; is used</span><br><span class="line">for receiving events and handling setup requests.</span><br></pre></td></tr></table></figure><p>å½“æ‰€æœ‰æ–‡ä»¶å…³é—­æ—¶ï¼Œè¯¥åŠŸèƒ½ä¼šè‡ªåŠ¨ç¦ç”¨ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">When all files are closed the function disables itself.</span><br></pre></td></tr></table></figure><p>æˆ‘è¿˜æƒ³æåˆ°çš„æ˜¯ï¼ŒFunctionFS çš„è®¾è®¡ä½¿å…¶å¯ä»¥å¤šæ¬¡æŒ‚è½½ï¼Œå› æ­¤æœ€ç»ˆä¸€ä¸ªgadgetå¯ä»¥ä½¿ç”¨å¤šä¸ª FunctionFS åŠŸèƒ½ã€‚å…¶ç†å¿µæ˜¯æ¯ä¸ª FunctionFS å®ä¾‹éƒ½ç”±æŒ‚è½½æ—¶ä½¿ç”¨çš„è®¾å¤‡åç§°æ ‡è¯†ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">What I also want to mention is that the FunctionFS is designed in such</span><br><span class="line">a way that it is possible to mount it several times so in the end</span><br><span class="line">a gadget could use several FunctionFS functions. The idea is that</span><br><span class="line">each FunctionFS instance is identified by the device name used</span><br><span class="line">when mounting.</span><br></pre></td></tr></table></figure><p>å¯ä»¥æƒ³è±¡ä¸€ä¸ªgadgetå…·æœ‰ä»¥å¤ªç½‘ã€MTP å’Œ HID æ¥å£ï¼Œå…¶ä¸­åä¸¤ä¸ªæ˜¯é€šè¿‡ FunctionFS å®ç°çš„ã€‚åœ¨ç”¨æˆ·ç©ºé—´å±‚é¢ï¼Œå®ƒçœ‹èµ·æ¥åƒè¿™æ ·ï¼š</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">One can imagine a gadget that has an Ethernet, MTP and HID interfaces</span><br><span class="line">where the last two are implemented via FunctionFS.  On user space</span><br><span class="line">level it would look like this::</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ insmod g_ffs.ko idVendor=&lt;ID&gt; iSerialNumber=&lt;string&gt; <span class="built_in">functions</span>=mtp,hid</span><br><span class="line">$ <span class="built_in">mkdir</span> /dev/ffs-mtp &amp;&amp; mount -t functionfs mtp /dev/ffs-mtp</span><br><span class="line">$ ( <span class="built_in">cd</span> /dev/ffs-mtp &amp;&amp; mtp-daemon ) &amp;</span><br><span class="line">$ <span class="built_in">mkdir</span> /dev/ffs-hid &amp;&amp; mount -t functionfs hid /dev/ffs-hid</span><br><span class="line">$ ( <span class="built_in">cd</span> /dev/ffs-hid &amp;&amp; hid-daemon ) &amp;</span><br></pre></td></tr></table></figure><p>åœ¨å†…æ ¸å±‚é¢ï¼Œgadgetæ£€æŸ¥ ffs_data-&gt;dev_name ä»¥ç¡®å®šå®ƒæ˜¯ä¸º MTPï¼ˆâ€œmtpâ€ï¼‰è¿˜æ˜¯ HIDï¼ˆâ€œhidâ€ï¼‰è®¾è®¡çš„ FunctionFSã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">On kernel level the gadget checks ffs_data-&gt;dev_name to identify</span><br><span class="line">whether it&#x27;s FunctionFS designed for MTP (&quot;mtp&quot;) or HID (&quot;hid&quot;).</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰æä¾› â€œfunctionsâ€ æ¨¡å—å‚æ•°ï¼Œé©±åŠ¨ç¨‹åºåªæ¥å—ä¸€ä¸ªå…·æœ‰ä»»æ„åç§°çš„åŠŸèƒ½ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">If no &quot;functions&quot; module parameters is supplied, the driver accepts</span><br><span class="line">just one function with any name.</span><br></pre></td></tr></table></figure><p>å½“æä¾›äº† â€œfunctionsâ€ æ¨¡å—å‚æ•°æ—¶ï¼Œåªæœ‰åˆ—å‡ºçš„åŠŸèƒ½åç§°ä¼šè¢«æ¥å—ã€‚ç‰¹åˆ«åœ°ï¼Œå¦‚æœ â€œfunctionsâ€ å‚æ•°çš„å€¼åªæ˜¯ä¸€ä¸ªå•å…ƒç´ åˆ—è¡¨ï¼Œé‚£ä¹ˆè¡Œä¸ºç±»ä¼¼äºæ²¡æœ‰ â€œfunctionsâ€ å‚æ•°çš„æƒ…å†µï¼›ç„¶è€Œï¼Œä»…æ¥å—å…·æœ‰æŒ‡å®šåç§°çš„åŠŸèƒ½ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">When &quot;functions&quot; module parameter is supplied, only functions</span><br><span class="line">with listed names are accepted. In particular, if the &quot;functions&quot;</span><br><span class="line">parameter&#x27;s value is just a one-element list, then the behaviour</span><br><span class="line">is similar to when there is no &quot;functions&quot; at all; however,</span><br><span class="line">only a function with the specified name is accepted.</span><br></pre></td></tr></table></figure><p>åªæœ‰åœ¨æ‰€æœ‰å£°æ˜çš„åŠŸèƒ½æ–‡ä»¶ç³»ç»Ÿéƒ½å·²æŒ‚è½½å¹¶ä¸”æ‰€æœ‰åŠŸèƒ½çš„ USB æè¿°ç¬¦éƒ½å·²å†™å…¥å…¶ ep0 æ—¶ï¼Œgadgetæ‰ä¼šè¢«æ³¨å†Œã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The gadget is registered only after all the declared function</span><br><span class="line">filesystems have been mounted and USB descriptors of all functions</span><br><span class="line">have been written to their ep0&#x27;s.</span><br></pre></td></tr></table></figure><p>ç›¸åï¼Œç¬¬ä¸€ä¸ª USB åŠŸèƒ½å…³é—­å…¶ç«¯ç‚¹åï¼Œgadgetä¼šè¢«æ³¨é”€ã€‚</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Conversely, the gadget is unregistered after the first USB function</span><br><span class="line">closes its endpoints.</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> USB </tag>
            
            <tag> configfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux USB gadget_configfs</title>
      <link href="/2024/09/22/Linux-USBconfigfs/"/>
      <url>/2024/09/22/Linux-USBconfigfs/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-USB-gadget-é€šè¿‡-configfs-é…ç½®"><a href="#Linux-USB-gadget-é€šè¿‡-configfs-é…ç½®" class="headerlink" title="Linux USB gadget é€šè¿‡ configfs é…ç½®"></a>Linux USB gadget é€šè¿‡ configfs é…ç½®</h2><ul><li><input disabled="" type="checkbox"> å…ˆé˜…è¯» <a href="Linux-configfs.md">Linux configfs</a>ï¼Œå†çœ‹æ­¤å†…å®¹</li></ul><p>usb åªæœ‰åœ¨ä½œä¸ºä»è®¾å¤‡æ—¶ï¼Œæ‰ä¼šç”¨åˆ° configfs å»é…ç½®åŠŸèƒ½ã€‚</p><p>æ›´æ–°æ—¥æœŸï¼š2013å¹´4æœˆ25æ—¥</p><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>USB Linux Gadget æ˜¯ä¸€ç§è®¾å¤‡ï¼Œå®ƒå…·æœ‰ä¸€ä¸ª UDCï¼ˆUSB è®¾å¤‡æ§åˆ¶å™¨ï¼‰ï¼Œå¹¶ä¸”å¯ä»¥è¿æ¥åˆ° USB ä¸»æœºï¼Œé€šè¿‡æ·»åŠ åŠŸèƒ½æ‰©å±•ä¸»æœºï¼Œå¦‚ä¸²è¡Œç«¯å£æˆ–å¤§å®¹é‡å­˜å‚¨åŠŸèƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A USB Linux Gadget is a device which has a UDC (USB Device Controller)</span><br><span class="line">and can be connected to a USB Host to extend it with additional functions</span><br><span class="line">like a serial port or a mass storage capability.</span><br></pre></td></tr></table></figure><p>ä»ä¸»æœºçš„è§’åº¦æ¥çœ‹ï¼Œ<strong>ä¸€ä¸ª Gadget æ˜¯ä¸€ç»„é…ç½®çš„é›†åˆ</strong>ï¼Œ<strong>æ¯ä¸ªé…ç½®åŒ…å«è‹¥å¹²æ¥å£ï¼Œè€Œä» Gadget çš„è§’åº¦çœ‹ï¼Œè¿™äº›æ¥å£è¢«ç§°ä¸ºåŠŸèƒ½ï¼ˆfunctionï¼‰ï¼Œæ¯ä¸ªåŠŸèƒ½ä»£è¡¨ä¸€ä¸ªå¦‚ä¸²è¡Œè¿æ¥æˆ– SCSI ç£ç›˜çš„è®¾å¤‡</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A gadget is seen by its host as a set of configurations, each of which</span><br><span class="line">contains a number of interfaces which, from the gadget&#x27;s perspective,</span><br><span class="line">are known as functions, each function representing e.g. a serial</span><br><span class="line">connection or a SCSI disk.</span><br></pre></td></tr></table></figure><p>Linux æä¾›äº†è®¸å¤šåŠŸèƒ½ä¾› Gadget ä½¿ç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux provides a number of functions for gadgets to use.</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»ºä¸€ä¸ª Gadget æ„å‘³ç€å†³å®šå°†æœ‰å“ªäº›é…ç½®ï¼Œä»¥åŠæ¯ä¸ªé…ç½®å°†æä¾›å“ªäº›åŠŸèƒ½</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Creating a gadget means deciding what configurations there will be and which</span><br><span class="line">functions each configuration will provide.</span><br></pre></td></tr></table></figure><p>Configfsï¼ˆè¯·å‚è§ <code>Documentation/filesystems/configfs.rst</code>ï¼‰éå¸¸é€‚åˆç”¨äºå‘å†…æ ¸ä¼ è¾¾ä¸Šè¿°å†³ç­–ã€‚æœ¬æ–‡æ¡£è®¨è®ºäº†å¦‚ä½•å®ç°è¿™ä¸€ç›®æ ‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Configfs (please see `Documentation/filesystems/configfs.rst`) lends itself</span><br><span class="line">nicely for the purpose of telling the kernel about the above mentioned decision.</span><br><span class="line">This document is about how to do it.</span><br></pre></td></tr></table></figure><p>å®ƒè¿˜æè¿°äº† Gadget ä¸­çš„ configfs é›†æˆè®¾è®¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">It also describes how configfs integration into gadget is designed.</span><br></pre></td></tr></table></figure><h2 id="è¦æ±‚"><a href="#è¦æ±‚" class="headerlink" title="è¦æ±‚"></a>è¦æ±‚</h2><p>ä¸ºäº†ä½¿å…¶å·¥ä½œï¼Œconfigfs å¿…é¡»å¯ç”¨ï¼Œå› æ­¤ .config ä¸­çš„ <code>CONFIGFS_FS</code> å¿…é¡»ä¸º â€˜yâ€™ æˆ– â€˜mâ€™ã€‚æˆªè‡³æœ¬æ–‡å†™ä½œæ—¶ï¼Œ<code>USB_LIBCOMPOSITE</code> é€‰æ‹©äº† <code>CONFIGFS_FS</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In order for this to work configfs must be available, so CONFIGFS_FS must be &#x27;y&#x27;</span><br><span class="line">or &#x27;m&#x27; in .config. As of this writing USB_LIBCOMPOSITE selects CONFIGFS_FS.</span><br></pre></td></tr></table></figure><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>ï¼ˆæè¿°ç¬¬ä¸€ä¸ªé€šè¿‡ configfs æä¾›çš„åŠŸèƒ½çš„åŸå§‹å¸–å­å¯ä»¥åœ¨è¿™é‡Œçœ‹åˆ°ï¼š<a href="http://www.spinics.net/lists/linux-usb/msg76388.html%EF%BC%89">http://www.spinics.net/lists/linux-usb/msg76388.htmlï¼‰</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(The original post describing the first function made available through configfs</span><br><span class="line">can be seen here: http://www.spinics.net/lists/linux-usb/msg76388.html)</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe libcomposite</span><br><span class="line">$ mount none <span class="variable">$CONFIGFS_HOME</span> -t configfs</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ CONFIGFS_HOME æ˜¯ configfs çš„æŒ‚è½½ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where CONFIGFS_HOME is the mount point for configfs</span><br></pre></td></tr></table></figure><h3 id="1-åˆ›å»º-Gadgets"><a href="#1-åˆ›å»º-Gadgets" class="headerlink" title="1. åˆ›å»º Gadgets"></a>1. åˆ›å»º Gadgets</h3><p>ä¸ºæ¯ä¸ªè¦åˆ›å»ºçš„ Gadget åˆ›å»ºç›¸åº”çš„ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="variable">$CONFIGFS_HOME</span>/usb_gadget/&lt;gadget name&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">For each gadget to be created its corresponding directory must be created:</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="variable">$CONFIGFS_HOME</span>/usb_gadget/g1</span><br></pre></td></tr></table></figure><p>è¿›å…¥å¯¹åº”çš„ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$CONFIGFS_HOME</span>/usb_gadget/g1</span><br></pre></td></tr></table></figure><p>æ¯ä¸ª Gadget éœ€è¦æŒ‡å®šå…¶ä¾›åº”å•† IDï¼ˆVIDï¼‰å’Œäº§å“ IDï¼ˆPIDï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;VID&gt; &gt; idVendor</span><br><span class="line">$ <span class="built_in">echo</span> &lt;PID&gt; &gt; idProduct</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Each gadget needs to have its vendor id &lt;VID&gt; and product id &lt;PID&gt; specified:</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª Gadget è¿˜éœ€è¦å…¶åºåˆ—å·ã€åˆ¶é€ å•†å’Œäº§å“å­—ç¬¦ä¸²ã€‚ä¸ºäº†å­˜å‚¨å®ƒä»¬ï¼Œéœ€è¦ä¸ºæ¯ç§è¯­è¨€åˆ›å»ºä¸€ä¸ªå­—ç¬¦ä¸²å­ç›®å½•ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A gadget also needs its serial number, manufacturer and product strings. In order</span><br><span class="line">to have a place to store them, a strings subdirectory must be created for each language,</span><br><span class="line">e.g.:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> strings/0x409</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/brookebasile/USB-langids/blob/master/USB%20Lang%20IDs%20-%20Language%20Identifiers.csv">usb language IDS</a> or <a href="http://www.baiheee.com/Documents/090518/090518112619/USB_LANGIDs.pdf">http://www.baiheee.com/Documents/090518/090518112619/USB_LANGIDs.pdf</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x0404Chinese (Taiwan)</span><br><span class="line">0x0804Chinese (PRC)</span><br><span class="line">0x0c04Chinese (Hong Kong SAR, PRC)</span><br><span class="line">0x1004Chinese (Singapore)</span><br><span class="line">0x1404Chinese (Macau SAR)</span><br><span class="line">0x0409English (United States)</span><br><span class="line">0x0809English (United Kingdom)</span><br></pre></td></tr></table></figure></blockquote><p>ç„¶åå¯ä»¥æŒ‡å®šå­—ç¬¦ä¸²ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Then the strings can be specified:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;serial number&gt; &gt; strings/0x409/serialnumber</span><br><span class="line">$ <span class="built_in">echo</span> &lt;manufacturer&gt; &gt; strings/0x409/manufacturer</span><br><span class="line">$ <span class="built_in">echo</span> &lt;product&gt; &gt; strings/0x409/product</span><br></pre></td></tr></table></figure><h3 id="2-åˆ›å»ºé…ç½®"><a href="#2-åˆ›å»ºé…ç½®" class="headerlink" title="2. åˆ›å»ºé…ç½®"></a>2. åˆ›å»ºé…ç½®</h3><p>æ¯ä¸ª Gadget å°†åŒ…å«è‹¥å¹²é…ç½®ï¼Œéœ€è¦åˆ›å»ºç›¸åº”çš„ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> configs/&lt;name&gt;.&lt;number&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Each gadget will consist of a number of configurations, their corresponding directories must be created:</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>&lt;name&gt;</code> å¯ä»¥æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­åˆæ³•çš„ä»»æ„å­—ç¬¦ä¸²ï¼Œ<code>&lt;number&gt;</code> æ˜¯é…ç½®çš„ç¼–å·ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> configs/c.1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where &lt;name&gt; can be any string which is legal in a filesystem and the &lt;number&gt; is the configuration&#x27;s number, e.g.:</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªé…ç½®ä¹Ÿéœ€è¦å…¶å­—ç¬¦ä¸²ï¼Œå› æ­¤éœ€è¦ä¸ºæ¯ç§è¯­è¨€åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> configs/c.1/strings/0x409</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Each configuration also needs its strings, so a subdirectory must be created for</span><br><span class="line">each language, e.g.:</span><br></pre></td></tr></table></figure><p>ç„¶åå¯ä»¥æŒ‡å®šé…ç½®å­—ç¬¦ä¸²ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;configuration&gt; &gt; configs/c.1/strings/0x409/configuration</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Then the configuration string can be specified:</span><br></pre></td></tr></table></figure><p>è¿˜å¯ä»¥ä¸ºé…ç½®è®¾ç½®ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 120 &gt; configs/c.1/MaxPower</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Some attributes can also be set for a configuration, e.g.:</span><br></pre></td></tr></table></figure><h3 id="3-åˆ›å»ºåŠŸèƒ½"><a href="#3-åˆ›å»ºåŠŸèƒ½" class="headerlink" title="3. åˆ›å»ºåŠŸèƒ½"></a>3. åˆ›å»ºåŠŸèƒ½</h3><p>Gadget å°†æä¾›ä¸€äº›åŠŸèƒ½ï¼Œä¸ºæ¯ä¸ªåŠŸèƒ½åˆ›å»ºç›¸åº”çš„ç›®å½•ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="built_in">functions</span>/&lt;name&gt;.&lt;instance name&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The gadget will provide some functions, for each function its corresponding</span><br><span class="line">directory must be created:</span><br></pre></td></tr></table></figure><p><strong>å…¶ä¸­ <code>&lt;name&gt;</code> å¯¹åº”äºå…è®¸çš„åŠŸèƒ½åç§°ä¹‹ä¸€</strong>ï¼Œå®ä¾‹åç§°æ˜¯æ–‡ä»¶ç³»ç»Ÿä¸­å…è®¸çš„ä»»æ„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="built_in">functions</span>/ncm.usb0 <span class="comment"># usb_f_ncm.ko gets loaded with request_module()</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">where &lt;name&gt; corresponds to one of allowed function names and instance name is</span><br><span class="line">an arbitrary string allowed in a filesystem, e.g.:</span><br></pre></td></tr></table></figure><p>æ¯ä¸ªåŠŸèƒ½æä¾›å…¶ç‰¹å®šçš„ä¸€ç»„å±æ€§ï¼Œå…·æœ‰åªè¯»æˆ–è¯»å†™è®¿é—®æƒé™ã€‚åœ¨é€‚ç”¨çš„æƒ…å†µä¸‹ï¼Œéœ€è¦é€‚å½“å†™å…¥å®ƒä»¬ã€‚è¯·å‚é˜… <code>Documentation/ABI/*/configfs-usb-gadget*</code> äº†è§£æ›´å¤šä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Each function provides its specific set of attributes, with either read-only or</span><br><span class="line">read-write access. Where applicable they need to be written to as appropriate.</span><br><span class="line">Please refer to Documentation/ABI/*/configfs-usb-gadget* for more information.</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥ <a href="https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing">Documentation&#x2F;ABI&#x2F;*&#x2F;configfs-usb-gadget</a> <strong>è¿™é‡Œæœ‰å¯¹æ¯ä¸ªæ–‡ä»¶çš„è¯¦ç»†ä»‹ç»</strong>ã€‚</p></blockquote><h3 id="4-å°†åŠŸèƒ½ä¸é…ç½®å…³è”"><a href="#4-å°†åŠŸèƒ½ä¸é…ç½®å…³è”" class="headerlink" title="4. å°†åŠŸèƒ½ä¸é…ç½®å…³è”"></a>4. å°†åŠŸèƒ½ä¸é…ç½®å…³è”</h3><p>æ­¤æ—¶åˆ›å»ºäº†è‹¥å¹² Gadgetï¼Œæ¯ä¸ª Gadget éƒ½æŒ‡å®šäº†è‹¥å¹²é…ç½®ï¼Œå¹¶ä¸”æœ‰è‹¥å¹²å¯ç”¨åŠŸèƒ½ã€‚å‰©ä¸‹çš„å°±æ˜¯æŒ‡å®šå“ªä¸ªåŠŸèƒ½åœ¨å“ªä¸ªé…ç½®ä¸­å¯ç”¨ï¼ˆåŒä¸€åŠŸèƒ½å¯ä»¥åœ¨å¤šä¸ªé…ç½®ä¸­ä½¿ç”¨ï¼‰ã€‚è¿™å¯ä»¥é€šè¿‡åˆ›å»ºç¬¦å·é“¾æ¥æ¥å®ç°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ln</span> -s <span class="built_in">functions</span>/&lt;name&gt;.&lt;instance name&gt; configs/&lt;name&gt;.&lt;number&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">At this moment a number of gadgets is created, each of which has a number of configurations specified and a number of functions available. What remains is specifying which function is available in which configuration (the same function can be used in multiple configurations). This is achieved with creating symbolic links:</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ln</span> -s <span class="built_in">functions</span>/ncm.usb0 configs/c.1</span><br></pre></td></tr></table></figure><h3 id="5-å¯ç”¨-Gadget"><a href="#5-å¯ç”¨-Gadget" class="headerlink" title="5. å¯ç”¨ Gadget"></a>5. å¯ç”¨ Gadget</h3><p>ä»¥ä¸Šæ‰€æœ‰æ­¥éª¤çš„ç›®çš„æ˜¯å°† Gadget ç»„æˆé…ç½®å’ŒåŠŸèƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">All the above steps serve the purpose of composing the gadget of configurations and functions.</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªç¤ºä¾‹ç›®å½•ç»“æ„å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An example directory structure might look like this:</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">./strings</span><br><span class="line">./strings/0x409</span><br><span class="line">./strings/0x409/serialnumber</span><br><span class="line">./strings/0x409/product</span><br><span class="line">./strings/0x409/manufacturer</span><br><span class="line">./configs</span><br><span class="line">./configs/c.1</span><br><span class="line">./configs/c.1/ncm.usb0 -&gt; ../../../../usb_gadget/g1/functions/ncm.usb0</span><br><span class="line">./configs/c.1/strings</span><br><span class="line">./configs/c.1/strings/0x409</span><br><span class="line">./configs/c.1/strings/0x409/configuration</span><br><span class="line">./configs/c.1/bmAttributes</span><br><span class="line">./configs/c.1/MaxPower</span><br><span class="line">./functions</span><br><span class="line">./functions/ncm.usb0</span><br><span class="line">./functions/ncm.usb0/ifname</span><br><span class="line">./functions/ncm.usb0/qmult</span><br><span class="line">./functions/ncm.usb0/host_addr</span><br><span class="line">./functions/ncm.usb0/dev_addr</span><br><span class="line">./UDC</span><br><span class="line">./bcdUSB</span><br><span class="line">./bcdDevice</span><br><span class="line">./idProduct</span><br><span class="line">./idVendor</span><br><span class="line">./bMaxPacketSize0</span><br><span class="line">./bDeviceProtocol</span><br><span class="line">./bDeviceSubClass</span><br><span class="line">./bDeviceClass</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„ Gadget å¿…é¡»æœ€ç»ˆå¯ç”¨ï¼Œä»¥ä¾¿ USB ä¸»æœºå¯ä»¥æšä¸¾å®ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Such a gadget must be finally enabled so that the USB host can enumerate it.</span><br></pre></td></tr></table></figure><p>ä¸ºäº†å¯ç”¨ Gadgetï¼Œå¿…é¡»å°†å…¶ç»‘å®šåˆ° UDCï¼ˆUSB è®¾å¤‡æ§åˆ¶å™¨ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;udc name&gt; &gt; UDC</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In order to enable the gadget it must be bound to a UDC (USB Device Controller):</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>&lt;udc name&gt;</code> æ˜¯åœ¨ <code>/sys/class/udc/*</code> ä¸­æ‰¾åˆ°çš„ä¸€ä¸ªåç§°ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where &lt;udc name&gt; is one of those found in /sys/class/udc/* e.g.:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> s3c-hsotg &gt; UDC</span><br></pre></td></tr></table></figure><h3 id="6-ç¦ç”¨-Gadget"><a href="#6-ç¦ç”¨-Gadget" class="headerlink" title="6. ç¦ç”¨ Gadget"></a>6. ç¦ç”¨ Gadget</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; UDC</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;&quot; &gt; UDC</span><br></pre></td></tr></table></figure><h3 id="7-æ¸…ç†"><a href="#7-æ¸…ç†" class="headerlink" title="7. æ¸…ç†"></a>7. æ¸…ç†</h3><p>ä»é…ç½®ä¸­åˆ é™¤åŠŸèƒ½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove functions from configurations:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> configs/&lt;config name&gt;.&lt;number&gt;/&lt;<span class="keyword">function</span>&gt;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ <code>&lt;config name&gt;.&lt;number&gt;</code> æŒ‡å®šé…ç½®ï¼Œ<code>&lt;function&gt;</code> æ˜¯è¦ä»é…ç½®ä¸­åˆ é™¤çš„åŠŸèƒ½çš„ç¬¦å·é“¾æ¥ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">where &lt;config name&gt;.&lt;number&gt; specify the configuration and &lt;function&gt; is a</span><br><span class="line">symlink to a function being removed from the configuration, e.g.:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> configs/c.1/ncm.usb0</span><br></pre></td></tr></table></figure><p>åˆ é™¤é…ç½®ä¸­çš„å­—ç¬¦ä¸²ç›®å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove strings directories in configurations:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/&lt;config name&gt;.&lt;number&gt;/strings/&lt;lang&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/c.1/strings/0x409</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ é™¤é…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and remove the configurations:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/&lt;config name&gt;.&lt;number&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/c.1</span><br></pre></td></tr></table></figure><p>åˆ é™¤åŠŸèƒ½ï¼ˆåŠŸèƒ½æ¨¡å—ä¸ä¼šè¢«å¸è½½ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove functions (function modules are not unloaded, though):</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> <span class="built_in">functions</span>/&lt;name&gt;.&lt;instance name&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> <span class="built_in">functions</span>/ncm.usb0</span><br></pre></td></tr></table></figure><p>åˆ é™¤ Gadget ä¸­çš„å­—ç¬¦ä¸²ç›®å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove strings directories in the gadget:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> strings/&lt;lang&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> strings/0x409</span><br></pre></td></tr></table></figure><p>æœ€ååˆ é™¤ Gadgetï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and finally remove the gadget:</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line">$ <span class="built_in">rmdir</span> &lt;gadget name&gt;</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> g1</span><br></pre></td></tr></table></figure><h2 id="å®ç°è®¾è®¡"><a href="#å®ç°è®¾è®¡" class="headerlink" title="å®ç°è®¾è®¡"></a>å®ç°è®¾è®¡</h2><blockquote><p><a href="Linux-configfs.md">linux configfs</a></p></blockquote><p>ä¸‹é¢å±•ç¤ºäº† configfs çš„å·¥ä½œåŸç†ã€‚ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥<strong>åœ¨ configfs ä¸­ï¼Œæœ‰é¡¹ç›®<code>item</code>å’Œç»„<code>group</code>ï¼Œå‡è¡¨ç¤ºä¸ºç›®å½•ã€‚é¡¹ç›®å’Œç»„çš„åŒºåˆ«åœ¨äºç»„å¯ä»¥åŒ…å«å…¶ä»–ç»„</strong>ğŸ’¥ğŸ’¥ğŸ’¥ã€‚ä¸‹å›¾ä»…æ˜¾ç¤ºäº†ä¸€ä¸ªé¡¹ç›®ã€‚é¡¹ç›®å’Œç»„éƒ½å¯ä»¥æœ‰å±æ€§ï¼Œè¿™äº›å±æ€§è¡¨ç¤ºä¸ºæ–‡ä»¶ã€‚ç”¨æˆ·å¯ä»¥åˆ›å»ºå’Œåˆ é™¤ç›®å½•ï¼Œä½†ä¸èƒ½åˆ é™¤æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å¯ä»¥æ˜¯åªè¯»æˆ–è¯»å†™çš„ï¼Œå…·ä½“å–å†³äºå®ƒä»¬è¡¨ç¤ºçš„å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Below the idea of how configfs works is presented. In configfs there are items and groups,</span><br><span class="line">both represented as directories. The difference between an item and a group is</span><br><span class="line">that a group can contain other groups. In the picture below only an item is shown.</span><br><span class="line">Both items and groups can have attributes, which are represented as files.</span><br><span class="line">The user can create and remove directories, but cannot remove files, which can</span><br><span class="line">be read-only or read-write, depending on what they represent.</span><br></pre></td></tr></table></figure><p>configfs æ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ†æ“ä½œ config_items&#x2F;groups å’Œ configfs_attributesï¼Œå®ƒä»¬æ˜¯é€šç”¨ä¸”å¯¹æ‰€æœ‰é…ç½®å…ƒç´ ç±»å‹ç›¸åŒçš„ã€‚ç„¶è€Œï¼Œå®ƒä»¬åµŒå…¥åœ¨ç‰¹å®šç”¨é€”çš„æ›´å¤§ç»“æ„ä¸­ã€‚ä¸‹å›¾ä¸­æœ‰ä¸€ä¸ª â€œcsâ€ åŒ…å«ä¸€ä¸ª config_itemï¼Œè¿˜æœ‰ä¸€ä¸ª â€œsaâ€ åŒ…å«ä¸€ä¸ª configfs_attributeã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The filesystem part of configfs operates on config_items/groups and</span><br><span class="line">configfs_attributes which are generic and of the same type for all configured elements.</span><br><span class="line">However, they are embedded in usage-specific larger structures. In the picture</span><br><span class="line">below there is a &quot;cs&quot; which contains a config_item and an &quot;sa&quot;</span><br><span class="line">which contains a configfs_attribute.</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶ç³»ç»Ÿè§†å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The filesystem view would be like this:</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">./cs        (directory)</span><br><span class="line">   |</span><br><span class="line">   +--sa    (file)</span><br><span class="line">   |</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br></pre></td></tr></table></figure><p>æ¯å½“ç”¨æˆ·è¯»å–&#x2F;å†™å…¥ â€œsaâ€ æ–‡ä»¶æ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ª struct config_item å’Œä¸€ä¸ª struct configfs_attributeã€‚åœ¨è¯¥å‡½æ•°ä¸­ï¼Œä½¿ç”¨å·²çŸ¥çš„ container_of æŠ€æœ¯æ£€ç´¢ â€œcsâ€ å’Œ â€œsaâ€ï¼Œå¹¶è°ƒç”¨é€‚å½“çš„ sa çš„å‡½æ•°ï¼ˆshow æˆ– storeï¼‰ï¼Œå¹¶ä¼ é€’ â€œcsâ€ å’Œä¸€ä¸ªå­—ç¬¦ç¼“å†²åŒºã€‚â€showâ€ ç”¨äºæ˜¾ç¤ºæ–‡ä»¶å†…å®¹ï¼ˆå°†æ•°æ®ä» cs å¤åˆ¶åˆ°ç¼“å†²åŒºï¼‰ï¼Œè€Œ â€œstoreâ€ ç”¨äºä¿®æ”¹æ–‡ä»¶å†…å®¹ï¼ˆå°†æ•°æ®ä»ç¼“å†²åŒºå¤åˆ¶åˆ° csï¼‰ï¼Œä½†å…·ä½“åšä»€ä¹ˆå–å†³äºè¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°è€…ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Whenever a user reads/writes the &quot;sa&quot; file, a function is called which accepts</span><br><span class="line">a struct config_item and a struct configfs_attribute. In the said function the</span><br><span class="line">&quot;cs&quot; and &quot;sa&quot; are retrieved using the well known container_of technique and an</span><br><span class="line">appropriate sa&#x27;s function (show or store) is called and passed the &quot;cs&quot; and a</span><br><span class="line">character buffer. The &quot;show&quot; is for displaying the file&#x27;s contents (copy data</span><br><span class="line">from the cs to the buffer), while the &quot;store&quot; is for modifying the file&#x27;s</span><br><span class="line">contents (copy data from the buffer to the cs), but it is up to the implementer</span><br><span class="line">of the two functions to decide what they actually do.</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">typedef struct configured_structure cs;</span><br><span class="line">typedef struct specific_attribute sa;</span><br><span class="line"></span><br><span class="line">                                       sa</span><br><span class="line">                       +----------------------------------+</span><br><span class="line">        cs             |  (*show)(cs *, buffer);          |</span><br><span class="line">+-----------------+    |  (*store)(cs *, buffer, length); |</span><br><span class="line">|                 |    |                                  |</span><br><span class="line">| +-------------+ |    |       +------------------+       |</span><br><span class="line">| | struct      |-|----|------&gt;|struct            |       |</span><br><span class="line">| | config_item | |    |       |configfs_attribute|       |</span><br><span class="line">| +-------------+ |    |       +------------------+       |</span><br><span class="line">|                 |    +----------------------------------+</span><br><span class="line">| data to be set  |                .</span><br><span class="line">|                 |                .</span><br><span class="line">+-----------------+                .</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶åç”±é…ç½®é¡¹&#x2F;ç»„è®¾è®¡è€…å†³å®šï¼Œè€Œç›®å½•é€šå¸¸å¯ä»¥éšæ„å‘½åã€‚ä¸€ä¸ªç»„å¯ä»¥è‡ªåŠ¨åˆ›å»ºå…¶é»˜è®¤å­ç»„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The file names are decided by the config item/group designer, while the directories</span><br><span class="line"> in general can be named at will. A group can have a number of its default</span><br><span class="line"> sub-groups created automatically.</span><br></pre></td></tr></table></figure><p>æœ‰å…³ configfs çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ <code>Documentation/filesystems/configfs.rst</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">For more information on configfs please see `Documentation/filesystems/configfs.rst`.</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ¦‚å¿µåœ¨ USB gadgets ä¸­çš„åº”ç”¨å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The concepts described above translate to USB gadgets like this:</span><br></pre></td></tr></table></figure><ol><li>ä¸€ä¸ª Gadget æœ‰å…¶é…ç½®ç»„ï¼Œå…·æœ‰ä¸€äº›å±æ€§ï¼ˆå¦‚ idVendorã€idProduct ç­‰ï¼‰å’Œé»˜è®¤å­ç»„ï¼ˆconfigsã€functionsã€stringsï¼‰ã€‚å†™å…¥è¿™äº›å±æ€§ä¼šå°†ä¿¡æ¯å­˜å‚¨åœ¨é€‚å½“çš„ä½ç½®ã€‚åœ¨ configsã€functions å’Œ strings å­ç»„ä¸­ï¼Œç”¨æˆ·å¯ä»¥åˆ›å»ºå®ƒä»¬çš„å­ç»„æ¥è¡¨ç¤ºç»™å®šè¯­è¨€çš„é…ç½®ã€åŠŸèƒ½å’Œå­—ç¬¦ä¸²ç»„ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. A gadget has its config group, which has some attributes (idVendor, idProduct etc)</span><br><span class="line"> and default sub-groups (configs, functions, strings). Writing to the attributes</span><br><span class="line"> causes the information to be stored in appropriate locations. In the configs,</span><br><span class="line"> functions and strings sub-groups a user can create their sub-groups to represent</span><br><span class="line"> configurations, functions, and groups of strings in a given language.</span><br></pre></td></tr></table></figure><ol start="2"><li>ç”¨æˆ·åˆ›å»ºé…ç½®å’ŒåŠŸèƒ½ï¼Œåœ¨é…ç½®ä¸­åˆ›å»ºæŒ‡å‘åŠŸèƒ½çš„ç¬¦å·é“¾æ¥ã€‚å½“ Gadget çš„ UDC å±æ€§è¢«å†™å…¥æ—¶ï¼Œè¿™äº›ä¿¡æ¯å°†è¢«ä½¿ç”¨ï¼Œè¿™æ„å‘³ç€å°† Gadget ç»‘å®šåˆ° UDCã€‚drivers&#x2F;usb&#x2F;gadget&#x2F;configfs.c ä¸­çš„ä»£ç éå†æ‰€æœ‰é…ç½®ï¼Œåœ¨æ¯ä¸ªé…ç½®ä¸­éå†æ‰€æœ‰åŠŸèƒ½å¹¶ç»‘å®šå®ƒä»¬ã€‚è¿™æ ·æ•´ä¸ª Gadget å°±è¢«ç»‘å®šäº†ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2. The user creates configurations and functions, in the configurations creates</span><br><span class="line">symbolic links to functions. This information is used when the gadget&#x27;s UDC</span><br><span class="line">attribute is written to, which means binding the gadget to the UDC. The code in</span><br><span class="line">drivers/usb/gadget/configfs.c iterates over all configurations, and in each</span><br><span class="line">configuration it iterates over all functions and binds them.</span><br><span class="line">This way the whole gadget is bound.</span><br></pre></td></tr></table></figure><ol start="3"><li>drivers&#x2F;usb&#x2F;gadget&#x2F;configfs.c æ–‡ä»¶åŒ…å«ä»¥ä¸‹ä»£ç ï¼š</li></ol><ul><li>Gadget çš„ config_group</li><li>Gadget çš„é»˜è®¤ç»„ï¼ˆconfigsã€functionsã€stringsï¼‰</li><li>å°†åŠŸèƒ½ä¸é…ç½®å…³è”ï¼ˆç¬¦å·é“¾æ¥ï¼‰</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3. The file drivers/usb/gadget/configfs.c contains code for</span><br><span class="line"></span><br><span class="line">- gadget&#x27;s config_group</span><br><span class="line">- gadget&#x27;s default groups (configs, functions, strings)</span><br><span class="line">- associating functions with configurations (symlinks)</span><br></pre></td></tr></table></figure><ol start="4"><li>æ¯ä¸ª USB åŠŸèƒ½è‡ªç„¶æœ‰å…¶å¸Œæœ›é…ç½®çš„è§†å›¾ï¼Œå› æ­¤åœ¨ functions å®ç°æ–‡ä»¶ drivers&#x2F;usb&#x2F;gadget&#x2F;f_*.c ä¸­å®šä¹‰äº†ç‰¹å®šåŠŸèƒ½çš„ config_groupsã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4. Each USB function naturally has its own view of what it wants configured,</span><br><span class="line">so config_groups for particular functions are defined in the functions</span><br><span class="line">implementation files drivers/usb/gadget/f_*.c.</span><br></pre></td></tr></table></figure><ol start="5"><li>åŠŸèƒ½ä»£ç çš„ç¼–å†™æ–¹å¼æ˜¯ä½¿ç”¨ usb_get_function_instance()ï¼Œè¯¥å‡½æ•°åè¿‡æ¥è°ƒç”¨ request_moduleã€‚å› æ­¤ï¼Œåªè¦ modprobe å·¥ä½œï¼Œç‰¹å®šåŠŸèƒ½çš„æ¨¡å—å°±ä¼šè‡ªåŠ¨åŠ è½½ã€‚è¯·æ³¨æ„ï¼Œåä¹‹åˆ™ä¸ç„¶ï¼šåœ¨ Gadget è¢«ç¦ç”¨å’Œæ‹†é™¤åï¼Œæ¨¡å—ä»ç„¶ä¿æŒåŠ è½½çŠ¶æ€ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5. Function&#x27;s code is written in such a way that it uses usb_get_function_instance(),</span><br><span class="line">which, in turn, calls request_module. So, provided that modprobe works,</span><br><span class="line">modules for particular functions are loaded automatically. Please note that</span><br><span class="line">the converse is not true: after a gadget is disabled and torn down,</span><br><span class="line">the modules remain loaded.</span><br></pre></td></tr></table></figure><h2 id="useful-links"><a href="#useful-links" class="headerlink" title="useful links"></a>useful links</h2><p>ä¸€äº›å¼€æºä»“åº“åŸºäºä¸Šé¢ä»‹ç»çš„ usb configfsï¼ŒUSB Gadget API ç­‰ï¼Œæäº†äº› cool things.</p><blockquote><p>copy from <a href="https://www.reddit.com/r/linux/comments/1annx0u/a_comprehensive_list_of_all_configfs_functionfs/?rdt=34774">https://www.reddit.com/r/linux/comments/1annx0u/a_comprehensive_list_of_all_configfs_functionfs/?rdt=34774</a></p><p><strong>A comprehensive list of all ConfigFS, FunctionFS, USB Gadget API, etc. tools and libraries on Github(*)</strong></p><p>Ok, so Iâ€™m writing a comprehensive list for all libraries, tools, modules, and scripts for any linux distro or kernel that I can find on Github, so I can learn more about how to make use of it.</p><h3 id="What-is-this"><a href="#What-is-this" class="headerlink" title="What is this?"></a>What is this?</h3><p>For those who donâ€™t know what any of the above APIs are, they are the underlying APIs that power things like the MTP protocol that is associated with your mobile electronics, such as smartphone and digital cameras. The Media Transfer Protocol (MTP) is the protocol that allows host devices to <em>pretend</em> to be peripheral storage devices to other hosts. This is what makes it possible for your cell phone or digital camera to show up as a storage device on your PC, even though they are technically small computers.</p><p>You can read more about these APIs from the kernel docs:</p><ul><li><a href="https://docs.kernel.org/driver-api/usb/gadget.html?highlight=gadgetfs">USB Gadget API for Linux â€” The Linux Kernel documentation</a></li></ul><h3 id="Why-is-this-cool"><a href="#Why-is-this-cool" class="headerlink" title="Why is this cool?"></a>Why is this cool?</h3><p>The really cool thing about these kernel APIs is that they can work at the USB protocol layer. Which means <em>any</em> USB device can be emulated by a linux machine any way you want. You are not limited to just the MTP protocol.</p><p>The reason I am exploring these tools is that I want to see exactly what kind of things I can do with this API. Something that has interested me about this API since I came across it was whether or not it could support hosting a <em>bootable</em> mass storage device. This could allow me to do something like providing Ventoy (or Medicat) over the Gadget API. I was thinking that I could build some kind of stack with this that would allow me to install an operating system dynamically on the host using live ISO, then once the OS has been installed provision it via Ansible over RNDIS without ever having to reboot the device doing the install. Basically, it would provide a method for a fully unattended bare metal install that could fit in your pocket.</p><h3 id="Whatâ€™s-this-about-kernels-plural"><a href="#Whatâ€™s-this-about-kernels-plural" class="headerlink" title="Whatâ€™s this about kernels (plural)?"></a>Whatâ€™s this about kernels (plural)?</h3><p>Note that earlier, in the first paragraph, I said any linux distro as well as any <em>kernel.</em> Since implementations of this API typically require USB OTG or USB Dual Role hardware, the kernel that is likely to have the most stable tools&#x2F;libraries is going to be the Android kernel. This is something to keep in mind when discussing these APIs.</p><h3 id="TL-DR-The-list"><a href="#TL-DR-The-list" class="headerlink" title="(TL;DR) The list"></a>(TL;DR) The list</h3><p>(*) - Most of these libraries are on Github, but it is worth-while to at least point out the Android Code Search</p><ul><li>(*) <a href="https://cs.android.com/">Android Code Search</a></li><li><a href="https://github.com/linux-usb-gadgets">linux-usb-gadgets</a> organization<ul><li>âœ¨âœ¨âœ¨ <a href="https://github.com/linux-usb-gadgets/libusbgx">libusbgx</a><ul><li>Seemingly really well rounded C library for linux for encapsulating the ConfigFS API. It also includes some bash tools for automatically creating and monitoring USB Gadgets</li></ul></li><li><a href="https://github.com/linux-usb-gadgets/gt">gt (Gadget-tool)</a><ul><li>A command line tool for setting USB gadgets with ConfigFS</li></ul></li><li><a href="https://github.com/linux-usb-gadgets/ptp-gadget">ptp-gadget</a><ul><li>An implementation of the PTP protocol (the predecessor for MTP) for Linux</li></ul></li><li>(old org&#x2F;repo) <a href="https://github.com/libusbg/libusbg">libusbg&#x2F;libusbg</a><ul><li>the original version of libusbg</li></ul></li></ul></li><li><a href="https://github.com/litui/gadgeteer">litui&#x2F;gadgeteer</a><ul><li>A JSON daemon for controlling ConfigFS</li></ul></li><li><a href="https://github.com/luka177/mmc-to-usb">luka177&#x2F;mmc-to-usb</a><ul><li>Allows you to control an emmc storage device from another PC, including allowing you to partition it.</li></ul></li><li><a href="https://github.com/tylerwhall/configfs-regulator">tylerwhall&#x2F;configfs-regulator</a><ul><li>A ConfigFS-based Voltage Regulator Driver</li></ul></li><li><a href="https://github.com/kopasiak/simple_usb_chat">kopasiak&#x2F;simple_usb_chat</a><ul><li>A simple chat program over FunctionFS</li></ul></li><li><a href="https://github.com/jghubert/FunctionFSTester">jghubert&#x2F;FunctionFSTester</a><ul><li>A repository for testing FunctionFS features on both the remote host and peripheral device. Have been ignoring most of these kinds of repos, but added this one, since it included tests to be run on the remote host.</li></ul></li><li><a href="https://github.com/vladrobot/Raspberry-GadgetFS/tree/master">vladrobot&#x2F;Raspberry-GadgetFS</a><ul><li>A wrapper for GadgetFS tailored to the raspberry pi that provides HID spoofing as well as USB mass storage via Python</li></ul></li><li>PTP&#x2F;MTP protocol<ul><li>linux-usb-gadgets&#x2F;ptp-gadget (see above)</li><li>âœ¨âœ¨ <a href="https://github.com/viveris/uMTP-Responder">viveris&#x2F;uMTP-Responder</a><ul><li>An implementation of a MTP responder for Linux. README has a decent list of Single Board Computers with OTG&#x2F;Dual Role USB ports</li></ul></li></ul></li><li><em>Controller Emulators&#x2F;Adapters</em><ul><li><a href="https://github.com/Poohl/gadfetfs-Switch-Fightstick">Poohl&#x2F;gadfetfs-Switch-Fightstick</a><ul><li>Wii Remote Emulator&#x2F;Adapter for the Nintendo Switch</li></ul></li><li><a href="https://github.com/dogtopus/ffsds4">dogtopus&#x2F;ffsds4</a><ul><li>A PS4 Controller Emulator over FunctionFS</li></ul></li><li><a href="https://github.com/Frederic98/GadgetDeck">Frederic98&#x2F;GadgetDeck</a><ul><li>A controller emulator using a steam deck as a gadget device over ConfigFS</li></ul></li></ul></li><li><em>Android USB Tools</em><ul><li><a href="https://github.com/tejado/android-usb-gadget">tejado&#x2F;android-usb-gadget</a><ul><li>Rooted Android tool used to spoof what your phone appears as to your computer. Really good tool for visually showing you what the ConfigFS&#x2F;FunctionFS is capable of.</li></ul></li><li><a href="https://github.com/tejado/Authorizer">tejado&#x2F;Authorizer</a><ul><li>Secure Password Store that can autotype passwords over FunctionFS</li></ul></li></ul></li><li><em>Hacking, Sniffing, and Security:</em><ul><li><a href="https://github.com/threadexio/anducky">threadexio&#x2F;anducky</a><ul><li>An implementation of Hak5â€™s Rubber Ducky on Android</li></ul></li><li><a href="https://github.com/ehabhussein/AutoGadgetFS">ehabhussein&#x2F;AutoGadgetFS</a><ul><li>Very comprehensive USB security, sniffing, and analyzing tool that can be used to perform USB man-in-the-middle attacks built on ConfigFS</li></ul></li><li><a href="https://github.com/greatscottgadgets/Facedancer">greatscottgadgets&#x2F;Facedancer</a><ul><li>Another USB man-in-the-middle-ware built on GadgetFS</li><li><a href="https://github.com/usb-tools/USBProxy-legacy">usb-tools&#x2F;USBProxy-legacy</a> (The original)</li></ul></li><li><a href="https://github.com/Iskuri/Usb-Over-TCP">Iskuri&#x2F;Usb-Over-TCP</a><ul><li>A USB over TCP implementation built on GadgetFS</li></ul></li></ul></li><li><em>Simple HID Spoofing Scripts:</em><ul><li><a href="https://github.com/linkjumper/configfs">linkjumper&#x2F;configfs</a><ul><li>A simple shell script for creating a HID device via ConfigFS</li></ul></li><li><a href="https://github.com/qlyoung/keyboard-gadget">qlyoung&#x2F;keyboard-gadget</a><ul><li>Another simple shell script for creating a HID device via ConfigFS</li></ul></li><li><a href="https://github.com/karacanil/linux-mouse-gadget">karacanil&#x2F;linux-mouse-gadget</a><ul><li>A small mouse spoofer</li></ul></li></ul></li><li><em>Non-HID Spoofing Tools:</em><ul><li><a href="https://github.com/oandrew/ipod-gadget">oandrew&#x2F;ipod-gadget</a><ul><li>A tool to spoof your raspberry pi or beaglebone black as an iPod for streaming audio and use with iPod accessories.</li></ul></li><li><a href="https://github.com/du33169/usb-gadget-utils">du33169&#x2F;usb-gadget-utils</a><ul><li>A small, but comprehensive HID spoofing kit. Includes a toolkit for extracting and parsing HID data from real hardware for use with ConfigFS.</li></ul></li></ul></li><li><em>ConfigFS Device Tree Overlay Patches (not yet part of the linux kernel):</em><ul><li><a href="https://github.com/ikwzm/dtbocfg">ikwzm&#x2F;dtbocfg</a><ul><li>A custom implementation of a â€œConfigFS overlay interface.â€ This is not part of the Linux Kernel, but independently developed â€œpatchâ€</li></ul></li><li><a href="https://github.com/Xilinx/linux-xlnx">Xilinx&#x2F;linux-xlnx</a><ul><li>A similar solution, but as an actually patched kernel</li></ul></li><li><a href="https://github.com/digitalloggers/linux-custom-gpio-patches">digitalloggers&#x2F;linux-custom-gpio-patches</a><ul><li>A ConfigFS Device Tree Overlay patch specifically tailored to Raspberry Pi GPIO headers</li></ul></li></ul></li><li>âœ¨âœ¨ <em>Programming Libraries for ConfigFS&#x2F;FunctionFS:</em><ul><li>libusbg&#x2F;libusbgx (see above)<ul><li>ConfigFS for C</li></ul></li><li><a href="https://github.com/ueno/libusb-gadget">ueno&#x2F;libusb-gadget</a><ul><li>GadgetFS for C</li></ul></li><li><a href="https://github.com/xstevens/usbg.rs">xstevens&#x2F;usbg.rs</a><ul><li>ConfigFS for Rust</li></ul></li><li><a href="https://github.com/R030t1/linux-usb-functionfs-sys">R030t1&#x2F;linux-usb-functionfs-sys</a><ul><li>Crude FunctionFS for Rust</li></ul></li><li><a href="https://github.com/AlinaNova21/node-gadget">AlinaNova21&#x2F;node-gadget</a><ul><li>ConfigFS for Node.JS</li></ul></li><li><a href="https://github.com/mgalka/pygadget">mgalka&#x2F;pygadget</a><ul><li>ConfigFS for Python</li></ul></li><li><a href="https://github.com/vpelletier/python-functionfs">vpelletier&#x2F;python-functionfs</a><ul><li>FunctionFS for Python</li></ul></li><li><a href="https://github.com/google/go-configfs-tsm">google&#x2F;go-configfs-tsm</a><ul><li>ConfigFS (and other things) for Go - NOTE that this one is written by Google</li></ul></li></ul></li></ul><p>This list is mostly all inclusive:</p><ul><li>It contains the majority of repositories with noteworthy ConfigFS&#x2F;FunctionFS features.</li><li>Most of the ignored repositories were ones that either:<ul><li>had little documentation&#x2F;were definitively unmaintained</li><li>were just some playground or test repos for learning&#x2F;future development</li></ul></li></ul></blockquote><h2 id="gadget-configfs-æºç åˆ†æ"><a href="#gadget-configfs-æºç åˆ†æ" class="headerlink" title="gadget configfs æºç åˆ†æ"></a>gadget configfs æºç åˆ†æ</h2><blockquote><p><a href="https://elixir.bootlin.com/linux/v5.10.186/source/drivers/usb/gadget/configfs.c">https://elixir.bootlin.com/linux/v5.10.186/source/drivers/usb/gadget/configfs.c</a><br><a href="Linux-configfs#%E7%A4%BA%E4%BE%8B">Linux-configfs#ç¤ºä¾‹)</a></p></blockquote><h3 id="é¡¶å±‚-subsystem"><a href="#é¡¶å±‚-subsystem" class="headerlink" title="é¡¶å±‚ subsystem"></a>é¡¶å±‚ subsystem</h3><p>åˆå§‹åŒ–çš„æ—¶å€™æ³¨å†Œäº†ä¸€ä¸ªåä¸º <code>usb_gadget</code> çš„ subsystemã€‚æ‰€ä»¥ï¼Œinsmod è¯¥æ¨¡å—ä¹‹åï¼Œä¼šå¾—åˆ° <code>/configfs/usb_gadget</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">gadget_subsys</span> =</span> &#123;</span><br><span class="line">.su_group = &#123;</span><br><span class="line">.cg_item = &#123;</span><br><span class="line">.ci_namebuf = <span class="string">&quot;usb_gadget&quot;</span>,</span><br><span class="line">.ci_type = &amp;gadgets_type,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">.su_mutex = __MUTEX_INITIALIZER(gadget_subsys.su_mutex),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">gadget_cfs_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">config_group_init(&amp;gadget_subsys.su_group);</span><br><span class="line"></span><br><span class="line">ret = configfs_register_subsystem(&amp;gadget_subsys);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">module_init(gadget_cfs_init);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">gadget_cfs_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">configfs_unregister_subsystem(&amp;gadget_subsys);</span><br><span class="line">&#125;</span><br><span class="line">module_exit(gadget_cfs_exit);</span><br></pre></td></tr></table></figure><p>è¯¥ <code>gadgets_type</code> ä¸­æ²¡æœ‰ <code>.ct_attrs</code>ï¼Œæ‰€ä»¥æ²¡æœ‰ä»»ä½•å±æ€§ï¼Œå³ <code>/configfs/usb_gadget</code> ç›®å½•ä¸ºç©ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">gadgets_type</span> =</span> &#123;</span><br><span class="line">.ct_group_ops   = &amp;gadgets_ops,</span><br><span class="line">.ct_owner       = THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>gadgets_ops</code> æŒ‡å®šäº† <code>.make_group</code>ï¼Œæ‰€ä»¥ <code>mkdir</code> ä¼šåˆ›å»ºå­é¡¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static struct configfs_group_operations gadgets_ops = &#123;</span><br><span class="line">.make_group     = &amp;gadgets_make,</span><br><span class="line">.drop_item      = &amp;gadgets_drop,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ <code>mkdir cvitek</code> ä¼šåˆ›å»º <code>/configfs/usb_gadget/cvitek</code>ï¼Œå¹¶åŒæ—¶ä¸º cvitek è‡ªåŠ¨åˆ›å»º <code>functions</code>, <code>configs</code>, <code>strings</code> å’Œ <code>os_desc</code> 4 ä¸ªå­é¡¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> config_group *<span class="title function_">gadgets_make</span><span class="params">(</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> config_group *group,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">gadget_info</span> *<span class="title">gi</span>;</span></span><br><span class="line"></span><br><span class="line">gi = kzalloc(<span class="keyword">sizeof</span>(*gi), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!gi)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª `/configfs/usb_gadget/cvitek`</span></span><br><span class="line">config_group_init_type_name(&amp;gi-&gt;group, name, &amp;gadget_root_type);</span><br><span class="line"></span><br><span class="line">config_group_init_type_name(&amp;gi-&gt;functions_group, <span class="string">&quot;functions&quot;</span>,</span><br><span class="line">&amp;functions_type);</span><br><span class="line">configfs_add_default_group(&amp;gi-&gt;functions_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">config_group_init_type_name(&amp;gi-&gt;configs_group, <span class="string">&quot;configs&quot;</span>,</span><br><span class="line">&amp;config_desc_type);</span><br><span class="line">configfs_add_default_group(&amp;gi-&gt;configs_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">config_group_init_type_name(&amp;gi-&gt;strings_group, <span class="string">&quot;strings&quot;</span>,</span><br><span class="line">&amp;gadget_strings_strings_type);</span><br><span class="line">configfs_add_default_group(&amp;gi-&gt;strings_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">config_group_init_type_name(&amp;gi-&gt;os_desc_group, <span class="string">&quot;os_desc&quot;</span>,</span><br><span class="line">&amp;os_desc_type);</span><br><span class="line">configfs_add_default_group(&amp;gi-&gt;os_desc_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">gi-&gt;composite.bind = configfs_do_nothing;</span><br><span class="line">gi-&gt;composite.unbind = configfs_do_nothing;</span><br><span class="line">gi-&gt;composite.suspend = <span class="literal">NULL</span>;</span><br><span class="line">gi-&gt;composite.resume = <span class="literal">NULL</span>;</span><br><span class="line">gi-&gt;composite.max_speed = USB_SPEED_SUPER;</span><br><span class="line"></span><br><span class="line">spin_lock_init(&amp;gi-&gt;spinlock);</span><br><span class="line">mutex_init(&amp;gi-&gt;lock);</span><br><span class="line">INIT_LIST_HEAD(&amp;gi-&gt;string_list);</span><br><span class="line">INIT_LIST_HEAD(&amp;gi-&gt;available_func);</span><br><span class="line"></span><br><span class="line">composite_init_dev(&amp;gi-&gt;cdev);</span><br><span class="line">gi-&gt;cdev.desc.bLength = USB_DT_DEVICE_SIZE;</span><br><span class="line">gi-&gt;cdev.desc.bDescriptorType = USB_DT_DEVICE;</span><br><span class="line">gi-&gt;cdev.desc.bcdDevice = cpu_to_le16(get_default_bcdDevice());</span><br><span class="line"></span><br><span class="line">gi-&gt;composite.gadget_driver = configfs_driver_template;</span><br><span class="line"></span><br><span class="line">gi-&gt;composite.gadget_driver.function = kstrdup(name, GFP_KERNEL);</span><br><span class="line">gi-&gt;composite.name = gi-&gt;composite.gadget_driver.function;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!gi-&gt;composite.gadget_driver.function)</span><br><span class="line"><span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;gi-&gt;group;</span><br><span class="line">err:</span><br><span class="line">kfree(gi);</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="gadget-root-type"><a href="#gadget-root-type" class="headerlink" title="gadget_root_type"></a>gadget_root_type</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">gadget_root_type</span> =</span> &#123;</span><br><span class="line">.ct_item_ops= &amp;gadget_root_item_ops,</span><br><span class="line">.ct_attrs= gadget_root_attrs,</span><br><span class="line">.ct_owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">gadget_root_item_ops</span> =</span> &#123;</span><br><span class="line">.release                = gadget_info_attr_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰å®šä¹‰ <code>.make_item/.make_group</code>ï¼Œæ‰€ä»¥æ— æ³•åœ¨ <code>/configfs/usb_gadget/cvitek</code> ç›®å½•ä¸­é€šè¿‡ <code>mkdir</code> åˆ›å»ºå­é¡¹ã€‚</p><p>å®ƒæœ‰ 10 ä¸ªå¯è¯»å†™çš„å±æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bDeviceClass);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bDeviceSubClass);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bDeviceProtocol);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bMaxPacketSize0);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, idVendor);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, idProduct);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bcdDevice);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bcdUSB);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, UDC);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, max_speed);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">gadget_root_attrs</span>[] =</span> &#123;</span><br><span class="line">&amp;gadget_dev_desc_attr_bDeviceClass,</span><br><span class="line">&amp;gadget_dev_desc_attr_bDeviceSubClass,</span><br><span class="line">&amp;gadget_dev_desc_attr_bDeviceProtocol,</span><br><span class="line">&amp;gadget_dev_desc_attr_bMaxPacketSize0,</span><br><span class="line">&amp;gadget_dev_desc_attr_idVendor,</span><br><span class="line">&amp;gadget_dev_desc_attr_idProduct,</span><br><span class="line">&amp;gadget_dev_desc_attr_bcdDevice,</span><br><span class="line">&amp;gadget_dev_desc_attr_bcdUSB,</span><br><span class="line">&amp;gadget_dev_desc_attr_UDC,</span><br><span class="line">&amp;gadget_dev_desc_attr_max_speed,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="functions-type"><a href="#functions-type" class="headerlink" title="functions_type"></a>functions_type</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">functions_type</span> =</span> &#123;</span><br><span class="line">.ct_group_ops   = &amp;functions_ops,</span><br><span class="line">.ct_owner       = THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">functions_ops</span> =</span> &#123;</span><br><span class="line">.make_group     = &amp;function_make,</span><br><span class="line">.drop_item      = &amp;function_drop,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ’¥ğŸ’¥ğŸ’¥ğŸ’¥åœ¨ configfs ä¸­ï¼Œæœ‰é¡¹ç›®itemå’Œç»„groupï¼Œå‡è¡¨ç¤ºä¸ºç›®å½•ã€‚é¡¹ç›®å’Œç»„çš„åŒºåˆ«åœ¨äºç»„å¯ä»¥åŒ…å«å…¶ä»–ç»„ğŸ’¥ğŸ’¥ğŸ’¥</p></blockquote><p>æ²¡æœ‰å±æ€§ï¼Œæ‰€ä»¥ä¸€å¼€å§‹ <code>/configfs/usb_gadget/cvitek/functions</code> ç›®å½•ä¸ºç©ºã€‚ä½†å®šä¹‰äº† <code>make_group</code>ï¼Œæ‰€ä»¥å¯ä»¥åˆ›å»ºç»„ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="Linux-configfs.md">Linux-configfs.md</a></li><li><a href="Linux-USBmtp.md">Linux-USBmtp.md</a></li><li><a href="https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing">https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing</a></li><li><a href="https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing/configfs-usb-gadget">https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing/configfs-usb-gadget</a></li><li><a href="http://www.spinics.net/lists/linux-usb/msg76388.html">http://www.spinics.net/lists/linux-usb/msg76388.html</a></li><li><a href="https://www.kernel.org/doc/html/v6.1/usb/gadget-testing.html">https://www.kernel.org/doc/html/v6.1/usb/gadget-testing.html</a></li><li><a href="https://www.kernel.org/doc/html/v6.1/usb/raw-gadget.html">https://www.kernel.org/doc/html/v6.1/usb/raw-gadget.html</a></li><li><a href="https://www.kernel.org/doc/html/v6.1/usb/functionfs.html">https://www.kernel.org/doc/html/v6.1/usb/functionfs.html</a></li><li><a href="https://wowothink.com/6a85234b/">usb gadget configfs åŸç†</a></li><li><a href="https://wowothink.com/a64c6a27/">usb gadget configfs éªŒè¯</a></li><li><a href="https://wowothink.com/440dc3d9/">usb gadget configfs ç¿»è¯‘</a></li><li><a href="https://wowothink.com/ffcaead/">Android usb gadgetç±»å‹</a></li><li><a href="https://wowothink.com/588ebc22/">ACM&amp;ECM&amp;NCM&amp;EEM&amp;RNDIS&amp;RmNetä»‹ç»</a></li><li><a href="https://wowothink.com/488cc6d0/">Linux USB Test Mode</a></li><li><a href="https://wowothink.com/69b1c932/">USB2.0ç†è®ºä¼ è¾“é€Ÿåº¦å’Œå®é™…ä¼ è¾“é€Ÿåº¦</a></li><li><a href="https://wowothink.com/68203a0/">Linuxé©±åŠ¨ä¸­é…ç½®æ”¯æŒç‰¹å®šUSB HUB</a></li><li><a href="https://wowothink.com/892013c5/">é…ç½®USB Hostå’ŒUSB Device full-speedå·¥ä½œ</a></li><li><a href="https://wowothink.com/e0007988/">Linuxæµ‹è¯•Uç›˜è¯»å†™é€Ÿåº¦</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> USB </tag>
            
            <tag> configfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux configfs</title>
      <link href="/2024/09/22/Linux-configfs/"/>
      <url>/2024/09/22/Linux-configfs/</url>
      
        <content type="html"><![CDATA[<blockquote><p>translate from <a href="https://www.kernel.org/doc/Documentation/filesystems/configfs/configfs.txt">https://www.kernel.org/doc/Documentation/filesystems/configfs/configfs.txt</a></p></blockquote><hr><h2 id="configfs-ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„å†…æ ¸å¯¹è±¡é…ç½®"><a href="#configfs-ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„å†…æ ¸å¯¹è±¡é…ç½®" class="headerlink" title="configfs - ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„å†…æ ¸å¯¹è±¡é…ç½®"></a>configfs - ç”¨æˆ·ç©ºé—´é©±åŠ¨çš„å†…æ ¸å¯¹è±¡é…ç½®</h2><p>ä¹”å°”Â·è´å…‹å°” <a href="mailto:&#x6a;&#x6f;&#x65;&#108;&#x2e;&#x62;&#x65;&#x63;&#x6b;&#101;&#114;&#64;&#x6f;&#114;&#x61;&#x63;&#108;&#101;&#x2e;&#x63;&#111;&#109;">&#x6a;&#x6f;&#x65;&#108;&#x2e;&#x62;&#x65;&#x63;&#x6b;&#101;&#114;&#64;&#x6f;&#114;&#x61;&#x63;&#108;&#101;&#x2e;&#x63;&#111;&#109;</a></p><p>æ›´æ–°æ—¥æœŸï¼š2005å¹´3æœˆ31æ—¥</p><p>ç‰ˆæƒæ‰€æœ‰ (c) 2005 Oracle Corporation,<br>ä¹”å°”Â·è´å…‹å°” <a href="mailto:&#x6a;&#x6f;&#x65;&#x6c;&#46;&#x62;&#x65;&#x63;&#107;&#x65;&#114;&#x40;&#111;&#x72;&#x61;&#99;&#108;&#101;&#x2e;&#99;&#x6f;&#x6d;">&#x6a;&#x6f;&#x65;&#x6c;&#46;&#x62;&#x65;&#x63;&#107;&#x65;&#114;&#x40;&#111;&#x72;&#x61;&#99;&#108;&#101;&#x2e;&#99;&#x6f;&#x6d;</a></p><hr><h2 id="ä»€ä¹ˆæ˜¯-configfsï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯-configfsï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯ configfsï¼Ÿ"></a>ä»€ä¹ˆæ˜¯ configfsï¼Ÿ</h2><p><code>configfs</code> æ˜¯åŸºäºå†…å­˜çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå®ƒæä¾›ä¸ <code>sysfs</code> ç›¸åçš„åŠŸèƒ½ã€‚<code>sysfs</code> æä¾›çš„æ˜¯å†…æ ¸å¯¹è±¡çš„æ–‡ä»¶ç³»ç»Ÿè§†å›¾ï¼Œè€Œ <code>configfs</code> åˆ™æ˜¯å†…æ ¸å¯¹è±¡æˆ– <code>config_items</code> çš„æ–‡ä»¶ç³»ç»Ÿç®¡ç†å™¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">configfs is a ram-based filesystem that provides the converse of</span><br><span class="line">sysfs&#x27;s functionality. Where sysfs is a filesystem-based view of</span><br><span class="line">kernel objects, configfs is a filesystem-based manager of kernel</span><br><span class="line">objects, or config_items.</span><br></pre></td></tr></table></figure><blockquote><p><strong>view VS manager</strong> çš„åŒºåˆ«ã€‚</p></blockquote><p>åœ¨ <code>sysfs</code> ä¸­ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åœ¨å†…æ ¸ä¸­åˆ›å»ºæ—¶ï¼ˆä¾‹å¦‚ï¼Œå‘ç°ä¸€ä¸ªè®¾å¤‡ï¼‰ï¼Œå®ƒä¼šè¢«æ³¨å†Œåˆ° <code>sysfs</code> ä¸­ã€‚å®ƒçš„å±æ€§ä¼šå‡ºç°åœ¨ <code>sysfs</code> ä¸­ï¼Œå…è®¸ç”¨æˆ·ç©ºé—´é€šè¿‡ <code>readdir(3)</code>&#x2F;<code>read(2)</code> è¯»å–è¿™äº›å±æ€§ã€‚æŸäº›å±æ€§ä¹Ÿè®¸å¯ä»¥é€šè¿‡ <code>write(2)</code> è¿›è¡Œä¿®æ”¹ã€‚é‡è¦çš„æ˜¯ï¼Œå†…æ ¸æ§åˆ¶ç€è¿™äº›å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œ<code>sysfs</code> ä»…ä»…æ˜¯è¿™äº›æ“ä½œçš„ä¸€ä¸ªçª—å£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">With sysfs, an object is created in kernel (for example, when a device</span><br><span class="line">is discovered) and it is registered with sysfs. Its attributes then</span><br><span class="line">appear in sysfs, allowing userspace to read the attributes via</span><br><span class="line">readdir(3)/read(2). It may allow some attributes to be modified via</span><br><span class="line">write(2). The important point is that the object is created and</span><br><span class="line">destroyed in kernel, the kernel controls the lifecycle of the sysfs</span><br><span class="line">representation, and sysfs is merely a window on all this.</span><br></pre></td></tr></table></figure><p>è€Œ <code>configfs</code> çš„ <code>config_item</code> æ˜¯é€šè¿‡ç”¨æˆ·ç©ºé—´çš„æ˜¾å¼æ“ä½œåˆ›å»ºçš„ï¼šä½¿ç”¨ <code>mkdir(2)</code>ã€‚å®ƒé€šè¿‡ <code>rmdir(2)</code> åˆ é™¤ã€‚å±æ€§åœ¨ <code>mkdir(2)</code> æ“ä½œæ—¶å‡ºç°ï¼Œå¯ä»¥é€šè¿‡ <code>read(2)</code> å’Œ <code>write(2)</code> è¿›è¡Œè¯»å–å’Œä¿®æ”¹ã€‚ä¸ <code>sysfs</code> ç±»ä¼¼ï¼Œ<code>readdir(3)</code> å¯ä»¥æŸ¥è¯¢é¡¹ç›®å’Œ&#x2F;æˆ–å±æ€§çš„åˆ—è¡¨ï¼Œ<code>symlink(2)</code> å¯ä»¥ç”¨äºå°†é¡¹ç›®åˆ†ç»„ã€‚ä¸ <code>sysfs</code> ä¸åŒçš„æ˜¯ï¼Œè¡¨ç¤ºçš„<strong>ç”Ÿå‘½å‘¨æœŸå®Œå…¨ç”±ç”¨æˆ·ç©ºé—´æ§åˆ¶</strong>ï¼Œå†…æ ¸æ¨¡å—å¿…é¡»å¯¹æ­¤ä½œå‡ºå“åº”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A configfs config_item is created via an explicit userspace operation:</span><br><span class="line">mkdir(2). It is destroyed via rmdir(2). The attributes appear at</span><br><span class="line">mkdir(2) time, and can be read or modified via read(2) and write(2).</span><br><span class="line">As with sysfs, readdir(3) queries the list of items and/or attributes.</span><br><span class="line">symlink(2) can be used to group items together. Unlike sysfs, the</span><br><span class="line">lifetime of the representation is completely driven by userspace. The</span><br><span class="line">kernel modules backing the items must respond to this.</span><br></pre></td></tr></table></figure><p><code>sysfs</code> å’Œ <code>configfs</code> å¯ä»¥å¹¶ä¸”åº”è¯¥å…±å­˜äºåŒä¸€ç³»ç»Ÿä¸Šï¼Œå®ƒä»¬äº’ä¸æ›¿ä»£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Both sysfs and configfs can and should exist together on the same</span><br><span class="line">system. One is not a replacement for the other.</span><br></pre></td></tr></table></figure><hr><h2 id="ä½¿ç”¨-configfs"><a href="#ä½¿ç”¨-configfs" class="headerlink" title="ä½¿ç”¨ configfs"></a>ä½¿ç”¨ configfs</h2><p><code>configfs</code> å¯ä»¥ä½œä¸ºæ¨¡å—ç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ç¼–è¯‘åˆ°å†…æ ¸ä¸­ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®å®ƒï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t configfs none /config</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">configfs can be compiled as a module or into the kernel. You can access</span><br><span class="line">it by doing</span><br><span class="line"></span><br><span class="line">mount -t configfs none /config</span><br></pre></td></tr></table></figure><p>é™¤éåŠ è½½äº†å®¢æˆ·ç«¯æ¨¡å—ï¼Œå¦åˆ™ <code>configfs</code> æ ‘æ˜¯ç©ºçš„ã€‚è¿™äº›æ¨¡å—ä¼šå°†å®ƒä»¬çš„é¡¹ç›®ç±»å‹æ³¨å†Œä¸º <code>configfs</code> çš„å­ç³»ç»Ÿã€‚ä¸€æ—¦å®¢æˆ·ç«¯å­ç³»ç»Ÿè¢«åŠ è½½ï¼Œå®ƒä¼šä½œä¸º <code>/config</code> ä¸‹çš„ä¸€ä¸ªï¼ˆæˆ–å¤šä¸ªï¼‰å­ç›®å½•å‡ºç°ã€‚å’Œ <code>sysfs</code> ä¸€æ ·ï¼Œ<code>configfs</code> æ ‘å§‹ç»ˆå­˜åœ¨ï¼Œæ— è®ºæ˜¯å¦æŒ‚è½½åˆ° <code>/config</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The configfs tree will be empty unless client modules are also loaded.</span><br><span class="line">These are modules that register their item types with configfs as</span><br><span class="line">subsystems. Once a client subsystem is loaded, it will appear as a</span><br><span class="line">subdirectory (or more than one) under /config. Like sysfs, the</span><br><span class="line">configfs tree is always there, whether mounted on /config or not.</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœæ‰“å¼€äº†æŸä¸ªå­æ¨¡å—çš„ configfs é…ç½®ï¼Œåœ¨ mount configfs ä¹‹åï¼Œå°±èƒ½åœ¨å¯¹åº”çš„ç›®å½•çœ‹åˆ°ã€‚æ¯”å¦‚ <code>CONFIG_USB_CONFIGFS=y</code> å¼€å¯ä¹‹åï¼Œ<code>/config/usb</code> å°±ä¼šå‡ºç°ã€‚</p></blockquote><p>ä¸€ä¸ªé¡¹ç›®å¯ä»¥é€šè¿‡ <code>mkdir(2)</code> åˆ›å»ºã€‚é¡¹ç›®çš„å±æ€§ä¹Ÿä¼šåœ¨æ­¤æ—¶å‡ºç°ã€‚å¯ä»¥é€šè¿‡ <code>readdir(3)</code> ç¡®å®šå±æ€§ï¼Œ<code>read(2)</code> æŸ¥è¯¢é»˜è®¤å€¼ï¼Œ<code>write(2)</code> å­˜å‚¨æ–°å€¼ã€‚ä¸è¦åœ¨ä¸€ä¸ªå±æ€§æ–‡ä»¶ä¸­æ··åˆå¤šä¸ªå±æ€§ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">An item is created via mkdir(2). The item&#x27;s attributes will also</span><br><span class="line">appear at this time. readdir(3) can determine what the attributes are,</span><br><span class="line">read(2) can query their default values, and write(2) can store new</span><br><span class="line">values. Don&#x27;t mix more than one attribute in one attribute file.</span><br></pre></td></tr></table></figure><blockquote><p>æ¯”å¦‚ï¼š<a href="./Linux-USBmtp.md#2-%E5%88%9B%E5%BB%BA%E5%A4%8D%E5%90%88%E8%AE%BE%E5%A4%87">Linux-USBmtp</a></p></blockquote><p><code>configfs</code> å±æ€§æœ‰ä¸¤ç§ç±»å‹ï¼š</p><ol><li>æ­£å¸¸å±æ€§ï¼Œä¸ <code>sysfs</code> å±æ€§ç±»ä¼¼ï¼Œæ˜¯å°å‹ ASCII æ–‡æœ¬æ–‡ä»¶ï¼Œæœ€å¤§å¤§å°ä¸ºä¸€é¡µï¼ˆ<code>PAGE_SIZE</code>ï¼Œåœ¨ i386 ä¸Šä¸º 4096 å­—èŠ‚ï¼‰ã€‚æ¯ä¸ªæ–‡ä»¶ä¸­æœ€å¥½åªåŒ…å«ä¸€ä¸ªå€¼ï¼Œå¹¶ä¸”éµå¾ª <code>sysfs</code> çš„ç›¸åŒæ³¨æ„äº‹é¡¹ã€‚<code>configfs</code> æœŸæœ› <code>write(2)</code> åœ¨ä¸€æ¬¡æ“ä½œä¸­å†™å…¥æ•´ä¸ªç¼“å†²åŒºã€‚å½“å†™å…¥æ­£å¸¸çš„ <code>configfs</code> å±æ€§æ—¶ï¼Œ<strong>ç”¨æˆ·ç©ºé—´è¿›ç¨‹åº”é¦–å…ˆè¯»å–æ•´ä¸ªæ–‡ä»¶ï¼Œä¿®æ”¹ä»–ä»¬æƒ³è¦æ›´æ”¹çš„éƒ¨åˆ†ï¼Œç„¶åå†™å›æ•´ä¸ªç¼“å†²åŒº</strong>ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">There are two types of configfs attributes:</span><br><span class="line"></span><br><span class="line">* Normal attributes, which similar to sysfs attributes, are small ASCII text</span><br><span class="line">files, with a maximum size of one page (PAGE_SIZE, 4096 on i386). Preferably</span><br><span class="line">only one value per file should be used, and the same caveats from sysfs apply.</span><br><span class="line">Configfs expects write(2) to store the entire buffer at once. When writing to</span><br><span class="line">normal configfs attributes, userspace processes should first read the entire</span><br><span class="line">file, modify the portions they wish to change, and then write the entire</span><br><span class="line">buffer back.</span><br></pre></td></tr></table></figure><ol start="2"><li>äºŒè¿›åˆ¶å±æ€§ï¼Œä¸ <code>sysfs</code> äºŒè¿›åˆ¶å±æ€§ç±»ä¼¼ï¼Œä½†è¯­ä¹‰ä¸Šæœ‰ä¸€äº›ç»†å¾®å˜åŒ–ã€‚<code>PAGE_SIZE</code> é™åˆ¶ä¸é€‚ç”¨ï¼Œä½†æ•´ä¸ªäºŒè¿›åˆ¶é¡¹å¿…é¡»é€‚åˆå•ä¸ªå†…æ ¸ <code>vmalloc</code> åˆ†é…çš„ç¼“å†²åŒºã€‚æ¥è‡ªç”¨æˆ·ç©ºé—´çš„ <code>write(2)</code> è°ƒç”¨æ˜¯ç¼“å†²çš„ï¼Œå±æ€§çš„ <code>write_bin_attribute</code> æ–¹æ³•å°†åœ¨æœ€ç»ˆå…³é—­æ—¶è¢«è°ƒç”¨ï¼Œå› æ­¤ç”¨æˆ·ç©ºé—´å¿…é¡»æ£€æŸ¥ <code>close(2)</code> çš„è¿”å›ç ä»¥éªŒè¯æ“ä½œæ˜¯å¦æˆåŠŸå®Œæˆã€‚ä¸ºäº†é˜²æ­¢æ¶æ„ç”¨æˆ·å¯¼è‡´å†…æ ¸å†…å­˜ä¸è¶³ï¼Œæ¯ä¸ªäºŒè¿›åˆ¶å±æ€§éƒ½æœ‰æœ€å¤§ç¼“å†²åŒºå¤§å°é™åˆ¶ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">* Binary attributes, which are somewhat similar to sysfs binary attributes,</span><br><span class="line">but with a few slight changes to semantics. The PAGE_SIZE limitation does not</span><br><span class="line">apply, but the whole binary item must fit in single kernel vmalloc&#x27;ed buffer.</span><br><span class="line">The write(2) calls from user space are buffered, and the attributes&#x27;</span><br><span class="line">write_bin_attribute method will be invoked on the final close, therefore it is</span><br><span class="line">imperative for user-space to check the return code of close(2) in order to</span><br><span class="line">verify that the operation finished successfully.</span><br><span class="line">To avoid a malicious user OOMing the kernel, there&#x27;s a per-binary attribute</span><br><span class="line">maximum buffer value.</span><br></pre></td></tr></table></figure><p>å½“éœ€è¦é”€æ¯ä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œä½¿ç”¨ <code>rmdir(2)</code> åˆ é™¤å®ƒã€‚å¦‚æœæœ‰å…¶ä»–é¡¹ç›®é€šè¿‡ <code>symlink(2)</code> é“¾æ¥åˆ°è¯¥é¡¹ç›®ï¼Œå®ƒæ˜¯ä¸èƒ½è¢«åˆ é™¤çš„ã€‚é“¾æ¥å¯ä»¥é€šè¿‡ <code>unlink(2)</code> åˆ é™¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">When an item needs to be destroyed, remove it with rmdir(2). An</span><br><span class="line">item cannot be destroyed if any other item has a link to it (via</span><br><span class="line">symlink(2)). Links can be removed via unlink(2).</span><br></pre></td></tr></table></figure><hr><h2 id="é…ç½®-FakeNBD-ä¸€ä¸ªä¾‹å­"><a href="#é…ç½®-FakeNBD-ä¸€ä¸ªä¾‹å­" class="headerlink" title="é…ç½® FakeNBD: ä¸€ä¸ªä¾‹å­"></a>é…ç½® FakeNBD: ä¸€ä¸ªä¾‹å­</h2><p>å‡è®¾æœ‰ä¸€ä¸ªç½‘ç»œå—è®¾å¤‡ï¼ˆNBDï¼‰é©±åŠ¨ç¨‹åºå…è®¸æ‚¨è®¿é—®è¿œç¨‹å—è®¾å¤‡ï¼Œç§°ä¹‹ä¸º FakeNBDã€‚FakeNBD ä½¿ç”¨ <code>configfs</code> è¿›è¡Œé…ç½®ã€‚æ˜¾ç„¶ï¼Œä¼šæœ‰ä¸€ä¸ªä¸“é—¨çš„ç¨‹åºä¾›ç³»ç»Ÿç®¡ç†å‘˜ä½¿ç”¨æ¥é…ç½® FakeNBDï¼Œä½†è¯¥ç¨‹åºå¿…é¡»é€šè¿‡æŸç§æ–¹å¼ä¸é©±åŠ¨ç¨‹åºé€šä¿¡ã€‚è¿™æ—¶ <code>configfs</code> å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[Configuring FakeNBD: an Example]</span><br><span class="line"></span><br><span class="line">Imagine there&#x27;s a Network Block Device (NBD) driver that allows you to</span><br><span class="line">access remote block devices. Call it FakeNBD. FakeNBD uses configfs</span><br><span class="line">for its configuration. Obviously, there will be a nice program that</span><br><span class="line">sysadmins use to configure FakeNBD, but somehow that program has to tell</span><br><span class="line">the driver about it. Here&#x27;s where configfs comes in.</span><br></pre></td></tr></table></figure><p>å½“åŠ è½½ FakeNBD é©±åŠ¨ç¨‹åºæ—¶ï¼Œå®ƒä¼šæ³¨å†Œåˆ° <code>configfs</code>ã€‚ä½¿ç”¨ <code>readdir(3)</code> å¯ä»¥çœ‹åˆ°è¿™ä¸€ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls /config</span></span><br><span class="line">fakenbd</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">When the FakeNBD driver is loaded, it registers itself with configfs.</span><br><span class="line">readdir(3) sees this just fine:</span><br><span class="line"></span><br><span class="line"># ls /config</span><br><span class="line">fakenbd</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ <code>mkdir(2)</code> åˆ›å»ºä¸€ä¸ª fakenbd è¿æ¥ã€‚åç§°æ˜¯ä»»æ„çš„ï¼Œä½†è¯¥å·¥å…·å¯èƒ½ä¼šä½¿ç”¨è¿™ä¸ªåç§°ã€‚ä¹Ÿè®¸å®ƒæ˜¯ä¸€ä¸ª <code>uuid</code> æˆ–ç£ç›˜åç§°ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mkdir /config/fakenbd/disk1</span></span><br><span class="line"><span class="comment"># ls /config/fakenbd/disk1</span></span><br><span class="line">target device rw</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A fakenbd connection can be created with mkdir(2). The name is</span><br><span class="line">arbitrary, but likely the tool will make some use of the name. Perhaps</span><br><span class="line">it is a uuid or a disk name:</span><br><span class="line"></span><br><span class="line"># mkdir /config/fakenbd/disk1</span><br><span class="line"># ls /config/fakenbd/disk1</span><br><span class="line">target device rw</span><br></pre></td></tr></table></figure><p><code>target</code> å±æ€§åŒ…å« FakeNBD å°†è¿æ¥çš„æœåŠ¡å™¨çš„ IP åœ°å€ã€‚<code>device</code> å±æ€§æ˜¯æœåŠ¡å™¨ä¸Šçš„è®¾å¤‡ã€‚æ˜¾ç„¶ï¼Œ<code>rw</code> å±æ€§å†³å®šäº†è¿æ¥æ˜¯åªè¯»è¿˜æ˜¯è¯»å†™ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 10.0.0.1 &gt; /config/fakenbd/disk1/target</span></span><br><span class="line"><span class="comment"># echo /dev/sda1 &gt; /config/fakenbd/disk1/device</span></span><br><span class="line"><span class="comment"># echo 1 &gt; /config/fakenbd/disk1/rw</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The target attribute contains the IP address of the server FakeNBD will</span><br><span class="line">connect to. The device attribute is the device on the server.</span><br><span class="line">Predictably, the rw attribute determines whether the connection is</span><br><span class="line">read-only or read-write.</span><br><span class="line"></span><br><span class="line"># echo 10.0.0.1 &gt; /config/fakenbd/disk1/target</span><br><span class="line"># echo /dev/sda1 &gt; /config/fakenbd/disk1/device</span><br><span class="line"># echo 1 &gt; /config/fakenbd/disk1/rw</span><br></pre></td></tr></table></figure><p>å°±æ˜¯è¿™æ ·ï¼Œä»…æ­¤è€Œå·²ã€‚ç°åœ¨ï¼Œè®¾å¤‡å·²é…ç½®å¥½ï¼Œå¹¶é€šè¿‡ shell å®Œæˆã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">That&#x27;s it. That&#x27;s all there is. Now the device is configured, via the</span><br><span class="line">shell no less.</span><br></pre></td></tr></table></figure><hr><h2 id="ä½¿ç”¨-configfs-ç¼–ç "><a href="#ä½¿ç”¨-configfs-ç¼–ç " class="headerlink" title="ä½¿ç”¨ configfs ç¼–ç "></a>ä½¿ç”¨ configfs ç¼–ç </h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Coding With configfs]</span><br></pre></td></tr></table></figure><p>åœ¨ <code>configfs</code> ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ª <code>config_item</code>ã€‚ä¸€ä¸ª <code>config_item</code> åæ˜ äº†å­ç³»ç»Ÿä¸­çš„ä¸€ä¸ªå¯¹è±¡ã€‚å®ƒå…·æœ‰ä¸è¯¥å¯¹è±¡çš„å€¼åŒ¹é…çš„å±æ€§ã€‚<code>configfs</code> å¤„ç†è¯¥å¯¹è±¡åŠå…¶å±æ€§çš„æ–‡ä»¶ç³»ç»Ÿè¡¨ç¤ºå½¢å¼ï¼Œå…è®¸å­ç³»ç»Ÿå¿½ç•¥é™¤åŸºæœ¬ <code>show/store</code> äº¤äº’ä»¥å¤–çš„æ‰€æœ‰æ“ä½œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Every object in configfs is a config_item. A config_item reflects an</span><br><span class="line">object in the subsystem. It has attributes that match values on that</span><br><span class="line">object. configfs handles the filesystem representation of that object</span><br><span class="line">and its attributes, allowing the subsystem to ignore all but the</span><br><span class="line">basic show/store interaction.</span><br></pre></td></tr></table></figure><p>é¡¹ç›®æ˜¯åœ¨ <code>config_group</code> ä¸­åˆ›å»ºå’Œé”€æ¯çš„ã€‚<code>group</code> æ˜¯ä¸€ç»„å…·æœ‰ç›¸åŒå±æ€§å’Œæ“ä½œçš„é¡¹ç›®ã€‚é¡¹ç›®é€šè¿‡ <code>mkdir(2)</code> åˆ›å»ºï¼Œé€šè¿‡ <code>rmdir(2)</code> ç§»é™¤ï¼Œä½† <code>configfs</code> å¤„ç†è¿™äº›æ“ä½œã€‚<code>group</code> æœ‰ä¸€ç»„æ“ä½œæ¥æ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Items are created and destroyed inside a config_group. A group is a</span><br><span class="line">collection of items that share the same attributes and operations.</span><br><span class="line">Items are created by mkdir(2) and removed by rmdir(2), but configfs</span><br><span class="line">handles that. The group has a set of operations to perform these tasks.</span><br></pre></td></tr></table></figure><p>å­ç³»ç»Ÿæ˜¯å®¢æˆ·ç«¯æ¨¡å—çš„é¡¶å±‚ã€‚åœ¨åˆå§‹åŒ–æœŸé—´ï¼Œå®¢æˆ·ç«¯æ¨¡å—å°†å­ç³»ç»Ÿæ³¨å†Œåˆ° <code>configfs</code>ï¼Œå­ç³»ç»Ÿå°†ä½œä¸º <code>configfs</code> æ–‡ä»¶ç³»ç»Ÿé¡¶éƒ¨çš„ä¸€ä¸ªç›®å½•å‡ºç°ã€‚å­ç³»ç»Ÿä¹Ÿæ˜¯ä¸€ä¸ª <code>config_group</code>ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œ <code>config_group</code> èƒ½åšçš„æ‰€æœ‰æ“ä½œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A subsystem is the top level of a client module. During initialization,</span><br><span class="line">the client module registers the subsystem with configfs, the subsystem</span><br><span class="line">appears as a directory at the top of the configfs filesystem. A</span><br><span class="line">subsystem is also a config_group, and can do everything a config_group</span><br><span class="line">can.</span><br></pre></td></tr></table></figure><blockquote><p><code>USB CONFIGFS</code> å°±æ˜¯ä¸€ä¸ª <code>config_group/subsystem</code> ã€‚</p></blockquote><hr><h3 id="struct-config-item"><a href="#struct-config-item" class="headerlink" title="struct config_item"></a><code>struct config_item</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> &#123;</span></span><br><span class="line"><span class="type">char</span>                    *ci_name;</span><br><span class="line"><span class="type">char</span>                    ci_namebuf[UOBJ_NAME_LEN];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kref</span>             <span class="title">ci_kref</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">ci_entry</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span>      *<span class="title">ci_parent</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_group</span>     *<span class="title">ci_group</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> *<span class="title">ci_type</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span>           *<span class="title">ci_dentry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">config_item_init</span><span class="params">(<span class="keyword">struct</span> config_item *)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">config_item_init_type_name</span><span class="params">(<span class="keyword">struct</span> config_item *,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> config_item_type *type)</span>;</span><br><span class="line"><span class="keyword">struct</span> config_item *<span class="title function_">config_item_get</span><span class="params">(<span class="keyword">struct</span> config_item *)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">config_item_put</span><span class="params">(<span class="keyword">struct</span> config_item *)</span>;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æ¥è¯´ï¼Œ<code>struct config_item</code> è¢«åµŒå…¥åˆ°ä¸€ä¸ªå®¹å™¨ç»“æ„ä¸­ï¼Œåè€…å®é™…ä¸Šè¡¨ç¤ºå­ç³»ç»Ÿæ­£åœ¨æ‰§è¡Œçš„æ“ä½œã€‚è¯¥ç»“æ„ä¸­çš„ <code>config_item</code> éƒ¨åˆ†æ˜¯å¯¹è±¡ä¸ <code>configfs</code> äº¤äº’çš„æ–¹å¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Generally, struct config_item is embedded in a container structure, a</span><br><span class="line">structure that actually represents what the subsystem is doing. The</span><br><span class="line">config_item portion of that structure is how the object interacts with</span><br><span class="line">configfs.</span><br></pre></td></tr></table></figure><p>æ— è®ºæ˜¯åœ¨æºæ–‡ä»¶ä¸­é™æ€å®šä¹‰è¿˜æ˜¯ç”±çˆ¶ <code>config_group</code> åˆ›å»ºï¼Œéƒ½å¿…é¡»è°ƒç”¨ <code>_init()</code> å‡½æ•°ä¹‹ä¸€å¯¹ <code>config_item</code> è¿›è¡Œåˆå§‹åŒ–ã€‚è¿™ä¼šåˆå§‹åŒ–å¼•ç”¨è®¡æ•°å¹¶è®¾ç½®ç›¸åº”çš„å­—æ®µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Whether statically defined in a source file or created by a parent</span><br><span class="line">config_group, a config_item must have one of the _init() functions</span><br><span class="line">called on it. This initializes the reference count and sets up the</span><br><span class="line">appropriate fields.</span><br></pre></td></tr></table></figure><hr><p>æ‰€æœ‰ <code>config_item</code> çš„ç”¨æˆ·éƒ½åº”è¯¥é€šè¿‡ <code>config_item_get()</code> è·å–å…¶å¼•ç”¨ï¼Œå¹¶åœ¨ä½¿ç”¨å®Œæˆåé€šè¿‡ <code>config_item_put()</code> é‡Šæ”¾å¼•ç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">All users of a config_item should have a reference on it via</span><br><span class="line">config_item_get(), and drop the reference when they are done via</span><br><span class="line">config_item_put().</span><br></pre></td></tr></table></figure><p>ä»…ä»…æœ‰ä¸€ä¸ª <code>config_item</code>ï¼Œå®ƒé™¤äº†å‡ºç°åœ¨ <code>configfs</code> ä¸­ä»¥å¤–ï¼Œå‡ ä¹ä¸èƒ½åšä»»ä½•äº‹æƒ…ã€‚é€šå¸¸å­ç³»ç»Ÿå¸Œæœ›è¯¥é¡¹ç›®æ˜¾ç¤ºå’Œ&#x2F;æˆ–å­˜å‚¨å±æ€§ï¼Œä»¥åŠæ‰§è¡Œå…¶ä»–æ“ä½œã€‚ä¸ºæ­¤ï¼Œå®ƒéœ€è¦ä¸€ä¸ªç±»å‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">By itself, a config_item cannot do much more than appear in configfs.</span><br><span class="line">Usually a subsystem wants the item to display and/or store attributes,</span><br><span class="line">among other things. For that, it needs a type.</span><br></pre></td></tr></table></figure><hr><h3 id="struct-config-item-type"><a href="#struct-config-item-type" class="headerlink" title="struct config_item_type"></a><code>struct config_item_type</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> &#123;</span></span><br><span class="line"><span class="type">void</span> (*release)(<span class="keyword">struct</span> config_item *);</span><br><span class="line"><span class="type">int</span> (*allow_link)(<span class="keyword">struct</span> config_item *src,</span><br><span class="line">  <span class="keyword">struct</span> config_item *target);</span><br><span class="line"><span class="type">void</span> (*drop_link)(<span class="keyword">struct</span> config_item *src,</span><br><span class="line"> <span class="keyword">struct</span> config_item *target);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span>                           *<span class="title">ct_owner</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span>         *<span class="title">ct_item_ops</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span>        *<span class="title">ct_group_ops</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span>               **<span class="title">ct_attrs</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_bin_attribute</span>**<span class="title">ct_bin_attrs</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>config_item_type</code> çš„æœ€åŸºæœ¬åŠŸèƒ½æ˜¯å®šä¹‰å¯ä»¥å¯¹ <code>config_item</code> æ‰§è¡Œçš„æ“ä½œã€‚æ‰€æœ‰åŠ¨æ€åˆ†é…çš„é¡¹ç›®éƒ½éœ€è¦æä¾› <code>ct_item_ops-&gt;release()</code> æ–¹æ³•ã€‚å½“ <code>config_item</code> çš„å¼•ç”¨è®¡æ•°é™ä¸ºé›¶æ—¶ï¼Œä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The most basic function of a config_item_type is to define what</span><br><span class="line">operations can be performed on a config_item. All items that have been</span><br><span class="line">allocated dynamically will need to provide the ct_item_ops-&gt;release()</span><br><span class="line">method. This method is called when the config_item&#x27;s reference count</span><br><span class="line">reaches zero.</span><br></pre></td></tr></table></figure><hr><h3 id="struct-configfs-attribute"><a href="#struct-configfs-attribute" class="headerlink" title="struct configfs_attribute"></a><code>struct configfs_attribute</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> &#123;</span></span><br><span class="line"><span class="type">char</span>                    *ca_name;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">module</span>           *<span class="title">ca_owner</span>;</span></span><br><span class="line"><span class="type">umode_t</span>                  ca_mode;</span><br><span class="line"><span class="type">ssize_t</span> (*show)(<span class="keyword">struct</span> config_item *, <span class="type">char</span> *);</span><br><span class="line"><span class="type">ssize_t</span> (*store)(<span class="keyword">struct</span> config_item *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“ <code>config_item</code> å¸Œæœ›æŸä¸ªå±æ€§ä½œä¸ºæ–‡ä»¶å‡ºç°åœ¨å…¶ <code>configfs</code> ç›®å½•ä¸­æ—¶ï¼Œå®ƒå¿…é¡»å®šä¹‰ä¸€ä¸ªæè¿°è¯¥å±æ€§çš„ <code>configfs_attribute</code>ã€‚ç„¶åå®ƒå°†è¯¥å±æ€§æ·»åŠ åˆ° <code>config_item_type-&gt;ct_attrs</code> çš„ä»¥ NULL ç»“å°¾çš„æ•°ç»„ä¸­ã€‚å½“é¡¹ç›®å‡ºç°åœ¨ <code>configfs</code> ä¸­æ—¶ï¼Œå±æ€§æ–‡ä»¶å°†ä»¥ <code>configfs_attribute-&gt;ca_name</code> æ–‡ä»¶åå‡ºç°ã€‚<code>configfs_attribute-&gt;ca_mode</code> æŒ‡å®šæ–‡ä»¶æƒé™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">When a config_item wants an attribute to appear as a file in the item&#x27;s</span><br><span class="line">configfs directory, it must define a configfs_attribute describing it.</span><br><span class="line">It then adds the attribute to the NULL-terminated array</span><br><span class="line">config_item_type-&gt;ct_attrs. When the item appears in configfs, the</span><br><span class="line">attribute file will appear with the configfs_attribute-&gt;ca_name</span><br><span class="line">filename. configfs_attribute-&gt;ca_mode specifies the file permissions.</span><br></pre></td></tr></table></figure><p>å¦‚æœå±æ€§æ˜¯å¯è¯»çš„å¹¶ä¸”æä¾›äº† <code>-&gt;show</code> æ–¹æ³•ï¼Œåˆ™æ¯å½“ç”¨æˆ·ç©ºé—´è¯·æ±‚è¯»å–è¯¥å±æ€§æ—¶ï¼Œè¯¥æ–¹æ³•å°†è¢«è°ƒç”¨ã€‚å¦‚æœå±æ€§æ˜¯å¯å†™çš„å¹¶ä¸”æä¾›äº† <code>-&gt;store</code> æ–¹æ³•ï¼Œåˆ™æ¯å½“ç”¨æˆ·ç©ºé—´è¯·æ±‚å†™å…¥è¯¥å±æ€§æ—¶ï¼Œè¯¥æ–¹æ³•å°†è¢«è°ƒç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">If an attribute is readable and provides a -&gt;show method, that method will</span><br><span class="line">be called whenever userspace asks for a read(2) on the attribute. If an</span><br><span class="line">attribute is writable and provides a -&gt;store method, that method will be</span><br><span class="line">be called whenever userspace asks for a write(2) on the attribute.</span><br></pre></td></tr></table></figure><hr><h3 id="struct-configfs-bin-attribute"><a href="#struct-configfs-bin-attribute" class="headerlink" title="struct configfs_bin_attribute"></a><code>struct configfs_bin_attribute</code></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_bin_attribute</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span><span class="title">cb_attr</span>;</span></span><br><span class="line"><span class="type">void</span>*cb_private;</span><br><span class="line"><span class="type">size_t</span>cb_max_size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å½“éœ€è¦ä¸€ä¸ªäºŒè¿›åˆ¶ blob ä½œä¸ºæ–‡ä»¶å†…å®¹å‡ºç°åœ¨é¡¹ç›®çš„ <code>configfs</code> ç›®å½•ä¸­æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ <code>configfs_bin_attribute</code>ã€‚è¦å®ç°è¿™ä¸€ç‚¹ï¼Œå°†äºŒè¿›åˆ¶å±æ€§æ·»åŠ åˆ° <code>config_item_type-&gt;ct_bin_attrs</code> çš„ä»¥ NULL ç»“å°¾çš„æ•°ç»„ä¸­ï¼Œå½“é¡¹ç›®å‡ºç°åœ¨ <code>configfs</code> ä¸­æ—¶ï¼Œå±æ€§æ–‡ä»¶å°†ä»¥ <code>configfs_bin_attribute-&gt;cb_attr.ca_name</code> æ–‡ä»¶åå‡ºç°ã€‚<code>configfs_bin_attribute-&gt;cb_attr.ca_mode</code> æŒ‡å®šæ–‡ä»¶æƒé™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">The binary attribute is used when the one needs to use a binary blob to</span><br><span class="line">appear as the contents of a file in the item&#x27;s configfs directory.</span><br><span class="line">To do so, add the binary attribute to the NULL-terminated array</span><br><span class="line">config_item_type-&gt;ct_bin_attrs, and the item appears in configfs, the</span><br><span class="line">attribute file will appear with the configfs_bin_attribute-&gt;cb_attr.ca_name</span><br><span class="line">filename. configfs_bin_attribute-&gt;cb_attr.ca_mode specifies the file</span><br><span class="line">permissions.</span><br></pre></td></tr></table></figure><p><code>cb_private</code> æˆå‘˜æ˜¯ä¸ºé©±åŠ¨ç¨‹åºä½¿ç”¨è€Œæä¾›çš„ï¼Œè€Œ <code>cb_max_size</code> æˆå‘˜æŒ‡å®šç”¨äºè¯¥äºŒè¿›åˆ¶å±æ€§çš„æœ€å¤§ <code>vmalloc</code> ç¼“å†²åŒºå¤§å°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The cb_private member is provided for use by the driver, while the</span><br><span class="line">cb_max_size member specifies the maximum amount of vmalloc buffer</span><br><span class="line">to be used.</span><br></pre></td></tr></table></figure><p>å¦‚æœäºŒè¿›åˆ¶å±æ€§æ˜¯å¯è¯»çš„ï¼Œå¹¶ä¸” <code>config_item</code> æä¾›äº† <code>ct_item_ops-&gt;read_bin_attribute()</code> æ–¹æ³•ï¼Œé‚£ä¹ˆæ¯å½“ç”¨æˆ·ç©ºé—´è¯·æ±‚è¯»å–è¯¥å±æ€§æ—¶ï¼Œå°†è°ƒç”¨è¯¥æ–¹æ³•ã€‚å¯¹äº <code>write(2)</code> ä¹Ÿæ˜¯å¦‚æ­¤ã€‚è¯»&#x2F;å†™æ“ä½œæ˜¯ç¼“å†²çš„ï¼Œå› æ­¤åªä¼šè¿›è¡Œä¸€æ¬¡è¯»&#x2F;å†™ï¼›å±æ€§æœ¬èº«ä¸éœ€è¦å…³å¿ƒè¿™ä¸€ç‚¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">If binary attribute is readable and the config_item provides a</span><br><span class="line">ct_item_ops-&gt;read_bin_attribute() method, that method will be called</span><br><span class="line">whenever userspace asks for a read(2) on the attribute. The converse</span><br><span class="line">will happen for write(2). The reads/writes are buffered, so only a</span><br><span class="line">single read/write will occur; the attributes need not concern itself</span><br><span class="line">with it.</span><br></pre></td></tr></table></figure><hr><h3 id="struct-config-group"><a href="#struct-config-group" class="headerlink" title="struct config_group"></a><code>struct config_group</code></h3><p><code>config_item</code> ä¸èƒ½ç‹¬ç«‹å­˜åœ¨ã€‚åˆ›å»º <code>config_item</code> çš„å”¯ä¸€æ–¹æ³•æ˜¯é€šè¿‡åœ¨ <code>config_group</code> ä¸Šä½¿ç”¨ <code>mkdir(2)</code>ï¼Œè¿™å°†è§¦å‘å­é¡¹çš„åˆ›å»ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span><span class="title">cg_item</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">cg_children</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> *<span class="title">cg_subsys</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">default_groups</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span><span class="title">group_entry</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">config_group_init</span><span class="params">(<span class="keyword">struct</span> config_group *group)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">config_group_init_type_name</span><span class="params">(<span class="keyword">struct</span> config_group *group,</span></span><br><span class="line"><span class="params"> <span class="type">const</span> <span class="type">char</span> *name,</span></span><br><span class="line"><span class="params"> <span class="keyword">struct</span> config_item_type *type)</span>;</span><br></pre></td></tr></table></figure><p><code>config_group</code> ç»“æ„åŒ…å«ä¸€ä¸ª <code>config_item</code>ã€‚é€‚å½“é…ç½®è¯¥é¡¹æ„å‘³ç€ <code>group</code> å¯ä»¥ä½œä¸ºè‡ªå·±çš„é¡¹ç›®å‘æŒ¥ä½œç”¨ã€‚ä¸è¿‡ï¼Œå®ƒå¯ä»¥åšæ›´å¤šï¼šå®ƒå¯ä»¥åˆ›å»ºå­é¡¹ç›®æˆ–å­ç»„ã€‚è¿™æ˜¯é€šè¿‡åœ¨ç»„çš„ <code>config_item_type</code> ä¸ŠæŒ‡å®šçš„ç»„æ“ä½œæ¥å®ç°çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The config_group structure contains a config_item. Properly configuring</span><br><span class="line">that item means that a group can behave as an item in its own right.</span><br><span class="line">However, it can do more: it can create child items or groups. This is</span><br><span class="line">accomplished via the group operations specified on the group&#x27;s</span><br><span class="line">config_item_type.</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> *(*<span class="title">make_item</span>)(<span class="keyword">struct</span> <span class="title">config_group</span> *<span class="title">group</span>,</span></span><br><span class="line"><span class="class"> <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> *(*<span class="title">make_group</span>)(<span class="keyword">struct</span> <span class="title">config_group</span> *<span class="title">group</span>,</span></span><br><span class="line"><span class="class">   <span class="title">const</span> <span class="title">char</span> *<span class="title">name</span>);</span></span><br><span class="line"><span class="type">int</span> (*commit_item)(<span class="keyword">struct</span> config_item *item);</span><br><span class="line"><span class="type">void</span> (*disconnect_notify)(<span class="keyword">struct</span> config_group *group,</span><br><span class="line">  <span class="keyword">struct</span> config_item *item);</span><br><span class="line"><span class="type">void</span> (*drop_item)(<span class="keyword">struct</span> config_group *group,</span><br><span class="line">  <span class="keyword">struct</span> config_item *item);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><p>å¦‚æœç»„æä¾›äº† <code>ct_group_ops-&gt;make_item()</code> æ–¹æ³•ï¼Œåˆ™é€šè¿‡ <code>mkdir(2)</code> åœ¨ç»„çš„ç›®å½•ä¸­è°ƒç”¨è¯¥æ–¹æ³•åˆ›å»ºå­é¡¹ã€‚å­ç³»ç»Ÿåˆ†é…ä¸€ä¸ªæ–°çš„ <code>config_item</code>ï¼ˆæˆ–æ›´å¯èƒ½æ˜¯å…¶å®¹å™¨ç»“æ„ï¼‰ï¼Œå¯¹å…¶è¿›è¡Œåˆå§‹åŒ–å¹¶è¿”å›ç»™ <code>configfs</code>ã€‚ç„¶å <code>configfs</code> å°†å¡«å……æ–‡ä»¶ç³»ç»Ÿæ ‘ä»¥åæ˜ æ–°é¡¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A group creates child items by providing the</span><br><span class="line">ct_group_ops-&gt;make_item() method. If provided, this method is called from mkdir(2) in the group&#x27;s directory. The subsystem allocates a new</span><br><span class="line">config_item (or more likely, its container structure), initializes it,</span><br><span class="line">and returns it to configfs. Configfs will then populate the filesystem</span><br><span class="line">tree to reflect the new item.</span><br></pre></td></tr></table></figure><p>å¦‚æœå­ç³»ç»Ÿå¸Œæœ›å­é¡¹æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç»„ï¼Œåˆ™å­ç³»ç»Ÿä¼šæä¾› <code>ct_group_ops-&gt;make_group()</code> æ–¹æ³•ã€‚å…¶ä»–æ‰€æœ‰è¡Œä¸ºç›¸åŒï¼Œä½¿ç”¨ç»„çš„ <code>_init()</code> å‡½æ•°å¯¹è¯¥ç»„è¿›è¡Œåˆå§‹åŒ–ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">If the subsystem wants the child to be a group itself, the subsystem</span><br><span class="line">provides ct_group_ops-&gt;make_group(). Everything else behaves the same,</span><br><span class="line">using the group _init() functions on the group.</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå½“ç”¨æˆ·ç©ºé—´åœ¨è¯¥é¡¹æˆ–ç»„ä¸Šè°ƒç”¨ <code>rmdir(2)</code> æ—¶ï¼Œ<code>ct_group_ops-&gt;drop_item()</code> æ–¹æ³•å°†è¢«è°ƒç”¨ã€‚ç”±äº <code>config_group</code> ä¹Ÿæ˜¯ä¸€ä¸ª <code>config_item</code>ï¼Œå› æ­¤ä¸éœ€è¦å•ç‹¬çš„ <code>drop_group()</code> æ–¹æ³•ã€‚å­ç³»ç»Ÿå¿…é¡»åœ¨é¡¹ç›®åˆ†é…æ—¶åˆå§‹åŒ–çš„å¼•ç”¨ä¸Šè°ƒç”¨ <code>config_item_put()</code>ã€‚å¦‚æœå­ç³»ç»Ÿæ²¡æœ‰ä»»ä½•å·¥ä½œè¦åšï¼Œåˆ™å¯ä»¥çœç•¥ <code>ct_group_ops-&gt;drop_item()</code> æ–¹æ³•ï¼Œ<code>configfs</code> å°†ä»£è¡¨å­ç³»ç»Ÿåœ¨è¯¥é¡¹ä¸Šè°ƒç”¨ <code>config_item_put()</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Finally, when userspace calls rmdir(2) on the item or group,</span><br><span class="line">ct_group_ops-&gt;drop_item() is called. As a config_group is also a</span><br><span class="line">config_item, it is not necessary for a separate drop_group() method.</span><br><span class="line">The subsystem must config_item_put() the reference that was initialized</span><br><span class="line">upon item allocation. If a subsystem has no work to do, it may omit</span><br><span class="line">the ct_group_ops-&gt;drop_item() method, and configfs will call</span><br><span class="line">config_item_put() on the item on behalf of the subsystem.</span><br></pre></td></tr></table></figure><p>é‡è¦æç¤ºï¼š<code>drop_item()</code> æ˜¯ <code>void</code> å‡½æ•°ï¼Œå› æ­¤ä¸èƒ½è¿”å›å¤±è´¥ã€‚å½“è°ƒç”¨ <code>rmdir(2)</code> æ—¶ï¼Œ<code>configfs</code> å°†ä»æ–‡ä»¶ç³»ç»Ÿæ ‘ä¸­åˆ é™¤è¯¥é¡¹ï¼ˆå‡è®¾æ²¡æœ‰å­é¡¹ä¿æŒå®ƒå¿™ç¢Œï¼‰ã€‚å­ç³»ç»Ÿè´Ÿè´£å¯¹æ­¤åšå‡ºå“åº”ã€‚å¦‚æœå­ç³»ç»Ÿåœ¨å…¶ä»–çº¿ç¨‹ä¸­å¼•ç”¨äº†è¯¥é¡¹ï¼Œåˆ™å†…å­˜æ˜¯å®‰å…¨çš„ã€‚è¯¥é¡¹å®é™…ä¸Šå¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½ä»å­ç³»ç»Ÿçš„ä½¿ç”¨ä¸­æ¶ˆå¤±ã€‚ä½†å®ƒå·²ç»ä» <code>configfs</code> ä¸­åˆ é™¤ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IMPORTANT: drop_item() is void, and as such cannot fail. When rmdir(2)</span><br><span class="line">is called, configfs WILL remove the item from the filesystem tree</span><br><span class="line">(assuming that it has no children to keep it busy). The subsystem is</span><br><span class="line">responsible for responding to this. If the subsystem has references to</span><br><span class="line">the item in other threads, the memory is safe. It may take some time</span><br><span class="line">for the item to actually disappear from the subsystem&#x27;s usage. But it</span><br><span class="line">is gone from configfs.</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨ <code>drop_item()</code> æ—¶ï¼Œé¡¹çš„é“¾æ¥å·²ç»è¢«æ‹†é™¤ã€‚å®ƒä¸å†æ‹¥æœ‰å…¶çˆ¶é¡¹çš„å¼•ç”¨ï¼Œå¹¶ä¸”åœ¨é¡¹ç›®å±‚æ¬¡ç»“æ„ä¸­æ²¡æœ‰ä½ç½®ã€‚å¦‚æœå®¢æˆ·ç«¯éœ€è¦åœ¨è¿™ç§æ‹†é™¤å‘ç”Ÿä¹‹å‰è¿›è¡Œä¸€äº›æ¸…ç†æ“ä½œï¼Œå­ç³»ç»Ÿå¯ä»¥å®ç° <code>ct_group_ops-&gt;disconnect_notify()</code> æ–¹æ³•ã€‚è¯¥æ–¹æ³•åœ¨ <code>configfs</code> ä»æ–‡ä»¶ç³»ç»Ÿè§†å›¾ä¸­åˆ é™¤è¯¥é¡¹åï¼Œä½†åœ¨ä»å…¶çˆ¶ç»„ä¸­åˆ é™¤ä¹‹å‰è°ƒç”¨ã€‚ä¸ <code>drop_item()</code> ä¸€æ ·ï¼Œ<code>disconnect_notify()</code> æ˜¯ <code>void</code> å‡½æ•°ï¼Œä¸èƒ½è¿”å›å¤±è´¥ã€‚å®¢æˆ·ç«¯å­ç³»ç»Ÿä¸åº”åœ¨è¿™é‡Œåˆ é™¤ä»»ä½•å¼•ç”¨ï¼Œå› ä¸ºå®ƒä»¬ä»ç„¶å¿…é¡»åœ¨ <code>drop_item()</code> ä¸­æ‰§è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">When drop_item() is called, the item&#x27;s linkage has already been torn</span><br><span class="line">down. It no longer has a reference on its parent and has no place in</span><br><span class="line">the item hierarchy. If a client needs to do some cleanup before this</span><br><span class="line">teardown happens, the subsystem can implement the</span><br><span class="line">ct_group_ops-&gt;disconnect_notify() method. The method is called after</span><br><span class="line">configfs has removed the item from the filesystem view but before the</span><br><span class="line">item is removed from its parent group. Like drop_item(),</span><br><span class="line">disconnect_notify() is void and cannot fail. Client subsystems should</span><br><span class="line">not drop any references here, as they still must do it in drop_item().</span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>config_group</code> ä»æœ‰å­é¡¹ï¼Œåˆ™æ— æ³•å°†å…¶åˆ é™¤ã€‚è¿™åœ¨ <code>configfs</code> çš„ <code>rmdir(2)</code> ä»£ç ä¸­å®ç°ã€‚ä¸ä¼šè°ƒç”¨ <code>-&gt;drop_item()</code>ï¼Œå› ä¸ºè¯¥é¡¹å°šæœªè¢«åˆ é™¤ã€‚<code>rmdir(2)</code> å°†å¤±è´¥ï¼Œå› ä¸ºç›®å½•ä¸ä¸ºç©ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A config_group cannot be removed while it still has child items. This</span><br><span class="line">is implemented in the configfs rmdir(2) code. -&gt;drop_item() will not be</span><br><span class="line">called, as the item has not been dropped. rmdir(2) will fail, as the</span><br><span class="line">directory is not empty.</span><br></pre></td></tr></table></figure><hr><h3 id="struct-configfs-subsystem"><a href="#struct-configfs-subsystem" class="headerlink" title="struct configfs_subsystem"></a><code>struct configfs_subsystem</code></h3><p>ğŸ”¥ğŸ”¥ <strong>å­ç³»ç»Ÿå¿…é¡»åœ¨æ¨¡å—åˆå§‹åŒ–æœŸé—´æ³¨å†Œè‡ªèº«ã€‚è¿™ä¼šå‘Šè¯‰ <code>configfs</code> å°†å­ç³»ç»Ÿæ˜¾ç¤ºåœ¨æ–‡ä»¶æ ‘ä¸­</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_group</span><span class="title">su_group</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span><span class="title">su_mutex</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">configfs_register_subsystem</span><span class="params">(<span class="keyword">struct</span> configfs_subsystem *subsys)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">configfs_unregister_subsystem</span><span class="params">(<span class="keyword">struct</span> configfs_subsystem *subsys)</span>;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå­ç³»ç»Ÿç”±ä¸€ä¸ªé¡¶å±‚ <code>config_group</code> å’Œä¸€ä¸ªäº’æ–¥é”ç»„æˆã€‚è¯¥ç»„æ˜¯åˆ›å»ºå­ <code>config_items</code> çš„ä½ç½®ã€‚å¯¹äºå­ç³»ç»Ÿæ¥è¯´ï¼Œè¿™ä¸ªç»„é€šå¸¸æ˜¯é™æ€å®šä¹‰çš„ã€‚åœ¨è°ƒç”¨ <code>configfs_register_subsystem()</code> ä¹‹å‰ï¼Œå­ç³»ç»Ÿå¿…é¡»é€šè¿‡å¸¸è§„çš„ç»„åˆå§‹åŒ–å‡½æ•°åˆå§‹åŒ–è¯¥ç»„ï¼Œå¹¶ä¸”è¿˜å¿…é¡»åˆå§‹åŒ–äº’æ–¥é”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A subsystem consists of a toplevel config_group and a mutex.</span><br><span class="line">The group is where child config_items are created. For a subsystem,</span><br><span class="line">this group is usually defined statically. Before calling</span><br><span class="line">configfs_register_subsystem(), the subsystem must have initialized the</span><br><span class="line">group via the usual group _init() functions, and it must also have</span><br><span class="line">initialized the mutex.</span><br></pre></td></tr></table></figure><p>å½“æ³¨å†Œè°ƒç”¨è¿”å›æ—¶ï¼Œå­ç³»ç»Ÿå˜ä¸ºæ´»åŠ¨çŠ¶æ€ï¼Œå¹¶é€šè¿‡ <code>configfs</code> å¯è§ã€‚æ­¤æ—¶ï¼Œå¯ä»¥è°ƒç”¨ <code>mkdir(2)</code>ï¼Œå­ç³»ç»Ÿå¿…é¡»å‡†å¤‡å¥½å¤„ç†å®ƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">When the register call returns, the subsystem is live, and it</span><br><span class="line">will be visible via configfs. At that point, mkdir(2) can be called and</span><br><span class="line">the subsystem must be ready for it.</span><br></pre></td></tr></table></figure><hr><h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>è¿™äº›åŸºæœ¬æ¦‚å¿µçš„æœ€ä½³ç¤ºä¾‹æ˜¯ <code>samples/configfs/configfs_sample.c</code> ä¸­çš„ <code>simple_children</code> å­ç³»ç»Ÿ&#x2F;ç»„å’Œ <code>simple_child</code> é¡¹ã€‚å®ƒå±•ç¤ºäº†ä¸€ä¸ªæ˜¾ç¤ºå’Œå­˜å‚¨å±æ€§çš„ç®€å•å¯¹è±¡ï¼Œä»¥åŠä¸€ä¸ªåˆ›å»ºå’Œé”€æ¯è¿™äº›å­é¡¹çš„ç®€å•ç»„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[An Example]</span><br><span class="line"></span><br><span class="line">The best example of these basic concepts is the simple_children</span><br><span class="line">subsystem/group and the simple_child item in</span><br><span class="line">samples/configfs/configfs_sample.c. It shows a trivial object displaying</span><br><span class="line">and storing an attribute, and a simple group creating and destroying</span><br><span class="line">these children.</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://elixir.bootlin.com/linux/v5.10.186/source/samples/configfs/configfs_sample.c">https://elixir.bootlin.com/linux/v5.10.186/source/samples/configfs/configfs_sample.c</a><br>å¯ä»¥è¯•è¯•ç¼–è¯‘ï¼ŒåŠ ä¸€äº›æ—¥å¿—çœ‹çœ‹ã€‚</p><p>è¿™é‡Œèµ·æ¥æ—¶ï¼Œå°† configfs æŒ‚è½½åˆ°äº† &#x2F;tmp&#x2F;usb ç›®å½•ã€‚ä¸å¥½ï¼Œæœ‰æ­§ä¹‰ğŸŒšã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@milkv-duo]~# ls</span><br><span class="line">configfs_sample.ko</span><br><span class="line">[root@milkv-duo]~# ls /tmp/usb</span><br><span class="line">usb_gadget</span><br><span class="line">[root@milkv-duo]~# insmod configfs_sample.ko</span><br><span class="line">[root@milkv-duo]~# ls /tmp/usb</span><br><span class="line">01-childless  02-simple-children  03-group-children  usb_gadget</span><br><span class="line">[root@milkv-duo]~# cd /tmp/usb/</span><br><span class="line">[root@milkv-duo]/tmp/usb# tree 0*</span><br><span class="line">01-childless</span><br><span class="line">â”œâ”€â”€ description</span><br><span class="line">â”œâ”€â”€ showme</span><br><span class="line">â””â”€â”€ storeme</span><br><span class="line">02-simple-children</span><br><span class="line">â””â”€â”€ description</span><br><span class="line">03-group-children</span><br><span class="line">â””â”€â”€ description</span><br><span class="line"></span><br><span class="line">0 directories, 5 files</span><br></pre></td></tr></table></figure></blockquote><h3 id="00-init"><a href="#00-init" class="headerlink" title="00-init"></a>00-init</h3><p>æˆ‘ä»¬ç°åœ¨å·²ç»å®Œæˆäº†å­ç³»ç»Ÿçš„å®šä¹‰ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè¿™é‡Œåˆ—å‡ºäº†æ‰€æœ‰çš„å­ç³»ç»Ÿã€‚è¿™ä½¿å¾—åˆå§‹åŒ–å‡½æ•°å¯ä»¥è½»æ¾æ³¨å†Œå®ƒä»¬ã€‚å¤§å¤šæ•°æ¨¡å—åªåŒ…å«ä¸€ä¸ªå­ç³»ç»Ÿï¼Œå¹¶ä¸”åªä¼šç›´æ¥è°ƒç”¨ <code>register_subsystem</code> è¿›è¡Œæ³¨å†Œã€‚</p><blockquote><p>å¦‚å‰é¢ <a href="#struct-configfs_subsystem"><code>struct configfs_subsystem</code></a> çš„æè¿°ï¼Œé€šè¿‡è°ƒç”¨</p><ul><li><code>config_group_init(&amp;subsys-&gt;su_group);</code></li><li><code>mutex_init(&amp;subsys-&gt;su_mutex);</code></li><li><code>configfs_register_subsystem(subsys);</code></li></ul><p>æ¥å®Œæˆconfigfs å­ç³»ç»Ÿçš„æ³¨å†Œã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We&#x27;re now done with our subsystem definitions.</span></span><br><span class="line"><span class="comment"> * For convenience in this module, here&#x27;s a list of them all.  It</span></span><br><span class="line"><span class="comment"> * allows the init function to easily register them.  Most modules</span></span><br><span class="line"><span class="comment"> * will only have one subsystem, and will only call register_subsystem</span></span><br><span class="line"><span class="comment"> * on it directly.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> *<span class="title">example_subsys</span>[] =</span> &#123;</span><br><span class="line">&amp;childless_subsys.subsys,</span><br><span class="line">&amp;simple_children_subsys,</span><br><span class="line">&amp;group_children_subsys,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">configfs_example_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> *<span class="title">subsys</span>;</span></span><br><span class="line"><span class="type">int</span> ret, i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; example_subsys[i]; i++) &#123;</span><br><span class="line">subsys = example_subsys[i];</span><br><span class="line"></span><br><span class="line">config_group_init(&amp;subsys-&gt;su_group);</span><br><span class="line">mutex_init(&amp;subsys-&gt;su_mutex);</span><br><span class="line">ret = configfs_register_subsystem(subsys);</span><br><span class="line"><span class="keyword">if</span> (ret) &#123;</span><br><span class="line">pr_err(<span class="string">&quot;Error %d while registering subsystem %s\n&quot;</span>,</span><br><span class="line">       ret, subsys-&gt;su_group.cg_item.ci_namebuf);</span><br><span class="line"><span class="keyword">goto</span> out_unregister;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_unregister:</span><br><span class="line"><span class="keyword">for</span> (i--; i &gt;= <span class="number">0</span>; i--)</span><br><span class="line">configfs_unregister_subsystem(example_subsys[i]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">configfs_example_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; example_subsys[i]; i++)</span><br><span class="line">configfs_unregister_subsystem(example_subsys[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(configfs_example_init);</span><br><span class="line">module_exit(configfs_example_exit);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br></pre></td></tr></table></figure><hr><h3 id="01-childless"><a href="#01-childless" class="headerlink" title="01-childless"></a>01-childless</h3><p>è¿™ä¸ªç¬¬ä¸€ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªæ²¡æœ‰å­é¡¹çš„å­ç³»ç»Ÿã€‚å®ƒä¸èƒ½åˆ›å»ºä»»ä½• <code>config_items</code>ï¼ŒåªåŒ…å«å±æ€§ã€‚</p><p>è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å°† <code>configfs_subsystem</code> å°è£…åœ¨ä¸€ä¸ªå®¹å™¨ä¸­ã€‚å¦‚æœå­ç³»ç»Ÿæœ¬èº«æ²¡æœ‰ç›´æ¥çš„å±æ€§ï¼Œè¿™å¹¶ä¸æ˜¯å¿…é¡»çš„ã€‚å¯ä»¥å‚è€ƒä¸‹ä¸€ä¸ªä¾‹å­ï¼Œ02-simple-childrenï¼Œæ¥äº†è§£è¿™ç§å­ç³»ç»Ÿã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 01-childless</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This first example is a childless subsystem.  It cannot create</span></span><br><span class="line"><span class="comment"> * any config_items.  It just has attributes.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Note that we are enclosing the configfs_subsystem inside a container.</span></span><br><span class="line"><span class="comment"> * This is not necessary if a subsystem has no attributes directly</span></span><br><span class="line"><span class="comment"> * on the subsystem.  See the next example, 02-simple-children, for</span></span><br><span class="line"><span class="comment"> * such a subsystem.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">childless</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">subsys</span>;</span></span><br><span class="line"><span class="type">int</span> showme;</span><br><span class="line"><span class="type">int</span> storeme;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> childless *<span class="title function_">to_childless</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> container_of(to_configfs_subsystem(to_config_group(item)),</span><br><span class="line">    <span class="keyword">struct</span> childless, subsys);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">childless_showme_show</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">childless</span> *<span class="title">childless</span> =</span> to_childless(item);</span><br><span class="line"><span class="type">ssize_t</span> pos;</span><br><span class="line"></span><br><span class="line">pos = <span class="built_in">sprintf</span>(page, <span class="string">&quot;%d\n&quot;</span>, childless-&gt;showme);</span><br><span class="line">childless-&gt;showme++;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pos;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">childless_storeme_show</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">sprintf</span>(page, <span class="string">&quot;%d\n&quot;</span>, to_childless(item)-&gt;storeme);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">childless_storeme_store</span><span class="params">(<span class="keyword">struct</span> config_item *item,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *page, <span class="type">size_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">childless</span> *<span class="title">childless</span> =</span> to_childless(item);</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">ret = kstrtoint(page, <span class="number">10</span>, &amp;childless-&gt;storeme);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">childless_description_show</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">sprintf</span>(page,</span><br><span class="line"><span class="string">&quot;[01-childless]\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;The childless subsystem is the simplest possible subsystem in\n&quot;</span></span><br><span class="line"><span class="string">&quot;configfs.  It does not support the creation of child config_items.\n&quot;</span></span><br><span class="line"><span class="string">&quot;It only has a few attributes.  In fact, it isn&#x27;t much different\n&quot;</span></span><br><span class="line"><span class="string">&quot;than a directory in /proc.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/configfs.h#L134</span></span><br><span class="line"><span class="comment">#define CONFIGFS_ATTR(_pfx, _name)\</span></span><br><span class="line"><span class="comment">static struct configfs_attribute _pfx##attr_##_name = &#123;\</span></span><br><span class="line"><span class="comment">.ca_name= __stringify(_name),\</span></span><br><span class="line"><span class="comment">.ca_mode= S_IRUGO | S_IWUSR,\</span></span><br><span class="line"><span class="comment">.ca_owner= THIS_MODULE,\</span></span><br><span class="line"><span class="comment">.show= _pfx##_name##_show,\</span></span><br><span class="line"><span class="comment">.store= _pfx##_name##_store,\</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#define CONFIGFS_ATTR_RO(_pfx, _name)\</span></span><br><span class="line"><span class="comment">static struct configfs_attribute _pfx##attr_##_name = &#123;\</span></span><br><span class="line"><span class="comment">.ca_name= __stringify(_name),\</span></span><br><span class="line"><span class="comment">.ca_mode= S_IRUGO,\</span></span><br><span class="line"><span class="comment">.ca_owner= THIS_MODULE,\</span></span><br><span class="line"><span class="comment">.show= _pfx##_name##_show,\</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#define CONFIGFS_ATTR_WO(_pfx, _name)\</span></span><br><span class="line"><span class="comment">static struct configfs_attribute _pfx##attr_##_name = &#123;\</span></span><br><span class="line"><span class="comment">.ca_name= __stringify(_name),\</span></span><br><span class="line"><span class="comment">.ca_mode= S_IWUSR,\</span></span><br><span class="line"><span class="comment">.ca_owner= THIS_MODULE,\</span></span><br><span class="line"><span class="comment">.store= _pfx##_name##_store,\</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“é¡¹ç›®å‡ºç°åœ¨ configfs ä¸­æ—¶ï¼Œå±æ€§æ–‡ä»¶å°†ä»¥ configfs_attribute-&gt;ca_name æ–‡ä»¶åå‡ºç°ã€‚</span></span><br><span class="line"><span class="comment">// configfs_attribute-&gt;ca_mode æŒ‡å®šæ–‡ä»¶æƒé™ã€‚</span></span><br><span class="line"><span class="comment">// âœ¨âœ¨âœ¨ æ³¨æ„è¿™é‡Œå®ä¸­ï¼ŒæŒ‡å®šäº† .show/.store å¯¹åº”çš„å¤„ç†å‡½æ•°ã€‚</span></span><br><span class="line">CONFIGFS_ATTR_RO(childless_, showme);</span><br><span class="line">CONFIGFS_ATTR(childless_, storeme);</span><br><span class="line">CONFIGFS_ATTR_RO(childless_, description);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[root@milkv-duo]/tmp/usb/01-childless# ls -lh</span></span><br><span class="line"><span class="comment">total 0</span></span><br><span class="line"><span class="comment">-r--r--r-- 1 root root 4.0K Jan  1 05:15 description</span></span><br><span class="line"><span class="comment">-r--r--r-- 1 root root 4.0K Jan  1 05:15 showme</span></span><br><span class="line"><span class="comment">-rw-r--r-- 1 root root 4.0K Jan  1 05:15 storeme</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ config_item å¸Œæœ›æŸä¸ªå±æ€§ä½œä¸ºæ–‡ä»¶å‡ºç°åœ¨å…¶ configfs ç›®å½•ä¸­æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">// å®ƒå¿…é¡»å®šä¹‰ä¸€ä¸ªæè¿°è¯¥å±æ€§çš„ configfs_attributeã€‚ç„¶åå®ƒå°†è¯¥å±æ€§æ·»åŠ åˆ°</span></span><br><span class="line"><span class="comment">// config_item_type-&gt;ct_attrs çš„ä»¥ NULL ç»“å°¾çš„æ•°ç»„ä¸­ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">childless_attrs</span>[] =</span> &#123;</span><br><span class="line">&amp;childless_attr_showme,</span><br><span class="line">&amp;childless_attr_storeme,</span><br><span class="line">&amp;childless_attr_description,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">childless_type</span> =</span> &#123;</span><br><span class="line">.ct_attrs= childless_attrs,</span><br><span class="line">.ct_owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">childless</span> <span class="title">childless_subsys</span> =</span> &#123;</span><br><span class="line">.subsys = &#123;</span><br><span class="line">.su_group = &#123;</span><br><span class="line">.cg_item = &#123;</span><br><span class="line">.ci_namebuf = <span class="string">&quot;01-childless&quot;</span>,</span><br><span class="line"><span class="comment">// config_item_type çš„æœ€åŸºæœ¬åŠŸèƒ½æ˜¯å®šä¹‰å¯ä»¥å¯¹ config_item æ‰§è¡Œçš„æ“ä½œ</span></span><br><span class="line">.ci_type = &amp;childless_type,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>å€’ç€çœ‹ä»£ç ï¼Œæ³¨æ„é…åˆçœ‹å‰é¢çš„ä»‹ç»ã€‚å±æ€§åŸºæœ¬åªæœ‰ <code>show/store</code> ä¸¤ç§æ“ä½œï¼Œå¯¹åº”è¯»å†™ï¼Œå¯é€šè¿‡ <code>echo/cat</code> æµ‹è¯•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@milkv-duo]/tmp/usb<span class="comment"># ls</span></span><br><span class="line">01-childless  02-simple-children  03-group-children  usb_gadget</span><br><span class="line">[root@milkv-duo]/tmp/usb<span class="comment"># cd 01-childless/</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># ls -lh</span></span><br><span class="line">total 0</span><br><span class="line">-r--r--r-- 1 root root 4.0K Jan  1 05:15 description</span><br><span class="line">-r--r--r-- 1 root root 4.0K Jan  1 05:15 showme</span><br><span class="line">-rw-r--r-- 1 root root 4.0K Jan  1 05:15 storeme</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat showme</span></span><br><span class="line">0</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat showme</span></span><br><span class="line">1</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat showme</span></span><br><span class="line">2</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat showme</span></span><br><span class="line">3</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat showme</span></span><br><span class="line">4</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat storeme</span></span><br><span class="line">0</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat storeme</span></span><br><span class="line">0</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat description</span></span><br><span class="line">[01-childless]</span><br><span class="line"></span><br><span class="line">The childless subsystem is the simplest possible subsystem <span class="keyword">in</span></span><br><span class="line">configfs.  It does not support the creation of child config_items.</span><br><span class="line">It only has a few attributes.  In fact, it isn<span class="string">&#x27;t much different</span></span><br><span class="line"><span class="string">than a directory in /proc.</span></span><br><span class="line"><span class="string">[root@milkv-duo]/tmp/usb/01-childless# echo 0 &gt; showme</span></span><br><span class="line"><span class="string">-sh: can&#x27;</span>t create showme: Permission denied</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat showme</span></span><br><span class="line">5</span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># echo 3 &gt; storeme</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/01-childless<span class="comment"># cat storeme</span></span><br><span class="line">3</span><br></pre></td></tr></table></figure></blockquote><hr><h3 id="02-simple-children"><a href="#02-simple-children" class="headerlink" title="02-simple-children"></a>02-simple-children</h3><p>è¿™ä¸ªä¾‹å­ä»…åŒ…å«ä¸€ä¸ªç®€å•çš„ã€å¸¦æœ‰å•ä¸€å±æ€§çš„å­é¡¹ã€‚æ³¨æ„ï¼Œè¿™é‡Œæ²¡æœ‰é¢å¤–çš„å±æ€§ç»“æ„ï¼Œå› ä¸ºå­é¡¹çš„å±æ€§ä¸€å¼€å§‹å°±æ˜¯å·²çŸ¥çš„ã€‚æ­¤å¤–ï¼Œå­ç³»ç»Ÿæ²¡æœ‰å®¹å™¨ï¼Œå› ä¸ºå®ƒè‡ªèº«æ²¡æœ‰ä»»ä½•å±æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 02-simple-children</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This example merely has a simple one-attribute child.  Note that</span></span><br><span class="line"><span class="comment"> * there is no extra attribute structure, as the child&#x27;s attribute is</span></span><br><span class="line"><span class="comment"> * known from the get-go.  Also, there is no container for the</span></span><br><span class="line"><span class="comment"> * subsystem, as it has no attributes of its own.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simple_child</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_item</span> <span class="title">item</span>;</span></span><br><span class="line"><span class="type">int</span> storeme;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> simple_child *<span class="title function_">to_simple_child</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> container_of(item, <span class="keyword">struct</span> simple_child, item);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">simple_child_storeme_show</span><span class="params">(<span class="keyword">struct</span> config_item *item, <span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">sprintf</span>(page, <span class="string">&quot;%d\n&quot;</span>, to_simple_child(item)-&gt;storeme);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">simple_child_storeme_store</span><span class="params">(<span class="keyword">struct</span> config_item *item,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *page, <span class="type">size_t</span> count)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simple_child</span> *<span class="title">simple_child</span> =</span> to_simple_child(item);</span><br><span class="line"><span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">ret = kstrtoint(page, <span class="number">10</span>, &amp;simple_child-&gt;storeme);</span><br><span class="line"><span class="keyword">if</span> (ret)</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONFIGFS_ATTR(simple_child_, storeme);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">simple_child_attrs</span>[] =</span> &#123;</span><br><span class="line">&amp;simple_child_attr_storeme,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">simple_child_release</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">kfree(to_simple_child(item));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">simple_child_item_ops</span> =</span> &#123;</span><br><span class="line">.release= simple_child_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">simple_child_type</span> =</span> &#123;</span><br><span class="line">.ct_item_ops= &amp;simple_child_item_ops,</span><br><span class="line">.ct_attrs= simple_child_attrs,</span><br><span class="line">.ct_owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simple_children</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_group</span> <span class="title">group</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> simple_children *<span class="title function_">to_simple_children</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> container_of(to_config_group(item),</span><br><span class="line">    <span class="keyword">struct</span> simple_children, group);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> config_item *<span class="title function_">simple_children_make_item</span><span class="params">(<span class="keyword">struct</span> config_group *group,</span></span><br><span class="line"><span class="params"><span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simple_child</span> *<span class="title">simple_child</span>;</span></span><br><span class="line"></span><br><span class="line">simple_child = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> simple_child), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!simple_child)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">config_item_init_type_name(&amp;simple_child-&gt;item, name,</span><br><span class="line">   &amp;simple_child_type);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;simple_child-&gt;item;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">simple_children_description_show</span><span class="params">(<span class="keyword">struct</span> config_item *item,</span></span><br><span class="line"><span class="params"><span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">sprintf</span>(page,</span><br><span class="line"><span class="string">&quot;[02-simple-children]\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;This subsystem allows the creation of child config_items.  These\n&quot;</span></span><br><span class="line"><span class="string">&quot;items have only one attribute that is readable and writeable.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONFIGFS_ATTR_RO(simple_children_, description);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">simple_children_attrs</span>[] =</span> &#123;</span><br><span class="line">&amp;simple_children_attr_description,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">simple_children_release</span><span class="params">(<span class="keyword">struct</span> config_item *item)</span></span><br><span class="line">&#123;</span><br><span class="line">kfree(to_simple_children(item));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">simple_children_item_ops</span> =</span> &#123;</span><br><span class="line">.release= simple_children_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note that, since no extra work is required on -&gt;drop_item(),</span></span><br><span class="line"><span class="comment"> * no -&gt;drop_item() is provided.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// å¦‚æœç»„æä¾›äº† ct_group_ops-&gt;make_item() æ–¹æ³•ï¼Œåˆ™é€šè¿‡ mkdir(2) åœ¨ç»„çš„ç›®å½•ä¸­è°ƒç”¨è¯¥æ–¹æ³•åˆ›å»ºå­é¡¹ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">simple_children_group_ops</span> =</span> &#123;</span><br><span class="line">.make_item= simple_children_make_item,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">simple_children_type</span> =</span> &#123;</span><br><span class="line">.ct_item_ops= &amp;simple_children_item_ops,</span><br><span class="line">.ct_group_ops= &amp;simple_children_group_ops,</span><br><span class="line">.ct_attrs= simple_children_attrs,</span><br><span class="line">.ct_owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">simple_children_subsys</span> =</span> &#123;</span><br><span class="line">.su_group = &#123;</span><br><span class="line">.cg_item = &#123;</span><br><span class="line">.ci_namebuf = <span class="string">&quot;02-simple-children&quot;</span>,</span><br><span class="line">.ci_type = &amp;simple_children_type,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><a href="#struct-config_group">config_group ç»“æ„åŒ…å«ä¸€ä¸ª config_itemã€‚é€‚å½“é…ç½®è¯¥é¡¹æ„å‘³ç€ group å¯ä»¥ä½œä¸ºè‡ªå·±çš„é¡¹ç›®å‘æŒ¥ä½œç”¨ã€‚ä¸è¿‡ï¼Œå®ƒå¯ä»¥åšæ›´å¤šï¼šå®ƒå¯ä»¥åˆ›å»ºå­é¡¹ç›®æˆ–å­ç»„ã€‚è¿™æ˜¯é€šè¿‡åœ¨ç»„çš„ config_item_type ä¸ŠæŒ‡å®šçš„ç»„æ“ä½œæ¥å®ç°çš„ã€‚</a></p><p>è¿™ä¸ªä¾‹å­ï¼Œå¯ä»¥é€šè¿‡ mkdir åˆ›å»ºå­é¡¹ï¼Œå­é¡¹æœ‰ä¸€ä¸ªå¯è¯»å†™çš„ storeme å±æ€§ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># cat description</span></span><br><span class="line">[02-simple-children]</span><br><span class="line"></span><br><span class="line">This subsystem allows the creation of child config_items.  These</span><br><span class="line">items have only one attribute that is readable and writeable.</span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># mkdir test01</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ description</span><br><span class="line">â””â”€â”€ test01</span><br><span class="line">    â””â”€â”€ storeme</span><br><span class="line"></span><br><span class="line">1 directory, 2 files</span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># echo xxx &gt; test01/storeme</span></span><br><span class="line">sh: write error: Invalid argument</span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># echo 30 &gt; test01/storeme</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># cat test01/storeme</span></span><br><span class="line">30</span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># mkdir test02</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># mkdir test03</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ description</span><br><span class="line">â”œâ”€â”€ test01</span><br><span class="line">â”‚Â Â  â””â”€â”€ storeme</span><br><span class="line">â”œâ”€â”€ test02</span><br><span class="line">â”‚Â Â  â””â”€â”€ storeme</span><br><span class="line">â””â”€â”€ test03</span><br><span class="line">    â””â”€â”€ storeme</span><br><span class="line"></span><br><span class="line">3 directories, 4 files</span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># cat test02/storeme</span></span><br><span class="line">0</span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># rmdir test03</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/02-simple-children<span class="comment"># ls</span></span><br><span class="line">description  test01  test02</span><br></pre></td></tr></table></figure></blockquote><h3 id="03-group-children"><a href="#03-group-children" class="headerlink" title="03-group-children"></a>03-group-children</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 03-group-children</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This example reuses the simple_children group from above.  However,</span></span><br><span class="line"><span class="comment"> * the simple_children group is not the subsystem itself, it is a</span></span><br><span class="line"><span class="comment"> * child of the subsystem.  Creation of a group in the subsystem creates</span></span><br><span class="line"><span class="comment"> * a new simple_children group.  That group can then have simple_child</span></span><br><span class="line"><span class="comment"> * children of its own.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> config_group *<span class="title function_">group_children_make_group</span><span class="params">(</span></span><br><span class="line"><span class="params"><span class="keyword">struct</span> config_group *group, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simple_children</span> *<span class="title">simple_children</span>;</span></span><br><span class="line"></span><br><span class="line">simple_children = kzalloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> simple_children),</span><br><span class="line">  GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!simple_children)</span><br><span class="line"><span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">config_group_init_type_name(&amp;simple_children-&gt;group, name,</span><br><span class="line">    &amp;simple_children_type);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;simple_children-&gt;group;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">group_children_description_show</span><span class="params">(<span class="keyword">struct</span> config_item *item,</span></span><br><span class="line"><span class="params"><span class="type">char</span> *page)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">sprintf</span>(page,</span><br><span class="line"><span class="string">&quot;[03-group-children]\n&quot;</span></span><br><span class="line"><span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="string">&quot;This subsystem allows the creation of child config_groups.  These\n&quot;</span></span><br><span class="line"><span class="string">&quot;groups are like the subsystem simple-children.\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CONFIGFS_ATTR_RO(group_children_, description);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">group_children_attrs</span>[] =</span> &#123;</span><br><span class="line">&amp;group_children_attr_description,</span><br><span class="line"><span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Note that, since no extra work is required on -&gt;drop_item(),</span></span><br><span class="line"><span class="comment"> * no -&gt;drop_item() is provided.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">group_children_group_ops</span> =</span> &#123;</span><br><span class="line">.make_group= group_children_make_group,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">group_children_type</span> =</span> &#123;</span><br><span class="line">.ct_group_ops= &amp;group_children_group_ops,</span><br><span class="line">.ct_attrs= group_children_attrs,</span><br><span class="line">.ct_owner= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">group_children_subsys</span> =</span> &#123;</span><br><span class="line">.su_group = &#123;</span><br><span class="line">.cg_item = &#123;</span><br><span class="line">.ci_namebuf = <span class="string">&quot;03-group-children&quot;</span>,</span><br><span class="line">.ci_type = &amp;group_children_type,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p><a href="#sturct-config_group">å¦‚æœå­ç³»ç»Ÿå¸Œæœ›å­é¡¹æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªç»„ï¼Œåˆ™å­ç³»ç»Ÿä¼šæä¾› <code>ct_group_ops-&gt;make_group()</code> æ–¹æ³•ã€‚</a></p><p>è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¯ä»¥é€šè¿‡ mkdir å»åˆ›å»º groupã€‚</p><blockquote><p>â“â“ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœ <code>ct_group_ops</code> ä¸­åŒæ—¶æŒ‡å®šäº† <code>make_group</code> å’Œ <code>make_item</code> ï¼Œé‚£ä¹ˆè°ƒç”¨ <code>mkdir</code> æ—¶æ˜¯æ‰§è¡Œå“ªä¸€ä¸ªå‘¢ï¼Ÿå¯ä»¥ä»æºç ä¸­æ‰¾ç­”æ¡ˆï¼š<a href="https://elixir.bootlin.com/linux/v5.10.186/source/fs/configfs">https://elixir.bootlin.com/linux/v5.10.186/source/fs/configfs</a>  <code>configfs</code> çš„å®ç°çœ‹èµ·æ¥æœ‰ç‚¹ç®€å•ï¼Œä»£ç é‡å¹¶ä¸å¤§ã€‚</p><p><a href="https://elixir.bootlin.com/linux/v5.10.186/source/fs/configfs/dir.c#L1353">https://elixir.bootlin.com/linux/v5.10.186/source/fs/configfs/dir.c#L1353</a> åœ¨ configfs_mkdir() ä¸­ï¼Œ<code>make_group</code> ä¼˜å…ˆè°ƒç”¨ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># cat description</span></span><br><span class="line">[03-group-children]</span><br><span class="line"></span><br><span class="line">This subsystem allows the creation of child config_groups.  These</span><br><span class="line"><span class="built_in">groups</span> are like the subsystem simple-children.</span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># mkdir grp1</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ description</span><br><span class="line">â””â”€â”€ grp1</span><br><span class="line">    â””â”€â”€ description</span><br><span class="line"></span><br><span class="line">1 directory, 2 files</span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># cat grp1/description</span></span><br><span class="line">[02-simple-children]</span><br><span class="line"></span><br><span class="line">This subsystem allows the creation of child config_items.  These</span><br><span class="line">items have only one attribute that is readable and writeable.</span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># mkdir grp1/item1</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># mkdir grp1/item2</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ description</span><br><span class="line">â””â”€â”€ grp1</span><br><span class="line">    â”œâ”€â”€ description</span><br><span class="line">    â”œâ”€â”€ item1</span><br><span class="line">    â”‚Â Â  â””â”€â”€ storeme</span><br><span class="line">    â””â”€â”€ item2</span><br><span class="line">        â””â”€â”€ storeme</span><br><span class="line"></span><br><span class="line">3 directories, 4 files</span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># rmdir grp1</span></span><br><span class="line"><span class="built_in">rmdir</span>: failed to remove <span class="string">&#x27;grp1&#x27;</span>: Directory not empty</span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># cd grp1/</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children/grp1<span class="comment"># rmdir item1</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children/grp1<span class="comment"># rmdir item2</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children/grp1<span class="comment"># cd ..</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># rmdir grp1</span></span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment"># ls</span></span><br><span class="line">description</span><br><span class="line">[root@milkv-duo]/tmp/usb/03-group-children<span class="comment">#</span></span><br></pre></td></tr></table></figure></blockquote><h2 id="å±‚æ¬¡ç»“æ„å¯¼èˆªå’Œå­ç³»ç»Ÿäº’æ–¥é”"><a href="#å±‚æ¬¡ç»“æ„å¯¼èˆªå’Œå­ç³»ç»Ÿäº’æ–¥é”" class="headerlink" title="å±‚æ¬¡ç»“æ„å¯¼èˆªå’Œå­ç³»ç»Ÿäº’æ–¥é”"></a>å±‚æ¬¡ç»“æ„å¯¼èˆªå’Œå­ç³»ç»Ÿäº’æ–¥é”</h2><p><code>configfs</code> æä¾›äº†ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ã€‚ç”±äº <code>config_groups</code> å’Œ <code>config_items</code> å‡ºç°åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå› æ­¤å®ƒä»¬è¢«æ’åˆ—æˆå±‚æ¬¡ç»“æ„ã€‚å­ç³»ç»Ÿ<strong>æ°¸è¿œ</strong>ä¸åº”è§¦åŠæ–‡ä»¶ç³»ç»Ÿéƒ¨åˆ†ï¼Œä½†å­ç³»ç»Ÿå¯èƒ½å¯¹è¯¥å±‚æ¬¡ç»“æ„æ„Ÿå…´è¶£ã€‚ä¸ºæ­¤ï¼Œå±‚æ¬¡ç»“æ„é€šè¿‡ <code>config_group-&gt;cg_children</code> å’Œ <code>config_item-&gt;ci_parent</code> ç»“æ„æˆå‘˜è¿›è¡Œé•œåƒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Hierarchy Navigation and the Subsystem Mutex]</span><br><span class="line"></span><br><span class="line">There is an extra bonus that configfs provides. The config_groups and</span><br><span class="line">config_items are arranged in a hierarchy due to the fact that they</span><br><span class="line">appear in a filesystem. A subsystem is NEVER to touch the filesystem</span><br><span class="line">parts, but the subsystem might be interested in this hierarchy. For</span><br><span class="line">this reason, the hierarchy is mirrored via the config_group-&gt;cg_children</span><br><span class="line">and config_item-&gt;ci_parent structure members.</span><br></pre></td></tr></table></figure><p>å­ç³»ç»Ÿå¯ä»¥åœ¨ä¿æŠ¤å­ç³»ç»Ÿäº’æ–¥é”çš„æƒ…å†µä¸‹å¯¼èˆª <code>cg_children</code> åˆ—è¡¨å’Œ <code>ci_parent</code> æŒ‡é’ˆï¼Œä»¥æŸ¥çœ‹ç”±å­ç³»ç»Ÿåˆ›å»ºçš„æ ‘ã€‚è¿™å¯èƒ½ä¼šä¸ <code>configfs</code> å¯¹å±‚æ¬¡ç»“æ„çš„ç®¡ç†äº§ç”Ÿç«äº‰ï¼Œå› æ­¤ <code>configfs</code> ä½¿ç”¨å­ç³»ç»Ÿäº’æ–¥é”æ¥ä¿æŠ¤ä¿®æ”¹ã€‚æ¯å½“å­ç³»ç»Ÿæƒ³è¦å¯¼èˆªå±‚æ¬¡ç»“æ„æ—¶ï¼Œå¿…é¡»åœ¨å­ç³»ç»Ÿäº’æ–¥é”çš„ä¿æŠ¤ä¸‹è¿›è¡Œã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A subsystem can navigate the cg_children list and the ci_parent pointer</span><br><span class="line">to see the tree created by the subsystem. This can race with configfs&#x27;</span><br><span class="line">management of the hierarchy, so configfs uses the subsystem mutex to</span><br><span class="line">protect modifications. Whenever a subsystem wants to navigate the</span><br><span class="line">hierarchy, it must do so under the protection of the subsystem</span><br><span class="line">mutex.</span><br></pre></td></tr></table></figure><p>åªè¦æ–°åˆ†é…çš„é¡¹å°šæœªé“¾æ¥åˆ°å±‚æ¬¡ç»“æ„ä¸­ï¼Œå­ç³»ç»Ÿå°†æ— æ³•è·å–äº’æ–¥é”ã€‚åŒæ ·ï¼Œåªè¦æ­£åœ¨åˆ é™¤çš„é¡¹å°šæœªä»å±‚æ¬¡ç»“æ„ä¸­è§£é™¤é“¾æ¥ï¼Œå®ƒå°†æ— æ³•è·å–äº’æ–¥é”ã€‚è¿™æ„å‘³ç€åªè¦è¯¥é¡¹åœ¨ <code>configfs</code> ä¸­ï¼Œå…¶ <code>ci_parent</code> æŒ‡é’ˆå°±æ°¸è¿œä¸ä¼šä¸º NULLï¼Œå¹¶ä¸”è¯¥é¡¹åœ¨å…¶çˆ¶é¡¹çš„ <code>cg_children</code> åˆ—è¡¨ä¸­å­˜åœ¨çš„æ—¶é—´ä¹Ÿæ˜¯</p><p>ç›¸åŒçš„ã€‚è¿™ä½¿å­ç³»ç»Ÿåœ¨æŒæœ‰äº’æ–¥é”æ—¶å¯ä»¥ä¿¡ä»» <code>ci_parent</code> å’Œ <code>cg_children</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">A subsystem will be prevented from acquiring the mutex while a newly</span><br><span class="line">allocated item has not been linked into this hierarchy. Similarly, it</span><br><span class="line">will not be able to acquire the mutex while a dropping item has not</span><br><span class="line">yet been unlinked. This means that an item&#x27;s ci_parent pointer will</span><br><span class="line">never be NULL while the item is in configfs, and that an item will only</span><br><span class="line">be in its parent&#x27;s cg_children list for the same duration. This allows</span><br><span class="line">a subsystem to trust ci_parent and cg_children while they hold the</span><br><span class="line">mutex.</span><br></pre></td></tr></table></figure><hr><h2 id="é€šè¿‡-symlink-2-å®ç°é¡¹çš„èšåˆ"><a href="#é€šè¿‡-symlink-2-å®ç°é¡¹çš„èšåˆ" class="headerlink" title="é€šè¿‡ symlink(2) å®ç°é¡¹çš„èšåˆ"></a>é€šè¿‡ <code>symlink(2)</code> å®ç°é¡¹çš„èšåˆ</h2><p><code>configfs</code> é€šè¿‡ <code>group-&gt;item</code> çš„çˆ¶&#x2F;å­å…³ç³»æä¾›äº†ä¸€ä¸ªç®€å•çš„åˆ†ç»„ã€‚ç„¶è€Œï¼Œåœ¨æ›´å¤§çš„ç¯å¢ƒä¸­ï¼Œé€šå¸¸éœ€è¦è¶…å‡ºçˆ¶&#x2F;å­è¿æ¥çš„èšåˆã€‚è¿™å¯ä»¥é€šè¿‡ <code>symlink(2)</code> å®ç°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Item Aggregation Via symlink(2)]</span><br><span class="line"></span><br><span class="line">configfs provides a simple group via the group-&gt;item parent/child</span><br><span class="line">relationship. Often, however, a larger environment requires aggregation</span><br><span class="line">outside of the parent/child connection. This is implemented via</span><br><span class="line">symlink(2).</span><br></pre></td></tr></table></figure><p><code>config_item</code> å¯ä»¥æä¾› <code>ct_item_ops-&gt;allow_link()</code> å’Œ <code>ct_item_ops-&gt;drop_link()</code> æ–¹æ³•ã€‚å¦‚æœå­˜åœ¨ <code>-&gt;allow_link()</code> æ–¹æ³•ï¼Œå¯ä»¥å°† <code>symlink(2)</code> è°ƒç”¨é…ç½®é¡¹ä½œä¸ºé“¾æ¥çš„æºã€‚é“¾æ¥åªå…è®¸åœ¨ <code>configfs</code> çš„ <code>config_items</code> ä¹‹é—´è¿›è¡Œã€‚ä»»ä½•åœ¨ <code>configfs</code> æ–‡ä»¶ç³»ç»Ÿä¹‹å¤–çš„ <code>symlink(2)</code> å°è¯•éƒ½å°†è¢«æ‹’ç»ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">A config_item may provide the ct_item_ops-&gt;allow_link() and</span><br><span class="line">ct_item_ops-&gt;drop_link() methods. If the -&gt;allow_link() method exists,</span><br><span class="line">symlink(2) may be called with the config_item as the source of the link.</span><br><span class="line">These links are only allowed between configfs config_items. Any</span><br><span class="line">symlink(2) attempt outside the configfs filesystem will be denied.</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨ <code>symlink(2)</code> æ—¶ï¼Œæº <code>config_item</code> çš„ <code>-&gt;allow_link()</code> æ–¹æ³•å°†ä¸è‡ªèº«å’Œç›®æ ‡é¡¹ä¸€èµ·è°ƒç”¨ã€‚å¦‚æœæºé¡¹å…è®¸é“¾æ¥åˆ°ç›®æ ‡é¡¹ï¼Œå®ƒå°†è¿”å› 0ã€‚æºé¡¹å¯èƒ½å¸Œæœ›æ‹’ç»é“¾æ¥ï¼Œå¦‚æœå®ƒåªå¸Œæœ›é“¾æ¥åˆ°æŸä¸€ç±»å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œåªèƒ½é“¾æ¥åˆ°è‡ªå·±çš„å­ç³»ç»Ÿä¸­çš„å¯¹è±¡ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">When symlink(2) is called, the source config_item&#x27;s -&gt;allow_link()</span><br><span class="line">method is called with itself and a target item. If the source item</span><br><span class="line">allows linking to target item, it returns 0. A source item may wish to</span><br><span class="line">reject a link if it only wants links to a certain type of object (say,</span><br><span class="line">in its own subsystem).</span><br></pre></td></tr></table></figure><p>å½“åœ¨ç¬¦å·é“¾æ¥ä¸Šè°ƒç”¨ <code>unlink(2)</code> æ—¶ï¼Œæºé¡¹å°†é€šè¿‡ <code>-&gt;drop_link()</code> æ–¹æ³•æ”¶åˆ°é€šçŸ¥ã€‚ä¸ <code>-&gt;drop_item()</code> æ–¹æ³•ä¸€æ ·ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>void</code> å‡½æ•°ï¼Œä¸èƒ½è¿”å›å¤±è´¥ã€‚å­ç³»ç»Ÿè´Ÿè´£å¯¹æ›´æ”¹ä½œå‡ºå“åº”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">When unlink(2) is called on the symbolic link, the source item is</span><br><span class="line">notified via the -&gt;drop_link() method. Like the -&gt;drop_item() method,</span><br><span class="line">this is a void function and cannot return failure. The subsystem is</span><br><span class="line">responsible for responding to the change.</span><br></pre></td></tr></table></figure><p>åªè¦é“¾æ¥åˆ°å…¶ä»–é¡¹ï¼Œæˆ–å…¶ä»–é¡¹é“¾æ¥åˆ°å®ƒï¼Œå°±æ— æ³•ç§»é™¤ <code>config_item</code>ã€‚<code>configfs</code> ä¸å…è®¸å‡ºç°æ‚¬ç©ºçš„ç¬¦å·é“¾æ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A config_item cannot be removed while it links to any other item, nor</span><br><span class="line">can it be removed while an item links to it. Dangling symlinks are not</span><br><span class="line">allowed in configfs.</span><br></pre></td></tr></table></figure><hr><h2 id="è‡ªåŠ¨åˆ›å»ºçš„å­ç»„"><a href="#è‡ªåŠ¨åˆ›å»ºçš„å­ç»„" class="headerlink" title="è‡ªåŠ¨åˆ›å»ºçš„å­ç»„"></a>è‡ªåŠ¨åˆ›å»ºçš„å­ç»„</h2><p>ä¸€ä¸ªæ–°çš„ <code>config_group</code> å¯èƒ½å¸Œæœ›æ‹¥æœ‰ä¸¤ç§ç±»å‹çš„å­ <code>config_items</code>ã€‚è™½ç„¶è¿™å¯ä»¥é€šè¿‡ <code>-&gt;make_item()</code> æ–¹æ³•ä¸­çš„â€œé­”æ³•åç§°â€å®ç°ï¼Œä½†é€šè¿‡ä¸€ç§ç”¨æˆ·ç©ºé—´å¯ä»¥çœ‹åˆ°è¿™ç§åˆ†æ­§çš„æ–¹æ³•æ›´åŠ æ˜ç¡®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Automatically Created Subgroups]</span><br><span class="line"></span><br><span class="line">A new config_group may want to have two types of child config_items.</span><br><span class="line">While this could be codified by magic names in -&gt;make_item(), it is much</span><br><span class="line">more explicit to have a method whereby userspace sees this divergence.</span><br></pre></td></tr></table></figure><p>ä¸å…¶æ‹¥æœ‰ä¸€ä¸ªè¡Œä¸ºä¸åŒçš„é¡¹ï¼Œä¸å¦‚è®© <code>configfs</code> æä¾›ä¸€ç§æ–¹æ³•ï¼Œå³åœ¨åˆ›å»ºçˆ¶ç»„æ—¶ï¼Œè‡ªåŠ¨åœ¨çˆ¶ç»„ä¸­åˆ›å»ºä¸€ä¸ªæˆ–å¤šä¸ªå­ç»„ã€‚å› æ­¤ï¼Œ<code>mkdir(&quot;parent&quot;)</code> ç»“æœæ˜¯ <code>&quot;parent&quot;</code>ï¼Œ<code>&quot;parent/subgroup1&quot;</code>ï¼Œä¾æ¬¡åˆ° <code>&quot;parent/subgroupN&quot;</code>ã€‚ç±»å‹ 1 çš„é¡¹ç°åœ¨å¯ä»¥åœ¨ <code>&quot;parent/subgroup1&quot;</code> ä¸­åˆ›å»ºï¼Œç±»å‹ N çš„é¡¹å¯ä»¥åœ¨ <code>&quot;parent/subgroupN&quot;</code> ä¸­åˆ›å»ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Rather than have a group where some items behave differently than</span><br><span class="line">others, configfs provides a method whereby one or many subgroups are</span><br><span class="line">automatically created inside the parent at its creation. Thus,</span><br><span class="line">mkdir(&quot;parent&quot;) results in &quot;parent&quot;, &quot;parent/subgroup1&quot;, up through</span><br><span class="line">&quot;parent/subgroupN&quot;. Items of type 1 can now be created in</span><br><span class="line">&quot;parent/subgroup1&quot;, and items of type N can be created in</span><br><span class="line">&quot;parent/subgroupN&quot;.</span><br></pre></td></tr></table></figure><p>è¿™äº›è‡ªåŠ¨å­ç»„ï¼ˆæˆ–é»˜è®¤ç»„ï¼‰ä¸ä¼šæ’é™¤çˆ¶ç»„çš„å…¶ä»–å­é¡¹ã€‚å¦‚æœå­˜åœ¨ <code>ct_group_ops-&gt;make_group()</code> æ–¹æ³•ï¼Œå¯ä»¥ç›´æ¥åœ¨çˆ¶ç»„ä¸­åˆ›å»ºå…¶ä»–å­ç»„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">These automatic subgroups, or default groups, do not preclude other</span><br><span class="line">children of the parent group. If ct_group_ops-&gt;make_group() exists,</span><br><span class="line">other child groups can be created on the parent group directly.</span><br></pre></td></tr></table></figure><p><code>configfs</code> å­ç³»ç»Ÿé€šè¿‡ä½¿ç”¨ <code>configfs_add_default_group()</code> å‡½æ•°å°†å®ƒä»¬æ·»åŠ åˆ°çˆ¶ <code>config_group</code> ç»“æ„ä¸­æ¥æŒ‡å®šé»˜è®¤ç»„ã€‚æ¯ä¸ªæ·»åŠ çš„ç»„å°†åœ¨çˆ¶ç»„åˆ›å»ºæ—¶åŒæ—¶å¡«å……åˆ° <code>configfs</code> æ ‘ä¸­ã€‚ç±»ä¼¼åœ°ï¼Œå®ƒä»¬å°†åœ¨çˆ¶ç»„ç§»é™¤æ—¶ä¸€èµ·è¢«åˆ é™¤ã€‚æ²¡æœ‰é¢å¤–çš„é€šçŸ¥ã€‚å½“ <code>-&gt;drop_item()</code> æ–¹æ³•é€šçŸ¥å­ç³»ç»Ÿçˆ¶ç»„æ­£åœ¨æ¶ˆå¤±æ—¶ï¼Œè¿™ä¹Ÿæ„å‘³ç€ä¸è¯¥çˆ¶ç»„å…³è”çš„æ¯ä¸ªé»˜è®¤ç»„å­é¡¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">A configfs subsystem specifies default groups by adding them using the</span><br><span class="line">configfs_add_default_group() function to the parent config_group</span><br><span class="line">structure. Each added group is populated in the configfs tree at the same</span><br><span class="line">time as the parent group. Similarly, they are removed at the same time</span><br><span class="line">as the parent. No extra notification is provided. When a -&gt;drop_item()</span><br><span class="line">method call notifies the subsystem the parent group is going away, it</span><br><span class="line">also means every default group child associated with that parent group.</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œé»˜è®¤ç»„ä¸èƒ½ç›´æ¥é€šè¿‡ <code>rmdir(2)</code> åˆ é™¤ã€‚åœ¨çˆ¶ç»„ä¸Šæ‰§è¡Œ <code>rmdir(2)</code> æ—¶ï¼Œå®ƒä»¬ä¹Ÿä¸ä¼šè¢«è§†ä¸ºå­é¡¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">As a consequence of this, default groups cannot be removed directly via</span><br><span class="line">rmdir(2). They also are not considered when rmdir(2) on the parent</span><br><span class="line">group is checking for children.</span><br></pre></td></tr></table></figure><hr><h2 id="ä¾èµ–å­ç³»ç»Ÿ"><a href="#ä¾èµ–å­ç³»ç»Ÿ" class="headerlink" title="ä¾èµ–å­ç³»ç»Ÿ"></a>ä¾èµ–å­ç³»ç»Ÿ</h2><p>æœ‰æ—¶å…¶ä»–é©±åŠ¨ç¨‹åºä¾èµ–äºç‰¹å®šçš„ <code>configfs</code> é¡¹ã€‚ä¾‹å¦‚ï¼Œ<code>ocfs2</code> æŒ‚è½½ä¾èµ–äºå¿ƒè·³åŒºåŸŸé¡¹ã€‚å¦‚æœè¯¥åŒºåŸŸé¡¹é€šè¿‡ <code>rmdir(2)</code> è¢«ç§»é™¤ï¼Œ<code>ocfs2</code> æŒ‚è½½å¿…é¡» <code>BUG</code> æˆ–åˆ‡æ¢åˆ°åªè¯»æ¨¡å¼ã€‚è¿™å¹¶ä¸ç†æƒ³ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[Dependent Subsystems]</span><br><span class="line"></span><br><span class="line">Sometimes other drivers depend on particular configfs items. For</span><br><span class="line">example, ocfs2 mounts depend on a heartbeat region item. If that</span><br><span class="line">region item is removed with rmdir(2), the ocfs2 mount must BUG or go</span><br><span class="line">readonly. Not happy.</span><br></pre></td></tr></table></figure><p><code>configfs</code> æä¾›äº†ä¸¤ä¸ªé¢å¤–çš„ API è°ƒç”¨ï¼š<code>configfs_depend_item()</code> å’Œ <code>configfs_undepend_item()</code>ã€‚å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºå¯ä»¥è°ƒç”¨ <code>configfs_depend_item()</code> æ¥å‘ŠçŸ¥ <code>configfs</code> å®ƒä¾èµ–æŸä¸ªç°æœ‰é¡¹ã€‚ä¹‹åï¼Œ<code>configfs</code> å°†åœ¨ <code>rmdir(2)</code> è°ƒç”¨æ—¶è¿”å› <code>-EBUSY</code> é”™è¯¯ã€‚å½“è¯¥é¡¹ä¸å†è¢«ä¾èµ–æ—¶ï¼Œå®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºè°ƒç”¨ <code>configfs_undepend_item()</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">configfs provides two additional API calls: configfs_depend_item() and</span><br><span class="line">configfs_undepend_item(). A client driver can call</span><br><span class="line">configfs_depend_item() on an existing item to tell configfs that it is</span><br><span class="line">depended on. configfs will then return -EBUSY from rmdir(2) for that</span><br><span class="line">item. When the item is no longer depended on, the client driver calls</span><br><span class="line">configfs_undepend_item() on it.</span><br></pre></td></tr></table></figure><p>è¿™äº› API ä¸èƒ½åœ¨ä»»ä½• <code>configfs</code> å›è°ƒä¸­è°ƒç”¨ï¼Œå› ä¸ºå®ƒä»¬ä¼šäº§ç”Ÿå†²çªã€‚å®ƒä»¬å¯èƒ½ä¼šé˜»å¡å’Œåˆ†é…å†…å­˜ã€‚å®¢æˆ·ç«¯é©±åŠ¨ç¨‹åºå¯èƒ½ä¸åº”è‡ªè¡Œè°ƒç”¨å®ƒä»¬ï¼Œè€Œåº”è¯¥æä¾›ä¾›å¤–éƒ¨å­ç³»ç»Ÿè°ƒç”¨çš„ APIã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">These API cannot be called underneath any configfs callbacks, as</span><br><span class="line">they will conflict. They can block and allocate. A client driver</span><br><span class="line">probably shouldn&#x27;t calling them of its own gumption. Rather it should</span><br><span class="line">be providing an API that external subsystems call.</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¿‡ç¨‹å¦‚ä½•å·¥ä½œï¼Ÿæƒ³è±¡ä¸€ä¸‹ <code>ocfs2</code> çš„æŒ‚è½½è¿‡ç¨‹ã€‚å½“å®ƒæŒ‚è½½æ—¶ï¼Œå®ƒè¯·æ±‚ä¸€ä¸ªå¿ƒè·³åŒºåŸŸé¡¹ã€‚è¿™æ˜¯é€šè¿‡è°ƒç”¨å¿ƒè·³ä»£ç æ¥å®ç°çš„ã€‚åœ¨å¿ƒè·³ä»£ç ä¸­ï¼ŒæŸ¥æ‰¾åŒºåŸŸé¡¹ã€‚åœ¨è¿™é‡Œï¼Œå¿ƒè·³ä»£ç è°ƒç”¨ <code>configfs_depend_item()</code>ã€‚å¦‚æœè°ƒç”¨æˆåŠŸï¼Œå¿ƒè·³çŸ¥é“è¯¥åŒºåŸŸæ˜¯å®‰å…¨çš„ï¼Œå¯ä»¥åˆ†é…ç»™ <code>ocfs2</code>ã€‚å¦‚æœå¤±è´¥ï¼Œåˆ™è¡¨ç¤ºè¯¥åŒºåŸŸæ­£åœ¨è¢«æ‹†é™¤ï¼Œå¿ƒè·³ä»£ç å¯ä»¥ä¼˜é›…åœ°è¿”å›ä¸€ä¸ªé”™è¯¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">How does this work? Imagine the ocfs2 mount process. When it mounts,</span><br><span class="line">it asks for a heartbeat region item. This is done via a call into the</span><br><span class="line">heartbeat code. Inside the heartbeat code, the region item is looked</span><br><span class="line">up. Here, the heartbeat code calls configfs_depend_item(). If it</span><br><span class="line">succeeds, then heartbeat knows the region is safe to give to ocfs2.</span><br><span class="line">If it fails, it was being torn down anyway, and</span><br><span class="line"></span><br><span class="line"> heartbeat can gracefully</span><br><span class="line">pass up an error.</span><br></pre></td></tr></table></figure><hr><h2 id="å¯æäº¤é¡¹"><a href="#å¯æäº¤é¡¹" class="headerlink" title="å¯æäº¤é¡¹"></a>å¯æäº¤é¡¹</h2><p>æ³¨æ„ï¼šå¯æäº¤é¡¹å½“å‰æœªå®ç°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[Committable Items]</span><br><span class="line"></span><br><span class="line">NOTE: Committable items are currently unimplemented.</span><br></pre></td></tr></table></figure><p>æŸäº› <code>config_items</code> æ— æ³•æ‹¥æœ‰æœ‰æ•ˆçš„åˆå§‹çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— æ³•ä¸ºé¡¹ç›®çš„å±æ€§æŒ‡å®šé»˜è®¤å€¼ï¼Œä»¥ä½¿é¡¹ç›®èƒ½å¤Ÿæ‰§è¡Œå…¶å·¥ä½œã€‚ç”¨æˆ·ç©ºé—´å¿…é¡»é…ç½®ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§ï¼Œä¹‹åå­ç³»ç»Ÿæ‰èƒ½å¯åŠ¨è¯¥é¡¹ç›®æ‰€ä»£è¡¨çš„å®ä½“ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Some config_items cannot have a valid initial state. That is, no</span><br><span class="line">default values can be specified for the item&#x27;s attributes such that the</span><br><span class="line">item can do its work. Userspace must configure one or more attributes,</span><br><span class="line">after which the subsystem can start whatever entity this item</span><br><span class="line">represents.</span><br></pre></td></tr></table></figure><p>è€ƒè™‘ä¸Šé¢çš„ FakeNBD è®¾å¤‡ã€‚æ²¡æœ‰ç›®æ ‡åœ°å€å’Œç›®æ ‡è®¾å¤‡ï¼Œå­ç³»ç»Ÿæ— æ³•çŸ¥é“è¦å¯¼å…¥å“ªä¸ªå—è®¾å¤‡ã€‚ç®€å•ç¤ºä¾‹å‡è®¾å­ç³»ç»Ÿä»…åœ¨æ‰€æœ‰å±æ€§éƒ½é…ç½®å®Œæˆåè¿æ¥ã€‚è¿™ç¡®å®å¯ä»¥å·¥ä½œï¼Œä½†ç°åœ¨æ¯ä¸ªå±æ€§å­˜å‚¨éƒ½å¿…é¡»æ£€æŸ¥å±æ€§æ˜¯å¦å·²åˆå§‹åŒ–ã€‚ä¸€æ—¦æ»¡è¶³æ¡ä»¶ï¼Œæ¯ä¸ªå±æ€§å­˜å‚¨éƒ½å¿…é¡»è§¦å‘è¿æ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Consider the FakeNBD device from above. Without a target address *and*</span><br><span class="line">a target device, the subsystem has no idea what block device to import.</span><br><span class="line">The simple example assumes that the subsystem merely waits until all the</span><br><span class="line">appropriate attributes are configured, and then connects. This will,</span><br><span class="line">indeed, work, but now every attribute store must check if the attributes</span><br><span class="line">are initialized. Every attribute store must fire off the connection if</span><br><span class="line">that condition is met.</span><br></pre></td></tr></table></figure><p>æ›´å¥½çš„æ–¹å¼æ˜¯ä½¿ç”¨ä¸€ä¸ªæ˜ç¡®çš„æ“ä½œé€šçŸ¥å­ç³»ç»Ÿ <code>config_item</code> å·²å‡†å¤‡å¥½ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ˜ç¡®çš„æ“ä½œå¯ä»¥è®©å­ç³»ç»Ÿæä¾›åé¦ˆï¼Œè¯´æ˜å±æ€§æ˜¯å¦ä»¥åˆç†çš„æ–¹å¼è¿›è¡Œäº†åˆå§‹åŒ–ã€‚<code>configfs</code> é€šè¿‡å¯æäº¤é¡¹æä¾›äº†æ­¤åŠŸèƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Far better would be an explicit action notifying the subsystem that the</span><br><span class="line">config_item is ready to go. More importantly, an explicit action allows</span><br><span class="line">the subsystem to provide feedback as to whether the attributes are</span><br><span class="line">initialized in a way that makes sense. configfs provides this as</span><br><span class="line">committable items.</span><br></pre></td></tr></table></figure><p><code>configfs</code> ä»ç„¶ä»…ä½¿ç”¨æ­£å¸¸çš„æ–‡ä»¶ç³»ç»Ÿæ“ä½œã€‚é€šè¿‡ <code>rename(2)</code> æäº¤ä¸€ä¸ªé¡¹ã€‚è¯¥é¡¹ä»å¯ä»¥ä¿®æ”¹çš„ç›®å½•ç§»åŠ¨åˆ°ä¸èƒ½ä¿®æ”¹çš„ç›®å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">configfs still uses only normal filesystem operations. An item is</span><br><span class="line">committed via rename(2). The item is moved from a directory where it</span><br><span class="line">can be modified to a directory where it cannot.</span><br></pre></td></tr></table></figure><p>ä»»ä½•æä¾› <code>ct_group_ops-&gt;commit_item()</code> æ–¹æ³•çš„ç»„éƒ½æ‹¥æœ‰å¯æäº¤çš„é¡¹ã€‚å½“è¯¥ç»„å‡ºç°åœ¨ <code>configfs</code> ä¸­æ—¶ï¼Œä¸èƒ½ç›´æ¥åœ¨ç»„ä¸­ä½¿ç”¨ <code>mkdir(2)</code>ã€‚ç›¸åï¼Œè¯¥ç»„å°†æœ‰ä¸¤ä¸ªå­ç›®å½•ï¼šâ€œliveâ€å’Œâ€œpendingâ€ã€‚<code>live</code> ç›®å½•ä¸æ”¯æŒ <code>mkdir(2)</code> æˆ– <code>rmdir(2)</code>ã€‚å®ƒåªå…è®¸ <code>rename(2)</code>ã€‚<code>pending</code> ç›®å½•å…è®¸ <code>mkdir(2)</code> å’Œ <code>rmdir(2)</code>ã€‚ä¸€ä¸ªé¡¹åœ¨ <code>pending</code> ç›®å½•ä¸­åˆ›å»ºã€‚å…¶å±æ€§å¯ä»¥éšæ„ä¿®æ”¹ã€‚ç”¨æˆ·ç©ºé—´é€šè¿‡å°†é¡¹é‡å‘½ååˆ° <code>live</code> ç›®å½•æ¥æäº¤è¯¥é¡¹ã€‚è¿™æ—¶ï¼Œå­ç³»ç»Ÿæ”¶åˆ° <code>-&gt;commit_item()</code> å›è°ƒã€‚å¦‚æœæ‰€æœ‰å¿…éœ€å±æ€§éƒ½å·²å¡«å†™ï¼Œæ–¹æ³•è¿”å› 0ï¼Œé¡¹è¢«ç§»åŠ¨åˆ° <code>live</code> ç›®å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Any group that provides the ct_group_ops-&gt;commit_item() method has</span><br><span class="line">committable items. When this group appears in configfs, mkdir(2) will</span><br><span class="line">not work directly in the group. Instead, the group will have two</span><br><span class="line">subdirectories: &quot;live&quot; and &quot;pending&quot;. The &quot;live&quot; directory does not</span><br><span class="line">support mkdir(2) or rmdir(2) either. It only allows rename(2). The</span><br><span class="line">&quot;pending&quot; directory does allow mkdir(2) and rmdir(2). An item is</span><br><span class="line">created in the &quot;pending&quot; directory. Its attributes can be modified at</span><br><span class="line">will. Userspace commits the item by renaming it into the &quot;live&quot;</span><br><span class="line">directory. At this point, the subsystem receives the -&gt;commit_item()</span><br><span class="line">callback. If all required attributes are filled to satisfaction, the</span><br><span class="line">method returns zero and the item is moved to the &quot;live&quot; directory.</span><br></pre></td></tr></table></figure><p>ç”±äºåœ¨ <code>live</code> ç›®å½•ä¸­æ— æ³•ä½¿ç”¨ <code>rmdir(2)</code>ï¼Œå¿…é¡»å…³é—­æˆ–â€œå–æ¶ˆæäº¤â€è¯¥é¡¹ã€‚åŒæ ·ï¼Œè¿™å¯ä»¥é€šè¿‡ <code>rename(2)</code> å®Œæˆï¼Œè¿™æ¬¡æ˜¯ä» <code>live</code> ç›®å½•é‡å‘½åå› <code>pending</code> ç›®å½•ã€‚å­ç³»ç»Ÿé€šè¿‡ <code>ct_group_ops-&gt;uncommit_object()</code> æ–¹æ³•æ”¶åˆ°é€šçŸ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">As rmdir(2) does not work in the &quot;live&quot; directory, an item must be</span><br><span class="line">shutdown, or &quot;uncommitted&quot;. Again, this is done via rename(2), this</span><br><span class="line">time from the &quot;live&quot; directory back to the &quot;pending&quot; one. The subsystem</span><br><span class="line">is notified by the ct_group_ops-&gt;uncommit_object() method.</span><br></pre></td></tr></table></figure><hr>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> configfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux USB mtp</title>
      <link href="/2024/09/17/Linux-USBmtp/"/>
      <url>/2024/09/17/Linux-USBmtp/</url>
      
        <content type="html"><![CDATA[<h2 id="USB-mtp-ä»‹ç»"><a href="#USB-mtp-ä»‹ç»" class="headerlink" title="USB mtp ä»‹ç»"></a>USB mtp ä»‹ç»</h2><p><a href="https://en.wikipedia.org/wiki/Media_Transfer_Protocol">https://en.wikipedia.org/wiki/Media_Transfer_Protocol</a></p><blockquote><p>from wiki:<br>MTPæ˜¯ä¸€ç§é«˜æ°´å¹³çš„æ–‡ä»¶ä¼ è¾“åè®®ï¼Œä¸é€šç”¨ä¸²è¡Œæ€»çº¿å¤§å®¹é‡å­˜å‚¨ç­‰é€šç”¨å­˜å‚¨åè®®ç›¸åã€‚è¿™æ„å‘³ç€MTPå®¢æˆ·ç«¯ï¼ˆè®¡ç®—æœºï¼‰çœ‹ä¸åˆ°æ„æˆæ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®ç»“æ„çš„å­—èŠ‚å—æ•°ç»„ï¼Œè€Œæ˜¯ç”¨æ–‡ä»¶å’Œæ–‡ä»¶å¤¹æ¥è¡¨ç¤ºMTPè®¾å¤‡ã€‚è¿™ä½¿å¾—MTPè®¾å¤‡å¯ä»¥å‚ä¸é«˜æ°´å¹³çš„æ“ä½œï¼ˆå¦‚æ›´æ–°å…¶å…ƒä¿¡æ¯ç´¢å¼•ï¼‰ï¼ŒåŒæ—¶å°†æ–‡ä»¶ç³»ç»Ÿçš„å®Œæ•´æ€§æŒæ¡åœ¨è‡ªå·±æ‰‹ä¸­ã€‚ç‰¹åˆ«æ˜¯ï¼Œæ‰çº¿ä¼ è¾“ï¼ˆä¾‹å¦‚è¿‡æ—©æ‹”æ‰USBç”µç¼†ï¼‰ä¸ä¼šæŸåè®¾å¤‡æ–‡ä»¶ç³»ç»Ÿã€‚[6]MTPçš„éé€šç”¨æ€§ä¼šå½±å“è®¡ç®—æœºæ“ä½œç³»ç»Ÿå¦‚ä½•å‘å…¶ä»–ç¨‹åºå’Œç”¨æˆ·å‘ˆç°MTPè®¾å¤‡ã€‚<br>æ ¹æ®å…¶è§„èŒƒï¼ŒMTPçš„</p><ul><li>ä¸»è¦ç›®çš„æ˜¯ä¿ƒè¿›å…·æœ‰ç¬æ€è¿æ¥çš„åª’ä½“è®¾å¤‡ä¹‹é—´çš„é€šä¿¡ã€‚[5]</li><li>ç¬¬äºŒä¸ªç›®çš„æ˜¯å¯ç”¨å¯¹è¿æ¥è®¾å¤‡çš„å‘½ä»¤å’Œæ§åˆ¶ã€‚[5]ç”µæ± ä¾›ç”µçš„ç§»åŠ¨è®¾å¤‡å¯ä»¥é€šè¿‡MTPæŠ¥å‘Šå…¶ç”µæ± ç”µé‡æ°´å¹³ã€‚[6]</li></ul><p>è¯¥åè®®æœ€åˆæ˜¯ä¸ºè·¨USBä½¿ç”¨è€Œå®ç°çš„ï¼Œä½†æ‰©å±•ä¸ºè·¨TCP&#x2F;IPå’Œè“ç‰™ä½¿ç”¨ã€‚Windows Vistaæ”¯æŒTCP&#x2F;IPä¸Šçš„MTPã€‚å¸¦æœ‰Windows Vistaå¹³å°æ›´æ–°çš„Windows 7å’ŒWindows Vistaä¹Ÿæ”¯æŒè“ç‰™ä¸Šçš„MTPã€‚[7]è¿æ¥åˆ°MTPè®¾å¤‡çš„ä¸»æœºç§°ä¸ºMTPå¯åŠ¨å™¨ï¼Œè€Œè®¾å¤‡æœ¬èº«æ˜¯MTPå“åº”å™¨ã€‚[8]</p></blockquote><p>è¿˜æ˜¯ wiki ä»‹ç»å¾—æ›´å¥½ï¼Œå…¶ä»–çš„éšä¾¿çœ‹çœ‹</p><p><a href="https://www.cnblogs.com/skywang12345/p/3474206.html">https://www.cnblogs.com/skywang12345/p/3474206.html</a></p><blockquote><p><a href="https://wowothink.com/ffcaead/">https://wowothink.com/ffcaead/</a></p><p>1ã€UMSï¼šUSB mass storageï¼ŒUSBå¤§å®¹é‡å­˜å‚¨ï¼Œä¹Ÿè¢«ç§°ä¸ºUMSï¼ŒUSB MSCã€‚åœ¨æ—§ç‰ˆAndroidæ‰‹æœºä¸Šä¼šå°†å…¶æš´éœ²ç»™è®¡ç®—æœºï¼Œæœ‰å¦‚ä¸‹å‡ ç§ç¼ºç‚¹ï¼š</p><ul><li>USB mass storageæ˜¯flash driverï¼Œå¤–éƒ¨hdï¼ŒSDå¡å’Œå…¶ä»–USBå­˜å‚¨è®¾å¤‡ä½¿ç”¨çš„æ ‡å‡†åè®®ã€‚é©±åŠ¨å™¨ä½¿å…¶è‡ªèº«å®Œå…¨å¯¹è®¡ç®—æœºå¯è§ï¼Œå°±åƒå®ƒæ˜¯å†…éƒ¨é©±åŠ¨å™¨ä¸€æ ·ï¼›</li><li><strong>è¿™ç§æ–¹å¼å­˜åœ¨é—®é¢˜ã€‚æ— è®ºä»€ä¹ˆè®¾å¤‡è®¿é—®å­˜å‚¨ï¼Œéƒ½éœ€è¦å¯¹å…¶è¿›è¡Œç‹¬å è®¿é—®ã€‚</strong>å°†å­˜å‚¨è¿æ¥åˆ°è®¡ç®—æœºæ—¶ï¼Œå®ƒä¸è®¾å¤‡ä¸Šè¿è¡Œçš„Androidæ“ä½œç³»ç»Ÿæ–­å¼€è¿æ¥ã€‚å­˜å‚¨åœ¨SDå¡æˆ–USBå­˜å‚¨å™¨ä¸Šçš„ä»»ä½•æ–‡ä»¶æˆ–åº”ç”¨ç¨‹åºåœ¨è¿æ¥åˆ°è®¡ç®—æœºæ—¶éƒ½å°†ä¸å¯ç”¨ï¼Œæ­¤æ—¶æ˜¯è®¡ç®—æœºç‹¬å ï¼›</li><li>ç”±äºå¿…é¡»å¯ä»¥ä»Windowsè®¾å¤‡è®¿é—®æ–‡ä»¶ç³»ç»Ÿï¼Œå› æ­¤å¿…é¡»ä½¿ç”¨FATæ–‡ä»¶ç³»ç»Ÿå¯¹å…¶è¿›è¡Œæ ¼å¼åŒ–ã€‚ å¾®è½¯ä¸ä»…æ‹¥æœ‰å¯¹FATæ–½åŠ çš„ä¸“åˆ©ï¼Œè€Œä¸”FATä¹Ÿæ˜¯ä¸€ä¸ªè¾ƒæ—§çš„ï¼Œè¾ƒæ…¢çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ²¡æœ‰ç°ä»£è®¸å¯ç³»ç»Ÿã€‚</li></ul><p>2ã€MTPï¼šMedia Transfer Protocolï¼Œåª’ä½“ä¼ è¾“åè®®ï¼Œä¸»è¦ç”¨äºä¼ è¾“åª’ä½“æ–‡ä»¶ï¼Œå½“Androidä½¿ç”¨è¯¥åè®®ï¼Œå°†å…¶è¿æ¥åˆ°ç”µè„‘ä¸Šï¼Œä¼šæ˜¾ç¤ºä¸€ä¸ªåª’ä½“è®¾å¤‡ã€‚è¯¥åè®®ä¸USB mass storageçš„å·¥ä½œæ–¹å¼éå¸¸ä¸åŒã€‚</p><ul><li>MTPä¸ä¼šå°†Androidè®¾å¤‡çš„åŸå§‹æ–‡ä»¶ç³»ç»Ÿæš´éœ²ç»™Windowsï¼Œè€Œæ˜¯åœ¨æ–‡ä»¶çº§åˆ«è¿è¡Œï¼›</li><li>Androidè®¾å¤‡ä¸ä¼šå°†å…¶æ•´ä¸ªå­˜å‚¨è®¾å¤‡æš´éœ²ç»™Windowsã€‚ ç›¸åï¼Œå½“å°†è®¾å¤‡è¿æ¥åˆ°è®¡ç®—æœºæ—¶ï¼Œè®¡ç®—æœºå°†æŸ¥è¯¢è®¾å¤‡ï¼Œå¹¶ä¸”è®¾å¤‡ä¼šå“åº”å…¶æä¾›çš„æ–‡ä»¶å’Œç›®å½•åˆ—è¡¨ã€‚</li><li>Androidå¯ä»¥é€‰æ‹©å®ƒå‘ˆç°å‡ºæ¥çš„æ–‡ä»¶ï¼Œå¹¶éšè—ç³»ç»Ÿæ–‡ä»¶ï¼Œä»¥ä¾¿å…¶ä»–äººæ— æ³•æŸ¥çœ‹æˆ–ä¿®æ”¹å®ƒä»¬ã€‚ å¦‚æœå°è¯•åˆ é™¤æˆ–ç¼–è¾‘æ— æ³•ä¿®æ”¹çš„æ–‡ä»¶ï¼Œè®¾å¤‡å°†æ‹’ç»è¯¥è¯·æ±‚ï¼Œå°†ä¼šçœ‹åˆ°é”™è¯¯æ¶ˆæ¯ã€‚</li><li><strong>è®¡ç®—æœºä¸éœ€è¦å¯¹å­˜å‚¨è®¾å¤‡è¿›è¡Œç‹¬å è®¿é—®ï¼Œå› æ­¤æ— éœ€è¿æ¥å­˜å‚¨ï¼Œæ–­å¼€è¿æ¥æˆ–ä¸ºä¸åŒç±»å‹çš„æ•°æ®åˆ†åˆ«è®¾ç½®åˆ†åŒº</strong>ã€‚Androidä¹Ÿå¯ä»¥ä½¿ç”¨å®ƒæƒ³è¦çš„ext4æˆ–ä»»ä½•å…¶ä»–æ–‡ä»¶ç³»ç»Ÿï¼Œä½†Windowsä¸å¿…äº†è§£è¯¥æ–‡ä»¶ç³»ç»Ÿã€‚</li><li>åœ¨å®è·µä¸­ï¼ŒMTPçš„åŠŸèƒ½å¾ˆåƒUSB mass storageã€‚ ä¾‹å¦‚ï¼ŒMTPè®¾å¤‡æ˜¾ç¤ºåœ¨Windowsèµ„æºç®¡ç†å™¨ä¸­ï¼Œå› æ­¤æ‚¨å¯ä»¥æµè§ˆå’Œä¼ è¾“æ–‡ä»¶ã€‚</li></ul></blockquote><h2 id="libmtp-åº“"><a href="#libmtp-åº“" class="headerlink" title="libmtp åº“"></a>libmtp åº“</h2><p><a href="https://github.com/libmtp/libmtp">https://github.com/libmtp/libmtp</a></p><h2 id="Initiator-and-Responder"><a href="#Initiator-and-Responder" class="headerlink" title="Initiator and Responder"></a>Initiator and Responder</h2><p>libmtp implements an MTP initiator, which means it initiate<br>MTP sessions with devices. The devices responding are known<br>as MTP responders. libmtp runs on something with a USB host<br>controller interface, using libusb to access the host<br>controller.</p><p>If youâ€™re more interested in the MTP responders, gadgets like<br>MP3 players, mobile phones etc, look into:</p><ul><li>MeeGo:s Buteo Sync:<br><a href="https://github.com/nemomobile/buteo-mtp">https://github.com/nemomobile/buteo-mtp</a><br><a href="https://wiki.merproject.org/wiki/Buteo/MTP">https://wiki.merproject.org/wiki/Buteo/MTP</a></li><li>Android has an MTP responder implementation:<br><a href="https://android.googlesource.com/platform/frameworks/base/+/master/media/jni/">https://android.googlesource.com/platform/frameworks/base/+/master/media/jni/</a></li><li>Ubuntu&#x2F;Ricardo Salveti has mtp-server and libmtp-server going:<br><a href="https://code.launchpad.net/~phablet-team/mtp/trunk">https://code.launchpad.net/~phablet-team/mtp/trunk</a><br><a href="https://bazaar.launchpad.net/~phablet-team/mtp/trunk/files">https://bazaar.launchpad.net/~phablet-team/mtp/trunk/files</a></li></ul><p>æ˜æ˜¾ï¼Œlibmtp æ˜¯ä¸»æœºç«¯ç”¨çš„åº“ï¼Œ</p><h2 id="umtprd"><a href="#umtprd" class="headerlink" title="umtprd"></a>umtprd</h2><p>buildroot ç¼–è¯‘ umtprd å·¥å…·ï¼Œç±»ä¼¼äº adbd çš„ä½œç”¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># mtp tools</span><br><span class="line">BR2_PACKAGE_UMTPRD=y</span><br></pre></td></tr></table></figure><h3 id="configfs-é…ç½®-mtp-æµç¨‹"><a href="#configfs-é…ç½®-mtp-æµç¨‹" class="headerlink" title="configfs é…ç½® mtp æµç¨‹"></a>configfs é…ç½® mtp æµç¨‹</h3><h4 id="0-åˆ‡æ¢ä¸º-device-æ¨¡å¼"><a href="#0-åˆ‡æ¢ä¸º-device-æ¨¡å¼" class="headerlink" title="0. åˆ‡æ¢ä¸º device æ¨¡å¼"></a>0. åˆ‡æ¢ä¸º device æ¨¡å¼</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> device &gt;/proc/cviusb/otg_role</span><br></pre></td></tr></table></figure><blockquote><p>å‚è€ƒ <a href="https://wowothink.com/6a85234b/">https://wowothink.com/6a85234b/</a></p></blockquote><h4 id="1-æŒ‚è½½-configfs"><a href="#1-æŒ‚è½½-configfs" class="headerlink" title="1. æŒ‚è½½ configfs"></a>1. æŒ‚è½½ configfs</h4><p>æ³¨å†Œäº†ä¸€ä¸ªåä¸ºusb_gadgetçš„configfså­ç³»ç»Ÿã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> -p /tmp/usb</span><br><span class="line">mount none /tmp/usb -t configfs</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;[root@sg200x]~# tree /tmp/usb/</span><br><span class="line">&gt;/tmp/usb/</span><br><span class="line">&gt;â””â”€â”€ usb_gadget</span><br><span class="line"></span><br><span class="line">&gt;1 directory, 0 files</span><br></pre></td></tr></table></figure></blockquote><h4 id="2-åˆ›å»ºå¤åˆè®¾å¤‡"><a href="#2-åˆ›å»ºå¤åˆè®¾å¤‡" class="headerlink" title="2. åˆ›å»ºå¤åˆè®¾å¤‡"></a>2. åˆ›å»ºå¤åˆè®¾å¤‡</h4><p><code>mkdir usb_gadget/cvitek</code> åˆ›å»ºåä¸º cvitek çš„usbå¤åˆè®¾å¤‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /tmp/usb/usb_gadget/cvitek</span><br></pre></td></tr></table></figure><p>åœ¨ cvitek ç›®å½•ä¸‹ä¼šåˆ›å»ºå¾ˆå¤šå±æ€§ï¼Œ</p><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@sg200x]/tmp/usb/usb_gadget# tree .</span><br><span class="line">.</span><br><span class="line">â””â”€â”€ cvitek</span><br><span class="line">    â”œâ”€â”€ UDC</span><br><span class="line">    â”œâ”€â”€ bDeviceClass</span><br><span class="line">    â”œâ”€â”€ bDeviceProtocol</span><br><span class="line">    â”œâ”€â”€ bDeviceSubClass</span><br><span class="line">    â”œâ”€â”€ bMaxPacketSize0</span><br><span class="line">    â”œâ”€â”€ bcdDevice</span><br><span class="line">    â”œâ”€â”€ bcdUSB</span><br><span class="line">    â”œâ”€â”€ configs</span><br><span class="line">    â”œâ”€â”€ functions</span><br><span class="line">    â”œâ”€â”€ idProduct</span><br><span class="line">    â”œâ”€â”€ idVendor</span><br><span class="line">    â”œâ”€â”€ max_speed</span><br><span class="line">    â”œâ”€â”€ os_desc</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ b_vendor_code</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ qw_sign</span><br><span class="line">    â”‚Â Â  â””â”€â”€ use</span><br><span class="line">    â””â”€â”€ strings</span><br><span class="line"></span><br><span class="line">5 directories, 13 files</span><br></pre></td></tr></table></figure></blockquote><h4 id="2-1-é…ç½®PIDå’ŒVID"><a href="#2-1-é…ç½®PIDå’ŒVID" class="headerlink" title="2.1 é…ç½®PIDå’ŒVID"></a>2.1 é…ç½®PIDå’ŒVID</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0x3346 &gt;/tmp/usb/usb_gadget/cvitek/idVendor</span><br><span class="line"><span class="built_in">echo</span> 0x1003 &gt;/tmp/usb/usb_gadget/cvitek/idProduct</span><br></pre></td></tr></table></figure><h4 id="2-2-åˆ›å»ºå¹¶é…ç½®-strings-å­ç›®å½•"><a href="#2-2-åˆ›å»ºå¹¶é…ç½®-strings-å­ç›®å½•" class="headerlink" title="2.2 åˆ›å»ºå¹¶é…ç½® strings å­ç›®å½•"></a>2.2 åˆ›å»ºå¹¶é…ç½® strings å­ç›®å½•</h4><p>é…ç½® strings é¦–å…ˆå¿…é¡»è®¾ç½®<code>language</code>ï¼Œè¿™é‡Œè®¾ç½®ä¸º<code>0x0409</code>è¡¨ç¤ºä½¿ç”¨çš„æ˜¯<code>en-us</code>è¯­è¨€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Set the product information string</span><br><span class="line">mkdir /tmp/usb/usb_gadget/cvitek/strings/0x409</span><br><span class="line">echo &quot;Cvitek&quot; &gt;/tmp/usb/usb_gadget/cvitek/strings/0x409/manufacturer</span><br><span class="line">echo &quot;USB Com Port&quot; &gt;/tmp/usb/usb_gadget/cvitek/strings/0x409/product</span><br><span class="line">echo &quot;0123456789&quot; &gt;/tmp/usb/usb_gadget/cvitek/strings/0x409/serialnumber</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&gt;[root@sg200x]/tmp/usb/usb_gadget# tree .</span><br><span class="line">&gt;.</span><br><span class="line">&gt;â””â”€â”€ cvitek</span><br><span class="line">   â”œâ”€â”€ UDC</span><br><span class="line">   â”œâ”€â”€ bDeviceClass</span><br><span class="line">   â”œâ”€â”€ bDeviceProtocol</span><br><span class="line">   â”œâ”€â”€ bDeviceSubClass</span><br><span class="line">   â”œâ”€â”€ bMaxPacketSize0</span><br><span class="line">   â”œâ”€â”€ bcdDevice</span><br><span class="line">   â”œâ”€â”€ bcdUSB</span><br><span class="line">   â”œâ”€â”€ configs</span><br><span class="line">   â”œâ”€â”€ functions</span><br><span class="line">   â”œâ”€â”€ idProduct</span><br><span class="line">   â”œâ”€â”€ idVendor</span><br><span class="line">   â”œâ”€â”€ max_speed</span><br><span class="line">   â”œâ”€â”€ os_desc</span><br><span class="line">   â”‚Â Â  â”œâ”€â”€ b_vendor_code</span><br><span class="line">   â”‚Â Â  â”œâ”€â”€ qw_sign</span><br><span class="line">   â”‚Â Â  â””â”€â”€ use</span><br><span class="line">   â””â”€â”€ strings</span><br><span class="line">       â””â”€â”€ 0x409</span><br><span class="line">           â”œâ”€â”€ manufacturer</span><br><span class="line">           â”œâ”€â”€ product</span><br><span class="line">           â””â”€â”€ serialnumber</span><br><span class="line"></span><br><span class="line">&gt;6 directories, 16 files</span><br></pre></td></tr></table></figure></blockquote><h4 id="2-3-åˆ›å»ºconfigurationå’Œå­—ç¬¦ä¸²"><a href="#2-3-åˆ›å»ºconfigurationå’Œå­—ç¬¦ä¸²" class="headerlink" title="2.3 åˆ›å»ºconfigurationå’Œå­—ç¬¦ä¸²"></a>2.3 åˆ›å»ºconfigurationå’Œå­—ç¬¦ä¸²</h4><p>åˆ›å»ºé…ç½® <code>c.1</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /tmp/usb/usb_gadget/cvitek/configs/c.1</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@sg200x]/tmp/usb/usb_gadget# tree .</span><br><span class="line">.</span><br><span class="line">â””â”€â”€ cvitek</span><br><span class="line">    â”œâ”€â”€ UDC</span><br><span class="line">    â”œâ”€â”€ bDeviceClass</span><br><span class="line">    â”œâ”€â”€ bDeviceProtocol</span><br><span class="line">    â”œâ”€â”€ bDeviceSubClass</span><br><span class="line">    â”œâ”€â”€ bMaxPacketSize0</span><br><span class="line">    â”œâ”€â”€ bcdDevice</span><br><span class="line">    â”œâ”€â”€ bcdUSB</span><br><span class="line">    â”œâ”€â”€ configs</span><br><span class="line">    â”‚Â Â  â””â”€â”€ c.1</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ MaxPower</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ bmAttributes</span><br><span class="line">    â”‚Â Â      â””â”€â”€ strings</span><br><span class="line">    â”œâ”€â”€ functions</span><br><span class="line">    â”œâ”€â”€ idProduct</span><br><span class="line">    â”œâ”€â”€ idVendor</span><br><span class="line">    â”œâ”€â”€ max_speed</span><br><span class="line">    â”œâ”€â”€ os_desc</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ b_vendor_code</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ qw_sign</span><br><span class="line">    â”‚Â Â  â””â”€â”€ use</span><br><span class="line">    â””â”€â”€ strings</span><br><span class="line">        â””â”€â”€ 0x409</span><br><span class="line">            â”œâ”€â”€ manufacturer</span><br><span class="line">            â”œâ”€â”€ product</span><br><span class="line">            â””â”€â”€ serialnumber</span><br><span class="line"></span><br><span class="line">8 directories, 18 files</span><br></pre></td></tr></table></figure></blockquote><p>è®¾ç½®é…ç½®åã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /tmp/usb/usb_gadget/cvitek/configs/c.1/strings/0x409</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;config1&quot;</span> &gt;/tmp/usb/usb_gadget/cvitek/configs/c.1/strings/0x409/configuration</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@sg200x]/tmp/usb/usb_gadget# tree .</span><br><span class="line">.</span><br><span class="line">â””â”€â”€ cvitek</span><br><span class="line">    â”œâ”€â”€ UDC</span><br><span class="line">    â”œâ”€â”€ bDeviceClass</span><br><span class="line">    â”œâ”€â”€ bDeviceProtocol</span><br><span class="line">    â”œâ”€â”€ bDeviceSubClass</span><br><span class="line">    â”œâ”€â”€ bMaxPacketSize0</span><br><span class="line">    â”œâ”€â”€ bcdDevice</span><br><span class="line">    â”œâ”€â”€ bcdUSB</span><br><span class="line">    â”œâ”€â”€ configs</span><br><span class="line">    â”‚Â Â  â””â”€â”€ c.1</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ MaxPower</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ bmAttributes</span><br><span class="line">    â”‚Â Â      â””â”€â”€ strings</span><br><span class="line">    â”‚Â Â          â””â”€â”€ 0x409</span><br><span class="line">    â”‚Â Â              â””â”€â”€ configuration</span><br><span class="line">    â”œâ”€â”€ functions</span><br><span class="line">    â”œâ”€â”€ idProduct</span><br><span class="line">    â”œâ”€â”€ idVendor</span><br><span class="line">    â”œâ”€â”€ max_speed</span><br><span class="line">    â”œâ”€â”€ os_desc</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ b_vendor_code</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ qw_sign</span><br><span class="line">    â”‚Â Â  â””â”€â”€ use</span><br><span class="line">    â””â”€â”€ strings</span><br><span class="line">        â””â”€â”€ 0x409</span><br><span class="line">            â”œâ”€â”€ manufacturer</span><br><span class="line">            â”œâ”€â”€ product</span><br><span class="line">            â””â”€â”€ serialnumber</span><br><span class="line"></span><br><span class="line">9 directories, 19 files</span><br></pre></td></tr></table></figure></blockquote><p>Set the MaxPower of USB descriptor</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 120 &gt;/tmp/usb/usb_gadget/cvitek/configs/c.1/MaxPower</span><br></pre></td></tr></table></figure><h4 id="3-åˆ›å»ºfunctions"><a href="#3-åˆ›å»ºfunctions" class="headerlink" title="3. åˆ›å»ºfunctions"></a>3. åˆ›å»ºfunctions</h4><p><strong>ä¸€ä¸ªUSBå¤åˆè®¾å¤‡ä¼šæœ‰å¤šä¸ªåŠŸèƒ½ï¼Œæ¯ä¸ªåŠŸèƒ½ç”±functionæ¥è¡¨ç¤ºï¼Œæ‰€è°“çš„functionå°±æ˜¯USBè®¾å¤‡æ”¯æŒçš„åŠŸèƒ½</strong>ã€‚å½“æ‰§è¡Œ<code>mkdir functions/mass_storage.0</code>çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨<code>function_make()</code>å‡½æ•°ï¼Œè°ƒç”¨<code>usb_get_function_instance()</code>å‡½æ•°ä¼ å…¥<code>mass_storage</code>å­—æ®µï¼Œå°†ä¼šä»ç°æœ‰çš„function listä¸­æ‰¾åˆ°ä¸ä¹‹åŒ¹é…çš„functionã€‚ç°æœ‰çš„function listæ˜¯ç”±<code>drivers/usb/gadget/function/f_xxx.c</code>ä¸­è¿›è¡Œæ·»åŠ çš„ï¼Œè¿™å°±å°†<code>f_xxx.c</code>è”ç³»èµ·æ¥äº†ã€‚</p><h4 id="3-1-åˆ›å»º-mtp-functions"><a href="#3-1-åˆ›å»º-mtp-functions" class="headerlink" title="3.1 åˆ›å»º mtp functions"></a>3.1 åˆ›å»º mtp functions</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /tmp/usb/usb_gadget/cvitek/functions/mtp.usb0</span><br></pre></td></tr></table></figure><p>å†…æ ¸è¿˜æ²¡å¼€å¯ç›¸åº”é…ç½®çš„ï¼Œå°±ä¼šæŠ¥é”™ã€‚<code>USB_CONFIGFS_F_MTP=y</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@sg200x]/tmp/usb/usb_gadget<span class="comment"># mkdir /tmp/usb/usb_gadget/cvitek/functions/mtp</span></span><br><span class="line">.usb0</span><br><span class="line"><span class="built_in">mkdir</span>: can<span class="string">&#x27;t create directory &#x27;</span>/tmp/usb/usb_gadget/cvitek/functions/mtp.usb0<span class="string">&#x27;: No such file or directory</span></span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@sg200x]/tmp/usb/usb_gadget# tree .</span><br><span class="line">.</span><br><span class="line">â””â”€â”€ cvitek</span><br><span class="line">    â”œâ”€â”€ UDC</span><br><span class="line">    â”œâ”€â”€ bDeviceClass</span><br><span class="line">    â”œâ”€â”€ bDeviceProtocol</span><br><span class="line">    â”œâ”€â”€ bDeviceSubClass</span><br><span class="line">    â”œâ”€â”€ bMaxPacketSize0</span><br><span class="line">    â”œâ”€â”€ bcdDevice</span><br><span class="line">    â”œâ”€â”€ bcdUSB</span><br><span class="line">    â”œâ”€â”€ configs</span><br><span class="line">    â”‚Â Â  â””â”€â”€ c.1</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ MaxPower</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ bmAttributes</span><br><span class="line">    â”‚Â Â      â””â”€â”€ strings</span><br><span class="line">    â”‚Â Â          â””â”€â”€ 0x409</span><br><span class="line">    â”‚Â Â              â””â”€â”€ configuration</span><br><span class="line">    â”œâ”€â”€ functions</span><br><span class="line">    â”‚Â Â  â””â”€â”€ mtp.usb0</span><br><span class="line">    â”œâ”€â”€ idProduct</span><br><span class="line">    â”œâ”€â”€ idVendor</span><br><span class="line">    â”œâ”€â”€ max_speed</span><br><span class="line">    â”œâ”€â”€ os_desc</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ b_vendor_code</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ qw_sign</span><br><span class="line">    â”‚Â Â  â””â”€â”€ use</span><br><span class="line">    â””â”€â”€ strings</span><br><span class="line">        â””â”€â”€ 0x409</span><br><span class="line">            â”œâ”€â”€ manufacturer</span><br><span class="line">            â”œâ”€â”€ product</span><br><span class="line">            â””â”€â”€ serialnumber</span><br><span class="line"></span><br><span class="line">10 directories, 19 files</span><br></pre></td></tr></table></figure></blockquote><h4 id="4-å°†funcå’Œconfigå…³è”èµ·æ¥"><a href="#4-å°†funcå’Œconfigå…³è”èµ·æ¥" class="headerlink" title="4. å°†funcå’Œconfigå…³è”èµ·æ¥"></a>4. å°†funcå’Œconfigå…³è”èµ·æ¥</h4><p>æ‰§è¡Œ<code>ln -s usb_gadget/cvitek/functions/mtp.usb0 usb_gadget/cvitek/configs/c.1</code>å‘½ä»¤å°†æ–°æ·»åŠ çš„<code>mtp</code>çš„<code>functions</code>æ·»åŠ åˆ°<code>configuration</code>å¯¹åº”çš„function listä¸­ï¼Œè¡¨ç¤ºå½“å‰usbå¤åˆè®¾å¤‡ä¸­æ–°å¢äº†ä¸€ä¸ªfunctionã€‚è¿™æ—¶å€™è°ƒç”¨çš„æ˜¯<code>config_usb_cfg_link()</code>å‡½æ•°ã€‚è‡³æ­¤ï¼Œ<code>functions</code>å’Œ<code>configuration</code>å…³è”èµ·æ¥äº†ã€‚æ¥ä¸‹æ¥è¦å°†<code>configuration</code>ä¸ç‰¹å®šçš„UDCè®¾å¤‡è¿æ¥èµ·æ¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> -s /tmp/usb/usb_gadget/cvitek/functions/mtp.usb0 /tmp/usb/usb_gadget/cvitek/configs/c.1</span><br></pre></td></tr></table></figure><blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@sg200x]/tmp/usb/usb_gadget# tree .</span><br><span class="line">.</span><br><span class="line">â””â”€â”€ cvitek</span><br><span class="line">    â”œâ”€â”€ UDC</span><br><span class="line">    â”œâ”€â”€ bDeviceClass</span><br><span class="line">    â”œâ”€â”€ bDeviceProtocol</span><br><span class="line">    â”œâ”€â”€ bDeviceSubClass</span><br><span class="line">    â”œâ”€â”€ bMaxPacketSize0</span><br><span class="line">    â”œâ”€â”€ bcdDevice</span><br><span class="line">    â”œâ”€â”€ bcdUSB</span><br><span class="line">    â”œâ”€â”€ configs</span><br><span class="line">    â”‚Â Â  â””â”€â”€ c.1</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ MaxPower</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ bmAttributes</span><br><span class="line">    â”‚Â Â      â”œâ”€â”€ mtp.usb0 -&gt; ../../../../usb_gadget/cvitek/functions/mtp.usb0</span><br><span class="line">    â”‚Â Â      â””â”€â”€ strings</span><br><span class="line">    â”‚Â Â          â””â”€â”€ 0x409</span><br><span class="line">    â”‚Â Â              â””â”€â”€ configuration</span><br><span class="line">    â”œâ”€â”€ functions</span><br><span class="line">    â”‚Â Â  â””â”€â”€ mtp.usb0</span><br><span class="line">    â”œâ”€â”€ idProduct</span><br><span class="line">    â”œâ”€â”€ idVendor</span><br><span class="line">    â”œâ”€â”€ max_speed</span><br><span class="line">    â”œâ”€â”€ os_desc</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ b_vendor_code</span><br><span class="line">    â”‚Â Â  â”œâ”€â”€ qw_sign</span><br><span class="line">    â”‚Â Â  â””â”€â”€ use</span><br><span class="line">    â””â”€â”€ strings</span><br><span class="line">        â””â”€â”€ 0x409</span><br><span class="line">            â”œâ”€â”€ manufacturer</span><br><span class="line">            â”œâ”€â”€ product</span><br><span class="line">            â””â”€â”€ serialnumber</span><br><span class="line"></span><br><span class="line">11 directories, 19 files</span><br></pre></td></tr></table></figure></blockquote><hr><h4 id="5-ç»‘å®šåˆ°UDCï¼Œä½¿èƒ½gadget"><a href="#5-ç»‘å®šåˆ°UDCï¼Œä½¿èƒ½gadget" class="headerlink" title="5. ç»‘å®šåˆ°UDCï¼Œä½¿èƒ½gadget"></a>5. ç»‘å®šåˆ°UDCï¼Œä½¿èƒ½gadget</h4><p>æ‰§è¡Œ<code>echo xxx &gt; usb_gadget/g1/UDC</code>å‘½ä»¤ï¼Œå°±ä¼šè°ƒç”¨<code>gadget_dev_desc_UDC_store()</code>å‡½æ•°ï¼Œè¿™é‡Œé¢è°ƒç”¨<code>usb composite framework</code>ä¸­çš„<code>usb_gadget_probe_driver()</code>å‡½æ•°å°†gadget driverä¸USB Controller Driverç»‘å®šï¼Œè¿™é‡Œçš„<code>Gadget Driver</code>å°±æ˜¯ä¸æˆ‘ä»¬åˆ›å»ºçš„usbå¤åˆè®¾å¤‡å¯¹åº”çš„é©±åŠ¨ï¼Œæ¥ä¸‹æ¥å°±ä¼šèµ°ä¸€ç³»åˆ—çš„<code>bind</code>æµç¨‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Start the gadget driver</span></span><br><span class="line">CVI_UDC=$(<span class="built_in">ls</span> /sys/class/udc/ | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;CVI_UDC&#125;</span> &gt;/tmp/usb/usb_gadget/cvitek/UDC</span><br></pre></td></tr></table></figure><h4 id="æ±‡æ€»"><a href="#æ±‡æ€»" class="headerlink" title="æ±‡æ€»"></a>æ±‡æ€»</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 0. åˆ‡æ¢ä¸º device æ¨¡å¼</span><br><span class="line">echo device &gt;/proc/cviusb/otg_role</span><br><span class="line"># 1. æŒ‚è½½ configfs</span><br><span class="line">mkdir -p /tmp/usb</span><br><span class="line">mount none /tmp/usb -t configfs</span><br><span class="line"># 2. åˆ›å»ºå¤åˆè®¾å¤‡</span><br><span class="line">mkdir -p /tmp/usb/usb_gadget/cvitek</span><br><span class="line"># 2.1 é…ç½®PIDå’ŒVID</span><br><span class="line">echo 0x3346 &gt;/tmp/usb/usb_gadget/cvitek/idVendor</span><br><span class="line">echo 0x1003 &gt;/tmp/usb/usb_gadget/cvitek/idProduct</span><br><span class="line"># 2.2 åˆ›å»ºå¹¶é…ç½® strings å­ç›®å½•</span><br><span class="line">mkdir /tmp/usb/usb_gadget/cvitek/strings/0x409</span><br><span class="line">echo &quot;Cvitek&quot; &gt;/tmp/usb/usb_gadget/cvitek/strings/0x409/manufacturer</span><br><span class="line">echo &quot;USB Com Port&quot; &gt;/tmp/usb/usb_gadget/cvitek/strings/0x409/product</span><br><span class="line">echo &quot;0123456789&quot; &gt;/tmp/usb/usb_gadget/cvitek/strings/0x409/serialnumber</span><br><span class="line"># 2.3 åˆ›å»ºconfigurationå’Œå­—ç¬¦ä¸²</span><br><span class="line">mkdir /tmp/usb/usb_gadget/cvitek/configs/c.1</span><br><span class="line">mkdir /tmp/usb/usb_gadget/cvitek/configs/c.1/strings/0x409</span><br><span class="line">echo &quot;config1&quot; &gt;/tmp/usb/usb_gadget/cvitek/configs/c.1/strings/0x409/configuration</span><br><span class="line"></span><br><span class="line">echo 120 &gt;/tmp/usb/usb_gadget/cvitek/configs/c.1/MaxPower</span><br><span class="line"># 3. åˆ›å»ºfunctions</span><br><span class="line">mkdir /tmp/usb/usb_gadget/cvitek/functions/mtp.usb0</span><br><span class="line"># 4. å°†funcå’Œconfigå…³è”èµ·æ¥</span><br><span class="line">ln -s /tmp/usb/usb_gadget/cvitek/functions/mtp.usb0 /tmp/usb/usb_gadget/cvitek/configs/c.1</span><br><span class="line"></span><br><span class="line">##########</span><br><span class="line">mkdir /dev/ffs-umtp</span><br><span class="line">mount -t functionfs mtp /dev/ffs-umtp</span><br><span class="line"># Start the umtprd service</span><br><span class="line">umtprd &amp;</span><br><span class="line"></span><br><span class="line"># 5. ç»‘å®šåˆ°UDCï¼Œä½¿èƒ½gadget</span><br><span class="line">CVI_UDC=$(ls /sys/class/udc/ | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line">echo $&#123;CVI_UDC&#125; &gt;/tmp/usb/usb_gadget/cvitek/UDC</span><br></pre></td></tr></table></figure><h3 id="umptrd-æºç "><a href="#umptrd-æºç " class="headerlink" title="umptrd æºç "></a>umptrd æºç </h3><p><a href="https://github.com/viveris/uMTP-Responder/tree/master/conf">https://github.com/viveris/uMTP-Responder/tree/master/conf</a></p><p>å®˜æ–¹æä¾›äº†ä¸€ä¸ªé…ç½®è„šæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FunctionFS uMTPrd startup example/test script</span></span><br><span class="line"><span class="comment"># Must be launched from a writable/temporary folder.</span></span><br><span class="line"></span><br><span class="line">modprobe libcomposite</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> cfg</span><br><span class="line">mount none cfg -t configfs</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> cfg/usb_gadget/g1</span><br><span class="line"><span class="built_in">cd</span> cfg/usb_gadget/g1</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> configs/c.1</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> <span class="built_in">functions</span>/ffs.mtp</span><br><span class="line"><span class="comment"># Uncomment / Change the follow line to enable another usb gadget function</span></span><br><span class="line"><span class="comment">#mkdir functions/acm.usb0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> strings/0x409</span><br><span class="line"><span class="built_in">mkdir</span> configs/c.1/strings/0x409</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 0x0100 &gt; idProduct</span><br><span class="line"><span class="built_in">echo</span> 0x1D6B &gt; idVendor</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;01234567&quot;</span> &gt; strings/0x409/serialnumber</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Viveris Technologies&quot;</span> &gt; strings/0x409/manufacturer</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The Viveris Product !&quot;</span> &gt; strings/0x409/product</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Conf 1&quot;</span> &gt; configs/c.1/strings/0x409/configuration</span><br><span class="line"><span class="built_in">echo</span> 120 &gt; configs/c.1/MaxPower</span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -s <span class="built_in">functions</span>/ffs.mtp configs/c.1</span><br><span class="line"><span class="comment"># Uncomment / Change the follow line to enable another usb gadget function</span></span><br><span class="line"><span class="comment">#ln -s functions/acm.usb0 configs/c.1</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /dev/ffs-umtp</span><br><span class="line">mount -t functionfs mtp /dev/ffs-umtp</span><br><span class="line"><span class="comment"># Start the umtprd service</span></span><br><span class="line">umtprd &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ../../..</span><br><span class="line"></span><br><span class="line"><span class="built_in">sleep</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable the usb functions</span></span><br><span class="line"><span class="built_in">ls</span> /sys/class/udc/ &gt; cfg/usb_gadget/g1/UDC</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount -t functionfs mtp /dev/ffs-umtp</span><br><span class="line">mount: mounting mtp on /dev/ffs-umtp failed: No such device</span><br></pre></td></tr></table></figure><p><code>CONFIG_USB_FUNCTIONFS=y</code> å¯è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cvitek-busybox init/reboot/poweroff</title>
      <link href="/2024/09/11/Cvitek-reboot/"/>
      <url>/2024/09/11/Cvitek-reboot/</url>
      
        <content type="html"><![CDATA[<h2 id="reboot-x2F-poweroff"><a href="#reboot-x2F-poweroff" class="headerlink" title="reboot&#x2F;poweroff"></a>reboot&#x2F;poweroff</h2><p><code>boards/default/dts/cv181x/cv181x_base.dtsi</code> ä¸­å®šä¹‰äº† <code>restart-controller</code> è®¾å¤‡ã€‚</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">restart:</span> <span class="title class_">restart-controller</span> <span class="punctuation">&#123;</span></span><br><span class="line"><span class="attr">compatible</span> <span class="operator">=</span> <span class="string">&quot;cvitek,restart&quot;</span><span class="punctuation">;</span></span><br><span class="line"><span class="attr">reg</span> <span class="operator">=</span> <span class="params">&lt;<span class="number">0x0</span> <span class="number">0x05025000</span> <span class="number">0x0</span> <span class="number">0x2000</span>&gt;</span><span class="punctuation">;</span></span><br><span class="line"><span class="punctuation">&#125;;</span></span><br></pre></td></tr></table></figure><p><code>drivers/power/reset/cvi-reboot.c</code> ä¸­å®ç°äº†å¯¹åº”çš„ä¸€ä¸ªå¹³å°é©±åŠ¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">of_device_id</span> <span class="title">cvi_reboot_of_match</span>[] =</span> &#123;</span><br><span class="line">&#123; .compatible = <span class="string">&quot;cvitek,restart&quot;</span> &#125;,</span><br><span class="line">&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">platform_driver</span> <span class="title">cvi_reboot_driver</span> =</span> &#123;</span><br><span class="line">.probe = cvi_reboot_probe,</span><br><span class="line">.driver = &#123;</span><br><span class="line">.name = <span class="string">&quot;cvi-reboot&quot;</span>,</span><br><span class="line">.of_match_table = cvi_reboot_of_match,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸»è¦çœ‹ä¸‹ <code>cvi_reboot_probe</code>ï¼Œå®ƒåšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œæ³¨å†Œ <code>restart</code> ä»¥åŠ <code>poweroff</code> çš„å›è°ƒå¤„ç†å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">notifier_block</span> <span class="title">cvi_restart_nb</span> =</span> &#123;</span><br><span class="line">.notifier_call = cvi_restart_handler,</span><br><span class="line">.priority = <span class="number">128</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cvi_reboot_probe</span><span class="params">(<span class="keyword">struct</span> platform_device *pdev)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device_node</span> *<span class="title">np</span> =</span> pdev-&gt;dev.of_node;</span><br><span class="line"><span class="type">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®è®¾å¤‡æ ‘ä¿¡æ¯è°ƒç”¨ ioremap æ˜ å°„åŸºå€ 0x05025000, size 0x2000</span></span><br><span class="line">base = of_iomap(np, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (!base) &#123;</span><br><span class="line">WARN(<span class="number">1</span>, <span class="string">&quot;failed to map base address&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œ restart çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">err = register_restart_handler(&amp;cvi_restart_nb);</span><br><span class="line"><span class="keyword">if</span> (err) &#123;</span><br><span class="line">dev_err(&amp;pdev-&gt;dev, <span class="string">&quot;cannot register restart handler (err=%d)\n&quot;</span>,</span><br><span class="line">err);</span><br><span class="line">iounmap(base);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œ poweroff çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">pm_power_off = &amp;cvi_do_pwroff;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="reboot-è°ƒç”¨é“¾"><a href="#reboot-è°ƒç”¨é“¾" class="headerlink" title="reboot è°ƒç”¨é“¾"></a>reboot è°ƒç”¨é“¾</h2><p>ä¸Šé¢åªæ˜¯åœ¨äº† kernel ä¸­æ³¨å†Œäº†ä¸€ä¸ª reboot æŒ‡ä»¤çš„ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œä½† reboot çš„å®Œæ•´æµç¨‹:</p><blockquote><p><a href="https://blog.csdn.net/davion_zhang/article/details/52233043">https://blog.csdn.net/davion_zhang/article/details/52233043</a></p></blockquote><p><img src="/../images/Cvitek-reboot/Center.jpeg" alt="reboot"></p><p>æ™®é€šçš„rebootæ˜¯é€šè¿‡busyboxä¸ºå…¥å£ï¼Œè¿›å…¥halt_mainå‡½æ•°ï¼Œç„¶åç»™initè¿›ç¨‹å‘é€SIGTERMä¿¡å·ï¼Œinitè¿›ç¨‹æ¥æ”¶åˆ°ä¿¡å·åç»™å…¶ä»–è¿›ç¨‹å‘é€ç»ˆæ­¢ä¿¡å·ï¼Œæœ€åè°ƒç”¨Cåº“å‡½æ•°rebootï¼Œrebooté€šè¿‡ç³»ç»Ÿè°ƒç”¨sys_rebootè¿›å…¥å†…æ ¸ï¼Œå†…æ ¸å°†æ•´ä¸ªç³»ç»Ÿé‡å¯ã€‚<strong>å…¶ä¸­åœ¨shellä¸­æ‰§è¡Œreboot â€“fåˆ™é€šè¿‡halt_mainç›´æ¥è°ƒç”¨Cå‡½æ•°rebootï¼Œä¸ç»è¿‡initè¿›ç¨‹</strong>ã€‚</p><h3 id="reboot-åº”ç”¨å±‚å®ç°"><a href="#reboot-åº”ç”¨å±‚å®ç°" class="headerlink" title="reboot åº”ç”¨å±‚å®ç°"></a>reboot åº”ç”¨å±‚å®ç°</h3><p>reboot æœ¬èº«ä¹Ÿåªæ˜¯ busybox å®ç°çš„ã€‚æ‰€ä»¥çœ‹ busybox çš„æºç å°±å¥½ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@milkv-duo]~<span class="comment"># whereis reboot</span></span><br><span class="line">reboot: /sbin/reboot</span><br><span class="line">[root@milkv-duo]~<span class="comment"># cd /sbin/</span></span><br><span class="line">[root@milkv-duo]/sbin<span class="comment"># ll reboot</span></span><br><span class="line">lrwxrwxrwx 1 root root 14 Aug  1  2024 reboot -&gt; ../bin/busybox*</span><br></pre></td></tr></table></figure><p><strong>âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨ å®é™…ä¸Šï¼Œrebootã€poweroffã€CTRL-ALT-DEL ç­‰éƒ½æ˜¯ç”±INIT è¿›ç¨‹å»å¤„ç†çš„ï¼Œinit è¿›ç¨‹ä¸­é…ç½®äº† ä¿¡å·-ä¿¡å·å¤„ç†å‡½æ•°ï¼Œrebootã€poweroffã€CTRL-ALT-DEL æœ¬è´¨ä¸Šéƒ½æ˜¯ç»™init è¿›ç¨‹å‘é€ä¿¡å·ï¼Œä»è€Œè®© init è¿›å»å»æ‰§è¡Œç›¸åº”çš„åŠ¨ä½œã€‚<br>USR1&#x2F;TERM&#x2F;USR2&#x2F;INT: run halt&#x2F;reboot&#x2F;poweroff&#x2F;Ctrl-Alt-Del scriptã€‚æ‰€ä»¥ï¼Œä½ å¯ä»¥é€šè¿‡ <code>kill -s SIGTERM 1</code> å®ç°rebootæ“ä½œï¼Œå…¶ä½™ç±»ä¼¼ã€‚æ‰€ä»¥ï¼Œå¾—ç†Ÿæ‚‰  <a href="./Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E4%BF%A1%E5%8F%B7.md">ä¿¡å·</a>âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨âœ¨</strong></p><p>åŸºäºä¸Šé¢çš„ç»“è®ºï¼Œå†æ¥çœ‹ä»£ç ã€‚åœ¨ <code>init/init.c halt.c</code> ä¸­ï¼Œreboot çš„å…·ä½“å®ç°æ˜¯è¿™æ ·çš„ï¼š</p><p>é¦–å…ˆï¼Œæœ‰ä¸ªå…¨å±€å˜é‡ G ã€‚æ•°æ®ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼Œä¸»è¦åŒ…å«ä¸€ä¸ªaction listä»£è¡¨åˆå§‹åŒ–è¿‡ç¨‹ä¼šæ‰§è¡Œçš„æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">globals</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">init_action</span> *<span class="title">init_action_list</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !ENABLE_FEATURE_INIT_SYSLOG</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *log_console;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="type">sigset_t</span> delayed_sigset;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">zero_ts</span>;</span></span><br><span class="line">&#125; FIX_ALIASING;</span><br></pre></td></tr></table></figure><p>initè¿›ç¨‹æœ¬èº«æ˜¯é€šè¿‡ä¿¡å·ä¼ é€’æ¶ˆæ¯ï¼Œè¿›è€Œå¤„ç†å¯¹åº”çš„åŠ¨ä½œã€‚è¿™é‡Œä¸»è¦å…ˆé€šè¿‡ <a href="./Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E4%BF%A1%E5%8F%B7.md">sigprocmask</a> æŠŠä¸€äº›å½±å“ç³»ç»Ÿå¯åŠ¨çš„ä¿¡å·è¿›è¡Œé˜»å¡ã€‚é˜²æ­¢å¹²æ‰°å‰æœŸåˆå§‹åŒ–è¿‡ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">init_main</span><span class="params">(<span class="type">int</span> argc UNUSED_PARAM, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">sa</span>;</span></span><br><span class="line"></span><br><span class="line">INIT_G();</span><br><span class="line"><span class="comment">/* Some users send poweroff signals to init VERY early.</span></span><br><span class="line"><span class="comment"> * To handle this, mask signals early.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGINT);  <span class="comment">/* Ctrl-Alt-Del */</span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGQUIT); <span class="comment">/* re-exec another init */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SIGPWR</span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGPWR);  <span class="comment">/* halt */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGUSR1); <span class="comment">/* halt */</span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGTERM); <span class="comment">/* reboot */</span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGUSR2); <span class="comment">/* poweroff */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_FEATURE_USE_INITTAB</span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGHUP);  <span class="comment">/* reread /etc/inittab */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">sigaddset(&amp;G.delayed_sigset, SIGCHLD); <span class="comment">/* make sigtimedwait() exit on SIGCHLD */</span></span><br><span class="line">sigprocmask(SIG_BLOCK, &amp;G.delayed_sigset, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure><p>å¦‚æœå‚æ•°å¸¦äº†-qå°±ç›´æ¥ç»™ è¿›ç¨‹1 ï¼ˆinitï¼‰å‘é€ SIGHUP ä¿¡å·.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argv[<span class="number">1</span>] &amp;&amp; <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;-q&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> kill(<span class="number">1</span>, SIGHUP);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initè¿›ç¨‹çš„è¿›ç¨‹å·å¿…é¡»æ˜¯1.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> !DEBUG_INIT</span></span><br><span class="line"><span class="comment">/* Expect to be invoked as init with PID=1 or be invoked as linuxrc */</span></span><br><span class="line"><span class="keyword">if</span> (getpid() != <span class="number">1</span></span><br><span class="line"> &amp;&amp; (!ENABLE_LINUXRC || applet_name[<span class="number">0</span>] != <span class="string">&#x27;l&#x27;</span>) <span class="comment">/* not linuxrc? */</span></span><br><span class="line">) &#123;</span><br><span class="line">bb_simple_error_msg_and_die(<span class="string">&quot;must be run as PID 1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> RB_DISABLE_CAD</span></span><br><span class="line"><span class="comment">/* Turn off rebooting via CTL-ALT-DEL - we get a</span></span><br><span class="line"><span class="comment"> * SIGINT on CAD so we can shut things down gracefully... */</span></span><br><span class="line">reboot(RB_DISABLE_CAD); <span class="comment">/* misnomer */</span></span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure><p>è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¦‚æœæœ‰å‚æ•°çš„è¯ï¼Œè®¾ç½® RUNLEVEL</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Make sure environs is set to something sane */</span></span><br><span class="line">putenv((<span class="type">char</span> *) <span class="string">&quot;HOME=/&quot;</span>);</span><br><span class="line">putenv((<span class="type">char</span> *) bb_PATH_root_path);</span><br><span class="line">putenv((<span class="type">char</span> *) <span class="string">&quot;SHELL=/bin/sh&quot;</span>);</span><br><span class="line">putenv((<span class="type">char</span> *) <span class="string">&quot;USER=root&quot;</span>); <span class="comment">/* needed? why? */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (argv[<span class="number">1</span>])</span><br><span class="line">xsetenv(<span class="string">&quot;RUNLEVEL&quot;</span>, argv[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@milkv-duo]/sbin<span class="comment"># printenv</span></span><br><span class="line">USER=root</span><br><span class="line">HOSTNAME=milkv-duo</span><br><span class="line">SHLVL=1</span><br><span class="line">LD_LIBRARY_PATH=/mnt/system/lib:/mnt/system/usr/lib</span><br><span class="line">HOME=/root</span><br><span class="line">OLDPWD=/root</span><br><span class="line">TERMINFO=/usr/share/terminfo</span><br><span class="line">PAGER=/bin/more</span><br><span class="line">PS1=[\u@\h]\w\$</span><br><span class="line">LOGNAME=root</span><br><span class="line">TERM=vt100</span><br><span class="line">PATH=/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:/mnt/system/usr/bin:/mnt/system/usr/sbin</span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PWD=/sbin</span><br><span class="line">EDITOR=/bin/vi</span><br></pre></td></tr></table></figure><p>éå•ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œè¯»å– &#x2F;etc&#x2F;inittabã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if we are supposed to be in single user mode */</span></span><br><span class="line"><span class="keyword">if</span> (argv[<span class="number">1</span>]</span><br><span class="line"> &amp;&amp; (<span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;single&quot;</span>) == <span class="number">0</span> || <span class="built_in">strcmp</span>(argv[<span class="number">1</span>], <span class="string">&quot;-s&quot;</span>) == <span class="number">0</span> || LONE_CHAR(argv[<span class="number">1</span>], <span class="string">&#x27;1&#x27;</span>))</span><br><span class="line">) &#123;</span><br><span class="line"><span class="comment">/* ??? shouldn&#x27;t we set RUNLEVEL=&quot;b&quot; here? */</span></span><br><span class="line"><span class="comment">/* Start a shell on console */</span></span><br><span class="line">new_init_action(RESPAWN, bb_default_login_shell, <span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Not in single user mode - see what inittab says */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* NOTE that if CONFIG_FEATURE_USE_INITTAB is NOT defined,</span></span><br><span class="line"><span class="comment"> * then parse_inittab() simply adds in some default</span></span><br><span class="line"><span class="comment"> * actions (i.e., INIT_SCRIPT and a pair</span></span><br><span class="line"><span class="comment"> * of &quot;askfirst&quot; shells) */</span></span><br><span class="line">parse_inittab();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://elixir.bootlin.com/busybox/1.36.1/source/init/init.c#L1248">https://elixir.bootlin.com/busybox/1.36.1/source/init/init.c#L1248</a><br>å³ä½¿æ²¡æœ‰ &#x2F;etc&#x2F;inittab æ–‡ä»¶ï¼Œä¹Ÿæœ‰é»˜è®¤é…ç½®ã€‚<br>è¿™ä¸ªæ–‡ä»¶éå¸¸é‡è¦ğŸ’¥ğŸ’¥ï¼Œè¿™æ˜¯åªå…³æ³¨ action å’Œ process<br>Valid actions include: <strong>sysinit, respawn, askfirst, wait, once, restart, ctrlaltdel, and shutdown</strong>.\nâ€</p><p><strong>Run only-once actions:</strong></p><ul><li>sysinit: â€˜sysinitâ€™ is the first item run on boot. init waits until all sysinit actions are completed before continuing.</li><li>wait: then all â€˜waitâ€™ actions are run. waitâ€™ actions, like â€˜sysinitâ€™ actions, cause init to wait until the specified task completes.</li><li>once: â€˜onceâ€™ actions are asynchronous, therefore, init does not wait for them to complete.</li><li>restart: â€˜restartâ€™ is the action taken to restart the init process. By default this should simply run &#x2F;sbin&#x2F;init, but can be a script which runs pivot_root or it can do all sorts of other interesting things.</li><li>ctrlaltdel: run when the system detects that someone on the system console has pressed the CTRL-ALT-DEL key combination. Typically one wants to run â€˜rebootâ€™ at this point to cause the system to reboot.</li><li>shutdown: Finally the â€˜shutdownâ€™ action specifies the actions to taken when init is told to reboot. Unmounting filesystems and disabling swap is a very good here.</li></ul><p><strong>Run repeatedly actions</strong>:</p><ul><li>respawn: â€˜respawnâ€™ actions are run after the â€˜onceâ€™ actions. When a process started with a â€˜respawnâ€™ action exits, init automatically restarts it. Unlike sysvinit, BusyBox init does not stop processes from respawning out of control. emmm å°±æ˜¯ ctrl+d æ—¶åˆé‡æ–°æœ‰ç™»é™†å—ï¼Ÿ</li><li>askfirst: The â€˜askfirstâ€™ actions acts just like respawn, except that before running the specified process it displays the line &quot;Please press Enter to activate this console.&quot; and then waits for the user to press enter before starting the specified process.</li></ul></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//usage:&quot;BusyBox init works just fine without an inittab. If no inittab is found,\n&quot;</span><br><span class="line">//usage:&quot;it has the following default behavior:\n&quot;</span><br><span class="line">//usage:&quot;\n&quot;</span><br><span class="line">//usage:&quot;::sysinit:/etc/init.d/rcS\n&quot;</span><br><span class="line">//usage:&quot;::askfirst:/bin/sh\n&quot;</span><br><span class="line">//usage:&quot;::ctrlaltdel:/sbin/reboot\n&quot;</span><br><span class="line">//usage:&quot;::shutdown:/sbin/swapoff -a\n&quot;</span><br><span class="line">//usage:&quot;::shutdown:/bin/umount -a -r\n&quot;</span><br><span class="line">//usage:&quot;::restart:/sbin/init\n&quot;</span><br><span class="line">//usage:&quot;tty2::askfirst:/bin/sh\n&quot;</span><br><span class="line">//usage:&quot;tty3::askfirst:/bin/sh\n&quot;</span><br><span class="line">//usage:&quot;tty4::askfirst:/bin/sh\n&quot;</span><br><span class="line">//usage:&quot;\n&quot;</span><br><span class="line">//usage:&quot;If you choose to use an /etc/inittab file, the inittab entry format is as follows:\n&quot;</span><br><span class="line">//usage:&quot;\n&quot;</span><br><span class="line">//usage:&quot;&lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;\n&quot;</span><br></pre></td></tr></table></figure><p>demo in ramdisk&#x2F;rootfs&#x2F;common_musl_riscv64&#x2F;etc&#x2F;inittab</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># Format for each entry: &lt;id&gt;:&lt;runlevels&gt;:&lt;action&gt;:&lt;process&gt;</span><br><span class="line">#</span><br><span class="line"># id        == tty to run on, or empty for /dev/console</span><br><span class="line"># runlevels == ignored</span><br><span class="line"># action    == one of sysinit, respawn, askfirst, wait, and once</span><br><span class="line"># process   == program to run</span><br><span class="line"></span><br><span class="line"># Startup the system</span><br><span class="line">::sysinit:/sbin/mdev -s</span><br><span class="line">::sysinit:/bin/mkdir -p /dev/pts</span><br><span class="line">::sysinit:/bin/mkdir -p /dev/shm</span><br><span class="line">::sysinit:/bin/mount -a</span><br><span class="line">null::sysinit:/bin/hostname -F /etc/hostname</span><br><span class="line"></span><br><span class="line"># now run any rc scripts</span><br><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line"></span><br><span class="line"># now run any post scripts</span><br><span class="line">::sysinit:/etc/init.d/rcP</span><br><span class="line"></span><br><span class="line"># Put a getty on the serial port</span><br><span class="line">console::respawn:/sbin/getty -L  console 115200 vt100 -n -l /usr/local/bin/autologin</span><br><span class="line"></span><br><span class="line"># Stuff to do for the 3-finger salute</span><br><span class="line">::ctrlaltdel:/sbin/reboot</span><br><span class="line"></span><br><span class="line"># Stuff to do before rebooting</span><br><span class="line">::shutdown:/etc/init.d/rcK</span><br><span class="line">::shutdown:/sbin/swapoff -a</span><br><span class="line">::shutdown:/bin/umount -a -r</span><br></pre></td></tr></table></figure><p>é¡ºåºæ‰§è¡Œ &#x2F;etc&#x2F;inittab ä¸­çš„äº‹æƒ…ã€‚All actions are run in the order they appear in &#x2F;etc&#x2F;inittab.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Now run everything that needs to be run */</span></span><br><span class="line"><span class="comment">/* First run the sysinit command */</span></span><br><span class="line">run_actions(SYSINIT);</span><br><span class="line">check_delayed_sigs(&amp;G.zero_ts);</span><br><span class="line"><span class="comment">/* Next run anything that wants to block */</span></span><br><span class="line">run_actions(WAIT);</span><br><span class="line">check_delayed_sigs(&amp;G.zero_ts);</span><br><span class="line"><span class="comment">/* Next run anything to be run only once */</span></span><br><span class="line">run_actions(ONCE);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>SYSINIT | WAIT | CTRLALTDEL | SHUTDOWN</code> 4 ç§ç±»å‹çš„ä»»åŠ¡éƒ½æ˜¯é˜»å¡çš„ï¼Œç­‰ä¸€ä¸ªå‘½ä»¤æ‰§è¡Œå®Œæ‰ä¼šç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Run all commands of a particular type */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">run_actions</span><span class="params">(<span class="type">int</span> action_type)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">init_action</span> *<span class="title">a</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (a = G.init_action_list; a; a = a-&gt;next) &#123;</span><br><span class="line"><span class="keyword">if</span> (!(a-&gt;action_type &amp; action_type))</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (a-&gt;action_type &amp; (SYSINIT | WAIT | ONCE | CTRLALTDEL | SHUTDOWN)) &#123;</span><br><span class="line"><span class="type">pid_t</span> pid = run(a);</span><br><span class="line"><span class="keyword">if</span> (a-&gt;action_type &amp; (SYSINIT | WAIT | CTRLALTDEL | SHUTDOWN))</span><br><span class="line">waitfor(pid);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (a-&gt;action_type &amp; (RESPAWN | ASKFIRST)) &#123;</span><br><span class="line"><span class="comment">/* Only run stuff with pid == 0. If pid != 0,</span></span><br><span class="line"><span class="comment"> * it is already running</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (a-&gt;pid == <span class="number">0</span>)</span><br><span class="line">a-&gt;pid = run(a);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº init è¿›ç¨‹ä¸»è¦æ˜¯é€šè¿‡ä¿¡å·æ¥å¤„ç†æ¶ˆæ¯ï¼Œinit è¿›ç¨‹æœ¬èº«å¹¶ä¸ä¼šé€€å‡ºï¼Œè€Œæ˜¯é˜»å¡ä¼‘çœ ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Now run the looping stuff for the rest of forever */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">/* (Re)run the respawn/askfirst stuff */</span></span><br><span class="line">run_actions(RESPAWN | ASKFIRST);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Wait for any signal (typically it&#x27;s SIGCHLD) */</span></span><br><span class="line">â›”â›”â›”â›” å°±è¿™é‡Œæ˜¯é˜»å¡ï¼Œç›´åˆ°æœ‰ä¿¡å·åˆ°æ¥ã€‚</span><br><span class="line">check_delayed_sigs(<span class="literal">NULL</span>); <span class="comment">/* NULL timespec makes it wait */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Wait for any child process(es) to exit */</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="type">pid_t</span> wpid;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">init_action</span> *<span class="title">a</span>;</span></span><br><span class="line"></span><br><span class="line">wpid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG);</span><br><span class="line"><span class="keyword">if</span> (wpid &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">a = mark_terminated(wpid);</span><br><span class="line"><span class="keyword">if</span> (a) &#123;</span><br><span class="line">message(L_LOG, <span class="string">&quot;process &#x27;%s&#x27; (pid %u) exited. &quot;</span></span><br><span class="line"><span class="string">&quot;Scheduling for restart.&quot;</span>,</span><br><span class="line">a-&gt;command, (<span class="type">unsigned</span>)wpid);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Don&#x27;t consume all CPU time - sleep a bit */</span></span><br><span class="line">sleep1();</span><br><span class="line">&#125; <span class="comment">/* while (1) */</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">check_delayed_sigs</span><span class="params">(<span class="keyword">struct</span> timespec *ts)</span></span><br><span class="line">&#123;</span><br><span class="line">â›”â›”â›”â›”â›”â›”â›”â›”â›”â›” å°±è¿™é‡Œæ˜¯é˜»å¡ï¼Œç›´åˆ°æœ‰ä¿¡å·åˆ°æ¥ã€‚</span><br><span class="line"><span class="type">int</span> sig = sigtimedwait(&amp;G.delayed_sigset, <span class="comment">/* siginfo_t */</span> <span class="literal">NULL</span>, ts);</span><br><span class="line"><span class="keyword">if</span> (sig &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* The signal &quot;sig&quot; was caught */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENABLE_FEATURE_USE_INITTAB</span></span><br><span class="line"><span class="keyword">if</span> (sig == SIGHUP)</span><br><span class="line">reload_inittab();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">ä¸åŒä¿¡å·ï¼Œä¸åŒå¤„ç†ã€‚</span><br><span class="line"><span class="keyword">if</span> (sig == SIGINT)</span><br><span class="line">run_actions(CTRLALTDEL);</span><br><span class="line"><span class="keyword">if</span> (sig == SIGQUIT) &#123;</span><br><span class="line">exec_restart_action();</span><br><span class="line"><span class="comment">/* returns only if no restart action defined */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((<span class="number">1</span> &lt;&lt; sig) &amp; (<span class="number">0</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> SIGPWR</span></span><br><span class="line">    | (<span class="number">1</span> &lt;&lt; SIGPWR)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    | (<span class="number">1</span> &lt;&lt; SIGUSR1)</span><br><span class="line">    | (<span class="number">1</span> &lt;&lt; SIGUSR2)</span><br><span class="line">    | (<span class="number">1</span> &lt;&lt; SIGTERM)</span><br><span class="line">)) &#123;</span><br><span class="line"><span class="comment">/* reboot, poweroff, or halt */</span></span><br><span class="line">halt_reboot_pwoff(sig);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* if (sig == SIGCHLD) do nothing */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">halt_reboot_pwoff</span><span class="params">(<span class="type">int</span> sig)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *m;</span><br><span class="line"><span class="type">unsigned</span> rb;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* We may call run() and it unmasks signals,</span></span><br><span class="line"><span class="comment"> * including the one masked inside this signal handler.</span></span><br><span class="line"><span class="comment"> * Testcase which would start multiple reboot scripts:</span></span><br><span class="line"><span class="comment"> *  while true; do reboot; done</span></span><br><span class="line"><span class="comment"> * Preventing it:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">reset_sighandlers_and_unblock_sigs();</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/busybox/1.36.1/source/init/init.c#L758</span></span><br><span class="line">    <span class="comment">// run_actions(SHUTDOWN); è¿™é‡Œè¿è¡Œ inittab ä¸­å®šä¹‰çš„ shutdown  ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢ğŸ“¢</span></span><br><span class="line"><span class="comment">// kill(-1, SIGTERM);</span></span><br><span class="line">    <span class="comment">// kill(-1, SIGKILL);</span></span><br><span class="line">    <span class="comment">// å»¶æ—¶åå†æ¬¡å‘é€SIGKILLä¿¡å·ï¼Œè¿™é‡Œè¯´æ˜ä¸€ä¸‹ä¸ºä»€ä¹ˆè¦å‘é€SIGKILLä¿¡å·ï¼Œä¸€èˆ¬çš„SIGINTå’ŒSIGTERMä¿¡å·éƒ½å¯ä»¥å±è”½æˆ–è½¬ä½œä»–ç”¨ï¼ŒSIGKILLä¿¡å·æ˜¯ä¸å¯è¢«å±è”½çš„ï¼Œ</span></span><br><span class="line">run_shutdown_and_kill_processes();</span><br><span class="line"></span><br><span class="line">m = <span class="string">&quot;halt&quot;</span>;</span><br><span class="line">rb = RB_HALT_SYSTEM;</span><br><span class="line"><span class="keyword">if</span> (sig == SIGTERM) &#123;</span><br><span class="line">m = <span class="string">&quot;reboot&quot;</span>;</span><br><span class="line">rb = RB_AUTOBOOT;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (sig == SIGUSR2) &#123;</span><br><span class="line">m = <span class="string">&quot;poweroff&quot;</span>;</span><br><span class="line">rb = RB_POWER_OFF;</span><br><span class="line">&#125;</span><br><span class="line">message(L_CONSOLE, <span class="string">&quot;Requesting system %s&quot;</span>, m);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">pause_and_low_level_reboot(rb); <span class="comment">// reboot(magic);</span></span><br><span class="line"><span class="comment">/* not reached */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="åº“å‡½æ•°-musl-clib"><a href="#åº“å‡½æ•°-musl-clib" class="headerlink" title="åº“å‡½æ•° musl clib"></a>åº“å‡½æ•° musl clib</h3><p><a href="https://elixir.bootlin.com/musl/v1.2.5/source/src/linux/reboot.c#L4">https://elixir.bootlin.com/musl/v1.2.5/source/src/linux/reboot.c#L4</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">type:</span><br><span class="line"><span class="comment">/* Perform a hard reset now.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_AUTOBOOT0x01234567</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Halt the system.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_HALT_SYSTEM0xcdef0123</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Enable reboot using Ctrl-Alt-Delete keystroke.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_ENABLE_CAD0x89abcdef</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Disable reboot using Ctrl-Alt-Delete keystroke.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_DISABLE_CAD0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Stop system and switch power off if possible.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_POWER_OFF0x4321fedc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Suspend system using software suspend.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_SW_SUSPEND0xd000fce2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Reboot system into new kernel.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_KEXEC0x45584543</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">reboot</span><span class="params">(<span class="type">int</span> type)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> syscall(SYS_reboot, <span class="number">0xfee1dead</span>, <span class="number">672274793</span>, type);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†…æ ¸å®ç°"><a href="#å†…æ ¸å®ç°" class="headerlink" title="å†…æ ¸å®ç°"></a>å†…æ ¸å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/reboot.c https://elixir.bootlin.com/linux/v5.10.186/source/kernel/reboot.c#L310</span></span><br><span class="line">SYSCALL_DEFINE4(reboot, <span class="type">int</span>, magic1, <span class="type">int</span>, magic2, <span class="type">unsigned</span> <span class="type">int</span>, cmd,</span><br><span class="line"><span class="type">void</span> __user *, arg)</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* Instead of trying to make the power_off code look like</span></span><br><span class="line"><span class="comment"> * halt when pm_power_off is not set do it the easy way.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((cmd == LINUX_REBOOT_CMD_POWER_OFF) &amp;&amp; !pm_power_off)</span><br><span class="line">cmd = LINUX_REBOOT_CMD_HALT;</span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;system_transition_mutex);</span><br><span class="line"><span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line"><span class="keyword">case</span> LINUX_REBOOT_CMD_RESTART: <span class="comment">// restart</span></span><br><span class="line">kernel_restart(<span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> LINUX_REBOOT_CMD_HALT:</span><br><span class="line">kernel_halt();</span><br><span class="line">do_exit(<span class="number">0</span>);</span><br><span class="line">panic(<span class="string">&quot;cannot halt&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> LINUX_REBOOT_CMD_POWER_OFF:</span><br><span class="line">kernel_power_off();</span><br><span class="line">do_exit(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> LINUX_REBOOT_CMD_RESTART2: <span class="comment">// è¿™ä¸ªå¸¦ buffer ?</span></span><br><span class="line">ret = strncpy_from_user(&amp;buffer[<span class="number">0</span>], arg, <span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">ret = -EFAULT;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">buffer[<span class="keyword">sizeof</span>(buffer) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">kernel_restart(buffer);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">kernel_restart_prepare</span><span class="params">(<span class="type">char</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">blocking_notifier_call_chain(&amp;reboot_notifier_list, SYS_RESTART, cmd);</span><br><span class="line">system_state = SYSTEM_RESTART;</span><br><span class="line">usermodehelper_disable();</span><br><span class="line">device_shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * syscore_shutdown - Execute all the registered system core shutdown callbacks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">syscore_shutdown</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">syscore_ops</span> *<span class="title">ops</span>;</span></span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;syscore_ops_lock);</span><br><span class="line"></span><br><span class="line">list_for_each_entry_reverse(ops, &amp;syscore_ops_list, node)</span><br><span class="line"><span class="keyword">if</span> (ops-&gt;shutdown) &#123;</span><br><span class="line"><span class="keyword">if</span> (initcall_debug)</span><br><span class="line">pr_info(<span class="string">&quot;PM: Calling %pS\n&quot;</span>, ops-&gt;shutdown);</span><br><span class="line">ops-&gt;shutdown();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mutex_unlock(&amp;syscore_ops_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">kernel_restart</span><span class="params">(<span class="type">char</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">kernel_restart_prepare(cmd);</span><br><span class="line">migrate_to_reboot_cpu();</span><br><span class="line">syscore_shutdown();</span><br><span class="line"><span class="keyword">if</span> (!cmd)</span><br><span class="line">pr_emerg(<span class="string">&quot;Restarting system\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">pr_emerg(<span class="string">&quot;Restarting system with command &#x27;%s&#x27;\n&quot;</span>, cmd);</span><br><span class="line">kmsg_dump(KMSG_DUMP_SHUTDOWN);</span><br><span class="line">machine_restart(cmd);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// arch/riscv/kernel/reset.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">machine_restart</span><span class="params">(<span class="type">char</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line">do_kernel_restart(cmd);</span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *do_kernel_restart - Execute kernel restart handler call chain</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Calls functions registered with register_restart_handler.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Expected to be called from machine_restart as last step of the restart</span></span><br><span class="line"><span class="comment"> *sequence.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Restarts the system immediately if a restart handler function has been</span></span><br><span class="line"><span class="comment"> *registered. Otherwise does nothing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">do_kernel_restart</span><span class="params">(<span class="type">char</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// è¿™é‡Œå°±ä¼šè°ƒç”¨åˆ°</span></span><br><span class="line">atomic_notifier_call_chain(&amp;restart_handler_list, reboot_mode, cmd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå°±ä¼šè°ƒç”¨åˆ° <a href="#reboot/poweroff">reboot&#x2F;poweroff</a> ä¸­æ³¨å†Œçš„å¤„ç†å‡½æ•°äº†.</p><p>çœ‹ datasheet . <a href="https://github.com/sophgo/sophgo-doc/releases/tag/sg2002-trm-v1.01">https://github.com/sophgo/sophgo-doc/releases/tag/sg2002-trm-v1.01</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// reg = &lt;0x0 0x05025000 0x0 0x2000&gt;;</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">cvi_restart_handler</span><span class="params">(<span class="keyword">struct</span> notifier_block *this,</span></span><br><span class="line"><span class="params"><span class="type">unsigned</span> <span class="type">long</span> mode, <span class="type">void</span> *cmd)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">void</span> __iomem *REG_RTC_CTRL_BASE = base;</span><br><span class="line"><span class="type">void</span> __iomem *REG_RTC_BASE = base + <span class="number">0x1000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Enable power suspend wakeup source mask */</span></span><br><span class="line"><span class="comment">// rtcsys_clkdiv 0x03c</span></span><br><span class="line">writel(<span class="number">0x1</span>, REG_RTC_BASE + <span class="number">0x3C</span>); <span class="comment">// 1 = select prdata from 32K domain</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rtc_ctrl_unlockkey 0x004</span></span><br><span class="line">writel(<span class="number">0xAB18</span>, REG_RTC_CTRL_BASE + RTC_CTRL0_UNLOCKKEY);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿™ä¸ªdatasheet ä¸Šæ²¡æœ‰ 0x0cc</span></span><br><span class="line">writel(<span class="number">0x1</span>, REG_RTC_BASE + RTC_EN_WARM_RST_REQ);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (readl(REG_RTC_BASE + RTC_EN_WARM_RST_REQ) != <span class="number">0x01</span>)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (readl(REG_RTC_BASE + RSM_STATE) != ST_ON)</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">writel(<span class="number">0xFFFF0800</span> | (<span class="number">0x1</span> &lt;&lt; <span class="number">4</span>), REG_RTC_CTRL_BASE + RTC_CTRL0);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> NOTIFY_DONE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®—äº†ï¼Œä¸ç®¡äº†ï¼Œè¿™é‡Œçœ‹èµ·æ¥å°±æ˜¯æœ€åçš„ä¸€æ­¥äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Cvitek </tag>
            
            <tag> reboot </tag>
            
            <tag> poweroff </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux USB é©±åŠ¨æ¡†æ¶</title>
      <link href="/2024/09/01/Linux-USB%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/"/>
      <url>/2024/09/01/Linux-USB%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/</url>
      
        <content type="html"><![CDATA[<p>depends on:</p><ul><li><input disabled="" type="checkbox"> bus é€šç”¨çŸ¥è¯†</li><li><input disabled="" type="checkbox"> uevent æœºåˆ¶</li><li><input disabled="" type="checkbox"> å­—ç¬¦è®¾å¤‡</li></ul><h2 id="USB-é©±åŠ¨æ¡†æ¶"><a href="#USB-é©±åŠ¨æ¡†æ¶" class="headerlink" title="USB é©±åŠ¨æ¡†æ¶"></a>USB é©±åŠ¨æ¡†æ¶</h2><p>å¾ˆå…¸å‹çš„Linux é©±åŠ¨æ¡†æ¶ï¼Œåˆ†</p><ul><li>æ ¸å¿ƒå±‚ï¼šå®Œæˆé€šç”¨åŠŸèƒ½ã€‚</li><li>è®¾å¤‡é©±åŠ¨å±‚ PDDï¼ˆå®ç°ç‰¹å®šåŠŸèƒ½ï¼Œæ¯”å¦‚ UVCï¼Œ UACï¼Œ HID è¿™äº›ç±»å‹çš„è®¾å¤‡é©±åŠ¨ï¼‰</li><li>æ§åˆ¶å™¨é©±åŠ¨ HCDï¼ˆé…ç½®å¯„å­˜å™¨å»æ“ä½œç¡¬ä»¶USB IPï¼Œå®Œæˆæ•°æ®æ”¶å‘ï¼‰ç±»ä¼¼ä¸ç½‘ç»œä¸­çš„æ•°æ®é“¾è·¯å±‚ï¼Œåªè´Ÿè´£æ•°æ®æ”¶å‘ã€‚</li></ul><p><img src="/../images/Linux-USB%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/image-20240901105545261.png" alt="image-20240901105545261"></p><blockquote><p>image from paper <USBIP a transparent device sharing technolog over ip network></p><p>è¿™æ®µ USB Driver Architecture è®²å¾—å¾ˆå¥½ã€‚</p><p>USB (Universal Serial Bus) 17) is one of the sophisticated peripheral interfaces based on the recent hardware progress. In the USB 2.0 speciï¬cation announced in April 2000, a host computer controls various USB devices with 3 transfer speeds (1.5 Mbps, 12.0 Mbps, and 480 Mbps) and 4 transfer types (Control, Bulk, Interrupt, and Isochronous). These transfers are serialized and controlled by a dedicated hardware function which is named USB Host Controller. Figure 1 shows the USB device driver model in most operating systems. A <strong>USB Host Controller Driver</strong> (USB HCD) exists in the lowest layer of the device driver stack and abstracts the I&#x2F;O interface of a host controller into a common API for USB device drivers. <strong>A USB PerDevice Drivers (USB PDD)</strong> is respon-sible for the control of each USB device. The key design of the USB driver stack is that a USB Host Controller and its USB HCD provide USB PDDs with abstracted data input&#x2F;output for I&#x2F;O buï¬€ers. Although a USB device and its USB PDD use the buï¬€er to transfer some control data and corresponding reply data, <strong>the USB HCD do not distinguish between control and reply</strong>.</p><p>In USB device drivers, a <strong>USB Request Block (URB)</strong> presents USB I&#x2F;O in a controller-independent form, which includes information about I&#x2F;O;</p><ul><li><strong>I&#x2F;O buï¬€er</strong></li><li>I&#x2F;O direction (Input&#x2F;Output)</li><li>I&#x2F;O speed (1.5 Mbps&#x2F;12 Mbps&#x2F;480 Mbps)</li><li>I&#x2F;O type (Control&#x2F;Bulk&#x2F;Interrupt&#x2F;Isochronous)</li><li>I&#x2F;O destination address</li><li><strong>completion handler</strong></li></ul><p>An application or a device driver controls a USB device as follows:</p><ol><li><strong>A USB PDD converts I&#x2F;O requests from another driver into URBs and submits these URBs to a USB HCD.</strong></li><li>The USB HCD transfers data as de-scribed by the URB.</li><li>After I&#x2F;O of the URB is completed, the completion handler of the URB is called in an interrupt context.</li><li>The USB PDD notiï¬es the upper driver of the requested I&#x2F;O completion.</li></ol><p>A USB device and its USB PDD use 4 diï¬€er- ent transfer types depending on characteristics of the device. <strong>Control and Bulk transfer types are asynchronously scheduled into the rest of the bandwidth after the periodical transfers</strong>. Control transfer is the most fundamental one for enumeration and initialization of devices. In 480 Mbps mode, <strong>20% of the bandwidth is reserved for Control transfer</strong>. Bulk transfer is used for the requests without any temporal re-striction, such as storage device I&#x2F;O, which is the fastest transfer when the bus is available. <strong>Isochronous and Interrupt transfer types are pe-riodically scheduled</strong>. Isochronous transfer can move control data at a constant bit rate, which is useful to read image data from a USB cam-era or to write sound data to a USB speaker. <strong>Interrupt transfer conï¬rms the maximum delay of the requested I&#x2F;O</strong>. This is used for USB mice and keyboards, which move a small amount of data sporadically.</p><p>note: UVC å‡ºæµçš„æ—¶å€™å‘ç°æœ€å¤§3ä¸ªè®¾å¤‡æ€»å¸¦å®½44MB æ²¡é—®é¢˜ï¼Œä½†48MB ä¼šæç¤ºèµ„æºä¸è¶³ã€‚æ€»å…± 480Mbps -&gt; 60MB -&gt; *80% -&gt; 48MB. ç†è®ºä¸Š 48Måˆšå¥½å¤Ÿï¼Œä¸è¿‡å…¶ä»–HUB ä¹‹ç±»çš„è®¾å¤‡å¯èƒ½ä¹Ÿä¼šå ä¸€ç‚¹å°±å¯¼è‡´ä¸å¤Ÿäº†ã€‚</p></blockquote><h3 id="ä»£ç é˜…è¯»æµç¨‹"><a href="#ä»£ç é˜…è¯»æµç¨‹" class="headerlink" title="ä»£ç é˜…è¯»æµç¨‹"></a>ä»£ç é˜…è¯»æµç¨‹</h3><ol><li><p><strong>ç¡®å®šæ ¸å¿ƒä»£ç </strong>ï¼ˆé€šè¿‡ .config + MAKEFILE + KCONFIGï¼‰</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> build/sg2002_wevb_riscv64_sd/.config | grep USB | grep <span class="string">&quot;=&quot;</span></span><br><span class="line">CONFIG_USB_OHCI_LITTLE_ENDIAN=y <span class="comment"># å¤§å°ç«¯ï¼Œä¸€èˆ¬éƒ½æ˜¯å°ç«¯</span></span><br><span class="line">CONFIG_USB_SUPPORT=y <span class="comment"># usb/phy ä¹Ÿæ˜¯ USB é©±åŠ¨çš„æ€»å¼€å…³</span></span><br><span class="line">CONFIG_USB_ARCH_HAS_HCD=y <span class="comment"># HOST CONTROLLERï¼Œè‚¯å®šå¾—é»˜è®¤Y</span></span><br><span class="line">CONFIG_USB_COMMON=y <span class="comment"># usb/common/usb-common.o</span></span><br><span class="line"></span><br><span class="line">CONFIG_USB_DEFAULT_PERSIST=y <span class="comment"># USBç”µæºä¼šè¯æŒä¹…æ€§</span></span><br><span class="line">CONFIG_USB_AUTOSUSPEND_DELAY=2 <span class="comment"># é»˜è®¤è‡ªåŠ¨ä¼‘çœ æ—¶é—´ï¼ˆ2Sï¼‰</span></span><br><span class="line">CONFIG_USB_ROLE_SWITCH=y <span class="comment"># æ”¯æŒè§’è‰² host/device åˆ‡æ¢ += usb/roles/roles.o</span></span><br><span class="line"></span><br><span class="line"><span class="comment">########## HOST ##########</span></span><br><span class="line">CONFIG_USB=y <span class="comment"># += usb/core usb/storage/ usb/misc/  Support for Host-side USB</span></span><br><span class="line"><span class="comment"># ä½œä¸º HOST æ—¶ç”¨ã€‚è¦ä½œä¸ºdeviceï¼Œåº”è¯¥çœ‹ USB Gadgetã€‚EHCI HCD ä»£è¡¨USB2.0ã€‚USB1.1æ˜¯ UHCIï¼ŒOHCI</span></span><br><span class="line"><span class="comment"># Say Y here if your computer has a host-side USB port and you want to use USB devices.  You then need to say Y to at least one of the Host Controller Driver (HCD) options below.  Choose a USB 1.1 controller, such as &quot;UHCI HCD support&quot; or &quot;OHCI HCD support&quot;, and &quot;EHCI HCD (USB 2.0) support&quot; except for older systems that do not have USB 2.0 support.  It doesn&#x27;t normally hurt to select them all if you are not certain.</span></span><br><span class="line"><span class="comment"># If your system has a device-side USB port, used in the peripheral side of the USB protocol, see the &quot;USB Gadget&quot; framework instead.</span></span><br><span class="line"><span class="comment">#### controller driver ####</span></span><br><span class="line">CONFIG_USB_DWC2=y           <span class="comment"># usb/dwc2/dwc2.o USB HCD é©±åŠ¨</span></span><br><span class="line">CONFIG_USB_DWC2_DUAL_ROLE=y <span class="comment"># æ”¯æŒä¸¤ç§è§’è‰²çš„å·¥ä½œæ¨¡å¼ï¼ˆhost/deviceï¼‰</span></span><br><span class="line"></span><br><span class="line"><span class="comment">########## DEVICE ##########</span></span><br><span class="line">CONFIG_USB_GADGET=y         <span class="comment"># += ä½œä¸ºUSBdeviceç”¨ã€‚usb/gadget udc/ function/ legacy/ udc/udc-core.o</span></span><br><span class="line">CONFIG_USB_GADGET_VBUS_DRAW=2 <span class="comment"># Maximum VBUS Power usage (2-500 mA)</span></span><br><span class="line">CONFIG_USB_GADGET_STORAGE_NUM_BUFFERS=2 <span class="comment"># Number of storage pipeline buffers</span></span><br><span class="line">CONFIG_USB_LIBCOMPOSITE=y   <span class="comment"># += usb/gadget/libcomposite.o  å¤åˆè®¾å¤‡é©±åŠ¨</span></span><br><span class="line">CONFIG_USB_F_ACM=y          <span class="comment"># += usb/gadget/function/usb_f_acm.o</span></span><br><span class="line">CONFIG_USB_U_SERIAL=y       <span class="comment"># += usb/gadget/function/u_serial.o</span></span><br><span class="line">CONFIG_USB_U_ETHER=y        <span class="comment"># += usb/gadget/function/u_ether.o</span></span><br><span class="line">CONFIG_USB_U_AUDIO=y        <span class="comment"># += usb/gadget/function/u_audio.o</span></span><br><span class="line">CONFIG_USB_F_SERIAL=y       <span class="comment"># += usb/gadget/function/usb_f_serial.o</span></span><br><span class="line">CONFIG_USB_F_ECM=y          <span class="comment"># += usb/gadget/function/f_ecm.o</span></span><br><span class="line">CONFIG_USB_F_EEM=y          <span class="comment"># += usb/gadget/function/f_eem.o</span></span><br><span class="line">CONFIG_USB_F_RNDIS=y        <span class="comment"># += usb/gadget/function/usb_f_rndis.o</span></span><br><span class="line">CONFIG_USB_F_MASS_STORAGE=y <span class="comment"># += usb/gadget/function/usb_f_mass_storage.o</span></span><br><span class="line">CONFIG_USB_F_FS=y           <span class="comment"># += usb/gadget/function/usb_f_fs.o</span></span><br><span class="line">CONFIG_USB_F_UAC1=y         <span class="comment"># += usb/gadget/function/usb_f_uac1.o</span></span><br><span class="line">CONFIG_USB_F_UVC=y          <span class="comment"># += usb/gadget/function/usb_f_uvc.o</span></span><br><span class="line">CONFIG_USB_CONFIGFS=y       <span class="comment"># æ”¯æŒé€šè¿‡configfså¯¹åŠŸèƒ½è¿›è¡Œé…ç½® USB Gadget functions configurable through configfs</span></span><br><span class="line">CONFIG_USB_CONFIGFS_SERIAL=y <span class="comment"># Generic serial bulk in/out</span></span><br><span class="line">CONFIG_USB_CONFIGFS_ACM=y   <span class="comment"># Abstract Control Model (CDC ACM)</span></span><br><span class="line">CONFIG_USB_CONFIGFS_ECM=y   <span class="comment"># Ethernet Control Model (CDC ECM)</span></span><br><span class="line">CONFIG_USB_CONFIGFS_RNDIS=y <span class="comment"># RNDIS</span></span><br><span class="line">CONFIG_USB_CONFIGFS_EEM=y   <span class="comment"># Ethernet Emulation Model (EEM)</span></span><br><span class="line">CONFIG_USB_CONFIGFS_MASS_STORAGE=y <span class="comment"># Mass Storage</span></span><br><span class="line">CONFIG_USB_CONFIGFS_F_FS=y  <span class="comment"># Function filesystem (FunctionFS)</span></span><br><span class="line"><span class="comment"># The Function Filesystem (FunctionFS) lets one create USB composite functions in user space in the same way GadgetFS lets one create USB gadgets in user space.</span></span><br><span class="line">CONFIG_USB_CONFIGFS_F_UAC1=y <span class="comment"># Audio Class 1.0</span></span><br><span class="line">CONFIG_USB_CONFIGFS_F_UVC=y <span class="comment"># USB Webcam function</span></span><br><span class="line">CONFIG_USB_HID=y            <span class="comment"># hid/usbhid/usbhid.o å¹¶éæ‰€æœ‰çš„PDDé©±åŠ¨å®ç°éƒ½æ”¾åœ¨ usb ç›®å½•ä¸‹</span></span><br></pre></td></tr></table></figure><p> å†æŸ¥æ‰¾é…ç½®å¯¹åº”çš„ä»£ç ã€‚vscode ä¸­æœç´¢ï¼Œä»…æœç´¢ Makefile, Kconfig ã€‚<strong>æ³¨æ„æœç´¢æŠ€å·§</strong>ã€‚<br> <img src="/../images/Linux-USB%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/image-20240901121143789.png" alt="image-20240901121143789"></p></li></ol><h3 id="core-ç›®å½•"><a href="#core-ç›®å½•" class="headerlink" title="core ç›®å½•"></a>core ç›®å½•</h3><blockquote><p><a href="https://www.cnblogs.com/wen123456/p/14281890.html">https://www.cnblogs.com/wen123456/p/14281890.html</a></p></blockquote><p>é¦–å…ˆï¼Œå¯ä»¥é€šè¿‡ Makefile <strong>ç¡®å®šæˆ‘ä»¬éœ€è¦å…³æ³¨é‚£äº› .c æ–‡ä»¶</strong>ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ç”¨äº† CONFIG_USB  CONFIG_OFã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">usbcore-y := usb.o hub.o hcd.o urb.o message.o driver.o</span><br><span class="line">usbcore-y += config.o file.o buffer.o sysfs.o endpoint.o</span><br><span class="line">usbcore-y += devio.o notify.o generic.o quirks.o devices.o</span><br><span class="line">usbcore-y += phy.o port.o</span><br><span class="line">usbcore-<span class="variable">$(CONFIG_OF)</span>+= of.o</span><br><span class="line">obj-<span class="variable">$(CONFIG_USB)</span>+= usbcore.o</span><br></pre></td></tr></table></figure><p>ç¡®å®šå½“å‰ç›®å½•ä¸‹ä¼šç¼–è¯‘å¤šå°‘ä¸ªæ¨¡å— <code>ko</code>ï¼š</p><ol><li><p>é€šè¿‡åœ¨å½“å‰è·¯å¾„æœç´¢ <code>module_init/subsys_initcall</code> ç­‰æ¨¡å—åˆå§‹åŒ–å‡½æ•°ã€‚</p></li><li><p>é€šè¿‡ Kconfig æ–‡ä»¶ä¸­ <code>tristate</code>  çš„ä¸ªæ•°ã€‚åªæœ‰ä¸º tristate æ‰èƒ½ç¼–è¯‘ä¸º ko å½¢å¼åŠ è½½ã€‚int çš„ä¸€èˆ¬éƒ½åªæ˜¯ä»¥å®åˆ¤æ–­çš„å½¢å¼åµŒå…¥åœ¨ä»£ç ä¸­ï¼Œä¸è¿‡è¿™ä¸ªéç»å¯¹ã€‚</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">config USB_LEDS_TRIGGER_USBPORT</span><br><span class="line">tristate &quot;USB port LED trigger&quot;</span><br><span class="line">depends on USB &amp;&amp; LEDS_TRIGGERS</span><br><span class="line">help</span><br><span class="line">  This driver allows LEDs to be controlled by USB events. Enabling this</span><br><span class="line">  trigger allows specifying list of USB ports that should turn on LED</span><br><span class="line">  when some USB device gets connected.</span><br><span class="line"></span><br><span class="line">config USB_AUTOSUSPEND_DELAY</span><br><span class="line">int &quot;Default autosuspend delay&quot;</span><br><span class="line">depends on USB</span><br><span class="line">default 2</span><br><span class="line">help</span><br><span class="line">  The default autosuspend delay in seconds.  Can be overridden</span><br><span class="line">  with the usbcore.autosuspend command line or module parameter.</span><br><span class="line"></span><br><span class="line">  The default value Linux has always had is 2 seconds.  Change</span><br><span class="line">  this value if you want a different delay and cannot modify</span><br><span class="line">  the command line or module parameter.</span><br></pre></td></tr></table></figure></li></ol><p>æ€»ä¹‹ç›®å‰ç¡®è®¤äº† core ç›®å½•ä¸‹å¯ä»¥ç¼–è¯‘å‡ºä¸¤ä¸ª ko æ–‡ä»¶ã€‚<code>usbcore.ko</code> ä»¥åŠ <code>ledtrig-usbport.ko</code>.</p><p>ç¡®å®šæ¨¡å—ä¹‹åï¼Œå°±å¯ä»¥ä» module çš„init å‡½æ•°å»è¿½ä»£ç ã€‚è¿‡ç¨‹ä¸­è‡ªç„¶ä¼šçœ‹åˆ°ä»–è°ƒç”¨å…¶ä»– c æ–‡ä»¶çš„æ–¹æ³•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Init</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">usb_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"><span class="keyword">if</span> (usb_disabled()) &#123;</span><br><span class="line">pr_info(<span class="string">&quot;%s: USB support disabled\n&quot;</span>, usbcore_name);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">usb_init_pool_max(); <span class="comment">// USB é©±åŠ¨ä¸­ä¼šåˆ†é…dmaå†…å­˜æ± ï¼Œç¡®å®šå†…å­˜ä¸­å†…å­˜å—çš„æœ€å°çš„å¤§å°ï¼Œä¸ ARCH_KMALLOC_MINALIGN æœ‰å…³ã€‚</span></span><br><span class="line"></span><br><span class="line">usb_debugfs_init(); <span class="comment">// debugfs ä¸­å¢åŠ æ–‡ä»¶ï¼Œæ–¹ä¾¿è°ƒè¯•</span></span><br><span class="line"></span><br><span class="line">usb_acpi_register(); <span class="comment">// æ²¡é…ç½®ï¼Œæš‚æ—¶ä¸ç®¡</span></span><br><span class="line">retval = bus_register(&amp;usb_bus_type); <span class="comment">// USB æ€»çº¿æ³¨å†Œ</span></span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> bus_register_failed;</span><br><span class="line">retval = bus_register_notifier(&amp;usb_bus_type, &amp;usb_bus_nb); <span class="comment">// æ³¨å†Œå†…æ ¸é€šçŸ¥é“¾ï¼Œç”¨äºè®¾å¤‡å’Œæ¥å£æ³¨å†Œçš„é€šçŸ¥</span></span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> bus_notifier_failed;</span><br><span class="line">retval = usb_major_init(); <span class="comment">// ç”³è¯· major numberã€‚</span></span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> major_init_failed;</span><br><span class="line">retval = usb_register(&amp;usbfs_driver); <span class="comment">// æ³¨å†Œæ¥å£é©±åŠ¨ usbfs</span></span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> driver_register_failed;</span><br><span class="line">retval = usb_devio_init(); <span class="comment">// åˆå§‹åŒ–å­—ç¬¦è®¾å¤‡</span></span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> usb_devio_init_failed;</span><br><span class="line">retval = usb_hub_init(); <span class="comment">// æ³¨å†Œæ¥å£é©±åŠ¨ hub</span></span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line"><span class="keyword">goto</span> hub_init_failed;</span><br><span class="line">retval = usb_register_device_driver(&amp;usb_generic_driver, THIS_MODULE);</span><br><span class="line"><span class="keyword">if</span> (!retval)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢éƒ½æ˜¯äº›å¼‚å¸¸æƒ…å†µçš„æ¸…ç†è¿‡ç¨‹ã€‚</span></span><br><span class="line">usb_hub_cleanup();</span><br><span class="line">hub_init_failed:</span><br><span class="line">usb_devio_cleanup();</span><br><span class="line">usb_devio_init_failed:</span><br><span class="line">usb_deregister(&amp;usbfs_driver);</span><br><span class="line">driver_register_failed:</span><br><span class="line">usb_major_cleanup();</span><br><span class="line">major_init_failed:</span><br><span class="line">bus_unregister_notifier(&amp;usb_bus_type, &amp;usb_bus_nb);</span><br><span class="line">bus_notifier_failed:</span><br><span class="line">bus_unregister(&amp;usb_bus_type);</span><br><span class="line">bus_register_failed:</span><br><span class="line">usb_acpi_unregister();</span><br><span class="line">usb_debugfs_cleanup();</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="usb-debugfs-init"><a href="#usb-debugfs-init" class="headerlink" title="usb_debugfs_init"></a>usb_debugfs_init</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">usb_debugfs_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// åœ¨debugfs ä¸­åˆ›å»ºä¸€ä¸ª devices æ–‡ä»¶ã€‚æä¾›äº†ä¸¤ä¸ª fopsï¼šread &amp; llseek</span></span><br><span class="line">usb_devices_root = debugfs_create_file(<span class="string">&quot;devices&quot;</span>, <span class="number">0444</span>, usb_debug_root,</span><br><span class="line">       <span class="literal">NULL</span>, &amp;usbfs_devices_fops);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// core/devices.c</span></span><br><span class="line"><span class="comment">// read æ–¹æ³•ä¼šéå†æ€»çº¿ï¼Œç„¶ådumpæ¯ä¸€ä¸ªè®¾å¤‡çš„ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">usb_device_read</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">char</span> __user *buf,</span></span><br><span class="line"><span class="params">       <span class="type">size_t</span> nbytes, <span class="type">loff_t</span> *ppos)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_bus</span> *<span class="title">bus</span>;</span></span><br><span class="line"><span class="type">ssize_t</span> ret, total_written = <span class="number">0</span>;</span><br><span class="line"><span class="type">loff_t</span> skip_bytes = *ppos;</span><br><span class="line"><span class="type">int</span> id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (*ppos &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (nbytes &lt;= <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">mutex_lock(&amp;usb_bus_idr_lock);</span><br><span class="line"><span class="comment">/* print devices for all busses */</span></span><br><span class="line">idr_for_each_entry(&amp;usb_bus_idr, bus, id) &#123;</span><br><span class="line"><span class="comment">/* recurse through all children of the root hub */</span></span><br><span class="line"><span class="keyword">if</span> (!bus_to_hcd(bus)-&gt;rh_registered)</span><br><span class="line"><span class="keyword">continue</span>;</span><br><span class="line">usb_lock_device(bus-&gt;root_hub);</span><br><span class="line"><span class="comment">// è¿™é‡Œ dump æ–¹æ³•å°†è®¾å¤‡ä¿¡æ¯å†™å…¥åˆ° buf ä¸­ï¼Œä¼ é€’ç»™ user-space</span></span><br><span class="line">ret = usb_device_dump(&amp;buf, &amp;nbytes, &amp;skip_bytes, ppos,</span><br><span class="line">      bus-&gt;root_hub, bus, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">usb_unlock_device(bus-&gt;root_hub);</span><br><span class="line"><span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">mutex_unlock(&amp;usb_bus_idr_lock);</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">total_written += ret;</span><br><span class="line">&#125;</span><br><span class="line">mutex_unlock(&amp;usb_bus_idr_lock);</span><br><span class="line"><span class="keyword">return</span> total_written;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">usbfs_devices_fops</span> =</span> &#123;</span><br><span class="line">.llseek =no_seek_end_llseek,</span><br><span class="line">.read =usb_device_read,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// common/common.c</span></span><br><span class="line"><span class="comment">// common å·²ç»æ˜¯å¦ä¸€ä¸ª module é‡Œé¢çš„ä»£ç äº†ï¼Œæ‰€ä»¥usbcore.koåŠ è½½ä¹‹å‰å¿…é¡»å…ˆåŠ è½½è¿™ä¸ª common.ko</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">usb_debug_root</span>;</span></span><br><span class="line">EXPORT_SYMBOL_GPL(usb_debug_root);</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">usb_common_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// debugfs ä¸­åˆ›å»ºä¸€ä¸ª usb ç›®å½•</span></span><br><span class="line">usb_debug_root = debugfs_create_dir(<span class="string">&quot;usb&quot;</span>, <span class="literal">NULL</span>);</span><br><span class="line">ledtrig_usb_init();</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="bus-register"><a href="#bus-register" class="headerlink" title="bus_register"></a>bus_register</h4><p>æ€»çº¿å˜›ï¼š<strong>ä¸€è¾¹è®¾å¤‡ï¼Œä¸€è¾¹é©±åŠ¨ï¼Œå®Œæˆè®¾å¤‡å’Œé©±åŠ¨çš„åŒ¹é…è¿‡ç¨‹</strong>ã€‚</p><p>æ— è®ºæ˜¯æœ‰è®¾å¤‡æ³¨å†Œã€è¿˜æ˜¯é©±åŠ¨åŠ è½½ï¼Œæ€»çº¿éƒ½è°ƒç”¨ <code>match</code> æ–¹æ³•å»åŒ¹é…ã€‚</p><p><code>uevent</code> æ–¹æ³•ï¼Œä¼šåœ¨è®¾å¤‡æ³¨å†Œæ—¶è°ƒç”¨ï¼Œå¯ä»¥ç»™åº”ç”¨å±‚ä¸ŠæŠ¥ä¿¡æ¯ï¼Œé€šçŸ¥æœ‰è®¾å¤‡æ’å…¥ä¹‹ç±»çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">retval = bus_register(&amp;usb_bus_type);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bus_type</span> <span class="title">usb_bus_type</span> =</span> &#123;</span><br><span class="line">.name =<span class="string">&quot;usb&quot;</span>,</span><br><span class="line">.match =usb_device_match,</span><br><span class="line">.uevent =usb_uevent,</span><br><span class="line">.need_parent_lock =<span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾å¤‡ä¸é©±åŠ¨çš„åŒ¹é…å®ç°ï¼Œåé¢å†ç»†çœ‹å§ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">usb_device_match</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> device_driver *drv)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">/* devices and interfaces are handled separately */</span></span><br><span class="line"><span class="keyword">if</span> (is_usb_device(dev)) &#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device</span> *<span class="title">udev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device_driver</span> *<span class="title">udrv</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* interface drivers never match devices */</span></span><br><span class="line"><span class="keyword">if</span> (!is_usb_device_driver(drv))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">udev = to_usb_device(dev);</span><br><span class="line">udrv = to_usb_device_driver(drv);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the device driver under consideration does not have a</span></span><br><span class="line"><span class="comment"> * id_table or a match function, then let the driver&#x27;s probe</span></span><br><span class="line"><span class="comment"> * function decide.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!udrv-&gt;id_table &amp;&amp; !udrv-&gt;match)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> usb_driver_applicable(udev, udrv);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_usb_interface(dev)) &#123;</span><br><span class="line"><span class="keyword">struct</span> usb_interface *intf;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_driver</span> *<span class="title">usb_drv</span>;</span></span><br><span class="line"><span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_id</span> *<span class="title">id</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* device drivers never match interfaces */</span></span><br><span class="line"><span class="keyword">if</span> (is_usb_device_driver(drv))</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">intf = to_usb_interface(dev);</span><br><span class="line">usb_drv = to_usb_driver(drv);</span><br><span class="line"></span><br><span class="line">id = usb_match_id(intf, usb_drv-&gt;id_table);</span><br><span class="line"><span class="keyword">if</span> (id)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">id = usb_match_dynamic_id(intf, usb_drv);</span><br><span class="line"><span class="keyword">if</span> (id)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡ uevent æœºåˆ¶ä¸ŠæŠ¥è®¾å¤‡ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">usb_uevent</span><span class="params">(<span class="keyword">struct</span> device *dev, <span class="keyword">struct</span> kobj_uevent_env *env)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device</span> *<span class="title">usb_dev</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_usb_device(dev)) &#123;</span><br><span class="line">usb_dev = to_usb_device(dev);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (is_usb_interface(dev)) &#123;</span><br><span class="line"><span class="keyword">struct</span> usb_interface *intf = to_usb_interface(dev);</span><br><span class="line"></span><br><span class="line">usb_dev = interface_to_usbdev(intf);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (usb_dev-&gt;devnum &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* driver is often null here; dev_dbg() would oops */</span></span><br><span class="line">pr_debug(<span class="string">&quot;usb %s: already deleted?\n&quot;</span>, dev_name(dev));</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!usb_dev-&gt;bus) &#123;</span><br><span class="line">pr_debug(<span class="string">&quot;usb %s: bus removed?\n&quot;</span>, dev_name(dev));</span><br><span class="line"><span class="keyword">return</span> -ENODEV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* per-device configurations are common */</span></span><br><span class="line"><span class="keyword">if</span> (add_uevent_var(env, <span class="string">&quot;PRODUCT=%x/%x/%x&quot;</span>,</span><br><span class="line">   le16_to_cpu(usb_dev-&gt;descriptor.idVendor),</span><br><span class="line">   le16_to_cpu(usb_dev-&gt;descriptor.idProduct),</span><br><span class="line">   le16_to_cpu(usb_dev-&gt;descriptor.bcdDevice)))</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* class-based driver binding models */</span></span><br><span class="line"><span class="keyword">if</span> (add_uevent_var(env, <span class="string">&quot;TYPE=%d/%d/%d&quot;</span>,</span><br><span class="line">   usb_dev-&gt;descriptor.bDeviceClass,</span><br><span class="line">   usb_dev-&gt;descriptor.bDeviceSubClass,</span><br><span class="line">   usb_dev-&gt;descriptor.bDeviceProtocol))</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/downey-blog/p/10507703.html">https://www.cnblogs.com/downey-blog/p/10507703.html</a></p><blockquote><ul><li><code>name</code>: è¯¥busçš„åå­—ï¼Œè¿™ä¸ªåå­—æ˜¯è¿™ä¸ªbusåœ¨sysfsæ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½“ç°ï¼Œå¯¹åº”&#x2F;sys&#x2F;bus&#x2F;$name.</li><li><code>dev_name</code>: è¿™ä¸ªdev_nameå¹¶ä¸å¯¹åº”busçš„åç§°ï¼Œè€Œæ˜¯å¯¹åº”busæ‰€åŒ…å«çš„struct deviceçš„åå­—ï¼Œå³å¯¹åº”dev_rootã€‚</li><li><code>dev_root</code>ï¼šbuså¯¹åº”çš„deviceç»“æ„ï¼Œæ¯ä¸ªè®¾å¤‡éƒ½éœ€è¦å¯¹åº”ä¸€ä¸ªç›¸åº”çš„struct device.</li><li><code>match</code>:busçš„deviceé“¾è¡¨å’Œdriveré“¾è¡¨è¿›è¡ŒåŒ¹é…çš„å®é™…æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œæ¯å½“æœ‰deviceæˆ–è€…driveræ·»åŠ åˆ°busä¸­æ—¶ï¼Œè°ƒç”¨matchå‡½æ•°ï¼Œä¸ºdevice(driver)å¯»æ‰¾åŒ¹é…çš„driver(device)ã€‚</li><li><code>uevent</code>: busæ—¶é—´å›è°ƒå‡½æ•°ï¼Œå½“å±äºè¿™ä¸ªbusçš„è®¾å¤‡å‘ç”Ÿæ·»åŠ ã€åˆ é™¤ã€ä¿®æ”¹ç­‰è¡Œä¸ºæ—¶ï¼Œéƒ½å°†å‡ºå‘uventäº‹ä»¶ã€‚</li><li><code>probe</code>: å½“deviceå’Œdriverç»ç”±matchåŒ¹é…æˆåŠŸæ—¶ï¼Œå°†ä¼šè°ƒç”¨æ€»çº¿çš„probeå‡½æ•°å®ç°å…·ä½“driverçš„åˆå§‹åŒ–ã€‚äº‹å®ä¸Šæ¯ä¸ªdriverä¹Ÿä¼šæä¾›ç›¸åº”çš„probeå‡½æ•°ï¼Œå…ˆè°ƒç”¨æ€»çº¿çš„probeå‡½æ•°ï¼Œåœ¨æ€»çº¿probeå‡½æ•°ä¸­è°ƒç”¨driverçš„probeå‡½æ•°ã€‚</li><li><code>remove</code>: ç§»é™¤æŒ‚è½½åœ¨è®¾å¤‡ä¸Šçš„driverï¼Œbusä¸Šçš„driveréƒ¨åˆ†ä¹Ÿä¼šæä¾›removeå‡½æ•°ï¼Œåœ¨æ‰§è¡Œç§»é™¤æ—¶ï¼Œå…ˆè°ƒç”¨driverçš„removeï¼Œç„¶åå†è°ƒç”¨busçš„removeä»¥æ¸…é™¤èµ„æºã€‚</li></ul></blockquote><h4 id="bus-register-notifier"><a href="#bus-register-notifier" class="headerlink" title="bus_register_notifier"></a>bus_register_notifier</h4><p>é€šçŸ¥é“¾ï¼Œç”¨äºè®¾å¤‡&#x2F;æ¥å£çš„æ·»åŠ ã€åˆ é™¤çš„é€šçŸ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">retval = bus_register_notifier(&amp;usb_bus_type, &amp;usb_bus_nb);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">notifier_block</span> <span class="title">usb_bus_nb</span> =</span> &#123;</span><br><span class="line">.notifier_call = usb_bus_notify,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Notifications of device and interface registration</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">usb_bus_notify</span><span class="params">(<span class="keyword">struct</span> notifier_block *nb, <span class="type">unsigned</span> <span class="type">long</span> action,</span></span><br><span class="line"><span class="params"><span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span> =</span> data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> (action) &#123;</span><br><span class="line"><span class="keyword">case</span> BUS_NOTIFY_ADD_DEVICE:</span><br><span class="line"><span class="keyword">if</span> (dev-&gt;type == &amp;usb_device_type)</span><br><span class="line">(<span class="type">void</span>) usb_create_sysfs_dev_files(to_usb_device(dev));</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (dev-&gt;type == &amp;usb_if_device_type)</span><br><span class="line">usb_create_sysfs_intf_files(to_usb_interface(dev));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> BUS_NOTIFY_DEL_DEVICE:</span><br><span class="line"><span class="keyword">if</span> (dev-&gt;type == &amp;usb_device_type)</span><br><span class="line">usb_remove_sysfs_dev_files(to_usb_device(dev));</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (dev-&gt;type == &amp;usb_if_device_type)</span><br><span class="line">usb_remove_sysfs_intf_files(to_usb_interface(dev));</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="usb-register"><a href="#usb-register" class="headerlink" title="usb_register"></a>usb_register</h4><p>æ³¨å†Œ usbfs é©±åŠ¨ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>æ¥å£é©±åŠ¨</strong>ã€‚ğŸ§ å¥‡æ€ªï¼Œè¿™ä¸ªé©±åŠ¨ä¸éœ€è¦æŒ‡å®šåŒ¹é…æ–¹å¼å—ï¼Ÿå“¦å“¦åº”è¯¥æ˜¯åªé€šè¿‡åå­—æ¥åŒ¹é…å“¦ã€‚</p><p>å°† usbfs é©±åŠ¨æäº¤åˆ°è®¾å¤‡æ¨¡å‹ï¼Œæ·»åŠ åˆ°USBæ€»çº¿çš„é©±åŠ¨é“¾è¡¨é‡Œã€‚</p><p>è®¾å¤‡é©±åŠ¨<code>struct usb_device_driver</code>å’Œæ¥å£é©±åŠ¨<code>struct usb_driver</code>åˆ†åˆ«ç”¨äº†ä¸åŒçš„æ•°æ®ç»“æ„è¡¨ç¤ºã€‚æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª <code>struct usb_class_driver</code> ç”¨äºè¡¨ç¤ºè®¾å¤‡ç±»é©±åŠ¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">retval = usb_register(&amp;usbfs_driver);</span><br><span class="line"><span class="comment">// devio.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_driver</span> <span class="title">usbfs_driver</span> =</span> &#123;</span><br><span class="line">.name =<span class="string">&quot;usbfs&quot;</span>,</span><br><span class="line">.probe =driver_probe,</span><br><span class="line">.disconnect =driver_disconnect,</span><br><span class="line">.suspend =driver_suspend,</span><br><span class="line">.resume =driver_resume,</span><br><span class="line">.supports_autosuspend = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* use a define to avoid include chaining to get THIS_MODULE &amp; friends */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> usb_register(driver) \</span></span><br><span class="line"><span class="meta">usb_register_driver(driver, THIS_MODULE, KBUILD_MODNAME)</span></span><br></pre></td></tr></table></figure><p>å’Œä¸‹é¢çš„ <code>usb_register_device_driver</code> æ³¨å†Œè®¾å¤‡é©±åŠ¨åŒºåˆ†ã€‚</p><h4 id="usb-devio-init"><a href="#usb-devio-init" class="headerlink" title="usb_devio_init"></a>usb_devio_init</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __init <span class="title function_">usb_devio_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">int</span> retval;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”³è¯· USB_DEVICE_MAX ä¸ªè®¾å¤‡å·ï¼Œæ‰€æœ‰çš„usbç›¸å…³çš„æ–‡ä»¶èŠ‚ç‚¹éƒ½æ˜¯ç”¨çš„è¿™ä¸ª MAJOR è®¾å¤‡å·</span></span><br><span class="line"><span class="comment">// #define USB_DEVICE_DEV MKDEV(USB_DEVICE_MAJOR, 0)</span></span><br><span class="line"><span class="comment">// #define USB_MAXBUS 64</span></span><br><span class="line"><span class="comment">// #define USB_DEVICE_MAX (USB_MAXBUS * 128)</span></span><br><span class="line">retval = register_chrdev_region(USB_DEVICE_DEV, USB_DEVICE_MAX,</span><br><span class="line"><span class="string">&quot;usb_device&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (retval) &#123;</span><br><span class="line">printk(KERN_ERR <span class="string">&quot;Unable to register minors for usb_device\n&quot;</span>);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°†å­—ç¬¦è®¾å¤‡ä¸æ–‡ä»¶æ“ä½œå…³è”</span></span><br><span class="line">cdev_init(&amp;usb_device_cdev, &amp;usbdev_file_operations);</span><br><span class="line"><span class="comment">// å°†å­—ç¬¦è®¾å¤‡æ·»åŠ åˆ°å†…æ ¸è®¾å¤‡é“¾è¡¨</span></span><br><span class="line">retval = cdev_add(&amp;usb_device_cdev, USB_DEVICE_DEV, USB_DEVICE_MAX);</span><br><span class="line"><span class="keyword">if</span> (retval) &#123;</span><br><span class="line">printk(KERN_ERR <span class="string">&quot;Unable to get usb_device major %d\n&quot;</span>,</span><br><span class="line">       USB_DEVICE_MAJOR);</span><br><span class="line"><span class="keyword">goto</span> error_cdev;</span><br><span class="line">&#125;</span><br><span class="line">usb_register_notify(&amp;usbdev_nb);</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">error_cdev:</span><br><span class="line">unregister_chrdev_region(USB_DEVICE_DEV, USB_DEVICE_MAX);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="usb-hub-init"><a href="#usb-hub-init" class="headerlink" title="usb_hub_init"></a>usb_hub_init</h4><p>æ³¨å†Œ hub æ¥å£é©±åŠ¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_driver</span> <span class="title">hub_driver</span> =</span> &#123;</span><br><span class="line">.name =<span class="string">&quot;hub&quot;</span>,</span><br><span class="line">.probe =hub_probe,</span><br><span class="line">.disconnect =hub_disconnect,</span><br><span class="line">.suspend =hub_suspend,</span><br><span class="line">.resume =hub_resume,</span><br><span class="line">.reset_resume =hub_reset_resume,</span><br><span class="line">.pre_reset =hub_pre_reset,</span><br><span class="line">.post_reset =hub_post_reset,</span><br><span class="line">.unlocked_ioctl = hub_ioctl,</span><br><span class="line">.id_table =hub_id_table,</span><br><span class="line">.supports_autosuspend =<span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">usb_hub_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">// æ³¨å†Œ hub æ¥å£é©±åŠ¨</span></span><br><span class="line"><span class="keyword">if</span> (usb_register(&amp;hub_driver) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">printk(KERN_ERR <span class="string">&quot;%s: can&#x27;t register hub driver\n&quot;</span>,</span><br><span class="line">usbcore_name);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The workqueue needs to be freezable to avoid interfering with</span></span><br><span class="line"><span class="comment"> * USB-PERSIST port handover. Otherwise it might see that a full-speed</span></span><br><span class="line"><span class="comment"> * device was gone before the EHCI controller had handed its port</span></span><br><span class="line"><span class="comment"> * over to the companion full-speed controller.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª workqueue to process hub events</span></span><br><span class="line">hub_wq = alloc_workqueue(<span class="string">&quot;usb_hub_wq&quot;</span>, WQ_FREEZABLE, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> (hub_wq)</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Fall through if kernel_thread failed */</span></span><br><span class="line">usb_deregister(&amp;hub_driver);</span><br><span class="line">pr_err(<span class="string">&quot;%s: can&#x27;t allocate workqueue for usb hub\n&quot;</span>, usbcore_name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="usb-register-device-driver"><a href="#usb-register-device-driver" class="headerlink" title="usb_register_device_driver"></a>usb_register_device_driver</h4><blockquote><p><a href="https://blog.csdn.net/qq_41483419/article/details/129158142">https://blog.csdn.net/qq_41483419/article/details/129158142</a></p><p> <strong>åªè¦æ˜¯usbè®¾å¤‡ï¼Œéƒ½ä¼šè·Ÿusb_generic_driveråŒ¹é…ä¸Š</strong>ã€‚</p><p>usb_generic_driverä¸­çš„generic_probeå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªusbè®¾å¤‡çš„ç¬¬ä¸€ä¸ªåŒ¹é…çš„driverã€‚Genericé€šç”¨ï¼Œåªè¦æ˜¯ä¸ªusbè®¾å¤‡å°±å¾—å…ˆè·Ÿä»–æ¥ä¸€æ®µï¼Œusbè®¾å¤‡é©±åŠ¨ç•Œçš„è€å¤§ã€‚ä»–çš„probeå¹²å•¥äº†å‘¢ï¼Ÿå¾ˆç®€å•ï¼æ‰¾ä¸ªåˆé€‚çš„é…ç½®ï¼Œé…ç½®ä¸€ä¸‹ã€‚ä»æ­¤usbè®¾å¤‡å°±è¿›å…¥é…ç½®çš„æ—¶ä»£äº†ã€‚(å‰æœŸçš„å·¥ä½œè°åšçš„å‘¢ï¼Œåˆ°è¿™éƒ½å·²ç»è®¾ç½®å®Œåœ°å€äº†ï¼Œå½“ç„¶æ˜¯hubäº†ï¼Œhubå‘ç°è®¾å¤‡åï¼Œä¼šè¿›è¡Œå‰æœŸçš„æšä¸¾è¿‡ç¨‹ï¼Œè·å¾—é…ç½®ï¼Œæœ€ç»ˆè°ƒç”¨device_addå°†è¯¥usbè®¾å¤‡æ·»åŠ åˆ°æ€»çº¿ä¸Šã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥ä¸“é—¨æ¥ä¸€å¤§æ®µï¼Œæ˜¯hubçš„ä¸»è¦å·¥ä½œï¼Œæ‰€ä»¥éœ€è¦æŠŠhubå•ç‹¬ä½œä¸ºä¸€ä¸ªå®¶æ—æ¥å¯¹å¾…ï¼Œäººå®¶å¯æ˜¯èµ°åœ¨ç¬¬ä¸€çº¿çš„é»˜é»˜æ— é—»çš„å·¥ä½œè€…ï¼Œé»˜é»˜çš„å°†è®¾å¤‡æšä¸¾å®Œæˆåï¼Œå°†è¿™ä¸ªè®¾å¤‡æ·»åŠ åˆ°usbæ€»çº¿ä¸Šï¼Œå¤šä¼Ÿå¤§)</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">usb_register_device_driver(&amp;usb_generic_driver, THIS_MODULE);</span><br><span class="line"></span><br><span class="line"><span class="comment">// generic.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device_driver</span> <span class="title">usb_generic_driver</span> =</span> &#123;</span><br><span class="line">.name =<span class="string">&quot;usb&quot;</span>,</span><br><span class="line">.match = usb_generic_driver_match,</span><br><span class="line">.probe = usb_generic_driver_probe,</span><br><span class="line">.disconnect = usb_generic_driver_disconnect,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>CONFIG_PM</span></span><br><span class="line">.suspend = usb_generic_driver_suspend,</span><br><span class="line">.resume = usb_generic_driver_resume,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">.supports_autosuspend = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>usb_device_driverç»“æ„ä½“æ˜¯usb_driverçš„ç®€åŒ–ç‰ˆæœ¬,è¿™é‡Œæ³¨å†Œçš„æ˜¯usbè®¾å¤‡(éæ¥å£)é©±åŠ¨ã€‚</p><p>usbæ€»çº¿çš„matchæ–¹æ³•å¯¹usbè®¾å¤‡å’Œusbæ¥å£åšäº†åŒºåˆ†å¤„ç†,é’ˆå¯¹usbè®¾å¤‡,ç›´æ¥matchçš„,(åˆ†æmatchæ—¶å€™å†ç»†åŒ–)</p><p>ç„¶åè°ƒç”¨usbè®¾å¤‡é©±åŠ¨çš„probeæ–¹æ³•</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">usb_probe_device</span><span class="params">(<span class="keyword">struct</span> device *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_driver</span> *<span class="title">udriver</span> =</span> to_usb_device_driver(dev-&gt;driver);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">usb_device</span> *<span class="title">udev</span> =</span> to_usb_device(dev);</span><br><span class="line">    <span class="type">int</span> error = <span class="number">0</span>;</span><br><span class="line">    dev_dbg(dev, <span class="string">&quot;%s\n&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">if</span> (!udriver-&gt;supports_autosuspend)  <span class="comment">//æ¡ä»¶æˆç«‹</span></span><br><span class="line">        error = usb_autoresume_device(udev);</span><br><span class="line">    <span class="keyword">if</span> (!error)</span><br><span class="line">        error = udriver-&gt;probe(udev);    <span class="comment">//è°ƒç”¨usb_device_driverçš„probeæ–¹æ³•</span></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€è°ƒç”¨usb_generic_driverçš„probeæ–¹æ³•</p><p>å¯¹åº”åˆ°root hub,æµç¨‹ä¼šè½¬å…¥åˆ°generic_probe().ä»£ç å¦‚ä¸‹:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">generic_probe</span><span class="params">(<span class="keyword">struct</span> usb_device *udev)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Choose and set the configuration.  This registers the interfaces</span></span><br><span class="line"><span class="comment">     * with the driver core and lets interface drivers bind to them.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (udev-&gt;authorized == <span class="number">0</span>) <span class="comment">//è‡³äºudev-&gt;authorized,åœ¨root hubçš„åˆå§‹åŒ–ä¸­,æ˜¯ä¼šå°†å…¶åˆå§‹åŒ–ä¸º1çš„.åé¢çš„é€»è¾‘å°±æ›´ç®€å•äº†.ä¸ºroot hub é€‰æ‹©ä¸€ä¸ªé…ç½®ç„¶åå†è®¾å®šè¿™ä¸ªé…ç½®.</span></span><br><span class="line">        dev_err(&amp;udev-&gt;dev, <span class="string">&quot;Device is not authorized for usage\n&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        c = usb_choose_configuration(udev); <span class="comment">//Usb2.0 specä¸Šè§„å®š,å¯¹äºhubè®¾å¤‡,åªèƒ½æœ‰ä¸€ä¸ªconfig,ä¸€ä¸ªinterface,ä¸€ä¸ªendpoint.å®é™…ä¸Š,åœ¨è¿™é‡Œ,å¯¹hubçš„é€‰æ‹©çº¦æŸä¸å¤§,åæ­£å°±ä¸€ä¸ªé…ç½®,ä¸ç®¡æ€ä¹ˆæ ·,é€‰æ‹©å’Œè®¾å®šéƒ½æ˜¯è¿™ä¸ªé…ç½®.</span></span><br><span class="line">        <span class="keyword">if</span> (c &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            err = usb_set_configuration(udev, c);</span><br><span class="line">            <span class="keyword">if</span> (err &amp;&amp; err != -ENODEV) &#123;</span><br><span class="line">                dev_err(&amp;udev-&gt;dev, <span class="string">&quot;can&#x27;t set config #%d, error %d\n&quot;</span>,</span><br><span class="line">                    c, err);</span><br><span class="line">                <span class="comment">/* This need not be fatal.  The user can try to</span></span><br><span class="line"><span class="comment">                 * set other configurations. */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* USB device state == configured ... usable */</span></span><br><span class="line">    usb_notify_add_device(udev);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>USB CORE æ¨¡å—åˆå§‹åŒ–è¿‡ç¨‹ï¼š</p><ul><li>æ³¨å†Œ usb æ€»çº¿</li><li>æ³¨å†Œ usbfs æ¥å£é©±åŠ¨</li><li>æ³¨å†Œ hub æ¥å£é©±åŠ¨</li><li>æ³¨å†Œ usb generic è®¾å¤‡é©±åŠ¨</li></ul><blockquote><p><a href="https://blog.csdn.net/vitalma/article/details/136300790">https://blog.csdn.net/vitalma/article/details/136300790</a></p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">usb_debugfs_init;</span><br><span class="line">---&gt; /sys/kernel/debug/usb/devices; dump USBè®¾å¤‡ä¿¡æ¯</span><br><span class="line">bus_register; æ€»çº¿èŠ‚ç‚¹</span><br><span class="line">---&gt; /sys/bus/usb;</span><br><span class="line">---&gt; /sys/bus/usb/drivers ç›®å½•</span><br><span class="line">---&gt; /sys/bus/usb/devices ç›®å½•</span><br><span class="line">---&gt; /sys/bus/usb/drivers_probe</span><br><span class="line">---&gt; /sys/bus/usb/drivers_autoprobe</span><br><span class="line">---&gt; /sys/bus/usb/uevent</span><br><span class="line">usb_register;</span><br><span class="line">---&gt; /sys/bus/usb/drivers/usbfs ç›®å½•</span><br><span class="line">usb_hub_init;</span><br><span class="line">---&gt; /sys/bus/usb/drivers/hub ç›®å½•</span><br><span class="line">usb_register_device_driver:</span><br><span class="line">---&gt; /sys/bus/usb/drivers/usb ç›®å½•</span><br></pre></td></tr></table></figure><p>ç®€å•çœ‹ä¸‹å…¶ä»–æ–‡ä»¶å®ç°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">usbcore-y := usb.o hub.o hcd.o urb.o message.o driver.o</span><br><span class="line">usbcore-y += config.o file.o buffer.o sysfs.o endpoint.o</span><br><span class="line">usbcore-y += devio.o notify.o generic.o quirks.o devices.o</span><br><span class="line">usbcore-y += phy.o port.o</span><br><span class="line">usbcore-$(CONFIG_OF)+= of.o</span><br><span class="line">obj-$(CONFIG_USB)+= usbcore.o</span><br><span class="line">buffer.c: DMA mempoolï¼Œæä¾›ä¸€äº› HCD ä¼šç”¨åˆ°çš„API</span><br><span class="line">config.c: ä½é€Ÿå…¨é€Ÿé«˜é€Ÿè¶…é€Ÿçš„æœ€å¤§åŒ…å¤§å°ã€è§£æendpoint/interface/configurationæè¿°ç¬¦ã€‚</span><br><span class="line">devices.c: å°±ä¸€ä¸ªä½œç”¨ dump æ‰€æœ‰è®¾å¤‡ä¿¡æ¯ã€‚è§ [debugfs/usb/devices]</span><br><span class="line">devio.c: usbfs é©±åŠ¨ï¼Œå®ç°äº†usbå­—ç¬¦è®¾å¤‡çš„æ–‡ä»¶æ“ä½œï¼Œread/write/ioctl ç­‰</span><br><span class="line">driver.c: æä¾›äº†é©±åŠ¨æ³¨å†Œç›¸å…³çš„API</span><br><span class="line">endpoint.c: åˆ›å»ºã€åˆ é™¤endpoint</span><br><span class="line">file.c: åœ¨ /dev ç›®å½•ä¸‹åˆ›å»ºè®¾å¤‡ï¼Œè®¾å¤‡åæ˜¯å¯¹äºçš„driverå+minerè®¾å¤‡å·ã€‚</span><br><span class="line">generic.c: generic è®¾å¤‡é©±åŠ¨å®ç°ã€‚</span><br><span class="line">hcd.c: HCD ....</span><br><span class="line">hub.c: HUB æ¥å£é©±åŠ¨ï¼Œè¿™ä¸ªæ–‡ä»¶ä¹Ÿæœ‰å¾ˆå¤šå†…å®¹ï¼Œå¥½åƒè®¾å¤‡æšä¸¾é˜¶æ®µéƒ½æ˜¯å®ƒå®Œæˆã€‚</span><br><span class="line">message.c: è¿™ç©æ„æ€ä¹ˆä¹Ÿå¾ˆå¤šå†…å®¹</span><br><span class="line">port.c: hubçš„ç«¯å£ç›¸å…³</span><br><span class="line">sysfs.c: /sys/bus/usb ç›¸å…³å§</span><br><span class="line">urb.c: USB Request Block.</span><br></pre></td></tr></table></figure><p>TODOï¼š</p><ul><li><p><input disabled="" type="checkbox"> ç¡®å®šè¿™ä¸‰ä¸ªé©±åŠ¨çš„ä½œç”¨ã€‚</p></li><li><p><input disabled="" type="checkbox"> æ¥å£é©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨çš„å…³ç³»ã€‚</p></li><li><p><a href="https://www.cnblogs.com/zyly/p/16255617.html">https://www.cnblogs.com/zyly/p/16255617.html</a></p></li><li><p><strong><a href="https://blog.csdn.net/jun_8018/article/details/116096984">Linux USBé©±åŠ¨åˆ†æ(ä¸€)</a></strong></p></li><li><p><strong><a href="https://blog.csdn.net/jun_8018/article/details/116137244">Linux USBé©±åŠ¨åˆ†æ(äºŒ)</a></strong></p></li><li><p><strong><a href="https://blog.csdn.net/jun_8018/article/details/116211644">Linux USBé©±åŠ¨åˆ†æ(ä¸‰)</a></strong></p></li><li><p><strong><a href="https://zhuanlan.zhihu.com/p/61079354">Linux USBæ€»çº¿é©±åŠ¨æ¡†æ¶åˆ†æ</a></strong></p></li><li><p><strong><a href="https://blog.csdn.net/qq_30736309/article/details/79583098">USBä¸»æœºæ§åˆ¶å™¨é©±åŠ¨â€”â€”OHCIåˆ†æ</a></strong></p></li><li><p><strong><a href="https://blog.csdn.net/jixianghao/article/details/45336873">äºŒã€usbå­ç³»ç»Ÿåˆå§‹åŒ–</a></strong></p></li><li><p><strong><a href="https://blog.csdn.net/fengyuwuzu0519/article/details/104259648">ã€linuxé©±åŠ¨ã€‘USBå­ç³»ç»Ÿåˆ†æ</a></strong></p></li></ul><h4 id="debugfs-x2F-usb-x2F-devices"><a href="#debugfs-x2F-usb-x2F-devices" class="headerlink" title="debugfs&#x2F;usb&#x2F;devices"></a>debugfs&#x2F;usb&#x2F;devices</h4><p>dump USBè®¾å¤‡ä¿¡æ¯</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">root@h:usb<span class="meta"># cat /sys/kernel/debug/usb/devices</span></span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">00</span> Prnt=<span class="number">00</span> Port=<span class="number">00</span> Cnt=<span class="number">00</span> Dev#=  <span class="number">1</span> Spd=<span class="number">480</span>  MxCh=<span class="number">16</span></span><br><span class="line">B:  Alloc=  <span class="number">0</span>/<span class="number">800</span> us ( <span class="number">0</span>%), #Int=  <span class="number">0</span>, #Iso=  <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">01</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">1</span>d6b ProdID=<span class="number">0002</span> Rev= <span class="number">6.08</span></span><br><span class="line">S:  Manufacturer=Linux <span class="number">6.8</span><span class="number">.0</span><span class="number">-41</span>-generic xhci-hcd</span><br><span class="line">S:  Product=xHCI Host Controller</span><br><span class="line">S:  SerialNumber=<span class="number">0000</span>:<span class="number">00</span>:<span class="number">14.0</span></span><br><span class="line">C:* #Ifs= <span class="number">1</span> Cfg#= <span class="number">1</span> Atr=e0 MxPwr=  <span class="number">0</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> Driver=hub</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">4</span> Ivl=<span class="number">256</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">01</span> Prnt=<span class="number">01</span> Port=<span class="number">01</span> Cnt=<span class="number">01</span> Dev#=  <span class="number">2</span> Spd=<span class="number">12</span>   MxCh= <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">00</span>(&gt;ifc ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">0b0</span>5 ProdID=<span class="number">19</span>af Rev= <span class="number">1.00</span></span><br><span class="line">S:  Manufacturer=AsusTek Computer Inc.</span><br><span class="line">S:  Product=AURA LED Controller</span><br><span class="line">S:  SerialNumber=<span class="number">9876543210</span></span><br><span class="line">C:* #Ifs= <span class="number">2</span> Cfg#= <span class="number">1</span> Atr=a0 MxPwr= <span class="number">16</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">0</span> Cls=ff(vend.) Sub=ff Prot=ff Driver=(none)</span><br><span class="line">I:* If#= <span class="number">2</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">03</span>(HID  ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> Driver=usbhid</span><br><span class="line">E:  Ad=<span class="number">82</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=  <span class="number">32</span> Ivl=<span class="number">4</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">01</span> Prnt=<span class="number">01</span> Port=<span class="number">08</span> Cnt=<span class="number">02</span> Dev#=  <span class="number">3</span> Spd=<span class="number">480</span>  MxCh= <span class="number">4</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">01</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">05e3</span> ProdID=<span class="number">0608</span> Rev=<span class="number">60.90</span></span><br><span class="line">S:  Product=USB2<span class="number">.0</span> Hub</span><br><span class="line">C:* #Ifs= <span class="number">1</span> Cfg#= <span class="number">1</span> Atr=e0 MxPwr=<span class="number">100</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> Driver=hub</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">1</span> Ivl=<span class="number">256</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">02</span> Prnt=<span class="number">03</span> Port=<span class="number">00</span> Cnt=<span class="number">01</span> Dev#=  <span class="number">5</span> Spd=<span class="number">12</span>   MxCh= <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">0</span>a12 ProdID=<span class="number">0001</span> Rev=<span class="number">88.91</span></span><br><span class="line">C:* #Ifs= <span class="number">2</span> Cfg#= <span class="number">1</span> Atr=c0 MxPwr=  <span class="number">0</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">3</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=  <span class="number">16</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">02</span>(O) Atr=<span class="number">02</span>(Bulk) MxPS=  <span class="number">64</span> Ivl=<span class="number">0</span>ms</span><br><span class="line">E:  Ad=<span class="number">82</span>(I) Atr=<span class="number">02</span>(Bulk) MxPS=  <span class="number">64</span> Ivl=<span class="number">0</span>ms</span><br><span class="line">I:* If#= <span class="number">1</span> Alt= <span class="number">0</span> #EPs= <span class="number">2</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">03</span>(O) Atr=<span class="number">01</span>(Isoc) MxPS=   <span class="number">0</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">83</span>(I) Atr=<span class="number">01</span>(Isoc) MxPS=   <span class="number">0</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">I:  If#= <span class="number">1</span> Alt= <span class="number">1</span> #EPs= <span class="number">2</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">03</span>(O) Atr=<span class="number">01</span>(Isoc) MxPS=   <span class="number">9</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">83</span>(I) Atr=<span class="number">01</span>(Isoc) MxPS=   <span class="number">9</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">I:  If#= <span class="number">1</span> Alt= <span class="number">2</span> #EPs= <span class="number">2</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">03</span>(O) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">17</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">83</span>(I) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">17</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">I:  If#= <span class="number">1</span> Alt= <span class="number">3</span> #EPs= <span class="number">2</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">03</span>(O) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">25</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">83</span>(I) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">25</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">I:  If#= <span class="number">1</span> Alt= <span class="number">4</span> #EPs= <span class="number">2</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">03</span>(O) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">33</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">83</span>(I) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">33</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">I:  If#= <span class="number">1</span> Alt= <span class="number">5</span> #EPs= <span class="number">2</span> Cls=e0(wlcon) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=btusb</span><br><span class="line">E:  Ad=<span class="number">03</span>(O) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">49</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">83</span>(I) Atr=<span class="number">01</span>(Isoc) MxPS=  <span class="number">49</span> Ivl=<span class="number">1</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">02</span> Prnt=<span class="number">03</span> Port=<span class="number">01</span> Cnt=<span class="number">02</span> Dev#=  <span class="number">7</span> Spd=<span class="number">480</span>  MxCh= <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">00</span>(&gt;ifc ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">14</span>cd ProdID=<span class="number">1212</span> Rev= <span class="number">1.00</span></span><br><span class="line">S:  Manufacturer=Generic</span><br><span class="line">S:  Product=Mass Storage Device</span><br><span class="line">S:  SerialNumber=<span class="number">121220160204</span></span><br><span class="line">C:* #Ifs= <span class="number">1</span> Cfg#= <span class="number">1</span> Atr=<span class="number">80</span> MxPwr=<span class="number">100</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">2</span> Cls=<span class="number">08</span>(stor.) Sub=<span class="number">06</span> Prot=<span class="number">50</span> Driver=usb-storage</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">02</span>(Bulk) MxPS= <span class="number">512</span> Ivl=<span class="number">0</span>ms</span><br><span class="line">E:  Ad=<span class="number">02</span>(O) Atr=<span class="number">02</span>(Bulk) MxPS= <span class="number">512</span> Ivl=<span class="number">0</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">02</span> Prnt=<span class="number">03</span> Port=<span class="number">02</span> Cnt=<span class="number">03</span> Dev#= <span class="number">14</span> Spd=<span class="number">480</span>  MxCh= <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">00</span>(&gt;ifc ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">3346</span> ProdID=<span class="number">1009</span> Rev= <span class="number">5.10</span></span><br><span class="line">S:  Manufacturer=Cvitek</span><br><span class="line">S:  Product=RNDIS</span><br><span class="line">S:  SerialNumber=<span class="number">0123456789</span></span><br><span class="line">C:* #Ifs= <span class="number">2</span> Cfg#= <span class="number">1</span> Atr=<span class="number">80</span> MxPwr=<span class="number">120</span>mA</span><br><span class="line">A:  FirstIf#= <span class="number">0</span> IfCount= <span class="number">2</span> Cls=<span class="number">02</span>(comm.) Sub=<span class="number">06</span> Prot=<span class="number">00</span></span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">02</span>(comm.) Sub=<span class="number">02</span> Prot=ff Driver=rndis_host</span><br><span class="line">E:  Ad=<span class="number">82</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">8</span> Ivl=<span class="number">32</span>ms</span><br><span class="line">I:* If#= <span class="number">1</span> Alt= <span class="number">0</span> #EPs= <span class="number">2</span> Cls=<span class="number">0</span>a(data ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> Driver=rndis_host</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">02</span>(Bulk) MxPS= <span class="number">512</span> Ivl=<span class="number">0</span>ms</span><br><span class="line">E:  Ad=<span class="number">01</span>(O) Atr=<span class="number">02</span>(Bulk) MxPS= <span class="number">512</span> Ivl=<span class="number">0</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">01</span> Prnt=<span class="number">01</span> Port=<span class="number">09</span> Cnt=<span class="number">03</span> Dev#=  <span class="number">4</span> Spd=<span class="number">12</span>   MxCh= <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">00</span>(&gt;ifc ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> MxPS= <span class="number">8</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">320f</span> ProdID=<span class="number">5088</span> Rev= <span class="number">1.04</span></span><br><span class="line">S:  Manufacturer=Telink</span><br><span class="line">S:  Product=Wireless Gaming Keyboard</span><br><span class="line">C:* #Ifs= <span class="number">2</span> Cfg#= <span class="number">1</span> Atr=a0 MxPwr=<span class="number">200</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">03</span>(HID  ) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=usbhid</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">8</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">I:* If#= <span class="number">1</span> Alt= <span class="number">0</span> #EPs= <span class="number">2</span> Cls=<span class="number">03</span>(HID  ) Sub=<span class="number">01</span> Prot=<span class="number">01</span> Driver=usbhid</span><br><span class="line">E:  Ad=<span class="number">82</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=  <span class="number">64</span> Ivl=<span class="number">1</span>ms</span><br><span class="line">E:  Ad=<span class="number">05</span>(O) Atr=<span class="number">03</span>(Int.) MxPS=  <span class="number">64</span> Ivl=<span class="number">1</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">01</span> Prnt=<span class="number">01</span> Port=<span class="number">12</span> Cnt=<span class="number">04</span> Dev#=  <span class="number">8</span> Spd=<span class="number">480</span>  MxCh= <span class="number">4</span></span><br><span class="line">D:  Ver= <span class="number">2.00</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">01</span> MxPS=<span class="number">64</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">058f</span> ProdID=<span class="number">6254</span> Rev= <span class="number">1.00</span></span><br><span class="line">C:* #Ifs= <span class="number">1</span> Cfg#= <span class="number">1</span> Atr=e0 MxPwr=<span class="number">100</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> Driver=hub</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">1</span> Ivl=<span class="number">256</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">01</span> Lev=<span class="number">02</span> Prnt=<span class="number">08</span> Port=<span class="number">00</span> Cnt=<span class="number">01</span> Dev#=  <span class="number">9</span> Spd=<span class="number">12</span>   MxCh= <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">1.10</span> Cls=<span class="number">00</span>(&gt;ifc ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> MxPS= <span class="number">8</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">046</span>d ProdID=c542 Rev= <span class="number">3.03</span></span><br><span class="line">S:  Manufacturer=Logitech</span><br><span class="line">S:  Product=Wireless Receiver</span><br><span class="line">C:* #Ifs= <span class="number">1</span> Cfg#= <span class="number">1</span> Atr=a0 MxPwr= <span class="number">50</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">03</span>(HID  ) Sub=<span class="number">01</span> Prot=<span class="number">02</span> Driver=usbhid</span><br><span class="line">E:  Ad=<span class="number">82</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">8</span> Ivl=<span class="number">4</span>ms</span><br><span class="line"></span><br><span class="line">T:  Bus=<span class="number">02</span> Lev=<span class="number">00</span> Prnt=<span class="number">00</span> Port=<span class="number">00</span> Cnt=<span class="number">00</span> Dev#=  <span class="number">1</span> Spd=<span class="number">10000</span> MxCh= <span class="number">9</span></span><br><span class="line">B:  Alloc=  <span class="number">0</span>/<span class="number">800</span> us ( <span class="number">0</span>%), #Int=  <span class="number">0</span>, #Iso=  <span class="number">0</span></span><br><span class="line">D:  Ver= <span class="number">3.10</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">03</span> MxPS= <span class="number">9</span> #Cfgs=  <span class="number">1</span></span><br><span class="line">P:  Vendor=<span class="number">1</span>d6b ProdID=<span class="number">0003</span> Rev= <span class="number">6.08</span></span><br><span class="line">S:  Manufacturer=Linux <span class="number">6.8</span><span class="number">.0</span><span class="number">-41</span>-generic xhci-hcd</span><br><span class="line">S:  Product=xHCI Host Controller</span><br><span class="line">S:  SerialNumber=<span class="number">0000</span>:<span class="number">00</span>:<span class="number">14.0</span></span><br><span class="line">C:* #Ifs= <span class="number">1</span> Cfg#= <span class="number">1</span> Atr=e0 MxPwr=  <span class="number">0</span>mA</span><br><span class="line">I:* If#= <span class="number">0</span> Alt= <span class="number">0</span> #EPs= <span class="number">1</span> Cls=<span class="number">09</span>(hub  ) Sub=<span class="number">00</span> Prot=<span class="number">00</span> Driver=hub</span><br><span class="line">E:  Ad=<span class="number">81</span>(I) Atr=<span class="number">03</span>(Int.) MxPS=   <span class="number">4</span> Ivl=<span class="number">256</span>ms</span><br></pre></td></tr></table></figure><p>å‰é¢å­—æ®µçš„æ„æ€ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// usb/core/devices.c</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_topo[] =</span><br><span class="line"><span class="comment">/* T:  Bus=dd Lev=dd Prnt=dd Port=dd Cnt=dd Dev#=ddd Spd=dddd MxCh=dd */</span></span><br><span class="line"><span class="string">&quot;\nT:  Bus=%2.2d Lev=%2.2d Prnt=%2.2d Port=%2.2d Cnt=%2.2d Dev#=%3d Spd=%-4s MxCh=%2d\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_string_manufacturer[] =</span><br><span class="line"><span class="comment">/* S:  Manufacturer=xxxx */</span></span><br><span class="line">  <span class="string">&quot;S:  Manufacturer=%.100s\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_string_product[] =</span><br><span class="line"><span class="comment">/* S:  Product=xxxx */</span></span><br><span class="line">  <span class="string">&quot;S:  Product=%.100s\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ALLOW_SERIAL_NUMBER</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_string_serialnumber[] =</span><br><span class="line"><span class="comment">/* S:  SerialNumber=xxxx */</span></span><br><span class="line">  <span class="string">&quot;S:  SerialNumber=%.100s\n&quot;</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_bandwidth[] =</span><br><span class="line"><span class="comment">/* B:  Alloc=ddd/ddd us (xx%), #Int=ddd, #Iso=ddd */</span></span><br><span class="line">  <span class="string">&quot;B:  Alloc=%3d/%3d us (%2d%%), #Int=%3d, #Iso=%3d\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_device1[] =</span><br><span class="line"><span class="comment">/* D:  Ver=xx.xx Cls=xx(sssss) Sub=xx Prot=xx MxPS=dd #Cfgs=dd */</span></span><br><span class="line">  <span class="string">&quot;D:  Ver=%2x.%02x Cls=%02x(%-5s) Sub=%02x Prot=%02x MxPS=%2d #Cfgs=%3d\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_device2[] =</span><br><span class="line"><span class="comment">/* P:  Vendor=xxxx ProdID=xxxx Rev=xx.xx */</span></span><br><span class="line">  <span class="string">&quot;P:  Vendor=%04x ProdID=%04x Rev=%2x.%02x\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_config[] =</span><br><span class="line"><span class="comment">/* C:  #Ifs=dd Cfg#=dd Atr=xx MPwr=dddmA */</span></span><br><span class="line">  <span class="string">&quot;C:%c #Ifs=%2d Cfg#=%2d Atr=%02x MxPwr=%3dmA\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_iad[] =</span><br><span class="line"><span class="comment">/* A:  FirstIf#=dd IfCount=dd Cls=xx(sssss) Sub=xx Prot=xx */</span></span><br><span class="line">  <span class="string">&quot;A:  FirstIf#=%2d IfCount=%2d Cls=%02x(%-5s) Sub=%02x Prot=%02x\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_iface[] =</span><br><span class="line"><span class="comment">/* I:  If#=dd Alt=dd #EPs=dd Cls=xx(sssss) Sub=xx Prot=xx Driver=xxxx*/</span></span><br><span class="line">  <span class="string">&quot;I:%c If#=%2d Alt=%2d #EPs=%2d Cls=%02x(%-5s) Sub=%02x Prot=%02x Driver=%s\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> format_endpt[] =</span><br><span class="line"><span class="comment">/* E:  Ad=xx(s) Atr=xx(ssss) MxPS=dddd Ivl=D?s */</span></span><br><span class="line">  <span class="string">&quot;E:  Ad=%02x(%c) Atr=%02x(%-4s) MxPS=%4d Ivl=%d%cs\n&quot;</span>;</span><br></pre></td></tr></table></figure><h4 id="file-c"><a href="#file-c" class="headerlink" title="file.c"></a>file.c</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">root@h:usb<span class="comment"># dmesg | tail -n 20</span></span><br><span class="line">[45807.088223] usb 1-9.4: New USB device found, idVendor=0403, idProduct=6001, bcdDevice= 6.00</span><br><span class="line">[45807.088238] usb 1-9.4: New USB device strings: Mfr=1, Product=2, SerialNumber=3</span><br><span class="line">[45807.088244] usb 1-9.4: Product: FT232R USB UART</span><br><span class="line">[45807.088248] usb 1-9.4: Manufacturer: FTDI</span><br><span class="line">[45807.088252] usb 1-9.4: SerialNumber: A50285BI</span><br><span class="line">[45807.096989] ftdi_sio 1-9.4:1.0: FTDI USB Serial Device converter detected</span><br><span class="line">[45807.097079] usb 1-9.4: Detected FT232R</span><br><span class="line">[45807.097821] usb 1-9.4: FTDI USB Serial Device converter now attached to ttyUSB0</span><br><span class="line">[45956.898368] usb 1-12: new full-speed USB device number 16 using xhci_hcd</span><br><span class="line">[45957.039833] usb 1-12: New USB device found, idVendor=320f, idProduct=5055, bcdDevice= 1.04</span><br><span class="line">[45957.039852] usb 1-12: New USB device strings: Mfr=1, Product=2, SerialNumber=0</span><br><span class="line">[45957.039859] usb 1-12: Product: VGN N75 PRO</span><br><span class="line">[45957.039864] usb 1-12: Manufacturer: Telink</span><br><span class="line">[45957.049757] input: Telink VGN N75 PRO  as /devices/pci0000:00/0000:00:14.0/usb1/1-12/1-12:1.0/0003:320F:5055.0007/input/input33</span><br><span class="line">[45957.102483] hid-generic 0003:320F:5055.0007: input,hidraw3: USB HID v1.11 Keyboard [Telink VGN N75 PRO ] on usb-0000:00:14.0-12/input0</span><br><span class="line">[45957.118181] input: Telink VGN N75 PRO  Keyboard as /devices/pci0000:00/0000:00:14.0/usb1/1-12/1-12:1.1/0003:320F:5055.0008/input/input34</span><br><span class="line">[45957.169742] input: Telink VGN N75 PRO  as /devices/pci0000:00/0000:00:14.0/usb1/1-12/1-12:1.1/0003:320F:5055.0008/input/input35</span><br><span class="line">[45957.169984] input: Telink VGN N75 PRO  as /devices/pci0000:00/0000:00:14.0/usb1/1-12/1-12:1.1/0003:320F:5055.0008/input/input36</span><br><span class="line">[45957.170313] input: Telink VGN N75 PRO  Mouse as /devices/pci0000:00/0000:00:14.0/usb1/1-12/1-12:1.1/0003:320F:5055.0008/input/input37</span><br><span class="line">[45957.170779] hid-generic 0003:320F:5055.0008: input,hiddev2,hidraw4: USB HID v1.11 Keyboard [Telink VGN N75 PRO ] on usb-0000:00:14.0-12/input1</span><br><span class="line">root@h:usb<span class="comment"># ls</span></span><br><span class="line">hiddev0  hiddev1  hiddev2</span><br><span class="line">root@h:usb<span class="comment"># ls -lh</span></span><br><span class="line">total 0</span><br><span class="line">crw------- 1 root root 180, 0  9æœˆ  1 09:12 hiddev0</span><br><span class="line">crw------- 1 root root 180, 1  9æœˆ  1 09:12 hiddev1</span><br><span class="line">crw------- 1 root root 180, 2  9æœˆ  1 21:58 hiddev2</span><br><span class="line">root@h:usb<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="usbfs-æ¥å£é©±åŠ¨"><a href="#usbfs-æ¥å£é©±åŠ¨" class="headerlink" title="usbfs æ¥å£é©±åŠ¨"></a>usbfs æ¥å£é©±åŠ¨</h3><h3 id="hub-æ¥å£é©±åŠ¨"><a href="#hub-æ¥å£é©±åŠ¨" class="headerlink" title="hub æ¥å£é©±åŠ¨"></a>hub æ¥å£é©±åŠ¨</h3><blockquote><p><a href="https://zhuanlan.zhihu.com/p/61079354">https://zhuanlan.zhihu.com/p/61079354</a></p></blockquote><p><img src="https://pica.zhimg.com/80/v2-6257ed39e775173bc62759393ddbb21c_720w.webp"></p><p>ç¡¬ä»¶ä¸»æœºæ§åˆ¶å™¨Host Controllerä¹‹ä¸Šè¿è¡Œçš„æ˜¯HCDï¼Œæ˜¯å¯¹ä¸»æœºæ§åˆ¶å™¨ç¡¬ä»¶çš„ä¸€ä¸ªæŠ½è±¡ï¼Œå®ç°æ ¸å¿ƒå±‚ä¸æ§åˆ¶å™¨ä¹‹é—´çš„å¯¹è¯æ¥å£ï¼ŒUSB HCDåŒ…å«å¤šç§USBæ¥å£è§„èŒƒï¼š</p><p>ï¼ˆ1ï¼‰UHCIï¼šIntelæä¾›ï¼Œé€šç”¨ä¸»æœºæ§åˆ¶æ¥å£ï¼ŒUSB1.0&#x2F;1.1ï¼›</p><p>ï¼ˆ2ï¼‰OHCIï¼šå¾®è½¯æä¾›ï¼Œå¼€æ”¾ä¸»æœºæ§åˆ¶æ¥å£ï¼ŒUSB1.0&#x2F;1.1ï¼›</p><p>ï¼ˆ3ï¼‰EHCIï¼šå¢å¼ºä¸»æœºæ§åˆ¶æ¥å£ï¼ŒUSB2.0ï¼›</p><p>2.4 USB Device Driver</p><p>USBè®¾å¤‡é©±åŠ¨æ¡†æ¶å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://picx.zhimg.com/80/v2-e2d44ba87579ca5f775dc2d79fd48143_720w.webp"></p><p>USBè®¾å¤‡æ˜¯ç”±ä¸€äº›é…ç½®(configuration)ã€æ¥å£ï¼ˆinterfaceï¼‰å’Œç«¯ç‚¹(endpoint)ç»„æˆï¼Œï¼Œå³ä¸€ä¸ªUSBè®¾å¤‡å¯ä»¥å«æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªé…ç½®ï¼Œåœ¨æ¯ä¸ªé…ç½®ä¸­å¯å«æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£ï¼Œåœ¨æ¯ä¸ªæ¥å£ä¸­å¯å«æœ‰è‹¥å¹²ä¸ªç«¯ç‚¹ã€‚ä¸€ä¸ªUSBè®¾å¤‡é©±åŠ¨å¯èƒ½åŒ…å«å¤šä¸ªå­é©±åŠ¨ã€‚ä¸€ä¸ªUSBè®¾å¤‡å­é©±åŠ¨ç¨‹åºå¯¹åº”ä¸€ä¸ªUSBæ¥å£ï¼Œè€Œéæ•´ä¸ªUSBè®¾å¤‡ã€‚</p><p>USBè®¾å¤‡ä½¿ç”¨å„ç§æè¿°ç¬¦æ¥è¯´æ˜å…¶è®¾å¤‡æ¶æ„ï¼ŒåŒ…æ‹¬è®¾å¤‡æè¿°ç¬¦ã€é…ç½®æè¿°ç¬¦ã€æ¥å£æè¿°ç¬¦ã€ç«¯ç‚¹æè¿°ç¬¦ã€å­—ç¬¦ä¸²æè¿°ç¬¦ã€‚åé¢å•ç‹¬è®¨è®ºUSBè®¾å¤‡æè¿°ç¬¦ã€‚</p><p>USBä¼ è¾“çš„å¯¹è±¡ä¸ºç«¯ç‚¹(endpoint)ï¼Œæ¯ä¸€ä¸ªç«¯ç‚¹éƒ½æœ‰ä¼ è¾“ç±»å‹ï¼Œä¼ è¾“æ–¹å‘ï¼Œé™¤äº†ç«¯ç‚¹0å¤–ï¼Œæ¯ä¸€ä¸ªç«¯ç‚¹åªæ”¯æŒä¸€ä¸ªæ–¹å‘çš„æ•°æ®ä¼ è¾“ï¼Œç«¯ç‚¹0ç”¨äºæ§åˆ¶ä¼ è¾“ï¼Œæ—¢èƒ½è¾“å‡ºä¹Ÿèƒ½è¾“å…¥ã€‚è¾“å…¥(IN)ã€è¾“å‡º(OUT) â€œéƒ½æ˜¯â€ åŸºäºUSBä¸»æœºçš„ç«‹åœºè¯´çš„ã€‚æ¯”å¦‚é¼ æ ‡çš„æ•°æ®æ˜¯ä»é¼ æ ‡ä¼ åˆ°PCæœº, å¯¹åº”çš„ç«¯ç‚¹ç§°ä¸ºâ€è¾“å…¥ç«¯ç‚¹â€ã€‚</p><p>é€šè¿‡ä»¥ä¸Šåˆ†æï¼ŒUSBè®¾å¤‡é©±åŠ¨æ¨¡å‹å¯ä»¥æ¦‚æ‹¬ä¸ºå¦‚ä¸‹å›¾ã€‚</p><p><img src="https://pic4.zhimg.com/80/v2-d3eab094e80102ae1ad79ed7fc477c2b_720w.webp"></p><p>ä¸»è¦åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼šUSBæ§åˆ¶å™¨é©±åŠ¨ï¼ŒUSBæ ¸å¿ƒï¼ŒUSBè®¾å¤‡é©±åŠ¨ã€‚å¦‚ä¸Šå›¾khubdæ˜¯USBå®ˆæŠ¤è¿›ç¨‹ï¼Œå½“USBè®¾å¤‡æ’å…¥çš„æ—¶å€™ï¼Œå®ˆæŠ¤è¿›ç¨‹ç›‘æµ‹åˆ°ï¼ŒUSBä¸»æœºæ§åˆ¶å™¨å°±ä¼šäº§ç”Ÿä¸€ä¸ªhub_irqä¸­æ–­ï¼Œæ§åˆ¶å™¨è°ƒç”¨hubçš„æ¢æµ‹å‡½æ•°ï¼Œæ¥è§£æè®¾å¤‡ä¿¡æ¯ã€‚</p><h3 id="hub-c-æºç åˆ†æ"><a href="#hub-c-æºç åˆ†æ" class="headerlink" title="hub.c æºç åˆ†æ"></a>hub.c æºç åˆ†æ</h3><p>hub.c æ–‡ä»¶å†…å®¹å¾ˆå¤šï¼Œä½†hub.h ä¸­å¯¹å¤–çš„æ¥å£è¿˜å¥½ã€‚æ•°æ®ç»“æ„ä¸»è¦å°±ä¸€ä¸ª <code>usb_hub, usb_port</code>ã€‚</p><p>hub å‚æ•°å¤ªå¤šäº†ï¼Œä¸”ä¸€å¼€å§‹ä¸æ–¹ä¾¿ç†è§£ã€‚å…ˆä» usb_port å¼€å§‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_hub</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_port</span>**<span class="title">ports</span>;</span> <span class="comment">/* array of usb_port pointers */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * struct usb port - kernel&#x27;s representation of a usb port</span></span><br><span class="line"><span class="comment"> * @child: usb device attached to the port</span></span><br><span class="line"><span class="comment"> * @dev: generic device interface</span></span><br><span class="line"><span class="comment"> * @port_owner: port&#x27;s owner</span></span><br><span class="line"><span class="comment"> * @peer: related usb2 and usb3 ports (share the same connector)</span></span><br><span class="line"><span class="comment"> * @req: default pm qos request for hubs without port power control</span></span><br><span class="line"><span class="comment"> * @connect_type: port&#x27;s connect type</span></span><br><span class="line"><span class="comment"> * @location: opaque representation of platform connector location</span></span><br><span class="line"><span class="comment"> * @status_lock: synchronize port_event() vs usb_port_&#123;suspend|resume&#125;</span></span><br><span class="line"><span class="comment"> * @portnum: port index num based one</span></span><br><span class="line"><span class="comment"> * @is_superspeed cache super-speed status</span></span><br><span class="line"><span class="comment"> * @usb3_lpm_u1_permit: whether USB3 U1 LPM is permitted.</span></span><br><span class="line"><span class="comment"> * @usb3_lpm_u2_permit: whether USB3 U2 LPM is permitted.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_port</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_device</span> *<span class="title">child</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">device</span> <span class="title">dev</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_dev_state</span> *<span class="title">port_owner</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usb_port</span> *<span class="title">peer</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dev_pm_qos_request</span> *<span class="title">req</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">usb_port_connect_type</span> <span class="title">connect_type</span>;</span></span><br><span class="line"><span class="type">usb_port_location_t</span> location;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">status_lock</span>;</span></span><br><span class="line">u32 over_current_count;</span><br><span class="line">u8 portnum;</span><br><span class="line">u32 quirks;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> is_superspeed:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> usb3_lpm_u1_permit:<span class="number">1</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> usb3_lpm_u2_permit:<span class="number">1</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Scripts-ç®¡ç†å¤šä¸ª git ä»“åº“</title>
      <link href="/2024/08/11/Scripts-git_tools/"/>
      <url>/2024/08/11/Scripts-git_tools/</url>
      
        <content type="html"><![CDATA[<h2 id="è„šæœ¬"><a href="#è„šæœ¬" class="headerlink" title="è„šæœ¬"></a>è„šæœ¬</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ANSIé¢œè‰²ç </span></span><br><span class="line">RED=<span class="string">&#x27;\033[0;31m&#x27;</span></span><br><span class="line">GREEN=<span class="string">&#x27;\033[0;32m&#x27;</span></span><br><span class="line">YELLOW=<span class="string">&#x27;\033[0;33m&#x27;</span></span><br><span class="line">BLUE=<span class="string">&#x27;\033[0;34m&#x27;</span></span><br><span class="line">NC=<span class="string">&#x27;\033[0m&#x27;</span> <span class="comment"># æ¢å¤é»˜è®¤é¢œè‰²</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Define special characters</span></span><br><span class="line">OK_STATUS=$<span class="string">&#x27;\u2714&#x27;</span>   <span class="comment"># âœ…</span></span><br><span class="line">FAIL_STATUS=$<span class="string">&#x27;\u274C&#x27;</span> <span class="comment"># âŒ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿å­˜å½“å‰ç›®å½•</span></span><br><span class="line">current_dir=$(<span class="built_in">pwd</span>)</span><br><span class="line">command_to_execute=<span class="string">&quot;\$1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># git log</span></span><br><span class="line"><span class="keyword">function</span> git_log &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å½“å‰åˆ†æ”¯åç§°</span></span><br><span class="line">current_branch=$(git rev-parse --abbrev-ref HEAD)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–é»˜è®¤è¿œç¨‹ä»“åº“åç§°</span></span><br><span class="line">remote=$(git for-each-ref --format=<span class="string">&#x27;%(upstream:short)&#x27;</span> <span class="string">&quot;<span class="subst">$(git symbolic-ref -q HEAD)</span>&quot;</span>)</span><br><span class="line">remote_name=<span class="variable">$&#123;remote%%/*&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥æ˜¯å¦å­˜åœ¨é»˜è®¤è¿œç¨‹ä»“åº“</span></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$remote</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>å½“å‰åˆ†æ”¯æ²¡æœ‰è¿½è¸ªè¿œç¨‹åˆ†æ”¯ã€‚<span class="variable">$&#123;NO_COLOR&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="comment"># æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰æœªæ¨é€çš„æäº¤</span></span><br><span class="line">local_commits=$(git <span class="built_in">log</span> <span class="variable">$&#123;remote&#125;</span>..HEAD --oneline)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$local_commits</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>å­˜åœ¨æœªåŒæ­¥åˆ°è¿œç¨‹ä»“åº“çš„æäº¤ (<span class="variable">$&#123;FAIL_STATUS&#125;</span>):<span class="variable">$&#123;NO_COLOR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$local_commits</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>å½“å‰åˆ†æ”¯å·²ç»å…¨éƒ¨åŒæ­¥åˆ°è¿œç¨‹ä»“åº“ (<span class="variable">$&#123;OK_STATUS&#125;</span> ).<span class="variable">$&#123;NO_COLOR&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥è¿œç¨‹æ˜¯å¦æœ‰æœªæ‹‰å–çš„æäº¤</span></span><br><span class="line">git fetch <span class="variable">$&#123;remote_name&#125;</span> &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">remote_commits=$(git <span class="built_in">log</span> HEAD..<span class="variable">$&#123;remote&#125;</span> --oneline)</span><br><span class="line"><span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$remote_commits</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span>è¿œç¨‹ä»“åº“å­˜åœ¨æœªæ‹‰å–çš„æäº¤ (<span class="variable">$&#123;FAIL_STATUS&#125;</span>):<span class="variable">$&#123;NO_COLOR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$remote_commits</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;GREEN&#125;</span>è¿œç¨‹ä»“åº“çš„æäº¤å·²ç»å…¨éƒ¨æ‹‰å–åˆ°æœ¬åœ° (<span class="variable">$&#123;OK_STATUS&#125;</span> ).<span class="variable">$&#123;NO_COLOR&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># git status function</span></span><br><span class="line"><span class="keyword">function</span> git_status &#123;</span><br><span class="line">git status</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&quot;</span></span><br><span class="line">git_log</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>==========================================================================<span class="variable">$&#123;NO_COLOR&#125;</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†å½“å‰ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•</span></span><br><span class="line"><span class="keyword">for</span> <span class="built_in">dir</span> <span class="keyword">in</span> */ ; <span class="keyword">do</span></span><br><span class="line"><span class="comment"># è¿›å…¥å­ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$dir</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥å­ç›®å½•ä¸­æ˜¯å¦å­˜åœ¨.gitç›®å½•</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;.git&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;BLUE&#125;</span>Executing &#x27;<span class="variable">$1</span>&#x27;, Current directory: <span class="subst">$(pwd)</span><span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="comment"># æ‰§è¡Œä¼ é€’è¿›æ¥çš„å‘½ä»¤</span></span><br><span class="line"><span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$command_to_execute</span>&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;<span class="variable">$&#123;YELLOW&#125;</span><span class="variable">$dir</span> is not a git repository<span class="variable">$&#123;NC&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿”å›åˆå§‹ç›®å½•</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$current_dir</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Operation completed for all repositories.&quot;</span></span><br></pre></td></tr></table></figure><p>å°†ä¸Šé¢çš„è„šæœ¬æ·»åŠ åˆ° <code>bin</code> ç›®å½•ä¸‹ï¼Œæˆ–è€…å¢åŠ  <code>PATH</code> ç¯å¢ƒå˜é‡ï¼Œä»¥ä¾¿ä»»æ„ä½ç½®éƒ½å¯ä»¥æ‰§è¡Œã€‚</p><h2 id="ç”¨æ³•"><a href="#ç”¨æ³•" class="headerlink" title="ç”¨æ³•"></a>ç”¨æ³•</h2><p>ä»¥ä¸Šè„šæœ¬å‘½åä¸º gitsï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gits <span class="string">&quot;git_status&quot;</span> <span class="comment"># éå†æ¯ä¸ªå­ç›®å½•ï¼Œå¦‚æœæ˜¯ git ä»“åº“ï¼Œæ‰§è¡Œ git status</span></span><br><span class="line">                  <span class="comment"># å¹¶æ£€æŸ¥æ˜¯å¦æœ‰æœªåŒæ­¥åˆ°è¿œç¨‹ä»“åº“çš„æäº¤ï¼Œæˆ–è€…æœªæ‹‰å–åˆ°æœ¬åœ°ä»“åº“çš„æäº¤</span></span><br><span class="line"></span><br><span class="line">gits <span class="string">&quot;git xxx&quot;</span> <span class="comment"># éå†æ¯ä¸ªå­ç›®å½•ï¼Œå¦‚æœæ˜¯ git ä»“åº“ï¼Œæ‰§è¡Œ git xxx</span></span><br><span class="line">               <span class="comment"># ä¾‹å¦‚ gits &quot;git fetch&quot;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Alios USB camera å¸¸è§éœ€æ±‚å¤„ç†</title>
      <link href="/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/"/>
      <url>/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/</url>
      
        <content type="html"><![CDATA[<h2 id="é…ç½®è¯´æ˜"><a href="#é…ç½®è¯´æ˜" class="headerlink" title="é…ç½®è¯´æ˜"></a>é…ç½®è¯´æ˜</h2><h3 id="ç»„ä»¶é…ç½®"><a href="#ç»„ä»¶é…ç½®" class="headerlink" title="ç»„ä»¶é…ç½®"></a>ç»„ä»¶é…ç½®</h3><p>æ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ª <code>.yaml</code> é…ç½®æ–‡ä»¶ï¼Œä¸»è¦å…³æ³¨ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">def_config:</span> <span class="comment"># ç»„ä»¶çš„å¯é…ç½®é¡¹</span></span><br><span class="line">  <span class="attr">CONFIG_XXX:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p><code>def_config</code> ä¸‹çš„é…ç½®éƒ½ä¼šä»¥å®å®šä¹‰çš„å½¢å¼æ¥å½±å“ä»£ç ã€‚å°±ç›¸å½“äºåœ¨ç¼–è¯‘æ—¶å¤šäº† <code>-DCONFIG_XXX=1</code> è¿™æ ·ã€‚</p><h3 id="Solution-é…ç½®"><a href="#Solution-é…ç½®" class="headerlink" title="Solution é…ç½®"></a>Solution é…ç½®</h3><p>Solution ä¹Ÿæœ‰ä¸€ä¸ª <code>yaml</code> çš„é…ç½®æ–‡ä»¶ï¼Œä¹ŸåŒ…å« <code>depends</code>ã€<code>def_config</code> ç­‰é…ç½®é¡¹ï¼Œè¿™é‡Œå•ç‹¬æ¥è®²ä¸»è¦æ˜¯æƒ³å¼ºè°ƒ <code>def_config</code> è¿™ä¸ªé…ç½®ï¼ŒSolution ä¸‹çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä¿®æ”¹ä»»æ„ç»„ä»¶çš„ <code>def_config</code> ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªç»„ä»¶ä¸‹çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œ<code>def_config</code> ä¸‹é…ç½®ç›¸å½“äºæ˜¯<em>é»˜è®¤é…ç½®</em>ã€‚å¦‚æœ Solution ä¸‹çš„é…ç½®é¡¹ä¸ç»„ä»¶çš„ä¸‹é…ç½®ä¸ä¸€è‡´ï¼Œä»¥ Solution çš„ä¸ºå‡†ã€‚</p><p><strong>â—â—å¼ºè°ƒï¼šSolution ä¸‹çš„é…ç½®ä¼šå¯¹æ‰€æœ‰ç»„ä»¶ç”Ÿæ•ˆï¼Œæ‰€ä»¥åœ¨å®šä¹‰é…ç½®çš„æ—¶å€™ï¼Œæ³¨æ„é…ç½®åæ˜¯å¦ä¸å…¶ä»–ç»„ä»¶é‡å¤äº†ï¼ˆå¯ä»¥é‡å¤ï¼Œä½†è¦ç¡®è®¤è¿™æ˜¯ä½ æœŸæœ›çš„ï¼‰ã€‚</strong></p><h2 id="ç”¨æˆ·å¸¸ç”¨æ”¹åŠ¨"><a href="#ç”¨æˆ·å¸¸ç”¨æ”¹åŠ¨" class="headerlink" title="ç”¨æˆ·å¸¸ç”¨æ”¹åŠ¨"></a>ç”¨æˆ·å¸¸ç”¨æ”¹åŠ¨</h2><ul><li><p><input checked="" disabled="" type="checkbox"> æ¿å¡å†…å­˜å¤§å°</p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_DRAM_CFG:</span> <span class="string">&quot;128m&quot;</span></span><br></pre></td></tr></table></figure></li><li><p><input checked="" disabled="" type="checkbox"> é…ç½® UVC æ•°é‡ã€‚æœ‰çš„å®¢æˆ·æ˜¯å•ç›®ï¼Œæœ‰çš„å®¢æˆ·æ˜¯åŒç›®ã€‚</p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_USBD_UVC_NUM:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure></li><li><p><input checked="" disabled="" type="checkbox"> ä¿®æ”¹ PID, VIDã€‚ï¼ˆè®¾å¤‡æè¿°ç¬¦é‡Œé¢ï¼‰</p></li><li><p><input checked="" disabled="" type="checkbox"> ä¿®æ”¹è®¾å¤‡åç§°ï¼ˆè§†é¢‘æ§åˆ¶æ¥å£æè¿°ç¬¦é‡Œé¢ã€‚åŒç›®åœºæ™¯ä¸€èˆ¬ä¸€ä¸ªrgbæ‘„åƒå¤´ + ä¸€ä¸ªçº¢å¤–æ‘„åƒå¤´ï¼Œéœ€è¦åˆ†åˆ«è®¾ç½®åå­—ä»¥åŒºåˆ†ï¼‰ã€‚</p></li><li><p><input checked="" disabled="" type="checkbox"> ä¿®æ”¹åºåˆ—å·ã€‚ï¼ˆè®¾å¤‡æè¿°ç¬¦é‡Œé¢ï¼‰</p></li><li><p><input checked="" disabled="" type="checkbox"> ä¿®æ”¹ PRODUCT IDï¼ˆè®¾å¤‡æè¿°ç¬¦é‡Œé¢ï¼‰</p></li><li><p><input checked="" disabled="" type="checkbox"> è§†é¢‘ç ç‡æ§åˆ¶ã€‚ï¼ˆMJPEG&#x2F;H264 H265ï¼‰</p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_MJPEG_BITRATE:</span> <span class="number">20480</span>          <span class="comment"># UVC æ¨æµæ—¶ï¼Œè®¾ç½®è§†é¢‘ç¼–ç å™¨ MJPEG çš„ç ç‡ï¼Œå•ä½ kbps</span></span><br><span class="line"><span class="attr">CONFIG_UVC_H264_H265_BITRATE:</span> <span class="number">4096</span>       <span class="comment"># UVC æ¨æµæ—¶ï¼Œè®¾ç½®è§†é¢‘ç¼–ç å™¨ H264/H265 çš„ç ç‡ï¼Œå•ä½ kbps</span></span><br></pre></td></tr></table></figure></li><li><p><input disabled="" type="checkbox"> ç¯å…‰äº®åº¦æ§åˆ¶ã€‚ï¼ˆé€šè¿‡ PWM è°ƒæ§ï¼‰</p></li><li><p><input checked="" disabled="" type="checkbox"> åˆ†è¾¨ç‡ã€‚ï¼ˆä¸åŒå®¢æˆ·éœ€è¦æ”¯æŒçš„åˆ†è¾¨ç‡ä¸ä¸€æ ·ï¼‰</p></li><li><p><input checked="" disabled="" type="checkbox"> æ”¯æŒé«˜åˆ†è¾¨ç‡ï¼ˆvpss ä»…ä¸€ä¸ªé€šé“æ”¯æŒ2880x1620)</p></li><li><p><input checked="" disabled="" type="checkbox"> <a href="#USBcamera%E9%80%9A%E7%94%A8%E5%8A%9F%E8%83%BD">USB camera é€šç”¨åŠŸèƒ½ï¼ˆäº®åº¦ã€è‰²è°ƒã€é¥±å’Œåº¦ç­‰è°ƒæ•´ï¼‰</a></p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_COMM_FUNC:</span> <span class="number">0</span>                  <span class="comment"># USB camera ä½¿èƒ½äº®åº¦ã€è‰²è°ƒã€å¯¹æ¯”åº¦ç­‰è°ƒæ•´åŠŸèƒ½</span></span><br></pre></td></tr></table></figure></li><li><p><input checked="" disabled="" type="checkbox"> <a href="#%E4%BF%9D%E6%8C%81%E8%BE%93%E5%87%BA%E9%95%BF%E5%AE%BD%E6%AF%94">è®¾ç½®è£å‰ªä»¥ä¿è¯ä»»æ„æ ¼å¼è¾“å‡ºä¸ä¼šå˜å½¢</a></p>  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_CROP_BEFORE_SCALE:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="æ¿å¡å†…å­˜å¤§å°"><a href="#æ¿å¡å†…å­˜å¤§å°" class="headerlink" title="æ¿å¡å†…å­˜å¤§å°"></a>æ¿å¡å†…å­˜å¤§å°</h3><p>1811cï¼Œ1810c ç­‰å†…å­˜å¤§å°ä¸ä¸€æ ·ï¼Œéœ€è¦æ›´å…·å®¢æˆ·ä½¿ç”¨çš„å…·ä½“èŠ¯ç‰‡æ¥è°ƒæ•´ã€‚</p><p><strong>é…ç½®é€‰é¡¹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_DRAM_CFG:</span> <span class="string">&quot;128m&quot;</span></span><br></pre></td></tr></table></figure><p><strong>é»˜è®¤é…ç½®</strong>ï¼š<code>64m</code></p><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/package.xxx.yaml</code></p><h3 id="UVC-æ•°é‡"><a href="#UVC-æ•°é‡" class="headerlink" title="UVC æ•°é‡"></a>UVC æ•°é‡</h3><p><strong>é…ç½®é€‰é¡¹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_USBD_UVC_NUM:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>é»˜è®¤é…ç½®</strong>ï¼š<code>1</code></p><p><strong>ç»„ä»¶é…ç½®ä½ç½®ï¼ˆé»˜è®¤é…ç½®ï¼‰</strong>ï¼š<code>components/cvi_platform/package.yaml</code></p><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/package.xxx.yaml</code></p><h3 id="PID-x2F-VID-ä¿®æ”¹"><a href="#PID-x2F-VID-ä¿®æ”¹" class="headerlink" title="PID&#x2F;VID ä¿®æ”¹"></a>PID&#x2F;VID ä¿®æ”¹</h3><p>æš‚æœªå®šä¹‰å®ã€‚ç›´æ¥ä¿®æ”¹å¯¹åº”æ–‡ä»¶ã€‚</p><p><strong>é…ç½®ä½ç½®</strong>ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CVITEK_VENDOR_ID        0x3346    <span class="comment">/* cvitek vendor id */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVITEK_PRODUCT_ID       0x0001    <span class="comment">/* Webcam A/V gadget */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVITEK_DEVICE_BCD       0x0001    <span class="comment">/* 0.01 */</span></span></span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹ä¸Šè¿°å®ï¼Œåœ¨è®¾å¤‡æè¿°ç¬¦ä¸­ä½¿ç”¨</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_descriptor</span> <span class="title">comp_device_descriptor</span> =</span> &#123;</span><br><span class="line">    .bLength            = USB_DT_DEVICE_SIZE,</span><br><span class="line">    .bDescriptorType    = USB_DT_DEVICE,</span><br><span class="line">    .bcdUSB             = USB_2_0,</span><br><span class="line">    .bDeviceClass       = USB_CLASS_MISC,</span><br><span class="line">    .bDeviceSubClass    = <span class="number">0x02</span>,</span><br><span class="line">    .bDeviceProtocol    = <span class="number">0x01</span>,</span><br><span class="line">    .bMaxPacketSize0    = <span class="number">0x40</span>,</span><br><span class="line">    .idVendor           = cpu_to_le16(CVITEK_VENDOR_ID),   # VID</span><br><span class="line">    .idProduct          = cpu_to_le16(CVITEK_PRODUCT_ID),  # PID</span><br><span class="line">    .bcdDevice          = cpu_to_le16(CVITEK_DEVICE_BCD),</span><br><span class="line">    .iManufacturer      = USB_STRING_MFC_INDEX,</span><br><span class="line">    .iProduct           = USB_STRING_PRODUCT_INDEX,</span><br><span class="line">    .iSerialNumber      = USB_STRING_SERIAL_INDEX,</span><br><span class="line">    .bNumConfigurations = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹åºåˆ—å·"><a href="#ä¿®æ”¹åºåˆ—å·" class="headerlink" title="ä¿®æ”¹åºåˆ—å·"></a>ä¿®æ”¹åºåˆ—å·</h3><p>åºåˆ—å·<code>iSerialNumber</code>æ˜¯åœ¨è®¾å¤‡æè¿°ä¸­æŒ‡å®šçš„ï¼ˆæŒ‡å®šå­—ç¬¦ä¸²æè¿°ç¬¦çš„IDï¼‰ã€‚è¦ä¿®æ”¹çš„è¯åªéœ€ä¿®æ”¹å¯¹åº”çš„å­—ç¬¦ä¸²æè¿°ç¬¦ã€‚</p><p><strong>é…ç½®ä½ç½®</strong>ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static const struct usb_descriptor_header * const comp_string_descriptors[] = &#123;</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_manufacturer,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;dev_string_descriptor_product,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_serial, // åºåˆ—å·å­—ç¬¦ä¸²æè¿°ç¬¦</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uac_string_descriptor_audio,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uvc_string_descriptor_camera1_name,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uvc_string_descriptor_camera2_name,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uvc_string_descriptor_camera3_name,</span><br><span class="line">    NULL,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// ä¿®æ”¹ `comp_string_descriptor_serial` å³å¯ã€‚</span><br><span class="line">// ç”±äº USB åè®®è§„å®šåºåˆ—å·æ˜¯ unicode ç¼–ç ï¼Œæ‰€ä»¥è¦ç”¨ `cpu_to_le16` è½¬æ¢ã€‚</span><br><span class="line">// å¹¶æ³¨æ„å­—ç¬¦ä¸²çš„é•¿åº¦å’Œå£°æ˜çš„ä¸€è‡´ã€‚</span><br><span class="line">DECLARE_UVC_STRING_DESCRIPTOR(10);</span><br><span class="line">static const struct UVC_STRING_DESCRIPTOR(10) comp_string_descriptor_serial = &#123;</span><br><span class="line">    .bLength            = UVC_STRING_DESCRIPTOR_SIZE(10),</span><br><span class="line">    .bDescriptorType    = USB_DESCRIPTOR_TYPE_STRING,</span><br><span class="line">    .wData              = &#123;</span><br><span class="line">        cpu_to_le16(&#x27;2&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;2&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;4&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;1&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;1&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;9&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="åŠ¨æ€ä¿®æ”¹åºåˆ—å·âœ¨"><a href="#åŠ¨æ€ä¿®æ”¹åºåˆ—å·âœ¨" class="headerlink" title="åŠ¨æ€ä¿®æ”¹åºåˆ—å·âœ¨"></a>åŠ¨æ€ä¿®æ”¹åºåˆ—å·âœ¨</h3><p>åŸºæœ¬éƒ½ä¼šç”¨åˆ°ã€‚</p><h3 id="ä¿®æ”¹-PRODUCT-ID"><a href="#ä¿®æ”¹-PRODUCT-ID" class="headerlink" title="ä¿®æ”¹ PRODUCT ID"></a>ä¿®æ”¹ PRODUCT ID</h3><p><code>product ID</code> ä¹Ÿæ˜¯åœ¨è®¾å¤‡æè¿°ä¸­æŒ‡å®šçš„<code>iProduct</code>ï¼ˆæŒ‡å®šå­—ç¬¦ä¸²æè¿°ç¬¦çš„IDï¼‰ã€‚è¦ä¿®æ”¹çš„è¯åªéœ€ä¿®æ”¹å¯¹åº”çš„å­—ç¬¦ä¸²æè¿°ç¬¦ã€‚</p><p><strong>é…ç½®ä½ç½®</strong>ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title function_">UVC_STRING_DESCRIPTOR</span><span class="params">(<span class="number">10</span>)</span> dev_string_descriptor_product = &#123;</span><br><span class="line">    .bLength            = UVC_STRING_DESCRIPTOR_SIZE(<span class="number">10</span>),</span><br><span class="line">    .bDescriptorType    = USB_DESCRIPTOR_TYPE_STRING,</span><br><span class="line">    .wData              = &#123;</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;I&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;T&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;K&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;-&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="è®¾å¤‡åç§°ä¿®æ”¹"><a href="#è®¾å¤‡åç§°ä¿®æ”¹" class="headerlink" title="è®¾å¤‡åç§°ä¿®æ”¹"></a>è®¾å¤‡åç§°ä¿®æ”¹</h3><p>è®¾å¤‡åç§°ä¹Ÿæ˜¯é€šè¿‡å­—ç¬¦ä¸²æè¿°ç¬¦ä¼ é€’ã€‚è§†é¢‘æ§åˆ¶æ¥å£æè¿°ç¬¦ä¸­çš„ <code>iInterface</code> æŒ‡å®šäº†åç§°å¯¹åº”çš„å­—ç¬¦ä¸²æè¿°ç¬¦çš„ä¸‹æ ‡ã€‚</p><p><strong>é…ç½®ä½ç½®</strong>ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_descriptor_header</span> * <span class="title">const</span> <span class="title">comp_string_descriptors</span>[] =</span> &#123;</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_manufacturer,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;dev_string_descriptor_product,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_serial,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uac_string_descriptor_audio,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uvc_string_descriptor_camera1_name, <span class="comment">// 3ä¸ªè®¾å¤‡åç§°æè¿°ç¬¦</span></span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uvc_string_descriptor_camera2_name,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uvc_string_descriptor_camera3_name,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* UVC Camera max name length is 32  */</span></span><br><span class="line">DECLARE_UVC_STRING_DESCRIPTOR(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title function_">UVC_STRING_DESCRIPTOR</span><span class="params">(<span class="number">32</span>)</span> uvc_string_descriptor_camera1_name = &#123;</span><br><span class="line">    .bLength            = UVC_STRING_DESCRIPTOR_SIZE(<span class="number">14</span>), <span class="comment">// name length is 14</span></span><br><span class="line">    .bDescriptorType    = USB_DESCRIPTOR_TYPE_STRING,</span><br><span class="line">    .wData              = &#123;</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;I&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;T&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;K&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27; &#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;M&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;R&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;1&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç›®å‰æœ€å¤§æ”¯æŒä¸‰ä¸ªæ‘„åƒå¤´ï¼Œæ‰€ä»¥è¿™é‡Œé¢„ç•™äº†ä¸‰ä¸ªè®¾å¤‡æè¿°ç¬¦ã€‚å¦‚éœ€ä¿®æ”¹åç§°ï¼Œä¿®æ”¹å¯¹åº”çš„æè¿°ç¬¦å³å¯ã€‚</p><p>â—â—<strong>æ³¨æ„</strong>ï¼šä¿®æ”¹ä¹‹åï¼ŒWindows éœ€è¦åœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­å¸è½½è®¾å¤‡ï¼Œå†æ’ä¸Šè®¾å¤‡æ‰èƒ½çœ‹çš„ä¿®æ”¹åçš„åå­—ã€‚(Windowsè‡ªèº«æœ‰ç¼“å­˜)</p><h3 id="è§†é¢‘ç ç‡æ§åˆ¶"><a href="#è§†é¢‘ç ç‡æ§åˆ¶" class="headerlink" title="è§†é¢‘ç ç‡æ§åˆ¶"></a>è§†é¢‘ç ç‡æ§åˆ¶</h3><p>ç›®å‰ <code>H264/H265</code> éƒ½æ˜¯åƒé…ç½® <code>CONFIG_UVC_H264_H265_BITRATE</code>ã€‚</p><p><code>MJPEG</code> æ ¼å¼çš„ç ç‡åˆ™æ˜¯é€šè¿‡ <code>CONFIG_UVC_MJPEG_BITRATE</code> é…ç½®ã€‚</p><p><strong>é…ç½®é€‰é¡¹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_MJPEG_BITRATE:</span> <span class="number">20480</span>          <span class="comment"># UVC æ¨æµæ—¶ï¼Œè®¾ç½®è§†é¢‘ç¼–ç å™¨ MJPEG çš„ç ç‡ï¼Œå•ä½ kbps</span></span><br><span class="line"><span class="attr">CONFIG_UVC_H264_H265_BITRATE:</span> <span class="number">4096</span>       <span class="comment"># UVC æ¨æµæ—¶ï¼Œè®¾ç½®è§†é¢‘ç¼–ç å™¨ H264/H265 çš„ç ç‡ï¼Œå•ä½ kbps</span></span><br></pre></td></tr></table></figure><p><strong>ç»„ä»¶é…ç½®ä½ç½®ï¼ˆé»˜è®¤é…ç½®ï¼‰</strong>ï¼š<code>components/cvi_platform/package.yaml</code></p><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/package.xxx.yaml</code></p><h3 id="è§†é¢‘æ ¼å¼è®¾ç½®"><a href="#è§†é¢‘æ ¼å¼è®¾ç½®" class="headerlink" title="è§†é¢‘æ ¼å¼è®¾ç½®"></a>è§†é¢‘æ ¼å¼è®¾ç½®</h3><p>ç›®å‰æ”¯æŒ <code>YUY2</code>ï¼Œ<code>H264</code>ï¼Œ<code>H265</code>ï¼Œ<code>MJPEG</code> 4 ç§æ ¼å¼å‡ºæµã€‚å…¶ä¸­ H264, H265 æœ‰ä¸€ä¸ª DISABLE é…ç½®é€‰é¡¹ï¼Œå› ä¸ºè¿™ä¸¤ç§ç¼–è§£ç æ–¹å¼éœ€è¦ä¸€ä¸ªå›ºä»¶ï¼ŒH264 çš„å›ºä»¶å¤§å°çº¦ä¸º253kï¼Œh265 çº¦ä¸º 147kï¼ŒæŸäº›åœºæ™¯ä¸‹flash å¤§å°ä¸å¤Ÿéœ€è¦ä¸¥æ ¼æ§åˆ¶å›ºä»¶å¤§å°ï¼Œå°±å¯ä»¥è€ƒè™‘disable h264&#x2F;h265ã€‚</p><p>ä¸è¿‡ç›®å‰release ç‰ˆæœ¬ä¸­ï¼Œcodec æ˜¯ä»¥.a é™æ€åº“çš„å½¢å¼æä¾›çš„ï¼Œé»˜è®¤æ˜¯ä½¿èƒ½äº†çš„ã€‚æ‰€ä»¥è¯¥é…ç½®æ„ä¹‰ä¸å¤§ã€‚</p><p><strong>é…ç½®é€‰é¡¹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_DISABLE_VENC_H264:</span> <span class="number">0</span>              <span class="comment"># æ˜¯å¦ç¦ç”¨ H264 ç¼–ç </span></span><br><span class="line"><span class="attr">CONFIG_DISABLE_VENC_H265:</span> <span class="number">0</span>              <span class="comment"># æ˜¯å¦ç¦ç”¨ H265 ç¼–ç </span></span><br></pre></td></tr></table></figure><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/package.xxx.yaml</code></p><h3 id="åˆ†è¾¨ç‡è®¾ç½®"><a href="#åˆ†è¾¨ç‡è®¾ç½®" class="headerlink" title="åˆ†è¾¨ç‡è®¾ç½®"></a>åˆ†è¾¨ç‡è®¾ç½®</h3><p>å¯ä¸ºä¸åŒè§†é¢‘æ ¼å¼é…ç½®å¤šç§ä¸åŒçš„åˆ†è¾¨ç‡ï¼Œç›´æ¥ä¿®æ”¹å¯¹äºçš„æè¿°æ•°ç»„ã€‚</p><p><strong>é…ç½®ä½ç½®</strong>ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_class/usbd_uvc/src/usbd_uvc.c</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static struct uvc_frame_info_st yuy2_frame_info[] = &#123;</span><br><span class="line">    &#123;1, 800, 600, 15, 0&#125;,</span><br><span class="line">    &#123;2, 640, 360, 15, 0&#125;,</span><br><span class="line">    &#123;3, 400, 300, 15, 0&#125;,</span><br><span class="line">    &#123;5, 480, 320, 15, 0&#125;,</span><br><span class="line">    &#123;6, 480, 360, 15, 0&#125;,</span><br><span class="line">    &#123;7, 1280, 720, 15, 0&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct uvc_frame_info_st mjpeg_frame_info[] = &#123;</span><br><span class="line">&#123;1, 240, 320, 30, 0&#125;,</span><br><span class="line">&#123;2, 320, 240, 30, 0&#125;,</span><br><span class="line">&#123;3, 480, 320, 30, 0&#125;,</span><br><span class="line">&#123;4, 640, 480, 30, 0&#125;,</span><br><span class="line">&#123;5, 656, 468, 30, 0&#125;,</span><br><span class="line">&#123;6, 720, 480, 30, 0&#125;,</span><br><span class="line">&#123;7, 800, 480, 30, 0&#125;,</span><br><span class="line">&#123;8, 864, 480, 30, 0&#125;,</span><br><span class="line">&#123;9, 800, 600, 30, 0&#125;,</span><br><span class="line">&#123;10, 1280, 720, 30, 0&#125;,</span><br><span class="line">&#123;11, 1920, 1080, 30, 0&#125;,</span><br><span class="line">&#123;12, 1600, 1200, 30, 0&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct uvc_frame_info_st h264_frame_info[] = &#123;</span><br><span class="line">    &#123;1, 800, 600, 30, 0&#125;,</span><br><span class="line">    &#123;2, 1280, 720, 30, 0&#125;,</span><br><span class="line">    &#123;3, 640, 480, 30, 0&#125;,</span><br><span class="line">    &#123;4, 400, 300, 30, 0&#125;,</span><br><span class="line">    &#123;5, 1920, 1080, 30, 0&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ ¼å¼ä¸ºï¼š<code>&#123;åºå·ï¼Œå®½ï¼Œé«˜ï¼Œå¸§ç‡ï¼Œæ˜¯å¦æ—‹è½¬&#125;</code>ã€‚</p><h3 id="æ”¯æŒé«˜åˆ†è¾¨ç‡"><a href="#æ”¯æŒé«˜åˆ†è¾¨ç‡" class="headerlink" title="æ”¯æŒé«˜åˆ†è¾¨ç‡"></a>æ”¯æŒé«˜åˆ†è¾¨ç‡</h3><p>è§†é¢‘æµå¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¼šç”¨åˆ°ä¸€äº›ä¸­é—´å˜é‡æ¥å­˜æ”¾å›¾åƒæ•°æ®ï¼Œç›®å‰è¯¥å˜é‡çš„å¤§å°æ˜¯é¢„å…ˆç¡®å®šçš„ï¼Œå³ <code>DEFAULT_FRAME_SIZE</code>ã€‚é»˜è®¤åˆ†é…çš„å¤§å°æ˜¯1920x1080x1.5ã€‚</p><p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒMJEPG&#x2F;H264&#x2F;H265 ç­‰éœ€è¦å­˜æ”¾çš„éƒ½æ˜¯ç¼–ç åçš„æ•°æ®ï¼Œå³ä½¿æ˜¯ 2560x1440 ç»è¿‡ç¼–ç åä¹Ÿå®Œå…¨èƒ½å­˜æ”¾ä¸‹ï¼Œä½†æˆ‘ä»¬è¿˜æ”¯æŒæœªå‹ç¼©çš„ YUY2 æ ¼å¼ï¼Œè‹¥éœ€è¦è¾“å‡º 1920x1080 çš„ YUY2 æ ¼å¼ï¼Œåˆ™ä¸Šè¿°ç©ºé—´å°±ä¸å¤Ÿç”¨äº†ã€‚éœ€è¦è®¾ç½®ä¸º 1920x1080x2ï¼Œå¦å¤–ï¼Œå¤„ç†è¿‡ç¨‹ä¸­è¿˜éœ€è¦å†åŸå§‹å›¾åƒæ•°æ®çš„åŸºç¡€ä¸Šï¼Œæ¯1012å­—èŠ‚åŠ ä¸Š12å­—èŠ‚çš„headerï¼Œæ‰€ä»¥è¿˜éœ€é¢å¤–åˆ†é… äº›ç©ºé—´ã€‚ç›®å‰å»ºè®®è®¾ç½®  1920x1120x2</p><p><strong>é…ç½®ä½ç½®</strong>ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_class/usbd_uvc/src/usbd_uvc.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WIDTH  (unsigned int)(1920)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEIGHT (unsigned int)(1080)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAM_FPS        (30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERVAL       (unsigned long)(10000000 / CAM_FPS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 3 / 2)</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¸º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WIDTH  (unsigned int)(1920)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEIGHT (unsigned int)(1120)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAM_FPS        (30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERVAL       (unsigned long)(10000000 / CAM_FPS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 2)</span></span><br></pre></td></tr></table></figure><h3 id="æ”¯æŒ-2880x1440-ç­‰é«˜åˆ†è¾¨ç‡"><a href="#æ”¯æŒ-2880x1440-ç­‰é«˜åˆ†è¾¨ç‡" class="headerlink" title="æ”¯æŒ 2880x1440 ç­‰é«˜åˆ†è¾¨ç‡"></a>æ”¯æŒ 2880x1440 ç­‰é«˜åˆ†è¾¨ç‡</h3><p>å‚è€ƒ ã€ŠCvitek Debug SOPã€‹</p><p>è¿™ä¸ªé—®é¢˜æ˜¯ç”±vpsså„scalerç¡¬ä»¶æ€§èƒ½å·®å¼‚å¯¼è‡´çš„ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦ä½¿ç”¨æœ€å¼ºçš„scaler-1è¿›è¡Œæ‰€éœ€å›¾åƒå¤„ç†ã€‚å…·ä½“çš„ï¼Œå¯¹äºsingle modeï¼Œéœ€è¦è®¾ç½®vpss chnçš„chnå·ä¸º1ï¼Œ<strong>å¯¹äºdual modeï¼Œéœ€è¦è®¾ç½® grp å±æ€§ä¸­çš„u8VpssDevä¸º1ä¸”è®¾ç½®vpss chnçš„chnå·ä¸º0</strong>ã€‚</p><p><strong>æ¨èè§£å†³åŠæ³•ï¼šå³ä½¿å•ä¸ªè®¾å¤‡ä¹Ÿä½¿ç”¨dual mode</strong>ã€‚</p><p>å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ single mode å¹¶è®¾ç½®é€šé“ä¸º1çš„è¯ï¼Œç›®å‰è¿˜ä¼šå¯ç”¨é€šé“0ï¼Œä¼šå ç”¨é¢å¤–çš„VBï¼Œä¹Ÿå¯ä»¥åˆå…¥è¿™ç¬”ä»£ç  <a href="https://gerrit-ai.sophgo.vip:8443/#/c/114453/%EF%BC%8C%E4%B8%8D%E5%90%AF%E7%94%A8chn0%E3%80%82%E8%BF%99%E6%A0%B7%E8%BF%98%E9%9C%80%E4%BF%AE%E6%94%B9uvc">https://gerrit-ai.sophgo.vip:8443/#/c/114453/ï¼Œä¸å¯ç”¨chn0ã€‚è¿™æ ·è¿˜éœ€ä¿®æ”¹uvc</a> ä½¿ç”¨çš„é€šé“å·ä¸º1.  VPSS å’Œvencçš„ç»‘å®šå…³ç³»åœ¨ï¼š<code>components/cvi_platform/protocol/usb_devices/usbd_class/usbd_uvc/src/usbd_uvc.c</code> ä¸­<code>uvc</code>è¿™ä¸ªå…¨å±€å˜é‡ä¸‹é…ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct uvc_device_info uvc[USBD_UVC_MAX_NUM] = &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    // .ep = 0x81,</span><br><span class="line">    .format_info = uvc_format_info,</span><br><span class="line">    .formats = ARRAY_SIZE(uvc_format_info),</span><br><span class="line">    .video = &#123;0, 0, 1&#125;, // &#123;venc chn, vpss grp, vpss chn&#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><h3 id="USBcameraé€šç”¨åŠŸèƒ½"><a href="#USBcameraé€šç”¨åŠŸèƒ½" class="headerlink" title="USBcameraé€šç”¨åŠŸèƒ½"></a>USBcameraé€šç”¨åŠŸèƒ½</h3><blockquote><p>å…¶ä»–é¡¹ç›®ä¹Ÿä¼šç”¨åˆ° usbcameraï¼Œä½†å¹¶ä¸éœ€è¦è°ƒæ•´è‰²è°ƒç­‰åŠŸèƒ½ï¼Œæ‰€ä»¥ç›®å‰ SDK é»˜è®¤å¹¶æœªå¯ç”¨è¿™äº›åŠŸèƒ½ã€‚</p><p>å¦‚éœ€å¯ç”¨ï¼Œéœ€è¦é€šè¿‡é…ç½® <code>CONFIG_UVC_COMM_FUNC:1</code>ï¼Œåˆ™å°†ç›®å‰æ”¯æŒçš„åŠŸèƒ½éƒ½å¯ç”¨ã€‚</p></blockquote><p><strong>é…ç½®é€‰é¡¹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_COMM_FUNC:</span> <span class="number">0</span>                  <span class="comment"># USB camera ä½¿èƒ½äº®åº¦ã€è‰²è°ƒã€å¯¹æ¯”åº¦ç­‰è°ƒæ•´åŠŸèƒ½</span></span><br></pre></td></tr></table></figure><p><strong>é»˜è®¤é…ç½®</strong>ï¼š<code>0</code> æœªå¯ç”¨ã€‚</p><p><strong>ç»„ä»¶é…ç½®ä½ç½®ï¼ˆé»˜è®¤é…ç½®ï¼‰</strong>ï¼š<code>components/cvi_platform/package.yaml</code></p><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/package.xxx.yaml</code></p><p><strong>æ³¨æ„</strong>ï¼šç”±äºæœ‰å¤šç›® sensor çš„åœºæ™¯ï¼Œåœ¨ç‰¹å®šæ‘„åƒå¤´ä¸‹è¿›è¡Œé…ç½®çš„æ—¶å€™ï¼Œä¼šåŒºåˆ†è®¾å¤‡çš„ã€‚è®¾å¤‡éœ€è¦ä¸å¯¹åº”çš„ VPSS GRP, VI_PIPE ç»‘å®šï¼Œå¿…é¡»æ»¡è¶³ä»¥ä¸‹å…³ç³»ï¼š</p><p>SENSOR0 -&gt; VI_PIPE0 -&gt; GRP0</p><p>SENSOR1 -&gt; VI_PIPE1 -&gt; GRP1</p><p>å¦åˆ™è®¾ç½®æ— æ³•ç”Ÿæ•ˆã€‚</p><p><strong>VI ç»‘å®š VPSS</strong> æ˜¯åœ¨ <code>solutions/usb_cam/customization/&#123;xxx&#125;/param/custom_vpssparam.c</code> ä¸­ï¼ŒGroup é…ç½®ä¸­æœ‰å¦‚ä¸‹å†…å®¹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.bBindMode = CVI_TRUE,</span><br><span class="line">.astChn[<span class="number">0</span>] = &#123;</span><br><span class="line">    .enModId = CVI_ID_VI,</span><br><span class="line">    .s32DevId = <span class="number">0</span>,</span><br><span class="line">    .s32ChnId = <span class="number">1</span>,  <span class="comment">// VI CHN ID</span></span><br><span class="line">&#125;,</span><br><span class="line">.astChn[<span class="number">1</span>] = &#123;</span><br><span class="line">    .enModId = CVI_ID_VPSS,</span><br><span class="line">    .s32DevId = <span class="number">1</span>,  <span class="comment">// group ID</span></span><br><span class="line">    .s32ChnId = <span class="number">0</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>ç›®å‰æ”¯æŒçš„åŠŸèƒ½æœ‰ï¼š</p><ul><li><input disabled="" type="checkbox"> PROCESSING UNIT<ul><li><input checked="" disabled="" type="checkbox"> äº®åº¦</li><li><input checked="" disabled="" type="checkbox"> å¯¹æ¯”åº¦</li><li><input checked="" disabled="" type="checkbox"> è‰²è°ƒ</li><li><input checked="" disabled="" type="checkbox"> é¥±å’Œåº¦</li><li><input checked="" disabled="" type="checkbox"> é”åº¦</li></ul></li><li><input disabled="" type="checkbox"> INPUT TERMINAL(CAMERA TERMINAL)<ul><li><input checked="" disabled="" type="checkbox"> PANTILEä¸Šä¸‹å·¦å³ç§»åŠ¨(ç»å¯¹)</li></ul></li><li><input disabled="" type="checkbox"> EXTENSION UNIT<ul><li><input checked="" disabled="" type="checkbox"> REBOOTï¼ˆå‘é€ reboot ä¼šé‡å¯ï¼Œæ— æ’æ‹”çƒ§å½•æ—¶ç”¨ï¼‰</li></ul></li></ul><h3 id="ä¿æŒè¾“å‡ºé•¿å®½æ¯”"><a href="#ä¿æŒè¾“å‡ºé•¿å®½æ¯”" class="headerlink" title="ä¿æŒè¾“å‡ºé•¿å®½æ¯”"></a>ä¿æŒè¾“å‡ºé•¿å®½æ¯”</h3><p>å½“sensorçš„è¾“å…¥å›¾åƒä¸º 16:9 æ—¶ï¼Œè‹¥è¾“å‡ºçš„åˆ†è¾¨ç‡ä¸º 4:3 ï¼Œä¼šçœ‹åˆ°è¾“å‡ºçš„å›¾åƒæ˜æ˜¾å‘ç”Ÿç•¸å˜ &#x2F; æˆ–è€…è¯´æœ‰é»‘è¾¹ï¼ˆ<strong>å–å†³äº vpss é€šé“çš„ ASPECT_RATIO_S å‚æ•°è®¾ç½®</strong>ï¼‰ã€‚å¯ä»¥ä½¿èƒ½è¯¥é…ç½® <code>CONFIG_UVC_CROP_BEFORE_SCALE:1</code>ï¼Œåœ¨è¿›è¡Œç¼©æ”¾å‰å…ˆè¿›è¡Œè£å‰ªï¼Œä½¿è£å‰ªåçš„å¤§å°ä¸è¾“å‡ºçš„é•¿å®½æ¯”ä¸€è‡´ï¼Œå¹¶ä¸”å°½å¯èƒ½æä¾›æ›´å¤§çš„è§†é‡ã€‚è¿™æ ·ç»è¿‡ç¼©æ”¾å°±ä¸ä¼šå‘ç”Ÿç•¸å˜ã€‚</p><p><strong>é…ç½®é€‰é¡¹</strong>ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_CROP_BEFORE_SCALE:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p><strong>é»˜è®¤é…ç½®</strong>ï¼š<code>1</code></p><p><strong>ç»„ä»¶é…ç½®ä½ç½®ï¼ˆé»˜è®¤é…ç½®ï¼‰</strong>ï¼š<code>components/cvi_platform/package.yaml</code></p><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/package.xxx.yaml</code></p><h3 id="ä¿æŒè¾“å‡ºé•¿å®½æ¯”2â€“æ˜¯å¦æ’é»‘è¾¹"><a href="#ä¿æŒè¾“å‡ºé•¿å®½æ¯”2â€“æ˜¯å¦æ’é»‘è¾¹" class="headerlink" title="ä¿æŒè¾“å‡ºé•¿å®½æ¯”2â€“æ˜¯å¦æ’é»‘è¾¹"></a>ä¿æŒè¾“å‡ºé•¿å®½æ¯”2â€“æ˜¯å¦æ’é»‘è¾¹</h3><p>VPSS åœ¨ç¼©æ”¾å¤„ç†æ—¶ï¼Œå¯ä»¥æŒ‡å®šå‚æ•°æ˜¯å¦ä¿å­˜é•¿å®½æ¯”ã€‚</p><p>å¦‚ 1280x720çš„å±å¹•ï¼Œå¦‚æœè¾“å‡ºçš„ç”»é¢æ˜¯ 800x400ï¼Œ</p><ul><li>AUTO ä¿æŒæ¯”ä¾‹çš„è¯å°±ä¼šæ‹‰ä¼¸ä¸º960x720ï¼Œå·¦å³ä¸¤è¾¹å°±ä¼šæœ‰é»‘è¾¹ã€‚</li><li>NONE ä¸è¿›è¡Œå¤„ç†ï¼ŒåŸå§‹å¤§å°è¾“å‡ºã€‚ï¼ˆç”»é¢å¯èƒ½ä¼šå˜å½¢ï¼Œæ¯”å¦‚16:9çš„è¾“å…¥ï¼Œè¾“å‡ºä¸º4:3æ—¶ï¼‰</li><li>MANUAL æ‰‹åŠ¨æŒ‡å®šæ˜¾ç¤ºçš„ä½ç½®ï¼Œä»¥åŠæ˜¾ç¤ºç”»é¢çš„å®½ã€é«˜ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ASPECT_RATIO_S</span> &#123;</span></span><br><span class="line">    ASPECT_RATIO_E enMode;      <span class="comment">// æ˜¯å¦å›ºå®šé•¿å®½æ¯”ï¼šNONE, AUTO, MANUAL</span></span><br><span class="line">    CVI_BOOL bEnableBgColor;    <span class="comment">// æ˜¯å¦è¦è®©ç”»é¢ä»¥å¤–ä»¥èƒŒæ™¯è‰²è¦†ç›–ã€‚</span></span><br><span class="line">    CVI_U32 u32BgColor;         <span class="comment">// å¡«å……èƒŒæ™¯é¢œè‰²ï¼ŒRGB 888ï¼Œå¯é€šè¿‡å® RGB_8BIT(0, 0, 0xFF) æ¥æŒ‡å®šã€‚bit[7:0]ç‚º Bï¼Œbit[15:8]ç‚º Gï¼Œbit[23:16]ç‚º R</span></span><br><span class="line">    RECT_S stVideoRect;         <span class="comment">// åœ¨æ‰‹åŠ¨æ¨¡å¼æ—¶æ‰ç”Ÿæ•ˆï¼Œè¿™ä¸ª RECT</span></span><br><span class="line">&#125; ASPECT_RATIO_S;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">ASPECT_RATIO_E</span> &#123;</span></span><br><span class="line">    ASPECT_RATIO_NONE = <span class="number">0</span>,      <span class="comment">// æ— åŠ¨ä½œï¼Œæ»¡å±</span></span><br><span class="line">    ASPECT_RATIO_AUTO,          <span class="comment">// è§†é¢‘ä¿æŒæ¯”ä¾‹ï¼Œè‡ªåŠ¨è®¡ç®—è§†é¢‘åŒºåŸŸ</span></span><br><span class="line">    ASPECT_RATIO_MANUAL,        <span class="comment">// æ‰‹åŠ¨å†³å®šè§†é¢‘åŒºåŸŸ</span></span><br><span class="line">    ASPECT_RATIO_MAX</span><br><span class="line">&#125; ASPECT_RATIO_E;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RECT_S</span> &#123;</span></span><br><span class="line">    CVI_S32 s32X;</span><br><span class="line">    CVI_S32 s32Y;</span><br><span class="line">    CVI_U32 u32Width;</span><br><span class="line">    CVI_U32 u32Height;</span><br><span class="line">&#125; RECT_S;</span><br></pre></td></tr></table></figure><p><strong>ç”¨æˆ·ï¼ˆç‰¹å®šé¡¹ç›®ï¼‰é…ç½®ä½ç½®</strong>ï¼š<code>solutions/usb_cam/customization/&#123;é¡¹ç›®xxx&#125;/param/custom_vpssparam.c</code> ä¸ºæ¯ä¸ª vpss é€šé“å•ç‹¬é…ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PARAM_CLASSDEFINE(PARAM_VPSS_CHN_CFG_S, CHNCFG, GRP0, CHN) [] =</span><br><span class="line">&#123;</span><br><span class="line">   &#123;.u8Rotation = ROTATION_0,</span><br><span class="line">    .stVpssChnAttr = &#123;</span><br><span class="line">            .u32Width = <span class="number">2880</span>,</span><br><span class="line">            .u32Height = <span class="number">1620</span>,</span><br><span class="line">            .enVideoFormat = VIDEO_FORMAT_LINEAR,</span><br><span class="line">            .enPixelFormat = PIXEL_FORMAT_NV21,</span><br><span class="line">            .stFrameRate.s32SrcFrameRate = <span class="number">-1</span>,</span><br><span class="line">            .stFrameRate.s32DstFrameRate = <span class="number">-1</span>,</span><br><span class="line">            .bFlip = CVI_FALSE,</span><br><span class="line">            .bMirror = CVI_FALSE,</span><br><span class="line">            .u32Depth = <span class="number">0</span>,</span><br><span class="line">            .stAspectRatio.enMode = ASPECT_RATIO_AUTO, <span class="comment">// ä¿æŒæ¯”ä¾‹ï¼Œä¼šæœ‰é»‘è¾¹ï¼Œæœªé…ç½®çš„è¯å°±æ˜¯æ‹‰ä¼¸</span></span><br><span class="line">            .stAspectRatio.bEnableBgColor = CVI_TRUE,</span><br><span class="line">            .stAspectRatio.u32BgColor    = COLOR_RGB_BLACK,</span><br><span class="line">            .stNormalize.bEnable = CVI_FALSE,</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure><h3 id="å¯ç”¨-pqtool-æ”¯æŒ"><a href="#å¯ç”¨-pqtool-æ”¯æŒ" class="headerlink" title="å¯ç”¨ pqtool æ”¯æŒ"></a>å¯ç”¨ pqtool æ”¯æŒ</h3><p>â—â—<strong>æ³¨æ„ç¼–è¯‘æ—¶è¦æŒ‡å®šæ­£ç¡®çš„ <code>CHIP_ARCH</code> ï¼Œå¦åˆ™ä¼šå¯¼è‡´ pqtool å·¥å…·ä½¿ç”¨æ—¶æŠ¥é”™</strong>ã€‚é€šè¿‡ <code>export CHIP_ARCH=cv181x; make usb_cam PROJECTS=&quot;XXXX&quot;</code>  ç¼–è¯‘ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_PQTOOL_SUPPORT:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">CONFIG_USBD_CDC_RNDIS:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">CONFIG_USBD_UVC:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">CONFIG_USB_DWC2_DMA_ENABLE:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">CONFIG_APP_RTSP_SUPPORT:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>å¯ç”¨ pqtool_support ä»¥åŠ rndis ç½‘ç»œæ‰èƒ½è®©pcç«¯å·¥å…·è¿ä¸Šã€‚ä½¿ç”¨ UVC å‡ºæµæ•ˆæœæ¯” rtsp æ›´å¥½ã€‚<br>DMA ä¸ rndis ä¸å…¼å®¹ï¼Œæ‰€ä»¥è¦å…³é—­ã€‚ä¸è¿‡ç›®å‰ä¸å¼€ DMA ä¼šæœ‰æ¦‚ç‡å±é—ªï¼Œæ‰€ä»¥ä»…æ¨èåœ¨è°ƒè¯•æ—¶å…³é—­DMAã€‚<br>RTSP ä¸ UVC ä¸å…¼å®¹ï¼Œæ‰€ä»¥è¦å…³é—­ã€‚</p><p><strong>ç›®å‰ RNDIS  æœ‰æ¦‚ç‡å‡ºé”™ï¼Œå‘ç°è¿ä¸ä¸Šçš„è¯åœ¨è®¾å¤‡ç®¡ç†å™¨ä¸­ï¼Œç¦ç”¨ rndis å¯¹åº”çš„è®¾å¤‡å†å¯ç”¨ã€‚</strong></p><p>æ¿ç«¯é»˜è®¤çš„ IP åœ°å€æ˜¯ <code>192.168.11.10</code>ï¼ŒPCç«¯å¯¹åº”çš„ rndis ç½‘å¡çš„ IP ä¹Ÿéœ€è¦æ‰‹åŠ¨è®¾ç½®åˆ°ç›¸åŒç½‘æ®µï¼Œæ‰èƒ½ä½¿ç”¨ Pqtool å·¥å…·è¿›è¡Œè¿æ¥ã€‚</p><h3 id="å¿«å¯è¯´æ˜"><a href="#å¿«å¯è¯´æ˜" class="headerlink" title="å¿«å¯è¯´æ˜"></a>å¿«å¯è¯´æ˜</h3><p>ä¸ºäº†èƒ½ä½¿ç”¨USBçƒ§å½•ï¼Œåœ¨romé˜¶æ®µä¼šç­‰å¾…1sæ£€æµ‹usbè¿æ¥ï¼Œè¿˜æœ‰uartçƒ§å½•çš„å¼•è„šè¢«å ç”¨ï¼Œä¹Ÿä¼šç­‰å¾…1sã€‚</p><ul><li><p>å¿«å¯1ï¼šé€šè¿‡å†™ efuse è·³è¿‡ rom é˜¶æ®µçš„çƒ§å½•æ£€æµ‹ã€‚</p><ul><li>é…ç½®ï¼š<code>CONFIG_ENABLE_FASTBOOT=1</code>ï¼Œå¯ç”¨åï¼Œapp_main ä¸­ä¼šè°ƒç”¨ <code>CVI_EFUSE_EnableFastBoot</code> å»çƒ§å†™ efuse ä½¿èƒ½å¿«å¯ã€‚</li><li>æ”¶ç›Šï¼š1sæ•´æˆ–2sæ•´ã€‚</li></ul></li><li><p>å¿«å¯2ï¼šboot0 é˜¶æ®µé€šè¿‡æ‹‰é«˜ SPI çš„é€Ÿç‡åŠ é€Ÿä»flash loadå›ºä»¶çš„è¿‡ç¨‹ã€‚æ¥æå‡å¯åŠ¨é€Ÿåº¦ã€‚</p><ul><li>é…ç½®ï¼š<code>CONFIG_QUICK_STARTUP_SUPPORT</code>ã€‚å¯ç”¨å boot0 ä¸­ä¼šæ‹‰é«˜ spi çš„æ—¶é’Ÿã€‚</li><li>æ”¶ç›Šï¼šçœ‹yoc.binï¼Œæˆ–è€…æ˜¯å¦éœ€è¦ä»flashåŠ è½½æ¨¡å‹å§ï¼Œæ”¶ç›Šä¸å¤§ï¼Œå¯èƒ½å°±å‡ åmsã€‚</li></ul></li></ul><h3 id="AE-å¿«é€Ÿæ”¶æ•›"><a href="#AE-å¿«é€Ÿæ”¶æ•›" class="headerlink" title="AE å¿«é€Ÿæ”¶æ•›"></a>AE å¿«é€Ÿæ”¶æ•›</h3><p>è‹¥ sensor çš„è‡ªåŠ¨æ›å…‰è°ƒæ•´è¾ƒæ…¢ï¼Œåœ¨åˆšæ‰“å¼€sensoræ—¶ï¼Œå¯èƒ½ä¼šçœ‹åˆ°æ˜æ˜¾çš„ç”»é¢äº®åº¦è°ƒæ•´çš„è¿‡ç¨‹ã€‚å¯ä»¥è°ƒæ•´pqå‚æ•°ï¼Œè°ƒå¤§è‡ªåŠ¨æ›å…‰çš„è°ƒæ•´é€Ÿç‡ã€‚</p><h3 id="æ‘„åƒå¤´å¼€å¯å…³é—­æ—¶è¿›è¡Œé¢å¤–å¤„ç†"><a href="#æ‘„åƒå¤´å¼€å¯å…³é—­æ—¶è¿›è¡Œé¢å¤–å¤„ç†" class="headerlink" title="æ‘„åƒå¤´å¼€å¯å…³é—­æ—¶è¿›è¡Œé¢å¤–å¤„ç†"></a>æ‘„åƒå¤´å¼€å¯å…³é—­æ—¶è¿›è¡Œé¢å¤–å¤„ç†</h3><p>ç›®å‰æ˜¯ä¸ºæ¯ä¸ªæ‘„åƒå¤´å»ºç«‹äº†ä¸€ä¸ªå¤„ç†çº¿ç¨‹ï¼Œå®Œæˆ UVC æ¨æµã€‚è¯¥çº¿ç¨‹ä¸­æ¯ä¸€æ¬¡è°ƒç”¨<code>vedio_streaming_send</code>å‘é€ä¸€å¸§ï¼Œé€šè¿‡æ£€æŸ¥stream_onçš„å˜åŒ–æƒ…å†µï¼Œç¡®å®šå½“å‰çš„çŠ¶æ€ã€‚stream_on ç”± 0-&gt;1 æ—¶è¡¨ç¤ºæ‰“å¼€äº†è®¾å¤‡ã€‚åä¹‹å…³é—­æ‘„åƒå¤´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">send_to_uvc</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int64_t</span> dev_index = (<span class="type">int64_t</span>)arg;</span><br><span class="line"><span class="type">bool</span> last_stream_on = <span class="literal">false</span>;</span><br><span class="line"><span class="type">bool</span> cur_stream_on = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (av_session_init_flag) &#123;</span><br><span class="line">cur_stream_on = uvc[dev_index].streaming_on;</span><br><span class="line"><span class="keyword">if</span> (cur_stream_on != last_stream_on) &#123;</span><br><span class="line">last_stream_on = cur_stream_on;</span><br><span class="line"><span class="keyword">if</span> (last_stream_on) &#123; <span class="comment">// å¼€å§‹æ¨æµ</span></span><br><span class="line"><span class="comment">// led gpio up, restart sensor, etc.</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// åœæ­¢æ¨æµ</span></span><br><span class="line"><span class="comment">// led gpio down, standby sensor, etc.</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(cur_stream_on) &#123;</span><br><span class="line">vedio_streaming_send(&amp;uvc[dev_index], dev_index);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">aos_msleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¯å…‰æ§åˆ¶"><a href="#ç¯å…‰æ§åˆ¶" class="headerlink" title="ç¯å…‰æ§åˆ¶"></a>ç¯å…‰æ§åˆ¶</h4><p>æ¨æµæ—¶å¼€ç¯ï¼Œåœæ­¢æ¨æµæ—¶å…³ç¯ã€‚ç®€å•çš„å¼€å…³å¯ç›´æ¥åœ¨ä¸Šé¢çš„æµç¨‹ä¸­å®ç°ï¼Œæœ‰äº›åœºæ™¯å¯è€ƒè™‘ä½¿ç”¨UVC å¤„ç†å•å…ƒä¸­çš„ backlightï¼Œ é€šè¿‡pwmå»æ§åˆ¶ç¯å…‰ã€‚</p><h4 id="standby-sensor-é™ä½åŠŸè€—"><a href="#standby-sensor-é™ä½åŠŸè€—" class="headerlink" title="standby sensor é™ä½åŠŸè€—"></a>standby sensor é™ä½åŠŸè€—</h4><p>åœ¨ä¸å‡ºæµçš„æ—¶å€™ï¼ˆå¾…æœºçŠ¶æ€ï¼‰ï¼Œå°† sensor standbyï¼Œä»¥é™ä½æ•´æœºåŠŸè€—ã€‚standby ä¸€èˆ¬æœ‰ä¸¤ä¸­æ–¹å¼ï¼š</p><ul><li>è½¯ä»¶standbyï¼šé€šè¿‡I2Cå‘é€æŒ‡ä»¤ï¼Œè®©sensorè¿›å…¥standbyæ¨¡å¼ï¼ˆä»ä¼šæœ‰è¾ƒä½çš„åŠŸè€—ï¼Œä»¥ç¡®ä¿èƒ½æ¥å—I2Cçš„å”¤é†’æŒ‡ä»¤ï¼‰</li><li>ç¡¬ä»¶standbyï¼šæ‹‰ä½sensorçš„powerdownå¼•è„šï¼Œè¿›è¡Œstandbyã€‚åŠŸè€—æ¯”è½¯ä»¶æ›´ä½ã€‚</li></ul><h3 id="è¶…é¢‘"><a href="#è¶…é¢‘" class="headerlink" title="è¶…é¢‘"></a>è¶…é¢‘</h3><p>clkstat å‘½ä»¤å¯ä»¥çœ‹æ—¶é’Ÿã€‚</p><h3 id="å¸¦å®½æ§åˆ¶"><a href="#å¸¦å®½æ§åˆ¶" class="headerlink" title="å¸¦å®½æ§åˆ¶"></a>å¸¦å®½æ§åˆ¶</h3><h3 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆå§‹åŒ–è®¡æ•°å™¨</span></span><br><span class="line"><span class="variable">$counter</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$true</span>) &#123;</span><br><span class="line">    <span class="comment"># å¢åŠ è®¡æ•°å™¨</span></span><br><span class="line">    <span class="variable">$counter</span>++</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è¾“å‡ºå½“å‰æ¬¡æ•°</span></span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">&quot;å½“å‰æ¬¡æ•°: <span class="variable">$counter</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¯åŠ¨åä¸º &#x27;xxx.exe&#x27; çš„ç¨‹åº</span></span><br><span class="line">    <span class="variable">$process</span> = <span class="built_in">Start-Process</span> <span class="string">&quot;C:\Program Files (x86)\NoÃ«l Danjou\AMCap\amcap.exe&quot;</span> <span class="literal">-PassThru</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­‰å¾…3ç§’</span></span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ€æ­»è¿›ç¨‹</span></span><br><span class="line">    <span class="built_in">Stop-Process</span> <span class="literal">-Id</span> <span class="variable">$process</span>.Id <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç­‰å¾…1ç§’</span></span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Cvitek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cvitek </tag>
            
            <tag> Alios </tag>
            
            <tag> USB </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UVC æ‰©å±•å•å…ƒ</title>
      <link href="/2024/05/15/USB-UVC_extension/"/>
      <url>/2024/05/15/USB-UVC_extension/</url>
      
        <content type="html"><![CDATA[<h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><ul><li><p><input checked="" disabled="" type="checkbox"> UVC æ‰©å±•å•å…ƒçš„ä½œç”¨æ˜¯å•¥ï¼Ÿ</p><blockquote><p>ã€ŠUVC 1.5 Class specificationã€‹ çš„ <code>2.7, 3.7.2</code> ä¸­ä»‹ç»äº† UVC çš„æ§åˆ¶æ¥å£åŒ…å«ï¼šè¾“å…¥ç»ˆç«¯ã€è¾“å‡ºç»ˆç«¯ã€ç›¸æœºç»ˆç«¯ã€é€‰æ‹©å™¨å•å…ƒã€å¤„ç†å•å…ƒã€ç¼–ç å•å…ƒã€æ‰©å±•å•å…ƒã€‚å‰å‡ ä¸ªéƒ½æ˜¯ç±»æ ‡å‡†ä¸­æœ‰æŒ‡å®šåº”è¯¥å®ç°ä»€ä¹ˆåŠŸèƒ½çš„ï¼Œæ‰©å±•å•å…ƒå°±æ˜¯ä¸“é—¨ç»™å‚å•†å®ç°è‡ªå®šä¹‰çš„ä¸€äº›åŠŸèƒ½ã€‚</p><p>æ¯”å¦‚æˆ‘ä»¬è¿™é‡Œå®¢æˆ·éœ€è¦èƒ½ç»™è®¾å¤‡å‘é€é‡å¯æŒ‡ä»¤ã€‚</p></blockquote></li><li><p><input checked="" disabled="" type="checkbox"> å’Œ UVC çš„å…³ç³»æ˜¯å•¥ï¼Ÿ</p><blockquote><p>UVC æ‰©å±•å•å…ƒæ˜¯ UVC çš„ä¸€ä¸ªå¯é€‰çš„å°åŠŸèƒ½ã€‚</p></blockquote></li><li><p><input checked="" disabled="" type="checkbox"> å¦‚ä½•å®ç°ä¸æµ‹è¯•ï¼Ÿ</p><blockquote><p>æµ‹è¯•å¯ä½¿ç”¨ï¼š</p><ul><li><code>Bus Hound</code>ï¼Œå¯ç»™è®¾å¤‡å‘é€ä»»æ„å‘½ä»¤ã€‚åˆ†å…è´¹ç‰ˆå’Œä»˜è´¹ç‰ˆï¼Œæˆ‘ä»¬è¿™é‡Œåªç”¨æ¥å‘æŒ‡ä»¤ï¼Œå…è´¹ç‰ˆå°±å¤Ÿç”¨äº†ã€‚å®˜æ–¹ç½‘å€ï¼š<a href="https://www.perisoft.net/bushound/index.htm">https://www.perisoft.net/bushound/index.htm</a></li><li><a href="https://www.usbzh.com/article/detail-761.html">UVCXUæ‘„åƒå¤´æ‰©å±•å•å…ƒè°ƒè¯•å·¥å…·UVCXU-USBä¸­æ–‡ç½‘å®˜æ–¹ç‰ˆ</a>ï¼Œéœ€è¦åŠ QQç¾¤ä¸‹è½½ã€‚</li><li><code>wireshark</code> æŠ“åŒ…åˆ†æã€‚</li></ul><blockquote><p><code>BusHound</code> æ˜¯ç›´æ¥è½¬åˆ°é©±åŠ¨å»å‘çš„ï¼Œæ²¡æœ‰é€šè¿‡ <code>windows</code> è§†é¢‘ç±»é©±åŠ¨ï¼Œè€ŒUVCXUè°ƒè¯•å·¥å…·æ—¶è°ƒç”¨äº†  <code>windows</code> è§†é¢‘ç±»é©±åŠ¨ï¼Œå°±ä¼šå—åˆ° windows çš„ä¸€äº›é™åˆ¶ã€‚è§ï¼š<a href="https://www.usbzh.com/article/detail-538.html">https://www.usbzh.com/article/detail-538.html</a></p></blockquote></blockquote></li></ul><h2 id="UVC-æ‰©å±•å•å…ƒæè¿°ç¬¦"><a href="#UVC-æ‰©å±•å•å…ƒæè¿°ç¬¦" class="headerlink" title="UVC æ‰©å±•å•å…ƒæè¿°ç¬¦"></a>UVC æ‰©å±•å•å…ƒæè¿°ç¬¦</h2><p>æ‰©å±•å•å…ƒæè¿°ç¬¦å…è®¸ç¡¬ä»¶è®¾è®¡è€…å®šä¹‰ä»»æ„ä¸€ç»„æ§åˆ¶æ¥å£ï¼Œä½¿ç±»é©±åŠ¨ç¨‹åºå¯ä»¥åœ¨è®¾å¤‡ä¸ä¾›åº”å•†æä¾›çš„ä¸»æœºè½¯ä»¶ä¹‹é—´è¿›è¡Œé€šè®¯æ§åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">UINT8 bLength;</span><br><span class="line">UINT8 bDescriptorType;</span><br><span class="line">UINT8 bDescriptorSubtype;</span><br><span class="line">UINT8 bUnitID;</span><br><span class="line">UINT8 guidExtensionCode[<span class="number">16</span>];</span><br><span class="line">UINT8 bNumControls;</span><br><span class="line">UINT8 bNrInPins;</span><br><span class="line">UINT8 baSourceID[bNrInPins];</span><br><span class="line">UINT8 bControlSize;</span><br><span class="line">UINT8 bmControls[bControlSize];</span><br><span class="line">UINT8 iExtension;</span><br></pre></td></tr></table></figure><hr><ul><li><code>bLength</code>ï¼šæè¿°ç¬¦çš„é•¿åº¦ï¼Œ<code>24+p(bNrInPins)+n(bControlSize)</code>ï¼Œå°±æ˜¯æ ‡è®°æè¿°ç¬¦è¿™ä¸ªç»“æ„ä½“çš„å¤§å°ã€‚</li></ul><hr><ul><li><p><code>bDescriptorType</code>ï¼šæè¿°ç¬¦ç±»å‹ï¼Œ<code>CS_INTERFACE</code>ï¼Œå€¼ä¸º <code>0x24</code>ã€‚</p></li><li><p><code>bDescriptorSubtype</code>ï¼šæè¿°ç¬¦å­ç±»å‹ã€‚ <code>VC_EXTENSION_UNIT</code>ï¼Œå€¼ä¸º <code>0x06</code>ã€‚</p><blockquote><p>è¿™ä¸¤ä¸ªå€¼éƒ½æ˜¯æŒ‰ç…§æ ‡å‡†æ¥çš„ï¼ŒæŒ‡å®šæè¿°ç¬¦çš„ç±»å‹ï¼Œå¿…é¡»æŒ‰ç…§æ ‡å‡†å¡«å›ºå®šå€¼ã€‚</p></blockquote></li></ul><hr><ul><li><p><code>bUnitID</code>ï¼šå”¯ä¸€æ ‡è¯†æè¿°ç¬¦ã€‚åŒä¸€è§†é¢‘åŠŸèƒ½å†…çš„ä»»ä½•å…¶ä»–å•å…ƒæˆ–ç»ˆç«¯ä¸å¾—å…·æœ‰ç›¸åŒçš„åŠŸèƒ½ <code>ID</code>ã€‚éé›¶å€¼ã€‚</p><blockquote><p>ä¸Šé¢æåˆ°çš„è¾“å…¥ç»ˆç«¯ã€è¾“å‡ºç»ˆç«¯ã€ç›¸æœºç»ˆç«¯ã€é€‰æ‹©å™¨å•å…ƒã€å¤„ç†å•å…ƒã€ç¼–ç å•å…ƒã€æ‰©å±•å•å…ƒï¼Œæ¯ä¸ªç»ˆç«¯ <code>terminal</code> æˆ–è€…å•å…ƒ <code>unit</code> éƒ½ä¼šæœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œ<code>bTerminalID</code> æˆ–è€… <code>bUnitID</code>ï¼Œæ”¶åˆ°æ•°æ®æ—¶ä¼šä¾æ®è¿™ä¸ªå€¼ï¼Œäº¤ç»™å¯¹åº”çš„æ¨¡å—å¤„ç†ã€‚</p></blockquote></li></ul><hr><ul><li><p><code>guidExtensionCode</code>ï¼šä¾›åº”å•†æ‰©å±•å•å…ƒç¼–ç </p><blockquote><p>è¿™ä¸ªå€¼ä¼¼ä¹æ²¡å•¥ç”¨å¤„ï¼Œåº”è¯¥åªæ˜¯å¡«è¡¨ç¤ºä¾›åº”å•†çš„ä¿¡æ¯ã€‚</p></blockquote></li></ul><hr><ul><li><p><code>bNumControls</code>ï¼šè¯¥æ‰©å±•å•å…ƒçš„æ§åˆ¶æ•°é‡ã€‚è¿™ä¸ªæ§åˆ¶æ˜¯æŒ‡æ§åˆ¶è¯·æ±‚ï¼Œå¯¹åº”æ‰©å±•å•å…ƒçš„<a href="https://www.usbzh.com/article/detail-172.html">ç‰¹å®šç±»è¯·æ±‚</a>çš„é€‰æ‹©å­çš„æ•°é‡ã€‚</p></li><li><p><code>bControlSize</code>ï¼š<code>bmControls</code> çš„å¤§å°ã€‚</p></li><li><p><code>bmControls[bControlSize]</code>ï¼šæ‰©å•†æŒ‡å®šè‡ªå®šä¹‰æ”¯æŒçš„ <code>bControlSize * 8</code> ä¸ªæ§åˆ¶ã€‚</p><blockquote><p>é¦–å…ˆï¼Œ<code>bmControls</code> æ˜¯ä¸ªä½å›¾ï¼Œæ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªåŠŸèƒ½ã€‚å¯ä»¥çœ‹<a href="https://elixir.bootlin.com/linux/v5.10/source/include/uapi/linux/usb/video.h#L88">çœ‹ <code>linux</code> å†…æ ¸ä¸­çš„å®šä¹‰</a>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* A.9.4. Camera Terminal Control Selectors */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_CONTROL_UNDEFINED0x00</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_SCANNING_MODE_CONTROL0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_AE_MODE_CONTROL0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_AE_PRIORITY_CONTROL0x03</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_EXPOSURE_TIME_ABSOLUTE_CONTROL0x04</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_EXPOSURE_TIME_RELATIVE_CONTROL0x05</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_FOCUS_ABSOLUTE_CONTROL0x06</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UVC_CT_FOCUS_RELATIVE_CONTROL0x07</span></span><br></pre></td></tr></table></figure><p>è¿™äº›å®çš„å€¼å°±æ˜¯é€‰æ‹©å­ã€‚é€‰æ‹©å­ä¸ <code>bmControls</code> è¿™ä¸ªæ•°ç»„çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ã€‚</p><table><thead><tr><th>BIT</th><th>é€‰æ‹©å­</th></tr></thead><tbody><tr><td>BIT0</td><td>1</td></tr><tr><td>BIT1</td><td>2</td></tr><tr><td>BIT2</td><td>3</td></tr><tr><td>â€¦</td><td>â€¦</td></tr><tr><td>BIT31</td><td>32</td></tr></tbody></table><p><code>bmControls[bControlSize]</code> çš„å€¼ä¸­ï¼Œå¯¹åº” <code>bit</code> ä¸º1ï¼Œå°±è¡¨ç¤ºæ”¯æŒè¯¥åŠŸèƒ½ã€‚æ¯”å¦‚æˆ‘åªæ”¯æŒ<code>UVC_CT_SCANNING_MODE_CONTROL</code> è¿™ä¸€ä¸ªåŠŸèƒ½ï¼Œé‚£ä¹ˆ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bNumControls = <span class="number">1</span>;</span><br><span class="line">bControlSize = <span class="number">1</span>;</span><br><span class="line">bmControls[<span class="number">0</span>] = cpu_to_le16(<span class="number">0x1</span>);</span><br></pre></td></tr></table></figure><p><code>bNumControls</code> å°±æ˜¯ <code>bmControls</code> ä¸­1çš„ä¸ªæ•°ã€‚ä¸è¿‡ <code>host/PC</code> ç«¯é©±åŠ¨ä¸ä¸€å®šä¼šç”¨è¿™ä¸ªå€¼ï¼Œwindows å¥½åƒå°±ç›´æ¥è‡ªå·±åˆ¤æ–­çš„ <code>bmControls</code> ä¸­1çš„ä¸ªæ•°ã€‚</p><p>åœ¨ä¸Šé¢çš„ Camera Terminal Control Selectors çš„å®šä¹‰ä¸­ï¼Œæ¯ä¸€ä½å¯¹åº”çš„åŠŸèƒ½éƒ½æ˜¯ UVC æ ‡å‡†ä¸­åˆ¶å®šçš„ã€‚è€Œæ‰©å±•æè¿°ç¬¦å°±æ˜¯ç•™ç»™å‚å•†è‡ªç”±å‘æŒ¥çš„ã€‚</p><p><strong>é€‰æ‹©å­</strong>ï¼š<strong>å°±æ˜¯å¯¹åº”åŠŸèƒ½çš„ ID</strong>ã€‚ç»™è®¾å¤‡å‘æ¶ˆæ¯æ—¶éœ€è¦æŒ‡å®šé€‰æ‹©å­ã€‚</p></blockquote></li></ul><hr><ul><li><p><code>bNrInPins</code>ï¼šè¾“å…¥ç®¡è„šæ•° p</p></li><li><p><code>baSourceID</code>ï¼šå„ä¸ªè¾“å…¥ç®¡è„šè¿æ¥çš„å®ä½“æˆ–ç«¯ç‚¹ID(ä»ç¬¬ä¸€ä¸ªåˆ°æœ€åä¸€ä¸ª)</p><blockquote><p>ä¸çŸ¥é“è¿™ä¸¤ä¸ªæœ‰å•¥ç”¨ã€‚</p></blockquote></li></ul><hr><ul><li><p><code>iExtension</code>ï¼šæ‰©å±•å•å…ƒçš„<a href="https://www.usbzh.com/article/detail-53.html">å­—ç¬¦ä¸²æè¿°ç¬¦</a>ç´¢å¼•ã€‚ç”¨æ¥æä¾›ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œç”¨ä¸ç€å†™0å°±è¡Œã€‚</p><blockquote><p>ä¸ºäº†æä¾›æ¯”è¾ƒå‹å¥½çš„è®¾å¤‡æ ‡è¯†ï¼ŒUSBè§„èŒƒä¸­å®šä¹‰äº†å­—ç¬¦ä¸²æè¿°ç¬¦ï¼Œå³ä½¿ç”¨äººç±»çš„è‡ªç„¶è¯­è¨€æ¥æè¿°è®¾å¤‡çš„åŠŸèƒ½ï¼Œç”Ÿäº§å‚å®¶ï¼Œç”Ÿäº§åºåˆ—å·ç­‰ã€‚è¿™é‡Œçš„è‡ªç„¶è¯­è¨€å¯ä»¥ä¸ºè‹±æ–‡ï¼Œä¹Ÿå¯ä»¥ä¸ºä¸­æ–‡ï¼Œä¹Ÿå¯ä»¥ä¸ºå…¶å®ƒçš„è‡ªç„¶è¯­è¨€ã€‚</p><p>ä¸ºäº†è§£å†³å­—ç¬¦ä¸²çš„è·¨å›½æ€§ï¼ŒUSBå­—ç¬¦ä¸²ä½¿ç”¨UNICODEç¼–ç ã€‚</p></blockquote></li></ul><p>æè¿°ç¬¦é…ç½®å¯¹äº†ï¼ŒåŸºæœ¬å°±æˆåŠŸäº†ä¸€å¤§åŠã€‚</p><h2 id="Unit-and-Terminal-Control-Requests"><a href="#Unit-and-Terminal-Control-Requests" class="headerlink" title="Unit and Terminal Control Requests"></a>Unit and Terminal Control Requests</h2><p>å¤§æ¦‚çŒœæµ‹äº†ä¸‹ï¼Œè¿™äº›è¯·æ±‚æ˜¯æŠŠæ¯ä¸ª <code>control_selector</code> å½“æˆä¸€ä¸ªæ•°å€¼å±æ€§æ¥çœ‹ï¼Œæ¯”å¦‚ä»¥ç¯å…‰äº®åº¦æ¥ç†è§£ã€‚</p><ul><li><p><code>GET_LEN</code>: è¡¨ç¤º <code>SET_CUR</code> æ—¶ä¼ è¾“çš„æ•°æ®é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰ã€‚æ¯”å¦‚äº®åº¦çš„èŒƒå›´åœ¨ 0~255 ä»¥ç±»çš„è¯ï¼Œä¸€ä¸ªå­—èŠ‚å°±å¯ä»¥è¡¨ç¤ºã€‚è€ŒèŒƒå›´å¦‚æœè¶…è¿‡ 255ï¼Œé‚£ä¸€ä¸ªå­—èŠ‚æ˜¾ç„¶ä¸å¤Ÿç”¨ã€‚<strong>æ³¨æ„ï¼šæ ‡å‡†ä¸­è¦æ±‚ <code>GET_LEN</code> çš„è¿”å›å€¼ä¸º2å­—èŠ‚çš„</strong>ã€‚</p></li><li><p><code>GET_INFO</code>: ç”¨äºè·å–è®¾å¤‡æ”¯æŒçš„ç‰¹å®šè¯·æ±‚ã€‚ä¸€èˆ¬å°±ä½¿èƒ½ <code>D0, D1</code> å°±è¡Œï¼Œè¿”å›çš„å€¼å„ <code>bit</code> ä»£è¡¨çš„å«ä¹‰è§ä¸‹è¡¨ï¼š</p><table><thead><tr><th>ä½</th><th>æè¿°</th><th>ä½çŠ¶æ€</th></tr></thead><tbody><tr><td>D0</td><td>1&#x3D;Supports GET value requests</td><td>Capability</td></tr><tr><td>D1</td><td>1&#x3D;Supports SET value requests</td><td>Capability</td></tr><tr><td>D2</td><td>1&#x3D;Disabled due to automatic mode(under device control)</td><td>State</td></tr><tr><td>D3</td><td>1&#x3D;Autoupdate Control</td><td>Capability</td></tr><tr><td>D4</td><td>1&#x3D;Asynchronous Control</td><td>Capability</td></tr><tr><td>D5</td><td>1&#x3D;Disabled due to incompatibility with Commit state.</td><td>State</td></tr><tr><td>D7..D6</td><td>ä¿ç•™ï¼Œç½®ä¸º0</td><td>â€”</td></tr></tbody></table><p>å¦‚æœ<a href="https://www.usbzh.com/article/detail-82.html">ç¼–ç å•å…ƒ</a>æ§åˆ¶çš„å®ç°ä½¿å¾—è®¾å¤‡å¯ä»¥å¯åŠ¨è¯¥æ§ä»¶çš„æœ€å°å’Œ&#x2F;æˆ–æœ€å¤§è®¾ç½®å±æ€§çš„æ›´æ”¹ï¼Œé‚£ä¹ˆè¯¥è®¾å¤‡åº”è¯¥èƒ½å¤Ÿå‘é€æ§åˆ¶æ›´æ”¹ä¸­æ–­æ¥é€šçŸ¥ä¸»æœºæ–°çš„ <code>GET_MIN</code> å’Œ&#x2F;æˆ– <code>GET_MAX</code> è®¾ç½®ï¼Œå› æ­¤å¿…é¡»è®¾ç½® <code>D3</code>ï¼ˆè‡ªåŠ¨æ›´æ–°æ§åˆ¶ï¼‰ã€‚</p></li></ul><hr><ul><li><p><code>GET_MIN</code>: æ”¯æŒçš„äº®åº¦æœ€å°å€¼ã€‚æ¯”å¦‚ 0</p></li><li><p><code>GET_MAX</code>: æ”¯æŒçš„äº®åº¦æœ€å¤§å€¼ã€‚æ¯”å¦‚ 100</p></li><li><p><code>GET_RES(resolution)</code>: è·å–è°ƒæ•´çš„ç²¾åº¦ã€‚æ¯”å¦‚ 10ï¼Œè¿™æ ·çš„è¯ï¼Œè°ƒç”¨ <code>SET_CUR</code> æ—¶ï¼Œå°±åªèƒ½è®¾ç½® 10 çš„æ•´æ•°å€ã€‚</p><p>  è¿™ä¸‰ä¸ªå€¼å­˜åœ¨å…³è”çš„ï¼Œæ ‡å‡†ä¸­ä¼¼ä¹æœ‰è¦æ±‚ <code>min/res</code>ï¼Œ<code>max/res</code>ï¼Œ<code>cur/res</code> éƒ½æ˜¯æ•´æ•°ï¼Œä¸èƒ½æ˜¯å°æ•°ã€‚<strong>å¦‚æœå±æ€§æ˜¯å­—ç¬¦ä¸²çš„è¯ï¼Œé‚£è¿™é‡Œ <code>RES</code> å°±å¾—è®¾ç½®ä¸º</strong><code>1</code>ã€‚</p></li></ul><hr><ul><li><code>GET_DEF(default)</code>: é»˜è®¤å€¼ï¼Œè®¾å¤‡æšä¸¾å®Œæˆä¹‹åï¼Œä¼šç«‹é©¬è°ƒç”¨è¯¥è¯·æ±‚è·å–é»˜è®¤å€¼ã€‚</li><li><code>SET_CUR</code>: è®¾ç½®äº®åº¦ä¸ºç‰¹å®šå€¼ã€‚</li><li><code>GET_CUR</code>: è·å–å½“å‰çš„äº®åº¦å€¼ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2>]]></content>
      
      
      <categories>
          
          <category> USB </category>
          
      </categories>
      
      
        <tags>
            
            <tag> USB </tag>
            
            <tag> UVC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CLANG FORMAT æ ¼å¼åŒ–ä»£ç </title>
      <link href="/2024/01/15/VSCODE-clang-format/"/>
      <url>/2024/01/15/VSCODE-clang-format/</url>
      
        <content type="html"><![CDATA[<h2 id="VSCODE-CLANG-FORMAT-æ ¼å¼åŒ–"><a href="#VSCODE-CLANG-FORMAT-æ ¼å¼åŒ–" class="headerlink" title="VSCODE CLANG FORMAT æ ¼å¼åŒ–"></a>VSCODE CLANG FORMAT æ ¼å¼åŒ–</h2><ol><li>è·å– linux çš„ clang-format.txt <a href="https://github.com/torvalds/linux/blob/master/.clang-format">https://github.com/torvalds/linux/blob/master/.clang-format</a></li><li>æ”¾åˆ°é¡¹ç›®çš„æ ¹ç›®å½•ï¼Œå¹¶å‘½åä¸º <code>.clang-format</code></li><li>vscode å‡†å¤‡ c&#x2F;c++ æ’ä»¶ï¼Œ</li><li>åœ¨VSCodeä¸­å®‰è£…çš„å¤šä¸ªæ’ä»¶å‡æ”¯æŒä½¿ç”¨clang-formatæ¥å¯¹ä»£ç æ‰§è¡Œæ ¼å¼åŒ–ï¼Œæ­¤æ—¶æŒ‰ç…§ä¸Šè¿°æ–‡ç« ä¸­çš„æ–¹æ³•å®Œæˆé…ç½®åï¼Œä»£ç æ ¼å¼åŒ–å¹¶æ²¡æœ‰ç”Ÿæ•ˆã€‚åæ¥æ— æ„ä¸­å‘ç°ï¼Œéœ€è¦åœ¨VSCodeçš„é…ç½®æ–‡ä»¶ä¸­å¢åŠ å¦‚ä¸‹é…ç½®ï¼Œä»å¤šä¸ªæ’ä»¶ä¸­é€‰æ‹©é»˜è®¤å¯ç”¨çš„æ ¼å¼åŒ–å·¥å…·ã€‚ <figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;[cpp]&quot;: &#123;</span><br><span class="line">&quot;editor.defaultFormatter&quot;: &quot;ms-vscode.cpptools&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><ul><li>Documentation&#x2F;process&#x2F;clang-format.rst</li><li><a href="https://clang.llvm.org/docs/ClangFormat.html">https://clang.llvm.org/docs/ClangFormat.html</a></li><li><a href="https://clang.llvm.org/docs/ClangFormatStyleOptions.html">https://clang.llvm.org/docs/ClangFormatStyleOptions.html</a></li></ul><h2 id="å¯èƒ½éœ€è¦ä¿®æ”¹çš„åœ°æ–¹"><a href="#å¯èƒ½éœ€è¦ä¿®æ”¹çš„åœ°æ–¹" class="headerlink" title="å¯èƒ½éœ€è¦ä¿®æ”¹çš„åœ°æ–¹"></a>å¯èƒ½éœ€è¦ä¿®æ”¹çš„åœ°æ–¹</h2><ol><li><p>å£°æ˜å¯¹é½ï¼›</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AlignConsecutiveDeclarations: false</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ats_attr</span> &#123;</span></span><br><span class="line"><span class="type">uint64_t</span> bucket_size;</span><br><span class="line"><span class="type">uint64_t</span> rate;</span><br><span class="line"><span class="type">uint64_t</span> bucket_empty;</span><br><span class="line"><span class="type">uint64_t</span> empty_to_full;</span><br><span class="line"><span class="type">uint64_t</span> eligility;</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="type">char</span> *b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// AlignConsecutiveDeclarations: true</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ats_attr</span> &#123;</span></span><br><span class="line"><span class="type">uint64_t</span> bucket_size;</span><br><span class="line"><span class="type">uint64_t</span> rate;</span><br><span class="line"><span class="type">uint64_t</span> bucket_empty;</span><br><span class="line"><span class="type">uint64_t</span> empty_to_full;</span><br><span class="line"><span class="type">uint64_t</span> eligility;</span><br><span class="line"><span class="type">int</span> a;</span><br><span class="line"><span class="type">char</span>*b;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// ä¸è¿‡è¿™æ ·ä¹Ÿä¼šå¯¼è‡´å¦‚ä¸‹çš„éš¾çœ‹çš„æƒ…å†µï¼š</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ats_attr</span> <span class="title">attr</span>;</span></span><br><span class="line"><span class="type">int</span>offset = offsetof(<span class="keyword">struct</span> ats_attr, bucket_size);</span><br></pre></td></tr></table></figure></li><li><p>æ³¨é‡Šå¯¹é½ï¼›</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AlignTrailingComments: true</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_NONE 0  <span class="comment">// æ— æ—¥å¿—è¾“å‡º</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_ERROR 1 <span class="comment">// é”™è¯¯æ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_WARN 2  <span class="comment">// è­¦å‘Šæ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_INFO 3  <span class="comment">// ä¿¡æ¯æ—¥å¿—</span></span></span><br><span class="line"><span class="comment">// AlignTrailingComments: false</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_NONE 0 <span class="comment">// æ— æ—¥å¿—è¾“å‡º</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_ERROR 1 <span class="comment">// é”™è¯¯æ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_WARN 2 <span class="comment">// è­¦å‘Šæ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_INFO 3 <span class="comment">// ä¿¡æ¯æ—¥å¿—</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å®å®šä¹‰å¯¹é½</span></span><br><span class="line">AlignConsecutiveMacros: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li><p>ä»£ç ä¹‹é—´çš„æœ€å¤§ç©ºè¡Œï¼›</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MaxEmptyLinesToKeep: 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW <span class="string">&quot;\e[1;33m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE <span class="string">&quot;\e[0;34m&quot;</span></span></span><br><span class="line"><span class="comment">// MaxEmptyLinesToKeep: 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW <span class="string">&quot;\e[1;33m&quot;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE <span class="string">&quot;\e[0;34m&quot;</span></span></span><br></pre></td></tr></table></figure></li><li><p>as named;</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AllowShortLoopsOnASingleLine: true</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) xxx;</span><br><span class="line"><span class="comment">// AllowShortLoopsOnASingleLine: false</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">xxx;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AllowShortIfStatementsOnASingleLine: true</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span>) xxx;</span><br><span class="line"><span class="comment">// AllowShortIfStatementsOnASingleLine: false</span></span><br><span class="line"><span class="keyword">if</span> (<span class="number">1</span>)</span><br><span class="line">xxx;</span><br></pre></td></tr></table></figure></li></ol><h2 id="å…¶ä»–é…ç½®å«ä¹‰"><a href="#å…¶ä»–é…ç½®å«ä¹‰" class="headerlink" title="å…¶ä»–é…ç½®å«ä¹‰"></a>å…¶ä»–é…ç½®å«ä¹‰</h2><blockquote><p><a href="https://www.cnblogs.com/oloroso/p/14699855.html">https://www.cnblogs.com/oloroso/p/14699855.html</a></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://clang.llvm.org/docs/ClangFormatStyleOptions.html</span></span><br><span class="line"><span class="comment"># https://www.bbsmax.com/A/VGzlMjexJb/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯­è¨€: None, Cpp, Java, JavaScript, ObjC, Proto, TableGen, TextProto</span></span><br><span class="line">Language: Cpp</span><br><span class="line"></span><br><span class="line">BasedOnStyle: LLVM</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¿é—®è¯´æ˜ç¬¦(publicã€privateç­‰)çš„åç§»</span></span><br><span class="line">AccessModifierOffset: -4</span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¦æ‹¬å·(å·¦åœ†æ‹¬å·ã€å·¦å°–æ‹¬å·ã€å·¦æ–¹æ‹¬å·)åçš„å¯¹é½: Align, DontAlign, AlwaysBreak(æ€»æ˜¯åœ¨å·¦æ‹¬å·åæ¢è¡Œ)</span></span><br><span class="line">AlignAfterOpenBracket: Align</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿ç»­èµ‹å€¼æ—¶ï¼Œå¯¹é½æ‰€æœ‰ç­‰å·</span></span><br><span class="line">AlignConsecutiveAssignments: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿ç»­å£°æ˜æ—¶ï¼Œå¯¹é½æ‰€æœ‰å£°æ˜çš„å˜é‡å</span></span><br><span class="line">AlignConsecutiveDeclarations: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹é½è¿ç»­ä½åŸŸå­—æ®µçš„é£æ ¼</span></span><br><span class="line"><span class="comment"># AlignConsecutiveBitFields: AcrossEmptyLinesAndComments</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹é½è¿ç»­å®å®šä¹‰çš„é£æ ¼</span></span><br><span class="line"><span class="comment"># AlignConsecutiveMacros: Consecutive #clang-format 12</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”¨äºåœ¨ä½¿ç”¨åæ–œæ æ¢è¡Œä¸­å¯¹é½åæ–œæ çš„é€‰é¡¹</span></span><br><span class="line">AlignEscapedNewlines: Left</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°´å¹³å¯¹é½äºŒå…ƒå’Œä¸‰å…ƒè¡¨è¾¾å¼çš„æ“ä½œæ•°</span></span><br><span class="line">AlignOperands: Align</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹é½è¿ç»­çš„å°¾éšçš„æ³¨é‡Š</span></span><br><span class="line">AlignTrailingComments: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœå‡½æ•°è°ƒç”¨æˆ–å¸¦æ‹¬å·çš„åˆå§‹åŒ–åˆ—è¡¨ä¸é€‚åˆå…¨éƒ¨åœ¨ä¸€è¡Œæ—¶</span></span><br><span class="line"><span class="comment"># å…è®¸å°†æ‰€æœ‰å‚æ•°æ”¾åˆ°ä¸‹ä¸€è¡Œï¼Œå³ä½¿BinPackArgumentsä¸ºfalse</span></span><br><span class="line">AllowAllArgumentsOnNextLine: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸æ„é€ å‡½æ•°çš„åˆå§‹åŒ–å‚æ•°æ”¾åœ¨ä¸‹ä¸€è¡Œ</span></span><br><span class="line">AllowAllConstructorInitializersOnNextLine: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸å‡½æ•°å£°æ˜çš„æ‰€æœ‰å‚æ•°åœ¨æ”¾åœ¨ä¸‹ä¸€è¡Œ</span></span><br><span class="line">AllowAllParametersOfDeclarationOnNextLine: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸çŸ­çš„å—æ”¾åœ¨åŒä¸€è¡Œ(Always æ€»æ˜¯å°†çŸ­å—åˆå¹¶æˆä¸€è¡Œï¼ŒEmpty åªåˆå¹¶ç©ºå—)</span></span><br><span class="line">AllowShortBlocksOnASingleLine: Empty</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸çŸ­çš„caseæ ‡ç­¾æ”¾åœ¨åŒä¸€è¡Œ</span></span><br><span class="line">AllowShortCaseLabelsOnASingleLine: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸çŸ­çš„å‡½æ•°æ”¾åœ¨åŒä¸€è¡Œ: None, InlineOnly(å®šä¹‰åœ¨ç±»ä¸­), Empty(ç©ºå‡½æ•°), Inline(å®šä¹‰åœ¨ç±»ä¸­ï¼Œç©ºå‡½æ•°), All</span></span><br><span class="line">AllowShortFunctionsOnASingleLine: Inline</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸çŸ­çš„ifè¯­å¥ä¿æŒåœ¨åŒä¸€è¡Œ</span></span><br><span class="line">AllowShortIfStatementsOnASingleLine: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸çŸ­çš„å¾ªç¯ä¿æŒåœ¨åŒä¸€è¡Œ</span></span><br><span class="line">AllowShortLoopsOnASingleLine: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»æ˜¯åœ¨å®šä¹‰è¿”å›ç±»å‹åæ¢è¡Œ(deprecated)</span></span><br><span class="line">AlwaysBreakAfterDefinitionReturnType: None</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»æ˜¯åœ¨è¿”å›ç±»å‹åæ¢è¡Œ: None, All, TopLevel(é¡¶çº§å‡½æ•°ï¼Œä¸åŒ…æ‹¬åœ¨ç±»ä¸­çš„å‡½æ•°),</span></span><br><span class="line"><span class="comment">#   AllDefinitions(æ‰€æœ‰çš„å®šä¹‰ï¼Œä¸åŒ…æ‹¬å£°æ˜), TopLevelDefinitions(æ‰€æœ‰çš„é¡¶çº§å‡½æ•°çš„å®šä¹‰)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡½æ•°å£°æ˜è¿”å›ç±»å‹åæ˜¯å¦æ¢è¡Œ(None è‡ªåŠ¨ï¼ŒAllå…¨éƒ¨ï¼ŒTopLevel...)</span></span><br><span class="line">AlwaysBreakAfterReturnType: None</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»æ˜¯åœ¨å¤šè¡Œstringå­—é¢é‡å‰æ¢è¡Œ</span></span><br><span class="line">AlwaysBreakBeforeMultilineStrings: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ€»æ˜¯åœ¨templateå£°æ˜åæ¢è¡Œ</span></span><br><span class="line">AlwaysBreakTemplateDeclarations: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># falseè¡¨ç¤ºå‡½æ•°å®å‚è¦ä¹ˆéƒ½åœ¨åŒä¸€è¡Œï¼Œè¦ä¹ˆéƒ½å„è‡ªä¸€è¡Œ</span></span><br><span class="line">BinPackArguments: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># falseè¡¨ç¤ºæ‰€æœ‰å½¢å‚è¦ä¹ˆéƒ½åœ¨åŒä¸€è¡Œï¼Œè¦ä¹ˆéƒ½å„è‡ªä¸€è¡Œ</span></span><br><span class="line">BinPackParameters: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤§æ‹¬å·æ¢è¡Œï¼Œåªæœ‰å½“ BreakBeforeBraces è®¾ç½®ä¸ºCustomæ—¶æ‰æœ‰æ•ˆ</span></span><br><span class="line">BraceWrapping:</span><br><span class="line"><span class="comment"># case è¯­å¥åé¢</span></span><br><span class="line">AfterCaseLabel: <span class="literal">true</span></span><br><span class="line"><span class="comment"># classå®šä¹‰åé¢</span></span><br><span class="line">AfterClass: <span class="literal">true</span></span><br><span class="line"><span class="comment"># æ§åˆ¶è¯­å¥åé¢</span></span><br><span class="line">AfterControlStatement: Never</span><br><span class="line"><span class="comment"># enumå®šä¹‰åé¢</span></span><br><span class="line">AfterEnum: <span class="literal">true</span></span><br><span class="line"><span class="comment"># å‡½æ•°å®šä¹‰åé¢</span></span><br><span class="line">AfterFunction: <span class="literal">true</span></span><br><span class="line"><span class="comment"># å‘½åç©ºé—´å®šä¹‰åé¢</span></span><br><span class="line">AfterNamespace: <span class="literal">false</span></span><br><span class="line"><span class="comment"># ObjCå®šä¹‰åé¢</span></span><br><span class="line">AfterObjCDeclaration: <span class="literal">false</span></span><br><span class="line"><span class="comment"># structå®šä¹‰åé¢</span></span><br><span class="line">AfterStruct: <span class="literal">true</span></span><br><span class="line"><span class="comment"># unionå®šä¹‰åé¢</span></span><br><span class="line">AfterUnion: <span class="literal">true</span></span><br><span class="line"><span class="comment"># extern å¯¼å‡ºå—åé¢</span></span><br><span class="line">AfterExternBlock: <span class="literal">false</span></span><br><span class="line"><span class="comment"># catchä¹‹å‰</span></span><br><span class="line">BeforeCatch: <span class="literal">true</span></span><br><span class="line"><span class="comment"># elseä¹‹å‰</span></span><br><span class="line">BeforeElse: <span class="literal">true</span></span><br><span class="line"><span class="comment"># ç¼©è¿›å¤§æ‹¬å·(æ•´ä¸ªå¤§æ‹¬å·æ¡†èµ·æ¥çš„éƒ¨åˆ†éƒ½ç¼©è¿›)</span></span><br><span class="line">IndentBraces: <span class="literal">false</span></span><br><span class="line"><span class="comment"># ç©ºå‡½æ•°çš„å¤§æ‹¬å·æ˜¯å¦å¯ä»¥åœ¨ä¸€è¡Œ</span></span><br><span class="line">SplitEmptyFunction: <span class="literal">false</span></span><br><span class="line"><span class="comment"># ç©ºè®°å½•ä½“(struct/class/union)çš„å¤§æ‹¬å·æ˜¯å¦å¯ä»¥åœ¨ä¸€è¡Œ</span></span><br><span class="line">SplitEmptyRecord: <span class="literal">false</span></span><br><span class="line"><span class="comment"># ç©ºåå­—ç©ºé—´çš„å¤§æ‹¬å·æ˜¯å¦å¯ä»¥åœ¨ä¸€è¡Œ</span></span><br><span class="line">SplitEmptyNamespace: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨äºŒå…ƒè¿ç®—ç¬¦å‰æ¢è¡Œ: None(åœ¨æ“ä½œç¬¦åæ¢è¡Œ), NonAssignment(åœ¨éèµ‹å€¼çš„æ“ä½œç¬¦å‰æ¢è¡Œ), All(åœ¨æ“ä½œç¬¦å‰æ¢è¡Œ)</span></span><br><span class="line">BreakBeforeBinaryOperators: None</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å¤§æ‹¬å·å‰æ¢è¡Œ: Attach(å§‹ç»ˆå°†å¤§æ‹¬å·é™„åŠ åˆ°å‘¨å›´çš„ä¸Šä¸‹æ–‡), Linux(é™¤å‡½æ•°ã€å‘½åç©ºé—´å’Œç±»å®šä¹‰ï¼Œä¸Attachç±»ä¼¼),</span></span><br><span class="line"><span class="comment">#   Mozilla(é™¤æšä¸¾ã€å‡½æ•°ã€è®°å½•å®šä¹‰ï¼Œä¸Attachç±»ä¼¼), Stroustrup(é™¤å‡½æ•°å®šä¹‰ã€catchã€elseï¼Œä¸Attachç±»ä¼¼),</span></span><br><span class="line"><span class="comment">#   Allman(æ€»æ˜¯åœ¨å¤§æ‹¬å·å‰æ¢è¡Œ), GNU(æ€»æ˜¯åœ¨å¤§æ‹¬å·å‰æ¢è¡Œï¼Œå¹¶å¯¹äºæ§åˆ¶è¯­å¥çš„å¤§æ‹¬å·å¢åŠ é¢å¤–çš„ç¼©è¿›), WebKit(åœ¨å‡½æ•°å‰æ¢è¡Œ), Custom</span></span><br><span class="line"><span class="comment">#   æ³¨ï¼šè¿™é‡Œè®¤ä¸ºè¯­å¥å—ä¹Ÿå±äºå‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤§æ‹¬å·çš„æ¢è¡Œè§„åˆ™</span></span><br><span class="line">BreakBeforeBraces: Custom</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‰å…ƒè¿ç®—æ“ä½œç¬¦æ¢è¡Œä½ç½®ï¼ˆ?å’Œ: åœ¨æ–°è¡Œè¿˜æ˜¯å°¾éƒ¨ï¼‰</span></span><br><span class="line">BreakBeforeTernaryOperators: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨çš„é€—å·å‰æ¢è¡Œ</span></span><br><span class="line">BreakConstructorInitializersBeforeComma: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦ä½¿ç”¨çš„æ„é€ å‡½æ•°åˆå§‹åŒ–å¼æ ·å¼</span></span><br><span class="line">BreakConstructorInitializers: BeforeComma</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¯è¡Œå­—ç¬¦çš„é™åˆ¶ï¼Œ0è¡¨ç¤ºæ²¡æœ‰é™åˆ¶</span></span><br><span class="line">ColumnLimit: 100</span><br><span class="line"></span><br><span class="line"><span class="comment"># æè¿°å…·æœ‰ç‰¹æ®Šæ„ä¹‰çš„æ³¨é‡Šçš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒä¸åº”è¯¥è¢«åˆ†å‰²ä¸ºå¤šè¡Œæˆ–ä»¥å…¶å®ƒæ–¹å¼æ”¹å˜</span></span><br><span class="line"><span class="comment"># CommentPragmas: &#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœä¸ºtrueï¼Œåˆ™è¿ç»­çš„åç§°ç©ºé—´å£°æ˜å°†åœ¨åŒä¸€è¡Œä¸Šã€‚å¦‚æœä¸ºfalseï¼Œåˆ™åœ¨æ–°è¡Œä¸Šå£°æ˜æ¯ä¸ªåç§°ç©ºé—´ã€‚</span></span><br><span class="line">CompactNamespaces: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨è¦ä¹ˆéƒ½åœ¨åŒä¸€è¡Œï¼Œè¦ä¹ˆéƒ½å„è‡ªä¸€è¡Œ</span></span><br><span class="line">ConstructorInitializerAllOnOneLineOrOnePerLine: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ„é€ å‡½æ•°çš„åˆå§‹åŒ–åˆ—è¡¨çš„ç¼©è¿›å®½åº¦</span></span><br><span class="line">ConstructorInitializerIndentWidth:  4</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»¶ç»­çš„è¡Œçš„ç¼©è¿›å®½åº¦</span></span><br><span class="line">ContinuationIndentWidth: 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># å»é™¤C++11çš„åˆ—è¡¨åˆå§‹åŒ–çš„å¤§æ‹¬å·&#123;åå’Œ&#125;å‰çš„ç©ºæ ¼</span></span><br><span class="line">Cpp11BracedListStyle: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§æ‰¿æœ€å¸¸ç”¨çš„æŒ‡é’ˆå’Œå¼•ç”¨çš„å¯¹é½æ–¹å¼</span></span><br><span class="line">DerivePointerAlignment: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­æ ¼å¼åŒ–</span></span><br><span class="line">DisableFormat: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è‡ªåŠ¨æ£€æµ‹å‡½æ•°çš„è°ƒç”¨å’Œå®šä¹‰æ˜¯å¦è¢«æ ¼å¼ä¸ºæ¯è¡Œä¸€ä¸ªå‚æ•°(Experimental)</span></span><br><span class="line">ExperimentalAutoDetectBinPacking: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœä¸ºtrueï¼Œåˆ™clangæ ¼å¼ä¼šä¸ºçŸ­åç§°ç©ºé—´æ·»åŠ ç¼ºå°‘çš„åç§°ç©ºé—´ç»“å°¾æ³¨é‡Šï¼Œå¹¶ä¿®å¤æ— æ•ˆçš„ç°æœ‰åç§°ç»“æŸæ³¨é‡Š</span></span><br><span class="line">FixNamespaceComments: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€è¦è¢«è§£è¯»ä¸ºforeachå¾ªç¯è€Œä¸æ˜¯å‡½æ•°è°ƒç”¨çš„å®</span></span><br><span class="line">ForEachMacros:  [ foreach, Q_FOREACH, BOOST_FOREACH ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹#includeè¿›è¡Œæ’åºï¼ŒåŒ¹é…äº†æŸæ­£åˆ™è¡¨è¾¾å¼çš„#includeæ‹¥æœ‰å¯¹åº”çš„ä¼˜å…ˆçº§ï¼ŒåŒ¹é…ä¸åˆ°çš„åˆ™é»˜è®¤ä¼˜å…ˆçº§ä¸ºINT_MAX(ä¼˜å…ˆçº§è¶Šå°æ’åºè¶Šé å‰)ï¼Œ</span></span><br><span class="line"><span class="comment">#   å¯ä»¥å®šä¹‰è´Ÿæ•°ä¼˜å…ˆçº§ä»è€Œä¿è¯æŸäº›#includeæ°¸è¿œåœ¨æœ€å‰é¢</span></span><br><span class="line">IncludeCategories:</span><br><span class="line">- Regex:  <span class="string">&#x27;^&quot;(llvm|llvm-c|clang|clang-c)/&#x27;</span></span><br><span class="line">Priority:   2</span><br><span class="line">- Regex:  <span class="string">&#x27;^(&lt;|&quot;(gtest|isl|json)/)&#x27;</span></span><br><span class="line">Priority:   3</span><br><span class="line">- Regex:  <span class="string">&#x27;.*&#x27;</span></span><br><span class="line">Priority:   1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼©è¿›caseæ ‡ç­¾</span></span><br><span class="line">IndentCaseLabels: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¦ä½¿ç”¨çš„é¢„å¤„ç†å™¨æŒ‡ä»¤ç¼©è¿›æ ·å¼</span></span><br><span class="line">IndentPPDirectives: AfterHash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼©è¿›å®½åº¦</span></span><br><span class="line">IndentWidth: 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‡½æ•°è¿”å›ç±»å‹æ¢è¡Œæ—¶ï¼Œç¼©è¿›å‡½æ•°å£°æ˜æˆ–å‡½æ•°å®šä¹‰çš„å‡½æ•°å</span></span><br><span class="line">IndentWrappedFunctionNames: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿ç•™åœ¨å—å¼€å§‹å¤„çš„ç©ºè¡Œ</span></span><br><span class="line">KeepEmptyLinesAtTheStartOfBlocks: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å§‹ä¸€ä¸ªå—çš„å®çš„æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">MacroBlockBegin: <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»“æŸä¸€ä¸ªå—çš„å®çš„æ­£åˆ™è¡¨è¾¾å¼</span></span><br><span class="line">MacroBlockEnd: <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿ç»­ç©ºè¡Œçš„æœ€å¤§æ•°é‡</span></span><br><span class="line">MaxEmptyLinesToKeep: 10</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‘½åç©ºé—´çš„ç¼©è¿›: None, Inner(ç¼©è¿›åµŒå¥—çš„å‘½åç©ºé—´ä¸­çš„å†…å®¹), All</span></span><br><span class="line"><span class="comment"># NamespaceIndentation: Inner</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ObjCå—æ—¶ç¼©è¿›å®½åº¦</span></span><br><span class="line">ObjCBlockIndentWidth: 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ObjCçš„@propertyåæ·»åŠ ä¸€ä¸ªç©ºæ ¼</span></span><br><span class="line">ObjCSpaceAfterProperty: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ObjCçš„protocolåˆ—è¡¨å‰æ·»åŠ ä¸€ä¸ªç©ºæ ¼</span></span><br><span class="line">ObjCSpaceBeforeProtocolList: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨call(åå¯¹å‡½æ•°è°ƒç”¨æ¢è¡Œçš„penalty</span></span><br><span class="line">PenaltyBreakBeforeFirstCallParameter: 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ä¸€ä¸ªæ³¨é‡Šä¸­å¼•å…¥æ¢è¡Œçš„penalty</span></span><br><span class="line">PenaltyBreakComment: 300</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬ä¸€æ¬¡åœ¨&lt;&lt;å‰æ¢è¡Œçš„penalty</span></span><br><span class="line">PenaltyBreakFirstLessLess:  120</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡ä¸­å¼•å…¥æ¢è¡Œçš„penalty</span></span><br><span class="line">PenaltyBreakString: 1000</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹äºæ¯ä¸ªåœ¨è¡Œå­—ç¬¦æ•°é™åˆ¶ä¹‹å¤–çš„å­—ç¬¦çš„penalty</span></span><br><span class="line">PenaltyExcessCharacter: 1000000</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æ¯ä¸€ä¸ªç©ºæ ¼ç¼©è¿›å­—ç¬¦çš„penalty(ç›¸å¯¹äºå‰å¯¼çš„éç©ºæ ¼åˆ—è®¡ç®—)</span></span><br><span class="line"><span class="comment"># PenaltyIndentedWhitespace: 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å‡½æ•°çš„è¿”å›ç±»å‹æ”¾åˆ°å®ƒè‡ªå·±çš„è¡Œçš„penalty</span></span><br><span class="line">PenaltyReturnTypeOnItsOwnLine: 120</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡é’ˆå’Œå¼•ç”¨çš„å¯¹é½: Left, Right, Middle</span></span><br><span class="line">PointerAlignment: Left</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸é‡æ–°æ’ç‰ˆæ³¨é‡Š</span></span><br><span class="line">ReflowComments: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸æ’åº#include</span></span><br><span class="line">SortIncludes: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…è®¸æ’åº using å£°æ˜é¡ºåº</span></span><br><span class="line">SortUsingDeclarations: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨Cé£æ ¼ç±»å‹è½¬æ¢åæ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpaceAfterCStyleCast: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨é€»è¾‘éæ“ä½œç¬¦(!)ä¹‹åæ’å…¥ä¸€ä¸ªç©ºæ ¼</span></span><br><span class="line">SpaceAfterLogicalNot: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ template å…³é”®å­—åæ’å…¥ä¸€ä¸ªç©ºæ ¼</span></span><br><span class="line">SpaceAfterTemplateKeyword: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®šä¹‰åœ¨ä»€ä¹ˆæƒ…å†µä¸‹åœ¨æŒ‡é’ˆé™å®šç¬¦ä¹‹å‰æˆ–ä¹‹åæ”¾ç½®ç©ºæ ¼</span></span><br><span class="line"><span class="comment"># SpaceAroundPointerQualifiers: Before</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨èµ‹å€¼è¿ç®—ç¬¦ä¹‹å‰æ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpaceBeforeAssignmentOperators: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å·¦åœ†æ‹¬å·ä¹‹å‰æ·»åŠ ä¸€ä¸ªç©ºæ ¼: Never, ControlStatements, Always</span></span><br><span class="line">SpaceBeforeParens: ControlStatements</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç©ºæ ¼å°†åœ¨åŸºäºèŒƒå›´çš„forå¾ªç¯å†’å·ä¹‹å‰è¢«åˆ é™¤</span></span><br><span class="line">SpaceBeforeRangeBasedForLoopColon: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># [ å‰æ˜¯å¦æ·»åŠ ç©ºæ ¼ï¼ˆæ•°ç»„åå’Œ[ä¹‹é—´ï¼ŒLambdasä¸ä¼šå—åˆ°å½±å“ï¼‰</span></span><br><span class="line"><span class="comment"># è¿ç»­å¤šä¸ª [ åªè€ƒè™‘ç¬¬ä¸€ä¸ªï¼ˆåµŒå¥—æ•°ç»„ï¼Œå¤šç»´æ•°ç»„ï¼‰</span></span><br><span class="line">SpaceBeforeSquareBrackets: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ç©ºçš„åœ†æ‹¬å·ä¸­æ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpaceInEmptyParentheses: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å°¾éšçš„è¯„è®ºå‰æ·»åŠ çš„ç©ºæ ¼æ•°(åªé€‚ç”¨äº//)</span></span><br><span class="line">SpacesBeforeTrailingComments: 3</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å°–æ‹¬å·çš„&lt;åå’Œ&gt;å‰æ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpacesInAngles: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å®¹å™¨(ObjCå’ŒJavaScriptçš„æ•°ç»„å’Œå­—å…¸ç­‰)å­—é¢é‡ä¸­æ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpacesInContainerLiterals:  <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨Cé£æ ¼ç±»å‹è½¬æ¢çš„æ‹¬å·ä¸­æ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpacesInCStyleCastParentheses: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœä¸ºtrueï¼Œå°†åœ¨If/for/switch/whileæ¡ä»¶æ‹¬å·å‰åæ’å…¥ç©ºæ ¼ã€‚</span></span><br><span class="line">SpacesInConditionalStatement: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨åœ†æ‹¬å·çš„(åå’Œ)å‰æ·»åŠ ç©ºæ ¼</span></span><br><span class="line">SpacesInParentheses: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨æ–¹æ‹¬å·çš„[åå’Œ]å‰æ·»åŠ ç©ºæ ¼ï¼Œlamdaè¡¨è¾¾å¼å’ŒæœªæŒ‡æ˜å¤§å°çš„æ•°ç»„çš„å£°æ˜ä¸å—å½±å“</span></span><br><span class="line">SpacesInSquareBrackets: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ ‡å‡†: Cpp03, Cpp11, Auto</span></span><br><span class="line">Standard: Cpp11</span><br><span class="line"></span><br><span class="line"><span class="comment"># tabå®½åº¦</span></span><br><span class="line">TabWidth: 4</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨tabå­—ç¬¦: Never, ForIndentation, ForContinuationAndIndentation, Always</span></span><br><span class="line">UseTab: Never</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Clang </tag>
            
            <tag> Tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buildroot æ‰“åŒ… rootfs</title>
      <link href="/2023/11/16/Cvitek-buildroot/"/>
      <url>/2023/11/16/Cvitek-buildroot/</url>
      
        <content type="html"><![CDATA[<h2 id="Cvitek-buildroot-æ‰“åŒ…-rootfs-æµç¨‹ä»‹ç»"><a href="#Cvitek-buildroot-æ‰“åŒ…-rootfs-æµç¨‹ä»‹ç»" class="headerlink" title="Cvitek buildroot æ‰“åŒ… rootfs æµç¨‹ä»‹ç»"></a>Cvitek buildroot æ‰“åŒ… rootfs æµç¨‹ä»‹ç»</h2><blockquote><p>åŸºäº <a href="https://github.com/sophgo/cvi_mmf_sdk/tree/v4.1.0">https://github.com/sophgo/cvi_mmf_sdk&#x2F;tree&#x2F;v4.1.0</a> çš„å®ç°ã€‚</p></blockquote><h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>åœ¨ <a href="https://github.com/sophgo/cvi_mmf_sdk">cvi_mmf_sdk</a> ä¸­ï¼Œæ”¯æŒä¸¤ç§ç”Ÿæˆ rootfs çš„æ–¹å¼ï¼š</p><ul><li>åŸºäº ramdisk ç›®å½•ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿã€‚</li><li>åŸºäº buildroot æ‰“åŒ…ç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿã€‚</li></ul><p>å‰è€…ä»…ä¿ç•™äº†å¸¸ç”¨çš„ä¸€äº›å·¥å…·ï¼Œå› æ­¤ç”Ÿæˆçš„æ–‡ä»¶ç³»ç»Ÿè¾ƒå°ï¼Œä¸è¿‡æ–°å¢å·¥å…·æ¯”è¾ƒéº»çƒ¦ã€‚åè€…æ–¹ä¾¿ç”¨æˆ·è‡ªå·±æ§åˆ¶éœ€è¦æ‰“åŒ…å“ªäº›å·¥å…·ã€‚</p><p><strong>é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼æ¥ç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œå¯é€šè¿‡åœ¨æ¿å­çš„é…ç½®æ–‡ä»¶ä¸­åŠ ä¸Š <code>CONFIG_BUILDROOT_FS=y</code> ï¼ˆå¦‚ <a href="https://github.com/sophgo/cvi_mmf_sdk/blob/v4.1.0/build/boards/cv181x/cv1812cp_sophpi_duo_sd/cv1812cp_sophpi_duo_sd_defconfig#L30">cv1812cp_sophpi_duo_sd_defconfig#L30</a> ä¸­çš„ä¾‹å­ï¼‰ï¼Œä»¥å¯ç”¨ <code>buildroot</code> æ¥ç”Ÿæˆæ–‡ä»¶ç³»ç»Ÿã€‚</p><h2 id="rootfs-æ‰“åŒ…æµç¨‹è¯´æ˜"><a href="#rootfs-æ‰“åŒ…æµç¨‹è¯´æ˜" class="headerlink" title="rootfs æ‰“åŒ…æµç¨‹è¯´æ˜"></a>rootfs æ‰“åŒ…æµç¨‹è¯´æ˜</h2><p>åœ¨ <code>source cvisetup.sh</code> ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>pack_rootfs</code> å‘½ä»¤æ¥æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿäº†ã€‚å®ƒæœ¬è´¨ä¸Šæ˜¯å®šä¹‰åœ¨ <a href="https://github.com/sophgo/cvi_mmf_sdk/blob/v4.1.0/build/common_functions.sh#L107">common_functions.sh</a> ä¸­çš„ä¸€ä¸ª shell å‡½æ•°ï¼Œåœ¨è®¾ç½®å¿…è¦çš„ç¯å¢ƒå˜é‡åï¼Œé€šè¿‡ <code>make rootfs</code> å®Œæˆæ‰“åŒ…çš„ç›¸å…³å¤„ç†ã€‚ä¸»è¦æœ‰3ä¸ªæ­¥éª¤ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">rootfs-prepare:</span></span><br><span class="line"><span class="comment"># è¿™é‡Œå°†æ‰€éœ€è¦çš„æ‰“åŒ…æ–‡ä»¶éƒ½å¤åˆ¶åˆ° $(OUTPUT_DIR)/rootfs è¿™ä¸ªç›®å½•ä¸­</span></span><br><span class="line"></span><br><span class="line"><span class="section">rootfs-pack:rootfs-prepare</span></span><br><span class="line"><span class="section">rootfs-pack:</span></span><br><span class="line"><span class="comment"># å®Œæˆä¸€äº›æ¸…ç†å·¥ä½œï¼Œå»æ‰æ— ç”¨çš„æ–‡ä»¶æˆ–è€… strip koæ–‡ä»¶ç­‰</span></span><br><span class="line"><span class="comment"># åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="section">rootfs:rootfs-pack</span></span><br><span class="line"><span class="section">rootfs:</span></span><br><span class="line"><span class="comment"># æ–‡ä»¶ç³»ç»Ÿåœ¨ rootfs-pack ä¸­å·²åˆ¶ä½œå®Œæˆï¼Œ</span></span><br><span class="line"><span class="comment"># è¿™é‡Œä»…å¯¹è¯¥æ–‡ä»¶å†è¿›è¡Œå°è£…ä¸€ä¸ªæŒ‡å®šçš„ Headerï¼Œçƒ§å½•åˆ° flash æ—¶ä¼šæ£€æŸ¥è¯¥ Headerã€‚</span></span><br><span class="line"><span class="comment"># è‹¥æ— Headerï¼Œæˆ–Headerä¿¡æ¯ä¸æ­£ç¡®ï¼Œå°±ä¼šè·³è¿‡è¯¥æ–‡ä»¶çš„çƒ§å½•ã€‚Headeræœ¬èº«å¹¶ä¸ä¼šçƒ§å½•åˆ° flashã€‚</span></span><br><span class="line"><span class="comment"># å¦‚æœæ˜¯ SD å¡å¯åŠ¨çš„æ–¹å¼ï¼Œåˆ™ä¸éœ€è¦å°è£…ã€‚</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(STORAGE_TYPE)</span>, sd)</span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> raw2cimg ,rootfs.<span class="variable">$(STORAGE_TYPE)</span>)</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯åŸºäº <code>ramdisk</code> ç›®å½•åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿçš„æµç¨‹ï¼ŒåŸºäº <code>buildroot</code> çš„æµç¨‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼š</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">br-rootfs-prepare:</span></span><br><span class="line"><span class="comment"># å°†å¿…è¦çš„æ–‡ä»¶å¤åˆ¶åˆ° buildroot ç›®å½•ä¸‹çš„ overlay ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"># buildroot åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿæ—¶ä¼šå°†è¯¥ç›®å½•ä¸‹çš„æ–‡ä»¶ä¹ŸåŒ…å«è¿›å»ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="section">br-rootfs-pack:</span></span><br><span class="line"><span class="comment"># åˆ¶ä½œ ext4 çš„æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ Makefile ä¸­ï¼Œä¼šæ£€æŸ¥ CONFIG_BUILDROOT_FS é…ç½®æ˜¯å¦å¯ç”¨</span></span><br><span class="line"><span class="comment"># è‹¥å¯ç”¨äº†ï¼Œåˆ™é€šè¿‡ br-rootfs-pack è°ƒç”¨ buildroot æ¥åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿã€‚</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CONFIG_BUILDROOT_FS)</span>,y)</span><br><span class="line"><span class="section">rootfs:br-rootfs-prepare</span></span><br><span class="line"><span class="section">rootfs:br-rootfs-pack</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="section">rootfs:rootfs-pack</span></span><br><span class="line"><span class="section">rootfs:</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> print_target)</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(STORAGE_TYPE)</span>, sd)</span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> raw2cimg ,rootfs.<span class="variable">$(STORAGE_TYPE)</span>)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure><p>æœ‰äº†åŸºæœ¬æµç¨‹çš„æ¦‚å¿µåï¼Œä¸‹é¢å±•å¼€åˆ†æåŸºäº <code>buildroot</code> åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿçš„æµç¨‹ã€‚</p><h3 id="br-rootfs-prepare"><a href="#br-rootfs-prepare" class="headerlink" title="br-rootfs-prepare"></a>br-rootfs-prepare</h3><p><code>br-rootfs-prepare</code> çš„ä¸»è¦å·¥ä½œæ˜¯å°†éœ€è¦æ‰“åŒ…åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ°æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œä»¥ä¾¿ buildroot åœ¨åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œèƒ½å°†è¿™äº›æ–‡ä»¶ä¸€åŒæ‰“åŒ…ã€‚ä¸€èˆ¬è¿™äº›æ–‡ä»¶åŒ…æ‹¬ï¼š</p><ul><li><code>build_kernel</code> å¾—åˆ°çš„ <code>.ko</code> æ–‡ä»¶ï¼›</li><li><code>build_middleware</code> å¾—åˆ°çš„åŠ¨æ€åº“æ–‡ä»¶ï¼›</li><li>å­˜æ”¾åœ¨ <code>middlleware</code> ä¸­ä»¥ <code>ko</code> æˆ– <code>so</code> å½¢å¼å‘å¸ƒçš„ä¸€äº›æ¨¡å—ï¼Œå¦‚ï¼š<a href="https://github.com/sophgo/cvi_mmf_sdk/tree/v4.1.0/middleware/v2/cv180x/ko">middleware&#x2F;v2&#x2F;cv180x&#x2F;ko</a>ã€‚</li></ul><p>åœ¨ <code>cvisetup.sh</code> ä¸­å°†éœ€è¦çš„è·¯å¾„å¯¼å‡ºä¸ºç¯å¢ƒå˜é‡ï¼Œä¸»è¦æœ‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># buildroot ä»“åº“æ‰€åœ¨è·¯å¾„</span></span><br><span class="line"><span class="built_in">export</span> BR_DIR=<span class="string">&quot;<span class="variable">$TOP_DIR</span>&quot;</span>/buildroot-2021.05</span><br><span class="line"></span><br><span class="line"><span class="comment"># overlay è·¯å¾„ï¼Œç”¨äºå­˜å‚¨éœ€è¦æ‰“åŒ…åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">export</span> BR_OVERLAY_DIR=<span class="variable">$&#123;BR_DIR&#125;</span>/board/cvitek/<span class="variable">$&#123;CHIP_ARCH&#125;</span>/overlay</span><br><span class="line"></span><br><span class="line"><span class="comment"># buildroot çš„é…ç½®æ–‡ä»¶åç§°ï¼Œå³ï¼š</span></span><br><span class="line"><span class="comment"># cvitek_CV180X_musl_riscv64_defconfig  cvitek_CV181X_musl_riscv64_defconfig</span></span><br><span class="line"><span class="built_in">export</span> BR_BOARD=cvitek_<span class="variable">$&#123;CHIP_ARCH&#125;</span>_<span class="variable">$&#123;SDK_VER&#125;</span></span><br><span class="line"><span class="built_in">export</span> BR_DEFCONFIG=<span class="variable">$&#123;BR_BOARD&#125;</span>_defconfig</span><br><span class="line"></span><br><span class="line"><span class="comment"># buildroot ç”Ÿæˆçš„æ–‡ä»¶ç³»ç»Ÿçš„ä¿å­˜è·¯å¾„</span></span><br><span class="line"><span class="built_in">export</span> BR_ROOTFS_DIR=<span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>&quot;</span>/tmp-rootfs</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç¯å¢ƒå˜é‡å®šä¹‰äº†æ–‡ä»¶å¤åˆ¶çš„ç›®æ ‡ä½ç½®ï¼Œåœ¨ <code>br-rootfs-prepare</code> åªè¿›è¡Œå¤åˆ¶å³å¯ï¼</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">br-rootfs-prepare:</span></span><br><span class="line"><span class="comment"># å¤åˆ¶ ko ä»¥åŠç›¸å…³ lib åˆ° buildroot ç›¸å…³è·¯å¾„</span></span><br><span class="line">$&#123;Q&#125;mkdir -p <span class="variable">$(BR_OVERLAY_DIR)</span>/mnt/system</span><br><span class="line">$&#123;Q&#125;cp -arf $&#123;SYSTEM_OUT_DIR&#125;/* <span class="variable">$(BR_OVERLAY_DIR)</span>/mnt/system/</span><br><span class="line"><span class="comment"># å¯¹ ko ä»¥åŠç›¸å…³åŠ¨æ€åº“ è¿›è¡Œ stripï¼Œä»¥ç¼©å°æ–‡ä»¶ç³»ç»Ÿå¤§å°</span></span><br><span class="line">$&#123;Q&#125;find <span class="variable">$(BR_OVERLAY_DIR)</span> -name <span class="string">&quot;*.ko&quot;</span> -type f -printf &#x27;striping %p\n&#x27; -exec <span class="variable">$(CROSS_COMPILE_KERNEL)</span>strip --strip-unneeded &#123;&#125; \;</span><br><span class="line">$&#123;Q&#125;find <span class="variable">$(BR_OVERLAY_DIR)</span> -name <span class="string">&quot;*.so*&quot;</span> -type f -printf &#x27;striping %p\n&#x27; -exec <span class="variable">$(CROSS_COMPILE_KERNEL)</span>strip --strip-all &#123;&#125; \;</span><br><span class="line">$&#123;Q&#125;find <span class="variable">$(BR_OVERLAY_DIR)</span> -executable -type f ! -name <span class="string">&quot;*.sh&quot;</span> ! -path <span class="string">&quot;*etc*&quot;</span> ! -path <span class="string">&quot;*.ko&quot;</span> -printf &#x27;striping %p\n&#x27; -exec <span class="variable">$(CROSS_COMPILE_SDK)</span>strip --strip-all &#123;&#125; 2&gt;/dev/null \;</span><br></pre></td></tr></table></figure><h3 id="br-rootfs-pack"><a href="#br-rootfs-pack" class="headerlink" title="br-rootfs-pack"></a>br-rootfs-pack</h3><p><code>br-rootfs-pack</code> çš„ä¸»è¦å·¥ä½œæ˜¯æŒ‡å®š buildroot çš„é…ç½®æ–‡ä»¶ï¼Œå®Œæˆ buildroot çš„ç¼–è¯‘å·¥ä½œï¼Œä»¥å¾—åˆ°éœ€è¦çš„æ–‡ä»¶ç³»ç»Ÿã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">br-rootfs-pack:export TARGET_OUTPUT_DIR=<span class="variable">$(BR_DIR)</span>/output/<span class="variable">$(BR_BOARD)</span></span></span><br><span class="line"><span class="section">br-rootfs-pack:</span></span><br><span class="line"><span class="comment"># æŒ‡å®šé…ç½®æ–‡ä»¶ å’Œ ç¼–è¯‘å·¥å…·é“¾è·¯å¾„</span></span><br><span class="line">$&#123;Q&#125;<span class="variable">$(MAKE)</span> -C <span class="variable">$(BR_DIR)</span> <span class="variable">$(BR_DEFCONFIG)</span> BR2_TOOLCHAIN_EXTERNAL_PATH=<span class="variable">$(CROSS_COMPILE_PATH)</span></span><br><span class="line"><span class="comment"># ç¼–è¯‘å¾—åˆ°æ–‡ä»¶ç³»ç»Ÿï¼Œä½äº $(TARGET_OUTPUT_DIR)/images/rootfs.ext4</span></span><br><span class="line">$&#123;Q&#125;<span class="variable">$(MAKE)</span> -j$&#123;NPROC&#125; -C <span class="variable">$(BR_DIR)</span></span><br><span class="line"><span class="comment"># $&#123;Q&#125;rm -rf $(BR_ROOTFS_DIR)/*</span></span><br><span class="line"><span class="comment"># å°†æ–‡ä»¶ç³»ç»Ÿä» buildroot è·¯å¾„ï¼Œå¤åˆ¶åˆ° SDK ç»Ÿä¸€çš„è¾“å‡ºè·¯å¾„ $(OUTPUT_DIR)</span></span><br><span class="line"> $&#123;Q&#125;cp <span class="variable">$(TARGET_OUTPUT_DIR)</span>/images/rootfs.ext4 <span class="variable">$(OUTPUT_DIR)</span>/rawimages/rootfs_ext4.<span class="variable">$(STORAGE_TYPE)</span></span><br><span class="line"> <span class="comment"># å°è£… Headerï¼Œè¿™æ˜¯çƒ§å½•åˆ° flash çš„å¿…è¦æ­¥éª¤</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> raw2cimg ,rootfs_ext4.<span class="variable">$(STORAGE_TYPE)</span>)</span></span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œå°±å¾—åˆ°äº† buildroot ç¼–è¯‘çš„æ–‡ä»¶ç³»ç»Ÿï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>è¯¥æ–‡ä»¶ç³»ç»Ÿä¸­ä»…åŒ…å«äº† <code>ko</code> å’Œ åŠ¨æ€åº“ï¼Œramdisk ä¸­çš„ä¸€äº›å¼€æœºè‡ªåŠ¨è¿è¡Œçš„è„šæœ¬å¹¶æœªåŒ…å«è¿›æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå› æ­¤æ²¡æœ‰è‡ªåŠ¨åŠ è½½ ko ç­‰æµç¨‹</strong></p><h2 id="buildroot-é…ç½®æ–‡ä»¶è¯´æ˜"><a href="#buildroot-é…ç½®æ–‡ä»¶è¯´æ˜" class="headerlink" title="buildroot é…ç½®æ–‡ä»¶è¯´æ˜"></a>buildroot é…ç½®æ–‡ä»¶è¯´æ˜</h2><p>ç›®å‰ <code>buildroot/configs</code> ç›®å½•ä¸‹æä¾›äº† <code>cv180x, cv181x</code> çš„åŸºç¡€é…ç½®æ–‡ä»¶ï¼Œç”¨æˆ·å¯åœ¨è¯¥é…ç½®æ–‡ä»¶çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œéƒ¨åˆ†å‚æ•°ä¸ä¸Šé¢ä»‹ç»çš„ç¼–è¯‘æµç¨‹æˆ–ç¼–è¯‘å·¥å…·é“¾æœ‰å…³ï¼Œä¸å¯éšæ„æ›´æ”¹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å·¥å…·é“¾ç›¸å…³çš„é…ç½®ã€‚</span></span><br><span class="line">BR2_TOOLCHAIN_*</span><br><span class="line">BR2_TOOLCHAIN_EXTERNAL_PREFIX=<span class="string">&quot;riscv64-unknown-linux-musl&quot;</span></span><br><span class="line">BR2_TARGET_LDFLAGS=<span class="string">&quot;-mcpu=c906fdv -march=rv64imafdcv0p7xthead -mcmodel=medany -mabi=lp64d&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. overlay è·¯å¾„</span></span><br><span class="line">BR2_ROOTFS_OVERLAY=<span class="string">&quot;board/cvitek/CV181X/overlay&quot;</span></span><br></pre></td></tr></table></figure><h3 id="ç½‘ç»œé—®é¢˜"><a href="#ç½‘ç»œé—®é¢˜" class="headerlink" title="ç½‘ç»œé—®é¢˜"></a>ç½‘ç»œé—®é¢˜</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å›½å†…é•œåƒ</span></span><br><span class="line">BR2_BACKUP_SITE=<span class="string">&quot;http://sources.buildroot.net&quot;</span></span><br><span class="line">BR2_KERNEL_MIRROR=<span class="string">&quot;https://mirrors.aliyun.com/linux-kernel&quot;</span></span><br><span class="line">BR2_GNU_MIRROR=<span class="string">&quot;https://mirrors.aliyun.com/gnu&quot;</span></span><br><span class="line">BR2_LUAROCKS_MIRROR=<span class="string">&quot;https://luarocks.cn&quot;</span></span><br><span class="line">BR2_CPAN_MIRROR=<span class="string">&quot;https://mirrors.aliyun.com/CPAN&quot;</span></span><br></pre></td></tr></table></figure><p>æœ‰äº›ä»“åº“è®¾ç½®ä¸Šé¢çš„ä»£ç†ä¹Ÿæ²¡ç”¨ğŸ˜‘ï¼Œå°±éœ€è¦<strong>æ‰‹åŠ¨ä¸‹è½½åï¼Œæ”¾åˆ° <code>buildroot-2021.05/dl</code> å¯¹åº”æ¨¡å—çš„æ–‡ä»¶å¤¹ä¸‹</strong>ã€‚</p><h3 id="æ‰“åŒ…-public-å·¥å…·é—®é¢˜"><a href="#æ‰“åŒ…-public-å·¥å…·é—®é¢˜" class="headerlink" title="æ‰“åŒ… public å·¥å…·é—®é¢˜"></a>æ‰“åŒ… public å·¥å…·é—®é¢˜</h3><p>åœ¨ä½¿ç”¨ ramdisk æ–¹å¼æ‰“åŒ…æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œæœ‰ä»å¥½å‡ ä¸ªåœ°æ–¹å¤åˆ¶æ–‡ä»¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ—¢ç„¶é€‰æ‹©ç”¨ buildroot äº†ï¼Œä¸€äº›ä¸‰æ–¹å·¥å…·éƒ½ç›´æ¥ç”¨ buildroot ç¼–è¯‘çš„å°±å¥½ï¼Œä¸éœ€è¦æ‹·è´ã€‚<strong>ä¸è¿‡åƒ S11defer_init è¿™ä¸ªæ–‡ä»¶ï¼Œåˆå¿…é¡»ä» ramdisk æ‹·è´ã€‚</strong></p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä» ramdisk/rootfs/public ä¸‹æ‹·è´é€‰ä¸­çš„å·¥å…·</span></span><br><span class="line"><span class="keyword">define</span> TARGET_PACKAGE_INSTALL_CMD</span><br><span class="line">@echo &#x27;TARGET PACKAGE OUTPUT DIR=<span class="variable">$(OUTPUT_DIR)</span>/rootfs&#x27;;\</span><br><span class="line"><span class="variable">$(<span class="built_in">foreach</span> t,<span class="variable">$(TARGET_PACKAGES)</span>,\</span></span><br><span class="line"><span class="variable">$&#123;Q&#125;cd <span class="variable">$(TOP_DIR)</span>/ramdisk/rootfs/public/<span class="variable">$(t)</span>/<span class="variable">$(packages_arch)</span>/ &amp;&amp; \</span></span><br><span class="line"><span class="variable">$&#123;Q&#125;find . \( ! -type d ! -name &quot;*.a&quot; ! -path &quot;*include*&quot; ! -name &quot;.gitkeep&quot; \)</span> \</span><br><span class="line">-printf &#x27;Copy Package file <span class="variable">$(TOP_DIR)</span>/ramdisk/rootfs/public/<span class="variable">$(t)</span>/<span class="variable">$(packages_arch)</span>/%p\n&#x27; \</span><br><span class="line">-exec cp -a --remove-destination --parents &#x27;&#123;&#125;&#x27; <span class="variable">$(OUTPUT_DIR)</span>/rootfs/ \; ; )</span><br><span class="line"><span class="keyword">endef</span></span><br><span class="line"></span><br><span class="line"><span class="section">rootfs-prepare:<span class="variable">$(OUTPUT_DIR)</span>/rootfs</span></span><br><span class="line"><span class="comment"># Copy rootfs</span></span><br><span class="line"><span class="keyword">ifeq</span> (<span class="variable">$(CONFIG_FASTBOOT)</span>,y)</span><br><span class="line">$&#123;Q&#125;cp -a --remove-destination <span class="variable">$(RAMDISK_PATH)</span>/rootfs/<span class="variable">$(ROOTFS_BASE)</span>_shrink/* <span class="variable">$(OUTPUT_DIR)</span>/rootfs</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">$&#123;Q&#125;cp -a --remove-destination <span class="variable">$(RAMDISK_PATH)</span>/rootfs/<span class="variable">$(ROOTFS_BASE)</span>/* <span class="variable">$(OUTPUT_DIR)</span>/rootfs</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy arch overlay rootfs</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="string">&quot;$(wildcard <span class="variable">$(SDK_VER_FOLDER_PATH)</span>)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">$&#123;Q&#125;cp -r <span class="variable">$(SDK_VER_FOLDER_PATH)</span>/* <span class="variable">$(OUTPUT_DIR)</span>/rootfs</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy chip overlay rootfs</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="string">&quot;$(wildcard <span class="variable">$(CHIP_FOLDER_PATH)</span>)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">$&#123;Q&#125;cp -r <span class="variable">$(CHIP_FOLDER_PATH)</span>/* <span class="variable">$(OUTPUT_DIR)</span>/rootfs</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy project overlay rootfs</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="string">&quot;$(wildcard <span class="variable">$(CUST_FOLDER_PATH)</span>)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">$&#123;Q&#125;cp -r <span class="variable">$(CUST_FOLDER_PATH)</span>/* <span class="variable">$(OUTPUT_DIR)</span>/rootfs</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“åŒ… menuconfig ä¸­é…ç½®çš„ä¸€äº›ä¸‰æ–¹å·¥å…·ã€‚æ¯”å¦‚ ntp/dropbear/python3 ç­‰</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> TARGET_PACKAGE_INSTALL_CMD)</span></span><br><span class="line"><span class="comment"># è®¾ç½®å…¶ä»–</span></span><br><span class="line">$&#123;Q&#125;$&#123;BUILD_PATH&#125;/boards/default/rootfs_script/prepare_rootfs.sh <span class="variable">$(OUTPUT_DIR)</span>/rootfs</span><br><span class="line"><span class="comment"># Generate S10_automount</span></span><br><span class="line">$&#123;Q&#125;python3 <span class="variable">$(COMMON_TOOLS_PATH)</span>/image_tool/create_automount.py <span class="variable">$(FLASH_PARTITION_XML)</span> <span class="variable">$(OUTPUT_DIR)</span>/rootfs/etc/init.d/</span><br><span class="line"><span class="comment"># Generate /etc/fw_env.config</span></span><br><span class="line">$&#123;Q&#125;python3 <span class="variable">$(COMMON_TOOLS_PATH)</span>/image_tool/mkcvipart.py <span class="variable">$(FLASH_PARTITION_XML)</span> <span class="variable">$(OUTPUT_DIR)</span>/rootfs/etc/ --fw_env</span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(CONFIG_FASTBOOT)</span>,y)</span><br><span class="line">if [ -f <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/fastboot ]; then $&#123;Q&#125;rm -rf <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/fastboot ; fi ;</span><br><span class="line">if [ -f <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/S11defer_init ]; then $&#123;Q&#125;rm -rf <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/S11defer_init; fi ;</span><br><span class="line"><span class="keyword">endif</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»å‡ ä¸ªè·¯å¾„æ‹·äº†æ–‡ä»¶ï¼Œåœ¨ä½¿ç”¨ buildroot æ—¶ï¼Œå¯ä»¥é€‰æ‹©åªä» Project è·¯å¾„æ‹·è´ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CUST_FOLDER_NAME = cv1813ha_wevb_0007a_emmc</span><br><span class="line">CHIP_FOLDER_PATH = /data/song.yu/youdao2/v4.2.0-intl/ramdisk/rootfs/overlay/cv1813ha</span><br><span class="line">SDK_VER_FOLDER_PATH = /data/song.yu/youdao2/v4.2.0-intl/ramdisk/rootfs/overlay/cv181x_32bit</span><br><span class="line">CUST_FOLDER_PATH = /data/song.yu/youdao2/v4.2.0-intl/ramdisk/rootfs/overlay/cv1813ha_wevb_0007a_emmc</span><br></pre></td></tr></table></figure><p>å°†å¿…éœ€çš„æ–‡ä»¶æ”¾åœ¨ <code>ramdisk/rootfs/overlay/cv1813ha_wevb_0007a_emmc</code> ç›®å½•ä¸‹å°±è¡Œã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">br-rootfs-prepare:</span></span><br><span class="line"><span class="variable">$(<span class="built_in">call</span> print_target)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copy project overlay rootfs, like ramdisk/rootfs/overlay/cv1813ha_wevb_0007a_emmc</span></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="string">&quot;$(wildcard <span class="variable">$(CUST_FOLDER_PATH)</span>)&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">$&#123;Q&#125;cp -r <span class="variable">$(CUST_FOLDER_PATH)</span>/* <span class="variable">$(BR_OVERLAY_DIR)</span></span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate /etc/inid.d/S10automount</span></span><br><span class="line">$&#123;Q&#125;python3 <span class="variable">$(COMMON_TOOLS_PATH)</span>/image_tool/create_automount.py <span class="variable">$(FLASH_PARTITION_XML)</span> <span class="variable">$(BR_OVERLAY_DIR)</span>/etc/init.d/</span><br><span class="line"><span class="comment"># Generate /etc/fw_env.config</span></span><br><span class="line">$&#123;Q&#125;python3 <span class="variable">$(COMMON_TOOLS_PATH)</span>/image_tool/mkcvipart.py <span class="variable">$(FLASH_PARTITION_XML)</span> <span class="variable">$(BR_OVERLAY_DIR)</span>/etc/ --fw_env</span><br><span class="line"></span><br><span class="line"><span class="keyword">ifneq</span> (<span class="variable">$(CONFIG_FASTBOOT)</span>,y)</span><br><span class="line">if [ -f <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/fastboot ]; then $&#123;Q&#125;rm -rf <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/fastboot ; fi ;</span><br><span class="line">if [ -f <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/S11defer_init ]; then $&#123;Q&#125;rm -rf <span class="variable">$(ROOTFS_DIR)</span>/etc/init.d/S11defer_init; fi ;</span><br><span class="line"><span class="keyword">endif</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># copy ko and mmf libs</span></span><br><span class="line">$&#123;Q&#125;mkdir -p <span class="variable">$(BR_OVERLAY_DIR)</span>/mnt/system</span><br><span class="line">$&#123;Q&#125;cp -arf $&#123;SYSTEM_OUT_DIR&#125;/* <span class="variable">$(BR_OVERLAY_DIR)</span>/mnt/system/</span><br><span class="line"><span class="comment"># strip</span></span><br><span class="line">$&#123;Q&#125;find <span class="variable">$(BR_OVERLAY_DIR)</span> -name <span class="string">&quot;*.ko&quot;</span> -type f -printf &#x27;striping %p\n&#x27; -exec <span class="variable">$(CROSS_COMPILE_KERNEL)</span>strip --strip-unneeded &#123;&#125; \;</span><br><span class="line">$&#123;Q&#125;find <span class="variable">$(BR_OVERLAY_DIR)</span> -name <span class="string">&quot;*.so*&quot;</span> -type f -printf &#x27;striping %p\n&#x27; -exec <span class="variable">$(CROSS_COMPILE_KERNEL)</span>strip --strip-all &#123;&#125; \;</span><br><span class="line">$&#123;Q&#125;find <span class="variable">$(BR_OVERLAY_DIR)</span> -executable -type f ! -name <span class="string">&quot;*.sh&quot;</span> ! -path <span class="string">&quot;*etc*&quot;</span> ! -path <span class="string">&quot;*.ko&quot;</span> -printf &#x27;striping %p\n&#x27; -exec <span class="variable">$(CROSS_COMPILE_SDK)</span>strip --strip-all &#123;&#125; 2&gt;/dev/null \;</span><br></pre></td></tr></table></figure><p>å¦‚æœéè¦ rootfs&#x2F;public ä¸‹çš„å·¥å…·ï¼Œä¹Ÿåœ¨åŠ ä¸Šè¿™ä¸ªï¼Œä¸å»ºè®®ï¼è¿˜æ˜¯ç›´æ¥ä¿®æ”¹ buildroot é…ç½®æ›´å¥½ã€‚</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">define</span> TARGET_PACKAGE_INSTALL_CMD_BR</span><br><span class="line">@echo &#x27;TARGET PACKAGE OUTPUT DIR=<span class="variable">$(BR_OVERLAY_DIR)</span>&#x27;;\</span><br><span class="line"><span class="variable">$(<span class="built_in">foreach</span> t,<span class="variable">$(TARGET_PACKAGES)</span>,\</span></span><br><span class="line"><span class="variable">$&#123;Q&#125;cd <span class="variable">$(TOP_DIR)</span>/ramdisk/rootfs/public/<span class="variable">$(t)</span>/<span class="variable">$(packages_arch)</span>/ &amp;&amp; \</span></span><br><span class="line"><span class="variable">$&#123;Q&#125;find . \( ! -type d ! -name &quot;*.a&quot; ! -path &quot;*include*&quot; ! -name &quot;.gitkeep&quot; \)</span> \</span><br><span class="line">-printf &#x27;Copy Package file <span class="variable">$(TOP_DIR)</span>/ramdisk/rootfs/public/<span class="variable">$(t)</span>/<span class="variable">$(packages_arch)</span>/%p\n&#x27; \</span><br><span class="line">-exec cp -a --remove-destination --parents &#x27;&#123;&#125;&#x27; <span class="variable">$(BR_OVERLAY_DIR)</span>/ \; ; )</span><br><span class="line"><span class="keyword">endef</span></span><br></pre></td></tr></table></figure><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><ul><li><p>â—â—æ³¨æ„ï¼šbuildroot ç›®å½•ä¸‹çš„ output&#x2F;xxx ä¸­çš„æ–‡ä»¶ï¼Œå¹¶ä¸ä¼šè‡ªåŠ¨åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œoverlayä¸­ç¬¬ä¸€æ¬¡æ·»åŠ äº†æŸä¸ªæ–‡ä»¶ï¼Œåé¢ä¸éœ€è¦è¿™ä¸ªæ–‡ä»¶äº†ï¼Œä»…ä»overlayç›®å½•åˆ é™¤è¿˜ä¸å¤Ÿï¼Œå¿…é¡»ä» output&#x2F;xxx&#x2F;target ä¸­åˆ é™¤ï¼Œè€Œä¸”æœ‰æ—¶å€™å¥‡å¥‡æ€ªæ€ªçš„ç¼–è¯‘æŠ¥é”™ï¼Œç›´æ¥æ¸…ç©º output&#x2F;xxx æ–‡ä»¶å¤¹ä¹Ÿèƒ½è§£å†³ã€‚</p><p>â—ä¹Ÿä¸èƒ½ç®€å•åœ°ç›´æ¥ <strong>åª</strong> åˆ é™¤output&#x2F;xxx&#x2F;target  ä¸­çš„æ–‡ä»¶ï¼Œæœ‰ä¸€äº›æ–‡ä»¶ã€æ–‡ä»¶å¤¹æ˜¯åœ¨ buildroot æŸä¸ªæ¨¡å—çš„ç¼–è¯‘è¿‡ç¨‹ä¸­æ”¾è¿›å»çš„ï¼Œåªåˆ é™¤ç›®æ ‡æ–‡ä»¶ï¼Œè€Œä¸æ¸…æ¥šç¼–è¯‘ä¸­é—´æ–‡ä»¶ output&#x2F;xxx&#x2F;buildï¼Œé‚£äº›æ–‡ä»¶ä¹Ÿä¸ä¼šé‡æ–°ç”Ÿæˆã€‚</p><p>å¦‚æœåœ¨æµç¨‹ä¸­è‡ªåŠ¨æ¸…ç©º output&#x2F;xxx æ–‡ä»¶å¤¹ï¼Œä¼šå¯¼è‡´ç¼–è¯‘æ—¶é—´å˜å¾—å¾ˆé•¿ã€‚</p></li><li><p>å¦‚ä½•å»æ‰å¼€æœºå¿…é¡»è¾“å…¥ç”¨æˆ·åã€å¯†ç ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ä¿®æ”¹ getty æœåŠ¡</span><br><span class="line">å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ getty æ¥ç®¡ç†ç»ˆç«¯ç™»å½•ï¼Œå¯ä»¥åœ¨ /etc/inittab æ–‡ä»¶ä¸­è®¾ç½®è‡ªåŠ¨ç™»å½•ã€‚</span><br><span class="line"></span><br><span class="line">ç¼–è¾‘ /etc/inittabï¼š</span><br><span class="line">æ‰“å¼€ /etc/inittab æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œæ‰¾åˆ°ç±»ä¼¼äºä»¥ä¸‹çš„è¡Œï¼š</span><br><span class="line"></span><br><span class="line">1:2345:respawn:/sbin/getty 38400 tty1</span><br><span class="line">ä¿®æ”¹ä¸ºï¼š</span><br><span class="line"></span><br><span class="line">1:2345:respawn:/sbin/getty --noclear tty1</span><br><span class="line">åˆ›å»ºè‡ªåŠ¨ç™»å½•çš„è„šæœ¬ï¼š</span><br><span class="line">åœ¨ /etc/init.d/ ä¸‹åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œå‘½åä¸º autologinï¼Œå†…å®¹å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">#!/bin/sh</span><br><span class="line">exec /bin/login -f your_username</span><br><span class="line">æ›¿æ¢ your_username ä¸ºä½ çš„å®é™…ç”¨æˆ·åã€‚</span><br><span class="line"></span><br><span class="line">ä½¿è„šæœ¬å¯æ‰§è¡Œï¼š</span><br><span class="line">chmod +x /etc/init.d/autologin</span><br></pre></td></tr></table></figure></li><li><p>ä¸æ˜¾ç¤ºå½“å‰æ‰€åœ¨è·¯å¾„ï¼Œå¢åŠ  <code>/etc/profile</code> æ–‡ä»¶ã€‚<code>\u: user \h: host</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/etc/profile</span></span><br><span class="line"><span class="built_in">export</span> LD_LIBRARY_PATH=<span class="string">&quot;/lib:/lib/3rd:/usr/lib:/mnt/system/lib:/mnt/system/usr/lib:/mnt/system/usr/lib/3rd:/mnt/data/lib&quot;</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">&quot;/usr/local/bin:/usr/bin:/bin:/usr/local/sbin:/usr/sbin:/sbin:/mnt/system/usr/bin:/mnt/system/usr/sbin:/mnt/data/bin:/mnt/data/sbin&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$PS1</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;`id -u`&quot;</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line"><span class="built_in">export</span> PS1=<span class="string">&#x27;# &#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">export</span> PS1=<span class="string">&#x27;$ &#x27;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> PAGER=<span class="string">&#x27;/bin/more &#x27;</span></span><br><span class="line"><span class="built_in">export</span> EDITOR=<span class="string">&#x27;/bin/vi&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Source configuration files from /etc/profile.d</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> /etc/profile.d/*.sh ; <span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$i</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">. <span class="variable">$i</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">unset</span> i</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> HOSTNAME=<span class="string">&quot;<span class="subst">$(hostname)</span>&quot;</span></span><br><span class="line"><span class="built_in">export</span> OLDPWD=/root</span><br><span class="line"></span><br><span class="line"><span class="comment"># \u: user \h: host</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&#x27;$USER&#x27;</span> == <span class="string">&#x27;root&#x27;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">export</span> PS1=<span class="string">&#x27;[\u@\h]\w\# &#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">export</span> PS1=<span class="string">&#x27;[\u@\h]\w\$ &#x27;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls -alF&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> la=<span class="string">&#x27;ls -A&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> l=<span class="string">&#x27;ls -CF&#x27;</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¹‹åï¼Œå°±æ˜¾ç¤º <code>[root@cvitek]~# </code></p></li><li><p>ä½¿ç”¨ erofs åªè¯»æ–‡ä»¶ç³»ç»Ÿåï¼Œ&#x2F;var&#x2F;run ä¸­ä¹Ÿåªè¯»ï¼Œå¯¼è‡´ä¸€äº›åŠ¨æ€ç”Ÿæˆçš„æ–‡ä»¶ï¼ˆå¦‚ PID æ–‡ä»¶ã€socket æ–‡ä»¶ç­‰ï¼‰æ— æ³•å†™å…¥ã€‚å¢åŠ  &#96;&#x2F;etc&#x2F;fstab æ–‡ä»¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ramdisk/rootfs/common_arm/etc$ cat fstab</span><br><span class="line"># &lt;file system&gt; &lt;mount pt&gt;      &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;</span><br><span class="line">/dev/root       /               ext2    rw,noauto       0       1</span><br><span class="line">proc            /proc           proc    defaults        0       0</span><br><span class="line">devpts          /dev/pts        devpts  defaults,gid=5,mode=620,ptmxmode=0666   0       0</span><br><span class="line">tmpfs           /dev/shm        tmpfs   mode=0777       0       0</span><br><span class="line">tmpfs           /tmp            tmpfs   mode=1777       0       0</span><br><span class="line">tmpfs           /run            tmpfs   mode=0755,nosuid,nodev  0       0</span><br><span class="line">tmpfs           /var/run        tmpfs   mode=0755,nosuid,nodev  0       0</span><br><span class="line">tmpfs           /var/lock       tmpfs   mode=0755,nosuid,nodev  0       0</span><br><span class="line">tmpfs           /var/empty      tmpfs   mode=0755,nosuid,nodev  0       0</span><br><span class="line">sysfs           /sys            sysfs   defaults        0       0</span><br><span class="line">nodev           /sys/kernel/debug debugfs   defaults    0       0</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Cvitek </tag>
            
            <tag> Buildroot </tag>
            
            <tag> Rootfs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux ç³»ç»Ÿç¼–ç¨‹-syslog</title>
      <link href="/2023/09/02/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-syslog/"/>
      <url>/2023/09/02/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-syslog/</url>
      
        <content type="html"><![CDATA[<h1 id="syslog"><a href="#syslog" class="headerlink" title="syslog"></a>syslog</h1><p>è¿™é‡Œè¯´çš„ <code>syslog</code> ä»…ä»…æ˜¯<code>api</code>ï¼Œ<code>man 3 syslog</code> æœ‰è¯¦ç»†çš„è¯´æ˜ã€‚ç®€å•æ¥è¯´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåº”ç”¨é€šè¿‡ <code>syslog()</code> è¿™ä¸ªè°ƒç”¨å°†æ—¥å¿—ä¿¡æ¯ä¼ é€’ç»™ <code>syslogd</code>ï¼ˆæˆ‘ä»¬å¯ä»¥ç§°ä¸ºæ—¥å¿—æ”¶é›†å™¨ï¼‰ã€‚<code>syslogd</code> å¯ä»¥æ ¹æ®é…ç½®æ–‡ä»¶ï¼ˆä¸€èˆ¬ä½äº <code>/etc/syslog.conf</code> æ¥å†³å®šå¦‚ä½•å¤„ç†æ—¥å¿—ä¿¡æ¯ï¼‰ã€‚æ¯”å¦‚ä¿å­˜åˆ°æŸä¸ªæ–‡ä»¶ã€å‘é€åˆ°è¿œç¨‹ä¸»æœºã€æ˜¾ç¤ºåˆ°æ§åˆ¶å°ç­‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">   app1               app2              app3 (äº§ç”Ÿæ—¥å¿—)</span><br><span class="line">    â”‚                   â”‚                â”‚</span><br><span class="line">    â”‚                   â”‚  syslog()      â”‚ (AF_UNIX ä¼ é€’æ—¥å¿—)</span><br><span class="line">    â”‚                   â”‚                â”‚</span><br><span class="line">    â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”         â”‚</span><br><span class="line">    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   syslogd    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”˜ (æ¥æ”¶æ—¥å¿—)</span><br><span class="line">                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><br><span class="line">                       â–¼</span><br><span class="line"> â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€syslog.confâ”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” (å¤„ç†æ—¥å¿—)</span><br><span class="line"> â”‚              â”‚              â”‚              â”‚</span><br><span class="line"> â”‚              â”‚              â”‚              â”‚</span><br><span class="line"> â–¼              â–¼              â–¼              â–¼</span><br><span class="line">file          console        remote         drop</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¦æŠŠæ—¥å¿—ä¿¡æ¯ä¼ é€’ç»™ <code>syslogd</code> è¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œå®é™…ä¸Šå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡ï¼Œè¿™é‡Œé‡‡ç”¨çš„æ˜¯æœ¬åœ°å¥—æ¥å­— <code>AF_UNIX</code>è¿™ç§æ–¹å¼å®ç°ã€‚å¯ä»¥å‚è€ƒ [Linux ç³»ç»Ÿç¼–ç¨‹-è¿›ç¨‹é€šä¿¡](.&#x2F;Linux ç³»ç»Ÿç¼–ç¨‹-è¿›ç¨‹é€šä¿¡.md)</p><h2 id="åŸºç¡€ç”¨æ³•"><a href="#åŸºç¡€ç”¨æ³•" class="headerlink" title="åŸºç¡€ç”¨æ³•"></a>åŸºç¡€ç”¨æ³•</h2><p>å¯¹ä½¿ç”¨æ¥è¯´ï¼Œå¾ˆç®€å•âœ¨ï¼Œå°±åªæ¶‰åŠåˆ° 3 ä¸ª <code>API</code> è°ƒç”¨ã€‚</p><blockquote><p>è™½ç„¶è¯´ <code>syslog</code> åè®®æ˜¯å¯ä»¥é€šè¿‡ç½‘ç»œå°†æ—¥å¿—ä¿¡æ¯ä¼ é€’ç»™å…¶ä»–ç½‘ç»œåœ°å€ï¼Œä½†è¿™æ˜¯ <code>syslogd</code> è¿™ä¸ªå®ˆæŠ¤è¿›ç¨‹çš„å·¥ä½œï¼Œå¯¹åº”ç”¨è€Œè¨€ï¼Œå®ƒåªéœ€è¦å°†æ—¥å¿—ä¿¡æ¯ä¼ é€’ç»™ <code>syslogd</code>ï¼Œåè€…ä¼šæ ¹æ®é…ç½®æ–‡ä»¶æ¥å†³å®šå¦‚ä½•å¤„ç†è¿™äº›æ—¥å¿—ä¿¡æ¯ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;syslog.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">openlog</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ident, <span class="type">int</span> option, <span class="type">int</span> facility)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">syslog</span><span class="params">(<span class="type">int</span> priority, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">closelog</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>openlog</code>ï¼šä¸ºå½“å‰åº”ç”¨å’Œ <code>system logger</code> å»ºç«‹è¿æ¥ï¼å…¶å®å°±æ˜¯å’Œ <code>syslogd</code> é€šè¿‡æœ¬åœ°å¥—æ¥å­—å®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚</li><li><code>syslog/vsyslog</code>ï¼šç”Ÿæˆä¸€æ¡æ—¥å¿—ä¿¡æ¯ï¼Œå®ƒå°†è¢«ä¼ é€’ç»™æ—¥å¿—æ”¶é›†å™¨ <code>syslogd</code>ï¼›</li><li><code>closelog</code>ï¼šæ–­å¼€å’Œ <code>system logger</code> çš„è¿æ¥ã€‚</li></ul><hr><h3 id="openlog"><a href="#openlog" class="headerlink" title="openlog"></a>openlog</h3><blockquote><p>å»ºç«‹æœ¬åœ°å¥—æ¥å­—è¿æ¥ã€‚å¯¹ <code>musl</code> è¿™ä¸ªåº“è€Œè¨€ï¼Œæœ¬åœ°å¥—æ¥å­—æ–‡ä»¶ä½äº <code>/dev/log</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@cvitek]/dev<span class="comment"># ls -lh log</span></span><br><span class="line">srw-rw-rw-    1 root     root           0 Jan  1 08:00 <span class="built_in">log</span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">openlog</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ident, <span class="type">int</span> option, <span class="type">int</span> facility)</span>;</span><br></pre></td></tr></table></figure><ul><li><p><code>ident</code>ï¼šæŒ‡å‘çš„å­—ç¬¦ä¸²è¢«æ·»åŠ åˆ°æ¯æ¡æ—¥å¿—ä¿¡æ¯çš„å‰é¢ï¼Œä¸€èˆ¬æŒ‡å®šä¸ºç¨‹åºåã€‚å¦‚æœ <code>ident</code> ä¸º <code>NULL</code>ï¼Œåˆ™ä½¿ç”¨ç¨‹åºåç§°ã€‚</p><blockquote><p>å› ä¸º <code>syslog</code> æœåŠ¡ç«¯ï¼ˆä¸€èˆ¬ä¸º <code>syslogd</code>ï¼‰ä¼šæ¥æ”¶åˆ°å¾ˆå¤šå®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥æ—¥å¿—å‰é¢ä¸€å®šè¦å¸¦æœ‰ç¨‹åºåæˆ–å…¶ä»–æ ‡è¯†å­—ç¬¦ä¸²ï¼Œè¿™æ ·æ‰èƒ½ç¡®å®šæ—¥å¿—æ¶ˆæ¯çš„æ¥æºã€‚</p></blockquote></li><li><p><code>option</code>ï¼šæŒ‡å®šè¿™ä¸ªè¿æ¥çš„ä¸€äº›ç‰¹æ€§ã€‚</p><blockquote><p>å°±åƒ<code>open</code>æ‰“å¼€æ–‡ä»¶æ—¶å¯ä»¥æŒ‡å®šä¸€äº› <code>flags</code>ï¼Œç”¨æ¥æ§åˆ¶è¯»å†™æƒé™ã€éé˜»å¡ç­‰ç­‰ã€‚ä¸è¿‡è¿™åªæ˜¯ä¸ªæ¯”å–»ï¼Œä¸æ‰“å¼€æ–‡ä»¶æ¯«æ— å…³ç³»ã€‚</p></blockquote></li><li><p><code>facility</code>ï¼šç”¨äºæŒ‡å®šè®°å½•æ¶ˆæ¯çš„ç¨‹åºç±»å‹ï¼Œæˆ–è€…è¯´æ¶ˆæ¯æ¥æºã€‚è¿™æ˜¯ä¸‹é¢è°ƒç”¨ <code>syslog</code> æ—¶çš„ä¸€ä¸ªé»˜è®¤å€¼ï¼Œä¸è¿‡å®é™…è°ƒç”¨æ—¶ä»ç„¶å¯ä»¥æ”¹ä¸ºå…¶ä»–ç±»å‹ã€‚</p><blockquote><p>ä¸ <code>ident</code> ç»†åˆ†æ¥æºå“ªä¸ªç¨‹åºä¸åŒï¼Œ<code>facility</code> æ˜¯æŒ‰å¤§ç±»åˆ’åˆ†ï¼Œæ¯”å¦‚æ¥è‡ªå†…æ ¸çš„æ¶ˆæ¯ï¼Œæˆ–è€…æ¥è‡ªç”¨æˆ·æ€çš„æ¶ˆæ¯ã€‚é€šè¿‡è¿™æ ·åˆ’åˆ†ï¼Œå¯ä»¥ä¸ºä¸åŒçš„å¤§ç±»è®¾ç½®ä¸åŒçš„è¾“å‡ºçº§åˆ«ï¼ˆé€šè¿‡é…ç½®æ–‡ä»¶è®¾ç½®ï¼‰ã€‚æ¯”å¦‚å†…æ ¸çš„æ—¥å¿—åªè®°å½•<code>Info</code> çº§åˆ«ï¼Œè€Œç”¨æˆ·æ€çš„æ—¥å¿—åˆ™è®¾ç½®ä¸º <code>Debug</code>ã€‚</p></blockquote></li></ul><p><code>openlog()</code> çš„ä½¿ç”¨æ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ²¡æœ‰è°ƒç”¨ï¼Œå®ƒå°†åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ <code>syslog()</code> æ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>ident</code> å°†é»˜è®¤ä¸º <code>NULL</code>ã€‚</p><hr><h3 id="option-ç±»å‹"><a href="#option-ç±»å‹" class="headerlink" title="option ç±»å‹"></a>option ç±»å‹</h3><ul><li><code>LOG_CONS</code>ï¼šå¦‚æœå‘é€åˆ°<code>system logger</code>æ—¶å‡ºç°é”™è¯¯ï¼Œåˆ™ç›´æ¥å†™å…¥ç³»ç»Ÿæ§åˆ¶å° <code>console</code>ã€‚</li><li><code>LOG_NDELAY</code>ï¼šç«‹å³æ‰“å¼€è¿æ¥(é€šå¸¸ï¼Œåœ¨è®°å½•ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶æ‰“å¼€è¿æ¥)ã€‚è¿™å¯èƒ½æ˜¯æœ‰ç”¨çš„ï¼Œä¾‹å¦‚ï¼Œå¦‚æœåç»­çš„ <code>chroot(2)</code> å°†ä½¿æ—¥å¿—è®°å½•å·¥å…·å†…éƒ¨ä½¿ç”¨çš„è·¯å¾„åä¸å¯è¾¾ã€‚</li><li><code>LOG_NOWAIT</code>ï¼šä¸è¦ç­‰å¾…åœ¨è®°å½•æ¶ˆæ¯æ—¶å¯èƒ½å·²ç»åˆ›å»ºçš„å­è¿›ç¨‹ã€‚(GNU C åº“ä¸åˆ›å»ºå­è¿›ç¨‹ï¼Œæ‰€ä»¥è¿™ä¸ªé€‰é¡¹å¯¹ Linux æ²¡æœ‰å½±å“ã€‚)</li><li><code>LOG_ODELAY</code>ï¼š<code>LOG_NDELAY</code> çš„é€†å‡½æ•°ï¼›è¿æ¥çš„æ‰“å¼€è¢«å»¶è¿Ÿï¼Œç›´åˆ° <code>syslog()</code> è¢«è°ƒç”¨ã€‚(è¿™æ˜¯é»˜è®¤å€¼ï¼Œä¸éœ€è¦æŒ‡å®šã€‚)</li><li><code>LOG_PERROR</code>ï¼šå°†æ¶ˆæ¯è®°å½•åˆ° <code>stderr</code>ã€‚(POSIX.1-2001 æˆ– POSIX.1-2008 ä¸­æ²¡æœ‰ã€‚)</li><li><code>LOG_PID</code>ï¼šåœ¨æ¯æ¡æ¶ˆæ¯ä¸­åŒ…å«å‘¼å«è€…çš„ PIDã€‚</li></ul><h3 id="facility-ç±»å‹"><a href="#facility-ç±»å‹" class="headerlink" title="facility ç±»å‹"></a>facility ç±»å‹</h3><ul><li><code>LOG_AUTH</code>: security&#x2F;authorization messages</li><li><code>LOG_AUTHPRIV</code>: security&#x2F;authorization messages (private)</li><li><code>LOG_CRON</code>: clock daemon (cron and at)</li><li><code>LOG_DAEMON</code>: system daemons without separate facility value</li><li><code>LOG_FTP</code>: ftp daemon</li><li><code>LOG_KERN</code>: kernel messages (these canâ€™t be generated from user processes)</li><li><code>LOG_LOCAL0 through LOG_LOCAL7</code>: reserved for local useã€‚è¿™ä¸ªå¯ä»¥ç”¨æˆ·è‡ªå®šä¹‰ã€‚</li><li><code>LOG_LPR</code>: line printer subsystem</li><li><code>LOG_MAIL</code>: mail subsystem</li><li><code>LOG_NEWS</code>: USENET news subsystem</li><li><code>LOG_SYSLOG</code>: messages generated internally by syslogd(8)</li><li><code>LOG_USER (default)</code>: generic user-level messages</li><li><code>LOG_UUCP</code>: UUCP subsystem</li></ul><h3 id="level-æ—¥å¿—çº§åˆ«"><a href="#level-æ—¥å¿—çº§åˆ«" class="headerlink" title="level æ—¥å¿—çº§åˆ«"></a>level æ—¥å¿—çº§åˆ«</h3><ul><li><code>LOG_EMERG</code>: system is unusable</li><li><code>LOG_ALERT</code>: action must be taken immediately</li><li><code>LOG_CRIT</code>: critical conditions</li><li><code>LOG_ERR</code>: error conditions</li><li><code>LOG_WARNING</code>: warning conditions</li><li><code>LOG_NOTICE</code>: normal, but significant, condition</li><li><code>LOG_INFO</code>: informational message</li><li><code>LOG_DEBUG</code>: debug-level message</li></ul><hr><h3 id="syslog-1"><a href="#syslog-1" class="headerlink" title="syslog"></a>syslog</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">syslog</span><span class="params">(<span class="type">int</span> priority, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br></pre></td></tr></table></figure><ul><li><p><code>priority</code> å‚æ•°ç”±ä¸€ä¸ª <code>facility</code> å€¼å’Œä¸€ä¸ª <code>level</code> å€¼ä¸€èµ·ç»„æˆã€‚</p><blockquote><p>å¦‚æœä¼˜å…ˆçº§ä¸­æ²¡æœ‰ç”¨åˆ° <code>facility</code>ï¼Œåˆ™ä½¿ç”¨ <code>openlog()</code> è®¾ç½®çš„é»˜è®¤å€¼ï¼Œæˆ–è€…ï¼Œå¦‚æœä¹‹å‰æ²¡æœ‰ <code>openlog()</code> è°ƒç”¨ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ <code>LOG_USER</code>ã€‚</p></blockquote></li><li><p><code>format</code>ï¼šä¸€ä¸ªæ ¼å¼å­—ç¬¦ä¸²ï¼Œåé¢è·Ÿè¯¥æ ¼å¼æ‰€éœ€çš„ä»»ä½•å‚æ•°ï¼Œé™¤äº† <code>%m</code> å°†è¢«é”™è¯¯æ¶ˆæ¯å­—ç¬¦ä¸² <code>strerror(errno)</code> å–ä»£ã€‚</p><blockquote><p><strong>æ ¼å¼å­—ç¬¦ä¸²ä¸éœ€è¦åŒ…å«ç»“æŸæ¢è¡Œç¬¦</strong>ã€‚</p></blockquote></li></ul><p>æ¯”å¦‚è¾“å‡ºä¸€æ¡ <code>DEBUG</code> çº§åˆ«çš„æ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syslog(LOG_USER|LOG_DEBUG, <span class="string">&quot;hello world\n&quot;</span>);</span><br><span class="line"><span class="comment">// ä¸éœ€è¦ \n</span></span><br><span class="line">syslog(LOG_DEBUG, <span class="string">&quot;hello world, num: %d&quot;</span>, num);</span><br></pre></td></tr></table></figure><h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p><code>syslog</code> é…ç½®æ–‡ä»¶ç”¨äºæ§åˆ¶ <code>syslogd</code> å®ˆæŠ¤è¿›ç¨‹å¦‚ä½•å¤„ç†æ—¥å¿—æ¶ˆæ¯ã€‚è¯¥æ–‡ä»¶é€šå¸¸ä½äº <code>/etc/syslog.conf</code> ä¸­ã€‚</p><p><code>syslog</code> é…ç½®æ–‡ä»¶ç”±ä¸€è¡Œä¸€è¡Œçš„é…ç½®é¡¹ç»„æˆã€‚æ¯ä¸€è¡ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå…³é”®å­—ç»„æˆ + <code>action</code> ç»„æˆã€‚å…³é”®å­—ä¹‹é—´ä½¿ç”¨åˆ†å·<code>;</code>åˆ†å‰²ï¼Œå…³é”®å­—å’Œ <code>action</code> ä¹‹é—´ä½¿ç”¨ç©ºæ ¼<code> </code>åˆ†å‰²ã€‚</p><p><strong>action</strong>ï¼šæŒ‡å®šæ¶ˆæ¯çš„å¤„ç†æ–¹å¼ã€‚å¸¸è§çš„ <code>action</code> åŒ…æ‹¬ï¼š</p><ul><li><code>file</code>ï¼šå°†æ¶ˆæ¯å†™å…¥æ–‡ä»¶ã€‚</li><li><code>remote</code>ï¼šå°†æ¶ˆæ¯å‘é€åˆ°è¿œç¨‹ä¸»æœºã€‚</li><li><code>console</code>ï¼šå°†æ¶ˆæ¯æ˜¾ç¤ºåœ¨æ§åˆ¶å°ã€‚</li><li><code>null</code>ï¼šä¸¢å¼ƒæ¶ˆæ¯ã€‚</li></ul><h3 id="é…ç½®æ–‡ä»¶ç¤ºä¾‹"><a href="#é…ç½®æ–‡ä»¶ç¤ºä¾‹" class="headerlink" title="é…ç½®æ–‡ä»¶ç¤ºä¾‹"></a>é…ç½®æ–‡ä»¶ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># å°†æ‰€æœ‰ info çº§åˆ«å’Œå†…æ ¸ debug çº§åˆ«çš„æ¶ˆæ¯å†™å…¥ `/var/log/messages` æ–‡ä»¶ã€‚</span><br><span class="line">*.info;kern.debug /var/log/messages</span><br><span class="line"></span><br><span class="line"># å°†æ‰€æœ‰å®‰å…¨ç›¸å…³æ¶ˆæ¯å†™å…¥ `/var/log/auth.log` æ–‡ä»¶</span><br><span class="line">auth.* /var/log/auth.log</span><br><span class="line"></span><br><span class="line"># å°†æ‰€æœ‰ä¿¡æ¯ã€è­¦å‘Šå’Œé”™è¯¯çº§åˆ«çš„é‚®ä»¶æ¶ˆæ¯å†™å…¥ `/var/log/apache/access_log` æ–‡ä»¶</span><br><span class="line">mail.info;mail.warn;mail.err /var/log/apache/access_log</span><br><span class="line"></span><br><span class="line"># å°†æ‰€æœ‰é”™è¯¯æ¶ˆæ¯å‘é€åˆ° root ç”¨æˆ·çš„é‚®ç®±</span><br><span class="line">*.err root@localhost</span><br></pre></td></tr></table></figure><p><strong>é…ç½®æ–‡ä»¶æ³¨æ„äº‹é¡¹</strong></p><ul><li><code>syslog</code> é…ç½®æ–‡ä»¶æ˜¯å…¨å±€æ€§çš„ï¼Œå¯¹æ‰€æœ‰ç³»ç»Ÿä¸Šçš„åº”ç”¨ç¨‹åºéƒ½æœ‰æ•ˆã€‚</li><li>å¯ä»¥ä½¿ç”¨ <code>-f</code> é€‰é¡¹æŒ‡å®š <code>syslogd</code> å®ˆæŠ¤è¿›ç¨‹ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚</li></ul><h2 id="syslogd"><a href="#syslogd" class="headerlink" title="syslogd"></a>syslogd</h2><p><code>syslogd</code> å®ˆæŠ¤è¿›ç¨‹å‚æ•°ä»‹ç»ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">-n              Run <span class="keyword">in</span> foreground</span><br><span class="line">                è¿™ä¸ªé€‰é¡¹è®© syslogd åœ¨å‰ç«¯è¿è¡Œï¼Œè€Œä¸æ˜¯åœ¨åå°è¿è¡Œã€‚</span><br><span class="line">                å¦‚æœè¿™ä¸ªé€‰é¡¹è¢«ä½¿ç”¨ï¼Œsyslogd ä¸ä¼š fork æˆåå°è¿›ç¨‹ã€‚</span><br><span class="line">-R HOST[:PORT]  Log to HOST:PORT (default PORT:514)</span><br><span class="line">                è®© syslogd å°†æ—¥å¿—æ¶ˆæ¯å‘é€åˆ°æŒ‡å®šçš„ä¸»æœºå’Œç«¯å£ã€‚é»˜è®¤çš„ç«¯å£æ˜¯ 514ã€‚</span><br><span class="line">-L              Log locally and via network (default is network only <span class="keyword">if</span> -R)</span><br><span class="line">                åŒæ—¶å°†æ—¥å¿—è®°å½•åˆ°æœ¬åœ°å’Œç½‘ç»œä¸Šã€‚æŒ‡å®š -R åé»˜è®¤åªè®°å½•åˆ°ç½‘ç»œ</span><br><span class="line">-O FILE         Log to FILE (default: /var/log/messages, stdout <span class="keyword">if</span> -)</span><br><span class="line">                è®© syslogd å°†æ—¥å¿—æ¶ˆæ¯å†™å…¥åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚é»˜è®¤ /var/log/messagesâœ¨âœ¨</span><br><span class="line">                ä½†å¦‚æœ FILE æ˜¯<span class="string">&quot;-&quot;</span>ï¼Œåˆ™ syslogd ä¼šå°†æ—¥å¿—æ¶ˆæ¯å†™å…¥åˆ°æ ‡å‡†è¾“å‡ºã€‚</span><br><span class="line">-s SIZE         Max size (KB) before rotation (default 200KB, 0=off)</span><br><span class="line">                æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å¤§å°ï¼ˆä»¥ KB ä¸ºå•ä½ï¼‰ï¼Œè¶…è¿‡è¯¥å¤§å°ä¼šæ–°å»ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ã€‚</span><br><span class="line">-b N            N rotated logs to keep (default 1, max 99, 0=purge)</span><br><span class="line">                è¦ä¿ç•™çš„å·²è½®è½¬æ—¥å¿—æ–‡ä»¶çš„æ•°é‡ã€‚</span><br><span class="line">-l N            Log only messages more urgent than prio N (1-8)</span><br><span class="line">                syslogd åªè®°å½•ä¼˜å…ˆçº§é«˜äº N çš„æ—¥å¿—æ¶ˆæ¯ã€‚8 æ˜¯ DEBUG çº§åˆ«</span><br><span class="line">-S              Smaller output</span><br><span class="line">                syslogd ä¼šå‡å° syslogd çš„è¾“å‡ºï¼Œä½¿å¾—æ—¥å¿—æ–‡ä»¶æ›´å°ã€‚</span><br><span class="line">-t              Strip client-generated timestamps</span><br><span class="line">                ç§»é™¤ç”±å®¢æˆ·ç«¯ç”Ÿæˆçš„æ—¥å¿—æ¶ˆæ¯ä¸­çš„æ—¶é—´æˆ³</span><br><span class="line">-f FILE         Use FILE as config (default:/etc/syslog.conf)</span><br><span class="line">                syslogd ä½¿ç”¨æŒ‡å®šçš„æ–‡ä»¶ä½œä¸ºé…ç½®æ–‡ä»¶ã€‚é»˜è®¤æ–‡ä»¶æ˜¯ /etc/syslog.conf</span><br></pre></td></tr></table></figure><p>Output File â¬‡ï¸ï¼ˆå¿…é¡»è¦åŠ å¼•å· <code>&quot;-&quot;</code> æ‰èƒ½åˆ°æ ‡å‡†è¾“å‡ºï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ syslogd -n -l 8 -O <span class="string">&quot;-&quot;</span></span><br><span class="line">Sep  3 00:28:38 panda syslog.info syslogd started: BusyBox v1.30.1</span><br></pre></td></tr></table></figure><p>Smaller Output æ¼”ç¤ºç»“æœï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Sep  2 23:50:01 panda user.debug syslog-test[2438]: hello world</span><br><span class="line">Sep  2 23:50:01 panda user.debug syslog-test[2438]: hello world</span><br><span class="line">Sep  2 23:50:01 panda user.debug syslog-test[2438]: hello 123</span><br><span class="line">Sep  2 23:50:39 panda syslog.info syslogd exiting</span><br><span class="line"><span class="comment"># åŠ ä¸Š -S å â¬‡ï¸</span></span><br><span class="line">Sep  3 00:20:37 syslogd started: BusyBox v1.30.1</span><br><span class="line">Sep  3 00:20:47 syslog-test[2693]: hello world</span><br><span class="line">Sep  3 00:20:47 syslog-test[2693]: hello world</span><br><span class="line">Sep  3 00:20:47 syslog-test[2693]: hello 123</span><br></pre></td></tr></table></figure><h2 id="å°è£…"><a href="#å°è£…" class="headerlink" title="å°è£…"></a>å°è£…</h2><p>ä½¿ç”¨ <code>syslog</code> æ—¶éœ€è¦æŒ‡å®š <code>facility|level</code> æ¯”è¾ƒéº»çƒ¦ï¼Œåœ¨ <a href="https://github.com/sophgo/cvi_mmf_sdk/blob/v4.1.0/middleware/v2/include/cvi_debug.h"><code>middleware/v2/include/cvi_debug.h</code></a> å¯¹ <code>syslog</code> é€šè¿‡å®å‡½æ•°è¿›è¡Œäº†ä¸€å±‚å°è£…â˜ ï¸ï¼Œåœ¨æ—¥å¿—æ¶ˆæ¯çš„åŸºç¡€ä¸Šæ·»åŠ äº†â€œæ–‡ä»¶åã€è¡Œå·ã€å‡½æ•°åâ€ï¼Œæœ¬æ„æ˜¯å¥½çš„ï¼Œä½†æ˜¯åå­—å¤ªé•¿äº†ï¼<code>TRACE</code> å’Œ <code>DBG</code> æ¯«æ— æ„ä¹‰ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CVI_TRACE_LOG(CVI_DBG_INFO, <span class="string">&quot;LT9611_MIPI_Input_Digtal: lt9611 set mipi port = 2\n&quot;</span>);</span><br></pre></td></tr></table></figure><p>ç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>openvswitch</code> çš„å‘½åæ›´åŠ ç®€æ´ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VLOG_DBG(<span class="string">&quot;xxx&quot;</span>);</span><br><span class="line">VLOG_INFO(<span class="string">&quot;XXXX&quot;</span>);</span><br><span class="line">VLOG_ERR(<span class="string">&quot;XXX&quot;</span>);</span><br></pre></td></tr></table></figure><p>å‚ç…§æ­¤æ–¹å¼ï¼ŒåŠ ä¸ª <code>CVI_</code> å‰ç¼€ä¹Ÿæ¯”è¾ƒç®€æ´å•Šï¼<code>CVI_VLOG_ERR(&quot;XXX&quot;);</code></p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://datatracker.ietf.org/doc/html/rfc5424">rfc 5424 â€“ The Syslog Protocol</a></li><li><a href="https://elixir.bootlin.com/musl/latest/source/include/syslog.h#L62">musl-syslog.h</a></li><li><a href="https://elixir.bootlin.com/musl/latest/source/src/misc/syslog.c#L138">musl-syslog.c</a></li><li>[Linux ç³»ç»Ÿç¼–ç¨‹-è¿›ç¨‹é€šä¿¡](.&#x2F;Linux ç³»ç»Ÿç¼–ç¨‹-è¿›ç¨‹é€šä¿¡.md)</li><li><a href="https://github.com/sophgo/cvi_mmf_sdk/blob/v4.1.0/middleware/v2/include/cvi_debug.h"><code>middleware/v2/include/cvi_debug.h</code></a></li></ul><h1 id="ç®€å•å®æ—¥å¿—"><a href="#ç®€å•å®æ—¥å¿—" class="headerlink" title="ç®€å•å®æ—¥å¿—"></a>ç®€å•å®æ—¥å¿—</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_NONE      0  <span class="comment">// æ— æ—¥å¿—è¾“å‡º</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_ERROR     1  <span class="comment">// é”™è¯¯æ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_WARN      2  <span class="comment">// è­¦å‘Šæ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_INFO      3  <span class="comment">// ä¿¡æ¯æ—¥å¿—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL_DEBUG     4  <span class="comment">// è°ƒè¯•æ—¥å¿—</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NONE                 <span class="string">&quot;\e[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED                  <span class="string">&quot;\e[0;31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW               <span class="string">&quot;\e[1;33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE                 <span class="string">&quot;\e[0;34m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è®¾ç½®å½“å‰æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_LEVEL MLOG_LEVEL_DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENAME__ (strrchr(__FILE__, <span class="string">&#x27;/&#x27;</span>) ? strrchr(__FILE__, <span class="string">&#x27;/&#x27;</span>) + 1 : __FILE__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG(level, level_str, fmt, ...)                                               \</span></span><br><span class="line"><span class="meta">    do &#123;                                                                    \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (level &lt;= MLOG_LEVEL) &#123;                                          \</span></span><br><span class="line"><span class="meta">            printf(level_str <span class="string">&quot; [%s:%d %s] &quot;</span> fmt, __FILENAME__, __LINE__, __func__, ##__VA_ARGS__); \</span></span><br><span class="line"><span class="meta">        &#125;                                                                   \</span></span><br><span class="line"><span class="meta">    &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åªå¯¹æ—¥å¿—çº§åˆ«åŠ ä¸Šé¢œè‰² */</span></span><br><span class="line"><span class="comment">// #define MLOG_ERROR(fmt, ...) MLOG(MLOG_LEVEL_ERROR, RED &quot;[ERR]&quot; NONE, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="comment">// #define MLOG_WARN(fmt, ...)  MLOG(MLOG_LEVEL_WARN, YELLOW &quot;[WARN]&quot; NONE, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="comment">// #define MLOG_INFO(fmt, ...)  MLOG(MLOG_LEVEL_INFO, BLUE &quot;[INFO]&quot; NONE, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="comment">// #define MLOG_DEBUG(fmt, ...) MLOG(MLOG_LEVEL_DEBUG, &quot;[DBG]&quot;, fmt, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‰€æœ‰æ—¥å¿—è¡Œéƒ½ä¸Šé¢œè‰² */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_ERROR(fmt, ...) MLOG(MLOG_LEVEL_ERROR, RED <span class="string">&quot;[ERR]&quot;</span>, fmt NONE , ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_WARN(fmt, ...)  MLOG(MLOG_LEVEL_WARN, YELLOW <span class="string">&quot;[WARN]&quot;</span>, fmt NONE, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_INFO(fmt, ...)  MLOG(MLOG_LEVEL_INFO, BLUE <span class="string">&quot;[INFO]&quot;</span>, fmt NONE, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_DEBUG(fmt, ...) MLOG(MLOG_LEVEL_DEBUG, <span class="string">&quot;[DBG]&quot;</span>, fmt, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    MLOG_ERROR(<span class="string">&quot;This is an error message\n&quot;</span>);</span><br><span class="line">    MLOG_WARN(<span class="string">&quot;This is a warning message\n&quot;</span>);</span><br><span class="line">    MLOG_INFO(<span class="string">&quot;This is an info message\n&quot;</span>);</span><br><span class="line">    MLOG_DEBUG(<span class="string">&quot;This is a debug message\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºä»€ä¹ˆä¸‹é¢çš„è¿™ä¸ª <code>&quot;\e[0;31m&quot;</code> èƒ½å†³å®šè¾“å‡ºçš„é¢œè‰²å‘¢ï¼Ÿ<br>è¿™æ®µä»£ç æ˜¯ä½¿ç”¨ ANSI è½¬ä¹‰ç æ¥æ§åˆ¶ç»ˆç«¯æ–‡æœ¬çš„é¢œè‰²å’Œæ ·å¼ã€‚åœ¨ ANSI è½¬ä¹‰ç ä¸­ï¼Œ<code>\e</code>ç”¨äºè¡¨ç¤ºASCIIç ä¸­çš„Escapeå­—ç¬¦ï¼ˆåè¿›åˆ¶ä¸º27ï¼‰ï¼Œå®ƒåœ¨ç»ˆç«¯ä¸­å‘Šè¯‰ç»ˆç«¯æ¨¡æ‹Ÿå™¨å»æ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œï¼Œæ¯”å¦‚æ”¹å˜é¢œè‰²æˆ–è€…æ ·å¼ã€‚åœ¨ ANSI è½¬ä¹‰ç ä¸­ï¼Œæ•°å­—éƒ¨åˆ†å¯¹åº”ä¸åŒçš„é¢œè‰²å’Œæ ·å¼ã€‚ä¾‹å¦‚ï¼Œ<code>0;31</code> è¡¨ç¤ºçº¢è‰²æ–‡å­—ï¼ˆ<code>0</code>æ˜¯æ ·å¼ä»£ç ï¼Œ<code>31</code>æ˜¯é¢œè‰²ä»£ç ï¼‰ã€‚åŒæ ·åœ°ï¼Œ<code>1;33</code> è¡¨ç¤ºäº®é»„è‰²æ–‡å­—ï¼Œ<code>0;34</code> è¡¨ç¤ºè“è‰²æ–‡å­—ã€‚</p><p>æ ·å¼ä»£ç å’Œé¢œè‰²ä»£ç åˆ†åˆ«æ˜¯å•¥ï¼Ÿ</p><p>ChatGPT</p><p>åœ¨ ANSI è½¬ä¹‰ç ä¸­ï¼Œç”¨äºæ§åˆ¶æ–‡æœ¬æ ·å¼å’Œé¢œè‰²çš„ä»£ç åˆ†åˆ«æ˜¯æ ·å¼ç å’Œé¢œè‰²ç ã€‚</p><p>æ ·å¼ç :</p><ul><li><code>0</code>ï¼šé‡ç½®æ‰€æœ‰æ–‡æœ¬å±æ€§ï¼Œæ¢å¤é»˜è®¤çŠ¶æ€ã€‚</li><li><code>1</code>ï¼šç²—ä½“æˆ–è€…é«˜äº®ï¼ˆå–å†³äºç»ˆç«¯çš„å®ç°ï¼‰ã€‚</li><li><code>2</code>ï¼šæš—è‰²ï¼ˆå¹¶éæ‰€æœ‰ç»ˆç«¯éƒ½æ”¯æŒï¼‰ã€‚</li><li><code>3</code>ï¼šæ–œä½“ï¼ˆå¹¶éæ‰€æœ‰ç»ˆç«¯éƒ½æ”¯æŒï¼‰ã€‚</li><li><code>4</code>ï¼šä¸‹åˆ’çº¿ã€‚</li><li><code>5</code>ï¼šé—ªçƒï¼ˆå¹¶éæ‰€æœ‰ç»ˆç«¯éƒ½æ”¯æŒï¼‰ã€‚</li><li><code>7</code>ï¼šåè½¬æ˜¾ç¤ºï¼Œå³å‰æ™¯è‰²å˜èƒŒæ™¯è‰²ï¼ŒèƒŒæ™¯è‰²å˜å‰æ™¯è‰²ã€‚</li><li><code>8</code>ï¼šéšè—ï¼ˆä¸å¯è§ï¼‰ã€‚</li></ul><p>é¢œè‰²ç ï¼ˆå‰æ™¯è‰²ï¼‰ï¼š</p><ul><li><code>30</code>ï¼šé»‘è‰²</li><li><code>31</code>ï¼šçº¢è‰²</li><li><code>32</code>ï¼šç»¿è‰²</li><li><code>33</code>ï¼šé»„è‰²</li><li><code>34</code>ï¼šè“è‰²</li><li><code>35</code>ï¼šæ´‹çº¢è‰²ï¼ˆå“çº¢ï¼‰</li><li><code>36</code>ï¼šé’è‰²</li><li><code>37</code>ï¼šç™½è‰²</li></ul><p>è¿™äº›ä»£ç å¯ä»¥é€šè¿‡ç»„åˆä½¿ç”¨æ¥äº§ç”Ÿä¸åŒçš„æ•ˆæœã€‚ä¾‹å¦‚ï¼Œ<code>&quot;\e[1;33m&quot;</code>è¡¨ç¤ºäº®é»„è‰²æ–‡æœ¬ï¼ˆ<code>1</code>ä»£è¡¨é«˜äº®ï¼Œ<code>33</code>ä»£è¡¨é»„è‰²ï¼‰ï¼›<code>&quot;\e[0;31m&quot;</code>è¡¨ç¤ºæ™®é€šçº¢è‰²æ–‡æœ¬ï¼ˆ<code>0</code>ä»£è¡¨é»˜è®¤æ ·å¼ï¼Œ<code>31</code>ä»£è¡¨çº¢è‰²ï¼‰ã€‚</p><p>è¯·æ³¨æ„ï¼Œå¹¶éæ‰€æœ‰ç»ˆç«¯éƒ½æ”¯æŒæ‰€æœ‰çš„æ ·å¼ç å’Œé¢œè‰²ç ï¼Œæ‰€ä»¥åœ¨ä¸åŒçš„ç»ˆç«¯ä¸­å¯èƒ½ä¼šæœ‰ä¸åŒçš„æ•ˆæœã€‚</p></blockquote><p>æˆ–è€…æ›´ç®€å•ä¸€ç‚¹ï¼Œä¸åŒºåˆ†æ—¥å¿—çº§åˆ«ã€‚å¯ä»¥ç”¨åœ¨ç®€å•åº“çš„ <code>.c</code> æ–‡ä»¶ä¸­ç”¨äºè¾“å‡ºé”™è¯¯ï¼Œè­¦å‘Šç­‰æ—¥å¿—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* LOG MACRO */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NONE   <span class="string">&quot;\e[0m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED    <span class="string">&quot;\e[1;31m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW <span class="string">&quot;\e[1;33m&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE   <span class="string">&quot;\e[0;34m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILENAME__ \</span></span><br><span class="line"><span class="meta">(strrchr(__FILE__, <span class="string">&#x27;/&#x27;</span>) ? strrchr(__FILE__, <span class="string">&#x27;/&#x27;</span>) + 1 : __FILE__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG(level_str, fmt, ...)                                       \</span></span><br><span class="line"><span class="meta">do &#123;                                                            \</span></span><br><span class="line"><span class="meta">printf(level_str <span class="string">&quot; [%s:%d %s] &quot;</span> NONE fmt, __FILENAME__, \</span></span><br><span class="line"><span class="meta">       __LINE__, __func__, ##__VA_ARGS__);              \</span></span><br><span class="line"><span class="meta">&#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_ERROR(fmt, ...) MLOG(RED <span class="string">&quot;[ERR]&quot;</span>, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_WARN(fmt, ...)  MLOG(YELLOW <span class="string">&quot;[WARN]&quot;</span>, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_INFO(fmt, ...)  MLOG(BLUE <span class="string">&quot;[INFO]&quot;</span>, fmt, ##__VA_ARGS__)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MLOG_DEBUG(fmt, ...) MLOG(<span class="string">&quot;[DBG]&quot;</span>, fmt, ##__VA_ARGS__)</span></span><br></pre></td></tr></table></figure><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p><code>printf</code> æœ¬èº«æ˜¯ä¸€ä¸ª<strong>ä¸å¯é‡å…¥å‡½æ•°</strong>ï¼Œä¸èƒ½åœ¨ä¸­æ–­ã€ä¿¡å·å¤„ç†å‡½æ•°ä¸­ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œè¿™é‡Œçš„ <code>mlog</code> åŒæ ·ä¸èƒ½åœ¨è¿™äº›åœ°æ–¹ä½¿ç”¨ã€‚</p><blockquote><p>å› ä¸ºprintfå‡½æ•°å†…éƒ¨è°ƒç”¨äº†mallocå‡½æ•°ï¼Œè€Œmallocä¹‹å‰ä¼šåˆ©ç”¨é™æ€mutexå¯¹å…¶è¿›è¡Œlockã€‚è®¾æƒ³è¿™æ ·ä¸€ç§æƒ…å†µï¼ŒæŸçº¿ç¨‹åœ¨è°ƒç”¨printfï¼ˆå†…éƒ¨æ‰§è¡Œè‡³å¯¹é™æ€mutexåŠ é”æ“ä½œï¼‰æ—¶ä¸­æ–­ï¼Œè€Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­åŒæ ·è°ƒç”¨äº†printfï¼Œåˆ™ä¼šäº§ç”Ÿæ­»é”ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> æ—¥å¿—ç³»ç»Ÿ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux å†…æ ¸-ä¸­æ–­</title>
      <link href="/2023/08/29/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/"/>
      <url>/2023/08/29/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/</url>
      
        <content type="html"><![CDATA[<h2 id="Linux-å†…æ ¸-â€”-ä¸­æ–­"><a href="#Linux-å†…æ ¸-â€”-ä¸­æ–­" class="headerlink" title="Linux å†…æ ¸ â€” ä¸­æ–­"></a>Linux å†…æ ¸ â€” ä¸­æ–­</h2><h2 id="ä»€ä¹ˆæ˜¯ä¸­æ–­"><a href="#ä»€ä¹ˆæ˜¯ä¸­æ–­" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¸­æ–­"></a>ä»€ä¹ˆæ˜¯ä¸­æ–­</h2><blockquote><p>æœ¬èŠ‚æ›´å¤šçš„æ˜¯å¯¹ä¸­æ–­æ¶‰åŠçš„å†…å®¹è¿›è¡Œç®€å•ä»‹ç»ï¼Œåç»­æ‰ä¼šå¯¹å„ä¸ªå†…å®¹è¯¦ç»†ä»‹ç»ã€‚</p></blockquote><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œä¸­æ–­ï¼ˆ<code>Interrupt</code>ï¼‰æ˜¯ä¸€ç§ç¡¬ä»¶æˆ–è½¯ä»¶äº‹ä»¶ï¼Œ<strong>å®ƒå¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„ <code>CPU</code> æŒ‡ä»¤åºåˆ—ï¼Œä½¿ <code>CPU</code> è½¬è€Œå¤„ç†æŸä¸ªç‰¹å®šäº‹ä»¶</strong>ã€‚ä¸­æ–­æœºåˆ¶å…è®¸å¤–éƒ¨è®¾å¤‡æˆ–ç³»ç»Ÿç»„ä»¶é€šè¿‡å‘é€ä¿¡å·æ¥é€šçŸ¥ <code>CPU</code> æŸç§äº‹ä»¶çš„å‘ç”Ÿï¼Œè¿™å¯ä»¥æ˜¯æ¥è‡ªç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚é”®ç›˜ã€é¼ æ ‡ã€ç¡¬ç›˜ç­‰ï¼‰çš„è¾“å…¥ã€å®šæ—¶å™¨åˆ°æœŸã€ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ç­‰ç­‰ã€‚</p><p>ä¸­æ–­çš„ä¸»è¦ç›®çš„æ˜¯æä¾›ä¸€ç§å¼‚æ­¥é€šä¿¡çš„æ–¹å¼ï¼Œè®© CPU èƒ½å¤ŸåŠæ—¶å“åº”å¤–éƒ¨äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æŒç»­åœ°è½®è¯¢æ£€æŸ¥äº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚è¿™æ ·å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿçš„æ•ˆç‡å’Œå“åº”é€Ÿåº¦ã€‚</p><blockquote><p>ä½†<strong>ä¸­æ–­è¿‡å¤šåè€Œä¼šé™ä½ç³»ç»Ÿçš„æ•ˆç‡</strong>ï¼åœ¨ç½‘ç»œæ”¶åŒ…å¤„ç†ä¸­ï¼Œå¾€å¾€é‡‡ç”¨ä¸­æ–­+è½®è¯¢çš„æ–¹å¼ã€‚</p></blockquote><p>åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ<strong>æ¯ç§ç±»å‹çš„ä¸­æ–­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†å·ï¼Œè¢«ç§°ä¸ºä¸­æ–­å·</strong>ã€‚å½“ä¸€ä¸ªä¸­æ–­äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒCPU ä¼šç«‹å³æš‚åœå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œç„¶åè·³è½¬åˆ°ä¸ä¸­æ–­å·ç›¸å…³è”çš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚ä¸­æ–­å¤„ç†ç¨‹åºæ˜¯ä¸€æ®µé¢„å…ˆç¼–å†™å¥½çš„ä»£ç ï¼Œè´Ÿè´£å¤„ç†ç‰¹å®šç±»å‹çš„ä¸­æ–­äº‹ä»¶ã€‚å¤„ç†å®Œä¸­æ–­äº‹ä»¶åï¼ŒCPU ä¼šæ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ç»§ç»­æ‰§è¡Œè¢«ä¸­æ–­çš„æŒ‡ä»¤ã€‚</p><blockquote><ol><li>ä¸­æ–­å·çš„åˆ†é…æ–¹å¼ã€‚</li><li>å¤§é‡ä¸­æ–­è§¦å‘æ—¶ï¼Œä¸Šä¸‹æ–‡ä¿å­˜<code>_raw_spin_unlock_irq</code>ä¸æ¢å¤<code>_raw_spin_unlock_irqrestore</code>å¾€å¾€ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚</li></ol></blockquote><p>Linux å†…æ ¸æœ‰ä¸€ä¸ª<strong>ä¸­æ–­æ§åˆ¶å™¨</strong>ï¼ˆ<code>Interrupt Controller</code>ï¼‰ï¼Œå®ƒç®¡ç†ç€æ‰€æœ‰ä¸­æ–­å¹¶å†³å®šå®ƒä»¬çš„ä¼˜å…ˆçº§å’Œå¤„ç†é¡ºåºã€‚ä¸­æ–­å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š<strong>ç¡¬ä»¶ä¸­æ–­</strong>å’Œ<strong>è½¯ä»¶ä¸­æ–­</strong>ã€‚ç¡¬ä»¶ä¸­æ–­æ˜¯ç”±å¤–éƒ¨è®¾å¤‡å¼•å‘çš„ï¼Œä¾‹å¦‚ï¼Œå½“é”®ç›˜æŒ‰é”®è¢«æŒ‰ä¸‹æ—¶ä¼šè§¦å‘ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ã€‚è½¯ä»¶ä¸­æ–­æ˜¯é€šè¿‡ç‰¹æ®Šçš„æŒ‡ä»¤æ¥è§¦å‘çš„ï¼Œé€šå¸¸ç”¨äºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–ä¸å†…æ ¸è¿›è¡Œé€šä¿¡ã€‚</p><blockquote><ol><li>ä¸­æ–­æœ‰ä¼˜å…ˆçº§ã€‚</li><li>è½¯ä»¶ä¹Ÿå¯ä»¥è§¦å‘ä¸­æ–­ã€‚</li></ol></blockquote><p>æ€»è€Œè¨€ä¹‹ï¼Œä¸­æ–­åœ¨ Linux ç³»ç»Ÿä¸­æ˜¯ä¸€ç§é‡è¦çš„æœºåˆ¶ï¼Œå®ƒå…è®¸å¤–éƒ¨äº‹ä»¶ä»¥å¼‚æ­¥çš„æ–¹å¼é€šçŸ¥ CPUï¼Œä»è€Œä½¿ç³»ç»Ÿèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å“åº”å„ç§äº‹ä»¶ã€‚</p><h3 id="ç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­"><a href="#ç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­" class="headerlink" title="ç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­"></a>ç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­</h3><p>ç¡¬ä¸­æ–­å°±æ˜¯ç”±<strong>å¤–éƒ¨</strong>ç¡¬ä»¶è®¾å¤‡è§¦å‘çš„ï¼Œæœ¬è´¨ä¸Šæ¥è¯´ï¼Œå°±æ˜¯æ”¹å˜æŸä¸ªå¼•è„šçš„ç”µå‹ç”µå¹³ï¼Œæ¯”å¦‚å¼•è„šè¾“å…¥ç”±é«˜ç”µå¹³å˜ä¸ºä½ç”µå¹³ï¼ˆä¸‹é™æ²¿è§¦å‘ï¼‰ï¼Œè¯¥å˜åŒ–ä¼šè¢«å¤„ç†å™¨çš„<strong>ä¸­æ–­æ§åˆ¶å™¨</strong>æ£€æµ‹åˆ°ï¼Œä»è€Œè·³è½¬åˆ°ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œã€‚ä¹Ÿæœ‰ä¸€äº›è®¾å¤‡æ”¯æŒä¸Šå‡æ²¿è§¦å‘ã€æˆ–è€…<strong>ç”µå¹³è§¦å‘</strong>ï¼Œå…·ä½“çš„è§¦å‘æ–¹å¼éœ€è¦å‚è€ƒè®¾å¤‡çš„æŠ€æœ¯è§„æ ¼æˆ–æ–‡æ¡£ã€‚</p><blockquote><ol><li>ä¸­æ–­æ§åˆ¶å™¨çš„åŸç†ã€‚</li><li>ä¸­æ–­å¤„ç†ç¨‹åºå’Œä¸­æ–­å¦‚ä½•å…³è”ï¼Œå¦‚ä½•åˆ‡æ¢åˆ°ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œã€‚</li><li>â€œå¤–éƒ¨â€ï¼šè¿™é‡Œæ‰€è¯´çš„å¤–éƒ¨æ˜¯é’ˆå¯¹ <code>CPU</code> è€Œè¨€çš„ï¼Œé™¤äº†ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„å¤–è®¾ç¡¬ç›˜ã€é”®ç›˜ã€é¼ æ ‡ã€ç½‘ç»œæ¥å£å¡ç­‰ï¼Œ<code>TLB</code>ã€<code>DMA</code> ç­‰æ¨¡å—ä¹Ÿèƒ½å‘èµ·ç¡¬ä»¶ä¸­æ–­ã€‚</li></ol></blockquote><p>æ“ä½œç³»ç»Ÿæ”¶åˆ°äº†ä¸­æ–­è¯·æ±‚ï¼Œä¼šæ‰“æ–­å…¶ä»–è¿›ç¨‹çš„è¿è¡Œï¼Œæ‰€ä»¥<strong>ä¸­æ–­è¯·æ±‚çš„å“åº”ç¨‹åºï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼Œè¦å°½å¯èƒ½å¿«çš„æ‰§è¡Œå®Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹æ­£å¸¸è¿›ç¨‹è¿è¡Œè°ƒåº¦åœ°å½±å“</strong>ã€‚è€Œä¸”ä¸­æ–­å¤„ç†ç¨‹åºå¯èƒ½ä¼šæš‚æ—¶å…³é—­ä¸­æ–­ï¼Œè¿™æ—¶å¦‚æœä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½åœ¨è¿˜æœªæ‰§è¡Œå®Œä¸­æ–­å¤„ç†ç¨‹åºå‰ï¼Œä¼šä¸¢å¤±å½“å‰å…¶ä»–è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚</p><p>Linux ç³»ç»Ÿä¸ºäº†è§£å†³ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œè¿‡é•¿å’Œä¸­æ–­ä¸¢å¤±çš„é—®é¢˜ï¼Œå°†<strong>ä¸­æ–­è¿‡ç¨‹åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µ</strong>ï¼Œåˆ†åˆ«æ˜¯<strong>ã€Œä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨åˆ†ã€</strong>ã€‚</p><ul><li>ä¸ŠåŠéƒ¨ç”¨æ¥<strong>å¿«é€Ÿå¤„ç†ä¸­æ–­</strong>ï¼Œä¸€èˆ¬ä¼šæš‚æ—¶å…³é—­ä¸­æ–­è¯·æ±‚ï¼Œä¸»è¦è´Ÿè´£å¤„ç†è·Ÿç¡¬ä»¶ç´§å¯†ç›¸å…³æˆ–è€…æ—¶é—´æ•æ„Ÿçš„äº‹æƒ…ã€‚</li><li>ä¸‹åŠéƒ¨ç”¨æ¥<strong>å»¶è¿Ÿå¤„ç†</strong>ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œï¼Œä¸€èˆ¬ä»¥<strong>ã€Œå†…æ ¸çº¿ç¨‹ã€</strong>çš„æ–¹å¼è¿è¡Œã€‚</li></ul><blockquote><p>å‚è€ƒè¿™é‡Œçš„ä¾‹å­ï¼š<a href="https://www.xiaolincoding.com/os/1_hardware/soft_interrupt.html#%E4%B8%AD%E6%96%AD%E6%98%AF%E4%BB%80%E4%B9%88">ä»€ä¹ˆæ˜¯è½¯ä¸­æ–­</a></p></blockquote><ul><li><strong>ä¸ŠåŠéƒ¨ç›´æ¥å¤„ç†ç¡¬ä»¶è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ç¡¬ä¸­æ–­</strong>ï¼Œä¸»è¦æ˜¯è´Ÿè´£è€—æ—¶çŸ­çš„å·¥ä½œï¼Œç‰¹ç‚¹æ˜¯å¿«é€Ÿæ‰§è¡Œï¼›</li><li><strong>ä¸‹åŠéƒ¨æ˜¯ç”±å†…æ ¸è§¦å‘ï¼Œä¹Ÿå°±è¯´è½¯ä¸­æ–­</strong>ï¼Œä¸»è¦æ˜¯è´Ÿè´£ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œï¼Œé€šå¸¸éƒ½æ˜¯è€—æ—¶æ¯”è¾ƒé•¿çš„äº‹æƒ…ï¼Œç‰¹ç‚¹æ˜¯å»¶è¿Ÿæ‰§è¡Œï¼›</li></ul><blockquote><p><del>æ³¨æ„è¿™é‡Œå°†ä¸‹åŠéƒ¨è¯´ä¸ºæ˜¯è½¯ä¸­æ–­æ„Ÿè§‰å¹¶ä¸å¤ªå‡†ç¡®ï¼Œåº”è¯¥æ˜¯ <code>tasklet</code></del>ã€‚</p><p>è½¯ä¸­æ–­è¿™ä¸ªæœ¯è¯­å­˜åœ¨ä¸€å®šçš„æ­§ä¹‰ï¼Œè¿™é‡Œä»–æ˜¯ä½œä¸º<strong>å¯å»¶è¿Ÿå‡½æ•°</strong>çš„æ€»ç§°ï¼Œæ—¢åŒ…æ‹¬äº† <code>softirq</code>ï¼Œä¹ŸåŒ…æ‹¬ <code>tasklet</code>ã€‚éœ€è¦æ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­å…¶æ„æ€ã€‚</p></blockquote><p>è¿˜æœ‰ä¸€ä¸ªåŒºåˆ«ï¼Œç¡¬ä¸­æ–­ï¼ˆä¸ŠåŠéƒ¨ï¼‰æ˜¯ä¼šæ‰“æ–­ CPU æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åç«‹å³æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºï¼Œè€Œè½¯ä¸­æ–­ï¼ˆä¸‹åŠéƒ¨ï¼‰æ˜¯ä»¥å†…æ ¸çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸€ä¸ª CPU éƒ½å¯¹åº”ä¸€ä¸ª<strong>è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹</strong>ï¼Œåå­—é€šå¸¸ä¸º<strong>ã€Œ<code>ksoftirqd/CPU</code> ç¼–å·ã€</strong>ï¼Œæ¯”å¦‚ <code>0</code> å· CPU å¯¹åº”çš„è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„åå­—æ˜¯ <code>ksoftirqd/0</code></p><blockquote><ol><li>è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„ä½œç”¨ï¼Œä¸å®ç°</li><li>ä¸­æ–­æ˜¯ä¸ <code>CPU</code> ç»‘å®šçš„ï¼</li></ol></blockquote><p>ä¸è¿‡ï¼Œ<strong>è½¯ä¸­æ–­ä¸åªæ˜¯åŒ…æ‹¬ç¡¬ä»¶è®¾å¤‡ä¸­æ–­å¤„ç†ç¨‹åºçš„ä¸‹åŠéƒ¨ï¼Œä¸€äº›å†…æ ¸è‡ªå®šä¹‰äº‹ä»¶ä¹Ÿå±äºè½¯ä¸­æ–­</strong>ï¼Œæ¯”å¦‚<strong>å†…æ ¸è°ƒåº¦</strong>ç­‰ã€RCU é”ï¼ˆå†…æ ¸é‡Œå¸¸ç”¨çš„ä¸€ç§é”ï¼‰ç­‰ã€‚</p><blockquote><ol><li>ç³»ç»Ÿè°ƒç”¨ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§è½¯ä¸­æ–­å§ï¼Œæ¶‰åŠåˆ°ç‰¹æƒçº§åˆ«çš„åˆ‡æ¢å’Œä¸Šä¸‹æ–‡çš„ä¿å­˜ä¸æ¢å¤ã€‚</li><li>æˆ‘çš„ç†è§£æ˜¯åªè¦æ¶‰åŠåˆ°ä¸Šä¸‹æ–‡çš„ä¿å­˜ä¸æ¢å¤ï¼Œå°±å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§ä¸­æ–­ã€‚</li><li>å†…æ ¸è°ƒåº¦è¿™é‡Œæ˜¯æŒ‡çº¿ç¨‹åˆ‡æ¢çš„è¿‡ç¨‹è¿˜æ˜¯è°ƒåº¦ç³»ç»Ÿæœ¬èº«å‘¢ï¼Ÿ</li></ol></blockquote><h3 id="åŒæ­¥ä¸­æ–­ä¸å¼‚æ­¥ä¸­æ–­"><a href="#åŒæ­¥ä¸­æ–­ä¸å¼‚æ­¥ä¸­æ–­" class="headerlink" title="åŒæ­¥ä¸­æ–­ä¸å¼‚æ­¥ä¸­æ–­"></a>åŒæ­¥ä¸­æ–­ä¸å¼‚æ­¥ä¸­æ–­</h3><p>å°†ä¸­æ–­å¯ä»¥æŒ‰è§¦å‘æºåˆ†ä¸ºç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­ï¼Œå¦ä¸€ç§å«æ³•ä¸º<strong>åŒæ­¥ä¸­æ–­ä¸å¼‚æ­¥ä¸­æ–­</strong>ï¼š</p><ul><li><strong>åŒæ­¥ä¸­æ–­å’Œå¼‚å¸¸</strong>ï¼šè¿™äº›ç”± CPU è‡ªèº«äº§ç”Ÿï¼Œé’ˆå¯¹å½“å‰æ‰§è¡Œçš„ç¨‹åºã€‚å¼‚å¸¸å¯èƒ½å› ç§ç§åŸå› è§¦å‘ï¼šç”±äºè¿è¡Œæ—¶å‘ç”Ÿçš„ç¨‹åºè®¾è®¡é”™è¯¯ï¼ˆå…¸å‹çš„ä¾‹å­æ˜¯é™¤ 0ï¼‰ï¼Œæˆ–ç”±äºå‡ºç°äº†å¼‚å¸¸çš„æƒ…å†µæˆ–æ¡ä»¶ï¼Œè‡´ä½¿å¤„ç†å™¨éœ€è¦â€œå¤–éƒ¨â€çš„å¸®åŠ©æ‰èƒ½å¤„ç†ã€‚<br>  å¼‚å¸¸æƒ…å†µä¸è§å¾—æ˜¯ç”±è¿›ç¨‹ç›´æ¥å¯¼è‡´çš„ï¼Œä½†å¿…é¡»å€ŸåŠ©äºå†…æ ¸æ‰èƒ½ä¿®å¤ã€‚ä¸€ä¸ªå¯èƒ½çš„ä¾‹å­æ˜¯ç¼ºé¡µå¼‚å¸¸ï¼Œåœ¨è¿›ç¨‹è¯•å›¾è®¿é—®è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€é¡µï¼Œè€Œè¯¥é¡µä¸åœ¨ç‰©ç†å†…å­˜ä¸­æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿæ­¤ç±»å¼‚å¸¸ã€‚æ ¹æ®ç¬¬ 4 ç« çš„è®¨è®ºï¼Œå†…æ ¸å¿…é¡»ä¸ CPU äº¤äº’ï¼Œç¡®ä¿å°†é¢„æœŸçš„æ•°æ®å–å…¥ç‰©ç†å†…å­˜ã€‚æ¥ä¸‹æ¥ï¼Œè¿›ç¨‹å¯ä»¥åœ¨å‘ç”Ÿå¼‚å¸¸çš„ä½ç½®æ¢å¤æ‰§è¡Œã€‚ç”±äºå†…æ ¸è‡ªåŠ¨æ¢å¤äº†è¿™ç§æƒ…å†µï¼Œè¿›ç¨‹ç”šè‡³ä¸ä¼šæ³¨æ„åˆ°ç¼ºé¡µå¼‚å¸¸çš„å­˜åœ¨ã€‚</li><li><strong>å¼‚æ­¥ä¸­æ–­</strong>ã€‚è¿™æ˜¯ç»å…¸çš„ä¸­æ–­ç±»å‹ï¼Œç”±å¤–éƒ¨è®¾å¤‡äº§ç”Ÿï¼Œå¯èƒ½å‘ç”Ÿåœ¨ä»»æ„æ—¶é—´ã€‚ä¸åŒäºåŒæ­¥ä¸­æ–­ï¼Œå¼‚æ­¥ä¸­æ–­å¹¶ä¸ä¸ç‰¹å®šè¿›ç¨‹å…³è”ã€‚å®ƒä»¬å¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•æ—¶é—´ï¼Œè€Œä¸ç‰µæ¶‰ç³»ç»Ÿå½“å‰æ‰§è¡Œçš„æ´»åŠ¨ã€‚ç½‘å¡é€šè¿‡å‘å‡ºä¸€ä¸ªç›¸å…³çš„ä¸­æ–­æ¥æŠ¥å‘Šæ–°åˆ†ç»„çš„åˆ°è¾¾ã€‚å› ä¸ºæ•°æ®å¯èƒ½åœ¨ä»»æ„æ—¶åˆ»åˆ°è¾¾ç³»ç»Ÿï¼Œæ‰€ä»¥å½“å‰æ‰§è¡Œçš„å¾ˆå¯èƒ½æ˜¯ä¸æ•°æ®æ— å…³çš„æŸä¸ªè¿›ç¨‹æˆ–å…¶ä»–ä¸œè¥¿ã€‚ä¸ºé¿å…æŸå®³è¯¥è¿›ç¨‹ï¼Œå†…æ ¸å¿…é¡»ç¡®ä¿ä¸­æ–­èƒ½å¤Ÿå°½å¿«å¤„ç†å®Œæ¯•ï¼ˆé€šè¿‡ç¼“å†²æ•°æ®ï¼‰ï¼Œä½¿å¾— CPU æ—¶é—´èƒ½å¤Ÿè¿”è¿˜ç»™å½“å‰è¿›ç¨‹ã€‚è¿™ä¹Ÿæ˜¯å†…æ ¸éœ€è¦å»¶æœŸæ“ä½œæœºåˆ¶çš„åŸå› ã€‚</li></ul><blockquote><p>ä»ä»‹ç»å¯ä»¥çœ‹å‡ºï¼ŒåŒæ­¥ä¸­æ–­å…¶å®å°±æ˜¯è½¯ä»¶ä¸­æ–­ï¼Œå¼‚æ­¥ä¸­æ–­ä¸ºç¡¬ä»¶ä¸­æ–­ï¼Œåªæ˜¯è¯´æ³•ä¸åŒã€‚</p></blockquote><p>ä¸¤ç±»ä¸­æ–­çš„å…±åŒç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœ CPU å½“å‰ä¸å¤„äºæ ¸å¿ƒæ€ï¼Œåˆ™å‘èµ·ä»ç”¨æˆ·æ€åˆ°æ ¸å¿ƒæ€çš„åˆ‡æ¢ã€‚æ¥ä¸‹æ¥ï¼Œåœ¨å†…æ ¸ä¸­æ‰§è¡Œä¸€ä¸ªä¸“é—¨çš„ä¾‹ç¨‹ï¼Œç§°ä¸ºä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆ<code>interrupt service routine</code>ï¼Œç®€ç§° <strong>ISR</strong>ï¼‰æˆ–ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆ<code>interrupt handler</code>ï¼‰ã€‚</p><h3 id="IRQ-ç¼–å·ä¸ä¸­æ–­å·"><a href="#IRQ-ç¼–å·ä¸ä¸­æ–­å·" class="headerlink" title="IRQ ç¼–å·ä¸ä¸­æ–­å·"></a>IRQ ç¼–å·ä¸ä¸­æ–­å·</h3><p>æ¯ä¸ªä¸­æ–­éƒ½æœ‰ä¸€ä¸ªç¼–å·ã€‚å¦‚æœä¸­æ–­å· <code>n</code> åˆ†é…ç»™ä¸€ä¸ªç½‘å¡è€Œ <code>mâ‰  n</code> åˆ†é…ç»™ <code>SCSI</code> æ§åˆ¶å™¨ï¼Œé‚£ä¹ˆå†…æ ¸å³å¯åŒºåˆ†ä¸¤ä¸ªè®¾å¤‡ï¼Œå¹¶åœ¨ä¸­æ–­å‘ç”Ÿæ—¶è°ƒç”¨å¯¹åº”çš„ <code>ISR</code> æ¥æ‰§è¡Œç‰¹å®šäºè®¾å¤‡çš„æ“ä½œã€‚å½“ç„¶ï¼ŒåŒæ ·çš„åŸåˆ™ä¹Ÿé€‚åº”äºå¼‚å¸¸ï¼Œä¸åŒçš„å¼‚å¸¸æŒ‡æ´¾äº†ä¸åŒçš„ç¼–å·ã€‚</p><p>é—æ†¾çš„æ˜¯ï¼Œç”±äºç‰¹åˆ«è®¾è®¡ï¼ˆé€šå¸¸æ˜¯å†å²ä¸Šçš„ï¼‰çš„â€œç‰¹æ€§â€ï¼ˆ<code>IA-32</code> ä½“ç³»ç»“æ„å°±æ˜¯ä¸€ä¸ªæ°å½“çš„ç‰¹ä¾‹ï¼‰ï¼Œæƒ…å†µå¹¶ä¸æ€»æ˜¯åƒæè¿°çš„é‚£æ ·ç®€å•ã€‚å› ä¸º<strong>åªæœ‰å¾ˆå°‘çš„ç¼–å·å¯ç”¨äºç¡¬ä»¶ä¸­æ–­ï¼Œæ‰€ä»¥å¿…é¡»ç”±å‡ ä¸ªè®¾å¤‡å…±äº«ä¸€ä¸ªç¼–å·</strong>ã€‚åœ¨ <code>IA-32</code> å¤„ç†å™¨ä¸Šï¼Œç¡¬ä»¶ä¸­æ–­çš„æœ€å¤§æ•°ç›®é€šå¸¸æ˜¯ 15ï¼Œè¿™ä¸ªå€¼å¯ä¸æ€ä¹ˆå¤§ï¼Œè¿˜æœ‰è€ƒè™‘åˆ°æœ‰äº›ä¸­æ–­ç¼–å·å·²ç»æ°¸ä¹…æ€§åœ°åˆ†é…ç»™äº†æ ‡å‡†çš„ç³»ç»Ÿç»„ä»¶ï¼ˆé”®ç›˜ã€å®šæ—¶å™¨ï¼Œç­‰ç­‰ï¼‰ï¼Œå› è€Œé™åˆ¶äº†å¯ç”¨äºå…¶ä»–å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­ç¼–å·æ•°ç›®ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º<strong>ä¸­æ–­å…±äº«</strong>ï¼ˆ<code>interrupt sharing</code>ï¼‰ã€‚ä½†å¿…é¡»ç¡¬ä»¶å’Œå†…æ ¸åŒæ—¶æ”¯æŒæ‰èƒ½ä½¿ç”¨è¯¥æŠ€æœ¯ï¼Œå› ä¸ºå¿…é¡»è¦è¯†åˆ«å‡ºä¸­æ–­æ¥æºäºå“ªä¸ªè®¾å¤‡ã€‚</p><blockquote><p>å¾ˆè‡ªç„¶ï¼Œç²¾å·§è®¾è®¡çš„æ€»çº¿ç³»ç»Ÿæ— éœ€è¯¥æ–¹æ¡ˆã€‚è¿™ç§ç³»ç»Ÿä¸ºç¡¬ä»¶è®¾å¤‡æä¾›äº†å¾ˆå¤šä¸­æ–­ï¼Œæ ¹æœ¬ä¸éœ€è¦å…±äº«ã€‚</p></blockquote><p>ä¸­æ–­ä¸èƒ½ç”±å¤„ç†å™¨å¤–éƒ¨çš„å¤–è®¾ç›´æ¥äº§ç”Ÿï¼Œè€Œå¿…é¡»å€ŸåŠ©äºä¸€ä¸ªç§°ä¸º<strong>ä¸­æ–­æ§åˆ¶å™¨</strong> (<code>interrupt controller</code>) çš„æ ‡å‡†ç»„ä»¶æ¥<strong>è¯·æ±‚</strong>ï¼Œè¯¥ç»„ä»¶å­˜åœ¨äºæ¯ä¸ªç³»ç»Ÿä¸­ã€‚</p><p>å¤–éƒ¨è®¾å¤‡ï¼ˆæˆ–å…¶æ§½ä½ï¼‰ï¼Œä¼šæœ‰ç”µè·¯è¿æ¥åˆ°ç”¨äºå‘ä¸­æ–­æ§åˆ¶å™¨å‘é€ä¸­æ–­è¯·æ±‚çš„ç»„ä»¶ã€‚æ§åˆ¶å™¨åœ¨æ‰§è¡Œäº†å„ç§ç”µå·¥ä»»åŠ¡ï¼ˆæˆ‘ä»¬å¯¹æ­¤æ²¡æœ‰æ›´å¤šå…´è¶£ï¼‰ä¹‹åï¼Œ<strong>å°†ä¸­æ–­è¯·æ±‚è½¬å‘åˆ° CPU çš„ä¸­æ–­è¾“å…¥</strong>ã€‚å› ä¸ºå¤–éƒ¨è®¾å¤‡ä¸èƒ½ç›´æ¥å‘å‡ºä¸­æ–­ï¼Œè€Œå¿…é¡»é€šè¿‡ä¸Šè¿°ç»„ä»¶è¯·æ±‚ä¸­æ–­ï¼Œæ‰€ä»¥è¿™ç§è¯·æ±‚æ›´æ­£ç¡®çš„å«æ³•æ˜¯<strong>IRQ</strong>ï¼Œæˆ–<strong>ä¸­æ–­è¯·æ±‚ï¼ˆinterrupt requestï¼‰</strong>ã€‚å› ä¸ºå°±è½¯ä»¶è€Œè¨€ï¼ŒIRQ å’Œä¸­æ–­ä¹‹é—´çš„å·®åˆ«ä¸æ˜¯é‚£ä¹ˆå¤§ï¼Œè¿™ä¸¤ä¸ªæœ¯è¯­é€šå¸¸å¯æ›¿æ¢ä½¿ç”¨ã€‚</p><p>å¯¹å¤§å¤šæ•° <code>CPU</code> æ¥è¯´ï¼Œéƒ½åªæ˜¯ä»å¯ç”¨äºå¤„ç†ç¡¬ä»¶ä¸­æ–­çš„æ•´ä¸ªä¸­æ–­å·èŒƒå›´æŠ½å–ä¸€å°éƒ¨åˆ†ä½¿ç”¨ã€‚æŠ½å–å‡ºçš„èŒƒå›´é€šå¸¸ä½äºæ‰€æœ‰ä¸­æ–­å·åºåˆ—çš„ä¸­éƒ¨ï¼Œä¾‹å¦‚ï¼Œ<code>IA-32 CPU</code> æ€»å…±æä¾›äº† 16 ä¸ªä¸­æ–­å·ï¼Œä» 32 åˆ° 47ã€‚</p><p>å¦‚æœè¯»è€…æ›¾ç»åœ¨ IA-32 ç³»ç»Ÿä¸Šé…ç½®è¿‡ I&#x2F;O æ‰©å±•å¡ï¼Œæˆ–ç ”ç©¶è¿‡ <code>/proc/interrupts</code> çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±ä¼šäº†è§£åˆ°ï¼Œæ‰©å±•å¡çš„ <code>IRQ</code> ç¼–å·ä» 0 å¼€å§‹ï¼Œåˆ° 15 ç»“æŸï¼Œå½“ç„¶ï¼Œå‰ææ˜¯ä½¿ç”¨äº†å…¸å‹çš„ä¸­æ–­æ§åˆ¶å™¨ <code>8256A</code>ã€‚è¿™æ„å‘³ç€è¿™é‡ŒåŒæ ·æœ‰ 16 ä¸ªä¸åŒçš„é€‰é¡¹ï¼Œä½†æ•°å€¼ä¸åŒã€‚ä¸­<strong>æ–­æ§åˆ¶å™¨é™¤äº†è´Ÿè´£ <code>IRQ</code> ä¿¡å·çš„ç”µå·¥å¤„ç†ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ <code>IRQ</code> ç¼–å·å’Œä¸­æ–­å·è¿›è¡Œä¸€ä¸ªâ€œè½¬æ¢â€</strong>ã€‚åœ¨ IA-32 ç³»ç»Ÿä¸Šï¼ŒåŠ  32 å³å¯ã€‚å¦‚æœè®¾å¤‡å‘å‡º <code>IRQ</code> 9ï¼Œ<code>CPU</code> å°†äº§ç”Ÿä¸­æ–­ 41ï¼Œåœ¨å®‰è£…ä¸­æ–­å¤„ç†ç¨‹åºæ—¶å¿…é¡»è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚å…¶ä»–ä½“ç³»ç»“æ„åœ¨ä¸­æ–­å·å’Œ <code>IRQ</code> ç¼–å·ä¹‹é—´é‡‡ç”¨å…¶ä»–æ˜ å°„æ–¹å¼ï¼Œè¿™é‡Œä¸ä¼šè¯¦ç»†é˜è¿°ã€‚</p><blockquote><p>æ³¨æ„ä¸Šé¢è¿™ä¸ªä¾‹å­æ¥ç†è§£ <code>IRQ</code> ç¼–å·ä¸ä¸­æ–­å·çš„åŒºåˆ«ï¼<code>IRQ</code> <strong>å·ä¸»è¦ç”¨äºç¡¬ä»¶ä¸­æ–­çš„æ ‡è¯†ï¼Œè€Œè½¯ä»¶ä¸­æ–­åˆ™ä½¿ç”¨å…¶ä»–æœºåˆ¶æ¥è¿›è¡Œæ ‡è¯†å’Œå¤„ç†</strong>ã€‚</p></blockquote><h3 id="ä¸­æ–­å¤„ç†ç¨‹åº"><a href="#ä¸­æ–­å¤„ç†ç¨‹åº" class="headerlink" title="ä¸­æ–­å¤„ç†ç¨‹åº"></a>ä¸­æ–­å¤„ç†ç¨‹åº</h3><p>åœ¨ <code>CPU</code> å¾—çŸ¥å‘ç”Ÿä¸­æ–­åï¼Œå®ƒå°†è¿›ä¸€æ­¥çš„å¤„ç†å§”æ‰˜ç»™ä¸€ä¸ªè½¯ä»¶ä¾‹ç¨‹ï¼Œè¯¥ä¾‹ç¨‹å¯èƒ½ä¼šä¿®å¤æ•…éšœã€æä¾›ä¸“é—¨çš„å¤„ç†æˆ–å°†å¤–éƒ¨äº‹ä»¶é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ã€‚ç”±äºæ¯ä¸ªä¸­æ–­å’Œå¼‚å¸¸éƒ½æœ‰å”¯ä¸€çš„ç¼–å·ï¼Œå†…æ ¸ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é¡¹æ˜¯æŒ‡å‘å¤„ç†ç¨‹åºå‡½æ•°çš„æŒ‡é’ˆã€‚ç›¸å…³çš„ä¸­æ–­å·æ ¹æ®æ•°ç»„é¡¹åœ¨æ•°ç»„ä¸­çš„ä½ç½®åˆ¤æ–­ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><p><img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230829210639960.png" alt="image-20230829210639960"></p><ol><li><p><strong>è¿›å…¥å’Œé€€å‡ºä»»åŠ¡</strong>ï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸­æ–­å¤„ç†åˆ’åˆ†ä¸º 3 éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œå¿…é¡»å»ºç«‹ä¸€ä¸ªé€‚å½“çš„ç¯å¢ƒï¼Œä½¿å¾—å¤„ç†ç¨‹åºå‡½æ•°èƒ½å¤Ÿåœ¨å…¶ä¸­æ‰§è¡Œï¼Œæ¥ä¸‹æ¥è°ƒç”¨å¤„ç†ç¨‹åºè‡ªèº«ï¼Œæœ€åå°†ç³»ç»Ÿå¤åŸï¼ˆåœ¨å½“å‰ç¨‹åºçœ‹æ¥ï¼‰åˆ°ä¸­æ–­ä¹‹å‰çš„çŠ¶æ€ã€‚è°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åºå‰åçš„ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ç§°ä¸º<strong>è¿›å…¥è·¯å¾„</strong>ï¼ˆå·¦è¾¹æ–¹æ¡†ï¼‰å’Œ<strong>é€€å‡ºè·¯å¾„</strong>ï¼ˆå³è¾¹æ–¹æ¡†ï¼‰ã€‚</p><p> <img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230829211951196.png" alt="image-20230829211951196"></p><p> è¿›å…¥å’Œé€€å‡ºä»»åŠ¡è¿˜è´Ÿè´£ç¡®ä¿å¤„ç†å™¨ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ã€‚è¿›å…¥è·¯å¾„çš„ä¸€ä¸ªå…³é”®ä»»åŠ¡æ˜¯ï¼Œä»ç”¨æˆ·æ€æ ˆåˆ‡æ¢åˆ°æ ¸å¿ƒæ€æ ˆã€‚ä½†æ˜¯ï¼Œåªæœ‰è¿™ä¸€ç‚¹è¿˜ä¸å¤Ÿã€‚å› ä¸ºå†…æ ¸è¿˜è¦ä½¿ç”¨ CPU èµ„æºæ‰§è¡Œå…¶ä»£ç ï¼Œ<strong>è¿›å…¥è·¯å¾„å¿…é¡»ä¿å­˜ç”¨æˆ·åº”ç”¨ç¨‹åºå½“å‰çš„å¯„å­˜å™¨çŠ¶æ€</strong>ï¼Œä»¥ä¾¿åœ¨ä¸­æ–­æ´»åŠ¨ç»“æŸåæ¢å¤ã€‚è¿™ä¸è°ƒåº¦æœŸé—´ç”¨äºä¸Šä¸‹æ–‡åˆ‡æ¢çš„æœºåˆ¶æ˜¯ç›¸åŒçš„ã€‚</p><blockquote><p>åœ¨ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ—¶ï¼Œå·²ç»ä¿å­˜äº†ä¸€éƒ¨åˆ†å†…æ ¸ä¼šç”¨åˆ°çš„å¯„å­˜å™¨çš„çŠ¶æ€ã€‚ä½†å†…æ ¸æ²¡ç”¨åˆ°çš„ï¼ˆæ¯”å¦‚æµ®ç‚¹æ•°å¯„å­˜å™¨ï¼‰ï¼Œå¹¶ä¸ä¿å­˜ã€‚åœ¨è¿›å…¥ä¸­æ–­å¤„ç†ç¨‹åºå‰ï¼Œéœ€è¦ä¿å­˜è¿™éƒ¨åˆ†å¯„å­˜å™¨çŠ¶æ€ã€‚</p><p>ä¸­æ–­åˆ°è¾¾æ—¶ï¼Œå¤„ç†å™¨å¯èƒ½æ­£å¤„äºå†…æ ¸æ€ï¼Œå› è€Œæ— éœ€ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ç­‰ï¼Œæ€»ä¹‹ï¼Œè¿›å…¥è·¯å¾„ä¹Ÿä¼šè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ã€‚</p></blockquote></li><li><p><strong>ä¸­æ–­å¤„ç†ç¨‹åº</strong>ï¼šä¸­æ–­å¤„ç†ç¨‹åºå¯èƒ½ä¼šé‡åˆ°å›°éš¾ï¼Œç‰¹åˆ«æ˜¯ï¼Œåœ¨å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œå‘ç”Ÿäº†å…¶ä»–ä¸­æ–­ã€‚å°½ç®¡å¯ä»¥é€šè¿‡åœ¨å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´ç¦ç”¨ä¸­æ–­æ¥é˜²æ­¢ï¼Œä½†è¿™ä¼šå¼•èµ·å…¶ä»–é—®é¢˜ï¼Œå¦‚é—æ¼é‡è¦çš„ä¸­æ–­ã€‚<strong>å±è”½</strong>ï¼ˆMaskingï¼Œè¿™ä¸ªæœ¯è¯­ç”¨äºè¡¨ç¤ºé€‰æ‹©æ€§åœ°ç¦ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä¸­æ–­ï¼‰å› è€Œ<strong>åªèƒ½çŸ­æ—¶é—´ä½¿ç”¨</strong>ã€‚</p><p>å› æ­¤ ISR å¿…é¡»æ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªè¦æ±‚ã€‚</p><ol><li>å®ç°ï¼ˆç‰¹åˆ«æ˜¯åœ¨ç¦ç”¨å…¶ä»–ä¸­æ–­æ—¶ï¼‰å¿…é¡»åŒ…å«å°½å¯èƒ½å°‘çš„ä»£ç ï¼Œä»¥æ”¯æŒå¿«é€Ÿå¤„ç†ã€‚</li><li>å¯ä»¥åœ¨å…¶ä»– ISR æ‰§è¡ŒæœŸé—´è°ƒç”¨çš„ä¸­æ–­å¤„ç†ç¨‹åºä¾‹ç¨‹ï¼Œä¸èƒ½å½¼æ­¤å¹²æ‰°ã€‚</li></ol><p>å°½ç®¡åä¸€ä¸ªè¦æ±‚å¯ä»¥é€šè¿‡é«˜è¶…çš„ç¼–ç¨‹å’Œç²¾å·§çš„ ISR è®¾è®¡æ¥æ»¡è¶³ï¼Œç„¶è€Œå‰ä¸€ä¸ªè¦æ±‚æ›´éš¾æ»¡è¶³ã€‚æ ¹æ®å…·ä½“çš„ä¸­æ–­ï¼Œå¿…é¡»è¿è¡ŒæŸä¸ªç¨‹åºï¼Œæ¥æ»¡è¶³ä¸­æ–­å¤„ç†çš„æœ€ä½è¦æ±‚ã€‚å› è€Œä»£ç é•¿åº¦æ— æ³•ä»»æ„ç¼©å‡ã€‚</p><p>å†…æ ¸å¦‚ä½•è§£å†³è¿™ç§ä¸¤éš¾é—®é¢˜å‘¢ï¼Ÿå¹¶é ISR çš„æ¯ä¸ªéƒ¨åˆ†éƒ½åŒç­‰é‡è¦ã€‚é€šå¸¸ï¼Œæ¯ä¸ªå¤„ç†ç¨‹åºä¾‹ç¨‹éƒ½å¯ä»¥åˆ’åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼Œå…·æœ‰ä¸åŒçš„æ„ä¹‰ã€‚</p><ol><li><strong>å…³é”®æ“ä½œå¿…é¡»åœ¨ä¸­æ–­å‘ç”Ÿåç«‹å³æ‰§è¡Œ</strong>ã€‚å¦åˆ™ï¼Œæ— æ³•ç»´æŒç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œæˆ–è®¡ç®—æœºçš„æ­£ç¡®è¿ä½œã€‚åœ¨æ‰§è¡Œæ­¤ç±»æ“ä½œæœŸé—´ï¼Œ<strong>å¿…é¡»ç¦ç”¨å…¶ä»–ä¸­æ–­</strong>ã€‚</li><li>éå…³é”®æ“ä½œä¹Ÿåº”è¯¥å°½å¿«æ‰§è¡Œï¼Œä½†<strong>å…è®¸å¯ç”¨ä¸­æ–­</strong>ï¼ˆå› è€Œå¯èƒ½è¢«å…¶ä»–ç³»ç»Ÿäº‹ä»¶ä¸­æ–­ï¼‰ã€‚</li><li><strong>å¯å»¶æœŸæ“ä½œä¸æ˜¯ç‰¹åˆ«é‡è¦</strong>ï¼Œä¸å¿…åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­å®ç°ã€‚å†…æ ¸å¯ä»¥å»¶è¿Ÿè¿™äº›æ“ä½œï¼Œåœ¨æ—¶é—´å……è£•æ—¶è¿›è¡Œã€‚<strong>å†…æ ¸æä¾›äº† <code>tasklet</code>ï¼Œç”¨äºåœ¨ç¨åæ‰§è¡Œå¯å»¶æœŸæ“ä½œ</strong>ã€‚</li></ol></li></ol><blockquote><ol><li>è¿™é‡Œè¿›ä¸€æ­¥è¯´æ˜äº†ä¸­æ–­çš„ä¸ŠåŠéƒ¨ã€ä¸‹åŠéƒ¨ã€‚ä½†ä¸å‰é¢æœ‰ç‚¹çŸ›ç›¾äº†ï¼Œå‰é¢è¯´çš„ä¸‹åŠéƒ¨å°±æ˜¯è½¯ä¸­æ–­ï¼Œè¿™é‡Œè¯´çš„ <code>tasklet</code>ï¼Œåè€…å¹¶ä¸ç­‰åŒä¸è½¯ä¸­æ–­ã€‚</li><li>å…³äº <code>tasklet</code>ï¼Œå…ˆç®€å•ç†è§£ä¸ºä¸€ç§â€œå†…æ ¸çº¿ç¨‹â€ã€‚åœ¨ç¡¬ä¸­æ–­çš„å¤„ç†å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªâ€œçº¿ç¨‹ <code>tasklet</code>â€å»æ‰§è¡Œè¾ƒå¤æ‚çš„å¤„ç†ä»£ç ï¼Œå®Œæˆçº¿ç¨‹åˆ›å»ºåï¼Œä¸­æ–­å¤„ç†ç¨‹åºå°±å¯ä»¥é€€å‡ºï¼Œè¿›è€Œæ¢å¤åŸç³»ç»Ÿçš„è¿›ç¨‹å¤„ç†ã€‚è€Œæˆ‘ä»¬åˆ›å»ºçš„ â€œçº¿ç¨‹<code>tasklet</code>â€ åˆ™è¿›å…¥å†…æ ¸çš„è°ƒåº¦ç³»ç»Ÿï¼Œå°±åƒæ™®é€šçš„çº¿ç¨‹é‚£æ ·ï¼Œç”±å†…æ ¸è°ƒåº¦ç³»ç»Ÿæ¥å®‰æ’æ—¶é—´ç‰‡è¿›è¡Œå¤„ç†ã€‚ï¼ˆä»…ä»…æ˜¯è¿™æ ·çŒœæµ‹ï¼Œå…·ä½“æƒ…å†µçœ‹ä¸‹é¢ï¼‰ã€‚</li></ol></blockquote><h3 id="å¤šæ ¸ç³»ç»Ÿä¸­æ–­å¤„ç†"><a href="#å¤šæ ¸ç³»ç»Ÿä¸­æ–­å¤„ç†" class="headerlink" title="å¤šæ ¸ç³»ç»Ÿä¸­æ–­å¤„ç†"></a>å¤šæ ¸ç³»ç»Ÿä¸­æ–­å¤„ç†</h3><p>ç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­äº¤ç»™å“ªä¸€ä¸ªæ ¸è¿›è¡Œå¤„ç†çš„é—®é¢˜ï¼</p><p>todoâ€¦</p><h3 id="ä¸­æ–­ç»Ÿè®¡ä¿¡æ¯"><a href="#ä¸­æ–­ç»Ÿè®¡ä¿¡æ¯" class="headerlink" title="ä¸­æ–­ç»Ÿè®¡ä¿¡æ¯"></a>ä¸­æ–­ç»Ÿè®¡ä¿¡æ¯</h3><p>åœ¨ <code>/proc</code> ç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«è®°å½•äº†ç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­çš„æ¬¡æ•°ï¼š<code>/proc/interrupts</code>ã€<code>/proc/softirqs</code>ã€‚åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šï¼Œä¼šæ˜¾ç¤ºå‡ºæ¯ä¸€ä¸ªæ ¸å¤„ç†çš„å¯¹åº”ä¸­æ–­çš„æ•°é‡ï¼Œè¿™é‡Œåªæœ‰å•æ ¸ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@cvitek]~<span class="comment"># cat /proc/softirqs</span></span><br><span class="line">                    CPU0</span><br><span class="line">          HI:          0</span><br><span class="line">       TIMER:      37049</span><br><span class="line">      NET_TX:       1398</span><br><span class="line">      NET_RX:       2344</span><br><span class="line">       BLOCK:        139</span><br><span class="line">    IRQ_POLL:          0</span><br><span class="line">     TASKLET:         19</span><br><span class="line">       SCHED:          0</span><br><span class="line">     HRTIMER:          0</span><br><span class="line">         RCU:      11288</span><br></pre></td></tr></table></figure><p>è½¯ä¸­æ–­çš„æ•°é‡æ˜¯å†…æ ¸ä»£ç ä¸­å›ºå®šçš„ï¼Œè€Œç¡¬ä¸­æ–­åˆ™ä¸å¤–è®¾æ•°é‡æœ‰å…³ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@cvitek]~<span class="comment"># cat /proc/interrupts</span></span><br><span class="line">           CPU0</span><br><span class="line">  2:          0  T-Head PLIC  76  cvi-tpu-tdma</span><br><span class="line">  5:      61141  RISC-V INTC   5  riscv-timer</span><br><span class="line"> 11:          0  T-Head PLIC  29  dw_dmac</span><br><span class="line"> 16:         60  T-Head PLIC  44  ttyS0</span><br><span class="line"> 21:          0  T-Head PLIC  49  4000000.i2c</span><br><span class="line"> 22:          0  T-Head PLIC  51  4020000.i2c</span><br><span class="line"> 23:          0  T-Head PLIC  52  4030000.i2c</span><br><span class="line"> 24:          0  T-Head PLIC  53  4040000.i2c</span><br><span class="line"> 25:       1443  T-Head PLIC  31  eth0</span><br><span class="line"> 26:       4296  T-Head PLIC  34  mmc0</span><br><span class="line"> 27:          0  T-Head PLIC  36  mmc1</span><br><span class="line"> 28:          0  T-Head PLIC  40  4100000.i2s</span><br><span class="line"> 29:          0  T-Head PLIC  43  4130000.i2s</span><br><span class="line"> 30:          0  T-Head PLIC  26  cif-irq0</span><br><span class="line"> 31:          0  T-Head PLIC  27  cif-irq1</span><br><span class="line"> 32:          0  T-Head PLIC  24  a000000.vi</span><br><span class="line"> 33:          0  T-Head PLIC  25  CVI_VIP_SCL</span><br><span class="line"> 34:          3  T-Head PLIC  97  a0a0000.ive</span><br><span class="line"> 35:          0  T-Head PLIC  28  CVI_VIP_DWA</span><br><span class="line"> 36:          0  T-Head PLIC  22  h265</span><br><span class="line"> 37:          0  T-Head PLIC  21  h264</span><br><span class="line"> 39:          0  T-Head PLIC  20  JPU_CODEC_IRQ</span><br><span class="line"> 40:          1  T-Head PLIC 101  mailbox</span><br><span class="line"> 49:          0  gpio-dwapb  13  cd-gpio-irq</span><br></pre></td></tr></table></figure><h2 id="ç¡¬ä¸­æ–­"><a href="#ç¡¬ä¸­æ–­" class="headerlink" title="ç¡¬ä¸­æ–­"></a>ç¡¬ä¸­æ–­</h2><blockquote><p>ä¸»è¦å…³æ³¨ï¼š</p><ol><li>æ€ä¹ˆä¸ºæŸä¸ªå¤–è®¾æ³¨å†Œä¸­æ–­ï¼ŒåŒ…æ‹¬ä¸­æ–­å·çš„åˆ†é…ï¼Œä¸­æ–­å¤„ç†ç¨‹åºçš„æ³¨å†Œã€‚</li><li>è¿™ä¸ªè¿‡ç¨‹å°±ä¼šæ¶‰åŠåˆ°ä¸­æ–­çš„å®ç°åŸç†ï¼Œä¸­æ–­çš„ä¼˜å…ˆçº§ï¼Œå¦‚ä½•åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçœ‹åˆ°ä¸­æ–­çš„ç›¸å…³ç»Ÿè®¡ä¿¡æ¯ <code>cat /proc/interrupts</code> è¿™ç§ã€‚</li></ol></blockquote><h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>ä¸­æ–­æŠ€æœ¯ä¸Šçš„å®ç°æœ‰ä¸¤æ–¹é¢ï¼š</p><ul><li><strong>æ±‡ç¼–è¯­è¨€ä»£ç </strong>ï¼Œä¸å¤„ç†å™¨é«˜åº¦ç›¸å…³ï¼Œç”¨äºå¤„ç†ç‰¹å®šå¹³å°ä¸Šç›¸å…³çš„åº•å±‚ç»†èŠ‚ï¼›</li><li><strong>æŠ½è±¡æ¥å£</strong>ï¼Œæ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºåŠå…¶ä»–å†…æ ¸ä»£ç å®‰è£…å’Œç®¡ç† <code>IRQ</code> å¤„ç†ç¨‹åºæ‰€éœ€çš„ã€‚</li></ul><p>æœ¬èŠ‚ä¸»è¦å…³æ³¨ç¬¬äºŒæ–¹é¢ã€‚</p><p><img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830114231632.png" alt="image-20230830114231632"></p><h4 id="irq-desc"><a href="#irq-desc" class="headerlink" title="irq_desc"></a>irq_desc</h4><blockquote><p>æ¯ä¸€ä¸ªä¸­æ–­éƒ½å¯¹åº”ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦ <code>irq_desc</code>ã€‚</p></blockquote><p>ä¸ºå“åº”å¤–éƒ¨è®¾å¤‡çš„ <code>IRQ</code>ï¼Œå†…æ ¸å¿…é¡»ä¸ºæ¯ä¸ªæ½œåœ¨çš„ <code>IRQ</code> æä¾›ä¸€ä¸ªå‡½æ•°ã€‚<strong>è¯¥å‡½æ•°å¿…é¡»èƒ½å¤ŸåŠ¨æ€æ³¨å†Œå’Œæ³¨</strong>é”€ã€‚<code>IRQ</code> ç›¸å…³ä¿¡æ¯ç®¡ç†çš„å…³é”®ç‚¹æ˜¯ä¸€ä¸ª<strong>å…¨å±€æ•°ç»„</strong>ï¼Œæ¯ä¸ªæ•°ç»„é¡¹å¯¹åº”ä¸€ä¸ª <code>IRQ</code> ç¼–å·ã€‚å› ä¸ºæ•°ç»„ä½ç½®å’Œä¸­æ–­å·æ˜¯ç›¸åŒçš„ï¼Œå¾ˆå®¹æ˜“å®šä½ä¸ç‰¹å®šçš„ <code>IRQ</code> ç›¸å…³çš„æ•°ç»„é¡¹ï¼š<code>IRQ</code> 0 åœ¨ä½ç½® 0ï¼Œ<code>IRQ</code> 15 åœ¨ä½ç½® 15ï¼Œç­‰ç­‰ã€‚ä¸è¿‡ <code>IRQ</code> æœ€ç»ˆæ˜ å°„åˆ°å“ªä¸ªå¤„ç†å™¨ä¸­æ–­ï¼Œåœ¨è¿™é‡Œæ˜¯ä¸ç›¸å…³çš„ã€‚</p><blockquote><p>å¦‚å‰é¢æ‰€è¯´çš„ <code>IRQ</code> å·ä¸ä¸­æ–­å·çš„åŒºåˆ«ã€‚<code>/proc/interrupts</code> ä¸­å±•ç¤ºçš„æ˜¯ <code>IRQ</code> å·è€Œä¸æ˜¯ä¸­æ–­å·ã€‚</p><p>é¡ºä¾¿æä¸€å˜´ï¼Œå†…æ ¸ä»£ç éƒ½æ˜¯é‡‡ç”¨çš„ <code>tab</code> ç¼©å‡ï¼Œå¹¶ä¸”ä¸€ä¸ª<code>1tab = 8space</code>ï¼Œæ‰€ä»¥å‘ç°å†…æ ¸ä»£ç å¯¹é½æœ‰é—®é¢˜æ—¶ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ä½ çš„<code>tab</code>è®¾ç½®ä¸å¯¹ã€‚</p><p>æœ¬æ–‡å‚è€ƒçš„æ˜¯å†…æ ¸ç‰ˆæœ¬æ˜¯ <code>v5.10.186</code> ã€‚ä¸ã€Šæ·±å…¥ Linux å†…æ ¸æ¶æ„ã€‹ä½¿ç”¨çš„ç•¥æœ‰åŒºåˆ«ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/irq/irqdesc.c#L554</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> <span class="title">irq_desc</span>[<span class="title">NR_IRQS</span>] __<span class="title">cacheline_aligned_in_smp</span> =</span> &#123;</span><br><span class="line">        [<span class="number">0</span> ... NR_IRQS<span class="number">-1</span>] = &#123;</span><br><span class="line">                .handle_irq     = handle_bad_irq,</span><br><span class="line">                .depth          = <span class="number">1</span>,</span><br><span class="line">                .lock           = __RAW_SPIN_LOCK_UNLOCKED(irq_desc-&gt;lock),</span><br><span class="line">        &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ol><li><code>struct irq_desc irq_desc[NR_IRQS]</code>: è¿™æ˜¯ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦æ•°ç»„ï¼Œç”¨äºå­˜å‚¨ç³»ç»Ÿä¸­æ‰€æœ‰å¯èƒ½çš„ä¸­æ–­çš„æè¿°ä¿¡æ¯ã€‚**<code>NR_IRQS</code> è¡¨ç¤ºä¸­æ–­æ€»æ•°<strong>ï¼Œåœ¨ä¸åŒçš„ä½“ç³»ç»“æ„ä¸Šï¼Œæ”¯æŒçš„ä¸­æ–­æ•°å¹¶ä¸ç›¸åŒï¼Œ32ã€64ã€128ã€512 ç­‰ç­‰ã€‚</strong>æ¯ä¸ªä¸­æ–­éƒ½å¯¹åº”ä¸€ä¸ª <a href="https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/irqdesc.h#L55"><code>struct irq_desc</code></a> çš„å®ä¾‹**ï¼ˆå³ä¸­æ–­æè¿°ç¬¦ï¼‰ã€‚</li><li><code>__cacheline_aligned_in_smp</code>: è¿™ä¸ªæ ‡å¿—è¡¨æ˜è¿™ä¸ªæ•°ç»„ä¼šè¢«åœ¨å¤šæ ¸ç³»ç»Ÿä¸­<strong>æŒ‰ç¼“å­˜è¡Œå¯¹é½</strong>ï¼ˆä¸€èˆ¬ä¸º <code>64 byte</code>ï¼‰ï¼Œä»¥æé«˜æ•ˆç‡ã€‚</li><li><code>[0 ... NR_IRQS-1]</code>: è¿™æ˜¯ä¸€ç§åˆå§‹åŒ–æ•°ç»„çš„è¯­æ³•ï¼Œè¡¨ç¤ºå¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œåˆå§‹åŒ–ã€‚</li><li><code>.handle_irq = handle_bad_irq</code>: è¿™å°†æ¯ä¸ªä¸­æ–­æè¿°ç¬¦çš„ <code>handle_irq</code> æˆå‘˜åˆå§‹åŒ–ä¸º <code>handle_bad_irq</code>ã€‚<code>handle_irq</code> æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œä½†åœ¨è¿™é‡Œå®ƒè¢«åˆå§‹åŒ–ä¸º <code>handle_bad_irq</code>ï¼Œå³å¤„ç†â€œåâ€ä¸­æ–­çš„å‡½æ•°ã€‚è¿™é€šå¸¸æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œè¡¨æ˜é»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰ä¸­æ–­éƒ½å°†ä½¿ç”¨ç›¸åŒçš„å¤„ç†å‡½æ•°ã€‚</li><li><code>.depth = 1</code>: è¿™å°†æ¯ä¸ªä¸­æ–­æè¿°ç¬¦çš„ <code>depth</code> æˆå‘˜åˆå§‹åŒ–ä¸º 1ã€‚**<code>depth</code> è¡¨ç¤ºä¸­æ–­åµŒå¥—çš„æ·±åº¦**ï¼Œå³åœ¨å¤„ç†ä¸­æ–­æ—¶ï¼Œå¦‚æœå‘ç”Ÿå¦ä¸€ä¸ªä¸­æ–­ï¼Œç³»ç»Ÿå¯ä»¥è·Ÿè¸ªä¸­æ–­çš„åµŒå¥—çº§åˆ«ã€‚<code>depth</code> æœ‰ä¸¤ä¸ªä»»åŠ¡ã€‚å®ƒå¯ç”¨äºç¡®å®š IRQ ç”µè·¯æ˜¯å¯ç”¨çš„è¿˜æ˜¯ç¦ç”¨çš„ã€‚æ­£å€¼è¡¨ç¤ºç¦ç”¨ï¼Œè€Œ 0 è¡¨ç¤ºå¯ç”¨ã€‚ä¸ºä»€ä¹ˆç”¨æ­£å€¼è¡¨ç¤ºç¦ç”¨çš„ <code>IRQ</code> å‘¢ï¼Ÿå› ä¸ºè¿™ä½¿å¾—å†…æ ¸èƒ½å¤ŸåŒºåˆ†å¯ç”¨å’Œç¦ç”¨çš„ <code>IRQ</code> ç”µè·¯ï¼Œä»¥åŠé‡å¤ç¦ç”¨åŒä¸€ä¸­æ–­çš„æƒ…å½¢ã€‚è¿™ä¸ªå€¼ç›¸å½“äºä¸€ä¸ªè®¡æ•°å™¨ï¼Œå†…æ ¸å…¶ä½™éƒ¨åˆ†çš„ä»£ç æ¯æ¬¡ç¦ç”¨æŸä¸ªä¸­æ–­ï¼Œåˆ™å°†å¯¹åº”çš„è®¡æ•°å™¨åŠ  1ï¼›æ¯æ¬¡ä¸­æ–­è¢«å†æ¬¡å¯ç”¨ï¼Œåˆ™å°†è®¡æ•°å™¨å‡ 1ã€‚åœ¨ <code>depth</code> å½’ 0 æ—¶ï¼Œç¡¬ä»¶æ‰èƒ½å†æ¬¡ä½¿ç”¨å¯¹åº”çš„ <code>IRQ</code>ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæ”¯æŒå¯¹åµŒå¥—ç¦ç”¨ä¸­æ–­çš„æ­£ç¡®å¤„ç†ã€‚</li><li><code>.lock = __RAW_SPIN_LOCK_UNLOCKED(irq_desc-&gt;lock)</code>: è¿™å°†æ¯ä¸ªä¸­æ–­æè¿°ç¬¦çš„ <code>lock</code> æˆå‘˜åˆå§‹åŒ–ä¸ºæœªé”å®šçš„è‡ªæ—‹é”ã€‚è‡ªæ—‹é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œ<strong>ç”¨äºä¿æŠ¤å¯¹ä¸­æ–­æè¿°ç¬¦çš„è®¿é—®</strong>ã€‚<code>__RAW_SPIN_LOCK_UNLOCKED</code> å®ç”¨äºåˆå§‹åŒ–è‡ªæ—‹é”ã€‚</li></ol><p>ä¸‹é¢æ˜¯ <code>irq_desc</code> çš„ç»“æ„ï¼ˆæœ‰çœç•¥ï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">irq_common_data</span>  <span class="title">irq_common_data</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">irq_data</span>         <span class="title">irq_data</span>;</span></span><br><span class="line">        <span class="comment">/* struct irq_data &#123;</span></span><br><span class="line"><span class="comment">                u32                     mask;</span></span><br><span class="line"><span class="comment">                unsigned int            irq;   // å“ªä¸€ä¸ªæ˜¯ç”±è®¾å¤‡æ ‘æŒ‡å®šçš„å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment">                unsigned long           hwirq; // è¿™</span></span><br><span class="line"><span class="comment">                struct irq_common_data  *common;</span></span><br><span class="line"><span class="comment">                struct irq_chip         *chip;</span></span><br><span class="line"><span class="comment">                struct irq_domain       *domain;</span></span><br><span class="line"><span class="comment">                void                    *chip_data;</span></span><br><span class="line"><span class="comment">        &#125;; */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> __percpu   *kstat_irqs;</span><br><span class="line">        <span class="type">irq_flow_handler_t</span>      handle_irq;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">irqaction</span>        *<span class="title">action</span>;</span>        <span class="comment">/* IRQ action list */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span>            status_use_accessors;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span>            depth;          <span class="comment">/* nested irq disables */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span>            irq_count;      <span class="comment">/* For detecting broken IRQs */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span>            irqs_unhandled;</span><br><span class="line">        <span class="type">raw_spinlock_t</span>          lock;</span><br><span class="line">        <span class="type">int</span>                     parent_irq;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">module</span>           *<span class="title">owner</span>;</span></span><br><span class="line">        <span class="type">const</span> <span class="type">char</span>              *name;</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure><ul><li><code>action</code>ï¼šæä¾›äº†ä¸€ä¸ªæ“ä½œé“¾ï¼Œéœ€è¦åœ¨ä¸­æ–­å‘ç”Ÿæ—¶æ‰§è¡Œã€‚ç”±ä¸­æ–­é€šçŸ¥çš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå¯ä»¥å°†ä¸ä¹‹ç›¸å…³çš„å¤„ç†ç¨‹åºå‡½æ•°æ”¾ç½®åœ¨æ­¤å¤„ã€‚æœ‰ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æ„ç”¨äºè¡¨ç¤ºè¿™äº›æ“ä½œã€‚</li><li><code>irq_data-&gt;chip</code>ï¼šç”µæµå¤„ç†å’ŒèŠ¯ç‰‡ç›¸å…³æ“ä½œè¢«å°è£…åœ¨ <code>chip</code> ä¸­ã€‚ä¸ºæ­¤å¼•å…¥äº†ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æ„ã€‚</li><li><code>name</code>ï¼šæŒ‡å®šäº†ç”µæµå±‚å¤„ç†ç¨‹åºçš„åç§°ï¼Œå¯¹è¾¹æ²¿è§¦å‘ä¸­æ–­ï¼Œé€šå¸¸æ˜¯ <code>edge</code>ï¼Œå¯¹ç”µå¹³è§¦å‘ä¸­æ–­ï¼Œé€šå¸¸æ˜¯ <code>level</code>ã€‚</li><li><code>status_use_accessors</code>ï¼š<ul><li><code>IRQ_DISABLED</code> ç”¨äºè¡¨ç¤ºè¢«è®¾å¤‡é©±åŠ¨ç¨‹åºç¦ç”¨çš„ IRQ ç”µè·¯ã€‚è¯¥æ ‡å¿—é€šçŸ¥å†…æ ¸ä¸è¦è¿›å…¥å¤„ç†ç¨‹åºã€‚</li><li>åœ¨ IRQ å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼ŒçŠ¶æ€è®¾ç½®ä¸º <code>IRQ_INPROGRESS</code>ã€‚ä¸ <code>IRQ_DISABLED</code> ç±»ä¼¼ï¼Œè¿™ä¼šé˜»æ­¢å…¶ä½™çš„å†…æ ¸ä»£ç æ‰§è¡Œè¯¥å¤„ç†ç¨‹åºã€‚</li><li>åœ¨ CPU æ³¨æ„åˆ°ä¸€ä¸ªä¸­æ–­ä½†å°šæœªæ‰§è¡Œå¯¹åº”çš„å¤„ç†ç¨‹åºæ—¶ï¼Œ<code>IRQ_PENDING</code> æ ‡å¿—ä½ç½®ä½ã€‚</li><li>ä¸ºæ­£ç¡®å¤„ç†å‘ç”Ÿåœ¨ä¸­æ–­å¤„ç†æœŸé—´çš„ä¸­æ–­ï¼Œéœ€è¦ <code>IRQ_MASKED</code> æ ‡å¿—ã€‚å…·ä½“å‚è§ 14.1.4 èŠ‚ã€‚</li><li>åœ¨æŸä¸ª IRQ åªèƒ½å‘ç”Ÿåœ¨ä¸€ä¸ª CPU ä¸Šæ—¶ï¼Œå°†è®¾ç½® <code>IRQ_PER_CPU</code> æ ‡å¿—ä½ã€‚ï¼ˆåœ¨ SMP ç³»ç»Ÿä¸­ï¼Œè¯¥æ ‡å¿—ä½¿å‡ ä¸ªç”¨äºé˜²æ­¢å¹¶å‘è®¿é—®çš„ä¿æŠ¤æœºåˆ¶å˜å¾—å¤šä½™ï¼‰ã€‚</li><li><code>IRQ_LEVEL</code> ç”¨äº Alpha å’Œ PowerPC ç³»ç»Ÿï¼Œç”¨äºåŒºåˆ†ç”µå¹³è§¦å‘å’Œè¾¹æ²¿è§¦å‘çš„ IRQã€‚</li><li><code>IRQ_REPLAY</code> æ„å‘³ç€è¯¥ IRQ å·²ç»ç¦ç”¨ï¼Œä½†æ­¤å‰å°šæœ‰ä¸€ä¸ªæœªç¡®è®¤çš„ä¸­æ–­ã€‚</li><li><code>IRQ_AUTODETECT</code> å’Œ <code>IRQ_WAITING</code> ç”¨äº IRQ çš„è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®ã€‚</li></ul></li></ul><h4 id="IRQ-æ§åˆ¶å™¨æŠ½è±¡"><a href="#IRQ-æ§åˆ¶å™¨æŠ½è±¡" class="headerlink" title="IRQ æ§åˆ¶å™¨æŠ½è±¡"></a>IRQ æ§åˆ¶å™¨æŠ½è±¡</h4><h3 id="æ³¨å†Œå’Œåˆ†é…-IRQ"><a href="#æ³¨å†Œå’Œåˆ†é…-IRQ" class="headerlink" title="æ³¨å†Œå’Œåˆ†é… IRQ"></a>æ³¨å†Œå’Œåˆ†é… IRQ</h3><ol><li><p><strong>æ³¨å†Œ IRQ</strong></p><p> ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºåŠ¨æ€æ³¨å†Œ ISR çš„å·¥ä½œï¼Œå¯ä»¥ä½¿æ‰€è¿°çš„æ•°æ®ç»“æ„éå¸¸ç®€å•åœ°è¿›è¡Œã€‚</p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* request_irq - Add a handler for an interrupt line</span></span><br><span class="line"><span class="comment">* @irq:     The interrupt line to allocate</span></span><br><span class="line"><span class="comment">* @handler: Function to be called when the IRQ occurs.</span></span><br><span class="line"><span class="comment">*           Primary handler for threaded interrupts</span></span><br><span class="line"><span class="comment">*           If NULL, the default primary handler is installed</span></span><br><span class="line"><span class="comment">* @flags:   Handling flags</span></span><br><span class="line"><span class="comment">* @name:    Name of the device generating this interrupt</span></span><br><span class="line"><span class="comment">* @dev:     A cookie passed to the handler function</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* This call allocates an interrupt and establishes a handler; see</span></span><br><span class="line"><span class="comment">* the documentation for request_threaded_irq() for details.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> __must_check</span><br><span class="line"><span class="title function_">request_irq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> irq, <span class="type">irq_handler_t</span> handler, <span class="type">unsigned</span> <span class="type">long</span> flags,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">char</span> *name, <span class="type">void</span> *dev)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> request_threaded_irq(irq, handler, <span class="literal">NULL</span>, flags, name, dev);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830155455169.png" alt="image-20230830155455169"></p></li><li><p><strong>é‡Šæ”¾ IRQ</strong></p></li><li><p><strong>æ³¨å†Œä¸­æ–­</strong></p></li></ol><h3 id="å¤„ç†-IRQ"><a href="#å¤„ç†-IRQ" class="headerlink" title="å¤„ç† IRQ"></a>å¤„ç† IRQ</h3><h4 id="1-åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ï¼š"><a href="#1-åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ï¼š" class="headerlink" title="1. åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ï¼š"></a>1. åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ï¼š</h4><p>åˆ°æ ¸å¿ƒæ€çš„åˆ‡æ¢ï¼Œæ˜¯åŸºäºæ¯ä¸ªä¸­æ–­ä¹‹åç”±å¤„ç†å™¨è‡ªåŠ¨æ‰§è¡Œçš„æ±‡ç¼–è¯­è¨€ä»£ç çš„ã€‚åªæœ‰é‚£äº›æœ€ä¸ºå¿…è¦çš„æ“ä½œç›´æ¥åœ¨æ±‡ç¼–è¯­è¨€ä»£ç ä¸­æ‰§è¡Œã€‚å†…æ ¸è¯•å›¾å°½å¿«åœ°è¿”å›åˆ°å¸¸è§„çš„ C ä»£ç ï¼Œå› ä¸º C ä»£ç æ›´å®¹æ˜“å¤„ç†ã€‚</p><p>åœ¨ C è¯­è¨€ä¸­è°ƒç”¨å‡½æ•°æ—¶ï¼Œéœ€è¦å°†æ‰€éœ€çš„æ•°æ®ï¼ˆè¿”å›åœ°å€å’Œå‚æ•°ï¼‰æŒ‰ä¸€å®šçš„é¡ºåºæ”¾åˆ°æ ˆä¸Šã€‚åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œè¿˜éœ€è¦å°†æœ€é‡è¦çš„å¯„å­˜å™¨ä¿å­˜åˆ°æ ˆä¸Šï¼Œä»¥ä¾¿ä»¥åæ¢å¤ã€‚è¿™ä¸¤ä¸ªæ“ä½œç”±å¹³å°ç›¸å…³çš„æ±‡ç¼–è¯­è¨€ä»£ç æ‰§è¡Œã€‚åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼Œæ§åˆ¶æµæ¥ä¸‹æ¥ä¼ é€’åˆ° <code>C</code> å‡½æ•° <code>do_IRQ</code>ï¼Œå…¶å®ç°ä¹Ÿæ˜¯å¹³å°ç›¸å…³çš„ï¼Œä½†æƒ…å†µä»ç„¶å¾—åˆ°äº†å¾ˆå¤§çš„ç®€åŒ–ã€‚ æ ¹æ®å¹³å°ä¸åŒï¼Œè¯¥å‡½æ•°çš„å‚æ•°æˆ–è€…æ˜¯<strong>å¤„ç†å™¨å¯„å­˜å™¨é›†åˆ</strong>ã€æˆ–æ˜¯ä¸­æ–­å·å’ŒæŒ‡å‘å¤„ç†å™¨å¯„å­˜å™¨é›†åˆçš„æŒ‡é’ˆã€‚</p><p><img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230831095645760.png" alt="image-20230831095645760"></p><blockquote><p>è¿™é‡Œç†è§£ä¸€ä¸‹å¦‚ä½•ä¿å­˜å¯„å­˜å™¨å€¼çš„ï¼Œå°±æ˜¯ç›´æ¥è¯»å–å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åå­˜æ”¾åœ¨ <code>struct pt_regs</code> è¿™ä¸ªç»“æ„ä½“ä¸­ã€‚å¹¶ä¸”æ˜¯å­˜æ”¾åœ¨æ ˆåº•çš„ï¼Œä¸è¿‡å¯„å­˜å™¨é›†åˆä¹Ÿå¯ä»¥è¢«å¤åˆ¶åˆ°åœ°å€ç©ºé—´ä¸­æ ˆä»¥å¤–çš„å…¶ä»–ä½ç½®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ<code>do_IRQ</code> çš„ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘ <code>pt_regs</code> çš„æŒ‡é’ˆï¼Œä½†è¿™å¹¶æ²¡æœ‰æ”¹å˜ä»¥ä¸‹äº‹å®ï¼šå¯„å­˜å™¨çš„å†…å­˜å·²ç»è¢«ä¿å­˜ï¼Œå¯ä»¥ç”± C ä»£ç è¯»å–ã€‚ä¸åŒä½“ç³»ç»“æ„ä¸‹ï¼Œè¯¥ç»“æ„ä½“ <code>pt_regs</code> çš„å®šä¹‰æœ‰åŒºåˆ«ã€‚<a href="https://elixir.bootlin.com/linux/v5.10.186/source/arch/x86/include/asm/ptrace.h#L12">x86_32</a></p></blockquote><h4 id="2-IRQ-æ ˆ"><a href="#2-IRQ-æ ˆ" class="headerlink" title="2. IRQ æ ˆ"></a>2. IRQ æ ˆ</h4><ol><li><p>è°ƒç”¨ç”µæµå¤„ç†ç¨‹åºä¾‹ç¨‹</p><p> <img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830160703773.png" alt="image-20230830160703773"></p></li><li><p>è°ƒç”¨é«˜å±‚ ISR</p></li><li><p>å®ç°å¤„ç†ç¨‹åºä¾‹ç¨‹</p></li></ol><h2 id="è½¯ä¸­æ–­"><a href="#è½¯ä¸­æ–­" class="headerlink" title="è½¯ä¸­æ–­"></a>è½¯ä¸­æ–­</h2><blockquote><p>æœ¬èŠ‚è¯­å¢ƒä¸‹çš„è½¯ä¸­æ–­ä¸å†æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„æ€»ç§°ï¼Œè€Œæ˜¯ç‰¹æŒ‡ <code>softirq</code>ï¼</p></blockquote><h3 id="è½¯ä¸­æ–­ç±»å‹"><a href="#è½¯ä¸­æ–­ç±»å‹" class="headerlink" title="è½¯ä¸­æ–­ç±»å‹"></a>è½¯ä¸­æ–­ç±»å‹</h3><p>ä¸åŒäºç¡¬ä»¶ä¸­æ–­ï¼ˆæ¯ä¸ªè®¾å¤‡ä½¿ç”¨çš„å¤–è®¾æ•°é‡å’Œç±»å‹ä¸åŒï¼‰éœ€è¦æ”¯æŒåŠ¨æ€åœ°æ³¨å†Œï¼Œè½¯ä»¶ä¸­æ–­çš„ç±»å‹æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤æ˜¯ä»¥é™æ€çš„å½¢å¼å›ºåŒ–åœ¨å†…æ ¸ä»£ç ä¸­ã€‚å„ä¸ªè½¯ä¸­æ–­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œè¿™è¡¨æ˜è½¯ä¸­æ–­æ˜¯ç›¸å¯¹ç¨€ç¼ºçš„èµ„æºï¼Œä½¿ç”¨å…¶å¿…é¡»è°¨æ…ï¼Œä¸èƒ½ç”±å„ç§è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œå†…æ ¸ç»„ä»¶éšæ„ä½¿ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¸Šåªèƒ½ä½¿ç”¨ <code>32</code> ä¸ªè½¯ä¸­æ–­ã€‚è™½ç„¶çœ‹èµ·æ¥å¾ˆæœ‰é™ï¼Œä½†åœ¨ç›®å‰çš„å†…æ ¸ä¸­ï¼Œä»…ä»…ç”¨åˆ°äº† 10 ä¸ªè½¯ä¸­æ–­ğŸ›«ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L545</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        HI_SOFTIRQ=<span class="number">0</span>,     <span class="comment">// ä¸ TASKLET_SOFTIRQ ç±»ä¼¼ï¼Œç”¨äºéœ€è¦ä¼˜å…ˆå¤„ç†çš„ tasklet</span></span><br><span class="line">        TIMER_SOFTIRQ,</span><br><span class="line">        NET_TX_SOFTIRQ,</span><br><span class="line">        NET_RX_SOFTIRQ,</span><br><span class="line">        BLOCK_SOFTIRQ,    <span class="comment">// ä¸å—è®¾å¤‡ï¼ˆå¦‚ç¡¬ç›˜ï¼‰ç›¸å…³çš„è½¯ä¸­æ–­ï¼Œç”¨äºå¤„ç†å—è®¾å¤‡çš„æ•°æ®ä¼ è¾“å’Œ IO æ“ä½œ</span></span><br><span class="line">        IRQ_POLL_SOFTIRQ, <span class="comment">// ç”¨äºè½®è¯¢å¤„ç†ä¸­æ–­è¯·æ±‚ï¼ˆIRQï¼‰ï¼Œé€šå¸¸ç”¨äºä¸€äº›ç‰¹æ®Šçš„æƒ…å†µ</span></span><br><span class="line">        TASKLET_SOFTIRQ,  <span class="comment">// ç”¨äºå¤„ç†ä¸€äº›éœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¢«ç§°ä¸º taskletï¼Œåœ¨è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ</span></span><br><span class="line">        SCHED_SOFTIRQ,    <span class="comment">// ä¸è°ƒåº¦å™¨ç›¸å…³çš„è½¯ä¸­æ–­ï¼Œç”¨äºå¤„ç†è¿›ç¨‹å’Œçº¿ç¨‹çš„è°ƒåº¦æ“ä½œ</span></span><br><span class="line">        HRTIMER_SOFTIRQ,  <span class="comment">// ç”¨äºé«˜ç²¾åº¦å®šæ—¶å™¨çš„å¤„ç†ï¼Œè¿™äº›å®šæ—¶å™¨ç”¨äºå®ç°é«˜åˆ†è¾¨ç‡çš„æ—¶é—´é—´éš”</span></span><br><span class="line">        RCU_SOFTIRQ,    <span class="comment">/* Preferable RCU(Read-Copy-Update) should always be the last softirq */</span></span><br><span class="line"></span><br><span class="line">        NR_SOFTIRQS</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L645</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * <span class="type">const</span> softirq_to_name[NR_SOFTIRQS] = &#123;</span><br><span class="line">        <span class="string">&quot;HI&quot;</span>, <span class="string">&quot;TIMER&quot;</span>, <span class="string">&quot;NET_TX&quot;</span>, <span class="string">&quot;NET_RX&quot;</span>, <span class="string">&quot;BLOCK&quot;</span>, <span class="string">&quot;IRQ_POLL&quot;</span>,</span><br><span class="line">        <span class="string">&quot;TASKLET&quot;</span>, <span class="string">&quot;SCHED&quot;</span>, <span class="string">&quot;HRTIMER&quot;</span>, <span class="string">&quot;RCU&quot;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®ç»“æ„-1"><a href="#æ•°æ®ç»“æ„-1" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><p>å†…æ ¸å€ŸåŠ©äºè½¯ä¸­æ–­æ¥è·çŸ¥å¼‚å¸¸æƒ…å†µçš„å‘ç”Ÿï¼Œè€Œè¯¥æƒ…å†µå°†åœ¨ç¨åç”±ä¸“é—¨çš„å¤„ç†ç¨‹åºä¾‹ç¨‹è§£å†³ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå†…æ ¸åœ¨ <code>do_IRQ</code> æœ«å°¾å¤„ç†æ‰€æœ‰å¾…å†³è½¯ä¸­æ–­ï¼Œå› è€Œå¯ä»¥ç¡®ä¿è½¯ä¸­æ–­èƒ½å¤Ÿå®šæœŸå¾—åˆ°å¤„ç†ã€‚</p><p>è½¯ä¸­æ–­æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸€ä¸ªè¡¨ï¼ŒåŒ…å« <code>NR_SOFTIRQS</code> ä¸ª <code>softirq_action</code> ç±»å‹çš„æ•°æ®é¡¹ã€‚è¯¥æ•°æ®ç±»å‹ç»“æ„éå¸¸ç®€å•ï¼ŒåªåŒ…å«ä¸€ä¸ªæŒ‡å‘å¤„ç†ç¨‹åºä¾‹ç¨‹çš„æŒ‡é’ˆï¼Œåœ¨è½¯ä¸­æ–­å‘ç”Ÿæ—¶ç”±å†…æ ¸æ‰§è¡Œè¯¥å¤„ç†ç¨‹åºä¾‹ç¨‹ã€‚</p><blockquote><p>è½¯ä¸­æ–­æ˜¯å·²çŸ¥çš„ï¼Œè¿™äº›ä¸­æ–­çš„å¤„ç†ç¨‹åºä¹Ÿæ˜¯å†…æ ¸ä¸­å·²ç»å®ç°å¥½äº†çš„ã€‚æœç´¢ <a href="https://elixir.bootlin.com/linux/v5.10.186/C/ident/open_softirq"><code>open_softirq</code></a> å°±å¯ä»¥çœ‹åˆ° <code>timer</code>ã€<code>RCU</code> ç­‰åœ¨å„è‡ªçš„ <code>.c</code> æ–‡ä»¶ä¸­<strong>é™æ€æ³¨å†Œ</strong>äº†å¯¹åº”ä¸­æ–­çš„å¤„ç†ç¨‹åºã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span> <span class="title">softirq_vec</span>[<span class="title">NR_SOFTIRQS</span>] __<span class="title">cacheline_aligned_in_smp</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L559</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="type">void</span>    (*action)(<span class="keyword">struct</span> softirq_action *);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">open_softirq</span><span class="params">(<span class="type">int</span> nr, <span class="type">void</span> (*action)(<span class="keyword">struct</span> softirq_action *))</span></span><br><span class="line">&#123;</span><br><span class="line">        softirq_vec[nr].action = action;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L636</span></span><br><span class="line">open_softirq(TASKLET_SOFTIRQ, tasklet_action);</span><br><span class="line">open_softirq(HI_SOFTIRQ, tasklet_hi_action);</span><br></pre></td></tr></table></figure><blockquote><p>ğŸ‘€è¿™ä¸ª <code>action</code> å‡½æ•°æŒ‡é’ˆï¼Œå®ƒçš„ä¼ å…¥å‚æ•°ä¹Ÿæ˜¯ <code>softirq_action</code>ğŸ‘»ï¼ˆä»åé¢ <code>tasklet_action</code> çš„ä¾‹å­æ¥çœ‹æ ¹æœ¬æ²¡ç”¨åˆ°è¿™ä¸ªå‚æ•°ğŸ‘€ï¼‰</p></blockquote><h3 id="è§¦å‘è½¯ä¸­æ–­"><a href="#è§¦å‘è½¯ä¸­æ–­" class="headerlink" title="è§¦å‘è½¯ä¸­æ–­"></a>è§¦å‘è½¯ä¸­æ–­</h3><blockquote><p>è§¦å‘è½¯ä¸­æ–­ä»…ä»…æ˜¯å‘èµ·äº†ä¸­æ–­è¯·æ±‚ï¼Œä¼šå¤„ç†ï¼Œä½†ä¸ä¸€å®šä¼šé©¬ä¸Šå¤„ç†ï¼Œè€Œæ˜¯è¦ç­‰è°ƒåº¦å™¨å®‰æ’ã€‚</p></blockquote><p>ä¸åŒäºç¡¬ä»¶ä¸­æ–­ç›´æ¥ç”±å¤–è®¾å‘èµ·è¯·æ±‚ï¼ˆç»è¿‡ä¸­æ–­æ§åˆ¶å™¨å‘èµ·ï¼‰ï¼Œè½¯ä¸­æ–­åˆ™æ˜¯é€šè¿‡è°ƒç”¨ <code>raise_softirq(int nr)</code> æ¥å¼•å‘ä¸€ä¸ªè½¯ä¸­æ–­ï¼ˆç±»ä¼¼æ™®é€šä¸­æ–­ï¼‰ã€‚è½¯ä¸­æ–­çš„ç¼–å·é€šè¿‡å‚æ•°æŒ‡å®šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">raise_softirq</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">        local_irq_save(flags); <span class="comment">// ç¦ç”¨æœ¬åœ° CPU çš„ç¡¬ä»¶ä¸­æ–­ï¼ŒåŒæ—¶å°†å½“å‰ä¸­æ–­çŠ¶æ€ä¿å­˜åœ¨ flags å˜é‡ä¸­</span></span><br><span class="line">        raise_softirq_irqoff(nr); <span class="comment">// è§¦å‘æŒ‡å®šçš„è½¯ä¸­æ–­ï¼Œä»…ä»…æ˜¯æ ‡å¿—ä¸ºéœ€è¦å¤„ç†ï¼Œéœ€è¦ç­‰å¾…è°ƒåº¦ç³»ç»Ÿå®‰æ’ CPU cycle</span></span><br><span class="line">        local_irq_restore(flags); <span class="comment">// åœ¨è½¯ä¸­æ–­è§¦å‘å®Œæ¯•åï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„ä¸­æ–­çŠ¶æ€ï¼Œå³å°†ä¸­æ–­é‡æ–°æ‰“å¼€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>è§¦å‘è½¯ä¸­æ–­ä»…ä»…æ˜¯è®¾ç½®å¯¹åº”ä¸­æ–­çš„æ ‡å¿—ä½ï¼Œå¹¶ä¸ä¼šåƒç¡¬ä»¶ä¸­æ–­é‚£æ ·ç«‹åˆ»æ‰§è¡Œï¼éœ€è¦ç­‰å¾…è°ƒåº¦ç³»ç»Ÿå®‰æ’ CPU cycleã€‚<br>æ‰€ä»¥è¿™é‡Œè™½ç„¶ç¦ç”¨äº†æœ¬åœ° CPU ç¡¬ä»¶ä¸­æ–­ï¼Œä½†è®¾ç½®æ ‡å¿—ä½ä¹‹åå°±ç«‹é©¬æ¢å¤ï¼Œç¦ç”¨çš„æ—¶é—´å¾ˆçŸ­ã€‚</p><p>å¦å¤–ï¼Œè¿™é‡Œç¦ç”¨çš„æ˜¯ç¡¬ä»¶ä¸­æ–­ï¼è½¯ä»¶ä¸­æ–­çš„æ‰§è¡Œæ˜¯é€šè¿‡å†…æ ¸è°ƒåº¦æœºåˆ¶æ¥è§¦å‘å’Œè°ƒåº¦çš„ï¼Œé€šå¸¸æ˜¯ä¸ºäº†åœ¨ä¸é˜»å¡å…¶ä»–æ“ä½œçš„æƒ…å†µä¸‹æ‰§è¡Œä¸€äº›å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä¸éœ€è¦è¢«æ˜¾å¼ç¦ç”¨ã€‚</p></blockquote><p>è¯¥å‡½æ•°è®¾ç½®å„ CPU å˜é‡ <code>irq_stat[smp_processor_id].__softirq_pending</code> ä¸­çš„å¯¹åº”æ¯”ç‰¹ä½ã€‚è¯¥å‡½æ•°å°†ç›¸åº”çš„è½¯ä¸­æ–­æ ‡è®°ä¸ºæ‰§è¡Œï¼Œä½†è¿™ä¸ªæ‰§è¡Œæ˜¯å»¶æœŸæ‰§è¡Œã€‚é€šè¿‡ä½¿ç”¨ç‰¹å®šäºå¤„ç†å™¨çš„ä½å›¾ï¼Œå†…æ ¸ç¡®ä¿å‡ ä¸ªè½¯ä¸­æ–­ï¼ˆç”šè‡³æ˜¯ç›¸åŒçš„ï¼‰å¯ä»¥åŒæ—¶åœ¨ä¸åŒçš„ CPU ä¸Šæ‰§è¡Œã€‚</p><blockquote><p>è¿™ä¸ªå˜é‡å¥½åƒå’Œå‰é¢çš„æ²¡å…³ç³»å•Šï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚</p><p>todoâ€¦</p></blockquote><h3 id="ä¼˜å…ˆçº§"><a href="#ä¼˜å…ˆçº§" class="headerlink" title="ä¼˜å…ˆçº§"></a>ä¼˜å…ˆçº§</h3><p><strong>è½¯ä¸­æ–­çš„ç¼–å·å½¢æˆäº†ä¸€ä¸ªä¼˜å…ˆé¡ºåº</strong>ï¼Œè¿™å¹¶ä¸å½±å“å„ä¸ªå¤„ç†ç¨‹åºä¾‹ç¨‹æ‰§è¡Œçš„é¢‘ç‡æˆ–å®ƒä»¬ç›¸å½“äºå…¶ä»–ç³»ç»Ÿæ´»åŠ¨çš„ä¼˜å…ˆçº§ï¼Œä½†å®šä¹‰äº†å¤šä¸ªè½¯ä¸­æ–­åŒæ—¶æ´»åŠ¨æˆ–å¾…å†³æ—¶å¤„ç†ä¾‹ç¨‹æ‰§è¡Œçš„æ¬¡åºã€‚</p><blockquote><p>ä¸å½±å“é¢‘ç‡æ˜¯å› ä¸ºåœ¨ä¸€æ¬¡ <code>do_IRQ</code> æ‰§è¡Œä¸­ï¼Œæ¯ä¸ªè½¯ä¸­æ–­éƒ½ä¼šè¢«éå†ã€æ‰§è¡Œï¼Œåªæ˜¯æŒ‰ç…§â€œä¼˜å…ˆçº§â€ï¼ˆé¡ºåºï¼‰æ‰§è¡Œè€Œå·²ã€‚</p><p>çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„ä»£ç   <a href="https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L282"><code>__do_softirq</code></a> ï¼Œéå† <code>softirq_vec</code> çš„ <code>actions</code>ã€‚</p></blockquote><h3 id="å¼€å¯è½¯ä¸­æ–­å¤„ç†"><a href="#å¼€å¯è½¯ä¸­æ–­å¤„ç†" class="headerlink" title="å¼€å¯è½¯ä¸­æ–­å¤„ç†"></a>å¼€å¯è½¯ä¸­æ–­å¤„ç†</h3><p>æœ‰å‡ ç§æ–¹æ³•å¯å¼€å¯è½¯ä¸­æ–­å¤„ç†ï¼Œä½†è¿™äº›éƒ½å½’ç»“ä¸ºè°ƒç”¨ <code>do_softirq</code> å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¯è§çš„ã€ç”¨äºåœ¨æ±‡ç¼–è¯­è¨€ä¸­è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºæ‰§è¡Œè½¯ä¸­æ–­çš„å¤„ç†</span></span><br><span class="line">asmlinkage __visible <span class="type">void</span> <span class="title function_">do_softirq</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        __u32 pending;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ£€æŸ¥å½“å‰ä»£ç æ˜¯å¦åœ¨ä¸€ä¸ªä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå³ä¸æ¶‰åŠç¡¬ä»¶ä¸­æ–­ï¼Œå› ä¸ºè½¯ä¸­æ–­ç”¨äºæ‰§è¡Œ ISR ä¸­éæ—¶é—´å…³é”®éƒ¨åˆ†ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥å…¶ä»£ç æœ¬èº«ä¸€å®šä¸èƒ½åœ¨ä¸­æ–­å¤„ç†ç¨‹åºå†…è°ƒç”¨ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (in_interrupt())</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        local_irq_save(flags); <span class="comment">// ç¦ç”¨æœ¬åœ° CPU çš„ç¡¬ä»¶ä¸­æ–­ï¼Œä»¥ç¡®ä¿åœ¨æ‰§è¡Œè½¯ä¸­æ–­å¤„ç†æ—¶ä¸ä¼šè¢«å…¶ä»–ç¡¬ä»¶ä¸­æ–­æ‰“æ–­</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–å½“å‰å¾…å¤„ç†çš„è½¯ä¸­æ–­æ ‡å¿—ï¼Œå³æ£€æŸ¥å“ªäº›è½¯ä¸­æ–­éœ€è¦è¢«æ‰§è¡Œ.</span></span><br><span class="line">        <span class="comment">// è¯¥å‡½æ•°è¿˜å°†åŸæ¥çš„ä½å›¾é‡ç½®ä¸º 0ã€‚æ¢å¥è¯è¯´ï¼Œæ¸…é™¤æ‰€æœ‰è½¯ä¸­æ–­ã€‚</span></span><br><span class="line">        pending = local_softirq_pending();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„è½¯ä¸­æ–­ï¼Œå¹¶ä¸”è¿˜ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ä¸“é—¨çš„å†…æ ¸çº¿ç¨‹ï¼ˆå¦‚ ksoftirqdï¼‰</span></span><br><span class="line">        <span class="comment">// æ­£åœ¨è¿è¡Œæ¥å¤„ç†è¿™äº›è½¯ä¸­æ–­ã€‚å¦‚æœæ¡ä»¶æ»¡è¶³ï¼Œå°±è°ƒç”¨</span></span><br><span class="line">        <span class="keyword">if</span> (pending &amp;&amp; !ksoftirqd_running(pending))</span><br><span class="line">                <span class="comment">// æ‰§è¡Œè½¯ä¸­æ–­çš„å®é™…å¤„ç†ã€‚è¿™ä¸ªå‡½æ•°ä¼šå°†è½¯ä¸­æ–­æ”¾åœ¨å½“å‰çº¿ç¨‹çš„æ ˆä¸Šè¿›è¡Œå¤„ç†ï¼Œ</span></span><br><span class="line">                <span class="comment">// ä»¥é¿å…ä¸å…¶ä»–ä¸Šä¸‹æ–‡ä¹‹é—´çš„å¹²æ‰°ã€‚è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ __do_softirq();</span></span><br><span class="line">                do_softirq_own_stack();</span><br><span class="line"></span><br><span class="line">        local_irq_restore(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230831101758366.png" alt="image-20230831101758366"></p><p><strong><code>softirq_vec</code> ä¸­çš„ <code>action</code> å‡½æ•°åœ¨ä¸€ä¸ª <code>while</code> å¾ªç¯ä¸­é’ˆå¯¹å„ä¸ªå¾…å†³çš„è½¯ä¸­æ–­è¢«è°ƒç”¨</strong>ã€‚ä¹Ÿå°±æ˜¯æŒ‰ç…§é¡ºåºï¼ˆä¼˜å…ˆçº§ï¼‰éå†æ‰€æœ‰éœ€è¦å¤„ç†çš„ä¸­æ–­ï¼Œä¾æ¬¡å¤„ç†ã€‚</p><blockquote><p><code>__do_softirq</code> è¿™é‡Œä¼šè°ƒç”¨è½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ï¼Œä¸€èˆ¬æ¥è¯´è€—æ—¶æ˜¯æ¯”è¾ƒé•¿çš„ï¼Œä¸ç†è§£è°ƒç”¨è¯¥å‡½æ•°æ—¶ä¸ºä»€ä¹ˆç¦ç”¨ç¡¬ä»¶ä¸­æ–­ã€‚</p><p>è¿™é‡Œéœ€è¦è¿›å…¥ <a href="https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L282"><code>__do_softirq</code></a> å†…éƒ¨æŸ¥çœ‹ï¼Œåœ¨æ­£å¼æ‰§è¡Œå¤„ç†å‡½æ•°ä¹‹å‰ï¼Œç¡¬ä»¶ä¸­æ–­å®é™…ä¸Šä¼šè¢«é‡æ–° <code>enable</code>ã€‚</p><p><del>ä¸å¤ªæ¸…æ¥šï¼Œä¸è¿‡æ€»ä¹‹äº‹å®å°±æ˜¯è¿™æ ·ï¼Œè¿™ä¹Ÿæ˜¯è½¯ä¸­æ–­çš„ä¸€ä¸ªâ€œç¼ºé™·â€ï¼ŒåŸºäºè½¯ä¸­æ–­çš„ <code>tasklet</code> æ‰§è¡ŒæœŸé—´åŒæ ·ç¦ç”¨äº†ç¡¬ä»¶ä¸­æ–­ã€‚å› æ­¤ä»–ä»¬çš„å¤„ç†å‡½æ•°æ‰§è¡Œæ—¶é—´ä»ç„¶éœ€è¦å°½é‡çŸ­ï¼Œä»¥ä¿æŒç³»ç»Ÿçš„å“åº”æ€§èƒ½ã€‚å¦‚æœéœ€è¦æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨<strong>å·¥ä½œé˜Ÿåˆ—</strong>ç­‰å…¶ä»–æœºåˆ¶ï¼Œå°†è¿™äº›æ“ä½œä» <code>Tasklet</code> ä¸­ç§»å‡ºï¼Œä»¥é¿å…é˜»å¡è½¯ä¸­æ–­çš„æ‰§è¡Œã€‚</del>ï¼ˆ<code>chatgpt</code> ğŸ¤®ï¼‰</p></blockquote><p>åœ¨å¤„ç†äº†æ‰€æœ‰æ ‡è®°å‡ºçš„è½¯ä¸­æ–­ä¹‹åï¼Œå†…æ ¸æ£€æŸ¥åœ¨æ­¤æœŸé—´æ˜¯å¦æœ‰æ–°çš„è½¯ä¸­æ–­æ ‡è®°åˆ°ä½å›¾ä¸­ã€‚è¦æ±‚åœ¨å‰ä¸€è½®å¾ªç¯ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ²¡æœ‰å¤„ç†çš„è½¯ä¸­æ–­ï¼Œè€Œé‡å¯çš„æ¬¡æ•°æ²¡æœ‰è¶…è¿‡ <code>MAX_SOFTIRQ_RESTART</code>ï¼ˆé€šå¸¸è®¾ç½®ä¸º 10ï¼‰ã€‚å¦‚æœæ˜¯è¿™æ ·ï¼Œåˆ™å†æ¬¡æŒ‰åºå¤„ç†æ ‡è®°çš„è½¯ä¸­æ–­ã€‚è¿™æ“ä½œä¼šä¸€ç›´é‡å¤ä¸‹å»ï¼Œç›´è‡³åœ¨æ‰§è¡Œæ‰€æœ‰å¤„ç†ç¨‹åºä¹‹åæ²¡æœ‰æ–°çš„æœªå¤„ç†è½¯ä¸­æ–­ä¸ºæ­¢ã€‚</p><p>å¦‚æœåœ¨ <code>MAX_SOFTIRQ_RESTART</code> æ¬¡é‡å¯å¤„ç†è¿‡ç¨‹ä¹‹åï¼Œä»ç„¶æœ‰æœªå¤„ç†çš„è½¯ä¸­æ–­ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•ï¼Ÿå†…æ ¸å°†è°ƒç”¨ <code>wakeup_softirqd</code> å”¤é†’è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹ã€‚</p><blockquote><p>ä¸Šé¢æè¿°çš„æ˜¯åœ¨ <a href="https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L255"><code>__do_softirq(void)</code></a> ä¸­ï¼Œé‡å¯ä¸ä»…æœ‰æ¬¡æ•°é™åˆ¶ï¼Œè¿˜æœ‰æ—¶é—´é™åˆ¶ã€‚</p></blockquote><h3 id="è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹"><a href="#è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹"></a>è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹</h3><p>è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹çš„ä»»åŠ¡æ˜¯ï¼Œä¸å…¶ä½™å†…æ ¸ä»£ç å¼‚æ­¥æ‰§è¡Œè½¯ä¸­æ–­ã€‚ä¸ºæ­¤ï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸ªå¤„ç†å™¨éƒ½åˆ†é…äº†è‡ªèº«çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œåä¸º <code>ksoftirqd</code>ã€‚</p><p>å†…æ ¸ä¸­æœ‰ä¸¤å¤„è°ƒç”¨ <code>wakeup_softirqd</code> å”¤é†’äº†è¯¥å®ˆæŠ¤è¿›ç¨‹ï¼š</p><ul><li>åœ¨ <code>do_softirq</code> ä¸­</li><li>ç”± <code>raise_softirq</code> åœ¨å†…éƒ¨è°ƒç”¨</li></ul><p>å”¤é†’å‡½æ•°æœ¬èº«åªéœ€è¦å‡ è¡Œä»£ç ã€‚é¦–å…ˆï¼Œå€ŸåŠ©äºä¸€äº›å®ï¼Œä»ä¸€ä¸ªå„ <code>CPU</code> å˜é‡è¯»å–æŒ‡å‘å½“å‰ <code>CPU</code> è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹çš„ <code>task_struct</code> çš„æŒ‡é’ˆã€‚å¦‚æœè¯¥è¿›ç¨‹å½“å‰çš„çŠ¶æ€ä¸æ˜¯ <code>TASK_RUNNING</code>ï¼Œåˆ™é€šè¿‡ <code>wake_up_process</code> å°†å…¶æ”¾ç½®åˆ°<strong>å°±ç»ªè¿›ç¨‹çš„åˆ—è¡¨æœ«å°¾</strong>ï¼ˆå‚è§ç¬¬ 2 ç« ï¼‰ã€‚å°½ç®¡è¿™å¹¶ä¸ä¼šç«‹å³å¼€å§‹å¤„ç†æ‰€æœ‰å¾…å†³è½¯ä¸­æ–­ï¼Œä½†åªè¦è°ƒåº¦å™¨æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Œå°±ä¼šé€‰æ‹©è¯¥å®ˆæŠ¤è¿›ç¨‹ï¼ˆä¼˜å…ˆçº§ä¸º <code>19</code>ï¼‰æ¥æ‰§è¡Œã€‚</p><blockquote><p>è½¯ä¸­æ–­çš„å®ˆæŠ¤è¿›ç¨‹åœ¨å†…æ ¸ä¸­ï¼Œä¸å…¶ä½™çº¿ç¨‹ä¸€èµ·é€šè¿‡è°ƒåº¦å™¨æ¥åˆ†é… CPU cycleï¼Œä¸è¿‡ç”±äº <code>ksoftirqd</code> çš„ä¼˜å…ˆçº§è¾ƒä½ï¼Œemmmï¼Œè½¯ä¸­æ–­çš„ä¼˜å…ˆçº§è¿™ä¹ˆä½ï¼Ÿï¼Ÿä¸ºä»€ä¹ˆï¼Ÿé‚£å¦‚æœç³»ç»Ÿæ¯”è¾ƒç¹å¿™çš„æ—¶å€™ï¼Œè¿™äº›ä¸­æ–­å²‚ä¸æ˜¯å¾ˆéš¾å¾—åˆ°å¤„ç†ï¼Ÿï¼ˆè™½ç„¶ä¹Ÿå’Œè°ƒåº¦ç®—æ³•æœ‰å…³ï¼Œlinux é»˜è®¤çš„è°ƒåº¦ç®—æ³•ä¹Ÿå§‹ç»ˆèƒ½ä¿è¯çº¿ç¨‹ä¸ä¼šé¥¿æ­»ï¼Œæ˜¯ç›¸å¯¹å…¬å¹³çš„ç®—æ³•ã€‚ï¼‰</p><p>è¿™ä¹Ÿæ˜¯è½¯ä¸­æ–­çš„ç‰¹ç‚¹å§ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼Œè·Ÿç¡¬ä»¶ä¸­æ–­ç«‹åˆ»æ‰§è¡Œæ¯”ä¸äº†çš„ã€‚</p></blockquote><p>åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ç”¨ <code>initcall</code> æœºåˆ¶ï¼ˆè§é™„å½• Dï¼‰è°ƒç”¨ <code>init</code> ä¸ä¹…ï¼Œå³åˆ›å»ºäº†ç³»ç»Ÿä¸­çš„è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹ã€‚åœ¨åˆå§‹åŒ–ä¹‹åï¼Œå„ä¸ªå®ˆæŠ¤è¿›ç¨‹éƒ½æ‰§è¡Œä»¥ä¸‹æ— é™å¾ªç¯ï¼š</p><p><img src="/../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830162923014.png" alt="image-20230830162923014"></p><blockquote><p>ä½†æ–°ç‰ˆå†…æ ¸ä¼¼ä¹å·²ç»æ¢äº†ä¸€ç§å®ç°æ–¹å¼äº†ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">run_ksoftirqd</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> cpu)</span></span><br><span class="line">&#123;</span><br><span class="line">        local_irq_disable();</span><br><span class="line">        <span class="keyword">if</span> (local_softirq_pending()) &#123;</span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 * We can safely run softirq on inline stack, as we are not deep</span></span><br><span class="line"><span class="comment">                 * in the task stack here.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                __do_softirq(); <span class="comment">// è°ƒç”¨ __do_softirq() å¤„ç†</span></span><br><span class="line">                local_irq_enable();</span><br><span class="line">                cond_resched();</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        local_irq_enable();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L734</span></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">smp_hotplug_thread</span> <span class="title">softirq_threads</span> =</span> &#123;</span><br><span class="line">        .store                  = &amp;ksoftirqd,</span><br><span class="line">        .thread_should_run      = ksoftirqd_should_run,</span><br><span class="line">        .thread_fn              = run_ksoftirqd,</span><br><span class="line">        .thread_comm            = <span class="string">&quot;ksoftirqd/%u&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __init <span class="type">int</span> <span class="title function_">spawn_ksoftirqd</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">        cpuhp_setup_state_nocalls(CPUHP_SOFTIRQ_DEAD, <span class="string">&quot;softirq:dead&quot;</span>, <span class="literal">NULL</span>,</span><br><span class="line">                                  takeover_tasklets);</span><br><span class="line">        BUG_ON(smpboot_register_percpu_thread(&amp;softirq_threads));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">early_initcall(spawn_ksoftirqd);</span><br></pre></td></tr></table></figure><p>æ¯ä¸€ä¸ª <code>core</code> ä¸Šéƒ½ä¼šå¯åŠ¨ä¸€ä¸ª <code>ksoftirqd</code> å®ˆæŠ¤è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">song.yu@WORKSTATION-PAD3:~$ ps aux | grep softirq</span><br><span class="line">root           <span class="number">9</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>  <span class="number">16</span>:<span class="number">58</span> [ksoftirqd/<span class="number">0</span>]</span><br><span class="line">root          <span class="number">18</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>  <span class="number">14</span>:<span class="number">43</span> [ksoftirqd/<span class="number">1</span>]</span><br><span class="line">root          <span class="number">24</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>  <span class="number">13</span>:<span class="number">40</span> [ksoftirqd/<span class="number">2</span>]</span><br><span class="line">root          <span class="number">30</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>  <span class="number">10</span>:<span class="number">04</span> [ksoftirqd/<span class="number">3</span>]</span><br><span class="line">root          <span class="number">36</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">21</span> [ksoftirqd/<span class="number">4</span>]</span><br><span class="line">root          <span class="number">42</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">29</span> [ksoftirqd/<span class="number">5</span>]</span><br><span class="line">root          <span class="number">48</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>  <span class="number">11</span>:<span class="number">24</span> [ksoftirqd/<span class="number">6</span>]</span><br><span class="line">root          <span class="number">54</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">39</span> [ksoftirqd/<span class="number">7</span>]</span><br><span class="line">root          <span class="number">60</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">55</span> [ksoftirqd/<span class="number">8</span>]</span><br><span class="line">root          <span class="number">66</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">12</span> [ksoftirqd/<span class="number">9</span>]</span><br><span class="line">root          <span class="number">72</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">51</span> [ksoftirqd/<span class="number">10</span>]</span><br><span class="line">root          <span class="number">78</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">24</span> [ksoftirqd/<span class="number">11</span>]</span><br><span class="line">root          <span class="number">84</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">7</span>:<span class="number">59</span> [ksoftirqd/<span class="number">12</span>]</span><br><span class="line">root          <span class="number">90</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">01</span> [ksoftirqd/<span class="number">13</span>]</span><br><span class="line">root          <span class="number">96</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">08</span> [ksoftirqd/<span class="number">14</span>]</span><br><span class="line">root         <span class="number">102</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">30</span> [ksoftirqd/<span class="number">15</span>]</span><br><span class="line">root         <span class="number">108</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">7</span>:<span class="number">49</span> [ksoftirqd/<span class="number">16</span>]</span><br><span class="line">root         <span class="number">114</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">00</span> [ksoftirqd/<span class="number">17</span>]</span><br><span class="line">root         <span class="number">120</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">9</span>:<span class="number">33</span> [ksoftirqd/<span class="number">18</span>]</span><br><span class="line">root         <span class="number">126</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">20</span> [ksoftirqd/<span class="number">19</span>]</span><br><span class="line">root         <span class="number">132</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">05</span> [ksoftirqd/<span class="number">20</span>]</span><br><span class="line">root         <span class="number">138</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">28</span> [ksoftirqd/<span class="number">21</span>]</span><br><span class="line">root         <span class="number">144</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">16</span> [ksoftirqd/<span class="number">22</span>]</span><br><span class="line">root         <span class="number">150</span>  <span class="number">0.0</span>  <span class="number">0.0</span>      <span class="number">0</span>     <span class="number">0</span> ?        S    <span class="number">4</span> æœˆ <span class="number">17</span>   <span class="number">8</span>:<span class="number">27</span> [ksoftirqd/<span class="number">23</span>]</span><br></pre></td></tr></table></figure><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul><li>è½¯ä¸­æ–­ç±»å‹æ˜¯æœ‰é™çš„ï¼Œå°± 10 æ¥ç§ï¼Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ä¹Ÿæ˜¯å†™æ­»äº†çš„ï¼Œä¸æ”¯æŒåŠ¨æ€æ³¨å†Œã€‚</li><li>è½¯ä¸­æ–­æ˜¯é€šè¿‡ <code>do_softirq</code> è¿™ä¸ªå‡½æ•°è°ƒç”¨å¼€å§‹æ‰§è¡Œçš„ï¼Œè¯¥å‡½æ•°ä¸€èˆ¬ç”± <code>ksoftirqd</code> å®ˆæŠ¤è¿›ç¨‹æ¥è°ƒç”¨æ‰§è¡Œï¼ˆå¥½åƒå…¶ä»–ä½ç½®ä¹Ÿå¯ä»¥è°ƒç”¨ï¼Œä¸è¿‡ä¸æ¸…æ¥šä¾‹å­ï¼‰ï¼Œè¯¥è¿›ç¨‹çš„ä¼˜å…ˆçº§å¾ˆä½ <code>19</code>ï¼Œæ‰€ä»¥<strong>è½¯ä¸­æ–­ä¸€èˆ¬ä¸èƒ½åŠæ—¶å¤„ç†</strong>ã€‚</li><li>è½¯ä¸­æ–­å¯ä»¥å¹¶å‘è¿è¡Œåœ¨å¤šä¸ª CPU ä¸Šï¼ˆå³ä½¿åŒä¸€ç±»å‹çš„ä¹Ÿå¯ä»¥ï¼‰ï¼Œæ‰€ä»¥è½¯ä¸­æ–­çš„<strong>å¤„ç†å‡½æ•°å¿…é¡»è®¾è®¡ä¸ºå¯é‡å…¥çš„å‡½æ•°</strong>ã€‚</li><li>è½¯ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¡¬ä»¶ä¸­æ–­æ²¡æœ‰è¢«ç¦ç”¨ï¼</li></ul><blockquote><p>âœ¨âœ¨âœ¨âœ¨</p><p>å…³äºä¸­æ–­çš„æ—¶åºï¼š</p><ul><li>ç¡¬ä¸­æ–­ä¼šæ‰“æ–­ç¡¬ä¸­æ–­ï¼ˆå½“ç„¶æ˜¯ä¸åŒç±»å‹çš„ï¼Œä»¥åŠæ²¡æœ‰è¢«ç¦ç”¨ï¼‰ï¼›</li><li>ç¡¬ä¸­æ–­ä¼šæ‰“æ–­è½¯ä¸­æ–­ï¼›</li><li>è½¯ä¸­æ–­ä¸ä¼šæ‰“æ–­ç¡¬ä¸­æ–­ï¼Œè½¯ä¸­æ–­ä¹Ÿä¸ä¼šæ‰“æ–­è½¯ä¸­æ–­ã€‚</li></ul></blockquote><h2 id="tasklet"><a href="#tasklet" class="headerlink" title="tasklet"></a>tasklet</h2><p>è½¯ä¸­æ–­æ˜¯å°†æ“ä½œæ¨è¿Ÿåˆ°æœªæ¥æ—¶åˆ»æ‰§è¡Œçš„æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚ä½†è¯¥å»¶æœŸæœºåˆ¶å¤„ç†èµ·æ¥éå¸¸å¤æ‚ã€‚å› ä¸ºå¤šä¸ªå¤„ç†å™¨å¯ä»¥åŒæ—¶ä¸”ç‹¬ç«‹åœ°å¤„ç†è½¯ä¸­æ–­ï¼Œ<strong>åŒä¸€ä¸ªè½¯ä¸­æ–­çš„å¤„ç†ç¨‹åºä¾‹ç¨‹å¯ä»¥åœ¨å‡ ä¸ª <code>CPU</code> ä¸ŠåŒæ—¶è¿è¡Œ</strong>ã€‚å¯¹è½¯ä¸­æ–­çš„æ•ˆç‡æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³é”®ï¼Œå¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šçš„ç½‘ç»œå®ç°æ˜¾ç„¶å—æƒ äºæ­¤ã€‚ä½†<strong>å¤„ç†ç¨‹åºä¾‹ç¨‹çš„è®¾è®¡å¿…é¡»æ˜¯å®Œå…¨å¯é‡å…¥ä¸”çº¿ç¨‹å®‰å…¨çš„</strong>ã€‚å¦å¤–ï¼Œä¸´ç•ŒåŒºå¿…é¡»ç”¨è‡ªæ—‹é”ä¿æŠ¤ï¼ˆæˆ–å…¶ä»– IPC æœºåˆ¶ï¼Œå‚è§ç¬¬ 5 ç« ï¼‰ï¼Œè€Œè¿™éœ€è¦å¤§é‡å®¡æ…çš„è€ƒè™‘ã€‚</p><p><code>tasklet</code> å’Œå·¥ä½œé˜Ÿåˆ—æ˜¯å»¶æœŸæ‰§è¡Œå·¥ä½œçš„æœºåˆ¶ï¼Œå…¶å®ç°åŸºäºè½¯ä¸­æ–­ï¼Œä½†å®ƒä»¬æ›´æ˜“äºä½¿ç”¨ï¼Œå› è€Œæ›´é€‚åˆäºè®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆä»¥åŠå…¶ä»–ä¸€èˆ¬æ€§çš„å†…æ ¸ä»£ç ï¼‰ã€‚</p><blockquote><p>æœ‰ç‚¹ç±»ä¼¼ä¸çº¿ç¨‹æ± çš„æ¦‚å¿µâœ¨ï¼Œçº¿ç¨‹æ± çš„å¤§å°å°±æ˜¯ <code>ksoftirqd</code> çš„æ•°é‡ï¼Œä»»åŠ¡å°±æ˜¯ <code>tasklet</code> æˆ–è€… <strong>å·¥ä½œé˜Ÿåˆ—</strong>ï¼Œå•ä¸ªä»»åŠ¡ <code>tasklet</code> å¯èƒ½åœ¨ä»»æ„ä¸€ä¸ª <code>ksoftirqd</code> ä¸Šè¿è¡Œï¼Œä½†æ˜¯ä¸€ä¸ª <code>tasklet</code> åªèƒ½åœ¨ä¸€ä¸ª <code>ksoftirqd</code> ä¸Šè¿è¡Œã€‚<code>tasklet</code> ä¹Ÿä¼šç”¨ä¸€ä¸ªå•å‘é“¾è¡¨ <code>tasklet_vec</code> æ¥ç®¡ç†ï¼Œ<del>æ¯æ¬¡ <code>ksoftirqd</code> å–ä»»åŠ¡æ—¶éƒ½éœ€è¦å¯¹è¯¥é˜Ÿåˆ—è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚</del></p></blockquote><h3 id="æ•°æ®ç»“æ„-2"><a href="#æ•°æ®ç»“æ„-2" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><h4 id="tasklet-struct"><a href="#tasklet-struct" class="headerlink" title="tasklet_struct"></a>tasklet_struct</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L613</span></span><br><span class="line"><span class="comment">/* Tasklets --- multithreaded analogue of BHs.</span></span><br><span class="line"><span class="comment">   Properties:</span></span><br><span class="line"><span class="comment">   * If tasklet_schedule() is called, then tasklet is guaranteed</span></span><br><span class="line"><span class="comment">     to be executed on some cpu at least once after this.</span></span><br><span class="line"><span class="comment">   * If the tasklet is already scheduled, but its execution is still not</span></span><br><span class="line"><span class="comment">     started, it will be executed only once.</span></span><br><span class="line"><span class="comment">   * If this tasklet is already running on another CPU (or schedule is called</span></span><br><span class="line"><span class="comment">     from tasklet itself), it is rescheduled for later.</span></span><br><span class="line"><span class="comment">   * Tasklet is strictly serialized wrt itself, but not</span></span><br><span class="line"><span class="comment">     wrt another tasklets. If client needs some intertask synchronization,</span></span><br><span class="line"><span class="comment">     he makes it with spinlocks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">next</span>;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> state;</span><br><span class="line">        <span class="type">atomic_t</span> count;</span><br><span class="line">        <span class="type">bool</span> use_callback;</span><br><span class="line">        <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">                <span class="type">void</span> (*func)(<span class="type">unsigned</span> <span class="type">long</span> data);</span><br><span class="line">                <span class="type">void</span> (*callback)(<span class="keyword">struct</span> tasklet_struct *t);</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li><p><code>next</code> æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨äºå»ºç«‹ <code>tasklet_struct</code> å®ä¾‹çš„é“¾è¡¨ã€‚è¿™å®¹è®¸å‡ ä¸ªä»»åŠ¡æ’é˜Ÿæ‰§è¡Œã€‚</p></li><li><p><code>func</code> æŒ‡å‘ä¸€ä¸ªå‡½æ•°çš„åœ°å€ï¼Œè¯¥å‡½æ•°çš„æ‰§è¡Œå°†è¢«å»¶æœŸã€‚<code>data</code> ç”¨ä½œè¯¥å‡½æ•°æ‰§è¡Œæ—¶çš„å‚æ•°ã€‚</p><blockquote><p> <code>data</code> æ˜¯ <code>unsigned long</code> ç±»å‹çš„ï¼Œæ‰€ä»¥æ³¨æ„å®ƒå¯èƒ½æ˜¯ä½œä¸ºæŒ‡é’ˆï¼ˆå€¼ä¸ºå†…å­˜åœ°å€ï¼‰æ¥ç”¨ï¼Œè€Œä¸æ˜¯å•çº¯çš„æ•°å­—ã€‚å†…æ ¸ä¸­ç»å¸¸è¿™æ ·ç”¨ã€‚</p></blockquote></li><li><p><code>state</code> è¡¨ç¤ºä»»åŠ¡çš„å½“å‰çŠ¶æ€ï¼Œç±»ä¼¼äºçœŸæ­£çš„è¿›ç¨‹ã€‚ä½†åªæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œåˆ†åˆ«ç”± <code>state</code> ä¸­çš„ä¸€ä¸ªæ¯”ç‰¹ä½è¡¨ç¤ºï¼Œè¿™ä¹Ÿæ˜¯äºŒè€…å¯ä»¥ç‹¬ç«‹è®¾ç½®&#x2F;æ¸…é™¤çš„åŸå› ã€‚</p><ul><li>åœ¨ <code>tasklet</code> æ³¨å†Œåˆ°å†…æ ¸ï¼Œç­‰å¾…è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå°†è®¾ç½® <code>TASKLET_STATE_SCHED</code>ã€‚</li><li><code>TASKLET_STATE_RUN</code> è¡¨ç¤º <code>tasklet</code> å½“å‰æ­£åœ¨æ‰§è¡Œã€‚ç¬¬äºŒä¸ªçŠ¶æ€åªåœ¨ <code>SMP</code> ç³»ç»Ÿä¸Šæœ‰ç”¨ã€‚ç”¨äºä¿æŠ¤ <code>tasklet</code> åœ¨å¤šä¸ªå¤„ç†å™¨ä¸Šå¹¶è¡Œæ‰§è¡Œã€‚</li></ul></li><li><p>åŸå­è®¡æ•°å™¨ <code>count</code> ç”¨äºç¦ç”¨å·²ç»è°ƒåº¦çš„ <code>tasklet</code>ã€‚å¦‚æœå…¶å€¼ä¸ç­‰äº 0ï¼Œåœ¨æ¥ä¸‹æ¥æ‰§è¡Œæ‰€æœ‰å¾…å†³çš„ <code>tasklet</code> æ—¶ï¼Œå°†å¿½ç•¥å¯¹åº”çš„ <code>tasklet</code>ã€‚</p></li></ul><p>è¿™ä¸ª <code>satat</code> ç”¨äºå¯¹ <code>tasklet</code> åŠ é”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L678</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">tasklet_trylock</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span> !test_and_set_bit(TASKLET_STATE_RUN, &amp;(t)-&gt;state);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">tasklet_unlock</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></span><br><span class="line">&#123;</span><br><span class="line">        smp_mb__before_atomic();</span><br><span class="line">        clear_bit(TASKLET_STATE_RUN, &amp;(t)-&gt;state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨å†Œ-tasklet"><a href="#æ³¨å†Œ-tasklet" class="headerlink" title="æ³¨å†Œ tasklet"></a>æ³¨å†Œ tasklet</h3><p><code>tasklet_schedule</code> å°†ä¸€ä¸ª <code>tasklet</code> æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ã€‚æ›´å‡†ç¡®åœ°æ¥è¯´ï¼Œæ˜¯æ³¨å†Œåˆ°è°ƒç”¨ <code>tasklet_schedule</code> è¿™ä¸ªå‡½æ•°çš„ <code>core</code> ä¸­ã€‚æ¯ä¸ªæ ¸ä¼šç»´æŠ¤ä¸€ä¸ªé“¾è¡¨ <code>tasklet_vec</code>ï¼Œå®ƒçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª <code>tasklet_struct</code> å®ä¾‹ï¼Œè¡¨ç¤ºè¦æ‰§è¡Œçš„ä»»åŠ¡ <code>tasklet</code>ã€‚</p><p><code>tasklet_schedule</code> ç”¨äºå°†æŒ‡å®šçš„ <code>tasklet</code> æ·»åŠ åˆ°é“¾è¡¨ <code>tasklet_vec</code> æœ«å°¾ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L502</span></span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_PER_CPU</span><span class="params">(<span class="keyword">struct</span> tasklet_head, tasklet_vec)</span>;</span><br><span class="line"><span class="type">static</span> <span class="title function_">DEFINE_PER_CPU</span><span class="params">(<span class="keyword">struct</span> tasklet_head, tasklet_hi_vec)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L685</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">tasklet_schedule</span><span class="params">(<span class="keyword">struct</span> tasklet_struct *t)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (!test_and_set_bit(TASKLET_STATE_SCHED, &amp;t-&gt;state))</span><br><span class="line">                __tasklet_schedule(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L521</span></span><br><span class="line"><span class="type">void</span> __tasklet_schedule(<span class="keyword">struct</span> tasklet_struct *t)</span><br><span class="line">&#123;</span><br><span class="line">        __tasklet_schedule_common(t, &amp;tasklet_vec,</span><br><span class="line">                                  TASKLET_SOFTIRQ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __tasklet_schedule_common(<span class="keyword">struct</span> tasklet_struct *t,</span><br><span class="line">                                      <span class="keyword">struct</span> tasklet_head __percpu *headp,</span><br><span class="line">                                      <span class="type">unsigned</span> <span class="type">int</span> softirq_nr)</span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tasklet_head</span> *<span class="title">head</span>;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line"></span><br><span class="line">        local_irq_save(flags);</span><br><span class="line">        head = this_cpu_ptr(headp);</span><br><span class="line">        t-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">        *head-&gt;tail = t;</span><br><span class="line">        head-&gt;tail = &amp;(t-&gt;next);</span><br><span class="line">        raise_softirq_irqoff(softirq_nr); <span class="comment">// å¼•èµ·ä¸€æ¬¡ TASKLET_SOFTIRQ è½¯ä¸­æ–­ï¼Œä»¥ä¾¿æ‰§è¡Œ tasklet</span></span><br><span class="line">        local_irq_restore(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å…³äº <code>tasklet_vec</code> å˜é‡ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ª <code>per_cpu</code> å˜é‡ï¼Œæ¯ä¸ªæ ¸éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„é“¾è¡¨ã€‚å…¶æ¬¡ï¼Œæ¯ä¸ªæ ¸ä¸Šçš„ä»»åŠ¡ <code>tasklet</code> åªèƒ½ç”±å®ƒè‡ªå·±å¤„ç†ï¼Œå…¶ä»–æ ¸ä¸ä¼šå¸®å¿™å¤„ç†ï¼Œå› æ­¤å¯èƒ½å°±ä¼šæ¶‰åŠåˆ°å¦‚ä½•åˆç†çš„åˆ†é… <code>tasklet</code>ã€‚</p><p>æ­¤å¤–ï¼Œ<code>tasklet</code> æ‰§è¡Œå®Œæ¯•åæ˜¯å¦ä¼šä» <code>tasklet_vec</code> ä¸Šç§»é™¤ï¼Ÿ</p></blockquote><h3 id="æ‰§è¡Œ-tasklet"><a href="#æ‰§è¡Œ-tasklet" class="headerlink" title="æ‰§è¡Œ tasklet"></a>æ‰§è¡Œ tasklet</h3><p><code>tasklet</code> çš„ç”Ÿå‘½å‘¨æœŸä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯å…¶æ‰§è¡Œã€‚å› ä¸º <code>tasklet</code> åŸºäºè½¯ä¸­æ–­å®ç°ï¼Œå®ƒä»¬æ€»æ˜¯åœ¨å¤„ç†è½¯ä¸­æ–­æ—¶æ‰§è¡Œã€‚</p><p><code>tasklet</code> å…³è”åˆ° <code>TASKLET_SOFTIRQ</code> è½¯ä¸­æ–­ã€‚å› è€Œï¼Œè°ƒç”¨ <code>raise_softirq(TASKLET_SOFTIRQ)</code>ï¼Œå³å¯åœ¨ä¸‹ä¸€ä¸ªé€‚å½“çš„æ—¶æœºæ‰§è¡Œå½“å‰å¤„ç†å™¨çš„ <code>tasklet</code>ã€‚å†…æ ¸ä½¿ç”¨ <code>tasklet_action</code> ä½œä¸ºè¯¥è½¯ä¸­æ–­çš„ <code>action</code> å‡½æ•°ã€‚</p><blockquote><p>è¿™ä¸ªå‡½æ•°ä¼šå– <code>tasklet_vec</code> é“¾è¡¨ä¸­çš„ <code>tasklet</code> ä¾æ¬¡æ‰§è¡Œ</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L636</span></span><br><span class="line">open_softirq(TASKLET_SOFTIRQ, tasklet_action);</span><br><span class="line">open_softirq(HI_SOFTIRQ, tasklet_hi_action);</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L576</span></span><br><span class="line"><span class="type">static</span> __latent_entropy <span class="type">void</span> <span class="title function_">tasklet_action</span><span class="params">(<span class="keyword">struct</span> softirq_action *a)</span></span><br><span class="line">&#123;</span><br><span class="line">        tasklet_action_common(a, this_cpu_ptr(&amp;tasklet_vec), TASKLET_SOFTIRQ);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">tasklet_action_common</span><span class="params">(<span class="keyword">struct</span> softirq_action *a,</span></span><br><span class="line"><span class="params">                                  <span class="keyword">struct</span> tasklet_head *tl_head,</span></span><br><span class="line"><span class="params">                                  <span class="type">unsigned</span> <span class="type">int</span> softirq_nr)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">list</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿™é‡Œæ¸…ç©ºäº† tasklet_vec é“¾è¡¨çš„ï¼Œç”¨ä¸´æ—¶å˜é‡ list æ¥è®¿é—® âœ¨</span></span><br><span class="line">        <span class="comment">// å› ä¸ºé¢„æœŸæ˜¯ä¼šå°†æ‰€æœ‰ tasklet æ‰§è¡Œçš„ï¼Œå¦‚æœå‡ºç°äº†æ„å¤–æƒ…å†µï¼Œå†æ·»åŠ å›æ¥</span></span><br><span class="line">        local_irq_disable();</span><br><span class="line">        <span class="built_in">list</span> = tl_head-&gt;head;</span><br><span class="line">        tl_head-&gt;head = <span class="literal">NULL</span>;</span><br><span class="line">        tl_head-&gt;tail = &amp;tl_head-&gt;head;</span><br><span class="line">        local_irq_enable();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">list</span>) &#123;</span><br><span class="line">                <span class="comment">// éå†å•å‘é“¾è¡¨ï¼Œä¾æ¬¡æ‰§è¡Œ</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">t</span> =</span> <span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">list</span> = <span class="built_in">list</span>-&gt;next;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// è¿™ä¸ªåŠ é”ã€è§£é”ï¼Œå°±æ˜¯å‰é¢æåˆ°çš„ state æ ‡å¿—ä½çš„å¤„ç†</span></span><br><span class="line">                <span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L678</span></span><br><span class="line">                <span class="keyword">if</span> (tasklet_trylock(t)) &#123;</span><br><span class="line">                        <span class="comment">// åªæœ‰è¿™ä¸ªåŸå­è®¡æ•°ä¸º 0 æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œè¯¥ tasklet</span></span><br><span class="line">                        <span class="keyword">if</span> (!<span class="type">atomic_read</span>(&amp;t-&gt;count)) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (!test_and_clear_bit(TASKLET_STATE_SCHED,</span><br><span class="line">                                                        &amp;t-&gt;state))</span><br><span class="line">                                        BUG();</span><br><span class="line">                                <span class="comment">// è°ƒç”¨ tasklet å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆ</span></span><br><span class="line">                                <span class="keyword">if</span> (t-&gt;use_callback)</span><br><span class="line">                                        t-&gt;callback(t);</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                        t-&gt;func(t-&gt;data);</span><br><span class="line">                                tasklet_unlock(t);</span><br><span class="line">                                <span class="comment">// å¤„ç†å®Œå°±ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª tasklet</span></span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        tasklet_unlock(t);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åªæœ‰å½“ tasklet å·²ç»åœ¨å…¶ä»–æ ¸å¤„ç†äº†æ—¶ï¼ŒåŠ é”å¤±è´¥æ‰ä¼šåˆ°è¿™é‡Œã€‚</span></span><br><span class="line">                local_irq_disable();</span><br><span class="line">                t-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                *tl_head-&gt;tail = t;</span><br><span class="line">                tl_head-&gt;tail = &amp;t-&gt;next;</span><br><span class="line">                __raise_softirq_irqoff(softirq_nr);</span><br><span class="line">                local_irq_enable();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å› ä¸ºä¸€ä¸ª <code>tasklet</code> åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œä¸€æ¬¡ï¼Œä½†å…¶ä»–çš„ <code>tasklet</code> å¯ä»¥å¹¶è¡Œè¿è¡Œï¼Œæ‰€ä»¥éœ€è¦ç‰¹å®šäº <code>tasklet</code> çš„é”</strong>ã€‚ <code>state</code> çŠ¶æ€ç”¨ä½œé”å˜é‡ã€‚åœ¨æ‰§è¡Œä¸€ä¸ª <code>tasklet</code> çš„å¤„ç†ç¨‹åºå‡½æ•°ä¹‹å‰ï¼Œå†…æ ¸ä½¿ç”¨ <code>tasklet_trylock</code> æ£€æŸ¥ <code>tasklet</code> çš„çŠ¶æ€æ˜¯å¦ä¸º <code>TASKLET_STATE_RUN</code>ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯å¦å·²ç»åœ¨ç³»ç»Ÿçš„å¦ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œ</p><blockquote><p>ğŸ§ ğŸ§ è¿™é‡Œ <code>tasklet</code> ç”¨å®Œä¹‹åï¼Œæ²¡æœ‰é”€æ¯ <code>free</code> è¯¶ï¼Ÿä¸æ€•å†…å­˜æ³„æ¼å—ï¼Ÿ</p><p><code>tasklet</code> ä¸æ˜¯æ¯ä¸€ä¸ªæ ¸æ‰§è¡Œå®ƒè‡ªå·±çš„å—ï¼Ÿä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ª <code>tasklet</code> å¯èƒ½åœ¨å…¶ä»–æ ¸ä¸Šé¢æ‰§è¡Œï¼Ÿ</p></blockquote><h3 id="HI-SOFTIRQ"><a href="#HI-SOFTIRQ" class="headerlink" title="HI_SOFTIRQ"></a>HI_SOFTIRQ</h3><p>é™¤äº†æ™®é€šçš„ <code>tasklet</code> ä¹‹å¤–ï¼Œå†…æ ¸è¿˜ä½¿ç”¨äº†å¦ä¸€ç§ <code>tasklet</code>ï¼Œå®ƒå…·æœ‰â€œè¾ƒé«˜â€çš„ä¼˜å…ˆçº§ã€‚é™¤ä»¥ä¸‹ä¿®æ”¹ä¹‹å¤–ï¼Œå…¶å®ç°ä¸æ™®é€šçš„ <code>tasklet</code> å®Œå…¨ç›¸åŒã€‚</p><ol><li><p>ä½¿ç”¨ <code>HI_SOFTIRQ</code> ä½œä¸ºè½¯ä¸­æ–­ï¼Œè€Œä¸æ˜¯ <code>TASKLET_SOFTIRQ</code>ï¼Œç›¸å…³çš„ <code>action</code> å‡½æ•°æ˜¯ <code>tasklet_hi_action</code>ã€‚</p></li><li><p>æ³¨å†Œçš„ <code>tasklet</code> åœ¨ CPU ç›¸å…³çš„å˜é‡ <code>tasklet_hi_vec</code> ä¸­æ’é˜Ÿã€‚è¿™æ˜¯ä½¿ç”¨ <code>tasklet_hi_schedule</code> å®Œæˆçš„ã€‚</p></li></ol><p>åœ¨è¿™é‡Œï¼Œâ€œè¾ƒé«˜ä¼˜å…ˆçº§â€æ˜¯æŒ‡è¯¥è½¯ä¸­æ–­çš„å¤„ç†ç¨‹åº <code>HI_SOFTIRQ</code> åœ¨æ‰€æœ‰å…¶ä»–å¤„ç†ç¨‹åºä¹‹å‰æ‰§è¡Œï¼Œ<strong>å°¤å…¶æ˜¯åœ¨æ„æˆäº†è½¯ä¸­æ–­æ´»åŠ¨ä¸»ä½“çš„ç½‘ç»œå¤„ç†ç¨‹åºä¹‹å‰æ‰§è¡Œ</strong>ã€‚</p><blockquote><p>æ‰€æœ‰è½¯ä¸­æ–­å…¶å®æœ¬è´¨ä¸Šéƒ½æ˜¯ç”± <code>ksoftirqd</code> å†³å®šçš„è¾ƒä½ä¼˜å…ˆçº§ï¼Œåªä¸è¿‡ä¸åŒç±»å‹çš„è½¯ä¸­æ–­ä¹‹é—´ï¼Œä¼˜å…ˆçº§ç•¥æœ‰åŒºåˆ«ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œè€Œå·²ã€‚è¿™é‡Œè¯´çš„è¾ƒé«˜ä¼˜å…ˆçº§ä¹Ÿä»…ä»…æ˜¯è¿™ä¸ªæ„æ€ã€‚æ¯•ç«Ÿ <code>HI_SOFTIRQ</code> æ˜¯æ‰€æœ‰è½¯ä¸­æ–­ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„äº†ã€‚ğŸ›«ğŸ›«è€Œä¸”è½¯ä¸­æ–­çš„ä¸»è¦å¼€é”€å°±æ˜¯å¤„ç†ç½‘ç»œæ”¶å‘åŒ…ï¼Œåªè¦ä¼˜å…ˆçº§æ¯”ç½‘ç»œæ”¶å‘åŒ…é«˜ï¼Œå°±èƒ½å¤Ÿå¾ˆå¿«åœ°æ‰§è¡Œäº†ã€‚</p></blockquote><p>å½“å‰ï¼Œå¤§éƒ¨åˆ†å£°å¡é©±åŠ¨ç¨‹åºéƒ½åˆ©ç”¨äº†è¿™ä¸€é€‰é¡¹ï¼Œå› ä¸ºæ“ä½œå»¶è¿Ÿæ—¶é—´å¤ªé•¿å¯èƒ½æŸå®³éŸ³é¢‘è¾“å‡ºçš„éŸ³è´¨ã€‚<strong>è€Œç”¨äºé«˜é€Ÿä¼ è¾“çš„ç½‘å¡ä¹Ÿå¯ä»¥å¾—ç›Šäºè¯¥æœºåˆ¶</strong>ã€‚</p><blockquote><p>ğŸ˜®ğŸ˜®ä¸§å¿ƒç—…ç‹‚äº†å§ï¼Œç½‘ç»œæ”¶å‘åŒ…çš„ä¼˜å…ˆçº§æœ¬æ¥å°±ä»…æ¬¡äº <code>HI</code>ã€<code>TIMER</code>ï¼Œè¿™éƒ½è¿˜è¦æ¥æŠ¢ <code>HI</code> ï¼Ÿ</p></blockquote><p>ç®€å•çœ‹çœ‹ä»£ç ï¼Œåªèƒ½å’Œä¸Šé¢è¯´ä¸€æ¨¡ä¸€æ ·âœ¨âœ¨å°±ä¼˜å…ˆå¤„ç†äº†è€Œå·²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L581</span></span><br><span class="line"><span class="type">static</span> __latent_entropy <span class="type">void</span> <span class="title function_">tasklet_hi_action</span><span class="params">(<span class="keyword">struct</span> softirq_action *a)</span></span><br><span class="line">&#123;</span><br><span class="line">        tasklet_action_common(a, this_cpu_ptr(&amp;tasklet_hi_vec), HI_SOFTIRQ);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><ul><li>ä¸€ç§ç‰¹å®šç±»å‹çš„ <code>tasklet</code> åªèƒ½è¿è¡Œåœ¨ä¸€ä¸ª <code>CPU</code> ä¸Šï¼Œä¸èƒ½å¹¶è¡Œï¼Œåªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚</li><li>å¤šä¸ªä¸åŒç±»å‹çš„ <code>tasklet</code> å¯ä»¥å¹¶è¡Œåœ¨å¤šä¸ª <code>CPU</code> ä¸Šã€‚</li><li>è½¯ä¸­æ–­æ˜¯é™æ€åˆ†é…çš„ï¼Œåœ¨å†…æ ¸ç¼–è¯‘å¥½ä¹‹åï¼Œå°±ä¸èƒ½æ”¹å˜ã€‚ä½† <code>tasklet</code> å°±çµæ´»è®¸å¤šï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ”¹å˜ï¼ˆæ¯”å¦‚æ·»åŠ æ¨¡å—æ—¶ï¼‰ã€‚</li><li>è½¯ä¸­æ–­ä¸­ä¸å…è®¸ç¡çœ ï¼Œè€Œ <code>tasklet</code> åŒæ ·æ˜¯åœ¨è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ï¼Œå› æ­¤åŒæ ·ä¸å…è®¸ç¡çœ ã€‚è€Œä¸‹æ–‡æ‰€æåˆ°çš„<strong>å·¥ä½œé˜Ÿåˆ—</strong>æ˜¯å…è®¸ç¡çœ çš„ã€‚</li></ul><h2 id="å®Œæˆé‡"><a href="#å®Œæˆé‡" class="headerlink" title="å®Œæˆé‡"></a>å®Œæˆé‡</h2><p>å®Œæˆé‡ä¸ä¿¡å·é‡æœ‰äº›ç›¸ä¼¼ï¼Œä½†æ˜¯åŸºäºç­‰å¾…é˜Ÿåˆ—å®ç°çš„ã€‚</p><h2 id="å·¥ä½œé˜Ÿåˆ—"><a href="#å·¥ä½œé˜Ÿåˆ—" class="headerlink" title="å·¥ä½œé˜Ÿåˆ—"></a>å·¥ä½œé˜Ÿåˆ—</h2><blockquote><p>å·¥ä½œé˜Ÿåˆ—å…¶å®å’Œ <code>ksoftirqd + tasklet</code> ç±»ä¼¼ï¼Œä¸è¿‡å®ƒä¸æ˜¯å·¥ä½œåœ¨è½¯ä¸­æ–­çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè€Œæ˜¯æ™®é€šçš„å†…æ ¸çº¿ç¨‹ã€‚æ­¤å¤–è¿›ç¨‹çš„æ•°é‡ä¹Ÿä¸åœ¨å±€é™äº <code>core</code> çš„æ•°é‡ï¼Œå‡ ä¹å¯ä»¥ä»»æ„åˆ›å»ºã€‚è¿›ç¨‹åä»¥ <code>kworker</code> ä¸ºå‰ç¼€ï¼</p><p>å…¶å®è¿˜æ˜¯å’Œçº¿ç¨‹æ± çš„åŸç†ç›¸ä¼¼çš„ã€‚</p></blockquote><p>å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å¤–ä¸€ä¸ªå¤„ç†å»¶åå‡½æ•°çš„æ¦‚å¿µï¼Œå®ƒå¤§ä½“ä¸Šå’Œ <code>tasklets</code> ç±»ä¼¼ã€‚å·¥ä½œé˜Ÿåˆ—è¿è¡Œäºå†…æ ¸è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œè€Œ <code>tasklets</code> è¿è¡Œäºè½¯ä¸­æ–­ä¸Šä¸‹æ–‡ã€‚è¿™æ„å‘³ç€å·¥ä½œé˜Ÿåˆ—å‡½æ•°ä¸å¿…åƒ <code>tasklets</code> ä¸€æ ·å¿…é¡»æ˜¯åŸå­æ€§çš„ã€‚<code>Tasklets</code> æ€»æ˜¯è¿è¡Œäºå®ƒæäº¤è‡ªçš„é‚£ä¸ªå¤„ç†å™¨ï¼Œå·¥ä½œé˜Ÿåˆ—åœ¨é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯è¿™æ ·ã€‚å·¥ä½œé˜Ÿåˆ—åœ¨ <code>Linux</code> å†…æ ¸ä»£ç  <a href="https://elixir.bootlin.com/linux/v5.10.186/source/kernel/workqueue.c#L200">kernel&#x2F;workqueue.c</a> ä¸­ç”±å¦‚ä¸‹çš„æ•°æ®ç»“æ„è¡¨ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pool_workqueue</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">worker_pool</span>      *<span class="title">pool</span>;</span>          <span class="comment">/* I: the associated pool */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">wq</span>;</span>            <span class="comment">/* I: the owning workqueue */</span></span><br><span class="line">        <span class="type">int</span>                     work_color;     <span class="comment">/* L: current color */</span></span><br><span class="line">        <span class="type">int</span>                     flush_color;    <span class="comment">/* L: flushing color */</span></span><br><span class="line">        <span class="type">int</span>                     refcnt;         <span class="comment">/* L: reference count */</span></span><br><span class="line">        <span class="type">int</span>                     nr_in_flight[WORK_NR_COLORS];</span><br><span class="line">                                                <span class="comment">/* L: nr of in_flight works */</span></span><br><span class="line">        <span class="type">int</span>                     nr_active;      <span class="comment">/* L: nr of active works */</span></span><br><span class="line">        <span class="type">int</span>                     max_active;     <span class="comment">/* L: max active works */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">inactive_works</span>;</span> <span class="comment">/* L: inactive works */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">pwqs_node</span>;</span>      <span class="comment">/* WR: node on wq-&gt;pwqs */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>        <span class="title">mayday_node</span>;</span>    <span class="comment">/* MD: node on wq-&gt;maydays */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Release of unbound pwq is punted to system_wq.  See put_pwq()</span></span><br><span class="line"><span class="comment">         * and pwq_unbound_release_workfn() for details.  pool_workqueue</span></span><br><span class="line"><span class="comment">         * itself is also RCU protected so that the first pwq can be</span></span><br><span class="line"><span class="comment">         * determined without grabbing wq-&gt;mutex.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span>      <span class="title">unbound_release_work</span>;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>         <span class="title">rcu</span>;</span></span><br><span class="line">&#125; __aligned(<span class="number">1</span> &lt;&lt; WORK_STRUCT_FLAG_BITS);</span><br></pre></td></tr></table></figure><p>å·¥ä½œé˜Ÿåˆ—æœ€åŸºç¡€çš„ç”¨æ³•ï¼Œæ˜¯ä½œä¸ºåˆ›å»ºå†…æ ¸çº¿ç¨‹çš„æ¥å£æ¥å¤„ç†æäº¤åˆ°é˜Ÿåˆ—é‡Œçš„å·¥ä½œä»»åŠ¡ã€‚æ‰€æœ‰è¿™äº›å†…æ ¸çº¿ç¨‹ç§°ä¹‹ä¸º <code>worker thread</code>ã€‚å·¥ä½œé˜Ÿåˆ—å†…çš„ä»»åŠ¡æ˜¯ç”±ä»£ç  <a href="https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/workqueue.h#L102">include&#x2F;linux&#x2F;workqueue.h</a> ä¸­å®šä¹‰çš„ <code>work_struct</code> è¡¨ç¤ºçš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> &#123;</span></span><br><span class="line">        <span class="type">atomic_long_t</span> data;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span></span><br><span class="line">        <span class="type">work_func_t</span> func;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">lockdep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤ä¸ªå­—æ®µæ¯”è¾ƒæœ‰æ„æ€ï¼š<code>func</code> â€“å°†è¢«å·¥ä½œé˜Ÿåˆ—è°ƒåº¦æ‰§è¡Œçš„å‡½æ•°ï¼Œ<code>data</code> â€“è¿™ä¸ªå‡½æ•°çš„å‚æ•°ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆå†…æ ¸ä½¿ç”¨ <code>atomic_long_t</code> ä½œä¸ºæŒ‡å‘ä»»æ„æ•°æ®çš„æŒ‡é’ˆçš„æ•°æ®ç±»å‹ï¼Œè€Œä¸æ˜¯é€šå¸¸çš„ <code>void *</code>ï¼Ÿ</p><p>è¿™é‡Œå†…æ ¸ä½¿ç”¨äº†ä¸€ç‚¹å°æŠ€å·§ï¼Œæ˜¾ç„¶æœ‰ç‚¹è¿‘ä¹äºâ€œè‚®è„â€ï¼Œä»¥ä¾¿å°†æ›´å¤šä¿¡æ¯æ”¾å…¥è¯¥ç»“æ„ï¼Œè€Œåˆä¸ä»˜å‡ºæ›´å¤šä»£ä»·ã€‚å› ä¸ºæŒ‡é’ˆåœ¨æ‰€æœ‰æ”¯æŒçš„ä½“ç³»ç»“æ„ä¸Šéƒ½å¯¹é½åˆ° 4 å­—èŠ‚è¾¹ç•Œï¼Œè€Œå‰ä¸¤ä¸ªæ¯”ç‰¹ä½ä¿è¯ä¸º 0ã€‚å› è€Œå¯ä»¥â€œæ»¥ç”¨â€è¿™ä¸¤ä¸ªæ¯”ç‰¹ä½ï¼Œå°†å…¶ç”¨ä½œæ ‡å¿—ä½ã€‚å‰©ä½™çš„æ¯”ç‰¹ä½ç…§æ—§ä¿å­˜æŒ‡é’ˆçš„ä¿¡æ¯ã€‚ä»¥ä¸‹çš„å®ç”¨äºå±è”½æ ‡å¿—ä½ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/workqueue.h#L90</span></span><br><span class="line">WORK_STRUCT_FLAG_MASK = (<span class="number">1UL</span> &lt;&lt; WORK_STRUCT_FLAG_BITS) - <span class="number">1</span>,</span><br><span class="line">WORK_STRUCT_WQ_DATA_MASK = ~WORK_STRUCT_FLAG_MASK,</span><br></pre></td></tr></table></figure><p>å½“å‰åªå®šä¹‰äº†ä¸€ä¸ªæ ‡å¿—ï¼š<code>WORK_STRUCT_PENDING</code> ç”¨æ¥æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰å¾…å†³ï¼ˆè¯¥æ ‡å¿—ä½ç½®ä½ï¼‰çš„å¯å»¶è¿Ÿå·¥ä½œé¡¹ã€‚è¾…åŠ©å® <code>work_pending(work)</code>ç”¨æ¥æ£€æŸ¥è¯¥æ ‡å¿—ä½ã€‚è¯·æ³¨æ„ï¼Œå°† <code>data</code> è®¾ç½®ä¸ºåŸå­æ•°æ®ç±»å‹ï¼Œç¡®ä¿å¯¹è¯¥æ¯”ç‰¹ä½çš„ä¿®æ”¹ä¸ä¼šå¸¦æ¥å¹¶å‘é—®é¢˜ã€‚</p></blockquote><h3 id="å°ç»“-2"><a href="#å°ç»“-2" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>â­â­ğŸ”¥ğŸ”¥ã€Šæ·±å…¥ Linux å†…æ ¸æ¶æ„ã€‹ç¬¬ 14 ç« ï¼Œä¹¦è®²å¾—æ›´å¥½ä¸€äº›ï¼Œä¸‹é¢çš„å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</li><li>â­â­ğŸ”¥ğŸ”¥<a href="https://github.com/MintCN/linux-insides-zh/blob/master/Interrupts/README.md">ã€ŠLinux å†…æ ¸æ­ç§˜ã€‹</a> è¿™æœ¬ä¹¦è®²å¾—ä¹Ÿå¾ˆå¥½ï¼Œè€Œä¸”æ›´è´´è¿‘ä»£ç è®²è§£ã€‚</li><li><a href="https://www.xiaolincoding.com/os/1_hardware/soft_interrupt.html#%E4%B8%AD%E6%96%AD%E6%98%AF%E4%BB%80%E4%B9%88">ä»€ä¹ˆæ˜¯è½¯ä¸­æ–­</a></li><li><a href="https://zhuanlan.zhihu.com/p/265705850">Linux å†…æ ¸ä¸­çš„è½¯ä¸­æ–­ã€tasklet å’Œå·¥ä½œé˜Ÿåˆ—è¯¦è§£</a></li><li><a href="https://www.toutiao.com/article/7153606983776731651/?wid=1693292862137">ç†è§£å†…æ ¸çš„ç¡¬è½¯ä¸­æ–­ï¼ˆè¯¦ç»†è®²è§£~ï¼‰</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è®¾å¤‡æ ‘è¯­æ³•ä»‹ç»</title>
      <link href="/2023/08/08/Linux%E5%86%85%E6%A0%B8-%E8%AE%BE%E5%A4%87%E6%A0%91/"/>
      <url>/2023/08/08/Linux%E5%86%85%E6%A0%B8-%E8%AE%BE%E5%A4%87%E6%A0%91/</url>
      
        <content type="html"><![CDATA[<h2 id="è®¾å¤‡æ ‘è¯­æ³•"><a href="#è®¾å¤‡æ ‘è¯­æ³•" class="headerlink" title="è®¾å¤‡æ ‘è¯­æ³•"></a>è®¾å¤‡æ ‘è¯­æ³•</h2><ol><li><p>ä»€ä¹ˆæ˜¯è®¾å¤‡ï¼Ÿ<br> ç›´è§‚ç‚¹ï¼šé”®ç›˜ã€é¼ æ ‡ã€å†…å­˜ã€CPUã€æ˜¾ç¤ºå™¨ã€<code>wifi</code>ã€ç½‘å¡ã€æ˜¾å¡æ˜¯è®¾å¤‡ã€‚<br> åº•å±‚ç‚¹ï¼š<code>SPI</code> ã€<code>I2C</code>ã€<code>I2S</code> ã€<code>mipi</code>ã€<code>gpio</code>ã€<code>USB</code> ç­‰æ§åˆ¶å™¨ã€‚</p></li><li><p>Linux &#x2F; Uboot æ˜¯å¦‚ä½•ç®¡ç†è¿™äº›è®¾å¤‡çš„å‘¢ï¼Ÿ<br> <strong>çˆ¶å­å…³ç³»</strong><br> <code>I2C</code> ç­‰æ§åˆ¶å™¨ä¸é€šè¿‡è¯¥æ§åˆ¶å™¨æ¥å…¥çš„è®¾å¤‡ï¼Œæ˜æ˜¾å°±æ˜¯çˆ¶å­å…³ç³»ã€‚<br> <strong>æ ¹è®¾å¤‡</strong></p><p> <code>SPI</code>ã€ <code>I2C</code> æ§åˆ¶å™¨è¿™æ ·çœ‹èµ·æ¥æ²¡æœ‰å…³è”çš„è®¾å¤‡ï¼Œä»–ä»¬å°±ç›´æ¥æŒ‚é åœ¨æ ¹è®¾å¤‡ä¸‹ã€‚</p><p> <img src="/../images/Linux%E5%86%85%E6%A0%B8-%E8%AE%BE%E5%A4%87%E6%A0%91/image-20231230124213784.png" alt="image-20231230124213784"></p></li><li><p>ä¸ºä»€ä¹ˆè¦æœ‰è®¾å¤‡æ ‘ï¼Ÿ</p><p> è¿™ä¸ªå’Œ Linux çš„è®¾å¤‡-é©±åŠ¨æ¨¡å‹å¯¹åº”ï¼Œé©±åŠ¨ - è®¾å¤‡åˆ†ç¦»ï¼Œé€šè¿‡ <code>Kconfig</code> å®šä¹‰çš„é…ç½®é¡¹å†³å®šæ˜¯å¦å¯ç”¨é©±åŠ¨ã€‚è®¾å¤‡æ˜¯å¦å¯ç”¨åˆ™æ˜¯ç”±è®¾å¤‡æ ‘æ¥å†³å®šã€‚<br> Linux æ”¯æŒçš„è®¾å¤‡ç±»å‹å¾ˆå¤šå¾ˆå¤šï¼Œä¸å¯èƒ½å°†æ‰€æœ‰è®¾å¤‡éƒ½å¯ç”¨ï¼ˆä¼šæµªè´¹å¤§é‡çš„å†…å­˜ã€CPUèµ„æºï¼‰ã€‚è®¾å¤‡æ ‘å°±æ˜¯ç”¨æ¥å‘Šè¯‰ Kernel éœ€è¦å¯ç”¨å“ªäº›è®¾å¤‡ã€‚</p></li></ol><h2 id="è¯­æ³•è¯´æ˜"><a href="#è¯­æ³•è¯´æ˜" class="headerlink" title="è¯­æ³•è¯´æ˜"></a>è¯­æ³•è¯´æ˜</h2><p><strong>è®¾å¤‡æ ‘ <code>dtsi</code> æ–‡ä»¶ä¸­ä½¿ç”¨ c è¯­è¨€çš„æ–¹å¼æ³¨é‡Š <code>/* æ³¨é‡Š */</code> ä»¥åŠ <code>// æ³¨é‡Š</code>ï¼Œç‰¹åˆ«æ³¨æ„ <code>#</code> æ˜¯æœ‰ç‰¹æ®Šæ„ä¹‰çš„ï¼Œä¸æ˜¯æ³¨é‡Šï¼ï¼</strong></p><p>è®¾å¤‡ä¹‹é—´çš„çˆ¶å­å…³ç³»ï¼Œç”¨æ–‡æœ¬è¡¨ç¤ºå‡ºæ¥æ˜¯ç”¨ <code>&#123;&#125;</code> ç®¡ç†çš„åŒ…å«å…³ç³»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/ &#123; <span class="comment">// â€˜/â€™ è¡¨ç¤ºæ ¹è®¾å¤‡</span></span><br><span class="line">spi0: spi0@<span class="number">04180000</span> &#123; <span class="comment">// spi0 æ˜¯ SPI æ§åˆ¶å™¨</span></span><br><span class="line">        compatible = <span class="string">&quot;snps,dw-apb-ssi&quot;</span>;</span><br><span class="line">        reg = &lt;<span class="number">0x0</span> <span class="number">0x04180000</span> <span class="number">0x0</span> <span class="number">0x10000</span>&gt;;</span><br><span class="line">        clocks = &lt;&amp;clk CV181X_CLK_SPI&gt;;</span><br><span class="line"></span><br><span class="line">panel@<span class="number">0</span> &#123; <span class="comment">// panel æ˜¯ SPI0 çš„ä¸€ä¸ªå­è®¾å¤‡</span></span><br><span class="line">            compatible = <span class="string">&quot;xxx,st7789v&quot;</span>;</span><br><span class="line">            spi-frequency = &lt;<span class="number">48000000</span>&gt;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¥½äº†ï¼Œæ¥ä¸‹æ¥å°±çœ‹ <a href="https://www.devicetree.org/">devicetree.org  çš„æ ‡å‡†æ–‡æ¡£</a>ï¼Œè‹±æ–‡çš„ï¼Œç¯‡å¹…ä¸é•¿ã€‚</p><h2 id="èŠ‚ç‚¹æ ¼å¼"><a href="#èŠ‚ç‚¹æ ¼å¼" class="headerlink" title="èŠ‚ç‚¹æ ¼å¼"></a><strong>èŠ‚ç‚¹æ ¼å¼</strong></h2><p>ä¸€ä¸ªèŠ‚ç‚¹å°±ä»£è¡¨ä¸€ä¸ªè®¾å¤‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label: node-name@unit-address</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼š</p><blockquote><ul><li>labelï¼šæ ‡ç­¾ï¼ˆå¯ä»¥çœç•¥ï¼‰ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸ºäº†æ–¹ä¾¿åœ°å¼•ç”¨ <code>node</code>ã€‚</li><li>node-nameï¼šèŠ‚ç‚¹åå­—ï¼Œè®¾å¤‡</li><li>unit-addressï¼šå•å…ƒåœ°å€ï¼ˆå¯ä»¥æ²¡æœ‰ï¼‰</li></ul></blockquote><h3 id="å¼•ç”¨èŠ‚ç‚¹"><a href="#å¼•ç”¨èŠ‚ç‚¹" class="headerlink" title="å¼•ç”¨èŠ‚ç‚¹"></a>å¼•ç”¨èŠ‚ç‚¹</h3><p><code>label</code> çš„ä½œç”¨æ˜¯ä¸ºäº†æ–¹ä¾¿åœ°å¼•ç”¨ <code>node</code>ã€‚å¼•ç”¨çš„ç›®çš„ä¸€èˆ¬æ˜¯ä¸ºäº† <strong>è¿½åŠ &#x2F;ä¿®æ”¹èŠ‚ç‚¹å†…å®¹</strong>ï¼Œæ¯”å¦‚ ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/dts-v1/;</span><br><span class="line">/&#123;</span><br><span class="line">    uart0: uart@fe001000 &#123;</span><br><span class="line">        compatible=<span class="string">&quot;ns16550&quot;</span>;</span><br><span class="line">        reg=&lt;<span class="number">0xfe001000</span> <span class="number">0x100</span>&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨ä¸‹é¢ 2 ç§æ–¹æ³•æ¥ä¿®æ”¹ <code>uart@fe001000</code> è¿™ä¸ª <code>node</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æ ¹èŠ‚ç‚¹ä¹‹å¤–ä½¿ç”¨ label å¼•ç”¨ node</span></span><br><span class="line">&amp;uart0 &#123;</span><br><span class="line">    status=<span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// æˆ–åœ¨æ ¹èŠ‚ç‚¹ä¹‹å¤–ä½¿ç”¨å…¨è·¯å¾„ï¼Œï¼ˆä¸ä½¿ç”¨æ ‡ç­¾ï¼‰</span></span><br><span class="line">&amp;&#123;/uart@fe001000&#125; &#123;</span><br><span class="line">    status=<span class="string">&quot;disabled&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å±æ€§æ ¼å¼"><a href="#å±æ€§æ ¼å¼" class="headerlink" title="å±æ€§æ ¼å¼"></a><strong>å±æ€§æ ¼å¼</strong></h2><p>ç®€å•åœ°è¯´ï¼Œ <code>properties</code> å°±æ˜¯ <code>name=value</code>ï¼Œ <code>value</code> æœ‰å¤šç§å–å€¼æ–¹å¼ã€‚ç¤ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸€ä¸ª 32 ä½çš„æ•°æ®ï¼Œç”¨å°–æ‹¬å·åŒ…å›´èµ·æ¥ï¼Œå¯ä»¥ç”¨åå…­è¿›åˆ¶ï¼Œä¹Ÿå¯ä»¥ç”¨åè¿›åˆ¶ï¼Œå¦‚</span></span><br><span class="line">interrupts = &lt;<span class="number">0xc</span>&gt;;</span><br><span class="line">interrupts = &lt;<span class="number">17</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸€ä¸ª 64 ä½æ•°æ®ï¼ˆåªèƒ½ä½¿ç”¨ 2 ä¸ª 32 ä½æ•°æ®è¡¨ç¤ºï¼‰ï¼Œç”¨å°–æ‹¬å·åŒ…å›´èµ·æ¥ï¼Œå¦‚ï¼š</span></span><br><span class="line">clock-frequency = &lt;<span class="number">0x00000001</span> <span class="number">0x00000000</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹Ÿå¯ä»¥ä¼ é€’å¤šä¸ªå€¼ï¼Œå…·ä½“çœ‹é©±åŠ¨å¦‚ä½•è§£æ</span></span><br><span class="line">test-property = &lt;<span class="number">11</span> <span class="number">22</span> <span class="number">33</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ‰ç»“æŸç¬¦çš„å­—ç¬¦ä¸²ï¼Œç”¨åŒå¼•å·åŒ…å›´èµ·æ¥ï¼Œå¦‚ï¼š</span></span><br><span class="line">compatible = <span class="string">&quot;simple-bus&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­—èŠ‚åºåˆ—ï¼Œç”¨ä¸­æ‹¬å·åŒ…å›´èµ·æ¥ï¼Œå¦‚ï¼š</span></span><br><span class="line">local-mac-address = [<span class="number">00</span> <span class="number">00</span> <span class="number">12</span> <span class="number">34</span> <span class="number">56</span> <span class="number">78</span>]; <span class="comment">// æ¯ä¸ª byte ä½¿ç”¨ 2 ä¸ª 16 è¿›åˆ¶æ•°æ¥è¡¨ç¤º</span></span><br><span class="line">local-mac-address = [<span class="number">000012345678</span>];      <span class="comment">// æ¯ä¸ª byte ä½¿ç”¨ 2 ä¸ª 16 è¿›åˆ¶æ•°æ¥è¡¨ç¤º</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯ä»¥æ˜¯å„ç§å€¼çš„ç»„åˆï¼Œç”¨é€—å·éš”å¼€ï¼Œå¦‚ï¼š</span></span><br><span class="line">compatible = <span class="string">&quot;ns16550&quot;</span>, <span class="string">&quot;ns8250&quot;</span>;</span><br><span class="line">example = &lt;<span class="number">0xf00f0000</span> <span class="number">19</span>&gt;, <span class="string">&quot;a strange property format&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="ä¸€äº›æ ‡å‡†å±æ€§"><a href="#ä¸€äº›æ ‡å‡†å±æ€§" class="headerlink" title="ä¸€äº›æ ‡å‡†å±æ€§"></a><strong>ä¸€äº›æ ‡å‡†å±æ€§</strong></h2><h3 id="compatible-å±æ€§"><a href="#compatible-å±æ€§" class="headerlink" title="compatible å±æ€§"></a><strong>compatible å±æ€§</strong></h3><p>â€œcompatibleâ€ è¡¨ç¤º â€œå…¼å®¹â€ï¼Œå¯¹äºæŸä¸ª LEDï¼Œå†…æ ¸ä¸­å¯èƒ½æœ‰ Aã€Bã€C ä¸‰ä¸ªé©±åŠ¨éƒ½æ”¯æŒå®ƒï¼Œé‚£å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">led &#123;</span><br><span class="line">    compatible = â€œAâ€, â€œBâ€, â€œCâ€;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å†…æ ¸å¯åŠ¨æ—¶ï¼Œ<strong>å°±ä¼šä¸ºè¿™ä¸ª LED æŒ‰è¿™æ ·çš„ä¼˜å…ˆé¡ºåºä¸ºå®ƒæ‰¾åˆ°é©±åŠ¨ç¨‹åº</strong>ï¼šAã€Bã€Cã€‚</p><h4 id="model-å±æ€§"><a href="#model-å±æ€§" class="headerlink" title="model å±æ€§"></a><strong>model å±æ€§</strong></h4><p>ç”¨æ¥è¡¨ç¤ºè®¾å¤‡å‹å·è€Œå·²ã€‚æ²¡å•¥ç”¨ã€‚</p><p>model å±æ€§ä¸ <code>compatible</code> å±æ€§æœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯æœ‰å·®åˆ«ã€‚<code>compatible</code> å±æ€§æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ—è¡¨ï¼Œè¡¨ç¤ºå¯ä»¥ä½ çš„ç¡¬ä»¶å…¼å®¹ Aã€Bã€C ç­‰é©±åŠ¨ï¼›model ç”¨æ¥å‡†ç¡®åœ°å®šä¹‰è¿™ä¸ªç¡¬ä»¶æ˜¯ä»€ä¹ˆã€‚æ¯”å¦‚æ ¹èŠ‚ç‚¹ä¸­å¯ä»¥è¿™æ ·å†™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">    compatible = <span class="string">&quot;samsung,smdk2440&quot;</span>, <span class="string">&quot;samsung,mini2440&quot;</span>;</span><br><span class="line">    model = <span class="string">&quot;jz2440_v3&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å®ƒè¡¨ç¤ºè¿™ä¸ªå•æ¿ï¼Œå¯ä»¥å…¼å®¹å†…æ ¸ä¸­çš„ â€œsmdk2440â€ï¼Œä¹Ÿå…¼å®¹ â€œmini2440â€ã€‚</p><p>ä» <code>compatible</code> å±æ€§ä¸­å¯ä»¥çŸ¥é“å®ƒå…¼å®¹å“ªäº›æ¿ï¼Œä½†æ˜¯å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆæ¿ï¼Ÿç”¨ model å±æ€§æ¥æ˜ç¡®ã€‚</p><h3 id="status-å±æ€§"><a href="#status-å±æ€§" class="headerlink" title="status å±æ€§"></a><strong>status å±æ€§</strong></h3><p>status å±æ€§çœ‹åå­—å°±çŸ¥é“æ˜¯å’Œè®¾å¤‡çŠ¶æ€æœ‰å…³çš„ï¼Œ status å±æ€§å€¼ä¹Ÿæ˜¯å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²æ˜¯è®¾å¤‡çš„çŠ¶æ€ä¿¡æ¯ï¼Œå¯é€‰çš„çŠ¶æ€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/../images/Linux%E5%86%85%E6%A0%B8-%E8%AE%BE%E5%A4%87%E6%A0%91/property.png" alt="property"></p><h3 id="address-cells-å’Œ-size-cells-å±æ€§"><a href="#address-cells-å’Œ-size-cells-å±æ€§" class="headerlink" title="#address-cells å’Œ #size-cells å±æ€§"></a><strong>#address-cells å’Œ #size-cells å±æ€§</strong></h3><p>æ ¼å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># address-cellsï¼šaddress    è¦ç”¨å¤šå°‘ä¸ª 32 ä½æ•°æ¥è¡¨ç¤ºï¼›</span></span><br><span class="line"><span class="meta"># size-cellsï¼šsize          è¦ç”¨å¤šå°‘ä¸ª 32 ä½æ•°æ¥è¡¨ç¤ºã€‚</span></span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä¸€æ®µå†…å­˜ï¼Œæ€ä¹ˆæè¿°å®ƒçš„èµ·å§‹åœ°å€å’Œå¤§å°ï¼Ÿ</p><p>ä¸‹ä¾‹ä¸­ï¼Œ<code>address-cells</code> ä¸º 1ï¼Œæ‰€ä»¥ reg ä¸­ç”¨ 1 ä¸ªæ•°æ¥è¡¨ç¤ºåœ°å€ï¼Œå³ç”¨ 0x80000000 æ¥è¡¨ç¤ºåœ°å€ï¼›size-cells ä¸º 1ï¼Œæ‰€ä»¥ reg ä¸­ç”¨ 1 ä¸ªæ•°æ¥è¡¨ç¤ºå¤§å°ï¼Œå³ç”¨ 0x20000000 è¡¨ç¤ºå¤§å°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">    <span class="meta"># address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    <span class="meta"># size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    memory &#123;</span><br><span class="line">        reg = &lt;<span class="number">0x80000000</span> <span class="number">0x20000000</span>&gt;;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="reg-å±æ€§"><a href="#reg-å±æ€§" class="headerlink" title="reg å±æ€§"></a><strong>reg å±æ€§</strong></h3><p><code>reg</code> å±æ€§çš„å€¼ï¼Œæ˜¯ä¸€ç³»åˆ—çš„ <code>&lt;address size&gt;</code>ï¼Œç”¨å¤šå°‘ä¸ª 32 ä½çš„æ•°æ¥è¡¨ç¤º <code>address</code> å’Œ <code>size</code>ï¼Œç”±å…¶<strong>çˆ¶èŠ‚ç‚¹</strong>çš„ <code>#address-cells</code>ã€<code>#size-cells</code> å†³å®šã€‚ç¤ºä¾‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/dts-v1/;</span><br><span class="line">/ &#123;</span><br><span class="line">    <span class="meta"># address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    <span class="meta"># size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œ memory è¿™ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„ address-cells = 1, è¡¨ç¤ºåœ°å€é•¿åº¦ä¸º 32 ä½ï¼Œ</span></span><br><span class="line">    <span class="comment">// size-cells = 1 è¡¨ç¤ºé•¿åº¦æ˜¯ç”¨ 32 ä½çš„æ•°æ¥è¡¨ç¤ºï¼Œsize-cells=2 è¡¨ç¤ºé•¿åº¦æ˜¯ç”¨ 64 ä½çš„æ•°æ¥è¡¨ç¤ºã€‚</span></span><br><span class="line">    memory &#123;</span><br><span class="line">         reg = &lt;<span class="number">0x8000</span> <span class="number">0x10</span> <span class="number">0xA000</span> <span class="number">0x100</span>&gt;; <span class="comment">// æœ‰ä¸¤ä¸ªå¯„å­˜å™¨å—ï¼Œåœ°å€ä½äº 0x800ï¼Œé•¿åº¦ä¸º 16 byteï¼Œå’Œä½äº 0xA000ï¼Œ256 å­—èŠ‚</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><del>ä¸è¿‡ï¼Œä»å®é™…æ–‡ä»¶ä¸­æ¥çœ‹ï¼Œreg çš„ç”¨æ³•æ›´åƒæ˜¯ <code>reg=&lt;0x00 addr 0x00 size&gt;</code> å¦‚ä¸‹æ‰€ç¤º</del>ğŸ¤¦â€â™‚ï¸ï¼Œæ¯”å¦‚ I2C è®¾å¤‡çš„ reg ç”¨æ¥è¡¨ç¤ºè®¾å¤‡åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">memory@<span class="number">80000000</span> &#123;</span><br><span class="line">device_type = <span class="string">&quot;memory&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x00</span> CVIMMAP_KERNEL_MEMORY_ADDR <span class="number">0x00</span> CVIMMAP_KERNEL_MEMORY_SIZE&gt;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fast_image &#123;</span><br><span class="line">compatible = <span class="string">&quot;cvitek,rtos_image&quot;</span>;</span><br><span class="line">reg-names = <span class="string">&quot;rtos_region&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x0</span> CVIMMAP_FREERTOS_ADDR <span class="number">0x0</span> CVIMMAP_FREERTOS_SIZE&gt;;</span><br><span class="line">ion-size = &lt;CVIMMAP_FREERTOS_RESERVED_ION_SIZE&gt;;<span class="comment">//reserved ion size for freertos</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™é‡Œå°±æ˜¯ä¸Šé¢ <code>#address-cells</code> å’Œ <code>#size-cells</code> å±æ€§çš„ä½œç”¨ï¼Œå› ä¸ºåœ¨ <code>cv181x_base.dtsi</code> ä¸­ï¼Œæ ¹èŠ‚ç‚¹æœ‰è®¾ç½®è¿™ä¸¤ä¸ªå±æ€§ä¸º2ï¼Œé‚£ä¹ˆå°±éœ€è¦ç”¨2ä¸ª32bitæ¥è¡¨ç¤ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ &#123;</span><br><span class="line">compatible = <span class="string">&quot;cvitek,cv181x&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#size-cells = <span class="string">&lt;0x2&gt;</span>;</span></span><br><span class="line"><span class="meta">#address-cells = <span class="string">&lt;0x2&gt;</span>;</span></span><br><span class="line"></span><br><span class="line">top_misc:top_misc_ctrl@<span class="number">3000000</span> &#123;</span><br><span class="line">compatible = <span class="string">&quot;syscon&quot;</span>;</span><br><span class="line">reg = &lt;<span class="number">0x0</span> <span class="number">0x03000000</span> <span class="number">0x0</span> <span class="number">0x8000</span>&gt;;</span><br><span class="line">&#125;;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><h3 id="name-å±æ€§"><a href="#name-å±æ€§" class="headerlink" title="name å±æ€§"></a><strong>name å±æ€§</strong></h3><p>è¿‡æ—¶äº†ï¼Œå»ºè®®ä¸ç”¨ã€‚å®ƒçš„å€¼æ˜¯å­—ç¬¦ä¸²ï¼Œç”¨æ¥è¡¨ç¤ºèŠ‚ç‚¹çš„åå­—ã€‚åœ¨è·Ÿ <code>platform_driver</code> åŒ¹é…æ—¶ï¼Œä¼˜å…ˆçº§æœ€ä½ã€‚<code>compatible</code> å±æ€§åœ¨åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œä¼˜å…ˆçº§æœ€é«˜ã€‚</p><h3 id="device-type-å±æ€§"><a href="#device-type-å±æ€§" class="headerlink" title="device_type å±æ€§"></a><strong>device_type å±æ€§</strong></h3><p>è¿‡æ—¶äº†ï¼Œå»ºè®®ä¸ç”¨ã€‚å®ƒçš„å€¼æ˜¯å­—ç¬¦ä¸²ï¼Œç”¨æ¥è¡¨ç¤ºèŠ‚ç‚¹çš„ç±»å‹ã€‚åœ¨è·Ÿ <code>platform_driver</code> åŒ¹é…æ—¶ï¼Œä¼˜å…ˆçº§ä¸ºä¸­ã€‚<code>compatible</code> å±æ€§åœ¨åŒ¹é…è¿‡ç¨‹ä¸­ï¼Œä¼˜å…ˆçº§æœ€é«˜ã€‚</p><h3 id="phandle-å±æ€§"><a href="#phandle-å±æ€§" class="headerlink" title="phandle å±æ€§"></a><strong>phandle å±æ€§</strong></h3><p>å…¨å±€å”¯ä¸€çš„IDï¼Œç”¨æ¥å¼•ç”¨è®¾å¤‡ã€‚ä½†ä¸€èˆ¬ä¹Ÿä¸ç”¨ï¼Œç›´æ¥ç”¨ <code>&amp;label</code> æ¥å¼•ç”¨è®¾å¤‡ã€‚</p><p><code>phandle</code> å±æ€§ä¸º <code>devicetree</code> ä¸­å”¯ä¸€çš„èŠ‚ç‚¹æŒ‡å®šä¸€ä¸ªæ•°å­—æ ‡è¯†ç¬¦ï¼ŒèŠ‚ç‚¹ä¸­çš„ <code>phandle</code> æ€§ï¼Œå®ƒçš„å–å€¼å¿…é¡»æ˜¯å”¯ä¸€çš„(ä¸è¦è·Ÿå…¶ä»–çš„ <code>phandle</code> å€¼ä¸€æ ·)ï¼Œä¾‹å¦‚:</p><h3 id="gpio-å±æ€§"><a href="#gpio-å±æ€§" class="headerlink" title="gpio å±æ€§"></a>gpio å±æ€§</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xxx-gpios =</span><br><span class="line">sda-gpios = &lt;&amp;portb 24 GPIO_ACTIVE_HIGH&gt;;</span><br></pre></td></tr></table></figure><p>è§£æåï¼Œå†…æ ¸ä¸­æå–æ—¶åªè¦ <code>-</code> å‰é¢çš„å€¼ã€‚è¿™é‡Œä»£è¡¨ <code>XGPIOB[24]</code> è¿™ç»„è„šã€‚åé¢çš„ <code>GPIO_ACTIVE_HIGH</code> è¡¨ç¤ºé«˜ç”µå¹³ä½¿èƒ½ã€‚æŸäº›<code>spi</code> è®¾å¤‡é€šä¿¡æ—¶ï¼Œç‰‡é€‰ä¿¡å·çº¿ <code>cs</code> æ˜¯ä½ç”µå¹³ä½¿èƒ½ï¼Œè¿™é‡Œå°±è¦æ”¹ä¸º <code>GPIO_ACTIVE_LOW</code>ï¼Œè¿™æ ·å°±ä¸éœ€è¦å»ä¿®æ”¹ä»£ç ä¸­çš„é€»è¾‘ã€‚</p><p>å¯ä»¥ç†è§£ä¸ºå†…æ ¸é©±åŠ¨ä¸­å°†GPIOè®¾ç½®ä¸º1ï¼Œåªæ˜¯å°†å…¶ä½¿èƒ½ï¼Œå…·ä½“æ˜¯é«˜ç”µå¹³è¿˜æ˜¯ä½ç”µå¹³ï¼Œè¿˜è¦çœ‹è¿™ä¸ªå±æ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sda_gpiod = devm_gpiod_get(&amp;pdev-&gt;dev, <span class="string">&quot;sda&quot;</span>, GPIOD_IN);</span><br></pre></td></tr></table></figure><h2 id="å¸¸ç”¨çš„èŠ‚ç‚¹"><a href="#å¸¸ç”¨çš„èŠ‚ç‚¹" class="headerlink" title="å¸¸ç”¨çš„èŠ‚ç‚¹"></a>å¸¸ç”¨çš„èŠ‚ç‚¹</h2><h3 id="æ ¹èŠ‚ç‚¹"><a href="#æ ¹èŠ‚ç‚¹" class="headerlink" title="æ ¹èŠ‚ç‚¹"></a>æ ¹èŠ‚ç‚¹</h3><p>ç”¨ <code>/</code> æ ‡è¯†æ ¹èŠ‚ç‚¹ï¼Œå¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/dts-v1/;</span><br><span class="line">/ &#123;</span><br><span class="line">    model = <span class="string">&quot;SMDK24440&quot;</span>;</span><br><span class="line">    compatible = <span class="string">&quot;samsung,smdk2440&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta"># address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    <span class="meta"># size-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="CPU-èŠ‚ç‚¹"><a href="#CPU-èŠ‚ç‚¹" class="headerlink" title="CPU èŠ‚ç‚¹"></a>CPU èŠ‚ç‚¹</h3><p>ä¸€èˆ¬ä¸éœ€è¦æˆ‘ä»¬è®¾ç½®ï¼Œåœ¨ <code>dtsi</code> æ–‡ä»¶ä¸­éƒ½å®šä¹‰å¥½äº†ï¼Œå¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cpus &#123;</span><br><span class="line">    <span class="meta"># address-cells = <span class="string">&lt;1&gt;</span>;</span></span><br><span class="line">    <span class="meta"># size-cells = <span class="string">&lt;0&gt;</span>;</span></span><br><span class="line"></span><br><span class="line">    cpu0: cpu@<span class="number">0</span> &#123;</span><br><span class="line">     .......</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="memory-èŠ‚ç‚¹"><a href="#memory-èŠ‚ç‚¹" class="headerlink" title="memory èŠ‚ç‚¹"></a>memory èŠ‚ç‚¹</h3><p>èŠ¯ç‰‡å‚å®¶ä¸å¯èƒ½äº‹å…ˆç¡®å®šä½ çš„æ¿å­ä½¿ç”¨å¤šå¤§çš„å†…å­˜ï¼Œæ‰€ä»¥ <code>memory</code> èŠ‚ç‚¹éœ€è¦æ¿å‚è®¾ç½®ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memory &#123;</span><br><span class="line">    reg = &lt;<span class="number">0x80000000</span> <span class="number">0x20000000</span>&gt;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="chosen-èŠ‚ç‚¹"><a href="#chosen-èŠ‚ç‚¹" class="headerlink" title="chosen èŠ‚ç‚¹"></a>chosen èŠ‚ç‚¹</h3><p>chosenå­èŠ‚ç‚¹ä¸ä»£è¡¨å®é™…ç¡¬ä»¶ï¼Œå®ƒä¸»è¦ç”¨äºç»™å†…æ ¸ä¼ é€’å‚æ•°ã€‚ è¿™é‡Œåªè®¾ç½®äº†â€œstdout-path &#x3D;â€serial0:115200n8â€;â€ä¸€æ¡å±æ€§ï¼Œè¡¨ç¤ºç³»ç»Ÿæ ‡å‡†è¾“å‡ºstdoutä½¿ç”¨ä¸²å£serial0ã€‚ æ­¤å¤–è¿™ä¸ªèŠ‚ç‚¹è¿˜ç”¨ä½œubootå‘linuxå†…æ ¸ä¼ é€’é…ç½®å‚æ•°çš„â€œé€šé“â€ï¼Œ æˆ‘ä»¬åœ¨Ubootä¸­è®¾ç½®çš„å‚æ•°å°±æ˜¯é€šè¿‡è¿™ä¸ªèŠ‚ç‚¹ä¼ é€’åˆ°å†…æ ¸çš„ï¼Œ è¿™éƒ¨åˆ†å†…å®¹æ˜¯ubootå’Œå†…æ ¸è‡ªåŠ¨å®Œæˆçš„ï¼Œä½œä¸ºåˆå­¦è€…æˆ‘ä»¬ä¸å¿…æ·±ç©¶ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾å¤‡æ ‘æ–‡ä»¶ç»™å†…æ ¸ä¼ å…¥ä¸€äº›å‚æ•°ï¼Œè¿™è¦åœ¨ <code>chosen</code> èŠ‚ç‚¹ä¸­è®¾ç½® <code>bootargs</code> å±æ€§ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chosen &#123;</span><br><span class="line">    bootargs = <span class="string">&quot;noinitrd root=/dev/mtdblock4 rw init=/linuxrc console=ttySAC0,115200&quot;</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// æˆ–è€…</span></span><br><span class="line">chosen &#123;</span><br><span class="line">    <span class="built_in">stdout</span>-path = <span class="string">&quot;serial0&quot;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="aliases-èŠ‚ç‚¹"><a href="#aliases-èŠ‚ç‚¹" class="headerlink" title="aliases èŠ‚ç‚¹"></a>aliases èŠ‚ç‚¹</h3><p>å°±æ˜¯ç»™æŸäº›èŠ‚ç‚¹è®¾ç½®åˆ«åï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">aliases &#123;</span><br><span class="line">    i2c0 = &amp;i2c0;</span><br><span class="line">    i2c1 = &amp;i2c1;</span><br><span class="line">    i2c2 = &amp;i2c2;</span><br><span class="line">    i2c3 = &amp;i2c3;</span><br><span class="line">    i2c4 = &amp;i2c4;</span><br><span class="line">    serial0 = &amp;uart0;</span><br><span class="line">    serial1 = &amp;uart1;</span><br><span class="line">    serial2 = &amp;uart2;</span><br><span class="line">    serial3 = &amp;uart3;</span><br><span class="line">    serial4 = &amp;uart4;</span><br><span class="line">    ethernet0 = &amp;ethernet0;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹ä¿¡æ¯"><a href="#å¦‚ä½•è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹ä¿¡æ¯" class="headerlink" title="å¦‚ä½•è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹ä¿¡æ¯"></a>å¦‚ä½•è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹ä¿¡æ¯</h2><blockquote><p>å‚è€ƒï¼š<a href="https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#id9">8. Linuxè®¾å¤‡æ ‘</a></p></blockquote><p>å†…æ ¸æä¾›äº†ä¸€ç»„å‡½æ•°ç”¨äºä»è®¾å¤‡èŠ‚ç‚¹è·å–èµ„æºï¼ˆè®¾å¤‡èŠ‚ç‚¹ä¸­å®šä¹‰çš„å±æ€§ï¼‰çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä»¥of_å¼€å¤´ï¼Œç§°ä¸ºOFæ“ä½œå‡½æ•°ã€‚ å¸¸ç”¨çš„OFå‡½æ•°ä»‹ç»çœ‹ <a href="https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#id9">8. Linuxè®¾å¤‡æ ‘</a></p><h3 id="æå–å±æ€§å€¼çš„ofå‡½æ•°"><a href="#æå–å±æ€§å€¼çš„ofå‡½æ•°" class="headerlink" title="æå–å±æ€§å€¼çš„ofå‡½æ•°"></a>æå–å±æ€§å€¼çš„ofå‡½æ•°</h3><p><a href="https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#of">https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#of</a></p><h3 id="å†…å­˜æ˜ å°„ç›¸å…³ofå‡½æ•°"><a href="#å†…å­˜æ˜ å°„ç›¸å…³ofå‡½æ•°" class="headerlink" title="å†…å­˜æ˜ å°„ç›¸å…³ofå‡½æ•°"></a>å†…å­˜æ˜ å°„ç›¸å…³ofå‡½æ•°</h3><p><a href="https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#id20">https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#id20</a></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://www.devicetree.org/">devicetree.org  çš„æ ‡å‡†æ–‡æ¡£</a>ï¼Œè‹±æ–‡çš„ï¼Œç¯‡å¹…ä¸é•¿ã€‚</li><li><a href="https://doc.embedfire.com/linux/stm32mp1/driver/zh/latest/linux_driver/base_driver_tree.html#id9">8. Linuxè®¾å¤‡æ ‘</a> é‡ç«ç›¸å…³æ•™ç¨‹ã€‚</li><li><a href="https://mp.weixin.qq.com/s?__biz=MzUxMjEyNDgyNw==&mid=2247507125&idx=1&sn=6100723c3d3d012e40f4706ed16fd2d1&chksm=f96bae41ce1c2757c842713f7828b01b7fa8914b23b5e3d2dfba7aa064d0e822eca24645d1c0&from=industrynews&version=4.1.7.6018&platform=win&poc_token=HI3X0WSjwJWFv7kC545w1yAqOg0r4p8YYUUMe1UV">å¾®ä¿¡-æ•´ç†äº†ä¸€ä»½ Linux è®¾å¤‡æ ‘åŸºç¡€çŸ¥è¯†ï¼Œå»ºè®®æ”¶è—ï¼</a></li><li><a href="https://tinylab.org/linux-dts-1/">Device Tree åˆæ¢</a></li><li><a href="https://elinux.org/Device_Tree_Usage">elinux.org&#x2F;Device_Tree_Usage</a></li><li><a href="http://hulc.xyz/2021/11/11/linux%E8%AE%BE%E5%A4%87%E6%A0%91%E8%A7%A3%E6%9E%90/">Linux è®¾å¤‡æ ‘è§£æ</a></li><li><a href="http://hulc.xyz/2021/11/16/linux%E8%AE%BE%E5%A4%87%E6%A0%91device-node%E8%BD%AC%E6%8D%A2%E6%88%90platform-device/">Linux è®¾å¤‡æ ‘ device_node è½¬æ¢æˆ platform_device</a></li><li><a href="https://bbs.huaweicloud.com/blogs/411120">https://bbs.huaweicloud.com/blogs/411120</a></li></ul><hr><h2 id="ğŸ’¡ç¼–è¯‘ã€åç¼–è¯‘"><a href="#ğŸ’¡ç¼–è¯‘ã€åç¼–è¯‘" class="headerlink" title="ğŸ’¡ç¼–è¯‘ã€åç¼–è¯‘"></a>ğŸ’¡ç¼–è¯‘ã€åç¼–è¯‘</h2><p>è¦å°†è®¾å¤‡æ ‘äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ<strong>DTB</strong>ï¼ŒDevice Tree Blobï¼‰åç¼–è¯‘ä¸ºè®¾å¤‡æ ‘æºæ–‡ä»¶ï¼ˆ<strong>DTS</strong>ï¼ŒDevice Tree Sourceï¼‰ï¼Œä½ å¯ä»¥ä½¿ç”¨ Linux ä¸­çš„ <code>dtc</code>ï¼ˆDevice Tree Compilerï¼‰å·¥å…·ã€‚ä»¥ä¸‹æ˜¯å…·ä½“çš„æ­¥éª¤ï¼š</p><ol><li><p><strong>å®‰è£… <code>dtc</code> å·¥å…·</strong>ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰ï¼š</p><ul><li>åœ¨åŸºäº Debian çš„ç³»ç»Ÿï¼ˆå¦‚ Ubuntuï¼‰ä¸­ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£…ï¼š<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install device-tree-compiler</span><br></pre></td></tr></table></figure></li></ul></li><li><p><strong>åç¼–è¯‘ DTB æ–‡ä»¶</strong>ï¼š<br>ä½¿ç”¨ <code>dtc</code> å‘½ä»¤å°† DTB æ–‡ä»¶åç¼–è¯‘ä¸º DTS æ–‡ä»¶ã€‚å‡è®¾ä½ çš„ DTB æ–‡ä»¶åä¸º <code>example.dtb</code>ï¼Œä½ å¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dtc -I dtb -O dts -o example.dts example.dtb</span><br></pre></td></tr></table></figure><ul><li><code>-I dtb</code>ï¼šæŒ‡å®šè¾“å…¥æ ¼å¼ä¸º DTBã€‚</li><li><code>-O dts</code>ï¼šæŒ‡å®šè¾“å‡ºæ ¼å¼ä¸º DTSã€‚</li><li><code>-o example.dts</code>ï¼šè¾“å‡ºçš„ DTS æ–‡ä»¶åã€‚</li><li><code>example.dtb</code>ï¼šè¦åç¼–è¯‘çš„ DTB æ–‡ä»¶ã€‚</li></ul></li><li><p><strong>æŸ¥çœ‹ DTS æ–‡ä»¶</strong>ï¼š<br>åç¼–è¯‘å®Œæˆåï¼Œä½ å¯ä»¥ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æŸ¥çœ‹ç”Ÿæˆçš„ <code>.dts</code> æ–‡ä»¶ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Kernel </tag>
            
            <tag> DTS </tag>
            
            <tag> Uboot </tag>
            
            <tag> è®¾å¤‡æ ‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Cvitek-å®‰å…¨å¯åŠ¨</title>
      <link href="/2023/08/03/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/"/>
      <url>/2023/08/03/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="Cvitek-å®‰å…¨å¯åŠ¨"><a href="#Cvitek-å®‰å…¨å¯åŠ¨" class="headerlink" title="Cvitek-å®‰å…¨å¯åŠ¨"></a>Cvitek-å®‰å…¨å¯åŠ¨</h2><blockquote><p>æ³¨ï¼šä»…è€ƒè™‘ <code>cv181x</code></p></blockquote><p>å®‰å…¨å¯åŠ¨çš„æ„ä¹‰ï¼š</p><ul><li>é˜²æ­¢ç”¨æˆ·çƒ§å½•æœªç»æˆæƒçš„å›ºä»¶ã€‚ï¼ˆç­¾åï¼‰</li><li>é˜²æ­¢é€šè¿‡å›ºä»¶æ‹·è´ï¼Œæ¥æŠ„è¢­äº§å“ã€‚ï¼ˆç­¾å+åŠ å¯†ï¼‰</li></ul><h2 id="åŸç†ä»‹ç»"><a href="#åŸç†ä»‹ç»" class="headerlink" title="åŸç†ä»‹ç»"></a>åŸç†ä»‹ç»</h2><h3 id="åŠ å¯†ç®—æ³•ä»‹ç»"><a href="#åŠ å¯†ç®—æ³•ä»‹ç»" class="headerlink" title="åŠ å¯†ç®—æ³•ä»‹ç»"></a>åŠ å¯†ç®—æ³•ä»‹ç»</h3><blockquote><ul><li><a href="https://mp.weixin.qq.com/s/XBYJFZ2jRF2slrlym3svQw">ç›˜ç‚¹äº”ç§æœ€å¸¸è§åŠ å¯†ç®—æ³•ï¼</a></li><li><a href="https://mp.weixin.qq.com/s/Hu1VBMSHh82n6bujWxr9nw">å¯†ç å­¦åŸºæœ¬æ¦‚å¿µ</a></li></ul></blockquote><p>ç®—æ³•æ•´ä½“ä¸Šå¯ä»¥åˆ†ä¸º**<del>ä¸å¯é€†åŠ å¯†</del><strong>ï¼Œä»¥åŠ</strong>å¯é€†åŠ å¯†<strong>ï¼Œå¯é€†åŠ å¯†åˆå¯ä»¥åˆ†ä¸º</strong>å¯¹ç§°åŠ å¯†<strong>å’Œ</strong>éå¯¹ç§°åŠ å¯†**ã€‚</p><blockquote><p>ä¸å¯é€†è¿™éƒ¨åˆ†ç§°ä¸º <strong>æ¶ˆæ¯æ‘˜è¦</strong> æ›´å¥½ï¼Œ<strong>æ‘˜è¦ç®—æ³•</strong>å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æ•£åˆ—å‡½æ•°ã€å“ˆå¸Œå‡½æ•°ï¼ˆHash Functionï¼‰ï¼Œå®ƒèƒ½å¤ŸæŠŠä»»æ„é•¿åº¦çš„æ•°æ®â€œå‹ç¼©â€æˆå›ºå®šé•¿åº¦ã€è€Œä¸”ç‹¬ä¸€æ— äºŒçš„â€œæ‘˜è¦â€å­—ç¬¦ä¸²ï¼Œå°±å¥½åƒæ˜¯ç»™è¿™æ®µæ•°æ®ç”Ÿæˆäº†ä¸€ä¸ªæ•°å­—â€œæŒ‡çº¹â€ã€‚</p></blockquote><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640.png" alt="å›¾ç‰‡"></p><h4 id="æ¶ˆæ¯æ‘˜è¦"><a href="#æ¶ˆæ¯æ‘˜è¦" class="headerlink" title="æ¶ˆæ¯æ‘˜è¦"></a>æ¶ˆæ¯æ‘˜è¦</h4><p>æ•£åˆ—ç®—æ³•ï¼Œå°±æ˜¯ä¸€ç§ä¸å¯é€†ç®—æ³•ï¼Œæ— æ³•ä»æ•£åˆ—ç»“æœä¸­åæ¨å‡ºæ˜æ–‡ã€‚<strong>å¯ä»¥ç”¨æ¥æ£€éªŒæ•°æ®æ˜¯å¦è¢«æ›´æ”¹</strong>ã€‚</p><p>æ•£åˆ—ç®—æ³•ä¸­ï¼Œæ˜æ–‡é€šè¿‡æ•£åˆ—ç®—æ³•ç”Ÿæˆæ•£åˆ—å€¼ï¼Œ<strong>æ•£åˆ—å€¼æ˜¯é•¿åº¦å›ºå®šçš„æ•°æ®ï¼Œå’Œæ˜æ–‡é•¿åº¦æ— å…³</strong>ã€‚</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640-1694590307639-3.png" alt="å›¾ç‰‡"></p><p>æ•£åˆ—ç®—æ³•çš„å…·ä½“å®ç°æœ‰å¾ˆå¤šç§ï¼Œå¸¸è§çš„åŒ…æ‹¬ <code>MD5</code>ã€<code>SHA1</code>ã€<code>SHA-224</code>ã€<code>SHA-256</code> ç­‰ç­‰ã€‚</p><p>æ•£åˆ—ç®—æ³•å¸¸ç”¨äº<strong>æ•°å­—ç­¾å</strong>ã€æ¶ˆæ¯è®¤è¯ã€å¯†ç å­˜å‚¨ç­‰åœºæ™¯ã€‚</p><blockquote><p>æœ¬æ–‡ä¸­ï¼Œå¯¹ <code>kernel</code>ã€<code>rootfs</code> çš„ç­¾åå°±æ˜¯åŸºäº <code>sha256</code> å®ç°ï¼ˆä¸è¿‡è¿˜ç”¨åˆ°äº†ä¸‹é¢çš„ <code>RSA</code>ï¼‰ã€‚</p></blockquote><table><thead><tr><th>åç§°</th><th>ä»‹ç»ï¼šéƒ½æ˜¯ç”¨äºå°†ä»»æ„é•¿åº¦çš„æ•°æ®æ˜ å°„ä¸ºå›ºå®šé•¿åº¦çš„æ•£åˆ—å€¼ï¼Œåªæ˜¯æ˜ å°„é•¿åº¦å’Œå®ç°ç®—æ³•ä¸åŒ</th></tr></thead><tbody><tr><td><code>MD5</code></td><td><code>MD5</code>ï¼ˆMessage-Digest Algorithm 5ï¼‰ï¼Œ<code>MD5</code> ç®—æ³•çš„è¾“å‡ºé•¿åº¦ä¸º <code>128</code> ä½ï¼Œé€šå¸¸ç”¨ <code>32</code> ä¸ª <code>16</code> è¿›åˆ¶æ•°è¡¨ç¤ºã€‚</td></tr><tr><td><code>SHA1</code></td><td><code>SHA-1</code> ç³»åˆ—å­˜åœ¨ç¼ºé™·ï¼Œå·²ç»ä¸å†è¢«æ¨èä½¿ç”¨</td></tr><tr><td><code>SHA2</code></td><td><code>SHA-2</code> ç®—æ³•åŒ…æ‹¬<code>SHA-224</code>ã€<code>SHA-256</code>ã€<code>SHA-384</code>å’Œ<code>SHA-512</code>å››ç§æ•£åˆ—å‡½æ•°ï¼Œ<br />åˆ†åˆ«å°†ä»»æ„é•¿åº¦çš„æ•°æ®æ˜ å°„ä¸º <code>224</code> ä½ã€<code>256</code> ä½ã€<code>384</code> ä½å’Œ <code>512</code> ä½çš„æ•£åˆ—å€¼ã€‚</td></tr></tbody></table><h4 id="å¯¹ç§°åŠ å¯†-â€“-AES-ç®—æ³•"><a href="#å¯¹ç§°åŠ å¯†-â€“-AES-ç®—æ³•" class="headerlink" title="å¯¹ç§°åŠ å¯† â€“ AES ç®—æ³•"></a>å¯¹ç§°åŠ å¯† â€“ AES ç®—æ³•</h4><p>å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640-1694591480328-6.png" alt="å›¾ç‰‡"></p><p>åŠ å¯†å’Œè§£å¯†è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„å¯†é’¥ï¼Œå› æ­¤å¯†é’¥çš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚å¦‚æœå¯†é’¥æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥è½»æ˜“åœ°ç ´è§£åŠ å¯†æ•°æ®ã€‚</p><p>å¸¸è§çš„å¯¹ç§°åŠ å¯†ç®—æ³•åŒ…æ‹¬ <code>DES</code>ã€<code>3DES</code>ã€<code>AES</code> ç­‰ã€‚å…¶ä¸­ï¼Œ**<code>AES</code> ç®—æ³•æ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„å¯¹ç§°åŠ å¯†ç®—æ³•ä¹‹ä¸€ï¼Œå…·æœ‰æ¯”è¾ƒé«˜çš„å®‰å…¨æ€§å’ŒåŠ å¯†æ•ˆç‡<strong>ã€‚</strong><code>AES</code> ç®—æ³•ä½¿ç”¨çš„å¯†é’¥é•¿åº¦ä¸º <code>128</code> ä½ã€<code>192</code> ä½æˆ– <code>256</code> ä½**ï¼ˆè¿™é‡Œçš„ä½æ˜¯ <code>bit</code>ï¼‰</p><blockquote><p>æˆ‘ä»¬ä½¿ç”¨çš„ <code>AES</code> ç§˜é’¥æ˜¯ 128 ä½ã€‚</p></blockquote><h4 id="éå¯¹ç§°åŠ å¯†-â€“-RSA-ç®—æ³•"><a href="#éå¯¹ç§°åŠ å¯†-â€“-RSA-ç®—æ³•" class="headerlink" title="éå¯¹ç§°åŠ å¯† â€“ RSA ç®—æ³•"></a>éå¯¹ç§°åŠ å¯† â€“ RSA ç®—æ³•</h4><p>éå¯¹ç§°åŠ å¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªå¯†é’¥ï¼Œè¿™ä¸¤ä¸ªå¯†é’¥äº’ä¸ç›¸åŒï¼Œä½†æ˜¯ç›¸äº’åŒ¹é…ï¼Œä¸€ä¸ªç§°ä¸º<strong>å…¬é’¥</strong>ï¼Œå¦ä¸€ä¸ªç§°ä¸º<strong>ç§é’¥</strong>ã€‚</p><p><strong>ä½¿ç”¨å…¶ä¸­çš„ä¸€ä¸ªåŠ å¯†ï¼Œåˆ™ä½¿ç”¨å¦ä¸€ä¸ªè¿›è¡Œè§£å¯†</strong>ã€‚ä¾‹å¦‚ä½¿ç”¨å…¬é’¥åŠ å¯†ï¼Œåˆ™éœ€è¦ä½¿ç”¨ç§é’¥è§£å¯†ã€‚</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640-1694591564320-9.png" alt="å›¾ç‰‡"></p><p><code>RSA</code> ç®—æ³•çš„<strong>ä¼˜ç‚¹æ˜¯å®‰å…¨æ€§é«˜</strong>ï¼Œå…¬é’¥å¯ä»¥å…¬å¼€ï¼Œç§é’¥å¿…é¡»ä¿å¯†ï¼Œä¿è¯äº†æ•°æ®çš„å®‰å…¨æ€§ï¼›å¯ç”¨äºæ•°å­—ç­¾åã€å¯†é’¥åå•†ç­‰å¤šç§åº”ç”¨åœºæ™¯ã€‚</p><p><strong>ç¼ºç‚¹æ˜¯åŠ å¯†ã€è§£å¯†é€Ÿåº¦è¾ƒæ…¢</strong>ï¼Œå¯†é’¥é•¿åº¦è¶Šé•¿ï¼ŒåŠ å¯†ã€è§£å¯†æ—¶é—´è¶Šé•¿ï¼›å¯†é’¥é•¿åº¦è¿‡çŸ­å®¹æ˜“è¢«æš´åŠ›ç ´è§£ï¼Œå¯†é’¥é•¿åº¦è¿‡é•¿åˆ™ä¼šå¢åŠ è®¡ç®—é‡å’Œå­˜å‚¨ç©ºé—´çš„å¼€é”€ã€‚</p><p><code>RSA</code> çš„ç§˜é’¥ï¼ˆåŒ…æ‹¬å…¬é’¥å’Œç§é’¥ï¼‰ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šæ¨¡æ•°å’ŒæŒ‡æ•°</p><ul><li><p><strong>å…¬é’¥</strong>ï¼šåŒ…æ‹¬æ¨¡æ•° <code>N</code> å’Œ<strong>å…¬é’¥æŒ‡æ•°</strong> <code>E</code>ã€‚å…¬é’¥ç”¨äº<strong>éªŒè¯æ•°å­—ç­¾å</strong>ã€‚</p></li><li><p><strong>ç§é’¥</strong>ï¼šåŒ…æ‹¬æ¨¡æ•° <code>N</code> å’Œ<strong>ç§é’¥æŒ‡æ•°</strong> <code>D</code>ã€‚ç§é’¥ç”¨äº<strong>ç”Ÿæˆæ•°å­—ç­¾å</strong>ã€‚</p><blockquote><p>å…·ä½“æ¥è¯´ï¼Œæ•°å­—ç­¾åè¿‡ç¨‹é€šå¸¸æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><strong>ä½¿ç”¨å“ˆå¸Œå‡½æ•°å¯¹è¦ç­¾åçš„æ•°æ®è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç”Ÿæˆæ¶ˆæ¯æ‘˜è¦ã€‚</strong></li><li><strong>ä½¿ç”¨ç§é’¥å¯¹æ¶ˆæ¯æ‘˜è¦è¿›è¡ŒåŠ å¯†ï¼Œç”Ÿæˆæ•°å­—ç­¾åã€‚</strong></li><li>å°†åŸå§‹æ•°æ®ã€æ•°å­—ç­¾åå’Œå…¬é’¥å‘é€ç»™æ¥æ”¶æ–¹ã€‚</li></ol><p>éªŒè¯æ•°å­—ç­¾åçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ol><li><strong>ä½¿ç”¨å…¬é’¥å¯¹æ•°å­—ç­¾åè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°æ¶ˆæ¯æ‘˜è¦ã€‚</strong></li><li><strong>ä½¿ç”¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°å¯¹åŸå§‹æ•°æ®è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç”Ÿæˆå¦ä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦ã€‚</strong></li><li>æ¯”è¾ƒè¿™ä¸¤ä¸ªæ¶ˆæ¯æ‘˜è¦ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è¡¨ç¤ºç­¾åæœ‰æ•ˆï¼Œå¦åˆ™è¡¨ç¤ºç­¾åæ— æ•ˆã€‚</li></ol><p>å› æ­¤ï¼Œå…¬é’¥é€šå¸¸ç”¨äºéªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§ï¼Œè€Œä¸æ˜¯ç”¨äºç”Ÿæˆæ•°å­—ç­¾åã€‚</p></blockquote></li></ul><p>åœ¨ä¸€ä¸ªæ ‡å‡†çš„ <code>RSA</code> å¯†é’¥å¯¹ä¸­ï¼Œå…¬é’¥çš„ <code>E</code>å’Œ <code>N</code> é€šå¸¸ä¹ŸåŒ…å«åœ¨ç§é’¥ä¸­ï¼Œ<strong>æ¨¡æ•° <code>N</code> æ˜¯ <code>RSA</code> å¯†é’¥å¯¹çš„å…³é”®éƒ¨åˆ†ï¼Œå®ƒåœ¨å…¬é’¥å’Œç§é’¥ä¸­éƒ½æ˜¯ç›¸åŒçš„</strong>ã€‚<code>E</code> å’Œ <code>D</code> æ˜¯æŒ‡æ•°ï¼Œå®ƒä»¬é€šå¸¸ä¸åŒï¼Œå› ä¸ºå®ƒä»¬åœ¨ä¸åŒçš„æ•°å­¦è¿ç®—ä¸­ä½¿ç”¨ã€‚</p><ul><li><code>E</code> é€šå¸¸è¢«è®¾ç½®ä¸ºå¸¸æ•°å€¼ 65537ï¼ˆ0x10001ï¼‰ï¼Œå› ä¸ºè¿™ä¸ªå€¼åœ¨äºŒè¿›åˆ¶ä¸­æœ‰å¾ˆå¤š 1ï¼Œä½¿å¾—åŠ å¯†æ“ä½œæ›´åŠ é«˜æ•ˆã€‚</li><li><code>N</code> æ˜¯ä¸€ä¸ªå¤§æ•´æ•°ï¼Œå®ƒæ˜¯ä¸¤ä¸ªå¤§è´¨æ•°çš„ä¹˜ç§¯ï¼Œ<strong>å®ƒå†³å®šäº† <code>RSA</code> å¯†é’¥çš„é•¿åº¦å’Œå¼ºåº¦</strong>ã€‚</li></ul><p>åœ¨ RSA ç®—æ³•ä¸­ï¼Œå…¬é’¥å’Œç§é’¥éƒ½åŒ…å«æ¨¡æ•° <code>N</code>ï¼Œè€Œ <code>N</code> æ˜¯ä¸¤ä¸ªå¤§è´¨æ•° <code>p</code> å’Œ <code>q</code> çš„ä¹˜ç§¯ã€‚å…¬é’¥è¿˜åŒ…å«ä¸€ä¸ªæŒ‡æ•° <code>e</code>ï¼Œè€Œç§é’¥åŒ…å«å¦ä¸€ä¸ªæŒ‡æ•° <code>d</code>ã€‚è¿™ä¸¤ä¸ªæŒ‡æ•° <code>e</code> å’Œ <code>d</code> çš„é€‰æ‹©è¦æ»¡è¶³ä¸€ä¸ªç‰¹å®šçš„æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ»¡è¶³ <code>e*d â‰¡ 1 (mod Ï†(N))</code> çš„å…³ç³»ã€‚åœ¨è¿™é‡Œï¼Œ<code>Ï†(N)</code> æ˜¯ Eulerâ€™s totient å‡½æ•°ï¼Œå®ƒå¯¹äº <code>N=p*q</code>ï¼Œå€¼ä¸º<code>Ï†(N)=(p-1)(q-1)</code>ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ä¸¤å¯¹å¯†é’¥ï¼ˆå…¬é’¥å’Œç§é’¥ï¼‰æœ‰ä¸åŒçš„æŒ‡æ•° <code>e</code> å’Œ dï¼Œä½† <code>e</code> å’Œ <code>d</code> æ˜¯æ»¡è¶³ç›¸åº”æ•°å­¦å…³ç³»çš„ã€‚ä½¿å¾—ç”¨å…¬é’¥è¿›è¡ŒåŠ å¯†çš„å¯†æ–‡ç”¨ç§é’¥èƒ½è§£å¯†ï¼Œç”¨ç§é’¥è¿›è¡ŒåŠ å¯†çš„å¯†æ–‡ç”¨å…¬é’¥èƒ½è§£å¯†ã€‚åœ¨è¿™é‡Œï¼Œâ€æ¨¡ Nâ€ æ˜¯æŒ‡åœ¨æ‰€æœ‰çš„åŠ å¯†å’Œè§£å¯†æ“ä½œéƒ½åœ¨æ¨¡ N çš„æ„ä¹‰ä¸‹è¿›è¡Œã€‚å®åˆ™ï¼Œâ€äº’é€†â€æ˜¯åœ¨æŒ‡ <code>e</code> å’Œ <code>d</code> ç›¸å¯¹äº <code>Ï†(N)</code> æ¨¡é€†çš„å…³ç³»ã€‚</p><blockquote><p><code>e*d â‰¡ 1(mod Ï†(N))</code> æ˜¯ä¸€ä¸ªåŒä½™æ–¹ç¨‹ï¼Œæè¿°çš„æ˜¯ <code>e</code> å’Œ <code>d</code> åœ¨æ¨¡ <code>Ï†(N)</code> ä¸‹çš„ä¹˜ç§¯åŒä½™äº 1ã€‚</p><p>åœ¨æ•°å­¦ä¸­ï¼Œâ€åŒä½™â€æ˜¯ä¸€ç§ç­‰ä»·å…³ç³»ï¼Œa å’Œ b â€œæ¨¡ m åŒä½™â€ï¼Œå¦‚æœå®ƒä»¬é™¤ä»¥ m å¾—åˆ°çš„ä½™æ•°ç›¸åŒã€‚åœ¨æ­¤å¤„çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™æ„å‘³ç€å½“ä½ å°† e*d é™¤ä»¥ Ï†(N)ï¼Œå¾—åˆ°çš„ä½™æ•°æ˜¯ 1ã€‚<br>è¿™ä¸ªå…³ç³»ç¡®ä¿äº†å…¬é’¥ï¼ˆNï¼Œeï¼‰å’Œç§é’¥ï¼ˆNï¼Œdï¼‰å½¼æ­¤äº’é€†ã€‚å³ï¼Œå¦‚æœä½ ä½¿ç”¨å…¬é’¥åŠ å¯†æ¶ˆæ¯ mï¼Œå¾—åˆ° <code>c=m^e (mod N)</code>ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç”¨ç§é’¥è§£å¯†æ¶ˆæ¯ cï¼Œå¾—åˆ° <code>m=c^d (mod N)</code>ï¼Œåä¹‹äº¦ç„¶ã€‚<br>è¿™æ ·è®¾è®¡çš„åŸå› åœ¨äºï¼Œå¦‚æœç¬¬ä¸‰æ–¹åªçŸ¥é“å…¬é’¥ï¼ˆNï¼Œeï¼‰ï¼Œä»–ä»¬æ— æ³•è®¡ç®—å‡ºç›¸åº”çš„ç§é’¥ dï¼Œé™¤éä»–ä»¬èƒ½å› æ•°åˆ†è§£ Nï¼Œè¿™åœ¨å®é™…ä¸­æ˜¯éå¸¸å›°éš¾çš„ï¼Œä½¿å¾—è¿™ä¸€åŠ å¯†ç³»ç»Ÿå…·æœ‰å¾ˆé«˜çš„å®‰å…¨æ€§ã€‚</p><p>N åªæ˜¯å…¬é’¥å’Œç§é’¥å…±æœ‰çš„æ¨¡æ•°è€Œå·²ï¼Œå®ƒæ˜¯ä¸¤ä¸ªå¤§è´¨æ•°çš„ä¹˜ç§¯ã€‚è¦æ¨å¯¼å‡ºç§é’¥ï¼Œé™¤äº†éœ€è¦çŸ¥é“ N å€¼å¤–ï¼Œè¿˜éœ€è¦çŸ¥é“è¿™ä¸¤ä¸ªè´¨æ•°ï¼Œç„¶è€Œï¼Œå½“ N æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ•°æ—¶ï¼Œè¦åˆ†è§£ Nï¼Œæ‰¾åˆ°è¿™ä¸¤ä¸ªè´¨æ•°ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸å¯èƒ½çš„ï¼ˆå¯¹äºä¸€ä¸ª N å€¼ï¼Œæœ‰ä¸”åªæœ‰ä¸€å¯¹è´¨æ•°çš„ä¹˜ç§¯ç­‰äº Nï¼‰ã€‚</p><p>2048 ä½çš„ RSA å¯†é’¥ä¸­çš„ N å€¼ï¼Œæ˜¯ç”±ä¸¤ä¸ª 1024 ä½çš„è´¨æ•°ç›¸ä¹˜å¾—åˆ°çš„ï¼Œæ‰€ä»¥å®ƒçš„é•¿åº¦å¤§çº¦åœ¨ 616 åˆ° 617 ä½ä¹‹é—´ã€‚åœ¨åè¿›åˆ¶ä¸‹ï¼Œå®ƒçš„å€¼å¤§çº¦åœ¨ 2 çš„ 2048 æ¬¡æ–¹åˆ° 2 çš„ 2049 æ¬¡æ–¹ä¹‹é—´ï¼Œå³å¤§çº¦åœ¨ 10 çš„ 617 æ¬¡æ–¹åˆ° 10 çš„ 618 æ¬¡æ–¹ä¹‹é—´ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸å¤§çš„æ•°ã€‚</p></blockquote><h4 id="RSA-ç¤ºä¾‹"><a href="#RSA-ç¤ºä¾‹" class="headerlink" title="RSA ç¤ºä¾‹"></a>RSA ç¤ºä¾‹</h4><p>ä½¿ç”¨ OpenSSL å‘½ä»¤è¡Œå·¥å…·ï¼Œä½ å¯ä»¥æ‰§è¡Œ RSA æ•°å­—ç­¾åå’ŒéªŒè¯æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ç”Ÿæˆ RSA å¯†é’¥å¯¹ï¼Œä½¿ç”¨ç§é’¥å¯¹æ–‡ä»¶è¿›è¡Œæ•°å­—ç­¾åï¼Œç„¶åä½¿ç”¨å…¬é’¥éªŒè¯ç­¾åã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆç§é’¥</span></span><br><span class="line">openssl genrsa -out private.pem 2048</span><br><span class="line"><span class="comment"># ä»ç§é’¥ä¸­æå–å…¬é’¥</span></span><br><span class="line">openssl rsa -<span class="keyword">in</span> private.pem -pubout -out public.pem</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 123456789 &gt; test.txt</span><br><span class="line"><span class="comment"># ä½¿ç”¨ç§é’¥å¯¹æ–‡ä»¶è¿›è¡Œç­¾å</span></span><br><span class="line">openssl dgst -sha256 -sign private.pem -out signature.bin test.txt</span><br><span class="line"><span class="comment"># ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å</span></span><br><span class="line">openssl dgst -sha256 -verify public.pem -signature signature.bin test.txt</span><br><span class="line"><span class="comment">## è¾“å‡º Verified OK</span></span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š</p><ul><li><code>private.pem</code>æ˜¯ç”Ÿæˆçš„ç§é’¥æ–‡ä»¶</li><li><code>public.pem</code>æ˜¯ä»ç§é’¥ä¸­æå–çš„å…¬é’¥æ–‡ä»¶</li><li><code>test.txt</code>æ˜¯è¦ç­¾åå’ŒéªŒè¯çš„æ–‡ä»¶</li><li><code>signature.bin</code>æ˜¯ä½¿ç”¨ç§é’¥å¯¹æ–‡ä»¶ç”Ÿæˆçš„ç­¾åæ–‡ä»¶</li></ul><p>ä¸‹é¢æ˜¯ä¸€ä¸ª python ç¤ºä¾‹ï¼Œç­¾åçš„æµç¨‹å’Œ <code>fipsign.py</code> ä¸­ç±»ä¼¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.PublicKey <span class="keyword">import</span> RSA</span><br><span class="line"><span class="keyword">from</span> Crypto.Signature <span class="keyword">import</span> pkcs1_15</span><br><span class="line"><span class="keyword">from</span> Crypto.Hash <span class="keyword">import</span> SHA256</span><br><span class="line"><span class="keyword">from</span> Crypto <span class="keyword">import</span> Random</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆ RSA å¯†é’¥å¯¹</span></span><br><span class="line">random_generator = Random.new().read</span><br><span class="line">key = RSA.generate(<span class="number">2048</span>, random_generator)</span><br><span class="line">public_key = key.publickey()</span><br><span class="line"></span><br><span class="line"><span class="comment"># åŸå§‹æ•°æ®</span></span><br><span class="line">message = <span class="string">b&quot;This is a test message.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¡ç®—å“ˆå¸Œå€¼</span></span><br><span class="line">h = SHA256.new(message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨ç§é’¥å¯¹åŸå§‹æ•°æ®çš„å“ˆå¸Œå€¼è¿›è¡Œç­¾å</span></span><br><span class="line">signature = pkcs1_15.new(key).sign(h)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å</span></span><br><span class="line">verifier = pkcs1_15.new(public_key)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    verifier.verify(h, signature)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The signature is valid.&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> (ValueError, TypeError):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The signature is not valid.&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼šåœ¨çœŸå®åº”ç”¨ä¸­ï¼Œä½ ä¸åº”è¯¥ç›´æ¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥ï¼Œè€Œåº”è¯¥ä½¿ç”¨å®‰å…¨çš„æ–¹å¼æ¥å­˜å‚¨å’Œè®¿é—®å®ƒä»¬ã€‚</span></span><br></pre></td></tr></table></figure><p><strong>é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦å…ˆhashï¼Œå†å¯¹hash è¿›è¡Œç­¾åï¼Ÿ</strong></p><p>åœ¨æ•°å­—ç­¾åä¸­ï¼Œé€šå¸¸å…ˆå¯¹æ¶ˆæ¯è¿›è¡Œå“ˆå¸Œï¼ˆhashingï¼‰ï¼Œç„¶åå†å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œè€Œä¸æ˜¯ç›´æ¥å¯¹åŸå§‹æ¶ˆæ¯è¿›è¡Œç­¾åã€‚è¿™æ ·åšæœ‰å‡ ä¸ªé‡è¦çš„åŸå› ï¼š</p><ol><li><p><strong>æ€§èƒ½</strong>ï¼šå“ˆå¸Œå‡½æ•°æ¯”ç­¾åç®—æ³•å¿«å¾—å¤šã€‚å“ˆå¸Œå‡½æ•°å¯ä»¥å°†ä»»æ„é•¿åº¦çš„æ•°æ®å‹ç¼©æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„å“ˆå¸Œå€¼ï¼Œè€Œç­¾åç®—æ³•åˆ™éœ€è¦å¯¹æ•´ä¸ªæ¶ˆæ¯ï¼ˆæˆ–å“ˆå¸Œå€¼ï¼‰è¿›è¡Œå¤æ‚çš„æ•°å­¦è¿ç®—ã€‚ç”±äºå“ˆå¸Œå‡½æ•°çš„å¿«é€Ÿæ€§ï¼Œå³ä½¿å¯¹äºéå¸¸å¤§çš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥å¿«é€Ÿç”Ÿæˆå“ˆå¸Œå€¼ï¼Œç„¶åå†å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œä»è€Œå¤§å¤§<strong>æé«˜äº†ç­¾åçš„æ•ˆç‡</strong>ã€‚</p></li><li><p><strong>å®‰å…¨æ€§</strong>ï¼šå“ˆå¸Œå‡½æ•°è¢«è®¾è®¡ä¸ºå…·æœ‰â€œé›ªå´©æ•ˆåº”â€ï¼ˆavalanche effectï¼‰ï¼Œè¿™æ„å‘³ç€å³ä½¿åŸå§‹æ¶ˆæ¯ä¸­åªæœ‰ä¸€ä¸ªå¾®å°çš„å˜åŒ–ï¼Œä¹Ÿä¼šå¯¼è‡´å“ˆå¸Œå€¼å‘ç”Ÿæ˜¾è‘—çš„å˜åŒ–ã€‚è¿™ç§æ€§è´¨ä½¿å¾—å“ˆå¸Œå€¼å¯¹ç¯¡æ”¹éå¸¸æ•æ„Ÿã€‚å¦‚æœç›´æ¥å¯¹åŸå§‹æ¶ˆæ¯è¿›è¡Œç­¾åï¼Œé‚£ä¹ˆä»»ä½•å¯¹æ¶ˆæ¯çš„å¾®å°ç¯¡æ”¹éƒ½å¯èƒ½éœ€è¦é‡æ–°è¿›è¡Œæ•´ä¸ªç­¾åè¿‡ç¨‹ï¼Œè¿™æ—¢è€—æ—¶åˆå®¹æ˜“æš´éœ²ç»™æ”»å‡»è€…æ›´å¤šçš„ä¿¡æ¯ã€‚é€šè¿‡å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œå¯ä»¥ç¡®ä¿å³ä½¿åŸå§‹æ¶ˆæ¯è¢«ç¯¡æ”¹ï¼Œç­¾åä¹Ÿä¼šç«‹å³å¤±æ•ˆï¼Œä»è€Œ<strong>æé«˜äº†å®‰å…¨æ€§</strong>ã€‚</p></li><li><p><strong>å¯éªŒè¯æ€§</strong>ï¼šå“ˆå¸Œå‡½æ•°æ˜¯å•å‘çš„ï¼Œè¿™æ„å‘³ç€ä»å“ˆå¸Œå€¼ä¸èƒ½æ¢å¤å‡ºåŸå§‹æ¶ˆæ¯ï¼ˆæˆ–è€…è¯´æ¢å¤åŸå§‹æ¶ˆæ¯æ˜¯éå¸¸å›°éš¾çš„ï¼‰ã€‚ä½†æ˜¯ï¼Œç»™å®šç›¸åŒçš„æ¶ˆæ¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¡ç®—å‡ºç›¸åŒçš„å“ˆå¸Œå€¼ã€‚å› æ­¤ï¼Œå½“æ¥æ”¶è€…æ”¶åˆ°ä¸€ä¸ªç­¾åå’Œç›¸åº”çš„æ¶ˆæ¯æ—¶ï¼Œä»–ä»¬å¯ä»¥è‡ªå·±è®¡ç®—æ¶ˆæ¯çš„å“ˆå¸Œå€¼ï¼Œå¹¶ä½¿ç”¨ç­¾åè€…çš„å…¬é’¥æ¥éªŒè¯ç­¾åæ˜¯å¦æœ‰æ•ˆã€‚è¿™ç§æ–¹å¼å…è®¸ä»»ä½•äººéªŒè¯ç­¾åçš„çœŸå®æ€§ï¼Œè€Œä¸éœ€è¦ä¸ç­¾åè€…è¿›è¡Œé€šä¿¡æˆ–äº¤æ¢ä»»ä½•é¢å¤–çš„ä¿¡æ¯ã€‚</p></li><li><p><strong>ç­¾åé•¿åº¦</strong>ï¼š<strong>ç›´æ¥å¯¹é•¿æ¶ˆæ¯è¿›è¡Œç­¾åå¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„ç­¾åéå¸¸é•¿</strong>ï¼Œä»è€Œå¢åŠ äº†å­˜å‚¨å’Œä¼ è¾“çš„è´Ÿæ‹…ã€‚é€šè¿‡å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œå¯ä»¥ç¡®ä¿ç­¾åé•¿åº¦å§‹ç»ˆå›ºå®šä¸”ç›¸å¯¹è¾ƒçŸ­ï¼Œè¿™æœ‰åˆ©äºèŠ‚çœç©ºé—´å’Œå¸¦å®½ã€‚</p></li></ol><p>ç»¼ä¸Šæ‰€è¿°ï¼Œå…ˆå¯¹æ¶ˆæ¯è¿›è¡Œå“ˆå¸Œï¼Œå†å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åæ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œå®ƒç»“åˆäº†å“ˆå¸Œå‡½æ•°å’Œç­¾åç®—æ³•çš„ä¼˜ç‚¹ï¼Œæä¾›äº†é«˜æ•ˆã€å®‰å…¨å’Œå¯éªŒè¯çš„æ•°å­—ç­¾åæ–¹æ¡ˆã€‚</p><h3 id="å¯åŠ¨æµç¨‹ç®€ä»‹"><a href="#å¯åŠ¨æµç¨‹ç®€ä»‹" class="headerlink" title="å¯åŠ¨æµç¨‹ç®€ä»‹"></a>å¯åŠ¨æµç¨‹ç®€ä»‹</h3><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/image-20230913160851943.png" alt="image-20230913160851943"></p><p>æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰ä¸ªï¼Œ<strong>ä¸€ä¸ªå®Œæ•´çš„å¯åŠ¨æµç¨‹</strong>ä¸ºï¼šç”±æ¿ç«¯å›ºå®šçš„ <code>ROM</code> ä¸­çš„ä»£ç ï¼ˆ<code>ZSBL</code>ï¼‰åˆå§‹åŒ–ç¯å¢ƒåï¼Œè°ƒç”¨ <code>FSBL</code>ï¼Œç„¶å <code>FSBL</code> è°ƒç”¨ <code>OpenSBI</code>ï¼Œè¿›è€Œè°ƒç”¨ <code>U-Boot</code>ï¼Œç”± <code>U-Boot</code> æ¥å¯åŠ¨å†…æ ¸ã€‚<strong>çƒ§å½•æµç¨‹</strong>ï¼ˆ<code>update</code>ï¼‰åªæ˜¯æ²¡æœ‰ <code>U-Boot</code> æ¥å¯åŠ¨å†…æ ¸è¿™ä¸€æ­¥éª¤ã€‚</p><blockquote><p>åˆ° <code>uboot</code> ä¹‹åï¼Œå°±ä¸»è¦æ˜¯ç”± <code>CONFIG_BOOTCOMMAND</code> æ¥æ§åˆ¶åç»­æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°å…ˆå°è¯•æ˜¾ç¤º <code>LOGO</code>ï¼Œç„¶åæ£€æµ‹æ˜¯å¦éœ€è¦å‡çº§ï¼Œ<code>cvi_update</code> å®ƒä¼šæ£€æŸ¥æ˜¯å¦æœ‰ <code>SD</code> å¡ä¸­æœ‰æ²¡æœ‰ <code>fip.bin</code> æˆ– <code>USB</code> å‡çº§ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ <code>||</code> ï¼Œå°±æ„å‘³ç€å‰é¢æ‰§è¡ŒæˆåŠŸï¼Œå°±ä¸ä¼šæ‰§è¡Œåç»­çš„ã€‚å‡çº§ä¹‹åï¼Œä¸ä¼šè‡ªåŠ¨è¿›å…¥å†…æ ¸å°±æ˜¯è¿™ä¸ªåŸå› ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// u-boot-2021.10/include/configs/cv181x-asic.h:302</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONFIG_BOOTCOMMAND    SHOWLOGOCMD <span class="string">&quot;cvi_update || run norboot || run nandboot || run emmcboot&quot;</span></span></span><br></pre></td></tr></table></figure></blockquote><p>æ•´ä¸ªå¯åŠ¨æµç¨‹æˆ‘ä»¬ç”¨åˆ°çš„ç¡¬ä»¶å­˜å‚¨è®¾å¤‡æœ‰ï¼š<code>eFuse</code>ã€<code>flash(nor/emmc/nand)</code>ã€<code>SD</code>ã€<code>ddr</code> è¿™ 4 ä¸ªã€‚</p><h4 id="ç¼–è¯‘æµç¨‹"><a href="#ç¼–è¯‘æµç¨‹" class="headerlink" title="ç¼–è¯‘æµç¨‹"></a>ç¼–è¯‘æµç¨‹</h4><p>è¿™é‡Œåªå…³æ³¨ä¼šç”Ÿæˆå“ªäº›æ–‡ä»¶ï¼Œä»¥åŠæ¯ä¸ªæ–‡ä»¶å¯¹åº”çš„æ¨¡å—ã€‚</p><table><thead><tr><th>æ¨¡å—</th><th>ç”Ÿæˆæ–‡ä»¶</th></tr></thead><tbody><tr><td>fsbl</td><td>bl2.binï¼Œç¼–è¯‘ fsbl ä¹‹åä¼šåˆ›å»º fip.bin ï¼ˆè¯¥æ–‡ä»¶æ‰“åŒ…äº† bl2.bin fw_dynamic.bin u-boot-raw.binï¼‰</td></tr><tr><td>opensbi</td><td>fw_dynamic.bin</td></tr><tr><td>uboot</td><td>u-boot-raw.bin</td></tr><tr><td>kernel</td><td>boot.spinor</td></tr><tr><td>ramdisk</td><td>rootfs.spinor</td></tr></tbody></table><h4 id="çƒ§å½•æµç¨‹"><a href="#çƒ§å½•æµç¨‹" class="headerlink" title="çƒ§å½•æµç¨‹"></a>çƒ§å½•æµç¨‹</h4><p>å…ˆè¯´å‡çº§ï¼ˆçƒ§å½•æµç¨‹ï¼‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°† <code>opensbi</code>ã€<code>uboot</code>ã€<code>kernel</code> ç­‰äºŒè¿›åˆ¶æ–‡ä»¶çƒ§å½•åˆ° <code>flash</code> ä¸Šï¼Œæ¯ä¸ªæ–‡ä»¶åœ¨ <code>flash</code> ä¸Šçš„å†™å…¥åœ°å€éƒ½æ˜¯é€šè¿‡æ–‡ä»¶ <code>partition.xml</code> æŒ‡å®šï¼Œå¦‚ï¼š</p><blockquote><p>ä¸æ˜¯æŒ‡å®šå†™å…¥åœ°å€ï¼Œè€Œæ˜¯æŒ‡å®šæ–‡ä»¶çš„å¤§å°ï¼Œä»–ä»¬åœ¨ <code>flash</code> ä¸Šç´§æŒ¨ç€æ’åˆ—ï¼Œæ¯”å¦‚ç¬¬ <code>0-1024</code>å­˜å‚¨ç€ <code>fip.bin</code>ï¼Œ<code>1024-4096</code> å­˜å‚¨ç€ <code>boot.spinor</code>ã€‚å³ä½¿ <code>fip.bin</code> çš„å®é™…å¤§å°æ²¡æœ‰ 1024ï¼Œ<code>boot.spinor</code> ä»ç„¶æ˜¯ä»ç¬¬ 1024 å¼€å§‹ã€‚<strong>è¦æ³¨æ„ <code>flash</code> çš„å¤§å°é™åˆ¶ï¼Œä¸è¦è¶…å‡ºäº† <code>flash</code> çš„å¤§å°</strong>ã€‚</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">physical_partition</span> <span class="attr">type</span>=<span class="string">&quot;spinor&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;fip&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;1024&quot;</span> <span class="attr">readonly</span>=<span class="string">&quot;false&quot;</span> <span class="attr">file</span>=<span class="string">&quot;fip.bin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;BOOT&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;3072&quot;</span> <span class="attr">readonly</span>=<span class="string">&quot;false&quot;</span> <span class="attr">file</span>=<span class="string">&quot;boot.spinor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;APPCFG&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;64&quot;</span> <span class="attr">readonly</span>=<span class="string">&quot;false&quot;</span> <span class="attr">file</span>=<span class="string">&quot;app_cfg.bin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;APPCFGDEF&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;64&quot;</span> <span class="attr">readonly</span>=<span class="string">&quot;false&quot;</span> <span class="attr">file</span>=<span class="string">&quot;app_cfg_def.bin&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;sig&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;64&quot;</span> <span class="attr">file</span>=<span class="string">&quot;sig.bin&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;ENV&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;64&quot;</span> <span class="attr">file</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;ENV_BAK&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;64&quot;</span> <span class="attr">file</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;ROOTFS&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;8192&quot;</span> <span class="attr">readonly</span>=<span class="string">&quot;false&quot;</span> <span class="attr">file</span>=<span class="string">&quot;rootfs.spinor&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;MISC&quot;</span> <span class="attr">size_in_kb</span>=<span class="string">&quot;512&quot;</span> <span class="attr">file</span>=<span class="string">&quot;logo.jpg&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">partition</span> <span class="attr">label</span>=<span class="string">&quot;DATA&quot;</span>  <span class="attr">readonly</span>=<span class="string">&quot;false&quot;</span> <span class="attr">file</span>=<span class="string">&quot;&quot;</span> <span class="attr">mountpoint</span>=<span class="string">&quot;/mnt/data&quot;</span> <span class="attr">type</span>=<span class="string">&quot;jffs2&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">physical_partition</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>å†™ <code>partition</code> æ—¶è¿˜è¦æ³¨æ„å¯¹é½é—®é¢˜ï¼Œè¿™ä¸ªä¸ <code>flash</code> æœ‰å…³ï¼Œæ¯”å¦‚åœ¨ <code>1812h_nand</code> ä½¿ç”¨çš„ <code>flash</code> æ˜¯ <code>W25N02KVxxIR/U</code>ï¼ŒæŸ¥çœ‹å…¶æ•°æ®æ‰‹å†Œå¯ä»¥çœ‹åˆ°ï¼Œæœ€å°çš„å—åº”è¯¥æ˜¯ <code>128KB</code>ï¼Œå¦‚æœä»ç„¶å°† <code>sig.bin</code> çš„å¤§å°è®¾ç½®ä¸º <code>size_in_kb=&quot;64&quot;</code> ï¼Œçƒ§å½•çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼</p><p>å¦å¤–ï¼Œä¹Ÿè¦æ³¨æ„ <code>parititon</code> ä¸­çš„å¤§å°è¦å’Œ <code>cv181x-asic.h</code> ä¸­è®¾ç½®çš„ <code>CONFIG_NANDBOOTCOMMAND</code> ä¸­ä¸€è‡´ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Flexible Architecture with 128KB blocks</span><br><span class="line">â€“ Uniform 128K-Byte Block Erase</span><br><span class="line">â€“ Flexible page data load methods</span><br></pre></td></tr></table></figure></blockquote><p>ç”±äº <code>fw_dynamic.bin u-boot-raw.bin</code> æ”¾å…¥äº† <code>fip.bin</code> æ–‡ä»¶ä¸­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿›è¡Œ <code>update</code> çš„æ—¶å€™åªéœ€è¦å‡†å¤‡ 3 ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fip.bin</span><br><span class="line">boot.spinor</span><br><span class="line">rootfs.spinor</span><br></pre></td></tr></table></figure><p>è™½ç„¶ <code>upgrade.zip</code> è§£å‹åï¼Œèƒ½çœ‹åˆ° <code>partition.xml</code> ï¼Œä¸è¿‡è¿™ç©æ„å¯ä»¥ä¸è¦ï¼Œå› ä¸ºç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå·²ç»ä»è¯¥æ–‡ä»¶ç”Ÿæˆäº†åˆ†åŒºçš„ <code>.h</code> å¤´æ–‡ä»¶åµŒå…¥åˆ°çš„ä»£ç ä¸­ï¼Œå®é™…çƒ§å½•æ—¶å¹¶ä¸ä¼šç”¨åˆ°ã€‚</p><p>å¦å¤–ï¼Œç”±äº <code>partition</code> çš„åˆ†åŒºåˆ’åˆ†ï¼Œä¸åŒåŒºåŸŸå›ºå®šèµ·å§‹åœ°å€å¹¶ä¸”ä¸ä¼šé‡å ï¼Œå› æ­¤å‡çº§è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åªçƒ§å½•ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸ä¸Šä¸€æ¬¡çƒ§å½•ç›¸æ¯”ï¼Œåªæœ‰ <code>u-boot</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ <code>SD</code> å¡ä¸­åªéœ€è¦å‡†å¤‡ <code>fip.bin</code> å°±è¡Œã€‚å¦‚æœ <code>kernel</code> å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±éœ€è¦ <code>fip.bin</code> å’Œ <code>boot.spinor</code>ï¼Œé¿å…é‡å¤çƒ§å½• <code>rootfs.spinor</code> å¯ä»¥åŠ å¿«ä¸€ç‚¹ç‚¹æ•ˆç‡ã€‚</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/sd%E5%8D%A1%E5%8D%87%E7%BA%A7.png" alt="sd å¡å‡çº§"></p><p>å‡çº§æµç¨‹ä¸ºï¼š</p><ol><li><code>rom</code> ä¸­ <code>bl1</code> ä»£ç å°† <code>bld.bin</code>ï¼ˆ<code>BL2</code> ä»£ç ï¼‰æ¬ç§»åˆ° <code>SRAM</code> ä¸­ï¼›</li><li>æ‰§è¡Œ <code>BL2</code> ä»£ç ï¼Œåˆå§‹åŒ– <code>ddr</code>ï¼Œå°† <code>bldp.bin</code> å’Œ <code>u-boot.bin</code> æ¬ç§»åˆ° <code>ddr</code> ä¸­ï¼›</li><li>æ‰§è¡Œ <code>bldp.bin</code>ï¼ˆ<code>BL31</code> ä»£ç ï¼‰ï¼›</li><li>æ‰§è¡Œ <code>ubootï¼ˆBL33ï¼‰</code>ä»£ç ï¼Œå°† <code>boot.xxx</code>ã€<code>rootfs.xxx</code>ã€<code>fip.bin</code> æ‹·è´åˆ° <code>spinor(nand/emmc)</code>ï¼ˆä¸­é—´éœ€è¦ç»è¿‡ <code>ddr</code>ï¼Œä¸Šå›¾ä¸­æ²¡æœ‰å±•ç¤ºè¯¥è¿‡ç¨‹ï¼‰ï¼›</li><li>ç»§ç»­æ‰§è¡Œ <code>uboot</code> ä»£ç ï¼Œå°† <code>boot.xxx</code> ä» <code>spinor(nand/emmc)</code> è¯»å…¥ <code>ddr</code>ï¼Œå¼€å§‹å¯åŠ¨ <code>kernel</code>ï¼›</li></ol><p><strong>4ã€5 ä¸¤æ­¥ç”± <code>uboot</code> ä¸‹ <code>cvi_update</code> å’Œ <code> run norboot/nandboot/emmcboot</code> æŒ‡ä»¤å®Œæˆ</strong>ï¼Œå…·ä½“æ¥è¯´ï¼Œ<code>cvi_update</code> ä¸»è¦å®Œæˆçš„äº‹æƒ…æœ‰ï¼š</p><ol><li>ä»å‡çº§çš„æºå¤´ä¸Šæ‹·è´ <code>boot.xxxã€rootfs.xxxã€fip.bin</code> åˆ° <code>ddr</code>ï¼›ï¼ˆè¿™é‡Œæºå¤´å¯ä»¥æ˜¯ <code>uart</code>ã€<code>sd</code> å¡ã€<code>usb</code> ç”šè‡³æ˜¯ <code>ethernet</code>ï¼‰</li><li>å°†ä»¥ä¸Šæ–‡ä»¶å†™å…¥å­˜å‚¨ä»‹è´¨ï¼ˆ<code>spinorã€spinandã€emmc</code>ï¼‰ï¼›åç»­å°±å¯ä»¥ç›´æ¥ä» <code>flash</code> å¯åŠ¨ã€‚</li></ol><h4 id="å¯åŠ¨æµç¨‹"><a href="#å¯åŠ¨æµç¨‹" class="headerlink" title="å¯åŠ¨æµç¨‹"></a>å¯åŠ¨æµç¨‹</h4><p>å¯åŠ¨æµç¨‹çš„å‰ä¸‰çº§ <code>fsbl, opensbi, uboot</code> å’Œçƒ§å½•æµç¨‹æ˜¯ä¸€è‡´çš„ï¼Œåªæœ‰åˆ° <code>uboot</code> è¿™é‡Œæ‰§è¡Œçš„å†…å®¹ä¸åŒã€‚</p><p>å†è¯´å¯åŠ¨æµç¨‹ï¼Œåœ¨ <code>uboot</code> å¯åŠ¨å†…æ ¸æ—¶ï¼Œ<code>nor flash</code> ä¸ <code>emmc/nand</code> æœ‰ç‚¹åŒºåˆ«ï¼Œå› ä¸º <code>nor</code> å¯ä»¥ç›´æ¥è¿è¡Œä»£ç ï¼Œè€Œ <code>emmc/nand</code> éœ€è¦å…ˆå°† <code>kernel</code> ä» <code>flash</code> ä¸­åŠ è½½åˆ° <code>ddr</code>ï¼Œç„¶åå†è¿è¡Œã€‚ä¸è¿‡ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨å®‰å…¨å¯åŠ¨æ—¶ï¼Œç”±äºéœ€è¦æ ¡éªŒ <code>kernel</code> çš„ç­¾åï¼Œæ‰€ä»¥å³ä½¿æ˜¯ <code>nor</code> ä¹Ÿéœ€è¦å°† <code>kernel</code> åŠ è½½åˆ° <code>ddr</code>ã€‚</p><h3 id="ç­¾ååŠ å¯†æµç¨‹ä»‹ç»"><a href="#ç­¾ååŠ å¯†æµç¨‹ä»‹ç»" class="headerlink" title="ç­¾ååŠ å¯†æµç¨‹ä»‹ç»"></a>ç­¾ååŠ å¯†æµç¨‹ä»‹ç»</h3><p>ä»ä¸Šé¢çš„çƒ§å½•æµç¨‹å¯ä»¥çœ‹åˆ°ï¼Œå‰æœŸåˆ° <code>uboot</code> è¿è¡Œé˜¶æ®µéƒ½ä¸ <code>fip.bin</code> æœ‰å…³ï¼Œå› æ­¤é¦–å…ˆæˆ‘ä»¬è¦ä¿è¯ <code>fip.bin</code> çš„å®‰å…¨æ€§ï¼Œè¦ä¿è¯å®ƒä¸è¢«ç¯¡æ”¹ã€‚ä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰é‡‡ç”¨ç›´æ¥å¯¹ <code>fip.bin</code> è¿™æ•´ä¸ªæ–‡ä»¶è¿›è¡ŒåŠ å¯†ï¼Œè€Œæ˜¯å¯¹ <code>fip.bin</code> ä¸­æ¯ä¸ªå°æ¨¡å—é€ä¸ªåŠ å¯†ã€ç­¾åã€‚ä¸€ä¸ª <code>fip.bin</code> æ–‡ä»¶çš„æ„æˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/image1.jpg" alt="_images/image1.jpg"></p><p>ä¸»è¦ä¹Ÿå°±æ˜¯å‰é¢è¯´çš„ <code>fsbl, opensbi, u-boot</code>ï¼Œä¸è¿‡è¿˜é¢å¤–å¢åŠ äº†å„çº§çš„ç­¾åï¼ˆå¯é€‰çš„ï¼‰ã€‚ç”Ÿæˆ <code>fip.bin</code> çš„è„šæœ¬æ˜¯<code>fsbl/plat/cv181x/ fiptool.py </code>ï¼Œå¯¹ <code>fip.bin</code> è¿›è¡Œç­¾åå’ŒåŠ å¯†çš„è„šæœ¬ä¹Ÿåœ¨è¯¥ç›®å½•ä¸‹ã€‚</p><blockquote><p>å…·ä½“çš„ <code>fip</code> æ„æˆå¯ä»¥çœ‹ <code>fsbl/plat/cv181x/fiptool.py:143</code> <code>FIP</code> è¿™ä¸ªç±»çš„å®šä¹‰ï¼Œ<code>FIP</code> å°±æ˜¯æŒ‰è¿™é‡Œå®šä¹‰çš„é¡ºåºï¼Œç”±äº”ä¸ªéƒ¨åˆ†ç»„æˆï¼š<code>param1, body1, param2, body2, ldr_2nd_hdr</code>ã€‚ä¸‹é¢æ˜¯ç”Ÿæˆ <code>fip</code> çš„ç¼–è¯‘æ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fsbl/plat/cv181x/fiptool.py -v genfip \</span><br><span class="line">        <span class="string">&#x27;/data/song.yu/cvi_mmf_sdk-intl/fsbl/build/cv1811h_wevb_0007a_spinor/fip.bin&#x27;</span> \</span><br><span class="line">        --MONITOR_RUNADDR=<span class="string">&quot;<span class="variable">$&#123;MONITOR_RUNADDR&#125;</span>&quot;</span> \</span><br><span class="line">        --BLCP_2ND_RUNADDR=<span class="string">&quot;<span class="variable">$&#123;BLCP_2ND_RUNADDR&#125;</span>&quot;</span> \</span><br><span class="line">        --CHIP_CONF=<span class="string">&#x27;/data/song.yu/cvi_mmf_sdk-intl/fsbl/build/cv1811h_wevb_0007a_spinor/chip_conf.bin&#x27;</span> \</span><br><span class="line">        --NOR_INFO=<span class="string">&#x27;FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&#x27;</span> \</span><br><span class="line">        --NAND_INFO=<span class="string">&#x27;00000000&#x27;</span>\</span><br><span class="line">        --BL2=<span class="string">&#x27;/data/song.yu/cvi_mmf_sdk-intl/fsbl/build/cv1811h_wevb_0007a_spinor/bl2.bin&#x27;</span> \</span><br><span class="line">        --BLCP_IMG_RUNADDR=0x05200200 \</span><br><span class="line">        --BLCP_PARAM_LOADADDR=0 \</span><br><span class="line">        --BLCP=<span class="built_in">test</span>/empty.bin \</span><br><span class="line">        --DDR_PARAM=<span class="string">&#x27;test/cv181x/ddr_param.bin&#x27;</span> \</span><br><span class="line">        --BLCP_2ND=<span class="string">&#x27;/data/song.yu/cvi_mmf_sdk-intl/freertos/cvitek/install/bin/cvirtos.bin&#x27;</span> \</span><br><span class="line">        --MONITOR=<span class="string">&#x27;../opensbi/build/platform/generic/firmware/fw_dynamic.bin&#x27;</span> \</span><br><span class="line">        --LOADER_2ND=<span class="string">&#x27;/data/song.yu/cvi_mmf_sdk-intl/u-boot-2021.10/build/cv1811h_wevb_0007a_spinor/u-boot-raw.bin&#x27;</span> \</span><br><span class="line">        --compress=<span class="string">&#x27;lzma&#x27;</span></span><br></pre></td></tr></table></figure></blockquote><h4 id="å‡†å¤‡ç§˜é’¥"><a href="#å‡†å¤‡ç§˜é’¥" class="headerlink" title="å‡†å¤‡ç§˜é’¥"></a>å‡†å¤‡ç§˜é’¥</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½ç§˜é’¥ï¼Œä»ç§˜é’¥çš„åç¼€å¯ä»¥çœ‹å‡ºå…¶ç±»å‹ï¼Œ<code>.key</code> ä¸º <code>AES</code> åŠ å¯†ä½¿ç”¨çš„ï¼Œ<code>.pem</code> ä¸º <code>RSA</code> ç®—æ³•ä½¿ç”¨çš„ã€‚</p><table><thead><tr><th>æ–‡ä»¶</th><th>ä½œç”¨</th><th>ä½¿ç”¨ä½ç½®</th></tr></thead><tbody><tr><td>rsa_hash0.pem</td><td>ç”¨äºç»™ <code>bl_priv.pem</code> ç­¾åçš„ <code>RSA</code> ç§é’¥ï¼Œå…¬é’¥ï¼ˆçš„ <code>hash</code> å€¼ï¼‰è¢«çƒ§åˆ° <code>HASH0_PUBLIC</code></td><td><code>rom code</code></td></tr><tr><td>bl_priv.pem</td><td>ç”¨äºç»™ <code>fsbl/opensbi/u-boot</code> ç”Ÿæˆç­¾åçš„ <code>RSA</code> ç§é’¥</td><td><code>fsbl</code></td></tr><tr><td>loader_ek.key</td><td>ç”¨äºç»™ <code>bl_ek.key</code> åŠ ã€è§£å¯†çš„ <code>AES</code> ç§˜é’¥ï¼Œä¹Ÿä¼šè¢«çƒ§å†™åˆ° <code>eFuse</code></td><td><code>rom code</code></td></tr><tr><td>bl_ek.key</td><td>ç”¨äºç»™ <code>fsbl/opensbi/u-boot</code> åŠ ã€è§£å¯†çš„ <code>AES</code> ç§˜é’¥</td><td><code>fsbl</code></td></tr></tbody></table><p><code>RSA</code> å¯†é’¥ä½¿ç”¨ <code>2048 bits</code> å’Œç¬¬ 4 è´¹é©¬æ•°ï¼Œ<strong>ç”¨äºç­¾å</strong>ï¼š</p><blockquote><p><strong>è™½ç„¶è¿™é‡Œè¯´â€œç­¾åâ€ï¼Œ<del>ä½†å’Œå‰é¢æ‰€è¯´çš„â€œæ¶ˆæ¯æ‘˜è¦â€å¹¶ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œéœ€è¦æ³¨æ„</del>ï¼ğŸ™„ğŸ™„æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä½†ç­¾åä¼šç”¨åˆ°ç§é’¥ï¼Œè€Œä¸ä»…ä»…æ˜¯ç›´æ¥ä½¿ç”¨ sha256 ç®—æ³•ä¹‹ç±»çš„ã€‚</strong>ç§é’¥ç­¾åï¼Œå…¬é’¥éªŒè¯ã€‚</p><p><code>PKCS#1 v1.5</code> æ˜¯ä¸€ç§å…¬é’¥å¯†ç å­¦æ ‡å‡†ï¼Œç”¨äºæ•°å­—ç­¾åå’ŒéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚å®ƒé€šå¸¸ä¸ <code>RSA</code> å¯†é’¥å¯¹ä¸€èµ·ä½¿ç”¨ã€‚</p><ol><li><strong>æ•°å­—ç­¾å</strong>ï¼šç­¾åè¿‡ç¨‹ä¼šä½¿ç”¨<strong>ç§é’¥</strong>ç”Ÿæˆä¸€ä¸ªä¸æ¶ˆæ¯ç›¸å…³è”çš„<strong>æ•°å­—ç­¾å</strong>ï¼Œä»¥ä¾¿åœ¨ä»¥åéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚</li><li><strong>æ•°å­—ç­¾åéªŒè¯</strong>ï¼šéªŒè¯è¿‡ç¨‹ä¼šä½¿ç”¨ä¸ç­¾åç›¸å…³çš„<strong>å…¬é’¥</strong>æ¥éªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ï¼Œä»¥ç¡®ä¿æ¶ˆæ¯æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¹¶ä¸”ç¡®å®æ˜¯ç”±ç§é’¥æŒæœ‰è€…ç­¾åçš„ã€‚</li></ol></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host$ openssl genrsa -out rsa_hash0.pem -F4 2048</span><br><span class="line">host$ openssl genrsa -out bl_priv.pem -F4 2048</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ºä»€ä¹ˆè¿™é‡Œä¸¤ä¸ª <code>rsa</code> ç§˜é’¥éƒ½æ˜¯ç§é’¥â“å…¬é’¥åœ¨å“ªå‘¢â“</p><p>ç­”ï¼š<code>RSA</code> ç®—æ³•çš„ç§é’¥ä¸­å®é™…ä¸ŠåŒ…å«äº†å…¬é’¥çš„ä¸€éƒ¨åˆ†ä¿¡æ¯ï¼Œå…·ä½“æ¥è¯´ï¼ŒåŒ…æ‹¬äº†<strong>æ¨¡æ•°</strong>å’Œ<strong>å…¬é’¥æŒ‡æ•°</strong>ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°å°±å¯ä»¥æ¨å‡ºå…¬é’¥ğŸ˜®ã€‚ä¸è¿‡å…¬é’¥æ˜¯æ— æ³•æ¨å‡ºç§é’¥çš„ï¼Œè¿™æ˜¯ <code>rsa</code> ç®—æ³•çš„å®‰å…¨ä¿éšœã€‚</p></blockquote><p><code>AES</code> çš„ç§˜é’¥<strong>ä½¿ç”¨é•¿åº¦ 16 çš„éšæœºæ•°</strong>ï¼ˆ<code>AES-128</code>ï¼‰ï¼Œ<strong>ç”¨äºåŠ å¯†</strong>ï¼šï¼ˆåªç­¾åä¸åŠ å¯†å°±ç”¨ä¸åˆ°è¿™ä¸ªï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host$ <span class="built_in">head</span> -c 16 /dev/random &gt; loader_ek.key</span><br><span class="line">host$ <span class="built_in">head</span> -c 16 /dev/random &gt; bl_ek.key</span><br></pre></td></tr></table></figure><h4 id="fip-ç»„æˆç»“æ„"><a href="#fip-ç»„æˆç»“æ„" class="headerlink" title="fip ç»„æˆç»“æ„"></a>fip ç»„æˆç»“æ„</h4><p>è¿™é‡Œå¾—çœ‹ä¸€ä¸‹ <code>fip.bin</code> çš„æ„æˆï¼Œåœ¨ <code>fsbl/plat/cv181x/fiptool.py:143</code> ä¸­å®šä¹‰ï¼Œä¸‹é¢æœ‰çœç•¥ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FIP</span>:</span><br><span class="line">    <span class="comment"># FIP å°±æ˜¯æŒ‰è¿™é‡Œå®šä¹‰çš„é¡ºåºï¼šparam1, body1, param2, body2, ldr_2nd_hdr</span></span><br><span class="line">    param1 = OrderedDict(</span><br><span class="line">        [</span><br><span class="line">            Entry.make(<span class="string">&quot;MAGIC1&quot;</span>, <span class="number">8</span>, <span class="built_in">int</span>, <span class="string">b&quot;CVBL01\n\0&quot;</span>),</span><br><span class="line">            Entry.make(<span class="string">&quot;MAGIC2&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">            Entry.make(<span class="string">&quot;BL2_IMG_CKSUM&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">            Entry.make(<span class="string">&quot;BL2_IMG_SIZE&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">            Entry.make(<span class="string">&quot;BLD_IMG_SIZE&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">            Entry.make(<span class="string">&quot;BL_EK&quot;</span>, <span class="number">32</span>, <span class="built_in">bytes</span>),             <span class="comment"># å­˜å‚¨ bl_ek ï¼Ÿ</span></span><br><span class="line">            Entry.make(<span class="string">&quot;ROOT_PK&quot;</span>, <span class="number">512</span>, <span class="built_in">bytes</span>),          <span class="comment"># å­˜å‚¨ rsa_hash0.pem ? 512 å­—èŠ‚åªæ˜¯æœ€å¤§é•¿åº¦å§</span></span><br><span class="line">            Entry.make(<span class="string">&quot;BL_PK&quot;</span>, <span class="number">512</span>, <span class="built_in">bytes</span>),            <span class="comment"># å­˜å‚¨ bl_priv.pem ?</span></span><br><span class="line">            Entry.make(<span class="string">&quot;BL_PK_SIG&quot;</span>, <span class="number">512</span>, <span class="built_in">bytes</span>),        <span class="comment"># å­˜å‚¨ bl_priv.pem çš„ç­¾å</span></span><br><span class="line">            Entry.make(<span class="string">&quot;CHIP_CONF_SIG&quot;</span>, <span class="number">512</span>, <span class="built_in">bytes</span>),</span><br><span class="line">            Entry.make(<span class="string">&quot;BL2_IMG_SIG&quot;</span>, <span class="number">512</span>, <span class="built_in">bytes</span>),      <span class="comment"># å­˜å‚¨ bl2(fsbl) é•œåƒçš„ç­¾å</span></span><br><span class="line">            Entry.make(<span class="string">&quot;BLCP_IMG_SIG&quot;</span>, <span class="number">512</span>, <span class="built_in">bytes</span>),     <span class="comment"># å­˜å‚¨ blcp é•œåƒçš„ç­¾å</span></span><br><span class="line">        ]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    body1 = OrderedDict(</span><br><span class="line">        [</span><br><span class="line">            Entry.make(<span class="string">&quot;BLCP&quot;</span>, <span class="literal">None</span>, <span class="built_in">bytes</span>),            <span class="comment"># å¡«å…… blcp</span></span><br><span class="line">            Entry.make(<span class="string">&quot;BL2&quot;</span>, <span class="literal">None</span>, <span class="built_in">bytes</span>),             <span class="comment"># å¡«å…… bl2</span></span><br><span class="line">        ]</span><br><span class="line">    )</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ <code>param1</code> ä¸­å­˜å‚¨ç€ <code>BL2</code> ï¼ˆä¹Ÿå°±æ˜¯ <code>fsbl</code> é•œåƒï¼‰çš„ç­¾åã€‚ä» <code>fsbl/plat/cv181x/fipsign.py:sign</code> ä¸­å¯ä»¥çœ‹åˆ°å…·ä½“çš„èµ‹å€¼è¿‡ç¨‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç­¾åçš„ä¸»å‡½æ•°</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sign</span>(<span class="params">self</span>):</span><br><span class="line">    logging.info(<span class="string">&quot;sign fip.bin&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å¤„ç† fip çš„ param1 éƒ¨åˆ†</span></span><br><span class="line">    self.param1[<span class="string">&quot;FIP_FLAGS&quot;</span>].content = self.FIP_FLAGS_SCS_MASK | self.param1[<span class="string">&quot;FIP_FLAGS&quot;</span>].toint()</span><br><span class="line">    self.sign_bl_pk()</span><br><span class="line">    cc = self.param1[<span class="string">&quot;CHIP_CONF&quot;</span>].content</span><br><span class="line">    cc_size = unpack(<span class="string">&quot;&lt;I&quot;</span>, self.param1[<span class="string">&quot;CHIP_CONF_SIZE&quot;</span>].content)[<span class="number">0</span>]</span><br><span class="line">    logging.debug(<span class="string">&quot;CHIP_CONF_SIZE=%#x&quot;</span>, cc_size)</span><br><span class="line">    cc = cc[:cc_size]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸»è¦å…³æ³¨è¿™é‡Œ 3 ä¸ª sign_by_bl_priv</span></span><br><span class="line">    self.param1[<span class="string">&quot;CHIP_CONF_SIG&quot;</span>].content = self.sign_by_bl_priv(cc)</span><br><span class="line">    self.param1[<span class="string">&quot;BL2_IMG_SIG&quot;</span>].content = self.sign_by_bl_priv(self.body1[<span class="string">&quot;BL2&quot;</span>].content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.body1[<span class="string">&quot;BLCP&quot;</span>].content:</span><br><span class="line">        logging.debug(<span class="string">&quot;sign blcp&quot;</span>)</span><br><span class="line">        self.param1[<span class="string">&quot;BLCP_IMG_SIG&quot;</span>].content = self.sign_by_bl_priv(self.body1[<span class="string">&quot;BLCP&quot;</span>].content)</span><br><span class="line"></span><br><span class="line">    self.sign_fip2()</span><br></pre></td></tr></table></figure><p>ä¸»è¦å…³æ³¨è¿™é‡Œ 3 ä¸ª <code>sign_by_bl_priv</code>ï¼Œå°† <code>BL2</code> é•œåƒé€šè¿‡ <code>bl_priv.pem</code> ç§é’¥è¿›è¡Œç­¾åï¼Œç„¶åå°†ç­¾åç»“æœæ”¾åœ¨ <code>param1[&quot;BL2_IMG_SIG&quot;]</code>ã€‚æ¿ç«¯é€šè¿‡å†™åœ¨ <code>efuse</code> çš„å…¬é’¥ï¼Œå¯¹ <code>BL2</code> åˆè®¡ç®—ä¸€æ¬¡ç­¾åï¼Œå’Œ <code>fip</code> ä¸­çš„ç­¾åå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´åˆ™è¯´æ˜è¯¥ <code>fip</code> ç¡®å®æ˜¯ç§é’¥æŒæœ‰è€…æä¾›çš„ã€‚</p><p>ä¸Šé¢åªæ˜¯å¯¹ <code>bl2</code> è¿›è¡Œäº†ç­¾åï¼Œ<code>FIP</code> çš„ååŠéƒ¨åˆ†è¿˜æœ‰ <code>opensbi</code>ï¼Œ <code>uboot</code>ï¼ˆåŒæ ·æœ‰çœç•¥ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">param2 = OrderedDict(</span><br><span class="line">    [</span><br><span class="line">        Entry.make(<span class="string">&quot;MAGIC1&quot;</span>, <span class="number">8</span>, <span class="built_in">int</span>, <span class="string">b&quot;CVLD02\n\0&quot;</span>),</span><br><span class="line">        Entry.make(<span class="string">&quot;MONITOR_CKSUM&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),                <span class="comment"># ATF-BL31 or OpenSBI</span></span><br><span class="line">        Entry.make(<span class="string">&quot;MONITOR_LOADADDR&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">        Entry.make(<span class="string">&quot;LOADER_2ND_RESERVED0&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),         <span class="comment"># uboot</span></span><br><span class="line">        Entry.make(<span class="string">&quot;LOADER_2ND_LOADADDR&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),          <span class="comment"># Reserved</span></span><br><span class="line">        Entry.make(<span class="string">&quot;RESERVED_LAST&quot;</span>, <span class="number">4096</span> - <span class="number">16</span> * <span class="number">5</span>, <span class="built_in">bytes</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">body2 = OrderedDict(</span><br><span class="line">    [</span><br><span class="line">        Entry.make(<span class="string">&quot;MONITOR&quot;</span>, <span class="literal">None</span>, <span class="built_in">bytes</span>),     <span class="comment"># å¡«å…… opensbi é•œåƒ</span></span><br><span class="line">        Entry.make(<span class="string">&quot;LOADER_2ND&quot;</span>, <span class="literal">None</span>, <span class="built_in">bytes</span>),  <span class="comment"># å¡«å…… uboot é•œåƒ</span></span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">ldr_2nd_hdr = OrderedDict(</span><br><span class="line">    [</span><br><span class="line">        Entry.make(<span class="string">&quot;MAGIC&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">        Entry.make(<span class="string">&quot;CKSUM&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">        Entry.make(<span class="string">&quot;SIZE&quot;</span>, <span class="number">4</span>, <span class="built_in">int</span>),</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä¸ <code>param1</code> ä¸åŒï¼Œè¿™é‡Œ <code>param2</code> ä¸­å¹¶æ²¡æœ‰æˆå‘˜ä¸“é—¨è®°å½• <code>uboot</code> çš„ç­¾åï¼Œè€Œæ˜¯ç›´æ¥æ”¾åœ¨äº†é•œåƒçš„æœ«å°¾ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¯¹ <code>opensbi</code> è¿›è¡Œç­¾åã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">e = self.body2[<span class="string">&quot;LOADER_2ND&quot;</span>] <span class="comment"># e å°±æ˜¯ uboot çš„é•œåƒ</span></span><br><span class="line"><span class="comment"># åœ¨æœ«å°¾é¢„ç•™ç­¾åçš„ç©ºé—´ï¼Œå†å¡«å…… \0 æŒ‰ IMAGE_ALIGN å¯¹é½</span></span><br><span class="line">e.content = self.pad(e.content + <span class="string">b&quot;\xCE&quot;</span> * sig_size, IMAGE_ALIGN)</span><br><span class="line"><span class="comment"># SIZE is after CKSUM, update it before signing</span></span><br><span class="line">self._update_ldr_2nd_hdr()</span><br><span class="line"></span><br><span class="line">image = <span class="built_in">bytearray</span>(e.content)</span><br><span class="line"><span class="comment"># è®¡ç®—ç­¾åï¼Œä¸åŒ…å«æœ€åé¢„ç•™ç»™å­˜å‚¨â€ç­¾åâ€œçš„å†…å®¹ã€‚</span></span><br><span class="line">sig = self.sign_by_bl_priv(image[self.ldr_2nd_hdr[<span class="string">&quot;CKSUM&quot;</span>].end : -sig_size])</span><br><span class="line"><span class="keyword">assert</span> sig_size == <span class="built_in">len</span>(sig)</span><br><span class="line">image[-sig_size:] = sig</span><br><span class="line"></span><br><span class="line">e.content = image</span><br></pre></td></tr></table></figure><h4 id="efuse-ä»‹ç»"><a href="#efuse-ä»‹ç»" class="headerlink" title="efuse ä»‹ç»"></a>efuse ä»‹ç»</h4><p><code>eFuse</code> ä¹Ÿå°±æ˜¯<strong>å¯ç¼–ç¨‹ç”µå­ç†”ä¸</strong>ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒå­˜å‚¨çš„æ•°æ®åªèƒ½å†™ <code>1</code> ä¸èƒ½å†™ <code>0</code>ï¼Œæœ€åˆå…¨ä¸º 0ï¼Œä¸€æ—¦å†™å…¥å°±æ— æ³•æ›´æ”¹ã€‚å…·æœ‰ä»¥ä¸‹ä¸»è¦ç‰¹ç‚¹ï¼š</p><ol><li><strong>ä¸å¯é€†æ€§</strong>ï¼šä¸€æ—¦é…ç½®ï¼Œ<code>eFuse</code> é€šå¸¸æ— æ³•è¢«æ“¦é™¤æˆ–é‡ç½®ã€‚è¿™æ„å‘³ç€ä¸€æ—¦ä¿¡æ¯è¢«å†™å…¥ <code>eFuse</code>ï¼Œå®ƒå°†æ°¸ä¹…å­˜å‚¨åœ¨å…¶ä¸­ï¼Œä¸èƒ½å†æ¬¡ä¿®æ”¹æˆ–æ¸…é™¤ã€‚è¿™ç§ä¸å¯é€†æ€§å¢å¼ºäº†å­˜å‚¨åœ¨ <code>eFuse</code> ä¸­çš„ä¿¡æ¯çš„å®‰å…¨æ€§ã€‚ï¼ˆä¸å¯æ“¦é™¤ï¼‰</li><li><strong>ç”µæ°”å¯ç¼–ç¨‹</strong>ï¼š<code>eFuse</code> å¯ä»¥é€šè¿‡ç”µæ°”ç¼–ç¨‹æ–¹å¼è¿›è¡Œé…ç½®ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨é¢å¤–çš„è®¾å¤‡æˆ–å·¥å…·ã€‚è¿™ç§å¯ç¼–ç¨‹æ€§ä½¿å¾—å®ƒåœ¨åˆ¶é€ è¿‡ç¨‹ä¸­æˆ–è®¾å¤‡çš„ç”Ÿå‘½å‘¨æœŸä¸­å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œé…ç½®ã€‚ï¼ˆå¯å†™å…¥ï¼‰</li><li><strong>é«˜å¯é æ€§</strong>ï¼š<code>eFuse</code> é€šå¸¸å…·æœ‰é«˜åº¦çš„å¯é æ€§å’Œç¨³å®šæ€§ï¼Œå¯ä»¥åœ¨å¹¿æ³›çš„æ¸©åº¦èŒƒå›´å’Œç¯å¢ƒæ¡ä»¶ä¸‹æ­£å¸¸å·¥ä½œã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºå„ç§åº”ç”¨ï¼ŒåŒ…æ‹¬æç«¯ç¯å¢ƒä¸‹çš„ç”¨é€”ã€‚</li><li><strong>ç‰©ç†å®‰å…¨</strong>ï¼š<code>eFuse</code> <strong>é€šå¸¸é›†æˆåœ¨èŠ¯ç‰‡å†…éƒ¨</strong>ï¼Œéš¾ä»¥ç‰©ç†ä¸Šè®¿é—®æˆ–ç ´åã€‚è¿™å¢å¼ºäº†å­˜å‚¨åœ¨å…¶ä¸­çš„æ•æ„Ÿä¿¡æ¯çš„ç‰©ç†å®‰å…¨æ€§ï¼Œé˜²æ­¢äº†ç¡¬ä»¶çº§åˆ«çš„æ”»å‡»ã€‚</li></ol><p><code>eFuse</code> çš„ä¸Šè¿°ç‰¹ç‚¹ï¼Œå¾ˆé€‚åˆç”¨æ¥å­˜å‚¨æ¿ç«¯çš„ç§˜é’¥ã€‚</p><h4 id="fip-ç­¾åæµç¨‹"><a href="#fip-ç­¾åæµç¨‹" class="headerlink" title="fip ç­¾åæµç¨‹"></a>fip ç­¾åæµç¨‹</h4><blockquote><p>ç›´æ¥ä½¿ç”¨ <code>fipsign.py</code> è¿™ä¸ªè„šæœ¬ï¼Œ<code>fip.bin</code> ä¸ºåŸå§‹é•œåƒï¼Œ<code>fip_sign.bin</code> ä¸ºç­¾ååçš„é•œåƒã€‚æ³¨æ„è¿™é‡Œä»…ä½¿ç”¨äº† <code>RSA</code> ç§˜é’¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ ./fipsign.py sign \</span><br><span class="line">      --root-priv=rsa_hash0.pem \</span><br><span class="line">      --bl-priv=bl_priv.pem \</span><br><span class="line">      fip.bin fip_sign.bin</span><br></pre></td></tr></table></figure></blockquote><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8.drawio.png" alt="å®‰å…¨å¯åŠ¨.drawio"></p><blockquote><p>å›¾ä¸­ <code>PK</code> è¡¨ç¤ºå…¬é’¥çš„ <code>N</code> å€¼ï¼Œ<code>_SIG/sign</code> è¡¨ç¤ºæ•°å­—ç­¾åã€‚</p></blockquote><ol><li><p>ä¿®æ”¹ <code>FIP_FLAGS</code> è¡¨æ˜è¿™ä¸ª <code>fip.bin</code> ä¸­æœ‰ç­¾åï¼Œéœ€è¦éªŒè¯ã€‚</p></li><li><p>ä»ç§é’¥ <code>rsa_hash0.pem</code> ä¸­æå– <code>N</code> å€¼å¹¶å†™åˆ° <code>fip.bin</code> ä¸­ï¼Œè¯¥ <code>N</code> å€¼å’Œ <code>rom</code> ä¸­å›ºåŒ–çš„ <code>E=0x10001</code> å¯ç»„æˆå…¬é’¥ï¼Œç”¨äºç­¾åéªŒè¯ã€‚</p></li><li><p><code>N</code> å€¼çš„ <code>sha256</code> æ•£åˆ—å€¼ä¼šè¢«å†™å…¥åˆ° <code>efuse</code> çš„ <code>LOCK_HASH0_PUBLIC </code>ï¼ŒéªŒè¯æ—¶å…ˆè®¡ç®— <code>fip.bin</code> ä¸­çš„ <code>N</code> å€¼çš„æ•£åˆ—å€¼ï¼Œä¸ <code>efuse</code> ä¸­å­˜å‚¨çš„æ•£åˆ—å€¼æ¯”è¾ƒï¼Œæ¥ç¡®è®¤ <code>N</code> å€¼ï¼ˆæˆ–è€…è¯´å…¬é’¥ï¼‰æ˜¯å¦ä¸æœ€åˆçš„ä¸€è‡´ã€‚</p></li><li><p>æå– <code>bl_priv.pem</code> çš„ <code>N</code> å€¼å†™å…¥åˆ° <code>fip.bin</code> ä¸­ã€‚</p></li><li><p>è®¡ç®— <code>bl_priv.pem</code> çš„ <code>N</code> å€¼çš„æ•°å­—ç­¾åï¼Œå¹¶å†™å…¥åˆ° <code>fip.bin</code> ä¸­ã€‚è¯¥ç­¾åæ˜¯é€šè¿‡ <code>rsa_hash0.pem</code> è¿™ä¸ªç§é’¥è®¡ç®— ï¼Œå¯ç”¨ <code>rsa_hash0.pem</code> çš„å…¬é’¥éªŒè¯ã€‚</p><blockquote><p>å®é™…æ˜¯ <code>bl_priv.pem</code> çš„ <code>N</code> å€¼çš„ SHA256 æ•£åˆ—å€¼çš„æ•°å­—ç­¾åï¼Œè¿™é‡Œç®€å•ç‚¹è¯´æ–¹ä¾¿ç†è§£ã€‚</p></blockquote></li><li><p>è®¡ç®— <code>bl2.bin(fsbl)</code> çš„æ•°å­—ç­¾åï¼Œè¯¥ç­¾åé€šè¿‡ <code>bl_priv.pem</code> è¿™ä¸ªç§é’¥è®¡ç®—ï¼Œç”¨ <code>BL_PK</code> éªŒè¯ã€‚</p></li><li><p>è®¡ç®— <code>fw_dynamic.bin(opensbi)</code> çš„æ•°å­—ç­¾åï¼Œè¯¥ç­¾åé€šè¿‡ <code>bl_priv.pem</code> è¿™ä¸ªç§é’¥è®¡ç®—ï¼Œç”¨ <code>BL_PK</code> éªŒè¯ã€‚</p></li><li><p>è®¡ç®— <code>u-boot-raw.bin(uboot)</code> çš„æ•°å­—ç­¾åï¼Œè¯¥ç­¾åé€šè¿‡ <code>bl_priv.pem</code> è¿™ä¸ªç§é’¥è®¡ç®—ï¼Œç”¨ <code>BL_PK</code> éªŒè¯ã€‚</p></li></ol><h4 id="fip-ç­¾å-åŠ å¯†æµç¨‹"><a href="#fip-ç­¾å-åŠ å¯†æµç¨‹" class="headerlink" title="fip ç­¾å+åŠ å¯†æµç¨‹"></a>fip ç­¾å+åŠ å¯†æµç¨‹</h4><blockquote><p>ç›´æ¥ä½¿ç”¨ <code>fipsign.py</code> è¿™ä¸ªè„šæœ¬ï¼Œ<code>fip.bin</code> ä¸ºåŸå§‹é•œåƒï¼Œ<code>fip_enc.bin</code> ä¸ºç­¾å+åŠ å¯†åçš„é•œåƒã€‚è¿™é‡Œä½¿ç”¨äº† <code>RSA</code> å’Œ <code>AES</code> ç§˜é’¥ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ ./fipsign.py sign-enc \</span><br><span class="line">         --root-priv=rsa_hash0.pem \</span><br><span class="line">         --bl-priv=bl_priv.pem \</span><br><span class="line">         --ldr-ek=loader_ek.key \</span><br><span class="line">         --bl-ek=bl_ek.key \</span><br><span class="line">         fip.bin fip_enc.bin</span><br></pre></td></tr></table></figure></blockquote><p><code>fip</code> çš„ç­¾åå¹¶åŠ å¯†ä¹Ÿå°±æ˜¯åœ¨ä¸Šé¢ç­¾åçš„åŸºç¡€ä¸Šï¼Œå†å¯¹å„ä¸ª <code>bin</code> æ–‡ä»¶è¿›è¡ŒåŠ å¯†ã€‚åŠ å¯†ä¸»è¦ä¾èµ–ä¸¤ä¸ª <code>AES</code> ç§˜é’¥ï¼Œ<code>loader_ek</code> å’Œ <code>bl_ek</code>ã€‚å‰è€…ä¼šè¢«å†™å…¥ <code>efuse</code>ï¼Œå¹¶ç”¨äºå¯¹ <code>bl_ek</code> çš„åŠ ã€è§£å¯†ã€‚<code>bl_ek</code> åŠ å¯†åæ”¾å…¥ <code>fip.bin</code> ä¸­ï¼Œ<code>bl_ek</code> ç”¨äºå¯¹å„ä¸ª <code>bin</code> æ–‡ä»¶è¿›è¡ŒåŠ å¯†ã€‚éªŒè¯æ—¶å…ˆé€šè¿‡ <code>efuse</code> ä¸­çš„æ˜æ–‡çš„ <code>loader_ek</code> ç§˜é’¥å¯¹ fip.bin ä¸­åŠ å¯†åçš„ <code>bl_ek</code> è¿›è¡Œè§£å¯†å¾—åˆ° <code>bl_ek</code>ã€‚ç„¶åç”¨å®ƒå¯¹å„ä¸ª <code>bin</code> æ–‡ä»¶è¿›è¡Œè§£å¯†ã€‚</p><p>éªŒè¯çš„æµç¨‹ç›¸åï¼Œå…ˆè§£å¯†åå†éªŒè¯ç­¾åã€‚</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-enc-fip.drawio.png" alt="å®‰å…¨å¯åŠ¨-sign-enc-fip.drawio"></p><ol><li>å°† <code>loader_ek.key</code> æ˜æ–‡å†™å…¥ <code>efuse</code>ã€‚</li><li>ç”¨ <code>loader_ek.key</code> åŠ å¯† <code>bl_ek.key</code> åå†™å…¥ <code>fip.bin</code>ã€‚</li><li>ç”¨ <code>bl_ek.key</code> å¯¹ <code>bl2.bin</code> è¿›è¡ŒåŠ å¯†ã€‚</li><li>ç”¨ <code>bl_ek.key</code> å¯¹ <code>fw_dynamic.bin</code> è¿›è¡ŒåŠ å¯†ã€‚</li><li>ç”¨ <code>bl_ek.key</code> å¯¹ <code>u-boot-raw.bin</code> è¿›è¡ŒåŠ å¯†ã€‚</li></ol><p>å…·ä½“ç­¾åçš„å®ç°æ¶‰åŠåˆ° <code>fsbl/plat/cv181x/</code> ç›®å½•ä¸‹çš„ <code>fipsign.py</code> å’Œ <code>fiptool.py</code>ã€‚å‰é¢ [fip ç»„æˆç»“æ„](#fip ç»„æˆç»“æ„) ä¹Ÿæåˆ°äº†éƒ¨åˆ†å®ç°ã€‚</p><blockquote><p><code>param2/ldr_2nd_hdr</code> ä¸­è®°å½•çš„ä¿¡æ¯ä¹Ÿä¼šéšç€ç­¾åã€åŠ å¯†æ›´æ–°ï¼Œè¿™é‡Œå¹¶ä¸å…³æ³¨è¿™äº›ç»†èŠ‚ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">encrypt_fip</span><br><span class="line">  â”œâ”€â–ºread_fip</span><br><span class="line">  â”œâ”€â–ºsign</span><br><span class="line">  â”‚   â”œâ”€â–ºsign_bl_pk</span><br><span class="line">  â”‚   â”œâ”€â–ºsign_by_bl_priv(BL2</span><br><span class="line">  â”‚   â”œâ”€â–ºsign_by_bl_priv(MONITOR</span><br><span class="line">  â”‚   â””â”€â–ºsign_by_bl_priv(LOADER_2ND_LOADADDR</span><br><span class="line">  â””â”€â–ºencrypt</span><br><span class="line">      â”œâ”€â–º_aes_encrypt(LOADER_EK, BL_EK)  # (ç§˜é’¥ï¼Œå¾…åŠ å¯†å†…å®¹)</span><br><span class="line">      â”œâ”€â–º_aes_encrypt(BL_EK, BL2)</span><br><span class="line">      â”œâ”€â–º_aes_encrypt(BL_EK, MONITOR)</span><br><span class="line">      â””â”€â–º_aes_encrypt(BL_EK, LOADER_2ND_LOADADDR)</span><br></pre></td></tr></table></figure><hr><h4 id="fip-æ ¡éªŒæµç¨‹"><a href="#fip-æ ¡éªŒæµç¨‹" class="headerlink" title="fip æ ¡éªŒæµç¨‹"></a>fip æ ¡éªŒæµç¨‹</h4><p><code>fip.bin</code>  çš„æ ¡éªŒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ä»£ç æ˜¯ä½äº <code>ROM</code> ä¸­ï¼ˆæ²¡æœ‰æƒé™æŸ¥çœ‹ï¼Œåªèƒ½åˆç†çŒœæµ‹ <code>fsbl</code> ä¸­ç¼ºå°‘çš„å°±æ˜¯åœ¨ <code>rom</code> ä¸­å®Œæˆçš„ï¼‰ï¼šä¸ç”¨çŒœæµ‹ï¼Œæµ‹è¯•å°±è¡Œï¼Œ<code>ROOT_PK</code>ï¼Œ<code>BL_PK</code>ï¼Œ<code>BL2</code>çš„ç­¾åæ ¡éªŒéƒ½æ˜¯åœ¨ <code>rom code</code> ä¸­å®Œæˆã€‚<del>ä» <code>efuse</code> è¯»å– AES ç§˜é’¥ <code>LOADER_EK</code></del>ã€‚æ ¡éªŒä¸é€šè¿‡åˆ™ä¸è¿›è¡Œçƒ§å½•ï¼Œç›´æ¥ä» <code>flash</code> åŠ è½½ <code>fsbl</code>ï¼Œæ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C.SCS/3/3.URPL.SDI/25000000/6000000.BS/SD.PS.SD/0x0/0x1000/0x1000/0.VRK4. E:verify root (-14)</span><br><span class="line"> W:DL cancelled. Load flash. (1).</span><br><span class="line">BS/NOR.PS.VRK4.VBK.DK4.VCC.PE.BS.DB2.VB2.BE.J.</span><br><span class="line">FSBL Jb2829:ga05fb6172-dirty:2023-09-19T10:28:45+08:00</span><br><span class="line"></span><br><span class="line">C.SCS/3/3.URPL.SDI/25000000/6000000.BS/SD.PS.SD/0x0/0x1000/0x1000/0.VRK4. E:verify bl_pk (-14)</span><br><span class="line">C.SCS/3/3.URPL.SDI/25000000/6000000.BS/SD.PS.SD/0x0/0x1000/0x1000/0.VRK4. E:verify BL2 (-14)</span><br></pre></td></tr></table></figure><p>è€Œ <code>FSBL</code> ä¸­çš„è§£å¯†ã€éªŒç­¾çš„æµç¨‹å¦‚ä¸‹ï¼šåŠ è½½æ—¶ï¼Œæ‰å»è§£å¯† + æ ¡éªŒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bl2_main</span><br><span class="line">   â”‚</span><br><span class="line">   â””â”€â–ºload_rest</span><br><span class="line">         â”‚</span><br><span class="line">         â”œâ”€â”€â–ºload_blcp_2nd â”€â”€â”€â”</span><br><span class="line">         â”‚                    â”‚</span><br><span class="line">         â”œâ”€â”€â–ºload_monitor â”€â”€â”€â”€â”¼â”€â”€â–ºdec_verify_image</span><br><span class="line">         â”‚                    â”‚       â”‚</span><br><span class="line">         â””â”€â”€â–ºload_loader_2nd â”€â”˜       â”œâ”€â”€â–ºsecurity_is_tee_encrypted</span><br><span class="line">                                      â”‚         â”‚</span><br><span class="line">                                      â”‚         â””â”€â”€â”€â–ºcryptodma_aes_decrypt</span><br><span class="line">                                      â””â”€â”€â–ºverify_rsa</span><br></pre></td></tr></table></figure><h3 id="kernel-x2F-rootfs-çš„ç­¾å"><a href="#kernel-x2F-rootfs-çš„ç­¾å" class="headerlink" title="kernel &#x2F; rootfs çš„ç­¾å"></a>kernel &#x2F; rootfs çš„ç­¾å</h3><p>é™¤ <code>fip.bin</code> å¤–ï¼Œè¿˜æœ‰ <code>kernel</code> çš„äº§ç‰© <code>boot.xxx</code> å’Œæ–‡ä»¶ç³»ç»Ÿçš„äº§ç‰© <code>rootfs.xxx</code>ã€‚</p><h4 id="å‡†å¤‡ç§˜é’¥-1"><a href="#å‡†å¤‡ç§˜é’¥-1" class="headerlink" title="å‡†å¤‡ç§˜é’¥"></a>å‡†å¤‡ç§˜é’¥</h4><blockquote><p>1ï¸âƒ£è¿™é‡Œçš„ç§˜é’¥çš„åç§°ä¸ä¸Šé¢ä¸ä¸€æ ·ï¼Œå› ä¸ºæ˜¯ä¸åŒæ—¶æœŸé’ˆå¯¹ä¸åŒæ¿å­å†™çš„ï¼Œä¸è¿‡é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œåé¢å†è€ƒè™‘ç»Ÿä¸€åç§°ã€‚<br>2ï¸âƒ£è¿™é‡Œæ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”Ÿæˆ <code>AES</code> ç§˜é’¥ã€‚</p></blockquote><table><thead><tr><th>æ–‡ä»¶</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>NTKC_PRIV.pem</td><td>ç”¨äºç»™ <code>REE_OS_PK</code> ç­¾åçš„ç§é’¥ã€‚å…¬é’¥ï¼ˆçš„ <code>hash</code> å€¼ï¼‰è¢«çƒ§åˆ° <code>HASH0_PUBLIC</code></td></tr><tr><td>REEOS_PRIV.pem</td><td>ç”¨äºç»™ <code>boot, rootfs</code> ç­¾åçš„ç§é’¥</td></tr><tr><td>boot.crl</td><td>é»‘åå•ï¼Œ<code>REEOS_PK.pem</code> ä¸èƒ½æ˜¯ <code>boot.crl</code> ä¸­çš„å€¼</td></tr></tbody></table><p>å’Œä¸Šé¢ä¸€æ ·ï¼Œä½¿ç”¨ <code>openssl</code> ç”Ÿæˆ <code>2048</code> ä½çš„ç§˜é’¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">host$ openssl genrsa -out NTKC_PRIV.pem -F4 2048</span><br><span class="line">host$ openssl genrsa -out REEOS_PRIV.pem -F4 2048</span><br></pre></td></tr></table></figure><h4 id="ç­¾åæµç¨‹"><a href="#ç­¾åæµç¨‹" class="headerlink" title="ç­¾åæµç¨‹"></a>ç­¾åæµç¨‹</h4><p>ä¸å‰é¢ç›´æ¥å°†ç­¾åä¿¡æ¯ç›´æ¥å†™å…¥åˆ° <code>fip.bin</code> ä¸åŒï¼Œå¯¹ <code>kernel</code> å’Œ <code>rootfs</code> çš„ç­¾åä¸“é—¨ç”Ÿæˆäº†ä¸€ä¸ª <code>sig.bin</code> æ–‡ä»¶æ¥å­˜å‚¨ã€‚å…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå…¬é’¥ã€ç­¾åã€æ–‡ä»¶å¤§å°ä¿¡æ¯ã€‚</p><blockquote><p>1ï¸âƒ£åœ¨è¿™é‡Œçš„è®¾è®¡ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿ <code>rootfs</code> æœ‰ä¸¤ä»½ï¼Œä¸€ä»½å°±æ˜¯æ­£å¸¸å¤§å°çš„ <code>upgrade</code>ï¼Œå¦ä¸€ä»½ä¸ºåˆ å‡äº†ä¸€äº›éå¿…è¦æ–‡ä»¶çš„ <code>minerfs</code>ã€‚ä¸è¿‡åœ¨åç»­çš„æµç¨‹ä¸­ï¼Œæˆ‘å¹¶æ²¡æœ‰å¯¹ <code>rootfs</code> è¿›è¡Œè£å‰ªï¼Œä¹Ÿå°±æ˜¯è¯´ <code>upgrade == minerfs == rootfs.spinor</code> ï¼Œå…ˆèµ°é€šæµç¨‹ï¼Œåç»­å†è€ƒè™‘æ˜¯å¦ç²¾ç®€ã€‚<br>2ï¸âƒ£åªè¿›è¡Œäº†ç­¾åæ“ä½œï¼Œæ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼<br>3ï¸âƒ£æ–‡ä»¶å¤§å°ä¿¡æ¯æ˜¯æ¿ç«¯é‡æ–°å¯¹ <code>kernel/rootfs</code> è®¡ç®—ç­¾åçš„æ—¶å€™ç”¨åˆ°çš„ã€‚</p></blockquote><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-boot-rootfs.drawio.png" alt="å®‰å…¨å¯åŠ¨-sign-boot-rootfs.drawio"></p><ol><li>ç”± <code>NTKC_PRIV.pem</code> ç§é’¥å¾—åˆ°å…¬é’¥ã€‚ <code>NTKC_PRIV.pem</code> çš„å…¬é’¥éœ€è¦è®°å½•åœ¨ <code>efuse</code> é‡Œé¢ï¼Œè€Œ <code>efuse</code> ç©ºé—´æœ‰é™ï¼Œç­¾å <code>rsa_hash0.pem</code> å·²ç»ç”¨äº†ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå¿…é¡»ç›¸ç­‰ <code>NTKC_PRIV.pem == rsa_hash0.pem</code> ã€‚</li><li>ç”± <code>REEOS_PRIV.pem</code> ç§é’¥å¾—åˆ°å…¬é’¥ã€‚è¯¥ç§é’¥æ„Ÿè§‰ä¹Ÿå¯ä»¥ä¸å‰é¢çš„ <code>bl_priv.pem</code> ç›¸åŒã€‚</li><li>ç”¨ <code>NTKC_PRIV.pem</code> è®¡ç®— <code>REEOS_PK.pem</code> çš„æ•°å­—ç­¾å</li><li>ç”¨ <code>NTKC_PRIV.pem</code> è®¡ç®—æ•°å­—ç­¾åã€‚<code>boot.crl</code> æ˜¯ä½œä¸ºé»‘åå•ä½¿ç”¨çš„ï¼Œå³ <code>REEOS_PK.pem</code> ä¸èƒ½æ˜¯ <code>boot.crl</code> ä¸­çš„å€¼ï¼ˆè¿™é‡Œé¢çš„å€¼æ˜¯å·²ç»æ³„æ¼çš„ç§˜é’¥ï¼‰ã€‚</li><li>ç”¨ <code>REEOS_PRIV.pem</code> è®¡ç®—æ•°å­—ç­¾åã€‚</li><li>ç”¨ <code>REEOS_PRIV.pem</code> è®¡ç®—æ•°å­—ç­¾åã€‚è¿™é‡Œä¸åŒºåˆ† <code>minerfs/upgrade</code> ï¼Œéƒ½è®°å½•ä¸º <code>rootfs</code> çš„ç­¾åã€‚</li></ol><p>å¯¹ <code>kernel</code> å’Œ <code>rootfs</code> çš„ç­¾åçš„å®ç°æ˜¯åœ¨ <code>make_sig_img.sh</code> è¿™ä¸ªè„šæœ¬ä¸­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e -o pipefail</span><br><span class="line"></span><br><span class="line">SIG_TMP_PATH=<span class="string">&quot;<span class="variable">$&#123;BUILD_PATH&#125;</span>/tools/common/sign_tools/sig_files&quot;</span></span><br><span class="line">NTKC_PRIV_PATH=<span class="string">&quot;<span class="variable">$&#123;BUILD_PATH&#125;</span>/tools/common/sign_tools/NTKC_PRIV.pem&quot;</span></span><br><span class="line">REEOS_PRIV_PATH=<span class="string">&quot;<span class="variable">$&#123;BUILD_PATH&#125;</span>/tools/common/sign_tools/REEOS_PRIV.pem&quot;</span></span><br><span class="line">BOOT_CRL_PATH=<span class="string">&quot;<span class="variable">$&#123;BUILD_PATH&#125;</span>/tools/common/sign_tools/boot.crl&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># sig.bin ä¸­ä¸åŒéƒ¨åˆ†çš„åˆ†å‰²ç¬¦</span></span><br><span class="line">SIG_IMG_SEP=$(<span class="built_in">printf</span> <span class="string">&#x27;\xe8\x6c\xdc\x26\x7b\xcb\xf6\x4b\x8d\xd8\xa2\x2c\x86\xa6\x58\x73\xf9\x42\xbc\x3a\x70\x58\x02\x43\xbe\x79\x56\x66\x23\x2a\x0a\x7e&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">int_to_bytes</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">    python3 -c <span class="string">&#x27;import sys; sys.stdout.buffer.write(int(sys.argv[1]).to_bytes(4, &quot;little&quot;))&#x27;</span> <span class="variable">$1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># create sig.bin</span></span><br><span class="line"><span class="keyword">function</span> make_sig_img()</span><br><span class="line">(</span><br><span class="line">    <span class="comment"># è¿™é‡Œé¡ºåºè¦å’Œ u-boot ä¸­ cvi_verify.c ä¸­å¯¹åº”</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span>()&quot;</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/NTKC_PK.pem</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/REEOS_PK.pem</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="string">&quot;<span class="variable">$&#123;BOOT_CRL_PATH&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/REEOS_PK.pem.sig</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/boot.crl.sig</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/boot.<span class="variable">$STORAGE_TYPE</span>.sig</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/minerfs.sig</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        <span class="built_in">cat</span> <span class="variable">$SIG_TMP_PATH</span>/upgrade.sig</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">        int_to_bytes <span class="string">&quot;<span class="subst">$(stat -c &#x27;%s&#x27; $OUTPUT_DIR/rawimages/boot.$STORAGE_TYPE)</span>&quot;</span></span><br><span class="line">        int_to_bytes <span class="string">&quot;<span class="subst">$(stat -c &#x27;%s&#x27; $OUTPUT_DIR/rawimages/rootfs.$STORAGE_TYPE)</span>&quot;</span></span><br><span class="line">        int_to_bytes <span class="string">&quot;<span class="subst">$(stat -c &#x27;%s&#x27; $OUTPUT_DIR/rawimages/rootfs.$STORAGE_TYPE)</span>&quot;</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">&#x27;%s&#x27;</span> <span class="string">&quot;<span class="variable">$SIG_IMG_SEP</span>&quot;</span></span><br><span class="line">    &#125; &gt; <span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>/rawimages/sig.bin&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># åœ¨æ–‡ä»¶ sig.bin å‰é¢åŠ ä¸Šä¸€æ®µå‰ç¼€å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ˜¯ cvitek çš„é•œåƒ</span></span><br><span class="line">    python3 <span class="string">&quot;<span class="variable">$BUILD_PATH</span>/tools/common/image_tool/raw2cimg.py&quot;</span> <span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>/rawimages/sig.bin&quot;</span> <span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>&quot;</span> <span class="string">&quot;<span class="variable">$FLASH_PARTITION_XML</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Save to <span class="variable">$OUTPUT_DIR</span>/sig.bin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹é•œåƒç”¨ç§é’¥è¿›è¡ŒåŠ å¯†ã€ç­¾å</span></span><br><span class="line"><span class="keyword">function</span> sign_image()</span><br><span class="line">(</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;FUNCNAME[0]&#125;</span>()&quot;</span></span><br><span class="line">    <span class="comment"># ç”±ç§é’¥å¾—åˆ°å…¬é’¥</span></span><br><span class="line">    openssl rsa -<span class="keyword">in</span> <span class="variable">$&#123;NTKC_PRIV_PATH&#125;</span> -pubout -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/NTKC_PK.pem&quot;</span></span><br><span class="line">    openssl rsa -<span class="keyword">in</span> <span class="variable">$&#123;NTKC_PRIV_PATH&#125;</span> -pubout -outform DER | <span class="built_in">sha256sum</span> &gt; <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/NTKC_PK.der.sha256&quot;</span></span><br><span class="line">    openssl rsa -<span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;REEOS_PRIV_PATH&#125;</span>&quot;</span> -pubout -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/REEOS_PK.pem&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># ç”Ÿæˆæ•°å­—ç­¾å</span></span><br><span class="line">    openssl dgst -sha256 -sign <span class="variable">$&#123;NTKC_PRIV_PATH&#125;</span> -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/REEOS_PK.pem.sig&quot;</span> <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/REEOS_PK.pem&quot;</span></span><br><span class="line">    openssl dgst -sha256 -sign <span class="variable">$&#123;NTKC_PRIV_PATH&#125;</span> -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/boot.crl.sig&quot;</span> <span class="variable">$&#123;BOOT_CRL_PATH&#125;</span></span><br><span class="line"></span><br><span class="line">    openssl dgst -sha256 -sign <span class="string">&quot;<span class="variable">$&#123;REEOS_PRIV_PATH&#125;</span>&quot;</span> -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/boot.<span class="variable">$STORAGE_TYPE</span>.sig&quot;</span> <span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>/rawimages/boot.<span class="variable">$STORAGE_TYPE</span>&quot;</span></span><br><span class="line">    <span class="comment"># è¿™é‡Œæ²¡æœ‰åŒºåˆ† upgrade/minerfsï¼Œæš‚æ—¶ä¸ç¡®å®šæ˜¯å¦éœ€è¦åŒºåˆ†ï¼Œæ‰€ä»¥ä¿ç•™ä¸¤ä¸ª</span></span><br><span class="line">    openssl dgst -sha256 -sign <span class="string">&quot;<span class="variable">$&#123;REEOS_PRIV_PATH&#125;</span>&quot;</span> -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/minerfs.sig&quot;</span> <span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>/rawimages/rootfs.<span class="variable">$STORAGE_TYPE</span>&quot;</span></span><br><span class="line">    openssl dgst -sha256 -sign <span class="string">&quot;<span class="variable">$&#123;REEOS_PRIV_PATH&#125;</span>&quot;</span> -out <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>/upgrade.sig&quot;</span> <span class="string">&quot;<span class="variable">$OUTPUT_DIR</span>/rawimages/rootfs.<span class="variable">$STORAGE_TYPE</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;sign_image done!&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>&quot;</span></span><br><span class="line">(</span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$SIG_TMP_PATH</span>&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Clear <span class="variable">$SIG_TMP_PATH</span>&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> -f ./*</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;start sign&quot;</span></span><br><span class="line">sign_image</span><br><span class="line">make_sig_img</span><br></pre></td></tr></table></figure><h4 id="æ ¡éªŒæµç¨‹"><a href="#æ ¡éªŒæµç¨‹" class="headerlink" title="æ ¡éªŒæµç¨‹"></a>æ ¡éªŒæµç¨‹</h4><ol><li>è®¡ç®— <code>sig.bin</code> ä¸­ <code>NTKC_PK.pem</code> çš„æ•£åˆ—å€¼ï¼Œä¸ <code>efuse</code> ä¸­å­˜å‚¨çš„æ•£åˆ—å€¼å¯¹æ¯”ï¼Œå¦‚æœç›¸åŒåˆ™è¯´æ˜ <code>NTKC_PK.pem</code> å¯ä¿¡ã€‚</li><li>åˆ©ç”¨ <code>NTKC_PK.pem</code> è®¡ç®— <code>REEOS_PK.pem</code> çš„æ•°å­—ç­¾åï¼Œå’Œ <code>REEOS_PK.pem.sig</code> å¯¹æ¯”ï¼Œç›¸åŒåˆ™è¯´æ˜ <code>REEOS_PK.pem</code> å¯ä¿¡ã€‚</li><li>åˆ©ç”¨ <code>REEOS_PK.pem</code> ä¸º <code>boot / rootfs</code> è®¡ç®—æ•°å­—ç­¾åï¼Œå¹¶ä¸å¯¹åº”çš„ <code>.sig</code> å¯¹æ¯”ï¼Œç›¸åŒåˆ™è¯´æ˜å¯¹åº”çš„æ–‡ä»¶æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¯ä¿¡ã€‚</li><li>æ ¡éªŒå®Œæ¯•ï¼Œå¯ä»¥æ­£å¸¸å¯åŠ¨ <code>kernel</code> äº†ã€‚</li></ol><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><h3 id="1ï¸âƒ£ä½¿ç”¨æ³¨æ„"><a href="#1ï¸âƒ£ä½¿ç”¨æ³¨æ„" class="headerlink" title="1ï¸âƒ£ä½¿ç”¨æ³¨æ„"></a>1ï¸âƒ£ä½¿ç”¨æ³¨æ„</h3><ol><li><strong>é…ç½®å‚æ•°</strong>ï¼Œ<code>fip.bin</code> çš„åŠ å¯†é€šè¿‡è®¾ç½®é…ç½®é€‰é¡¹ <code>CONFIG_FSBL_SECURE_BOOT_SUPPORT=y</code> å¯ç”¨ï¼Œè€Œ <code>kernel</code> å’Œ <code>rootfs</code> åˆ™æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡ <code>UBOOT_VBOOT=1</code> æ¥å¯ç”¨ã€‚åˆ†å¼€é…ç½®æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡éœ€è¦æœªåŠ å¯†çš„ <code>fip.bin</code> æ¥å®ç°çƒ§å†™ <code>efuse</code>ï¼Œåœ¨ <code>efuse</code> è¿˜æœªçƒ§å†™çš„æƒ…å†µä¸‹ï¼ŒåŠ å¯†äº†çš„ <code>fip.bin</code> æ— æ³•åŠ è½½ã€‚</li><li><strong>ä¿®æ”¹</strong> <code>partition.xml</code>ï¼Œå…¶å®å°±æ˜¯å¢åŠ ä¸€é¡¹ <code>sig.bin</code>ï¼Œéœ€è¦æ³¨æ„å…¶å¤§å°å¯¹é½ï¼Œå…·ä½“å¤§å°è¦çœ‹å¯¹åº” <code>flash</code> æ•°æ®æ‰‹å†Œï¼Œä¸è¿‡ä¸€èˆ¬ä¸º <code>64k/128k</code>ã€‚</li><li><strong>ä¿®æ”¹</strong> <code>cv18xx-asic.h</code>ï¼Œåœ¨ <code>uboot</code>å¯åŠ¨ <code>kernel</code> ä¹‹å‰ï¼Œéœ€è¦å…ˆå¯¹ <code>kernel</code> å’Œ <code>rootfs</code> è¿›è¡Œç­¾åæ ¡éªŒï¼Œè€Œè¿™ä¸€è¿‡ç¨‹éœ€è¦å…ˆå°†å¯¹åº”çš„å†…å®¹ä» <code>flash</code> è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç›®å‰åªæµ‹è¯•äº† <code>spinor/spinand</code>ï¼Œ<code>emmc</code> è¿˜æœªæµ‹è¯•ã€‚<strong>å¦å¤–æ³¨æ„</strong>ï¼šè¯»å–æ—¶å„ä¸ªåˆ†åŒºå æ®çš„å†…å­˜ä¸è¦é‡å ï¼Œåˆ†åŒºçš„å¤§å°æœ€å¥½ä¸ <code>partition.xml</code> ä¸­ä¸€è‡´ã€‚</li></ol><h3 id="2ï¸âƒ£raw2cimg-py"><a href="#2ï¸âƒ£raw2cimg-py" class="headerlink" title="2ï¸âƒ£raw2cimg.py"></a>2ï¸âƒ£raw2cimg.py</h3><p>åœ¨æˆ‘ä»¬çš„ç¼–è¯‘æµç¨‹ä¸­ï¼Œç¼–è¯‘å¾—åˆ°çš„åŸå§‹æ–‡ä»¶æ¯”å¦‚ <code>boot.spinand</code>ï¼Œ <code>rootfs.spinor</code> ç­‰æ˜¯æ”¾åœ¨ <code>$OUTPUT_DIR/rawimages</code> ç›®å½•ä¸‹çš„ï¼Œä¸è¿‡ç¼–è¯‘æµç¨‹ä¸­è¿˜ä¼šè°ƒç”¨ <code>raw2cimg.py</code> å¯¹è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åŠ ä¸Šä¸€æ®µå‰ç¼€<code>Header</code>ï¼Œ<code>upgrade.zip</code> ä¸­æ‰“åŒ…çš„ä¹Ÿæ˜¯è¿™äº›æ·»åŠ â€<code>header</code>â€œåçš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ hexdump sig.bin</span><br><span class="line">0000000 4943 474d 0001 0000 0040 0000 0001 0000</span><br><span class="line">0000010 0bb5 0000 6973 0067 0000 0000 0000 0000</span><br><span class="line">0000020 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0000040 0001 0000 0b75 0000 0000 00b2 0000 0002</span><br><span class="line">0000050 dd1b 0ee4 0000 0000 0000 0000 0000 0000</span><br><span class="line">0000060 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0000080 2d2d 2d2d 422d 4745 4e49 5020 4255 494c <span class="comment"># è¿™ä¸€è¡Œå¼€å§‹æ˜¯æ­£å¼å†…å®¹</span></span><br><span class="line">0000090 2043 454b 2d59 2d2d 2d2d 4d0a 4949 4942</span><br></pre></td></tr></table></figure><p><del>é—®é¢˜åœ¨äºğŸ’¢ï¼šå‰é¢ <code>sig.bin</code> ä¸­ä½¿ç”¨çš„æ˜¯ <code>rawimages</code> ä¸‹çš„æ–‡ä»¶ç”Ÿæˆçš„ç­¾åï¼Œè€Œçƒ§å†™åˆ° <code>flash</code> çš„æ˜¯å¢åŠ äº†ä¸€æ®µå‰ç¼€åçš„æ–‡ä»¶ï¼Œä¸¤ä¸ªæ–‡ä»¶æœ‰å·®å¼‚ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œ <code>kernel</code> å’Œ <code>rootfs</code> ç­¾åæ ¡éªŒçš„æ—¶å€™ï¼Œåº”è¯¥æ— æ³•é€šè¿‡æ‰å¯¹â—ğŸ’¢ğŸ’¢ä½†å®ƒç¡®å®èƒ½é€šè¿‡æ ¡éªŒï¼Œå¹¶ä¸”ä½¿ç”¨ <code>rawimages</code> ä¸‹çš„æ–‡ä»¶åè€Œæ— æ³•é€šè¿‡ğŸ¤¦â€â™‚ï¸ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å“ªé‡Œæœ‰å¯¹å‰ç¼€è¿›è¡Œè£å‰ªä¹‹ç±»çš„ä»£ç ğŸ¤¦â€â™‚ï¸ğŸ¤¦â€â™‚ï¸ğŸ¤¦â€â™‚ï¸</del>ã€‚</p><p><strong>æ˜¯åœ¨çƒ§å½•çš„è¿‡ç¨‹ä¸­å°±è¿›è¡Œäº†è£å‰ª</strong>ã€‚åœ¨ <code>cvi_update</code> è¿‡ç¨‹ä¸­ï¼Œä¼šæ£€æŸ¥å„ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ <code>Header</code>ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–è€…ä¸ä¸€è‡´ï¼Œä¼šæ— æ³•çƒ§å½•åˆ° <code>flash</code>ã€‚æ­¤å¤–ï¼Œåœ¨å®é™…çƒ§å½•æ—¶ä¹Ÿä¼šè£å‰ªæ‰ <code>header</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">do_cvi_update</span><br><span class="line">    â”‚</span><br><span class="line">    â””â–º_storage_update</span><br><span class="line">         â”‚</span><br><span class="line">         â””â”€â–º_checkHeader</span><br><span class="line">              â”‚</span><br><span class="line">              â”œâ”€â”€â–ºuint32_t pos = HEADER_SIZE;</span><br><span class="line">              â””â”€â”€â–ºsnprintf(cmd, 255, &quot;fatload %s %p %s 0x%x 0x%x;&quot;, strStorage,</span><br><span class="line">                   (void *)UPDATE_ADDR, file, load_size, pos);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æœªæ·»åŠ  <code>Header</code> çš„ <code>sig.bin</code>ï¼Œ<code>boot.spinor</code>ï¼Œ<code>rootfs.spinor</code> çƒ§å½•çš„æ—¶å€™ï¼Œä¼šæç¤ºä¸‹é¢çš„é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">File:sig.bin Magic number is wrong, skip it</span><br><span class="line">File:rootfs.spinor Magic number is wrong, skip it</span><br></pre></td></tr></table></figure><h3 id="3ï¸âƒ£çƒ§å½•-efuse"><a href="#3ï¸âƒ£çƒ§å½•-efuse" class="headerlink" title="3ï¸âƒ£çƒ§å½• efuse"></a>3ï¸âƒ£çƒ§å½• efuse</h3><p>ç›®å‰æ˜¯å°†çƒ§å½• <code>efuse</code> çš„æµç¨‹æ˜¯ç»‘å®šåœ¨å¯¹ <code>kernel</code> ç­¾åçš„ã€‚åªè¦å¯ç”¨äº† <code>UBOOT_VBOOT=1</code>ï¼Œå¯åŠ¨è¿‡ç¨‹ä¸­å°±ä¼šæ£€æŸ¥æ˜¯å¦è®¾ç½®äº†å®‰å…¨å¯åŠ¨ï¼ˆé€šè¿‡è¯»å– <code>efuse</code> çš„æ•°æ®åˆ¤æ–­ï¼‰ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å°±ä¼šçƒ§å†™ <code>efuse</code>ï¼ŒåŒ…æ‹¬ <code>HASH0_PUBLIC</code> å’Œ <code>loader_ek</code>ã€‚</p><p>å¦‚æœæ¯æ¬¡ç¼–è¯‘çš„ <code>boot.xxx</code> éƒ½å¸¦æœ‰è¿™äº›ä¿¡æ¯ï¼Œå®¹æ˜“å¯¼è‡´ç§˜é’¥æ³„æ¼ã€‚å‰è€…æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºçƒ§å†™åˆ° <code>efuse</code> çš„æ˜¯å…¬é’¥ï¼Œå³ä½¿çŸ¥é“å…¬é’¥ä¹Ÿæ¨ä¸å‡ºç§é’¥ã€‚ä¸è¿‡åè€…æ˜¯ <code>AES</code> æ˜æ–‡çš„ç§˜é’¥ï¼Œå­˜åœ¨éšæ‚£ã€‚<del>æ‰€ä»¥ï¼Œåœ¨éå¿…è¦çš„æ—¶å€™åº”è¯¥æ³¨é‡Šæ‰ç›¸å…³å†…å®¹</del>ã€‚å·²å¢åŠ é…ç½®ç¯å¢ƒå˜é‡ <code>UBOOT_WRITE_EFUSE=1</code> æ¥æ§åˆ¶ã€‚</p><h3 id="â­æ›´æ–°"><a href="#â­æ›´æ–°" class="headerlink" title="â­æ›´æ–°"></a>â­æ›´æ–°</h3><p>ç”±äºå®¢æˆ·è¦æ±‚ï¼Œåªç­¾åï¼Œä¸å¯¹ <code>fip.bin</code> è¿›è¡ŒåŠ å¯†ï¼Œå¸Œæœ›èƒ½ä»¥å®è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤éœ€è¦å¯¹éƒ¨åˆ†ä»£ç è¿›è¡Œæ›´æ–°ã€‚</p><ol><li>ä½¿ç”¨ç¯å¢ƒå˜é‡ <code>ONLY_SIGN_FIP=1</code> æ¥è¡¨ç¤ºä»…å¯¹ <code>fip.bin</code> è¿›è¡Œç­¾åï¼Œæœªè®¾ç½®æˆ–è®¾ç½®ä¸º0è¡¨ç¤ºç­¾å+åŠ å¯†ã€‚</li><li>ä»£ç ä¸»è¦æ›´æ–°ï¼š<ol><li>ç¼–è¯‘æµç¨‹ä¸­ <code>fip_v2.mk</code> è°ƒç”¨ <code>fipsign.py</code> ä¹‹å‰æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚</li><li>ç¼–è¯‘æµç¨‹ä¸­ <code>build/Makefile</code> å°† <code>loader_ek</code> å¤åˆ¶åˆ° <code>uboot</code> ç›®å½•ä¸‹çš„è¿‡ç¨‹ï¼Œéœ€è¦å…ˆæ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚</li><li><code>efuse.c</code> ä¸­çƒ§å†™ <code>efuse</code> æ—¶ï¼Œæ£€æŸ¥ç¯å¢ƒå˜é‡ï¼Œä¸çƒ§å†™ <code>loader_ek</code>ã€‚</li><li>åœ¨ <code>uboot/*/cvitek.mk</code> ä¸­è¿˜è¦å¢åŠ  <code>-DONLY_SIGN_FIP</code>ï¼Œè¿™æ ·æ‰èƒ½å½±å“åˆ° <code>efuse.c</code> ä¸­çš„ä»£ç ã€‚</li></ol></li></ol><h3 id="4ï¸âƒ£ä½¿ç”¨æ–¹æ³•"><a href="#4ï¸âƒ£ä½¿ç”¨æ–¹æ³•" class="headerlink" title="4ï¸âƒ£ä½¿ç”¨æ–¹æ³•"></a>4ï¸âƒ£ä½¿ç”¨æ–¹æ³•</h3><ol><li><p>å‡†å¤‡ä»¥ä¸‹å‡ ä¸ªç§˜é’¥æ–‡ä»¶ï¼Œå¦‚ä½•ç”Ÿæˆç§˜é’¥å¯ä»¥çœ‹å‰é¢çš„ä»‹ç»ã€‚</p><table><thead><tr><th>fip.bin</th><th>kernel&#x2F;rootfs</th><th></th></tr></thead><tbody><tr><td>rsa_hash0.pem</td><td>NTKC_PRIV.pem</td><td>ç”¨äºç»™ <code>bl_priv.pem</code> ç­¾åçš„ <code>RSA</code> ç§é’¥ï¼Œå…¬é’¥ï¼ˆçš„ <code>hash</code> å€¼ï¼‰è¢«çƒ§åˆ° <code>HASH0_PUBLIC</code></td></tr><tr><td>bl_priv.pem</td><td></td><td>ç”¨äºç»™ <code>fsbl/opensbi/u-boot</code> ç”Ÿæˆç­¾åçš„ <code>RSA</code> ç§é’¥</td></tr><tr><td>loader_ek.key</td><td></td><td>ç”¨äºç»™ <code>bl_ek.key</code> åŠ ã€è§£å¯†çš„ <code>AES</code> ç§˜é’¥ï¼Œä¹Ÿä¼šè¢«çƒ§å†™åˆ° <code>eFuse</code></td></tr><tr><td>bl_ek.key</td><td></td><td>ç”¨äºç»™ <code>fsbl/opensbi/u-boot</code> åŠ ã€è§£å¯†çš„ <code>AES</code> ç§˜é’¥</td></tr><tr><td></td><td>REEOS_PRIV.pem</td><td>ç”¨äºç»™ <code>boot, rootfs</code> ç­¾åçš„ç§é’¥</td></tr><tr><td></td><td>boot.crl</td><td>é»‘åå•ï¼Œ<code>REEOS_PK.pem</code> ä¸èƒ½æ˜¯ <code>boot.crl</code> ä¸­çš„å€¼ï¼Œ<strong>ä¸èƒ½ä¸ºç©ºæ–‡ä»¶</strong></td></tr></tbody></table></li><li><p>åœ¨ä¸€ä¸ªç©ºç™½çš„æ¿å­ä¸Šï¼Œæ­¤æ—¶æ¿å­çš„ <code>efuse</code> è¿˜æ²¡æœ‰å†™è¿‡ï¼Œé¦–å…ˆéœ€è¦çƒ§å†™ <code>efuse</code>ï¼Œæ­¤æ—¶ä¸èƒ½åŠ å¯† <code>fip.bin</code>ã€‚</p><p> <code>export UBOOT_VBOOT=1 UBOOT_WRITE_EFUSE=1; source build/xxx</code></p></li><li><p><strong>å®Œæˆçƒ§å½•åï¼Œæ‹”å¡ï¼Œé‡æ–°ä¸Šç”µ</strong>ï¼Œæ‰ä¼šè¿›è¡Œ <code>efuse</code> çš„çƒ§å†™ã€‚</p></li><li><p>çƒ§å†™å®Œæ¯•ï¼Œåç»­ç¼–è¯‘çš„é•œåƒå°±å¿…é¡»å¯¹ <code>fip.bin</code> è¿›è¡ŒåŠ å¯†äº†ï¼Œå¦åˆ™æ— æ³•çƒ§å½•ã€‚<br> å®Œæˆçƒ§å½•åï¼Œä¹Ÿä¸è¦å†ä½¿ç”¨ <code>UBOOT_WRITE_EFUSE=1</code>ï¼Œå¦åˆ™ <code>boot.xxx</code> ä¸­ä¼šå¸¦æœ‰ <code>loader_ek.key</code> çš„æ˜æ–‡ï¼Œå®¹æ˜“å¯¼è‡´ç§˜é’¥æ³„æ¼ã€‚</p><p> <code>export UBOOT_VBOOT=1; source build/xxx</code>ï¼Œå†é€šè¿‡ <code>menuconfig</code> å¯ç”¨ <code>CONFIG_FSBL_SECURE_BOOT_SUPPORT</code>(è¿™ä¸ªå¯ä»¥å†™åœ¨å¯¹åº”æ¿å¡ç›®å½•ä¸‹çš„ xxx_defconfig æ–‡ä»¶ä¸­ )</p></li></ol><h2 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h2><ol><li><p>ç§˜é’¥éƒ½æ˜¯å†™åœ¨ efuse ä¸­çš„ï¼Œé‚£åˆ«äººå²‚ä¸æ˜¯å¯ä»¥ç›´æ¥è¯» efuse è·å–åˆ°ç§˜é’¥ï¼Ÿè¿™æ ·ä¸å¾ˆå®¹æ˜“ç ´è§£å—ï¼Ÿ</p><blockquote><p>efuse ä¸­å­˜äº†ä¸¤ä¸ªç§˜é’¥ï¼š</p><ol><li>HASH0_PUBLIC åŒºå­˜æ”¾çš„ RSA ç®—æ³•çš„å…¬é’¥çš„ sha256 å“ˆå¸Œå€¼ã€‚</li><li>LOADER_EK åŒºå­˜æ”¾çš„ AES çš„ç§˜é’¥ã€‚</li></ol><p>æ­£å¸¸æƒ…å†µä¸‹æ˜¯å¯è¯»å†™çš„ï¼Œä¸è¿‡çƒ§å†™ä¸‹é¢ä¸¤ä¸ªå­—æ®µï¼Œå°±å¯ä»¥ç¦ç”¨å¯¹åº”åŒºåŸŸçš„è¯»å†™ã€‚<a href="https://doc.sophgo.com/cvitek-develop-docs/master/docs_latest_release/CV180x_CV181x/zh/01.software/BSP/eFuse_User_Guide/build/html/2_eFuse_User_Guide/eFuse_Overview.html">see doc</a></p><table><thead><tr><th>LOCK_LOADER_EK</th><th>é”å®šå®‰å…¨å¯åŠ¨AESåŠ å¯†å¯†é’¥åŒºåŸŸï¼Œè®©æ­¤åŒºåŸŸæ— æ³•è¯»å†™</th></tr></thead><tbody><tr><td>LOCK_DEVICE_EK</td><td>é”å®šDEVICE_EKï¼Œè®©æ­¤åŒºåŸŸæ— æ³•è¯»å†™</td></tr></tbody></table><p><strong>é‚£å¦‚æœä¸èƒ½è¯»å†™ï¼Ÿå¯åŠ¨è¿‡ç¨‹åˆæ˜¯æ€ä¹ˆéªŒç­¾å’Œè§£å¯†çš„å‘¢ï¼Ÿ</strong></p><p>è¿™ä¸¤ä¸ªç§˜é’¥çš„å†…å®¹æ˜¯åœ¨ rom code ä¸­è¯»å–çš„ï¼Œrom code æœ‰ç‰¹æƒå§ã€‚efuse åŒºåˆ†å®‰å…¨ä»‹é¢å’Œéå®‰å…¨ä»‹é¢ï¼Œé”è¯»å†™åªæ˜¯éå®‰å…¨ç•Œé¢çš„è¯»å†™ï¼Œå®‰å…¨ç•Œé¢è‡³å°‘èƒ½è¯»ã€‚</p></blockquote></li><li><p><del>fip çš„ç­¾åæ ¡éªŒéƒ½æ˜¯åœ¨ fsbl ä¸­å®Œæˆ</del>ï¼Œå¦‚æœèƒ½è·å¾— fsbl çš„æºç ï¼Œä¿®æ”¹åèƒ½è·³è¿‡ç­¾åæ ¡éªŒè¿‡ç¨‹å—ï¼Ÿ</p><blockquote><p>çœ‹ [fip æ ¡éªŒæµç¨‹](#fip æ ¡éªŒæµç¨‹) ï¼Œåœ¨ rom code ä¸­ä¼šé¦–å…ˆå¯¹ fip è¿›è¡Œæ ¡éªŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä½ èƒ½ä¿®æ”¹ fsbl çš„æµç¨‹ï¼Œä½†æ²¡æœ‰ RSA ç§˜é’¥ï¼Œæ— æ³•å¯¹ fip è¿›è¡Œç­¾åï¼Œé‚£ä¹ˆåœ¨ rom code é˜¶æ®µå°±è¢«å¡ä½äº†ã€‚</p><p>å¦‚æœç§˜é’¥éƒ½æ³„æ¼äº†ï¼Œé‚£æ”¹ä¸æ”¹ fsbl çš„æµç¨‹éƒ½ä¸€æ ·äº†ã€‚</p></blockquote></li><li><p>å…¬é’¥ä¸å°å¿ƒæ³„æ¼äº†ï¼Œèƒ½è¢«äººåˆ©ç”¨å—ï¼Ÿå‰é¢ä»‹ç»çš„å…¬é’¥æ˜¯ç›´æ¥å­˜æ”¾åœ¨ fip.bin ä¸­çš„ï¼Œfip.bin æœ¬èº«åˆä¸å¤§ï¼ŒçŸ¥é“å…¬é’¥çš„ä½æ•°ï¼Œæ€»èƒ½ç©·ä¸¾å‡ºæ¥å§ã€‚</p><blockquote><p>é™¤äº†ç©·ä¸¾ï¼Œè¿˜å¯ä»¥éšä¾¿åˆ›å»ºä¸€ä¸ªå…¬é’¥ç§é’¥ï¼Œç”¨ç§é’¥ç­¾å <code>fip.bin</code> ç„¶åæŸ¥çœ‹å…¬é’¥å¯¹åº” <code>fip.bin</code> ä¸­çš„åç§»é‡ã€‚ä¸å°±å¯ä»¥çŸ¥é“ä»»æ„ä¸€ä¸ª <code>fip.bin</code> ä¸­çš„å…¬é’¥äº†å—ï¼Ÿ</p><p>å‡è®¾å·²ç»çŸ¥é“äº†å…¬é’¥ï¼Œrom code é‡Œé¢å¦‚æœä»…ä»…å¯¹å…¬é’¥æœ¬èº«è¿›è¡Œäº†æ ¡éªŒï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´æˆ‘å¯ä»¥ä½¿ç”¨è‡ªå·±ç¼–è¯‘çš„ä¸€ä¸ª fip.binï¼Œæ›¿æ¢é‡Œé¢çš„å…¬é’¥ï¼Œå°±å¯ä»¥è¿›å…¥ fsbl é˜¶æ®µäº†ã€‚é‚£æˆ‘å²‚ä¸æ˜¯å¯ä»¥ä¿®æ”¹ fsblï¼Œè·³è¿‡ç­¾åã€è§£å¯†çš„è¿‡ç¨‹ï¼Ÿè¿™ä¸å°±ç ´è§£äº†ï¼Ÿï¼Ÿï¼Ÿubootå°±å¯ä»¥çƒ§å½•ä»»ä½•å›ºä»¶äº†â€¦. ï¼Ÿï¼Ÿï¼Ÿ</p><p>ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡</p><p>å…¬é’¥ç¡®å®å®¹æ˜“è·å–ï¼ŒæŸ¥çœ‹ <code>fiptool.py</code> å¯ä»¥çœ‹åˆ° <code>ROOT_PK</code> åœ¨ <code>fip.bin</code> ä¸­çš„åç§»é‡ä¸º <code>0X400</code>ã€‚ä¸è¿‡è¿™å¹¶æ²¡æœ‰å®‰å…¨é£é™©ã€‚å› ä¸ºç›®å‰æ˜¯ä¸€çº§ä¸€çº§æ ¡éªŒçš„ã€‚</p><ul><li><code>rom code</code> ä¸­ä¼šæ ¡éªŒ <code>BL2(FSBL)</code> çš„ç­¾åï¼Œä¿è¯äº† <code>FSBL</code> æ— æ³•è¢«ç¯¡æ”¹ã€‚æˆ–è€…è¯´ç¯¡æ”¹åçš„ <code>FSBL</code> æ— æ³•é€šè¿‡ <code>ROM</code> çš„æ ¡éªŒã€‚<em>å¯¹åº”ä¸‹å›¾ä¸­çš„ 2,4,5,6 æ­¥</em>ã€‚</li><li><code>FSBL</code> ä¸­æ ¡éªŒ <code>UBOOT</code>ï¼Œä¹Ÿå°±ä¿è¯äº† <code>uboot</code> æ— æ³•è¢«ç¯¡æ”¹ã€‚<em>å¯¹åº”ä¸‹å›¾ä¸­çš„ 7,8 æ­¥</em>ã€‚</li><li><code>uboot</code> æ ¡éªŒ <code>kernel/rootfs</code>ï¼Œä¿è¯äº†å®ƒä»¬æ— æ³•è¢«ç¯¡æ”¹ã€‚</li></ul><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-enc-fip.drawio.png" alt="å®‰å…¨å¯åŠ¨-sign-enc-fip.drawio"></p><p>å›åˆ°ä¸Šé¢çš„é—®é¢˜ï¼Œ<code>rom</code> ä¸­å¹¶ä¸æ˜¯åªæ ¡éªŒäº† <code>ROOT_PK</code>ï¼Œè€Œæ˜¯æ ¡éªŒäº† <code>bl2</code> çš„ç­¾åã€‚å³ä½¿ <code>root pk</code> æ³„éœ²äº†ï¼Œä¹Ÿä¸ä¼šå½±å“ <code>bl2</code> çš„ç­¾åæ ¡éªŒï¼ˆè¿™éœ€è¦ root å’Œ bl çš„ç§é’¥ï¼‰ã€‚ä¸å­˜åœ¨å®‰å…¨é£é™©ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œç›®å‰ <code>kernel</code> å’Œ <code>rootfs</code> çš„æ ¡éªŒåšçš„ä¸å¤ªå¥½ï¼Œç†è®ºä¸Š <code>uboot</code> é˜¶æ®µå»æ ¡éªŒ <code>kernel</code> å’Œ <code>rootfs</code> çš„ç­¾åæ—¶ï¼Œåº”è¯¥ä½¿ç”¨æ–°çš„ç§˜é’¥ï¼Œè€Œä¸æ˜¯ <code>root pk</code>ã€‚ä¹Ÿå°±æ˜¯ <code>NTKC_PRIV.pem</code> çš„å…¬é’¥ä¹Ÿå¯ä»¥è®°å½•åœ¨ <code>fip.bin</code> ä¸­ï¼Œ<code>fsbl</code> ä¸­å¯¹ <code>uboot</code> éªŒç­¾çš„æ—¶å€™ï¼Œç”¨ <code>bl_pk</code> å¯¹ <code>sig.bin</code> è¿›è¡ŒéªŒç­¾ï¼Œä¹Ÿå°±æ˜¯å°† <code>sig.bin</code> ä¸­çš„ <code>NTKC_PK.pem</code> æ¢ä¸º <code>bl_pk</code>ï¼Œè¿™æ ·å°±æ˜¯ä¸€å±‚ä¸€å±‚çš„ä¾èµ–å…³ç³»ã€‚è€Œä¸æ˜¯ç°åœ¨ <code>uboot</code> ç›´æ¥ç”¨ <code>root</code> çš„å…¬é’¥ã€‚ã€‚ä¸è¿‡ä¹Ÿè¿˜å¥½ï¼Œå½±å“ä¸å¤§ã€‚</p><p><img src="/../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-boot-rootfs.drawio.png" alt="å®‰å…¨å¯åŠ¨-sign-boot-rootfs.drawio"></p></blockquote></li><li><p><strong>å®‰å…¨å¯åŠ¨çš„æ„ä¹‰</strong></p><blockquote><ul><li><p>é˜²æ­¢ç”¨æˆ·çƒ§å½•æœªç»æˆæƒçš„å›ºä»¶ã€‚ï¼ˆç­¾åï¼‰</p><blockquote><p>å¯ç”¨å®‰å…¨å¯åŠ¨ä¹‹åï¼Œåªèƒ½çƒ§å½•ç­¾ååçš„å›ºä»¶ã€‚</p></blockquote></li><li><p>é˜²æ­¢é€šè¿‡å›ºä»¶æ‹·è´ï¼Œæ¥æŠ„è¢­äº§å“ã€‚ï¼ˆç­¾å+åŠ å¯†ï¼‰</p><blockquote><p>A å–èŠ¯ç‰‡ï¼Œæä¾› SDKã€‚</p><p>B ä¹°èŠ¯ç‰‡ï¼Œç”»æ¿å­ï¼Œç”¨ A æä¾›çš„ èŠ¯ç‰‡ + SDK åšäº§å“å–ã€‚</p><p>C æŠ„ B çš„æ¿å­ï¼Œå¹¶ç›´æ¥æ‹· B <code>flash</code> ä¸­çš„å›ºä»¶ï¼Œå†ä¹° A çš„åŒæ¬¾èŠ¯ç‰‡ã€‚ç†è®ºä¸Šç”¨å¾ˆä½çš„æˆæœ¬å°±å®Œæˆäº†å¯¹ B äº§å“çš„å®Œå…¨å¤åˆ¶ã€‚</p><p>å¦‚ä½•é¿å…å‘¢ï¼Ÿ</p><ol><li>å®‰å…¨å¯åŠ¨ï¼ˆä»…ç­¾åï¼‰ï¼ŒC çš„è§†è§’æ¥çœ‹ï¼Œå›ºä»¶æœ‰äº†ï¼Œé—®é¢˜åœ¨äºèŠ¯ç‰‡ä¸Šçš„ <code>efuse</code> çƒ§å†™ã€‚ä¸è¿‡ä»…ç­¾åçš„è¯ï¼Œåªä¼šç”¨åˆ° <code>root_pk</code>ï¼Œè€Œè¿™æ˜¯å¯ä»¥ä»å›ºä»¶ <code>fip.bin</code> ä¸­è·å¾—çš„ã€‚å› æ­¤ <code>C</code> è¿˜æ˜¯å¯ä»¥æŠ„è¢­ã€‚</li><li>å®‰å…¨å¯åŠ¨ï¼ˆç­¾å + åŠ å¯†ï¼‰ï¼ŒC çš„è§†è§’æ¥çœ‹ï¼Œå›ºä»¶æœ‰äº†ï¼Œè¿˜å·® <code>LOADER_EK</code>ï¼Œè€Œè¿™æ— æ³•è¯»å–ã€‚å› æ­¤ï¼Œæ— æ³•æŠ„è¢­ã€‚</li></ol></blockquote></li></ul></blockquote></li><li><p>ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œè¿˜æœ‰ä¸€ä¸ªå…³é”®åœ¨äº <code>efuse</code> ä¸­çš„ <code>AES</code> ç§˜é’¥ï¼Œç»ä¸èƒ½è¢«çªƒå–ã€‚å¦‚ä½•å®ç°å‘¢ï¼Ÿå®‰å…¨ä»‹é¢å’Œéå®‰å…¨ä»‹é¢</p><blockquote></blockquote></li></ol><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://doc.sophgo.com/cvitek-develop-docs/master/docs_latest_release/CV180x_CV181x/zh/01.software/BSP/Secure_Boot_User_Guide/build/html/3_Secure_Image_Generation.html">å®‰å…¨å¯åŠ¨ä½¿ç”¨æŒ‡å—</a></li><li><a href="https://doc.sophgo.com/cvitek-develop-docs/master/docs_latest_release/CV180x_CV181x/zh/01.software/BSP/eFuse_User_Guide/build/html/index.html">eFuse ä½¿ç”¨æŒ‡å—</a></li><li><a href="https://cloud.tencent.com/developer/article/1693368">å›¾è§£|ä»€ä¹ˆæ˜¯ RSA ç®—æ³•</a></li><li><a href="https://mp.weixin.qq.com/s/XBYJFZ2jRF2slrlym3svQw">ç›˜ç‚¹äº”ç§æœ€å¸¸è§åŠ å¯†ç®—æ³•ï¼</a></li><li><a href="https://mp.weixin.qq.com/s/Hu1VBMSHh82n6bujWxr9nw">å¯†ç å­¦åŸºæœ¬æ¦‚å¿µ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Cvitek </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Cvitek </tag>
            
            <tag> uboot </tag>
            
            <tag> å¯åŠ¨æµç¨‹ </tag>
            
            <tag> sha256 </tag>
            
            <tag> rsa </tag>
            
            <tag> aes </tag>
            
            <tag> openssl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gdb</title>
      <link href="/2023/04/14/gdb/"/>
      <url>/2023/04/14/gdb/</url>
      
        <content type="html"><![CDATA[<h1 id="GDB-å¤‡å¿˜æ¸…å•"><a href="#GDB-å¤‡å¿˜æ¸…å•" class="headerlink" title="GDB å¤‡å¿˜æ¸…å•"></a>GDB å¤‡å¿˜æ¸…å•</h1><p>æœ¬æ¸…å•æä¾›äº†å¯¹ <a href="https://en.wikipedia.org/wiki/GNU_Debugger">GDB</a> çš„å…¥é—¨ç®€è¦æ¦‚è¿°ï¼Œä»¥åŠ <code>GDB</code> å¸¸ç”¨ç¤ºä¾‹ï¼Œå®Œæ•´æ–‡æ¡£å‚é˜… <a href="https://www.eecs.umich.edu/courses/eecs373/readings/Debugger.pdf">Debugging with gdb</a>ï¼Œè¯¥æ–‡æ¡£æœ€åæœ‰ <code>GDB index</code>ï¼Œå¯ä»¥å¿«é€ŸæŸ¥æ‰¾å‘½ä»¤ã€‚</p><h2 id="å…¥é—¨"><a href="#å…¥é—¨" class="headerlink" title="å…¥é—¨"></a>å…¥é—¨</h2><!--rehype:body-class=cols-2--><h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><!--rehype:wrap-class=row-span-2--><p><code>[]</code> å†…ä¸ºå‘½ä»¤ç¼©å†™</p><table><thead><tr><th align="left">å‘½ä»¤ <code>[ç¼©å†™]</code></th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>help[h]</code></td><td align="left"><strong>æŸ¥çœ‹å‘½ä»¤å¸®åŠ©</strong>ã€‚å¦‚ <code>help run</code></td></tr><tr><td align="left"><code>run[r]</code></td><td align="left"><strong>è¿è¡Œç¨‹åº</strong>ã€‚å¯æ­é…å‚æ•°ä½¿ç”¨</td></tr><tr><td align="left"><code>start</code></td><td align="left"><strong>è¿è¡Œç¨‹åºï¼Œåœåœ¨ç¬¬ä¸€æ¡æ‰§è¡Œè¯­å¥</strong>ã€‚å¯æ­é…å‚æ•°ä½¿ç”¨</td></tr><tr><td align="left"><code>list[l]</code></td><td align="left"><strong>æŸ¥çœ‹ç¨‹åºæºç </strong></td></tr><tr><td align="left"><code>break[b]</code></td><td align="left"><strong>è®¾ç½®æ–­ç‚¹</strong>ã€‚å¯æŒ‡å®šæ–‡ä»¶åã€å‡½æ•°åå’Œè¡Œå·ç­‰å‚æ•°æ¥è®¾ç½®æ–­ç‚¹</td></tr><tr><td align="left"><code>watch</code></td><td align="left"><strong>è®¾ç½®ç›‘è§†ç‚¹</strong>ã€‚å½“ç›‘è§†çš„å˜é‡å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œç¨‹åºä¼šè¢«ä¸­æ–­</td></tr><tr><td align="left"><code>delete</code></td><td align="left"><strong>åˆ é™¤æ–­ç‚¹ç­‰</strong>ã€‚å¯ç”¨äºåˆ é™¤æ–­ç‚¹ã€ç›‘è§†ç‚¹ã€<code>display</code> ç­‰</td></tr><tr><td align="left"><code>continue[c]</code></td><td align="left"><strong>ç»§ç»­æ‰§è¡Œç¨‹åº</strong>ã€‚è®©ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æˆ–ç¨‹åºç»“æŸ</td></tr><tr><td align="left"><code>next[n]</code></td><td align="left"><strong>å•æ­¥æ‰§è¡Œç¨‹åºï¼Œè·³è¿‡å‡½æ•°è°ƒç”¨</strong></td></tr><tr><td align="left"><code>step[s]</code></td><td align="left"><strong>å•æ­¥æ‰§è¡Œç¨‹åºï¼Œè¿›å…¥å‡½æ•°è°ƒç”¨</strong></td></tr><tr><td align="left"><code>finish</code></td><td align="left"><strong>ç»“æŸå½“å‰å‡½æ•°</strong>ã€‚è¿”å›åˆ°å‡½æ•°è°ƒç”¨ç‚¹</td></tr><tr><td align="left"><code>kill</code></td><td align="left"><strong>æ€æ­»å½“å‰çš„è°ƒè¯•è¿›ç¨‹</strong></td></tr><tr><td align="left"><code>backtrace[bt]</code></td><td align="left"><strong>æŸ¥çœ‹å‡½æ•°è°ƒç”¨æ ˆ</strong>ã€‚å®ƒä¼šæ‰“å°å‡ºå½“å‰çš„å‡½æ•°è°ƒç”¨æ ˆ</td></tr><tr><td align="left"><code>frame[fr]</code></td><td align="left"><strong>åˆ‡æ¢æ ˆå¸§</strong>ã€‚ä»¥æŸ¥çœ‹è¯¥æ ˆå¸§ä¸­çš„å±€éƒ¨å˜é‡å’Œå‚æ•°ç­‰</td></tr><tr><td align="left"><code>info</code></td><td align="left"><strong>æŸ¥çœ‹ç¨‹åºçŠ¶æ€ä¿¡æ¯</strong>ã€‚ä¾‹å¦‚æ–­ç‚¹ã€å¯„å­˜å™¨ã€çº¿ç¨‹ã€å±€éƒ¨å˜é‡ç­‰</td></tr><tr><td align="left"><code>show</code></td><td align="left"><strong>æŸ¥çœ‹ <code>gdb</code> é…ç½®ä¿¡æ¯</strong>ã€‚ä¸ <code>info</code> ä¸åŒï¼Œ <code>show</code> æŸ¥çœ‹ <code>GDB</code> æœ¬èº«çš„é…ç½®ä¿¡æ¯</td></tr><tr><td align="left"><code>set</code></td><td align="left"><strong>è®¾ç½®å˜é‡å€¼</strong>ã€‚æœ‰æ—¶æŒ‡å®šå˜é‡ç±»å‹æ‰èƒ½è®¾ç½®ï¼Œå¦‚ <code>set *(int*)(&amp;a) = 3</code></td></tr><tr><td align="left"><code>whatis</code></td><td align="left"><strong>æŸ¥çœ‹å˜é‡ã€å‡½æ•°ç±»å‹</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>whatis a</code> å¯ä»¥æ˜¾ç¤ºå˜é‡ <code>a</code> çš„ç±»å‹</td></tr><tr><td align="left"><code>ptype</code></td><td align="left"><strong>æŸ¥çœ‹å˜é‡ã€å‡½æ•°ç±»å‹</strong>ã€‚ä¼šæ˜¾ç¤ºå®Œæ•´çš„ç»“æ„ä½“ç±»å‹</td></tr><tr><td align="left"><code>print[p]</code></td><td align="left"><strong>æ‰“å°å˜é‡çš„å€¼</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>print x</code> å¯ä»¥æ˜¾ç¤ºå˜é‡ <code>x</code> çš„å½“å‰å€¼</td></tr><tr><td align="left"><code>display</code></td><td align="left"><strong>æŒç»­æ‰“å°å˜é‡çš„å€¼</strong>ã€‚ä¸ <code>print</code> ç±»ä¼¼ï¼Œä½†å®ƒä¼šåœ¨æ¯æ¬¡åœä¸‹æ—¶è‡ªåŠ¨è¾“å‡ºå€¼</td></tr><tr><td align="left"><code>thread</code></td><td align="left"><strong>åˆ‡æ¢çº¿ç¨‹</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>thread 2</code> åˆ‡æ¢åˆ°ç¼–å·ä¸º <code>2</code> çš„çº¿ç¨‹</td></tr><tr><td align="left"><code>signal</code></td><td align="left"><strong>å‘è¿›ç¨‹å‘é€ä¿¡å·</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>signal 9</code> å‘é€ç¼–å·ä¸º <code>9</code> çš„ä¿¡å·</td></tr></tbody></table><!--rehype:className=left-align--><h3 id="å¯åŠ¨è°ƒè¯•"><a href="#å¯åŠ¨è°ƒè¯•" class="headerlink" title="å¯åŠ¨è°ƒè¯•"></a>å¯åŠ¨è°ƒè¯•</h3><p>å¯åŠ¨è¿›ç¨‹ï¼Œä¸å¸¦å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb &lt;program&gt;</span></span><br><span class="line">(gdb) run</span><br></pre></td></tr></table></figure><p>å¯åŠ¨è¿›ç¨‹ï¼Œå¸¦å‚æ•° <code>&lt;args&gt;</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb &lt;program&gt;</span></span><br><span class="line">(gdb) run &lt;args&gt;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ <code>gdb</code> æ—¶ä¼ å…¥å‚æ•°ï¼Œ<code>run</code> å°±ä¸ç”¨ä¼ å…¥äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb --args &lt;program&gt; 1 2 3</span></span><br><span class="line">(gdb) run</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>set</code> è®¾ç½®å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># gdb &lt;program&gt;</span></span><br><span class="line">(gdb) <span class="built_in">set</span> args 1 2 3</span><br><span class="line">(gdb) run</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºè¿è¡Œæ—¶å°†è¦æˆ–å·²ç»ä¼ é€’ç»™ç¨‹åºçš„å‚æ•°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) show args</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨è¿›ç¨‹å‰ï¼Œæ·»åŠ ç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">set</span> <span class="built_in">env</span> DEBUG 1</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨è¿›ç¨‹å‰ï¼Œæ¸…é™¤ç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) <span class="built_in">unset</span> <span class="built_in">env</span> DEBUG</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿›ç¨‹å· <code>123</code> è¿æ¥åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) attach 123</span><br></pre></td></tr></table></figure><h3 id="core-dump-æ–‡ä»¶"><a href="#core-dump-æ–‡ä»¶" class="headerlink" title="core dump æ–‡ä»¶"></a>core dump æ–‡ä»¶</h3><!--rehype:wrap-class=row-span-2--><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>linux</code> ç³»ç»Ÿä¸­ç¨‹åºå´©æºƒæ—¶ä¹Ÿä¸ä¼šç”Ÿæˆ <code>core dump</code> æ–‡ä»¶ï¼Œéœ€è¦å…ˆå¯ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -c unlimited</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/tmp/core-%e-%p-%t&quot;</span> &gt; /proc/sys/kernel/core_pattern</span><br></pre></td></tr></table></figure><p>è°ƒè¯• <code>core</code> æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb program /tmp/core-file</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹æºç "><a href="#æŸ¥çœ‹æºç " class="headerlink" title="æŸ¥çœ‹æºç "></a>æŸ¥çœ‹æºç </h3><!--rehype:wrap-class=row-span-2--><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) list 30</code></td><td align="left">æŸ¥çœ‹ç¬¬ <code>30</code> è¡Œä¸ºä¸­å¿ƒçš„ä¸Šä¸‹ <code>5</code> è¡Œæºç </td></tr><tr><td align="left"><code>(gdb) list main</code></td><td align="left">æŸ¥çœ‹ <code>main</code> å‡½æ•°ä¸ºä¸­å¿ƒçš„ä¸Šä¸‹ <code>5</code> è¡Œæºç </td></tr><tr><td align="left"><code>(gdb) list file.c:30</code></td><td align="left">æŸ¥çœ‹ <code>file.c</code> æ–‡ä»¶ä¸­ <code>30</code> è¡Œçš„æºç </td></tr><tr><td align="left"><code>(gdb) list file.c:main</code></td><td align="left">æŸ¥çœ‹ <code>file.c</code> æ–‡ä»¶ä¸­ <code>main</code> å‡½æ•°</td></tr><tr><td align="left"><code>(gdb) disassemble</code></td><td align="left">æŸ¥çœ‹å½“å‰å¯æ‰§è¡Œæ–‡ä»¶çš„æ±‡ç¼–æºç </td></tr><tr><td align="left"><code>(gdb) disassemble myfun</code></td><td align="left">æŸ¥çœ‹æŒ‡å®šå‡½æ•°çš„æ±‡ç¼–æºç </td></tr></tbody></table><h3 id="æµç¨‹æ§åˆ¶"><a href="#æµç¨‹æ§åˆ¶" class="headerlink" title="æµç¨‹æ§åˆ¶"></a>æµç¨‹æ§åˆ¶</h3><!--rehype:wrap-class=row-span-2--><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) step[s]</code></td><td align="left">æ‰§è¡Œæºç çº§åˆ«çš„å•æ­¥è¿›å…¥æ“ä½œ</td></tr><tr><td align="left"><code>(gdb) stepi[si]</code></td><td align="left">æ‰§è¡ŒæŒ‡ä»¤çº§åˆ«çš„å•æ­¥è¿›å…¥æ“ä½œ</td></tr><tr><td align="left"><code>(gdb) next[n]</code></td><td align="left">æ‰§è¡Œæºç çº§åˆ«çš„å•æ­¥è·³è¿‡æ“ä½œ</td></tr><tr><td align="left"><code>(gdb) nexti[ni]</code></td><td align="left">æ‰§è¡ŒæŒ‡ä»¤çº§åˆ«çš„å•æ­¥è·³è¿‡æ“ä½œ</td></tr><tr><td align="left"><code>(gdb) continue[c]</code></td><td align="left">ç»§ç»­æ‰§è¡Œï¼Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æˆ–ç¨‹åºç»“æŸ</td></tr><tr><td align="left"><code>(gdb) finish</code></td><td align="left">è¿è¡Œå®Œå½“å‰å‡½æ•°ï¼Œå¹¶è¿”å›åˆ°å‡½æ•°è°ƒç”¨ç‚¹</td></tr><tr><td align="left"><code>(gdb) return</code></td><td align="left">ç›´æ¥é€€å‡ºå½“å‰å‡½æ•°ï¼Œä¸æ‰§è¡Œå‰©ä¸‹ä»£ç å—</td></tr><tr><td align="left"><code>(gdb) return expression</code></td><td align="left">å¯ä»¥æŒ‡å®šè¿”å›å€¼çš„å†…å®¹</td></tr><tr><td align="left"><code>(gdb) until</code></td><td align="left">ç»“æŸå½“å‰å¾ªç¯</td></tr></tbody></table><h3 id="æ–­ç‚¹å‘½ä»¤"><a href="#æ–­ç‚¹å‘½ä»¤" class="headerlink" title="æ–­ç‚¹å‘½ä»¤"></a>æ–­ç‚¹å‘½ä»¤</h3><!--rehype:wrap-class=row-span-2--><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) break main</code></td><td align="left">åœ¨æ‰€æœ‰åä¸º <code>main</code> çš„å‡½æ•°å¤„è®¾ç½®ä¸€ä¸ªæ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) break test.c:12</code></td><td align="left">åœ¨æ–‡ä»¶ <code>test.c</code> çš„ç¬¬ <code>12</code> è¡Œè®¾ç½®æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) break test.c:func</code></td><td align="left">åœ¨æ–‡ä»¶ <code>test.c</code> çš„ <code>func</code> å‡½æ•°å¤„è®¾ç½®æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) rbreak regular-expression</code></td><td align="left">åœ¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„å‡½æ•°åä¸Šè®¾ç½®æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) break foo if a &lt; 100</code></td><td align="left">è®¾ç½®<strong>æ¡ä»¶æ–­ç‚¹</strong>ï¼Œæ¡ä»¶æ»¡è¶³æ‰åœæ­¢</td></tr><tr><td align="left"><code>(gdb) info break</code></td><td align="left">åˆ—å‡ºæ‰€æœ‰æ–­ç‚¹ä½ç½®ã€ç¼–å·</td></tr><tr><td align="left"><code>(gdb) delete 2</code></td><td align="left">åˆ é™¤æŒ‡å®šç¼–å·çš„æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) clear</code></td><td align="left">åˆ é™¤åˆšæ‰åœæ­¢å¤„çš„æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) disable 1</code></td><td align="left"><code>disable</code> æŒ‡å®šç¼–å·çš„æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) enable 1</code></td><td align="left"><code>enable</code> æŒ‡å®šç¼–å·çš„æ–­ç‚¹</td></tr></tbody></table><h3 id="watch-å‘½ä»¤"><a href="#watch-å‘½ä»¤" class="headerlink" title="watch å‘½ä»¤"></a>watch å‘½ä»¤</h3><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) watch var</code></td><td align="left">ç›‘è§†å˜é‡ï¼Œå½“å€¼å˜åŒ–æ—¶ä¼šè¾“å‡ºæ–°ã€æ—§å€¼</td></tr><tr><td align="left"><code>(gdb) info break</code></td><td align="left">åˆ—å‡ºæ–­ç‚¹ï¼Œä¹ŸåŒ…æ‹¬ <code>watchpoint</code></td></tr><tr><td align="left"><code>(gdb) i watch</code></td><td align="left">åªåˆ—å‡º <code>watchpoint</code></td></tr><tr><td align="left"><code>(gdb) delete 1</code></td><td align="left">åˆ é™¤æŒ‡å®šçš„ <code>watchpoint</code></td></tr></tbody></table><h3 id="æŸ¥çœ‹å˜é‡"><a href="#æŸ¥çœ‹å˜é‡" class="headerlink" title="æŸ¥çœ‹å˜é‡"></a>æŸ¥çœ‹å˜é‡</h3><!--rehype:wrap-class=row-span-2--><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) info args</code></td><td align="left">æŸ¥çœ‹ä¼ å…¥å‚æ•°ä¿¡æ¯</td></tr><tr><td align="left"><code>(gdb) info local</code></td><td align="left">æŸ¥çœ‹å½“å‰æ ˆå¸§ï¼ˆå‡½æ•°ï¼‰çš„æœ¬åœ°å˜é‡</td></tr><tr><td align="left"><code>(gdb) print var</code></td><td align="left">æŸ¥çœ‹æŒ‡å®šå˜é‡çš„å€¼</td></tr><tr><td align="left"><code>(gdb) print/x var</code></td><td align="left">ä»¥åå…­è¿›åˆ¶è¾“å‡ºå˜é‡çš„å€¼</td></tr><tr><td align="left"><code>(gdb) print ptr</code></td><td align="left">å‡è®¾ <code>int *ptr=&amp;a</code>ï¼Œè¾“å‡ºå˜é‡ <code>a</code> çš„åœ°å€</td></tr><tr><td align="left"><code>(gdb) print *ptr</code></td><td align="left">å‡è®¾ <code>int *ptr=&amp;a</code>ï¼Œè¾“å‡ºå˜é‡ <code>a</code> çš„å€¼</td></tr><tr><td align="left"><code>(gdb) print *ptr@5</code></td><td align="left">å‡è®¾ <code>int ptr[5]</code>ï¼Œè¾“å‡ºæ•°ç»„çš„å€¼</td></tr><tr><td align="left"><code>(gdb) display var</code></td><td align="left">ä¸ <code>print</code> ä½œç”¨ç›¸åŒï¼Œä½†æ¯æ¬¡åœä¸‹æ¥éƒ½è‡ªåŠ¨è¾“å‡ºå˜é‡çš„å€¼</td></tr><tr><td align="left"><code>(gdb) info display</code></td><td align="left">åˆ—å‡ºæ‰€æœ‰è®¾ç½®äº† <code>display</code> çš„å˜é‡</td></tr><tr><td align="left"><code>(gdb) undisplay 1</code></td><td align="left">ä¸ <code>display</code> ç›¸åï¼Œä¸èƒ½æŒ‡å®šå˜é‡åï¼Œåªèƒ½æ˜¯ç¼–å·</td></tr><tr><td align="left"><code>(gdb) delete display 1</code></td><td align="left">ä¸ <code>undisplay</code> ç±»ä¼¼ï¼Œé€šè¿‡ç¼–å·å–æ¶ˆæ˜¾ç¤º</td></tr><tr><td align="left"><code>(gdb) whatis var</code></td><td align="left">æŸ¥çœ‹å˜é‡ç±»å‹</td></tr><tr><td align="left"><code>(gdb) ptype var</code></td><td align="left">æ¯” <code>type</code> æ›´è¯¦ç»†ï¼Œä¼šç»™å‡ºç»“æ„ä½“çš„å®šä¹‰</td></tr></tbody></table><h3 id="å¯¼å…¥ç¬¦å·è¡¨"><a href="#å¯¼å…¥ç¬¦å·è¡¨" class="headerlink" title="å¯¼å…¥ç¬¦å·è¡¨"></a>å¯¼å…¥ç¬¦å·è¡¨</h3><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>(gdb) add-symbol-file xxx.so 0xd0832000</code></td><td>å¯¼å…¥ <code>xxx.so</code> ä¸­ <code>.text</code> éƒ¨åˆ†çš„å†…å®¹</td></tr><tr><td><code>(gdb) add-symbol-file xxx.so 0xd0832000 -s .bss 0xxxxxx</code></td><td>é€šè¿‡ <code>-s</code> å¯ä»¥å¯¼å…¥é¢å¤–çš„æ®µ</td></tr><tr><td><code>(gdb) add-symbol-file xxx.so 0xd0832000 -s .data 0xxxxxx</code></td><td></td></tr></tbody></table><h3 id="frame-æ ˆå¸§"><a href="#frame-æ ˆå¸§" class="headerlink" title="frame æ ˆå¸§"></a>frame æ ˆå¸§</h3><p>æ¯å½“ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œä¸€ä¸ªæ–°çš„æ ˆå¸§ <code>frame</code> å°±ä¼šè¢«å‹å…¥æ ˆä¸­ï¼Œæ ˆå¸§åŒ…å«äº†è¯¥å‡½æ•°çš„å±€éƒ¨å˜é‡ã€å‚æ•°ã€è¿”å›åœ°å€å’Œå…¶ä»–ä¿¡æ¯ï¼Œå½“å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œè¿™ä¸ªæ ˆå¸§ä¼šè¢«å¼¹å‡ºæ ˆå¹¶é”€æ¯ã€‚</p><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) frame</code></td><td align="left">æ˜¾ç¤ºå½“å‰æ ˆå¸§å’Œæºä»£ç è¡Œ</td></tr><tr><td align="left"><code>(gdb) backtrace</code></td><td align="left">æ‰“å°å‡ºå½“å‰æ­£åœ¨æ‰§è¡Œçš„æ‰€æœ‰æ ˆå¸§</td></tr><tr><td align="left"><code>(gdb) backtrace 5</code></td><td align="left">åªæ˜¾ç¤ºæœ€è¿‘è°ƒç”¨çš„ <code>5</code> ä¸ªæ ˆå¸§</td></tr><tr><td align="left"><code>(gdb) frame 2</code></td><td align="left">åˆ‡æ¢åˆ°ç¬¬ <code>2</code> ä¸ªæ ˆå¸§ï¼Œä»¥æŸ¥çœ‹ä¿¡æ¯</td></tr><tr><td align="left"><code>(gdb) up</code></td><td align="left">åˆ‡æ¢åˆ°ä¸Šä¸€çº§è°ƒç”¨æ ˆå¸§</td></tr><tr><td align="left"><code>(gdb) down</code></td><td align="left">åˆ‡æ¢åˆ°ä¸‹ä¸€çº§è°ƒç”¨æ ˆå¸§</td></tr></tbody></table><h3 id="å‡½æ•°è°ƒç”¨"><a href="#å‡½æ•°è°ƒç”¨" class="headerlink" title="å‡½æ•°è°ƒç”¨"></a>å‡½æ•°è°ƒç”¨</h3><p><code>call</code> å’Œ <code>print</code> è°ƒç”¨çš„å‡½æ•°å¦‚æœå­˜åœ¨å…¨å±€å˜é‡ã€é™æ€å˜é‡çš„ä¿®æ”¹ï¼Œåœ¨å‡½æ•°è¿”å›åä¼šæ¢å¤åˆ°è°ƒç”¨ä¹‹å‰çš„å€¼ï¼Œè¿™ä¸¤ä¸ªè°ƒç”¨ä¸ä¼šå½±å“ç¨‹åºçš„çŠ¶æ€</p><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) call func(a, b)</code></td><td align="left">è°ƒç”¨æŒ‡å®šçš„å‡½æ•°ï¼Œä¸å½±å“ä¸»çº¿ç¨‹å˜é‡</td></tr><tr><td align="left"><code>(gdb) print func(a, b)</code></td><td align="left">ä¸ <code>call</code> ç±»ä¼¼</td></tr><tr><td align="left"><code>(gdb) finish</code></td><td align="left">ç»“æŸå½“å‰è¿è¡Œçš„å‡½æ•°</td></tr></tbody></table><h3 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h3><!--rehype:wrap-class=row-span-2--><p><code>linux</code> ä¸‹ä½¿ç”¨ <code>kill -l</code> æŸ¥çœ‹ä¿¡å·ç¼–å·ä¸ä¿¡å·åï¼Œä½¿ç”¨ <code>info signal</code> æŸ¥çœ‹ä¿¡å·çš„å¤„ç†æ–¹å¼ã€æè¿°ç­‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) info signal</span><br><span class="line">Signal        Stop  Print   Pass to program Description</span><br><span class="line"></span><br><span class="line">SIGHUP        Yes   Yes     Yes             Hangup</span><br><span class="line">SIGINT        Yes   Yes     No              Interrupt</span><br><span class="line">SIGQUIT       Yes   Yes     Yes             Quit</span><br><span class="line">SIGILL        Yes   Yes     Yes             Illegal instruction</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) signal SIGKILL</code></td><td align="left">å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼Œç”¨ä¿¡å·åæˆ–ç¼–å·è¡¨ç¤º</td></tr><tr><td align="left"><code>(gdb) signal 9</code></td><td align="left">å‘è¿›ç¨‹å‘é€ä¿¡å·ï¼Œç”¨ä¿¡å·åæˆ–ç¼–å·è¡¨ç¤º</td></tr><tr><td align="left"><code>(gdb) handle &lt;signal&gt; actions</code></td><td align="left">æŒ‡å®šä¿¡å·çš„å¤„ç†æ–¹å¼ï¼Œé€‰æ‹©å¦‚ä¸‹ï¼Œå¯ä»¥ç»„åˆ</td></tr><tr><td align="left"><code>stop/nostop</code></td><td align="left">æ”¶åˆ°ä¿¡å·æ˜¯å¦åœæ­¢è¿›ç¨‹ï¼Œç±»ä¼¼æ–­ç‚¹</td></tr><tr><td align="left"><code>print/noprint</code></td><td align="left">æ”¶åˆ°ä¿¡å·æ˜¯å¦è¾“å‡ºæ¶ˆæ¯</td></tr><tr><td align="left"><code>pass/nopass</code></td><td align="left">æ˜¯å¦å°†ä¿¡å·ä¼ é€’ç»™ç¨‹åº</td></tr></tbody></table><h3 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h3><table><thead><tr><th align="left">å‘½ä»¤</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><code>(gdb) info threads</code></td><td align="left">åˆ—å‡ºæ‰€æœ‰çº¿ç¨‹ï¼Œæ ‡è¯†å½“å‰æ‰€åœ¨çº¿ç¨‹</td></tr><tr><td align="left"><code>(gdb) thread 2</code></td><td align="left">åˆ‡æ¢åˆ°ç¼–å·ä¸º <code>2</code> çš„çº¿ç¨‹</td></tr><tr><td align="left"><code>(gdb) break file.c:23 thread all</code></td><td align="left">åœ¨æ‰€æœ‰çº¿ç¨‹ä¸­ç›¸åº”çš„è¡Œä¸Šè®¾ç½®æ–­ç‚¹</td></tr><tr><td align="left"><code>(gdb) thread apply all command</code></td><td align="left">è®©æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œ <code>gdb</code> å‘½ä»¤</td></tr><tr><td align="left"><code>(gdb) thread apply ID1 ID2 command</code></td><td align="left">è®©æŒ‡å®šçº¿ç¨‹æ‰§è¡Œ <code>gdb</code> å‘½ä»¤</td></tr><tr><td align="left"><code>(gdb) set scheduler-locking off</code></td><td align="left">æ‰€æœ‰çº¿ç¨‹éƒ½æ‰§è¡Œï¼Œè¿™æ˜¯é»˜è®¤å€¼</td></tr><tr><td align="left"><code>(gdb) set scheduler-locking on</code></td><td align="left">åªè®©å½“å‰çº¿ç¨‹æ‰§è¡Œ</td></tr></tbody></table><h2 id="å¦è§"><a href="#å¦è§" class="headerlink" title="å¦è§"></a>å¦è§</h2><ul><li><a href="https://carlyleliu.github.io/2022/%E5%BA%94%E7%94%A8%E5%B4%A9%E6%BA%83%E8%B0%83%E8%AF%95%E5%88%86%E6%9E%90">åº”ç”¨å´©æºƒè°ƒè¯•åˆ†æ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> gdb </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åå¤§ç»å…¸æ’åºç®—æ³•ï¼ˆåŠ¨å›¾æ¼”ç¤ºï¼‰</title>
      <link href="/2022/12/18/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/"/>
      <url>/2022/12/18/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡æ¥æºäº <a href="https://www.cnblogs.com/onepixel/articles/7674659.html">www.cnblogs.com</a>ï¼Œå°†ä»£ç å®ç°æ”¹ä¸ºäº† <code>c++</code><br>æ–‡ä¸­çš„åŠ¨æ€å›¾ä¹Ÿå¯ä»¥åœ¨ï¼š<a href="https://visualgo.net/zh/sorting">visualgo.net&#x2F;zh&#x2F;sorting</a> æŸ¥çœ‹ï¼Œè¿˜æœ‰å…¶ä»–ç®—æ³•çš„å¯è§†åŒ–ï¼<br>å¦ä¸€ä¸ªå¯è§†åŒ–æ’åºè¿‡ç¨‹çš„ç½‘ç«™ï¼š<a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">cs.usfca.edu&#x2F;~galles&#x2F;visualization&#x2F;Algorithms.html</a>ï¼Œè¿˜åŒ…æ‹¬æ•°æ®ç»“æ„çš„å¯è§†åŒ–</p></blockquote><h2 id="0ã€ç®—æ³•æ¦‚è¿°"><a href="#0ã€ç®—æ³•æ¦‚è¿°" class="headerlink" title="0ã€ç®—æ³•æ¦‚è¿°"></a>0ã€ç®—æ³•æ¦‚è¿°</h2><h3 id="0-1-ç®—æ³•åˆ†ç±»"><a href="#0-1-ç®—æ³•åˆ†ç±»" class="headerlink" title="0.1 ç®—æ³•åˆ†ç±»"></a>0.1 ç®—æ³•åˆ†ç±»</h3><p>åç§å¸¸è§æ’åºç®—æ³•å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š</p><ul><li><strong>æ¯”è¾ƒç±»æ’åº</strong>ï¼šé€šè¿‡æ¯”è¾ƒæ¥å†³å®šå…ƒç´ é—´çš„ç›¸å¯¹æ¬¡åºï¼Œç”±äºå…¶æ—¶é—´å¤æ‚åº¦ä¸èƒ½çªç ´ <code>O(nlogn)</code>ï¼Œå› æ­¤ä¹Ÿç§°ä¸ºéçº¿æ€§æ—¶é—´æ¯”è¾ƒç±»æ’åºã€‚</li><li><strong>éæ¯”è¾ƒç±»æ’åº</strong>ï¼šä¸é€šè¿‡æ¯”è¾ƒæ¥å†³å®šå…ƒç´ é—´çš„ç›¸å¯¹æ¬¡åºï¼Œå®ƒå¯ä»¥çªç ´åŸºäºæ¯”è¾ƒæ’åºçš„æ—¶é—´ä¸‹ç•Œï¼Œä»¥çº¿æ€§æ—¶é—´è¿è¡Œï¼Œå› æ­¤ä¹Ÿç§°ä¸ºçº¿æ€§æ—¶é—´éæ¯”è¾ƒç±»æ’åºã€‚</li></ul><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20190306165258970-1789860540.png" alt="algorithm"></p><h3 id="0-2-ç®—æ³•å¤æ‚åº¦"><a href="#0-2-ç®—æ³•å¤æ‚åº¦" class="headerlink" title="0.2 ç®—æ³•å¤æ‚åº¦"></a>0.2 ç®—æ³•å¤æ‚åº¦</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20180402133438219-1946132192.png" alt="complex"></p><p><strong>ç›¸å…³æ¦‚å¿µ</strong>ï¼š</p><ul><li><strong>ç¨³å®š</strong>ï¼šå¦‚æœ <code>a</code> åŸæœ¬åœ¨ <code>b</code> å‰é¢ï¼Œè€Œ <code>a=b</code>ï¼Œæ’åºä¹‹å <code>a</code> ä»ç„¶åœ¨ <code>b</code> çš„å‰é¢ã€‚</li><li><strong>ä¸ç¨³å®š</strong>ï¼šå¦‚æœ <code>a</code> åŸæœ¬åœ¨ <code>b</code> çš„å‰é¢ï¼Œè€Œ <code>a=b</code>ï¼Œæ’åºä¹‹å <code>a</code> å¯èƒ½ä¼šå‡ºç°åœ¨ <code>b</code> çš„åé¢ã€‚</li><li><strong>æ—¶é—´å¤æ‚åº¦</strong>ï¼šå¯¹æ’åºæ•°æ®çš„æ€»çš„æ“ä½œæ¬¡æ•°ã€‚åæ˜ å½“ <code>n</code> å˜åŒ–æ—¶ï¼Œæ“ä½œæ¬¡æ•°å‘ˆç°ä»€ä¹ˆè§„å¾‹ã€‚</li><li><strong>ç©ºé—´å¤æ‚åº¦ï¼š</strong>æ˜¯æŒ‡ç®—æ³•åœ¨è®¡ç®—æœºå†…æ‰§è¡Œæ—¶æ‰€éœ€å­˜å‚¨ç©ºé—´çš„åº¦é‡ï¼Œå®ƒä¹Ÿæ˜¯æ•°æ®è§„æ¨¡ <code>n</code> çš„å‡½æ•°ã€‚</li></ul><h2 id="1ã€å†’æ³¡æ’åºï¼ˆBubble-Sortï¼‰"><a href="#1ã€å†’æ³¡æ’åºï¼ˆBubble-Sortï¼‰" class="headerlink" title="1ã€å†’æ³¡æ’åºï¼ˆBubble Sortï¼‰"></a>1ã€å†’æ³¡æ’åºï¼ˆBubble Sortï¼‰</h2><p>å†’æ³¡æ’åºæ˜¯ä¸€ç§ç®€å•çš„æ’åºç®—æ³•ã€‚å®ƒé‡å¤åœ°èµ°è®¿è¿‡è¦æ’åºçš„æ•°åˆ—ï¼Œä¸€æ¬¡æ¯”è¾ƒä¸¤ä¸ªå…ƒç´ ï¼Œå¦‚æœå®ƒä»¬çš„é¡ºåºé”™è¯¯å°±æŠŠå®ƒä»¬äº¤æ¢è¿‡æ¥ã€‚èµ°è®¿æ•°åˆ—çš„å·¥ä½œæ˜¯é‡å¤åœ°è¿›è¡Œç›´åˆ°æ²¡æœ‰å†éœ€è¦äº¤æ¢ï¼Œä¹Ÿå°±æ˜¯è¯´è¯¥æ•°åˆ—å·²ç»æ’åºå®Œæˆã€‚è¿™ä¸ªç®—æ³•çš„åå­—ç”±æ¥æ˜¯å› ä¸ºè¶Šå°çš„å…ƒç´ ä¼šç»ç”±äº¤æ¢æ…¢æ…¢ â€œæµ®â€ åˆ°æ•°åˆ—çš„é¡¶ç«¯ã€‚</p><h3 id="1-1-ç®—æ³•æè¿°"><a href="#1-1-ç®—æ³•æè¿°" class="headerlink" title="1.1 ç®—æ³•æè¿°"></a>1.1 ç®—æ³•æè¿°</h3><ul><li>æ¯”è¾ƒç›¸é‚»çš„å…ƒç´ ã€‚å¦‚æœç¬¬ä¸€ä¸ªæ¯”ç¬¬äºŒä¸ªå¤§ï¼Œå°±äº¤æ¢å®ƒä»¬ä¸¤ä¸ªï¼›</li><li>å¯¹æ¯ä¸€å¯¹ç›¸é‚»å…ƒç´ ä½œåŒæ ·çš„å·¥ä½œï¼Œä»å¼€å§‹ç¬¬ä¸€å¯¹åˆ°ç»“å°¾çš„æœ€åä¸€å¯¹ï¼Œè¿™æ ·åœ¨æœ€åçš„å…ƒç´ åº”è¯¥ä¼šæ˜¯æœ€å¤§çš„æ•°ï¼›</li><li>é’ˆå¯¹æ‰€æœ‰çš„å…ƒç´ é‡å¤ä»¥ä¸Šçš„æ­¥éª¤ï¼Œé™¤äº†æœ€åä¸€ä¸ªï¼›</li><li>é‡å¤æ­¥éª¤ 1~3ï¼Œç›´åˆ°æ’åºå®Œæˆã€‚</li></ul><h3 id="1-2-åŠ¨å›¾æ¼”ç¤º"><a href="#1-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="1.2 åŠ¨å›¾æ¼”ç¤º"></a>1.2 åŠ¨å›¾æ¼”ç¤º</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015223238449-2146169197.gif" alt="bubblesort"></p><h3 id="1-3-ä»£ç å®ç°"><a href="#1-3-ä»£ç å®ç°" class="headerlink" title="1.3 ä»£ç å®ç°"></a>1.3 ä»£ç å®ç°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">bubbleSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; len<span class="number">-1</span>-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &gt; arr[j+<span class="number">1</span>])</span><br><span class="line">                <span class="built_in">swap</span>(arr[j], arr[j+<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2ã€é€‰æ‹©æ’åºï¼ˆSelection-Sortï¼‰"><a href="#2ã€é€‰æ‹©æ’åºï¼ˆSelection-Sortï¼‰" class="headerlink" title="2ã€é€‰æ‹©æ’åºï¼ˆSelection Sortï¼‰"></a>2ã€é€‰æ‹©æ’åºï¼ˆSelection Sortï¼‰</h2><p>é€‰æ‹©æ’åº (Selection-sort) æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†ï¼šé¦–å…ˆåœ¨æœªæ’åºåºåˆ—ä¸­æ‰¾åˆ°æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œå­˜æ”¾åˆ°æ’åºåºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œç„¶åï¼Œå†ä»å‰©ä½™æœªæ’åºå…ƒç´ ä¸­ç»§ç»­å¯»æ‰¾æœ€å°ï¼ˆå¤§ï¼‰å…ƒç´ ï¼Œç„¶åæ”¾åˆ°å·²æ’åºåºåˆ—çš„æœ«å°¾ã€‚ä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°æ‰€æœ‰å…ƒç´ å‡æ’åºå®Œæ¯•ã€‚</p><h3 id="2-1-ç®—æ³•æè¿°"><a href="#2-1-ç®—æ³•æè¿°" class="headerlink" title="2.1 ç®—æ³•æè¿°"></a>2.1 ç®—æ³•æè¿°</h3><p><code>n</code> ä¸ªè®°å½•çš„ç›´æ¥é€‰æ‹©æ’åºå¯ç»è¿‡ <code>n-1</code> è¶Ÿç›´æ¥é€‰æ‹©æ’åºå¾—åˆ°æœ‰åºç»“æœã€‚å…·ä½“ç®—æ³•æè¿°å¦‚ä¸‹ï¼š</p><ul><li>åˆå§‹çŠ¶æ€ï¼šæ— åºåŒºä¸º <code>R[1..n]</code>ï¼Œæœ‰åºåŒºä¸ºç©ºï¼›</li><li>ç¬¬ <code>i</code> è¶Ÿæ’åº (<code>i=1,2,3â€¦n-1</code>) å¼€å§‹æ—¶ï¼Œå½“å‰æœ‰åºåŒºå’Œæ— åºåŒºåˆ†åˆ«ä¸º <code>R[1..i-1]</code>å’Œ <code>R(i..n)</code>ã€‚è¯¥è¶Ÿæ’åºä»å½“å‰æ— åºåŒºä¸­ - é€‰å‡ºå…³é”®å­—æœ€å°çš„è®°å½• <code>R[k]</code>ï¼Œå°†å®ƒä¸æ— åºåŒºçš„ç¬¬ <code>1</code> ä¸ªè®°å½• <code>R</code> äº¤æ¢ï¼Œä½¿ <code>R[1..i]</code>å’Œ <code>R[i+1..n)</code>åˆ†åˆ«å˜ä¸ºè®°å½•ä¸ªæ•°å¢åŠ  <code>1</code> ä¸ªçš„æ–°æœ‰åºåŒºå’Œè®°å½•ä¸ªæ•°å‡å°‘ <code>1</code> ä¸ªçš„æ–°æ— åºåŒºï¼›</li><li><code>n-1</code> è¶Ÿç»“æŸï¼Œæ•°ç»„æœ‰åºåŒ–äº†ã€‚</li></ul><h3 id="2-2-åŠ¨å›¾æ¼”ç¤º"><a href="#2-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="2.2 åŠ¨å›¾æ¼”ç¤º"></a>2.2 åŠ¨å›¾æ¼”ç¤º</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015224719590-1433219824.gif" alt="selectsort">ã€€ã€€</p><h3 id="2-3-ä»£ç å®ç°"><a href="#2-3-ä»£ç å®ç°" class="headerlink" title="2.3 ä»£ç å®ç°"></a>2.3 ä»£ç å®ç°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">selectionSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> minIdx;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        minIdx = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = i+<span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &lt; arr[minIdx])</span><br><span class="line">                minIdx = j;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (minIdx != i)</span><br><span class="line">            <span class="built_in">swap</span>(arr[minIdx], arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2-4-ç®—æ³•åˆ†æ"><a href="#2-4-ç®—æ³•åˆ†æ" class="headerlink" title="2.4 ç®—æ³•åˆ†æ"></a>2.4 ç®—æ³•åˆ†æ</h3><p>è¡¨ç°æœ€ç¨³å®šçš„æ’åºç®—æ³•ä¹‹ä¸€ï¼Œå› ä¸ºæ— è®ºä»€ä¹ˆæ•°æ®è¿›å»éƒ½æ˜¯ <code>O(n2)</code> çš„æ—¶é—´å¤æ‚åº¦ï¼Œæ‰€ä»¥ç”¨åˆ°å®ƒçš„æ—¶å€™ï¼Œæ•°æ®è§„æ¨¡è¶Šå°è¶Šå¥½ã€‚å”¯ä¸€çš„å¥½å¤„å¯èƒ½å°±æ˜¯ä¸å ç”¨é¢å¤–çš„å†…å­˜ç©ºé—´äº†å§ã€‚ç†è®ºä¸Šè®²ï¼Œé€‰æ‹©æ’åºå¯èƒ½ä¹Ÿæ˜¯å¹³æ—¶æ’åºä¸€èˆ¬äººæƒ³åˆ°çš„æœ€å¤šçš„æ’åºæ–¹æ³•äº†å§ã€‚</p><h2 id="3ã€æ’å…¥æ’åºï¼ˆInsertion-Sortï¼‰"><a href="#3ã€æ’å…¥æ’åºï¼ˆInsertion-Sortï¼‰" class="headerlink" title="3ã€æ’å…¥æ’åºï¼ˆInsertion Sortï¼‰"></a>3ã€æ’å…¥æ’åºï¼ˆInsertion Sortï¼‰</h2><p>æ’å…¥æ’åºï¼ˆInsertion-Sortï¼‰çš„ç®—æ³•æè¿°æ˜¯ä¸€ç§ç®€å•ç›´è§‚çš„æ’åºç®—æ³•ã€‚å®ƒçš„å·¥ä½œåŸç†æ˜¯é€šè¿‡æ„å»ºæœ‰åºåºåˆ—ï¼Œå¯¹äºæœªæ’åºæ•°æ®ï¼Œåœ¨å·²æ’åºåºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼Œæ‰¾åˆ°ç›¸åº”ä½ç½®å¹¶æ’å…¥ã€‚</p><blockquote><p>core: å·¦è¾¹æ˜¯æœ‰åºæ•°ç»„ï¼Œå°†å³è¾¹æœªæ’åºçš„ç¬¬ä¸€ä¸ªæ•°æ’å…¥åˆ°å·¦è¾¹æœ‰åºæ•°ç»„ä¸­ã€‚</p></blockquote><h3 id="3-1-ç®—æ³•æè¿°"><a href="#3-1-ç®—æ³•æè¿°" class="headerlink" title="3.1 ç®—æ³•æè¿°"></a>3.1 ç®—æ³•æè¿°</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ’å…¥æ’åºéƒ½é‡‡ç”¨ <code>in-place</code> åœ¨æ•°ç»„ä¸Šå®ç°ã€‚å…·ä½“ç®—æ³•æè¿°å¦‚ä¸‹ï¼š</p><ul><li>ä»ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œè¯¥å…ƒç´ å¯ä»¥è®¤ä¸ºå·²ç»è¢«æ’åºï¼›</li><li>å–å‡ºä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å·²ç»æ’åºçš„å…ƒç´ åºåˆ—ä¸­ä»åå‘å‰æ‰«æï¼›</li><li>å¦‚æœè¯¥å…ƒç´ ï¼ˆå·²æ’åºï¼‰å¤§äºæ–°å…ƒç´ ï¼Œå°†è¯¥å…ƒç´ ç§»åˆ°ä¸‹ä¸€ä½ç½®ï¼›</li><li>é‡å¤æ­¥éª¤ 3ï¼Œç›´åˆ°æ‰¾åˆ°å·²æ’åºçš„å…ƒç´ å°äºæˆ–è€…ç­‰äºæ–°å…ƒç´ çš„ä½ç½®ï¼›</li><li>å°†æ–°å…ƒç´ æ’å…¥åˆ°è¯¥ä½ç½®åï¼›</li><li>é‡å¤æ­¥éª¤ 2~5ã€‚</li></ul><h3 id="3-2-åŠ¨å›¾æ¼”ç¤º"><a href="#3-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="3.2 åŠ¨å›¾æ¼”ç¤º"></a>3.2 åŠ¨å›¾æ¼”ç¤º</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015225645277-1151100000.gif" alt="insertsort"></p><h3 id="3-3-ä»£ç å®ç°"><a href="#3-3-ä»£ç å®ç°" class="headerlink" title="3.3 ä»£ç å®ç°"></a>3.3 ä»£ç å®ç°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertionSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> currVal, currIdx;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">        currIdx = i;</span><br><span class="line">        currVal = arr[i];</span><br><span class="line">        <span class="keyword">while</span>(currIdx &gt; <span class="number">0</span> &amp;&amp; currVal &lt; arr[currIdx<span class="number">-1</span>]) &#123;</span><br><span class="line">            arr[currIdx] = arr[currIdx<span class="number">-1</span>];</span><br><span class="line">            currIdx--;</span><br><span class="line">        &#125;</span><br><span class="line">        arr[currIdx] = currVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3-4-ç®—æ³•åˆ†æ"><a href="#3-4-ç®—æ³•åˆ†æ" class="headerlink" title="3.4 ç®—æ³•åˆ†æ"></a>3.4 ç®—æ³•åˆ†æ</h3><p>æ’å…¥æ’åºåœ¨å®ç°ä¸Šï¼Œé€šå¸¸é‡‡ç”¨ <code>in-place</code> æ’åºï¼ˆå³åªéœ€ç”¨åˆ° <code>O(1)</code> çš„é¢å¤–ç©ºé—´çš„æ’åºï¼‰ï¼Œå› è€Œåœ¨ä»åå‘å‰æ‰«æè¿‡ç¨‹ä¸­ï¼Œéœ€è¦åå¤æŠŠå·²æ’åºå…ƒç´ é€æ­¥å‘åæŒªä½ï¼Œä¸ºæœ€æ–°å…ƒç´ æä¾›æ’å…¥ç©ºé—´ã€‚</p><h2 id="4ã€å¸Œå°”æ’åºï¼ˆShell-Sortï¼‰"><a href="#4ã€å¸Œå°”æ’åºï¼ˆShell-Sortï¼‰" class="headerlink" title="4ã€å¸Œå°”æ’åºï¼ˆShell Sortï¼‰"></a>4ã€å¸Œå°”æ’åºï¼ˆShell Sortï¼‰</h2><p>1959 å¹´ Shell å‘æ˜ï¼Œç¬¬ä¸€ä¸ªçªç ´ <code>O(n2)</code> çš„æ’åºç®—æ³•ï¼Œæ˜¯ç®€å•æ’å…¥æ’åºçš„æ”¹è¿›ç‰ˆã€‚å®ƒä¸æ’å…¥æ’åºçš„ä¸åŒä¹‹å¤„åœ¨äºï¼Œå®ƒä¼šä¼˜å…ˆæ¯”è¾ƒè·ç¦»è¾ƒè¿œçš„å…ƒç´ ã€‚å¸Œå°”æ’åºåˆå«<strong>ç¼©å°å¢é‡æ’åº</strong>ã€‚</p><blockquote><p>core: åˆ†ç»„æ’å…¥æ’åºï¼Œçœ‹ä¸‹å›¾å§ã€‚</p></blockquote><h3 id="4-1-ç®—æ³•æè¿°"><a href="#4-1-ç®—æ³•æè¿°" class="headerlink" title="4.1 ç®—æ³•æè¿°"></a>4.1 ç®—æ³•æè¿°</h3><p>å…ˆå°†æ•´ä¸ªå¾…æ’åºçš„è®°å½•åºåˆ—åˆ†å‰²æˆä¸ºè‹¥å¹²å­åºåˆ—åˆ†åˆ«è¿›è¡Œç›´æ¥æ’å…¥æ’åºï¼Œå…·ä½“ç®—æ³•æè¿°ï¼š</p><ul><li>é€‰æ‹©ä¸€ä¸ªå¢é‡åºåˆ— <code>t1ï¼Œt2ï¼Œâ€¦ï¼Œtk</code>ï¼Œå…¶ä¸­ <code>ti&gt;tj</code>ï¼Œ<code>tk=1</code>ï¼›</li><li>æŒ‰å¢é‡åºåˆ—ä¸ªæ•° <code>k</code>ï¼Œå¯¹åºåˆ—è¿›è¡Œ <code>k</code> è¶Ÿæ’åºï¼›</li><li>æ¯è¶Ÿæ’åºï¼Œæ ¹æ®å¯¹åº”çš„å¢é‡ <code>ti</code>ï¼Œå°†å¾…æ’åºåˆ—åˆ†å‰²æˆè‹¥å¹²é•¿åº¦ä¸º <code>m</code> çš„å­åºåˆ—ï¼Œåˆ†åˆ«å¯¹å„å­è¡¨è¿›è¡Œç›´æ¥æ’å…¥æ’åºã€‚ä»…å¢é‡å› å­ä¸º <code>1</code> æ—¶ï¼Œæ•´ä¸ªåºåˆ—ä½œä¸ºä¸€ä¸ªè¡¨æ¥å¤„ç†ï¼Œè¡¨é•¿åº¦å³ä¸ºæ•´ä¸ªåºåˆ—çš„é•¿åº¦ã€‚</li></ul><h3 id="4-2-åŠ¨å›¾æ¼”ç¤º"><a href="#4-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="4.2 åŠ¨å›¾æ¼”ç¤º"></a>4.2 åŠ¨å›¾æ¼”ç¤º</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20180331170017421-364506073.gif" alt="shellsort"></p><h3 id="4-3-ä»£ç å®ç°"><a href="#4-3-ä»£ç å®ç°" class="headerlink" title="4.3 ä»£ç å®ç°"></a>4.3 ä»£ç å®ç°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">shellSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> currVal, currIdx;</span><br><span class="line">    <span class="comment">/* gap å°±æ˜¯ä¸Šé¢çš„ t1, t2, ... , tkï¼Œä¹Ÿæ˜¯åŠ¨å›¾ä¸­ä¸¤ä¸ªç›¸åŒé¢œè‰²æ–¹æ¡†çš„é—´è· */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> gap = len/<span class="number">2</span>; gap &gt; <span class="number">0</span>; gap = gap/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">/* å¸Œå°”æ’åºæ˜¯åŸºäºæ’å…¥æ’åºï¼Œä¸‹é¢çš„è¿‡ç¨‹å’Œæ’å…¥æ’åºä¸€è‡´ï¼Œ</span></span><br><span class="line"><span class="comment">         * é€šè¿‡ gap å®ç°äº†åˆ†ç»„æ’å…¥æ’åº</span></span><br><span class="line"><span class="comment">         * è¿™é‡Œå’ŒåŠ¨å›¾æ¼”ç¤ºçš„ä¸ä¸€æ ·ï¼ŒåŠ¨å›¾æ˜¯åˆ†ç»„æ‰§è¡Œï¼Œå®é™…æ“ä½œæ˜¯å¤šä¸ªåˆ†ç»„äº¤æ›¿æ‰§è¡Œ */</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = gap; i &lt; len; i++) &#123;</span><br><span class="line">            currIdx = i;</span><br><span class="line">            currVal = arr[i];</span><br><span class="line">            <span class="keyword">while</span>(currIdx-gap &gt;= <span class="number">0</span> &amp;&amp; currVal &lt; arr[currIdx-gap]) &#123;</span><br><span class="line">                arr[currIdx] = arr[currIdx-gap];</span><br><span class="line">                currIdx -= gap;</span><br><span class="line">            &#125;</span><br><span class="line">            arr[currIdx] = currVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4-4-ç®—æ³•åˆ†æ"><a href="#4-4-ç®—æ³•åˆ†æ" class="headerlink" title="4.4 ç®—æ³•åˆ†æ"></a>4.4 ç®—æ³•åˆ†æ</h3><p>å¸Œå°”æ’åºçš„æ ¸å¿ƒåœ¨äºé—´éš”åºåˆ—çš„è®¾å®šã€‚æ—¢å¯ä»¥æå‰è®¾å®šå¥½é—´éš”åºåˆ—ï¼Œä¹Ÿå¯ä»¥åŠ¨æ€çš„å®šä¹‰é—´éš”åºåˆ—ã€‚åŠ¨æ€å®šä¹‰é—´éš”åºåˆ—çš„ç®—æ³•æ˜¯ã€Šç®—æ³•ï¼ˆç¬¬ 4 ç‰ˆï¼‰ã€‹çš„åˆè‘—è€… Robert Sedgewick æå‡ºçš„ã€‚</p><h2 id="5ã€å½’å¹¶æ’åºï¼ˆMerge-Sortï¼‰"><a href="#5ã€å½’å¹¶æ’åºï¼ˆMerge-Sortï¼‰" class="headerlink" title="5ã€å½’å¹¶æ’åºï¼ˆMerge Sortï¼‰"></a>5ã€å½’å¹¶æ’åºï¼ˆMerge Sortï¼‰</h2><p>å½’å¹¶æ’åºæ˜¯å»ºç«‹åœ¨å½’å¹¶æ“ä½œä¸Šçš„ä¸€ç§æœ‰æ•ˆçš„æ’åºç®—æ³•ã€‚è¯¥ç®—æ³•æ˜¯é‡‡ç”¨åˆ†æ²»æ³•ï¼ˆDivide and Conquerï¼‰çš„ä¸€ä¸ªéå¸¸å…¸å‹çš„åº”ç”¨ã€‚å°†å·²æœ‰åºçš„å­åºåˆ—åˆå¹¶ï¼Œå¾—åˆ°å®Œå…¨æœ‰åºçš„åºåˆ—ï¼›å³å…ˆä½¿æ¯ä¸ªå­åºåˆ—æœ‰åºï¼Œå†ä½¿å­åºåˆ—æ®µé—´æœ‰åºã€‚è‹¥å°†ä¸¤ä¸ªæœ‰åºè¡¨åˆå¹¶æˆä¸€ä¸ªæœ‰åºè¡¨ï¼Œç§°ä¸º <strong>2-è·¯å½’å¹¶</strong>ã€‚</p><h3 id="5-1-ç®—æ³•æè¿°"><a href="#5-1-ç®—æ³•æè¿°" class="headerlink" title="5.1 ç®—æ³•æè¿°"></a>5.1 ç®—æ³•æè¿°</h3><ul><li>æŠŠé•¿åº¦ä¸º <code>n</code> çš„è¾“å…¥åºåˆ—åˆ†æˆä¸¤ä¸ªé•¿åº¦ä¸º <code>n/2</code> çš„å­åºåˆ—ï¼›</li><li>å¯¹è¿™ä¸¤ä¸ªå­åºåˆ—åˆ†åˆ«é‡‡ç”¨å½’å¹¶æ’åºï¼›</li><li>å°†ä¸¤ä¸ªæ’åºå¥½çš„å­åºåˆ—åˆå¹¶æˆä¸€ä¸ªæœ€ç»ˆçš„æ’åºåºåˆ—ã€‚</li></ul><h3 id="5-2-åŠ¨å›¾æ¼”ç¤º"><a href="#5-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="5.2 åŠ¨å›¾æ¼”ç¤º"></a>5.2 åŠ¨å›¾æ¼”ç¤º</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015230557043-37375010.gif" alt="mergesort"></p><h3 id="5-3-ä»£ç å®ç°"><a href="#5-3-ä»£ç å®ç°" class="headerlink" title="5.3 ä»£ç å®ç°"></a>5.3 ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å¯¹å¤–æä¾›çš„æ¥å£åªä¼ å…¥æ•°ç»„ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mergeSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> len = arr.size();</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">2</span>)</span><br><span class="line">        mergeSortSplit(arr, <span class="number">0</span>, len<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‹†åˆ†æ•°ç»„ï¼Œä¸èƒ½ç”¨é¢å¤–ç©ºé—´ï¼Œå°±åªæœ‰è®°å½•å·¦å³ä¸‹æ ‡ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mergeSortSplit</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">/* è¿˜å¯æ‹†åˆ†å°±ç»§ç»­åˆ† */</span></span><br><span class="line">    <span class="type">int</span> mid = l + (r-l)/<span class="number">2</span>; <span class="comment">/* or l + ((r-l)&gt;&gt;1); æ³¨æ„ &gt;&gt; ä¼˜å…ˆçº§ä½äº + */</span></span><br><span class="line">    mergeSortSplit(arr, l, mid);</span><br><span class="line">    mergeSortSplit(arr, mid+<span class="number">1</span>, r);</span><br><span class="line">    <span class="comment">/* åˆ°æ­¤å°±å¯ä»¥ä¿è¯ (l,mid), (mid+1,r) è¿™ä¸¤ä¸ªæ•°ç»„æ˜¯æœ‰åºçš„äº†ï¼Œ</span></span><br><span class="line"><span class="comment">     * ç°åœ¨è¦å°†è¿™ä¸¤ä¸ªæœ‰åºæ•°ç»„åˆå¹¶ä¸ºä¸€ä¸ªæœ‰åºæ•°ç»„ */</span></span><br><span class="line">    merge(arr, l, r, mid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„ (l,mid), (mid+1,r)</span></span><br><span class="line"><span class="comment"> * ä¸‹é¢æ˜¯å€ŸåŠ©ä¸€ä¸ªé¢å¤–æ•°ç»„çš„åˆå¹¶æ–¹æ³•ï¼Œä¸€èˆ¬éƒ½ç”¨æ­¤æ–¹æ³• */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">merge</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> mid)</span> &#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; <span class="title function_">tmp</span><span class="params">(r-l+<span class="number">1</span>)</span>;</span><br><span class="line">    <span class="type">int</span> i = l, j = mid+<span class="number">1</span>, t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= mid &amp;&amp; j &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt; arr[j]) &#123;</span><br><span class="line">            tmp[t++] = arr[i++];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp[t++] = arr[j++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= mid) tmp[t++] = arr[i++];</span><br><span class="line">    <span class="keyword">while</span>(j &lt;= r) tmp[t++] = arr[j++];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = l; i &lt;= r; i++) &#123;</span><br><span class="line">        arr[i] = tmp[i-l];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**********************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„ (l,mid), (mid+1,r)</span></span><br><span class="line"><span class="comment"> * ä¸‹é¢æ˜¯åŸåœ°åˆå¹¶æ–¹æ³•ï¼Œä¸è¿‡æ—¶é—´å¤æ‚åº¦è¾ƒé«˜ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">merge</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp; arr, <span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> mid)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = l;</span><br><span class="line">    <span class="type">int</span> j = mid + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt;= mid &amp;&amp; j &lt;= r) &#123;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒä¸¤ä¸ªæ•°ç»„çš„å½“å‰å…ƒç´ ï¼Œå°†è¾ƒå°çš„åŠ å…¥ç»“æœæ•°ç»„</span></span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt; arr[j]) &#123;</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> temp = arr[j]; <span class="comment">// ä¿å­˜ç¬¬äºŒä¸ªæ•°ç»„çš„å½“å‰å…ƒç´ </span></span><br><span class="line">            <span class="comment">// å°†ç¬¬ä¸€ä¸ªæ•°ç»„ä¸­ i åˆ° j-1 çš„æ‰€æœ‰å…ƒç´ å‘åç§»åŠ¨ä¸€ä½</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> k = j<span class="number">-1</span>; k &gt;= i; k--) &#123;</span><br><span class="line">                arr[k+<span class="number">1</span>] = arr[k];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†ç¬¬äºŒä¸ªæ•°ç»„çš„å½“å‰å…ƒç´ æ’å…¥åˆ°ç¬¬ä¸€ä¸ªæ•°ç»„çš„å½“å‰ä½ç½®</span></span><br><span class="line">            arr[i] = temp;</span><br><span class="line">            <span class="comment">// æ›´æ–°æŒ‡é’ˆä½ç½®</span></span><br><span class="line">            i++;</span><br><span class="line">            mid++;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5-4-ç®—æ³•åˆ†æ"><a href="#5-4-ç®—æ³•åˆ†æ" class="headerlink" title="5.4 ç®—æ³•åˆ†æ"></a>5.4 ç®—æ³•åˆ†æ</h3><p>å½’å¹¶æ’åºæ˜¯ä¸€ç§ç¨³å®šçš„æ’åºæ–¹æ³•ã€‚å’Œé€‰æ‹©æ’åºä¸€æ ·ï¼Œå½’å¹¶æ’åºçš„æ€§èƒ½ä¸å—è¾“å…¥æ•°æ®çš„å½±å“ï¼Œä½†è¡¨ç°æ¯”é€‰æ‹©æ’åºå¥½çš„å¤šï¼Œå› ä¸ºå§‹ç»ˆéƒ½æ˜¯ O(nlognï¼‰çš„æ—¶é—´å¤æ‚åº¦ã€‚ä»£ä»·æ˜¯éœ€è¦é¢å¤–çš„å†…å­˜ç©ºé—´ã€‚</p><p>åœ¨é€’å½’è¿‡ç¨‹ä¸­ï¼Œæ¯å±‚é€’å½’éƒ½éœ€è¦ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶æ•°ç»„æ¥å­˜å‚¨åˆå¹¶çš„ç»“æœã€‚ä½†æ˜¯ï¼Œå½’å¹¶æ’åºçš„é€’å½’æ·±åº¦æœ€å¤šæ˜¯ <code>logn</code> å±‚ï¼Œå› æ­¤ä½¿ç”¨çš„ä¸´æ—¶æ•°ç»„çš„æ€»æ•°ä¹Ÿæ˜¯ <code>logn</code> ä¸ªã€‚æ‰€ä»¥ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯ <code>O(nlogn)</code>ã€‚ä½†æ˜¯ï¼Œç”±äºå¸¸æ•°è¾ƒå°ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­ç©ºé—´å¤æ‚åº¦é€šå¸¸è¢«è®¤ä¸ºæ˜¯ <code>O(n)</code>ã€‚</p><h2 id="6ã€å¿«é€Ÿæ’åºï¼ˆQuick-Sortï¼‰"><a href="#6ã€å¿«é€Ÿæ’åºï¼ˆQuick-Sortï¼‰" class="headerlink" title="6ã€å¿«é€Ÿæ’åºï¼ˆQuick Sortï¼‰"></a>6ã€å¿«é€Ÿæ’åºï¼ˆQuick Sortï¼‰</h2><p>å¿«é€Ÿæ’åºçš„åŸºæœ¬æ€æƒ³ï¼šé€šè¿‡ä¸€è¶Ÿæ’åºå°†å¾…æ’è®°å½•åˆ†éš”æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†è®°å½•çš„å…³é”®å­—å‡æ¯”å¦ä¸€éƒ¨åˆ†çš„å…³é”®å­—å°ï¼Œåˆ™å¯åˆ†åˆ«å¯¹è¿™ä¸¤éƒ¨åˆ†è®°å½•ç»§ç»­è¿›è¡Œæ’åºï¼Œä»¥è¾¾åˆ°æ•´ä¸ªåºåˆ—æœ‰åºã€‚</p><blockquote><p>core: é€‰æ‹©åŸºå‡†ï¼Œè°ƒæ•´æ•°ç»„ä½¿å¾—æ¯”åŸºå‡†å€¼å°çš„æ‘†æ”¾åœ¨åŸºå‡†å‰é¢ï¼Œæ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢ã€‚åœ¨é€’å½’å¤„ç†å­æ•°ç»„ã€‚</p></blockquote><h3 id="6-1-ç®—æ³•æè¿°"><a href="#6-1-ç®—æ³•æè¿°" class="headerlink" title="6.1 ç®—æ³•æè¿°"></a>6.1 ç®—æ³•æè¿°</h3><p>å¿«é€Ÿæ’åºä½¿ç”¨åˆ†æ²»æ³•æ¥æŠŠä¸€ä¸ªä¸²ï¼ˆlistï¼‰åˆ†ä¸ºä¸¤ä¸ªå­ä¸²ï¼ˆsub-listsï¼‰ã€‚å…·ä½“ç®—æ³•æè¿°å¦‚ä¸‹ï¼š</p><ul><li>ä»æ•°åˆ—ä¸­æŒ‘å‡ºä¸€ä¸ªå…ƒç´ ï¼Œç§°ä¸º â€œåŸºå‡†â€ï¼ˆ<code>pivot</code>ï¼‰ï¼›</li><li>é‡æ–°æ’åºæ•°åˆ—ï¼Œ<strong>æ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å°çš„æ‘†æ”¾åœ¨åŸºå‡†å‰é¢</strong>ï¼Œ<strong>æ‰€æœ‰å…ƒç´ æ¯”åŸºå‡†å€¼å¤§çš„æ‘†åœ¨åŸºå‡†çš„åé¢</strong>ï¼ˆç›¸åŒçš„æ•°å¯ä»¥åˆ°ä»»ä¸€è¾¹ï¼‰ã€‚åœ¨è¿™ä¸ªåˆ†åŒºé€€å‡ºä¹‹åï¼Œè¯¥åŸºå‡†å°±å¤„äºæ•°åˆ—çš„ä¸­é—´ä½ç½®ã€‚è¿™ä¸ªç§°ä¸ºåˆ†åŒºï¼ˆ<code>partition</code>ï¼‰æ“ä½œï¼›</li><li>é€’å½’åœ°ï¼ˆ<code>recursive</code>ï¼‰æŠŠå°äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—å’Œå¤§äºåŸºå‡†å€¼å…ƒç´ çš„å­æ•°åˆ—æ’åºã€‚</li></ul><h3 id="6-2-åŠ¨å›¾æ¼”ç¤º"><a href="#6-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="6.2 åŠ¨å›¾æ¼”ç¤º"></a>6.2 åŠ¨å›¾æ¼”ç¤º</h3><blockquote><p><a href="https://visualgo.net/zh/sorting">å¦‚æœè§‰å¾—å¤ªå¿«ï¼Œå¯åœ¨è¯¥ç½‘é¡µé€æ­¥æŸ¥çœ‹è¿‡ç¨‹</a></p></blockquote><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015230936371-1413523412.gif" alt="quicksort"></p><h3 id="6-3-ä»£ç å®ç°"><a href="#6-3-ä»£ç å®ç°" class="headerlink" title="6.3 ä»£ç å®ç°"></a>6.3 ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">quickSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> mid = partition(arr, l, r);</span><br><span class="line">    quickSort(arr, l, mid<span class="number">-1</span>);</span><br><span class="line">    quickSort(arr, mid+<span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åŠ¨å›¾ä¸­çš„ç®—æ³•ï¼Œå¦‚æœä¸ç†è§£å¯ä»¥ç‚¹å¼€é‚£ä¸ªå¯è§†åŒ–çš„ç½‘é¡µï¼Œå¯ä»¥é€æ­¥æŸ¥çœ‹ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">partition</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r)</span> &#123;</span><br><span class="line">    <span class="type">int</span> pivot = arr[l];</span><br><span class="line">    <span class="type">int</span> bigIdx = l+<span class="number">1</span>; <span class="comment">/* è®°å½•ç¬¬ä¸€ä¸ªå¤§äºpivotçš„å€¼çš„ä¸‹æ ‡, -1è¡¨ç¤ºä¸å­˜åœ¨ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ‰¾åˆ°pivotå³è¾¹ç¬¬ä¸€ä¸ªå¤§äºpivotçš„ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="keyword">while</span>(bigIdx &lt;= r &amp;&amp; arr[bigIdx] &lt;= pivot) bigIdx++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦‚æœpivotå³è¾¹ä¸å­˜åœ¨å¤§äºpivotçš„æ•°ï¼Œè¯¥å¾ªç¯ä¸ä¼šè¿›è¡Œï¼ŒbigIdxä¸ºr+1 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = bigIdx+<span class="number">1</span>; i &lt;= r; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt;= pivot) &#123;</span><br><span class="line">            swap(arr[i], arr[bigIdx]);</span><br><span class="line">            bigIdx++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ— è®ºpivotå³è¾¹æ˜¯å¦å­˜åœ¨å¤§äºpivotçš„æ•°ï¼ŒbigIdx-1éƒ½æ˜¯åˆæ³•çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">     * å¦‚æœå­˜åœ¨ï¼Œå°±å°†æœ€åä¸€ä¸ªå°äºç­‰äºpivotçš„æ•°å’Œpivotäº¤æ¢</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸å­˜åœ¨ï¼Œå°±å°†æ•°ç»„æœ€åä¸€ä¸ªæ•°ï¼ˆä¹Ÿæ˜¯æœ€åä¸€ä¸ªå°äºç­‰äºpivotçš„æ•°ï¼‰å’Œpivotäº¤æ¢ */</span></span><br><span class="line">    swap(arr[bigIdx<span class="number">-1</span>], arr[l]);</span><br><span class="line">    <span class="keyword">return</span> bigIdx<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ³¨æ„ï¼šæ­¤å¤„çš„å®ç°ä¸åŠ¨å›¾ä¸­ä¸ä¸€æ ·ï¼</span></span><br><span class="line"><span class="comment"> * ä»¥arr[start]ä¸ºåŸºå‡†pivotï¼Œå®ç°arrä¸­å·¦è¾¹çš„æ•°éƒ½å°äºpivot,</span></span><br><span class="line"><span class="comment"> * arrå³è¾¹çš„æ•°éƒ½å¤§äºpivotï¼Œè¿”å›pivotçš„ä¸‹æ ‡ã€‚</span></span><br><span class="line"><span class="comment"> * åç»­å†å¯¹ pivot çš„å·¦å³æ•°ç»„åˆ†åˆ«æ’åº */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">partition</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> start, <span class="type">int</span> end)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> l = start, r = end, pivot = arr[start];</span><br><span class="line">    <span class="keyword">while</span> (l &lt; r) &#123;</span><br><span class="line">        <span class="keyword">while</span>(l &lt; r &amp;&amp; pivot &lt;= arr[r]) r--; <span class="comment">// ä»å³å‘å·¦æ‰¾åˆ°ç¬¬ä¸€ä¸ªå°äºåŸºå‡†æ•°çš„æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (l &lt; r) &#123;</span><br><span class="line">            arr[l++] = arr[r];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(l &lt; r &amp;&amp; pivot &gt;= arr[l]) l++; <span class="comment">// ä»å·¦å‘å³æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºåŸºå‡†æ•°çš„æ•°</span></span><br><span class="line">        <span class="keyword">if</span> (l &lt; r) &#123;</span><br><span class="line">            arr[r--] = arr[l];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    arr[l] = pivot;</span><br><span class="line">    <span class="keyword">return</span> l;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="7ã€å †æ’åºï¼ˆHeap-Sortï¼‰"><a href="#7ã€å †æ’åºï¼ˆHeap-Sortï¼‰" class="headerlink" title="7ã€å †æ’åºï¼ˆHeap Sortï¼‰"></a>7ã€å †æ’åºï¼ˆHeap Sortï¼‰</h2><p>å †æ’åºï¼ˆHeapsortï¼‰æ˜¯æŒ‡åˆ©ç”¨å †è¿™ç§æ•°æ®ç»“æ„æ‰€è®¾è®¡çš„ä¸€ç§æ’åºç®—æ³•ã€‚å †ç§¯æ˜¯ä¸€ä¸ªè¿‘ä¼¼å®Œå…¨äºŒå‰æ ‘çš„ç»“æ„ï¼Œå¹¶åŒæ—¶æ»¡è¶³å †ç§¯çš„æ€§è´¨ï¼šå³å­ç»“ç‚¹çš„é”®å€¼æˆ–ç´¢å¼•æ€»æ˜¯å°äºï¼ˆæˆ–è€…å¤§äºï¼‰å®ƒçš„çˆ¶èŠ‚ç‚¹ã€‚</p><h3 id="7-1-ç®—æ³•æè¿°"><a href="#7-1-ç®—æ³•æè¿°" class="headerlink" title="7.1 ç®—æ³•æè¿°"></a>7.1 ç®—æ³•æè¿°</h3><ul><li>å°†åˆå§‹å¾…æ’åºå…³é”®å­—åºåˆ— (<code>R1,R2...Rn</code>) æ„<strong>å»ºæˆå¤§é¡¶å †</strong>ï¼Œæ­¤å †ä¸ºåˆå§‹çš„æ— åºåŒºï¼›</li><li>å°†å †é¡¶å…ƒç´  <code>R[1]</code>ä¸æœ€åä¸€ä¸ªå…ƒç´  <code>R[n]</code>äº¤æ¢ï¼Œæ­¤æ—¶å¾—åˆ°æ–°çš„æ— åºåŒº (<code>R1,R2,â€¦â€¦Rn-1</code>) å’Œæ–°çš„æœ‰åºåŒº(<code>Rn</code>), ä¸”æ»¡è¶³ <code>R[1,2â€¦n-1]&lt;=R[n]</code>ï¼›</li><li>ç”±äºäº¤æ¢åæ–°çš„å †é¡¶ <code>R[1]</code>å¯èƒ½è¿åå †çš„æ€§è´¨ï¼Œå› æ­¤éœ€è¦å¯¹å½“å‰æ— åºåŒº (<code>R1,R2,â€¦â€¦Rn-1</code>) è°ƒæ•´ä¸ºæ–°å †ï¼Œç„¶åå†æ¬¡å°† <code>R[1]</code>ä¸æ— åºåŒºæœ€åä¸€ä¸ªå…ƒç´ äº¤æ¢ï¼Œå¾—åˆ°æ–°çš„æ— åºåŒº (<code>R1,R2â€¦.Rn-2</code>) å’Œæ–°çš„æœ‰åºåŒº(<code>Rn-1,Rn</code>)ã€‚ä¸æ–­é‡å¤æ­¤è¿‡ç¨‹ç›´åˆ°æœ‰åºåŒºçš„å…ƒç´ ä¸ªæ•°ä¸º <code>n-1</code>ï¼Œåˆ™æ•´ä¸ªæ’åºè¿‡ç¨‹å®Œæˆã€‚</li></ul><h3 id="7-2-åŠ¨å›¾æ¼”ç¤º"><a href="#7-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="7.2 åŠ¨å›¾æ¼”ç¤º"></a>7.2 åŠ¨å›¾æ¼”ç¤º</h3><blockquote><p><a href="https://www.cs.usfca.edu/~galles/visualization/HeapSort.html">å †æ’åºåœ¨çº¿æ¼”ç¤º</a></p></blockquote><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015231308699-356134237.gif" alt="heapsort"></p><h3 id="7-3-ä»£ç å®ç°"><a href="#7-3-ä»£ç å®ç°" class="headerlink" title="7.3 ä»£ç å®ç°"></a>7.3 ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ•°ç»„æœ¬èº«å°±å¯ä»¥è¡¨ç¤ºå †ï¼ˆå®Œå…¨äºŒå‰æ ‘ï¼‰ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">heapSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> n = arr.size();</span><br><span class="line">    <span class="comment">/* æ„å»ºå¤§é¡¶å † */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* ä»ç¬¬ä¸€ä¸ªéå¶å­ç»“ç‚¹ä»ä¸‹è‡³ä¸Šï¼Œä»å³è‡³å·¦è°ƒæ•´ç»“æ„ */</span></span><br><span class="line">        adjustHeap(arr, i, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†å †é¡¶å…ƒç´ ä¸æœ«å°¾å…ƒç´ äº¤æ¢ï¼Œå°†æœ€å¤§å…ƒç´ &quot;æ²‰&quot;åˆ°æ•°ç»„æœ«ç«¯ */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        swap(arr[<span class="number">0</span>], arr[i]);</span><br><span class="line">        <span class="comment">/* é‡æ–°å¯¹å †è¿›è¡Œè°ƒæ•´ */</span></span><br><span class="line">        adjustHeap(arr, <span class="number">0</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">adjustHeap</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> i, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="type">int</span> child;</span><br><span class="line">    <span class="type">int</span> temp;</span><br><span class="line">    <span class="keyword">for</span> (temp = arr[i]; <span class="number">2</span> * i + <span class="number">1</span> &lt; n; i = child) &#123;</span><br><span class="line">        child = <span class="number">2</span> * i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰å³å­©å­ï¼Œä¸”å³å­©å­å¤§äºå·¦å­©å­</span></span><br><span class="line">        <span class="keyword">if</span> (child + <span class="number">1</span> &lt; n &amp;&amp; arr[child] &lt; arr[child + <span class="number">1</span>]) &#123;</span><br><span class="line">            child++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœçˆ¶èŠ‚ç‚¹å¤§äºä»»ä½•ä¸€ä¸ªå­©å­çš„å€¼ï¼Œåˆ™ç›´æ¥è·³å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (temp &gt;= arr[child]) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠè¾ƒå¤§çš„å­©å­å¾€ä¸Šç§»åŠ¨ï¼Œæ›¿æ¢å®ƒçš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        arr[i] = arr[child];</span><br><span class="line">    &#125;</span><br><span class="line">    arr[i] = temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8ã€è®¡æ•°æ’åºï¼ˆCounting-Sortï¼‰"><a href="#8ã€è®¡æ•°æ’åºï¼ˆCounting-Sortï¼‰" class="headerlink" title="8ã€è®¡æ•°æ’åºï¼ˆCounting Sortï¼‰"></a>8ã€è®¡æ•°æ’åºï¼ˆCounting Sortï¼‰</h2><p>è®¡æ•°æ’åºä¸æ˜¯åŸºäºæ¯”è¾ƒçš„æ’åºç®—æ³•ï¼Œå…¶æ ¸å¿ƒåœ¨äºå°†è¾“å…¥çš„æ•°æ®å€¼è½¬åŒ–ä¸ºé”®å­˜å‚¨åœ¨é¢å¤–å¼€è¾Ÿçš„æ•°ç»„ç©ºé—´ä¸­ã€‚ ä½œä¸ºä¸€ç§çº¿æ€§æ—¶é—´å¤æ‚åº¦çš„æ’åºï¼Œè®¡æ•°æ’åºè¦æ±‚è¾“å…¥çš„æ•°æ®å¿…é¡»æ˜¯æœ‰ç¡®å®šèŒƒå›´çš„æ•´æ•°ã€‚</p><h3 id="8-1-ç®—æ³•æè¿°"><a href="#8-1-ç®—æ³•æè¿°" class="headerlink" title="8.1 ç®—æ³•æè¿°"></a>8.1 ç®—æ³•æè¿°</h3><ul><li>æ‰¾å‡ºå¾…æ’åºçš„æ•°ç»„ä¸­æœ€å¤§å’Œæœ€å°çš„å…ƒç´ ï¼›</li><li>ç»Ÿè®¡æ•°ç»„ä¸­æ¯ä¸ªå€¼ä¸º i çš„å…ƒç´ å‡ºç°çš„æ¬¡æ•°ï¼Œå­˜å…¥æ•°ç»„ C çš„ç¬¬ i é¡¹ï¼›</li><li>å¯¹æ‰€æœ‰çš„è®¡æ•°ç´¯åŠ ï¼ˆä» C ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ å¼€å§‹ï¼Œæ¯ä¸€é¡¹å’Œå‰ä¸€é¡¹ç›¸åŠ ï¼‰ï¼›</li><li>åå‘å¡«å……ç›®æ ‡æ•°ç»„ï¼šå°†æ¯ä¸ªå…ƒç´  i æ”¾åœ¨æ–°æ•°ç»„çš„ç¬¬ C(i) é¡¹ï¼Œæ¯æ”¾ä¸€ä¸ªå…ƒç´ å°±å°† C(i) å‡å» 1ã€‚</li></ul><h3 id="8-2-åŠ¨å›¾æ¼”ç¤º"><a href="#8-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="8.2 åŠ¨å›¾æ¼”ç¤º"></a>8.2 åŠ¨å›¾æ¼”ç¤º</h3><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015231740840-6968181.gif" alt="counting sort"></p><h3 id="8-3-ä»£ç å®ç°"><a href="#8-3-ä»£ç å®ç°" class="headerlink" title="8.3 ä»£ç å®ç°"></a>8.3 ä»£ç å®ç°</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">countingSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> maxValue)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">count</span><span class="params">(maxValue+<span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="comment">/* è®¡æ•° */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++)</span><br><span class="line">        count[arr[i]]++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é‡å»º */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= maxValue; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span>(count[i]--)</span><br><span class="line">            arr[t++] = i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="8-4-ç®—æ³•åˆ†æ"><a href="#8-4-ç®—æ³•åˆ†æ" class="headerlink" title="8.4 ç®—æ³•åˆ†æ"></a>8.4 ç®—æ³•åˆ†æ</h3><p>è®¡æ•°æ’åºæ˜¯ä¸€ä¸ªç¨³å®šçš„æ’åºç®—æ³•ã€‚å½“è¾“å…¥çš„å…ƒç´ æ˜¯ n ä¸ª 0 åˆ° k ä¹‹é—´çš„æ•´æ•°æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n+k)ï¼Œç©ºé—´å¤æ‚åº¦ä¹Ÿæ˜¯ O(n+k)ï¼Œå…¶æ’åºé€Ÿåº¦å¿«äºä»»ä½•æ¯”è¾ƒæ’åºç®—æ³•ã€‚å½“ k ä¸æ˜¯å¾ˆå¤§å¹¶ä¸”åºåˆ—æ¯”è¾ƒé›†ä¸­æ—¶ï¼Œè®¡æ•°æ’åºæ˜¯ä¸€ä¸ªå¾ˆæœ‰æ•ˆçš„æ’åºç®—æ³•ã€‚</p><h2 id="9ã€æ¡¶æ’åºï¼ˆBucket-Sortï¼‰"><a href="#9ã€æ¡¶æ’åºï¼ˆBucket-Sortï¼‰" class="headerlink" title="9ã€æ¡¶æ’åºï¼ˆBucket Sortï¼‰"></a>9ã€æ¡¶æ’åºï¼ˆBucket Sortï¼‰</h2><p>æ¡¶æ’åºæ˜¯è®¡æ•°æ’åºçš„å‡çº§ç‰ˆã€‚å®ƒåˆ©ç”¨äº†å‡½æ•°çš„æ˜ å°„å…³ç³»ï¼Œé«˜<strong>æ•ˆä¸å¦çš„å…³é”®å°±åœ¨äºè¿™ä¸ªæ˜ å°„å‡½æ•°çš„ç¡®å®š</strong>ã€‚æ¡¶æ’åº (Bucket sort) çš„å·¥ä½œçš„åŸç†ï¼šå‡è®¾è¾“å…¥æ•°æ®æœä»å‡åŒ€åˆ†å¸ƒï¼Œå°†æ•°æ®åˆ†åˆ°æœ‰é™æ•°é‡çš„æ¡¶é‡Œï¼Œæ¯ä¸ªæ¡¶å†åˆ†åˆ«æ’åºï¼ˆæœ‰å¯èƒ½å†ä½¿ç”¨åˆ«çš„æ’åºç®—æ³•æˆ–æ˜¯ä»¥é€’å½’æ–¹å¼ç»§ç»­ä½¿ç”¨æ¡¶æ’åºè¿›è¡Œæ’ï¼‰ã€‚</p><p><strong>æ¡¶æ’åºæœ€é‡è¦çš„åŸåˆ™ï¼šå°†æ•°æ®åˆ†åˆ°æ¡¶çš„è¿‡ç¨‹ä¸­ï¼Œ<code>æ˜ å°„å‡½æ•°</code>ï¼Œå¿…é¡»ä¿è¯ ç¬¬<code>i-1</code>ä¸ªæ¡¶ä¸­çš„æ•° &lt; ç¬¬ <code>i</code> ä¸ªæ¡¶ä¸­çš„æ•° &lt; ç¬¬ <code>i+1</code> ä¸ªæ¡¶ä¸­çš„æ•°</strong>ï¼Œè¿™æ ·æ‰èƒ½ä½¿åˆå¹¶è¿‡ç¨‹æ›´åŠ é«˜æ•ˆã€‚æ¯”å¦‚ä½¿ç”¨æ˜ å°„å‡½æ•°ï¼š<code>int bucketIndex = (int)(nums[i] * bucketNum / (maxNum - minNum + 1));</code></p><h3 id="9-1-ç®—æ³•æè¿°"><a href="#9-1-ç®—æ³•æè¿°" class="headerlink" title="9.1 ç®—æ³•æè¿°"></a>9.1 ç®—æ³•æè¿°</h3><ul><li>è®¾ç½®ä¸€ä¸ªå®šé‡çš„æ•°ç»„å½“ä½œç©ºæ¡¶ï¼›</li><li>éå†è¾“å…¥æ•°æ®ï¼Œå¹¶ä¸”æŠŠæ•°æ®ä¸€ä¸ªä¸€ä¸ªæ”¾åˆ°å¯¹åº”çš„æ¡¶é‡Œå»ï¼›</li><li>å¯¹æ¯ä¸ªä¸æ˜¯ç©ºçš„æ¡¶è¿›è¡Œæ’åºï¼›</li><li>ä»ä¸æ˜¯ç©ºçš„æ¡¶é‡ŒæŠŠæ’å¥½åºçš„æ•°æ®æ‹¼æ¥èµ·æ¥ã€‚</li></ul><h3 id="9-2-å›¾ç‰‡æ¼”ç¤º"><a href="#9-2-å›¾ç‰‡æ¼”ç¤º" class="headerlink" title="9.2 å›¾ç‰‡æ¼”ç¤º"></a>9.2 å›¾ç‰‡æ¼”ç¤º</h3><blockquote><p><a href="https://www.cs.usfca.edu/~galles/visualization/BucketSort.html">åŠ¨æ€æ¼”ç¤ºçš„ç½‘é¡µ</a></p></blockquote><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015232107090-1920702011.png" alt="bucketsort"></p><h3 id="9-3-ä»£ç å®ç°"><a href="#9-3-ä»£ç å®ç°" class="headerlink" title="9.3 ä»£ç å®ç°"></a>9.3 ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">bucketSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> bucketNum = <span class="number">10</span>; <span class="comment">/* æ¡¶çš„æ•°é‡ */</span></span><br><span class="line">    <span class="type">int</span> bucketIndex;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;&gt; bucket(bucketNum, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–æ•°ç»„çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ */</span></span><br><span class="line">    <span class="type">int</span> maxNum = arr[<span class="number">0</span>], minNum = arr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; arr.size(); i++) &#123;</span><br><span class="line">        maxNum = max(maxNum, arr[i]);</span><br><span class="line">        minNum = min(minNum, arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†æ•°æ®æ˜ å°„åˆ°æ¡¶ä¸­ */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.size(); i++) &#123;</span><br><span class="line">        bucketIndex = (<span class="type">int</span>)(arr[i] * bucketNum / (maxNum - minNum + <span class="number">1</span>));</span><br><span class="line">        <span class="comment">/* è¿™é‡Œå¯èƒ½å‡ºç° bucketIndex == bucketNumï¼Œéœ€è¦ç‰¹æ®Šå¤„ç† */</span></span><br><span class="line">        <span class="keyword">if</span> (bucketIndex == bucketNum) --bucketIndex;</span><br><span class="line">        bucket[bucketIndex].emplace_back(arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¯¹æ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®æ’åºï¼Œå¯ä»¥é€‰ç”¨å¿«æ’ç­‰ï¼Œè¿™é‡Œä¸ºäº†ç®€æ´ç›´æ¥è°ƒç”¨sort */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        sort(bucket[i].begin(), bucket[i].end());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†å„ä¸ªæ¡¶ä¸­çš„æ•°æ®æŒ‰é¡ºåºå–å‡ºï¼Œå¾—åˆ°æ’åºåçš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * ä¹‹æ‰€ä»¥åˆå¹¶è¿‡ç¨‹ä¸éœ€è¦å†æ¬¡åˆ¤æ–­ï¼Œæ˜¯å› ä¸ºå‰é¢æ˜ å°„å‡½æ•°ä¿è¯äº†</span></span><br><span class="line"><span class="comment">     * ç¬¬ i-1 ä¸ªæ¡¶ä¸­çš„æ•° &lt; ç¬¬ i ä¸ªæ¡¶ä¸­çš„æ•° &lt; ç¬¬ i+1 ä¸ªæ¡¶ä¸­çš„æ•° */</span></span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> &amp; v : bucket[i])</span><br><span class="line">            arr[t++] = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="9-4-ç®—æ³•åˆ†æ"><a href="#9-4-ç®—æ³•åˆ†æ" class="headerlink" title="9.4 ç®—æ³•åˆ†æ"></a>9.4 ç®—æ³•åˆ†æ</h3><p>æ¡¶æ’åºæœ€å¥½æƒ…å†µä¸‹ä½¿ç”¨çº¿æ€§æ—¶é—´ <code>O(n)</code>ï¼Œæ¡¶æ’åºçš„æ—¶é—´å¤æ‚åº¦ï¼Œå–å†³ä¸å¯¹å„ä¸ªæ¡¶ä¹‹é—´æ•°æ®è¿›è¡Œæ’åºçš„æ—¶é—´å¤æ‚åº¦ï¼Œå› ä¸ºå…¶å®ƒéƒ¨åˆ†çš„æ—¶é—´å¤æ‚åº¦éƒ½ä¸º <code>O(n)</code>ã€‚å¾ˆæ˜¾ç„¶ï¼Œæ¡¶åˆ’åˆ†çš„è¶Šå°ï¼Œå„ä¸ªæ¡¶ä¹‹é—´çš„æ•°æ®è¶Šå°‘ï¼Œæ’åºæ‰€ç”¨çš„æ—¶é—´ä¹Ÿä¼šè¶Šå°‘ã€‚ä½†ç›¸åº”çš„ç©ºé—´æ¶ˆè€—å°±ä¼šå¢å¤§ã€‚</p><h2 id="10ã€åŸºæ•°æ’åºï¼ˆRadix-Sortï¼‰"><a href="#10ã€åŸºæ•°æ’åºï¼ˆRadix-Sortï¼‰" class="headerlink" title="10ã€åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰"></a>10ã€åŸºæ•°æ’åºï¼ˆRadix Sortï¼‰</h2><p>åŸºæ•°æ’åºæ˜¯æŒ‰ç…§ä½ä½å…ˆæ’åºï¼Œç„¶åæ”¶é›†ï¼›å†æŒ‰ç…§é«˜ä½æ’åºï¼Œç„¶åå†æ”¶é›†ï¼›ä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æœ€é«˜ä½ã€‚æœ‰æ—¶å€™æœ‰äº›å±æ€§æ˜¯æœ‰ä¼˜å…ˆçº§é¡ºåºçš„ï¼Œå…ˆæŒ‰ä½ä¼˜å…ˆçº§æ’åºï¼Œå†æŒ‰é«˜ä¼˜å…ˆçº§æ’åºã€‚æœ€åçš„æ¬¡åºå°±æ˜¯é«˜ä¼˜å…ˆçº§é«˜çš„åœ¨å‰ï¼Œé«˜ä¼˜å…ˆçº§ç›¸åŒçš„ä½ä¼˜å…ˆçº§é«˜çš„åœ¨å‰ã€‚</p><h3 id="10-1-ç®—æ³•æè¿°"><a href="#10-1-ç®—æ³•æè¿°" class="headerlink" title="10.1 ç®—æ³•æè¿°"></a>10.1 ç®—æ³•æè¿°</h3><ul><li>å–å¾—æ•°ç»„ä¸­çš„æœ€å¤§æ•°ï¼Œå¹¶å–å¾—ä½æ•°ï¼›</li><li><code>arr</code> ä¸ºåŸå§‹æ•°ç»„ï¼Œä»æœ€ä½ä½å¼€å§‹å–æ¯ä¸ªä½ç»„æˆ <code>radix</code> æ•°ç»„ï¼›</li><li>å¯¹ <code>radix</code> è¿›è¡Œè®¡æ•°æ’åºï¼ˆåˆ©ç”¨è®¡æ•°æ’åºé€‚ç”¨äºå°èŒƒå›´æ•°çš„ç‰¹ç‚¹ï¼‰ï¼›</li></ul><h3 id="10-2-åŠ¨å›¾æ¼”ç¤º"><a href="#10-2-åŠ¨å›¾æ¼”ç¤º" class="headerlink" title="10.2 åŠ¨å›¾æ¼”ç¤º"></a>10.2 åŠ¨å›¾æ¼”ç¤º</h3><blockquote><p>æ³¨æ„çœ‹ï¼Œé‡å»ºæ—¶ï¼Œé‡‡ç”¨çš„FIFOçš„æ–¹å¼</p></blockquote><p><img src="/../images/%E5%8D%81%E5%A4%A7%E7%BB%8F%E5%85%B8%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%EF%BC%88%E5%8A%A8%E5%9B%BE%E6%BC%94%E7%A4%BA%EF%BC%89/849589-20171015232453668-1397662527.gif" alt="radixsort"></p><h3 id="10-3-ä»£ç å®ç°"><a href="#10-3-ä»£ç å®ç°" class="headerlink" title="10.3 ä»£ç å®ç°"></a>10.3 ä»£ç å®ç°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">radixSort</span><span class="params">(<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt; &amp;arr)</span> &#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">1</span>; <span class="comment">/* ç”¨äºåˆ¤æ–­æ˜¯å¦ç»§ç»­æ¯”è¾ƒé«˜ä½ */</span></span><br><span class="line">    <span class="type">int</span> mod = <span class="number">10</span>, dev = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> len = arr.size();</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="built_in">queue</span>&lt;<span class="type">int</span>&gt;&gt; radix(<span class="number">10</span>, <span class="built_in">queue</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(count) &#123;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* æ”¾åˆ°æ¡¶ä¸­ */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            radix[(arr[i]%mod)/dev].push(arr[i]);</span><br><span class="line">            <span class="keyword">if</span> (arr[i]/mod &gt; <span class="number">0</span>)</span><br><span class="line">                ++count;</span><br><span class="line">        &#125;</span><br><span class="line">        mod *= <span class="number">10</span>;</span><br><span class="line">        dev *= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* é‡å»º arr */</span></span><br><span class="line">        <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span>(!radix[i].empty()) &#123;</span><br><span class="line">                arr[t++] = radix[i].front();</span><br><span class="line">                radix[i].pop();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="10-4-ç®—æ³•åˆ†æ"><a href="#10-4-ç®—æ³•åˆ†æ" class="headerlink" title="10.4 ç®—æ³•åˆ†æ"></a>10.4 ç®—æ³•åˆ†æ</h3><p>åŸºæ•°æ’åºåŸºäºåˆ†åˆ«æ’åºï¼Œåˆ†åˆ«æ”¶é›†ï¼Œæ‰€ä»¥æ˜¯ç¨³å®šçš„ã€‚ä½†åŸºæ•°æ’åºçš„æ€§èƒ½æ¯”æ¡¶æ’åºè¦ç•¥å·®ï¼Œæ¯ä¸€æ¬¡å…³é”®å­—çš„æ¡¶åˆ†é…éƒ½éœ€è¦ <code>O(n)</code> çš„æ—¶é—´å¤æ‚åº¦ï¼Œè€Œä¸”åˆ†é…ä¹‹åå¾—åˆ°æ–°çš„å…³é”®å­—åºåˆ—åˆéœ€è¦ <code>O(n)</code> çš„æ—¶é—´å¤æ‚åº¦ã€‚å‡å¦‚å¾…æ’æ•°æ®å¯ä»¥åˆ†ä¸º <code>d</code> ä¸ªå…³é”®å­—ï¼Œåˆ™åŸºæ•°æ’åºçš„æ—¶é—´å¤æ‚åº¦å°†æ˜¯ <code>O(d*2n)</code> ï¼Œå½“ç„¶ <code>d</code> è¦è¿œè¿œå°äº <code>n</code>ï¼Œå› æ­¤åŸºæœ¬ä¸Šè¿˜æ˜¯çº¿æ€§çº§åˆ«çš„ã€‚</p><p>åŸºæ•°æ’åºçš„ç©ºé—´å¤æ‚åº¦ä¸º <code>O(n+k)</code>ï¼Œå…¶ä¸­ <code>k</code> ä¸ºæ¡¶çš„æ•°é‡ã€‚ä¸€èˆ¬æ¥è¯´ <code>n&gt;&gt;k</code>ï¼Œå› æ­¤é¢å¤–ç©ºé—´éœ€è¦å¤§æ¦‚ <code>n</code> ä¸ªå·¦å³ã€‚</p><h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bubbleSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; len<span class="number">-1</span>-i; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &gt; arr[j+<span class="number">1</span>])</span><br><span class="line">                <span class="built_in">swap</span>(arr[j], arr[j+<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">selectionSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> minIdx;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len<span class="number">-1</span>; i++) &#123;</span><br><span class="line">        minIdx = i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = i+<span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (arr[j] &lt; arr[minIdx])</span><br><span class="line">                minIdx = j;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (minIdx != i)</span><br><span class="line">            <span class="built_in">swap</span>(arr[minIdx], arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertionSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> currVal, currIdx;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">        currIdx = i;</span><br><span class="line">        currVal = arr[i];</span><br><span class="line">        <span class="keyword">while</span>(currIdx &gt; <span class="number">0</span> &amp;&amp; currVal &lt; arr[currIdx<span class="number">-1</span>]) &#123;</span><br><span class="line">            arr[currIdx] = arr[currIdx<span class="number">-1</span>];</span><br><span class="line">            currIdx--;</span><br><span class="line">        &#125;</span><br><span class="line">        arr[currIdx] = currVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">shellSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">int</span> currVal, currIdx;</span><br><span class="line">    <span class="comment">/* gap å°±æ˜¯ä¸Šé¢çš„ t1, t2, ... , tkï¼Œä¹Ÿæ˜¯åŠ¨å›¾ä¸­ä¸¤ä¸ªç›¸åŒé¢œè‰²æ–¹æ¡†çš„é—´è· */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> gap = len/<span class="number">2</span>; gap &gt; <span class="number">0</span>; gap = gap/<span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">/* å¸Œå°”æ’åºæ˜¯åŸºäºæ’å…¥æ’åºï¼Œä¸‹é¢çš„è¿‡ç¨‹å’Œæ’å…¥æ’åºä¸€è‡´ï¼Œ</span></span><br><span class="line"><span class="comment">         * é€šè¿‡ gap å®ç°äº†åˆ†ç»„æ’å…¥æ’åº</span></span><br><span class="line"><span class="comment">         * è¿™é‡Œå’ŒåŠ¨å›¾æ¼”ç¤ºçš„ä¸ä¸€æ ·ï¼ŒåŠ¨å›¾æ˜¯åˆ†ç»„æ‰§è¡Œï¼Œå®é™…æ“ä½œæ˜¯å¤šä¸ªåˆ†ç»„äº¤æ›¿æ‰§è¡Œ */</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = gap; i &lt; len; i++) &#123;</span><br><span class="line">            currIdx = i;</span><br><span class="line">            currVal = arr[i];</span><br><span class="line">            <span class="keyword">while</span>(currIdx-gap &gt;= <span class="number">0</span> &amp;&amp; currVal &lt; arr[currIdx-gap]) &#123;</span><br><span class="line">                arr[currIdx] = arr[currIdx-gap];</span><br><span class="line">                currIdx -= gap;</span><br><span class="line">            &#125;</span><br><span class="line">            arr[currIdx] = currVal;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå¹¶ä¸¤ä¸ªæœ‰åºæ•°ç»„ (l,mid), (mid+1,r)</span></span><br><span class="line"><span class="comment"> * ä¸‹é¢æ˜¯å€ŸåŠ©ä¸€ä¸ªé¢å¤–æ•°ç»„çš„åˆå¹¶æ–¹æ³•ï¼Œä¸€èˆ¬éƒ½ç”¨æ­¤æ–¹æ³• */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">merge</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r, <span class="type">int</span> mid)</span> </span>&#123;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">tmp</span><span class="params">(r-l+<span class="number">1</span>)</span></span>;</span><br><span class="line">    <span class="type">int</span> i = l, j = mid+<span class="number">1</span>, t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= mid &amp;&amp; j &lt;= r) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt; arr[j]) &#123;</span><br><span class="line">            tmp[t++] = arr[i++];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            tmp[t++] = arr[j++];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(i &lt;= mid) tmp[t++] = arr[i++];</span><br><span class="line">    <span class="keyword">while</span>(j &lt;= r) tmp[t++] = arr[j++];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = l; i &lt;= r; i++) &#123;</span><br><span class="line">        arr[i] = tmp[i-l];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‹†åˆ†æ•°ç»„ï¼Œä¸èƒ½ç”¨é¢å¤–ç©ºé—´ï¼Œå°±åªæœ‰è®°å½•å·¦å³ä¸‹æ ‡ */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mergeSortSplit</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">/* è¿˜å¯æ‹†åˆ†å°±ç»§ç»­åˆ† */</span></span><br><span class="line">    <span class="type">int</span> mid = l + (r-l)/<span class="number">2</span>; <span class="comment">/* or l + ((r-l)&gt;&gt;1); æ³¨æ„ &gt;&gt; ä¼˜å…ˆçº§ä½äº + */</span></span><br><span class="line">    <span class="built_in">mergeSortSplit</span>(arr, l, mid);</span><br><span class="line">    <span class="built_in">mergeSortSplit</span>(arr, mid+<span class="number">1</span>, r);</span><br><span class="line">    <span class="comment">/* åˆ°æ­¤å°±å¯ä»¥ä¿è¯ (l,mid), (mid+1,r) è¿™ä¸¤ä¸ªæ•°ç»„æ˜¯æœ‰åºçš„äº†ï¼Œ</span></span><br><span class="line"><span class="comment">     * ç°åœ¨è¦å°†è¿™ä¸¤ä¸ªæœ‰åºæ•°ç»„åˆå¹¶ä¸ºä¸€ä¸ªæœ‰åºæ•°ç»„ */</span></span><br><span class="line">    <span class="built_in">merge</span>(arr, l, r, mid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¯¹å¤–æä¾›çš„æ¥å£åªä¼ å…¥æ•°ç»„ */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">mergeSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">2</span>)</span><br><span class="line">        <span class="built_in">mergeSortSplit</span>(arr, <span class="number">0</span>, len<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åŠ¨å›¾ä¸­çš„ç®—æ³•ï¼Œå¦‚æœä¸ç†è§£å¯ä»¥ç‚¹å¼€é‚£ä¸ªå¯è§†åŒ–çš„ç½‘é¡µï¼Œå¯ä»¥é€æ­¥æŸ¥çœ‹ */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">partition</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> pivot = arr[l];</span><br><span class="line">    <span class="type">int</span> bigIdx = l+<span class="number">1</span>; <span class="comment">/* è®°å½•ç¬¬ä¸€ä¸ªå¤§äºpivotçš„å€¼çš„ä¸‹æ ‡, -1è¡¨ç¤ºä¸å­˜åœ¨ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ‰¾åˆ°pivotå³è¾¹ç¬¬ä¸€ä¸ªå¤§äºpivotçš„ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="keyword">while</span>(bigIdx &lt;= r &amp;&amp; arr[bigIdx] &lt;= pivot) bigIdx++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦‚æœpivotå³è¾¹ä¸å­˜åœ¨å¤§äºpivotçš„æ•°ï¼Œè¯¥å¾ªç¯ä¸ä¼šè¿›è¡Œï¼ŒbigIdxä¸ºr+1 */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = bigIdx+<span class="number">1</span>; i &lt;= r; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (arr[i] &lt;= pivot) &#123;</span><br><span class="line">            <span class="built_in">swap</span>(arr[i], arr[bigIdx]);</span><br><span class="line">            bigIdx++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ— è®ºpivotå³è¾¹æ˜¯å¦å­˜åœ¨å¤§äºpivotçš„æ•°ï¼ŒbigIdx-1éƒ½æ˜¯åˆæ³•çš„ä¸‹æ ‡</span></span><br><span class="line"><span class="comment">     * å¦‚æœå­˜åœ¨ï¼Œå°±å°†æœ€åä¸€ä¸ªå°äºç­‰äºpivotçš„æ•°å’Œpivotäº¤æ¢</span></span><br><span class="line"><span class="comment">     * å¦‚æœä¸å­˜åœ¨ï¼Œå°±å°†æ•°ç»„æœ€åä¸€ä¸ªæ•°ï¼ˆä¹Ÿæ˜¯æœ€åä¸€ä¸ªå°äºç­‰äºpivotçš„æ•°ï¼‰å’Œpivotäº¤æ¢ */</span></span><br><span class="line">    <span class="built_in">swap</span>(arr[bigIdx<span class="number">-1</span>], arr[l]);</span><br><span class="line">    <span class="keyword">return</span> bigIdx<span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">quickSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> l, <span class="type">int</span> r)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (l &gt;= r) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> mid = <span class="built_in">partition</span>(arr, l, r);</span><br><span class="line">    <span class="built_in">quickSort</span>(arr, l, mid<span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">quickSort</span>(arr, mid+<span class="number">1</span>, r);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">adjustHeap</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> i, <span class="type">int</span> n)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> child;</span><br><span class="line">    <span class="type">int</span> temp;</span><br><span class="line">    <span class="keyword">for</span> (temp = arr[i]; <span class="number">2</span> * i + <span class="number">1</span> &lt; n; i = child) &#123;</span><br><span class="line">        child = <span class="number">2</span> * i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ‰å³å­©å­ï¼Œä¸”å³å­©å­å¤§äºå·¦å­©å­</span></span><br><span class="line">        <span class="keyword">if</span> (child + <span class="number">1</span> &lt; n &amp;&amp; arr[child] &lt; arr[child + <span class="number">1</span>]) &#123;</span><br><span class="line">            child++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœçˆ¶èŠ‚ç‚¹å¤§äºä»»ä½•ä¸€ä¸ªå­©å­çš„å€¼ï¼Œåˆ™ç›´æ¥è·³å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (temp &gt;= arr[child]) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠè¾ƒå¤§çš„å­©å­å¾€ä¸Šç§»åŠ¨ï¼Œæ›¿æ¢å®ƒçš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">        arr[i] = arr[child];</span><br><span class="line">    &#125;</span><br><span class="line">    arr[i] = temp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ•°ç»„æœ¬èº«å°±å¯ä»¥è¡¨ç¤ºå †ï¼ˆå®Œå…¨äºŒå‰æ ‘ï¼‰ */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">heapSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> n = arr.<span class="built_in">size</span>();</span><br><span class="line">    <span class="comment">/* æ„å»ºå¤§é¡¶å † */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n / <span class="number">2</span> - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">/* ä»ç¬¬ä¸€ä¸ªéå¶å­ç»“ç‚¹ä»ä¸‹è‡³ä¸Šï¼Œä»å³è‡³å·¦è°ƒæ•´ç»“æ„ */</span></span><br><span class="line">        <span class="built_in">adjustHeap</span>(arr, i, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†å †é¡¶å…ƒç´ ä¸æœ«å°¾å…ƒç´ äº¤æ¢ï¼Œå°†æœ€å¤§å…ƒç´ &quot;æ²‰&quot;åˆ°æ•°ç»„æœ«ç«¯ */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="built_in">swap</span>(arr[<span class="number">0</span>], arr[i]);</span><br><span class="line">        <span class="comment">/* é‡æ–°å¯¹å †è¿›è¡Œè°ƒæ•´ */</span></span><br><span class="line">        <span class="built_in">adjustHeap</span>(arr, <span class="number">0</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">countingSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr, <span class="type">int</span> maxValue)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">count</span><span class="params">(maxValue+<span class="number">1</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="comment">/* è®¡æ•° */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++)</span><br><span class="line">        count[arr[i]]++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é‡å»º */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= maxValue; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span>(count[i]--)</span><br><span class="line">            arr[t++] = i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bucketSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> bucketNum = <span class="number">10</span>; <span class="comment">/* æ¡¶çš„æ•°é‡ */</span></span><br><span class="line">    <span class="type">int</span> bucketIndex;</span><br><span class="line">    vector&lt;vector&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">bucket</span>(bucketNum, <span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è·å–æ•°ç»„çš„æœ€å¤§å€¼å’Œæœ€å°å€¼ */</span></span><br><span class="line">    <span class="type">int</span> maxNum = arr[<span class="number">0</span>], minNum = arr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        maxNum = <span class="built_in">max</span>(maxNum, arr[i]);</span><br><span class="line">        minNum = <span class="built_in">min</span>(minNum, arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†æ•°æ®æ˜ å°„åˆ°æ¡¶ä¸­ */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        bucketIndex = (<span class="type">int</span>)(arr[i] * bucketNum / (maxNum - minNum + <span class="number">1</span>));</span><br><span class="line">        <span class="comment">/* è¿™é‡Œå¯èƒ½å‡ºç° bucketIndex == bucketNumï¼Œéœ€è¦ç‰¹æ®Šå¤„ç† */</span></span><br><span class="line">        <span class="keyword">if</span> (bucketIndex == bucketNum) --bucketIndex;</span><br><span class="line">        bucket[bucketIndex].<span class="built_in">emplace_back</span>(arr[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¯¹æ¯ä¸ªæ¡¶ä¸­çš„æ•°æ®æ’åºï¼Œå¯ä»¥é€‰ç”¨å¿«æ’ç­‰ï¼Œè¿™é‡Œä¸ºäº†ç®€æ´ç›´æ¥è°ƒç”¨sort */</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        <span class="built_in">sort</span>(bucket[i].<span class="built_in">begin</span>(), bucket[i].<span class="built_in">end</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å°†å„ä¸ªæ¡¶ä¸­çš„æ•°æ®æŒ‰é¡ºåºå–å‡ºï¼Œå¾—åˆ°æ’åºåçš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     * ä¹‹æ‰€ä»¥åˆå¹¶è¿‡ç¨‹ä¸éœ€è¦å†æ¬¡åˆ¤æ–­ï¼Œæ˜¯å› ä¸ºå‰é¢æ˜ å°„å‡½æ•°ä¿è¯äº†</span></span><br><span class="line"><span class="comment">     * ç¬¬ i-1 ä¸ªæ¡¶ä¸­çš„æ•° &lt; ç¬¬ i ä¸ªæ¡¶ä¸­çš„æ•° &lt; ç¬¬ i+1 ä¸ªæ¡¶ä¸­çš„æ•° */</span></span><br><span class="line">    <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; bucketNum; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> &amp; v : bucket[i])</span><br><span class="line">            arr[t++] = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">radixSort</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">1</span>; <span class="comment">/* ç”¨äºåˆ¤æ–­æ˜¯å¦ç»§ç»­æ¯”è¾ƒé«˜ä½ */</span></span><br><span class="line">    <span class="type">int</span> mod = <span class="number">10</span>, dev = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> len = arr.<span class="built_in">size</span>();</span><br><span class="line">    vector&lt;queue&lt;<span class="type">int</span>&gt;&gt; <span class="built_in">radix</span>(<span class="number">10</span>, <span class="built_in">queue</span>&lt;<span class="type">int</span>&gt;());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(count) &#123;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* æ”¾åˆ°æ¡¶ä¸­ */</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            radix[(arr[i]%mod)/dev].<span class="built_in">push</span>(arr[i]);</span><br><span class="line">            <span class="keyword">if</span> (arr[i]/mod &gt; <span class="number">0</span>)</span><br><span class="line">                ++count;</span><br><span class="line">        &#125;</span><br><span class="line">        mod *= <span class="number">10</span>;</span><br><span class="line">        dev *= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* é‡å»º arr */</span></span><br><span class="line">        <span class="type">int</span> t = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">while</span>(!radix[i].<span class="built_in">empty</span>()) &#123;</span><br><span class="line">                arr[t++] = radix[i].<span class="built_in">front</span>();</span><br><span class="line">                radix[i].<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">printArray</span><span class="params">(vector&lt;<span class="type">int</span>&gt; &amp;arr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; arr.<span class="built_in">size</span>(); i++)</span><br><span class="line">        cout &lt;&lt; arr[i] &lt;&lt; <span class="string">&quot;, &quot;</span>;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    vector&lt;<span class="type">int</span>&gt; arr = &#123;<span class="number">1</span>,<span class="number">5</span>,<span class="number">67</span>,<span class="number">23</span>,<span class="number">9</span>,<span class="number">3</span>,<span class="number">34</span>,<span class="number">65</span>,<span class="number">23</span>,<span class="number">4</span>,<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bubbleSort(arr);</span></span><br><span class="line">    <span class="comment">// selectionSort(arr);</span></span><br><span class="line">    <span class="comment">// insertionSort(arr);</span></span><br><span class="line">    <span class="comment">// shellSort(arr);</span></span><br><span class="line">    <span class="comment">// mergeSort(arr);</span></span><br><span class="line">    <span class="comment">// quickSort(arr, 0, arr.size()-1);</span></span><br><span class="line">    <span class="comment">// heapSort(arr);</span></span><br><span class="line">    <span class="comment">// countingSort(arr, 67);</span></span><br><span class="line">    <span class="comment">// bucketSort(arr);</span></span><br><span class="line">    <span class="built_in">radixSort</span>(arr);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printArray</span>(arr);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Algorithm </tag>
            
            <tag> Sort </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVSwitch-æ•°æ®ç»“æ„</title>
      <link href="/2022/11/01/OpenVSwitch-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/"/>
      <url>/2022/11/01/OpenVSwitch-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      
        <content type="html"><![CDATA[<h2 id="å¸¸ç”¨å®"><a href="#å¸¸ç”¨å®" class="headerlink" title="å¸¸ç”¨å®"></a>å¸¸ç”¨å®</h2><blockquote><p>include&#x2F;openvswitch&#x2F;util.h #119</p></blockquote><h3 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h3><p>typeofä¸æ˜¯Cè¯­è¨€æœ¬èº«çš„å…³é”®è¯æˆ–è¿ç®—ç¬¦ï¼Œå®ƒæ˜¯GCCçš„ä¸€ä¸ªæ‰©å±•ï¼Œä½œç”¨æ­£å¦‚å…¶å­—é¢æ„æ€ï¼Œç”¨æŸç§å·²æœ‰ä¸œè¥¿ï¼ˆå˜é‡ã€å‡½æ•°ç­‰ï¼‰çš„ç±»å‹å»å®šä¹‰æ–°çš„å˜é‡ç±»å‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">typeof(<span class="type">int</span> *)a, b;     <span class="comment">// ç­‰ä»·äº int *a, *b;</span></span><br><span class="line">typeof(a) c;           <span class="comment">// ç­‰ä»·äº int *c</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVS_TYPEOF(OBJECT) typeof(OBJECT)</span></span><br></pre></td></tr></table></figure><h3 id="offsetof"><a href="#offsetof" class="headerlink" title="offsetof"></a>offsetof</h3><p>è·å–ç»“æ„ä½“<code>TYPE</code>ä¸­æŸä¸ªæˆå‘˜<code>MEMBER</code>çš„åç§»é‡ï¼ˆç›¸å¯¹äºç»“æ„ä½“åœ°å€ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* /usr/lib/gcc/x86_64-linux-gnu/9/include/stddef.h */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(TYPE, MEMBER) __builtin_offsetof (TYPE, MEMBER)</span></span><br><span class="line"><span class="comment">/* ç±»ä¼¼äº */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(TYPE, MEMBER)    ((size_t)&amp;((TYPE *)0)-&gt;MEMBER)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨æ–¹æ³• */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">        <span class="type">char</span> a[];</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Output is compiler dependent */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;offsets: i=%zd; c=%zd; d=%zd a=%zd\n&quot;</span>,</span><br><span class="line">            offsetof(<span class="keyword">struct</span> s, i), offsetof(<span class="keyword">struct</span> s, c),</span><br><span class="line">            offsetof(<span class="keyword">struct</span> s, d), offsetof(<span class="keyword">struct</span> s, a));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(struct s)=%zd\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> s));</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="OBJECT-OFFSETOF"><a href="#OBJECT-OFFSETOF" class="headerlink" title="OBJECT_OFFSETOF"></a>OBJECT_OFFSETOF</h3><p>ç»™å®šä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆ<code>OBJECT</code>ï¼Œè¿”å›å…¶æˆå‘˜<code>MEMBER</code>çš„åç§»é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OBJECT_OFFSETOF(OBJECT, MEMBER) offsetof(typeof(*(OBJECT)), MEMBER)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨æ–¹æ³• */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJECT_OFFSETOF(OBJECT, MEMBER) offsetof(typeof(*(OBJECT)), MEMBER)</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">        <span class="type">char</span> a[];</span><br><span class="line">    &#125; *obj = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Output is compiler dependent */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;offsets: i=%zd; c=%zd; d=%zd a=%zd\n&quot;</span>,</span><br><span class="line">            OBJECT_OFFSETOF(obj, i), OBJECT_OFFSETOF(obj, c),</span><br><span class="line">            OBJECT_OFFSETOF(obj, d), OBJECT_OFFSETOF(obj, a));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;sizeof(struct s)=%zd\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> s));</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CONTAINER-OF"><a href="#CONTAINER-OF" class="headerlink" title="CONTAINER_OF"></a>CONTAINER_OF</h3><p>å·²çŸ¥ç»“æ„ä½“<code>STRUCT</code>ä¸­æŸä¸ªæˆå‘˜<code>MEMBER</code>çš„åœ°å€ä¸º<code>POINTER</code>ï¼Œè¿”å›è¯¥ç»“æ„ä½“<code>STRUCT</code>çš„é¦–åœ°å€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* include/openvswitch/util.h #119 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONTAINER_OF(POINTER, STRUCT, MEMBER)                           \</span></span><br><span class="line"><span class="meta">        ((STRUCT *) (void *) ((char *) (POINTER) - offsetof (STRUCT, MEMBER)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨æ–¹æ³• */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONTAINER_OF(POINTER, STRUCT, MEMBER)                           \</span></span><br><span class="line"><span class="meta">        ((STRUCT *) (void *) ((char *) (POINTER) - offsetof (STRUCT, MEMBER)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">        <span class="type">char</span> a[];</span><br><span class="line">    &#125; obj;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr: %p\n&quot;</span>, &amp;obj);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from i: %p\n&quot;</span>, CONTAINER_OF(&amp;obj.i, <span class="keyword">struct</span> s, i));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from c: %p\n&quot;</span>, CONTAINER_OF(&amp;obj.c, <span class="keyword">struct</span> s, c));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from d: %p\n&quot;</span>, CONTAINER_OF(&amp;obj.d, <span class="keyword">struct</span> s, d));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from a: %p\n&quot;</span>, CONTAINER_OF(&amp;obj.a, <span class="keyword">struct</span> s, a));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="OBJECT-CONTAINING"><a href="#OBJECT-CONTAINING" class="headerlink" title="OBJECT_CONTAINING"></a>OBJECT_CONTAINING</h4><p>å·²çŸ¥æŸä¸ªç»“æ„ä½“å¯¹è±¡ä¸­æŸä¸ªæˆå‘˜<code>MEMBER</code>çš„åœ°å€ä¸º<code>POINTER</code>ï¼Œè¿”å›è¯¥å¯¹è±¡çš„åœ°å€ã€‚</p><p>ä¸<code>CONTAINER_OF</code>ç±»ä¼¼ï¼Œ<strong>åªæ˜¯ç”±<code>STRUCT</code>æ›¿æ¢ä¸ºæŒ‡å‘è¯¥ç»“æ„ä½“çš„æŒ‡é’ˆ<code>OBJECT</code>ï¼Œä¸”<code>OBJECT</code>æ˜¯å¦ä¸ºç©ºæ— å½±å“ï¼Œåªæ˜¯ç”¨äºé€šè¿‡<code>type_of</code>è·å–ç»“æ„ä½“ç±»å‹ã€‚</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OBJECT_CONTAINING(POINTER, OBJECT, MEMBER)                      \</span></span><br><span class="line"><span class="meta">    ((OVS_TYPEOF(OBJECT)) (void *)                                      \</span></span><br><span class="line"><span class="meta">     ((char *) (POINTER) - OBJECT_OFFSETOF(OBJECT, MEMBER)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨æ–¹æ³• */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJECT_OFFSETOF(OBJECT, MEMBER) offsetof(typeof(*(OBJECT)), MEMBER)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OVS_TYPEOF(OBJECT) typeof(OBJECT)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> OBJECT_CONTAINING(POINTER, OBJECT, MEMBER)                      \</span></span><br><span class="line"><span class="meta">    ((OVS_TYPEOF(OBJECT)) (void *)                                      \</span></span><br><span class="line"><span class="meta">     ((char *) (POINTER) - OBJECT_OFFSETOF(OBJECT, MEMBER)))</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> i;</span><br><span class="line">        <span class="type">char</span> c;</span><br><span class="line">        <span class="type">double</span> d;</span><br><span class="line">        <span class="type">char</span> a[];</span><br><span class="line">    &#125; obj;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">s</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>; <span class="comment">/* p ä¸ºç©ºï¼Œä½†æ— å½±å“ */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr: %p\n&quot;</span>, &amp;obj);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from i: %p\n&quot;</span>, OBJECT_CONTAINING(&amp;obj.i, p, i));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from c: %p\n&quot;</span>, OBJECT_CONTAINING(&amp;obj.c, p, c));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from d: %p\n&quot;</span>, OBJECT_CONTAINING(&amp;obj.d, p, d));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;obj addr from a: %p\n&quot;</span>, OBJECT_CONTAINING(&amp;obj.a, p, a));</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ASSIGN-CONTAINER"><a href="#ASSIGN-CONTAINER" class="headerlink" title="ASSIGN_CONTAINER"></a>ASSIGN_CONTAINER</h4><p>åŒä¸Šï¼Œå·²çŸ¥æŸä¸ªç»“æ„ä½“å¯¹è±¡ä¸­æŸä¸ªæˆå‘˜<code>MEMBER</code>çš„åœ°å€ä¸º<code>POINTER</code>ï¼Œä½†æ˜¯<strong>å°†è¯¥ç»“æ„ä½“çš„åœ°å€èµ‹å€¼ç»™<code>OBJECT</code>ï¼Œè¿”å›</strong><code>(void)0</code>ã€‚</p><p><code>,</code>é€—å·è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§æœ€ä½ï¼æ‰€ä»¥è¿™é‡Œæ˜¯å…ˆå¯¹<code>OBJECT</code>èµ‹å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ASSIGN_CONTAINER(OBJECT, POINTER, MEMBER) \</span></span><br><span class="line"><span class="meta">    ((OBJECT) = OBJECT_CONTAINING(POINTER, OBJECT, MEMBER), (void) 0)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>; <span class="comment">/* p ä¸ºç©ºï¼Œä½†æ— å½±å“ */</span></span><br><span class="line">ASSIGN_CONTAINER(p, &amp;obj.i, i)</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;obj addr from i: %p\n&quot;</span>, p); <span class="comment">/* p == &amp;obj */</span></span><br></pre></td></tr></table></figure><h4 id="INIT-CONTAINER"><a href="#INIT-CONTAINER" class="headerlink" title="INIT_CONTAINER"></a>INIT_CONTAINER</h4><p>åŒä¸Šï¼Œå°±å¤šä¸ªä¸€ä¸ªå¯¹<code>OBJECT</code>åˆå§‹åŒ–ä¸º<code>NULL</code>çš„æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INIT_CONTAINER(OBJECT, POINTER, MEMBER) \</span></span><br><span class="line"><span class="meta">    ((OBJECT) = NULL, ASSIGN_CONTAINER(OBJECT, POINTER, MEMBER))</span></span><br></pre></td></tr></table></figure><h3 id="BUILD-ASSERT-TYPE"><a href="#BUILD-ASSERT-TYPE" class="headerlink" title="BUILD_ASSERT_TYPE"></a>BUILD_ASSERT_TYPE</h3><p>ç¼–è¯‘è¿‡ç¨‹åšç±»å‹ä¸€è‡´æ€§æ£€æŸ¥ã€‚å¦‚æœ<code>POINTER</code>ä¸æŒ‡å®šçš„ç±»å‹<code>TYPE</code>ä¸åŒ¹é…çš„è¯ï¼Œä¼šæŠ¥ç¼–è¯‘é”™è¯¯ã€‚ä½†å¦‚æœç»™å®šçš„<code>TYPE</code>æ˜¯<code>void *</code>ï¼Œåˆ™å¯ä»¥ä¸ä»»æ„ç±»å‹çš„<code>POINTER</code>åŒ¹é…ã€‚</p><ul><li><strong>sizeof</strong>ï¼š<code>POINTER</code><strong>å¯ä»¥æ˜¯è¡¨è¾¾å¼</strong>ï¼Œæ‰€ä»¥è¿™é‡Œç”¨<code>sizeof</code><strong>æ¥ç¡®ä¿è¡¨è¾¾å¼ä¸ä¼šè¢«æ‰§è¡Œ</strong>ã€‚</li><li>**(void)**ï¼šé€šè¿‡<code>(void)</code><strong>å¿½ç•¥</strong>å‡½æ•°æˆ–è¡¨è¾¾å¼çš„å€¼ï¼Œè¿™é‡Œæ˜¯<code>sizeof</code>çš„è¿”å›å€¼ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> BUILD_ASSERT_TYPE(POINTER, TYPE) \</span></span><br><span class="line"><span class="meta">    ((void) sizeof ((int) ((POINTER) == (TYPE) (POINTER))))</span></span><br></pre></td></tr></table></figure><h3 id="CONST-CAST"><a href="#CONST-CAST" class="headerlink" title="CONST_CAST"></a>CONST_CAST</h3><p>å°†<code>const</code>ä¿®é¥°çš„æŒ‡é’ˆè½¬ä¸ºæŒ‡å®š<code>TYPE</code>çš„<code>non-const</code>ç±»å‹ã€‚å½“æŒ‡å®šçš„ç±»å‹<code>TYPE</code>ä¸æŒ‡é’ˆ<code>POINTER</code>ç±»å‹ä¸åŒ¹é…æ—¶ï¼Œç¼–è¯‘ä¼šæœ‰è­¦å‘Šã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CONST_CAST(TYPE, POINTER)                               \</span></span><br><span class="line"><span class="meta">    (BUILD_ASSERT_TYPE(POINTER, TYPE),                          \</span></span><br><span class="line"><span class="meta">     (TYPE) (POINTER))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨æ–¹æ³• */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUILD_ASSERT_TYPE(POINTER, TYPE) \</span></span><br><span class="line"><span class="meta">    ((void) sizeof ((int) ((POINTER) == (TYPE) (POINTER))))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CONST_CAST(TYPE, POINTER)                               \</span></span><br><span class="line"><span class="meta">    (BUILD_ASSERT_TYPE(POINTER, TYPE),                          \</span></span><br><span class="line"><span class="meta">     (TYPE) (POINTER))</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> constant = <span class="number">26</span>;</span><br><span class="line">    <span class="type">const</span> <span class="type">int</span>* const_p = &amp;constant;</span><br><span class="line">    <span class="type">int</span>* modifier = CONST_CAST(<span class="type">int</span> *, const_p);</span><br><span class="line">    <span class="comment">/* int* modifier = CONST_CAST(double *, const_p);</span></span><br><span class="line"><span class="comment">     * å½“æŒ‡å®šçš„ç±»å‹ double* ä¸æŒ‡é’ˆç±»å‹ä¸åŒ¹é…æ—¶ï¼Œç¼–è¯‘ä¼šæœ‰è­¦å‘Š */</span></span><br><span class="line">    *modifier = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;constant: %d\n&quot;</span>, constant);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;*modifier: %d\n&quot;</span>, *modifier);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ovs-assert"><a href="#ovs-assert" class="headerlink" title="ovs_assert"></a>ovs_assert</h3><p>å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œä¼šæŠ¥é”™å¹¶è¾“å‡ºå‘ç”Ÿé”™è¯¯çš„ä½ç½®ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•é˜¶æ®µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ovs_assert(CONDITION)                                           \</span></span><br><span class="line"><span class="meta">    (OVS_LIKELY(CONDITION)                                              \</span></span><br><span class="line"><span class="meta">     ? (void) 0                                                         \</span></span><br><span class="line"><span class="meta">     : ovs_assert_failure(OVS_SOURCE_LOCATOR, __func__, #CONDITION))</span></span><br></pre></td></tr></table></figure><h2 id="ovs-list"><a href="#ovs-list" class="headerlink" title="ovs_list"></a>ovs_list</h2><blockquote><p>include&#x2F;openvswitch&#x2F;list.h</p><p><a href="https://zhuanlan.zhihu.com/p/58087261">Linuxå†…æ ¸ä¸­å¸¸ç”¨çš„æ•°æ®ç»“æ„</a></p></blockquote><p>åŒå‘é“¾è¡¨ç»“æ„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> *<span class="title">prev</span>;</span>     <span class="comment">/* Previous list element. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> *<span class="title">next</span>;</span>     <span class="comment">/* Next list element. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">s</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æŸä¸ªç»“æ„ä½“éœ€è¦å®ç°é“¾è¡¨æ—¶ï¼Œåªéœ€è¦å°†è¯¥<code>ovs_list</code>åµŒå…¥åˆ°ç»“æ„ä½“ä¸­ã€‚</p><p><img src="/../images/OpenVSwitch-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/OVS%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-ovs_list.drawio.png" alt="ovs_list"></p><p><code>prev/next</code>æŒ‡å‘çš„æ˜¯<code>struct s</code>ä¸­çš„<code>node</code>ï¼Œå½“éœ€è¦<code>s</code>çš„åœ°å€æ—¶ï¼Œéœ€è¦é€šè¿‡ä¸Šé¢çš„å®<code>CONTAINER_OF</code>æˆ–è€…<code>OBJECT_CONTAINING</code>ã€‚</p><p><strong>LIST_FOR_EACH</strong>ï¼š<code>ITER</code>ä¸ºç»“æ„ä½“çš„ç©ºæŒ‡é’ˆ<code>struct s *p = NULL</code>ï¼Œéå†è¿‡ç¨‹ä¸­ä¼šæŒ‡å‘å½“å‰èŠ‚ç‚¹ï¼›<code>MEMBER</code>ä¸ºç»“æ„ä½“ä¸­<code>ovs_list</code>æˆå‘˜çš„åç§°<code>node</code>ï¼›<code>LIST</code>ä¸ºé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼ˆæˆ–è€…ä»»æ„é“¾è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œ<code>LIST</code>è‡ªèº«ä¸ä¼šè¢«éå†åˆ°ï¼›</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LIST_FOR_EACH(ITER, MEMBER, LIST)                               \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(ITER, (LIST)-&gt;next, MEMBER);                    \</span></span><br><span class="line"><span class="meta">         &amp;(ITER)-&gt;MEMBER != (LIST);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(ITER, (ITER)-&gt;MEMBER.next, MEMBER))</span></span><br></pre></td></tr></table></figure><p><strong>LIST_FOR_EACH_CONTINUE</strong>ï¼šåŒä¸Šï¼Œä½†<code>ITER</code>æœ‰åˆå§‹å€¼ï¼Œä»å½“å‰ä½ç½®çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹éå†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LIST_FOR_EACH_CONTINUE(ITER, MEMBER, LIST)                      \</span></span><br><span class="line"><span class="meta">    for (ASSIGN_CONTAINER(ITER, (ITER)-&gt;MEMBER.next, MEMBER);             \</span></span><br><span class="line"><span class="meta">         &amp;(ITER)-&gt;MEMBER != (LIST);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(ITER, (ITER)-&gt;MEMBER.next, MEMBER))</span></span><br></pre></td></tr></table></figure><p><strong>LIST_FOR_EACH_REVERSE</strong>ï¼šä¸<code>LIST_FOR_EACH</code>ç±»ä¼¼ï¼Œä½†åå‘éå†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> LIST_FOR_EACH_REVERSE(ITER, MEMBER, LIST)                       \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(ITER, (LIST)-&gt;prev, MEMBER);                    \</span></span><br><span class="line"><span class="meta">         &amp;(ITER)-&gt;MEMBER != (LIST);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(ITER, (ITER)-&gt;MEMBER.prev, MEMBER))</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªä¾‹å­ï¼š</p><ul><li>å°†è¯¥ä»£ç æ”¾åœ¨<code>ovs</code>æºç æ ¹ç›®å½•ä¸‹ï¼Œç¼–è¯‘æ—¶æŒ‡å®šå¤´æ–‡ä»¶è·¯å¾„ï¼š<code>gcc test.c -o test -I include</code>ã€‚</li><li>å°†å®å®šä¹‰å±•å¼€ï¼š<code>gcc -E -P test.c -o test.i</code> ï¼Œç›´æ¥è·³è½¬åˆ°æœ€åçœ‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;openvswitch/list.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> name;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> <span class="title">A</span> =</span> &#123;.name = <span class="string">&#x27;A&#x27;</span>, .age = <span class="number">1</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> <span class="title">B</span> =</span> &#123;.name = <span class="string">&#x27;B&#x27;</span>, .age = <span class="number">2</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> <span class="title">C</span> =</span> &#123;.name = <span class="string">&#x27;C&#x27;</span>, .age = <span class="number">3</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> <span class="title">D</span> =</span> &#123;.name = <span class="string">&#x27;D&#x27;</span>, .age = <span class="number">4</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_list</span> <span class="title">head</span>;</span>   <span class="comment">/* å¯åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ ovs_list ä½œä¸º head */</span></span><br><span class="line">    ovs_list_init(&amp;head);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ’å…¥ï¼šåœ¨ head å‰é¢æ’å…¥ A */</span></span><br><span class="line">    ovs_list_insert(&amp;head, &amp;A.node);    <span class="comment">/* A - head */</span></span><br><span class="line">    ovs_list_insert(&amp;head, &amp;B.node);    <span class="comment">/* A - B - head */</span></span><br><span class="line">    ovs_list_insert(&amp;B.node, &amp;C.node);  <span class="comment">/* A - C - B - head */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ›¿æ¢ï¼šç”¨ D æ›¿æ¢åŸæ¥ C çš„ä½ç½® */</span></span><br><span class="line">    ovs_list_replace(&amp;D.node, &amp;C.node); <span class="comment">/* A - D - B - head */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Person</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* éå†é“¾è¡¨ï¼Œè¾“å‡ºï¼šA - D - B */</span></span><br><span class="line">    LIST_FOR_EACH(p, node, &amp;head) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;name: %c\n&quot;</span>, p-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ é™¤ï¼šåˆ é™¤æŒ‡å®šèŠ‚ç‚¹ï¼Œè¿”å›åˆ é™¤å…ƒç´ çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ */</span></span><br><span class="line">    ovs_list *pl = ovs_list_remove(&amp;D.node); <span class="comment">/* pl == &amp;B.node */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="hmap"><a href="#hmap" class="headerlink" title="hmap"></a>hmap</h2><blockquote><p>include&#x2F;openvswitch&#x2F;hmap.h<br>lib&#x2F;hmap.c</p><p><a href="https://www.sdnlab.com/15552.html">æ·±å…¥åˆ†æHmap</a></p></blockquote><p><strong>A hash map.</strong></p><p>ä¸€ç§å“ˆå¸Œæ¡¶å®ç°ã€‚</p><ul><li>æ¡¶çš„æ•°é‡å¯è‡ªåŠ¨æ‰©å®¹ã€æ”¶ç¼©ï¼Œä¸”æ€»æ˜¯<code>2^n</code>ã€‚</li><li>å“ˆå¸Œå‡½æ•°å°±æ˜¯<code>key &amp; mask</code>ï¼Œè¿™é‡Œ<code>mask = 2^n-1</code>ã€‚</li><li>é€šè¿‡å¼€é“¾æ³•è§£å†³å“ˆå¸Œå†²çªã€‚</li><li>èŠ‚ç‚¹æ•°é‡ä¸º0æˆ–1æ—¶æ¯”è¾ƒç‰¹æ®Šã€‚</li></ul><blockquote><p>å°†å“ˆå¸Œæ¡¶çš„å¤§å°è®¾ç½®ä¸º<code>2^n</code>æ˜¯ä¸ºäº†åŠ é€Ÿã€‚å‡è®¾æ¡¶çš„å¤§å°ä¸º<code>len</code>ï¼Œé‚£ä¹ˆå“ˆå¸Œå‡½æ•°å°±åº”è¯¥ä¸º<code>key % len</code>ï¼Œè€Œå½“<code>len = 2^n</code>æ—¶ï¼Œ<code>key % len == key &amp; (len - 1)</code>ï¼Œç›¸æ¯”ä¹‹ä¸‹ï¼Œ<code>&amp;</code>æ“ä½œæ¯”<code>%</code>æ›´å¿«ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> &#123;</span></span><br><span class="line">    <span class="comment">/* buckets å°±æ˜¯å“ˆå¸Œæ¡¶ï¼Œæœ¬è´¨ä¸ºæŒ‡é’ˆæ•°ç»„ï¼ˆhmap_node *ï¼‰</span></span><br><span class="line"><span class="comment">     * å¦‚æœ mask == 0, buckets = &amp;one */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">buckets</span>;</span></span><br><span class="line">    <span class="comment">/* one åªæœ‰å½“ mask == 0 æ—¶æ‰å­˜å‚¨æ•°æ®ï¼Œmask != 0, åˆ™ one = NULL; */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">one</span>;</span></span><br><span class="line">    <span class="comment">/* buckets æ•°ç»„çš„å¤§å°ä¸º mask + 1 */</span></span><br><span class="line">    <span class="type">size_t</span> mask;</span><br><span class="line">    <span class="comment">/* hmap ä¸­æœ‰æ•ˆ hmap_node èŠ‚ç‚¹ä¸ªæ•° */</span></span><br><span class="line">    <span class="type">size_t</span> n;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¸€ä¸ªå“ˆå¸Œæ˜ å°„èŠ‚ç‚¹ï¼Œç”¨äºåµŒå…¥åˆ°è¢«æ˜ å°„çš„æ•°æ®ç»“æ„ä¸­ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> hash;                <span class="comment">/* å“ˆå¸Œå€¼ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">next</span>;</span>     <span class="comment">/* å•é“¾è¡¨ */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><img src="/../images/OpenVSwitch-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/OVS%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-hmap.drawio.png" alt="hmap"></p><p>åŒæ ·ï¼Œé€šè¿‡<code>hmap</code>å¾—åˆ°<code>hmap_node</code>çš„åœ°å€åï¼Œéœ€è¦é€šè¿‡<code>CONTAINER_OF</code>è·å–å¯¹åº”ç»“æ„ä½“å¯¹è±¡çš„åœ°å€ã€‚</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">hmap_init</span><span class="params">(<span class="keyword">struct</span> hmap *)</span>;   <span class="comment">/* åˆå§‹åŒ– */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hmap_insert(HMAP, NODE, HASH)   <span class="comment">/* æ’å…¥èŠ‚ç‚¹ */</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_remove</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="keyword">struct</span> hmap_node *)</span>;  <span class="comment">/* åˆ é™¤æŒ‡å®šèŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_random_node</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *)</span>; <span class="comment">/* éšæœºè¿”å›ä¸€ä¸ªèŠ‚ç‚¹ */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">hmap_contains</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *, <span class="type">const</span> <span class="keyword">struct</span> hmap_node *)</span>; <span class="comment">/* åˆ¤æ–­hmapæ˜¯å¦åŒ…å«è¯¥èŠ‚ç‚¹ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_destroy</span><span class="params">(<span class="keyword">struct</span> hmap *)</span>;  <span class="comment">/* é”€æ¯hmapï¼Œé‡Šæ”¾bucketsçš„å†…å­˜ï¼Œä½†ä¸è´Ÿè´£é”€æ¯hmap_nodeå¯¹åº”çš„èµ„æº */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_clear</span><span class="params">(<span class="keyword">struct</span> hmap *)</span>;    <span class="comment">/* å°† buckets æ•°ç»„æ¸…0ï¼Œå¤§å°ä¸å˜ï¼Œåªæ˜¯æ‰€æœ‰æŒ‡é’ˆç½®ä¸º NULL(0) */</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_remove</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">bucket</span> =</span> &amp;hmap-&gt;buckets[node-&gt;hash &amp; hmap-&gt;mask];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (*bucket != node) &#123;</span><br><span class="line">        bucket = &amp;(*bucket)-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    *bucket = node-&gt;next;</span><br><span class="line">    hmap-&gt;n--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>HMAP_FOR_EACH_WITH_HASH</strong>ï¼šéå† <code>HMAP</code> ä¸­æ‰€æœ‰ <code>hash_node-&gt;hash</code> å€¼ç­‰äº <code>HASH</code> çš„èŠ‚ç‚¹ï¼Œ<code>Node</code>å®é™…<code>struct</code>çš„æŒ‡é’ˆï¼›</p><p>æ ¹æ®<code>HASH</code>æ‰¾åˆ°å“ˆå¸Œæ¡¶æ‰€åœ¨çš„ä¸‹æ ‡ï¼Œç„¶åéå†å¯¹åº”çš„é“¾è¡¨ã€‚é“¾è¡¨ä¸­ï¼Œæœ‰å¯èƒ½ä¸åŒ<code>hash</code>å€¼çš„èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹ä¼šè¢«è·³è¿‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_WITH_HASH(NODE, MEMBER, HASH, HMAP)               \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first_with_hash(HMAP, HASH), MEMBER); \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next_with_hash(&amp;(NODE)-&gt;MEMBER),   \</span></span><br><span class="line"><span class="meta">                          MEMBER))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¿”å›ä¸‹ä¸€ä¸ªå…·æœ‰ç›¸åŒ hmap_node-&gt;hash å€¼çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰è¿”å› NULLï¼Œä¼šè·³è¿‡hashå€¼ä¸åŒçš„èŠ‚ç‚¹ */</span></span><br><span class="line"><span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_next_with_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br></pre></td></tr></table></figure><p><strong>HMAP_FOR_EACH_IN_BUCKET</strong>ï¼šåŒä¸Šï¼Œä½†éå†é“¾è¡¨æ—¶ï¼Œ<strong>ä¸ä¼šè·³è¿‡</strong>æœ‰ä¸åŒ<code>hash</code>å€¼çš„èŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_IN_BUCKET(NODE, MEMBER, HASH, HMAP)               \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first_in_bucket(HMAP, HASH), MEMBER); \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next_in_bucket(&amp;(NODE)-&gt;MEMBER), MEMBER))</span></span><br></pre></td></tr></table></figure><p><strong>HMAP_FOR_EACH</strong>ï¼šéå†<code>HMAP</code>ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH(NODE, MEMBER, HMAP) \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_INIT(NODE, MEMBER, HMAP, (void) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_INIT(NODE, MEMBER, HMAP, ...)                     \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first(HMAP), MEMBER), __VA_ARGS__;   \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER))</span></span><br></pre></td></tr></table></figure><p><strong>HMAP_FOR_EACH_SAFE</strong>ï¼šéå†<code>HMAP</code>ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ã€‚</p><p>ä¸<code>HMAP_FOR_EACH</code>ç›¸æ¯”ï¼Œåœ¨è¿›è¡Œå¾ªç¯æ¡ä»¶åˆ¤æ–­æ—¶ï¼Œä¼šé€šè¿‡<code>NEXT</code>é¢„å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€å³ä½¿åœ¨å¾ªç¯è¿‡ç¨‹ä¸­å°†<code>NODE</code>ä»<code>HMAP</code>ä¸­ç§»é™¤ï¼Œä»ç„¶å¯æ­£ç¡®éå†åç»­èŠ‚ç‚¹ã€‚</p><p>å…¶å®å¦‚æœåªæ˜¯ä»<code>HMAP</code>ä¸­ç§»é™¤ï¼Œä¸Šé¢çš„<code>HMAP_FOR_EACH</code>ä¹Ÿå¯ä»¥ï¼Œä¸è¿‡è¦æ˜¯è¿˜è°ƒç”¨äº†<code>free(NODE)</code>ï¼Œä¸Šé¢çš„å°±ä¼šå¯¼è‡´æ®µé”™è¯¯ï¼Œæˆ–è€…ä¸€äº›å¥‡æ€ªçš„å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_SAFE(NODE, NEXT, MEMBER, HMAP) \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_SAFE_INIT(NODE, NEXT, MEMBER, HMAP, (void) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_SAFE_INIT(NODE, NEXT, MEMBER, HMAP, ...)          \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first(HMAP), MEMBER), __VA_ARGS__;   \</span></span><br><span class="line"><span class="meta">         ((NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))               \</span></span><br><span class="line"><span class="meta">          || ((NODE = NULL), false)                                     \</span></span><br><span class="line"><span class="meta">          ? INIT_CONTAINER(NEXT, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER), 1 \</span></span><br><span class="line"><span class="meta">          : 0);                                                         \</span></span><br><span class="line"><span class="meta">         (NODE) = (NEXT))</span></span><br></pre></td></tr></table></figure><p><strong>HMAP_FOR_EACH_CONTINUE</strong>ï¼šå¯ä»¥ä»ä¸­é—´æŸä¸ªä½ç½®ï¼ˆ<code>NODE</code>æ‰€åœ¨ä½ç½®ï¼‰å¼€å§‹éå†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_CONTINUE(NODE, MEMBER, HMAP) \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_CONTINUE_INIT(NODE, MEMBER, HMAP, (void) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_CONTINUE_INIT(NODE, MEMBER, HMAP, ...)            \</span></span><br><span class="line"><span class="meta">    for (ASSIGN_CONTAINER(NODE, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER), \</span></span><br><span class="line"><span class="meta">         __VA_ARGS__;                                                   \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER))</span></span><br></pre></td></tr></table></figure><p><strong>hmap_insert</strong>ï¼šå‘<code>HMAP</code>ä¸­æ’å…¥èŠ‚ç‚¹<code>NODE</code>ï¼Œæ–°èŠ‚ç‚¹çš„å“ˆå¸Œå€¼ä¸º<code>HASH</code>ã€‚</p><p>è¯¥æ’å…¥å‡½æ•°åœ¨æ’å…¥èŠ‚ç‚¹æ—¶ä¸ä¼šæ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åŒæ ·å“ˆå¸Œå€¼çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´<code>hmap</code>ä¸­å¯èƒ½å­˜åœ¨å“ˆå¸Œå€¼ç›¸åŒçš„èŠ‚ç‚¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> hmap_insert(HMAP, NODE, HASH) \</span></span><br><span class="line"><span class="meta">    hmap_insert_at(HMAP, NODE, HASH, OVS_SOURCE_LOCATOR)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_insert_at</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="keyword">struct</span> hmap_node *node, <span class="type">size_t</span> hash,</span></span><br><span class="line"><span class="params">               <span class="type">const</span> <span class="type">char</span> *where)</span></span><br><span class="line">&#123;</span><br><span class="line">    hmap_insert_fast(hmap, node, hash);</span><br><span class="line">    <span class="keyword">if</span> (hmap-&gt;n / <span class="number">2</span> &gt; hmap-&gt;mask) &#123;</span><br><span class="line">        hmap_expand_at(hmap, where);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">hmap_insert_fast(<span class="keyword">struct</span> hmap *hmap, <span class="keyword">struct</span> hmap_node *node, <span class="type">size_t</span> hash)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">bucket</span> =</span> &amp;hmap-&gt;buckets[hash &amp; hmap-&gt;mask];</span><br><span class="line">    node-&gt;hash = hash;</span><br><span class="line">    node-&gt;next = *bucket;</span><br><span class="line">    *bucket = node;</span><br><span class="line">    hmap-&gt;n++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªä¾‹å­ï¼š</p><ul><li>å°†è¯¥ä»£ç æ”¾åœ¨<code>ovs</code>æºç æ ¹ç›®å½•ä¸‹ï¼Œç¼–è¯‘æ—¶æŒ‡å®šå¤´æ–‡ä»¶è·¯å¾„ï¼š<code>gcc test.c -o test -I include</code>ï¼Œ<code>hmap.h</code>ä¹Ÿéœ€è¦ä¸€ç‚¹ä¿®æ”¹æ‰èƒ½ç¼–è¯‘ã€‚</li><li>å°†å®å®šä¹‰å±•å¼€ï¼š<code>gcc -E -P test.c -o test.p -I include -I .</code> ï¼Œç›´æ¥è·³è½¬åˆ°æœ€åçœ‹ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;openvswitch/hmap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">element</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> value;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">node</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> i, N_ELEMS = <span class="number">100</span>;</span><br><span class="line">    <span class="type">int</span> values[N_ELEMS];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">element</span> *<span class="title">elem</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">hmap</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">data</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    hmap_init(&amp;hmap);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N_ELEMS; i++) &#123;</span><br><span class="line">        <span class="comment">/* åŠ¨æ€åˆ†é…å…ƒç´ ï¼Œè®¾ç½®æ¯ä¸ªå…ƒç´ çš„hashä¸º ä¸‹æ ‡+1 */</span></span><br><span class="line">        elem = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> element));</span><br><span class="line">        elem-&gt;value = i+<span class="number">1</span>;</span><br><span class="line">        hmap_insert(&amp;hmap, &amp;elem-&gt;node, i+<span class="number">1</span>);</span><br><span class="line">        <span class="comment">/* æŸ¥çœ‹ hmap è‡ªåŠ¨æ‰©å®¹ */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i+1 = %ld, hmap.mask = %ld, .n = %ld\n&quot;</span>, i, hmap.mask, hmap.n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------éå† hash å€¼ä¸º3çš„èŠ‚ç‚¹ \n&quot;</span>);</span><br><span class="line">    HMAP_FOR_EACH_WITH_HASH(elem, node, <span class="number">3</span>, &amp;hmap) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;elem .value = %d, .hash = %ld\n&quot;</span>, elem-&gt;value, elem-&gt;node.hash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------éå† hash å€¼ä¸º3 æ‰€åœ¨ buckets çš„å…¨éƒ¨èŠ‚ç‚¹ \n&quot;</span>);</span><br><span class="line">    HMAP_FOR_EACH_IN_BUCKET(elem, node, <span class="number">3</span>, &amp;hmap) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;elem .value = %d, .hash = %ld\n&quot;</span>, elem-&gt;value, elem-&gt;node.hash);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------éå† mapï¼Œåˆ é™¤å€¼ä¸º10çš„èŠ‚ç‚¹ \n&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">element</span> *<span class="title">next</span>;</span></span><br><span class="line">    HMAP_FOR_EACH_SAFE(elem, next, node, &amp;hmap) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;elem .value = %d, .hash = %ld\n&quot;</span>, elem-&gt;value, elem-&gt;node.hash);</span><br><span class="line">        <span class="keyword">if</span> (elem-&gt;value == <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;free elem\n&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(elem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------éå† hmapï¼Œåˆ é™¤å€¼ä¸º11çš„èŠ‚ç‚¹ \n&quot;</span>);</span><br><span class="line">    HMAP_FOR_EACH(elem, node, &amp;hmap) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;elem .value = %d, .hash = %ld\n&quot;</span>, elem-&gt;value, elem-&gt;node.hash);</span><br><span class="line">        <span class="keyword">if</span> (elem-&gt;value == <span class="number">11</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;free elem\n&quot;</span>);</span><br><span class="line">            <span class="built_in">free</span>(elem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hmap_destroy(&amp;hmap);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>include&#x2F;openvswitch&#x2F;hmap.h éœ€è¦å°†<code>hmap.c</code>ä¸­çš„å®ç°æš‚æ—¶æ”¾åˆ°<code>hmap.h</code>ä¸­æ‰èƒ½æ­£ç¡®ç¼–è¯‘ï¼Œè€Œä¸”è¿˜æ³¨é‡Šäº†ä¸€äº›å…¶ä»–å¤–éƒ¨å‡½æ•°è°ƒç”¨ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> HMAP_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_H 1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;openvswitch/util.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>  __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* A hash map node, to be embedded inside the data structure being mapped. */</span></span><br><span class="line"><span class="comment">/* ä¸€ä¸ªå“ˆå¸Œæ˜ å°„èŠ‚ç‚¹ï¼Œç”¨äºåµŒå…¥åˆ°è¢«æ˜ å°„çš„æ•°æ®ç»“æ„ä¸­ã€‚ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> hash;                <span class="comment">/* Hash value. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">next</span>;</span>     <span class="comment">/* Next in linked list. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the hash value embedded in &#x27;node&#x27;. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title function_">hmap_node_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> node-&gt;hash;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_NODE_NULL ((struct hmap_node *) 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_NODE_NULL_INITIALIZER &#123; 0, HMAP_NODE_NULL &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns true if &#x27;node&#x27; has been set to null by hmap_node_nullify() and has</span></span><br><span class="line"><span class="comment"> * not been un-nullified by being inserted into an hmap. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line"><span class="title function_">hmap_node_is_null</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> node-&gt;next == HMAP_NODE_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Marks &#x27;node&#x27; with a distinctive value that can be tested with</span></span><br><span class="line"><span class="comment"> * hmap_node_is_null().  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_node_nullify</span><span class="params">(<span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    node-&gt;next = HMAP_NODE_NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* A hash map. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> &#123;</span></span><br><span class="line">    <span class="comment">/* buckets å°±æ˜¯å“ˆå¸Œæ¡¶ï¼Œæœ¬è´¨ä¸ºæŒ‡é’ˆæ•°ç»„ï¼ˆhmap_node *ï¼‰</span></span><br><span class="line"><span class="comment">     * å¦‚æœ mask == 0, buckets = &amp;one */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">buckets</span>;</span></span><br><span class="line">    <span class="comment">/* one åªæœ‰å½“ mask == 0 æ—¶æ‰å­˜å‚¨æ•°æ®ï¼Œmask != 0, åˆ™ one = NULL; */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">one</span>;</span></span><br><span class="line">    <span class="comment">/* buckets æ•°ç»„çš„å¤§å°ä¸º mask + 1, maskæ€»æ˜¯ 2^n - 1.</span></span><br><span class="line"><span class="comment">    * (èŠ‚ç‚¹hashå€¼ &amp; mask)ï¼šè¯¥èŠ‚ç‚¹åœ¨bucketsæ•°ç»„ä¸­çš„ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="type">size_t</span> mask;</span><br><span class="line">    <span class="comment">/* buckets ä¸­å®é™…æœ‰æ•ˆ hmap_node èŠ‚ç‚¹ä¸ªæ•°ï¼Œå½“ n &gt; 2*mask + 1æ—¶æ‰ä¼šæ‰©å®¹ */</span></span><br><span class="line">    <span class="type">size_t</span> n;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initializer for an empty hash map. */</span></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ– hmap &#123;buckets = &amp;one, one = NULL, mask = 0, n = 0&#125; */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_INITIALIZER(HMAP) \</span></span><br><span class="line"><span class="meta">    &#123; (struct hmap_node **const) &amp;(HMAP)-&gt;one, NULL, 0, 0 &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initializer for an immutable struct hmap &#x27;HMAP&#x27; that contains &#x27;N&#x27; nodes</span></span><br><span class="line"><span class="comment"> * linked together starting at &#x27;NODE&#x27;.  The hmap only has a single chain of</span></span><br><span class="line"><span class="comment"> * hmap_nodes, so &#x27;N&#x27; should be small. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_CONST(HMAP, N, NODE) &#123;                                 \</span></span><br><span class="line"><span class="meta">        CONST_CAST(struct hmap_node **, &amp;(HMAP)-&gt;one), NODE, 0, N &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initialization. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_init</span><span class="params">(<span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_destroy</span><span class="params">(<span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_clear</span><span class="params">(<span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_swap</span><span class="params">(<span class="keyword">struct</span> hmap *a, <span class="keyword">struct</span> hmap *b)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_moved</span><span class="params">(<span class="keyword">struct</span> hmap *hmap)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span> <span class="title function_">hmap_count</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span> <span class="title function_">hmap_is_empty</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Adjusting capacity. */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_expand_at</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="type">const</span> <span class="type">char</span> *where)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hmap_expand(HMAP) hmap_expand_at(HMAP, OVS_SOURCE_LOCATOR)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_shrink_at</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="type">const</span> <span class="type">char</span> *where)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hmap_shrink(HMAP) hmap_shrink_at(HMAP, OVS_SOURCE_LOCATOR)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_reserve_at</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="type">size_t</span> capacity, <span class="type">const</span> <span class="type">char</span> *where)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hmap_reserve(HMAP, CAPACITY) \</span></span><br><span class="line"><span class="meta">    hmap_reserve_at(HMAP, CAPACITY, OVS_SOURCE_LOCATOR)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Insertion and deletion. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">hmap_insert_at</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="keyword">struct</span> hmap_node *,</span></span><br><span class="line"><span class="params">                                  <span class="type">size_t</span> hash, <span class="type">const</span> <span class="type">char</span> *where)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> hmap_insert(HMAP, NODE, HASH) \</span></span><br><span class="line"><span class="meta">    hmap_insert_at(HMAP, NODE, HASH, OVS_SOURCE_LOCATOR)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">hmap_insert_fast</span><span class="params">(<span class="keyword">struct</span> hmap *,</span></span><br><span class="line"><span class="params">                                    <span class="keyword">struct</span> hmap_node *, <span class="type">size_t</span> hash)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">hmap_remove</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="keyword">struct</span> hmap_node *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hmap_node_moved</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="keyword">struct</span> hmap_node *, <span class="keyword">struct</span> hmap_node *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">hmap_replace</span><span class="params">(<span class="keyword">struct</span> hmap *, <span class="type">const</span> <span class="keyword">struct</span> hmap_node *old,</span></span><br><span class="line"><span class="params">                                <span class="keyword">struct</span> hmap_node *new_node)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_random_node</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Search.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * HMAP_FOR_EACH_WITH_HASH éå† HMAP ä¸­æ‰€æœ‰hashå€¼ç­‰äºHASHçš„ NODEã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * HMAP_FOR_EACH_IN_BUCKET åœ¨HMAPä¸­æ‰€æœ‰ä¸HASHå±äºåŒä¸€æ¡¶çš„èŠ‚ç‚¹ä¸Šè¿­ä»£ NODEã€‚</span></span><br><span class="line"><span class="comment"> * iterates NODE over all of the nodes in HMAP that would fall in the same bucket as HASH.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * NODE æ˜¯åŒ…å« &#x27;struct hmap_node&#x27; çš„ç»“æ„ä½“åç§°ã€‚</span></span><br><span class="line"><span class="comment"> * MEMBER å¿…é¡»æ˜¯ NODEä¸­ &#x27;struct hmap_node&#x27; æˆå‘˜çš„åç§°ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * These macros may be used interchangeably to search for a particular value in</span></span><br><span class="line"><span class="comment"> * an hmap, see, e.g. shash_find() for an example.  Usually, using</span></span><br><span class="line"><span class="comment"> * HMAP_FOR_EACH_WITH_HASH provides an optimization, because comparing a hash</span></span><br><span class="line"><span class="comment"> * value is usually cheaper than comparing an entire hash map key.  But for</span></span><br><span class="line"><span class="comment"> * simple hash map keys, it makes sense to use HMAP_FOR_EACH_IN_BUCKET because</span></span><br><span class="line"><span class="comment"> * it avoids doing two comparisons when a single simple comparison suffices.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The loop should not change NODE to point to a different node or insert or</span></span><br><span class="line"><span class="comment"> * delete nodes in HMAP (unless it &quot;break&quot;s out of the loop to terminate</span></span><br><span class="line"><span class="comment"> * iteration).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * HASH is only evaluated once.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * When the loop terminates normally, meaning the iteration has completed</span></span><br><span class="line"><span class="comment"> * without using &#x27;break&#x27;, NODE will be NULL.  This is true for all of the</span></span><br><span class="line"><span class="comment"> * HMAP_FOR_EACH_*() macros.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_WITH_HASH(NODE, MEMBER, HASH, HMAP)               \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first_with_hash(HMAP, HASH), MEMBER); \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next_with_hash(&amp;(NODE)-&gt;MEMBER),   \</span></span><br><span class="line"><span class="meta">                          MEMBER))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_IN_BUCKET(NODE, MEMBER, HASH, HMAP)               \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first_in_bucket(HMAP, HASH), MEMBER); \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next_in_bucket(&amp;(NODE)-&gt;MEMBER), MEMBER))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_first_with_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *,</span></span><br><span class="line"><span class="params">                                                     <span class="type">size_t</span> hash)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_next_with_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_first_in_bucket</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *,</span></span><br><span class="line"><span class="params">                                                     <span class="type">size_t</span> hash)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_next_in_bucket</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">hmap_contains</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *, <span class="type">const</span> <span class="keyword">struct</span> hmap_node *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Iteration.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The *_INIT variants of these macros additionally evaluate the expressions</span></span><br><span class="line"><span class="comment"> * supplied following the HMAP argument once during the loop initialization.</span></span><br><span class="line"><span class="comment"> * This makes it possible for data structures that wrap around hmaps to insert</span></span><br><span class="line"><span class="comment"> * additional initialization into their iteration macros without having to</span></span><br><span class="line"><span class="comment"> * completely rewrite them.  In particular, it can be a good idea to insert</span></span><br><span class="line"><span class="comment"> * BUILD_ASSERT_TYPE checks for map and node types that wrap hmap, since</span></span><br><span class="line"><span class="comment"> * otherwise it is possible for clients to accidentally confuse two derived</span></span><br><span class="line"><span class="comment"> * data structures that happen to use the same member names for struct hmap and</span></span><br><span class="line"><span class="comment"> * struct hmap_node. */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Iterates through every node in HMAP. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH(NODE, MEMBER, HMAP) \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_INIT(NODE, MEMBER, HMAP, (void) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_INIT(NODE, MEMBER, HMAP, ...)                     \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first(HMAP), MEMBER), __VA_ARGS__;   \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Safe when NODE may be freed (not needed when NODE may be removed from the</span></span><br><span class="line"><span class="comment"> * hash map but its members remain accessible and intact). */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_SAFE(NODE, NEXT, MEMBER, HMAP) \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_SAFE_INIT(NODE, NEXT, MEMBER, HMAP, (void) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_SAFE_INIT(NODE, NEXT, MEMBER, HMAP, ...)          \</span></span><br><span class="line"><span class="meta">    for (INIT_CONTAINER(NODE, hmap_first(HMAP), MEMBER), __VA_ARGS__;   \</span></span><br><span class="line"><span class="meta">         ((NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))               \</span></span><br><span class="line"><span class="meta">          || ((NODE = NULL), false)                                     \</span></span><br><span class="line"><span class="meta">          ? INIT_CONTAINER(NEXT, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER), 1 \</span></span><br><span class="line"><span class="meta">          : 0);                                                         \</span></span><br><span class="line"><span class="meta">         (NODE) = (NEXT))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Continues an iteration from just after NODE. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_CONTINUE(NODE, MEMBER, HMAP) \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_CONTINUE_INIT(NODE, MEMBER, HMAP, (void) 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_CONTINUE_INIT(NODE, MEMBER, HMAP, ...)            \</span></span><br><span class="line"><span class="meta">    for (ASSIGN_CONTAINER(NODE, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER), \</span></span><br><span class="line"><span class="meta">         __VA_ARGS__;                                                   \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);                                     \</span></span><br><span class="line"><span class="meta">         ASSIGN_CONTAINER(NODE, hmap_next(HMAP, &amp;(NODE)-&gt;MEMBER), MEMBER))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_pop_helper__</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="type">size_t</span> *bucket)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (; *bucket &lt;= hmap-&gt;mask; (*bucket)++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">node</span> =</span> hmap-&gt;buckets[*bucket];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (node) &#123;</span><br><span class="line">            hmap_remove(hmap, node);</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HMAP_FOR_EACH_POP(NODE, MEMBER, HMAP)                               \</span></span><br><span class="line"><span class="meta">    for (size_t bucket__ = 0;                                               \</span></span><br><span class="line"><span class="meta">         INIT_CONTAINER(NODE, hmap_pop_helper__(HMAP, &amp;bucket__), MEMBER),  \</span></span><br><span class="line"><span class="meta">         (NODE != OBJECT_CONTAINING(NULL, NODE, MEMBER))                    \</span></span><br><span class="line"><span class="meta">         || ((NODE = NULL), false);)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_first</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *)</span>;</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_next</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *,</span></span><br><span class="line"><span class="params">                                          <span class="type">const</span> <span class="keyword">struct</span> hmap_node *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmap_position</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> bucket;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> offset;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> hmap_node *<span class="title function_">hmap_at_position</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *,</span></span><br><span class="line"><span class="params">                                   <span class="keyword">struct</span> hmap_position *)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the number of nodes currently in &#x27;hmap&#x27;. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span></span><br><span class="line"><span class="title function_">hmap_count</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap-&gt;n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the maximum number of nodes that &#x27;hmap&#x27; may hold before it should be</span></span><br><span class="line"><span class="comment"> * rehashed. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">size_t</span></span><br><span class="line"><span class="title function_">hmap_capacity</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap-&gt;mask * <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns true if &#x27;hmap&#x27; currently contains no nodes,</span></span><br><span class="line"><span class="comment"> * false otherwise.</span></span><br><span class="line"><span class="comment"> * Note: While hmap in general is not thread-safe without additional locking,</span></span><br><span class="line"><span class="comment"> * hmap_is_empty() is. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">bool</span></span><br><span class="line"><span class="title function_">hmap_is_empty</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap-&gt;n == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Inserts &#x27;node&#x27;, with the given &#x27;hash&#x27;, into &#x27;hmap&#x27;.  &#x27;hmap&#x27; is never</span></span><br><span class="line"><span class="comment"> * expanded automatically. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_insert_fast</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="keyword">struct</span> hmap_node *node, <span class="type">size_t</span> hash)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">bucket</span> =</span> &amp;hmap-&gt;buckets[hash &amp; hmap-&gt;mask];</span><br><span class="line">    node-&gt;hash = hash;</span><br><span class="line">    node-&gt;next = *bucket;</span><br><span class="line">    *bucket = node;</span><br><span class="line">    hmap-&gt;n++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç”¨ç»™å®šçš„&#x27;hash&#x27;å€¼å°†&#x27;node&#x27;æ’å…¥åˆ°&#x27;hmap&#x27;ä¸­ï¼Œå¹¶åœ¨å¿…è¦æ—¶æ‰©å®¹&#x27;hmap&#x27;ä»¥ä¼˜åŒ–æœç´¢æ€§èƒ½</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;where&#x27;ç”¨äºè°ƒè¯•æ—¥å¿—è®°å½•ã€‚é€šå¸¸ä½¿ç”¨ hmap_insert() è‡ªåŠ¨æä¾›</span></span><br><span class="line"><span class="comment"> * è°ƒç”¨è€…çš„æºæ–‡ä»¶å’Œwhereçš„è¡Œå·ã€‚*/</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_insert_at</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="keyword">struct</span> hmap_node *node, <span class="type">size_t</span> hash,</span></span><br><span class="line"><span class="params">               <span class="type">const</span> <span class="type">char</span> *where)</span></span><br><span class="line">&#123;</span><br><span class="line">    hmap_insert_fast(hmap, node, hash);</span><br><span class="line">    <span class="comment">/* å¦‚æœhmapä¸­å®é™…èŠ‚ç‚¹çš„æ•°é‡è¶…è¿‡å®¹é‡çš„ä¸€åŠæ—¶ï¼Œè¿›è¡Œç¿»å€æ‰©å®¹ */</span></span><br><span class="line">    <span class="keyword">if</span> (hmap-&gt;n / <span class="number">2</span> &gt; hmap-&gt;mask) &#123;</span><br><span class="line">        hmap_expand_at(hmap, where);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Removes &#x27;node&#x27; from &#x27;hmap&#x27;.  Does not shrink the hash table; call</span></span><br><span class="line"><span class="comment"> * hmap_shrink() directly if desired. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_remove</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">bucket</span> =</span> &amp;hmap-&gt;buckets[node-&gt;hash &amp; hmap-&gt;mask];</span><br><span class="line">    <span class="keyword">while</span> (*bucket != node) &#123;</span><br><span class="line">        bucket = &amp;(*bucket)-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    *bucket = node-&gt;next;</span><br><span class="line">    hmap-&gt;n--;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Puts &#x27;new_node&#x27; in the position in &#x27;hmap&#x27; currently occupied by &#x27;old_node&#x27;.</span></span><br><span class="line"><span class="comment"> * The &#x27;new_node&#x27; must hash to the same value as &#x27;old_node&#x27;.  The client is</span></span><br><span class="line"><span class="comment"> * responsible for ensuring that the replacement does not violate any</span></span><br><span class="line"><span class="comment"> * client-imposed invariants (e.g. uniqueness of keys within a map).</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Afterward, &#x27;old_node&#x27; is not part of &#x27;hmap&#x27;, and the client is responsible</span></span><br><span class="line"><span class="comment"> * for freeing it (if this is desirable). */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_replace</span><span class="params">(<span class="keyword">struct</span> hmap *hmap,</span></span><br><span class="line"><span class="params">             <span class="type">const</span> <span class="keyword">struct</span> hmap_node *old_node, <span class="keyword">struct</span> hmap_node *new_node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">bucket</span> =</span> &amp;hmap-&gt;buckets[old_node-&gt;hash &amp; hmap-&gt;mask];</span><br><span class="line">    <span class="keyword">while</span> (*bucket != old_node) &#123;</span><br><span class="line">        bucket = &amp;(*bucket)-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    *bucket = new_node;</span><br><span class="line">    new_node-&gt;hash = old_node-&gt;hash;</span><br><span class="line">    new_node-&gt;next = old_node-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_next_with_hash__</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *node, <span class="type">size_t</span> hash)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (node != <span class="literal">NULL</span> &amp;&amp; node-&gt;hash != hash) &#123;</span><br><span class="line">        node = node-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> CONST_CAST(<span class="keyword">struct</span> hmap_node *, node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the first node in &#x27;hmap&#x27; with the given &#x27;hash&#x27;, or a null pointer if</span></span><br><span class="line"><span class="comment"> * no nodes have that hash value. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_first_with_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap, <span class="type">size_t</span> hash)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap_next_with_hash__(hmap-&gt;buckets[hash &amp; hmap-&gt;mask], hash);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the first node in &#x27;hmap&#x27; in the bucket in which the given &#x27;hash&#x27;</span></span><br><span class="line"><span class="comment"> * would land, or a null pointer if that bucket is empty. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_first_in_bucket</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap, <span class="type">size_t</span> hash)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap-&gt;buckets[hash &amp; hmap-&gt;mask];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the next node in the same bucket as &#x27;node&#x27;, or a null pointer if</span></span><br><span class="line"><span class="comment"> * there are no more nodes in that bucket.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the hash map has been reallocated since &#x27;node&#x27; was visited, some nodes</span></span><br><span class="line"><span class="comment"> * may be skipped; if new nodes with the same hash value have been added, they</span></span><br><span class="line"><span class="comment"> * will be skipped.  (Removing &#x27;node&#x27; from the hash map does not prevent</span></span><br><span class="line"><span class="comment"> * calling this function, since node-&gt;next is preserved, although freeing</span></span><br><span class="line"><span class="comment"> * &#x27;node&#x27; of course does.) */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_next_in_bucket</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> node-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the next node in the same hash map as &#x27;node&#x27; with the same hash</span></span><br><span class="line"><span class="comment"> * value, or a null pointer if no more nodes have that hash value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the hash map has been reallocated since &#x27;node&#x27; was visited, some nodes</span></span><br><span class="line"><span class="comment"> * may be skipped; if new nodes with the same hash value have been added, they</span></span><br><span class="line"><span class="comment"> * will be skipped.  (Removing &#x27;node&#x27; from the hash map does not prevent</span></span><br><span class="line"><span class="comment"> * calling this function, since node-&gt;next is preserved, although freeing</span></span><br><span class="line"><span class="comment"> * &#x27;node&#x27; of course does.) */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_next_with_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap_next_with_hash__(node-&gt;next, node-&gt;hash);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_next__</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap, <span class="type">size_t</span> start)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = start; i &lt;= hmap-&gt;mask; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">node</span> =</span> hmap-&gt;buckets[i];</span><br><span class="line">        <span class="keyword">if</span> (node) &#123;</span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the first node in &#x27;hmap&#x27;, in arbitrary order, or a null pointer if</span></span><br><span class="line"><span class="comment"> * &#x27;hmap&#x27; is empty. */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_first</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmap_next__(hmap, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the next node in &#x27;hmap&#x27; following &#x27;node&#x27;, in arbitrary order, or a</span></span><br><span class="line"><span class="comment"> * null pointer if &#x27;node&#x27; is the last node in &#x27;hmap&#x27;.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If the hash map has been reallocated since &#x27;node&#x27; was visited, some nodes</span></span><br><span class="line"><span class="comment"> * may be skipped or visited twice.  (Removing &#x27;node&#x27; from the hash map does</span></span><br><span class="line"><span class="comment"> * not prevent calling this function, since node-&gt;next is preserved, although</span></span><br><span class="line"><span class="comment"> * freeing &#x27;node&#x27; of course does.) */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_next</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap, <span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> (node-&gt;next</span><br><span class="line">            ? node-&gt;next</span><br><span class="line">            : hmap_next__(hmap, (node-&gt;hash &amp; hmap-&gt;mask) + <span class="number">1</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Initializes &#x27;hmap&#x27; as an empty hash table. */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_init</span><span class="params">(<span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    hmap-&gt;buckets = &amp;hmap-&gt;one;</span><br><span class="line">    hmap-&gt;one = <span class="literal">NULL</span>;</span><br><span class="line">    hmap-&gt;mask = <span class="number">0</span>;</span><br><span class="line">    hmap-&gt;n = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Frees memory reserved by &#x27;hmap&#x27;.  It is the client&#x27;s responsibility to free</span></span><br><span class="line"><span class="comment"> * the nodes themselves, if necessary. */</span></span><br><span class="line"><span class="comment">/* é‡Šæ”¾ hmap åˆ†é…çš„å†…å­˜ï¼Œä½†ä»…ä»…é‡Šæ”¾ hmap è‡ªèº«çš„æŒ‡é’ˆæ•°ç»„çš„å†…å­˜ï¼Œ</span></span><br><span class="line"><span class="comment"> * å¹¶ä¸è´Ÿè´£é‡Šæ”¾ åµŒå…¥hmap_nodeçš„ç»“æ„ çš„å†…å­˜ */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_destroy</span><span class="params">(<span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (hmap &amp;&amp; hmap-&gt;buckets != &amp;hmap-&gt;one) &#123;</span><br><span class="line">        <span class="built_in">free</span>(hmap-&gt;buckets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç§»é™¤ hmap çš„ buckets ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç•™å‡ºç©ºé—´æ¥æ”¶æ–°çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰é‡Šæ”¾hampçš„å†…å­˜</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function is appropriate when &#x27;hmap&#x27; will soon have about as many</span></span><br><span class="line"><span class="comment"> * elements as it did before.  If &#x27;hmap&#x27; will likely have fewer elements than</span></span><br><span class="line"><span class="comment"> * before, use hmap_destroy() followed by hmap_init() to save memory and</span></span><br><span class="line"><span class="comment"> * iteration time.</span></span><br><span class="line"><span class="comment"> * å½“&#x27;hmap&#x27;å¾ˆå¿«å°†æ‹¥æœ‰å’Œä»¥å‰ä¸€æ ·å¤šçš„å…ƒç´ æ—¶ï¼Œæ­¤å‡½æ•°æ˜¯åˆé€‚çš„ã€‚å¦‚æœ&#x27;hmap&#x27;å¯èƒ½æ¯”ä»¥å‰æœ‰æ›´å°‘çš„å…ƒç´ ï¼Œ</span></span><br><span class="line"><span class="comment"> * ä½¿ç”¨hmap_destroy()å’Œhmap_init()æ¥èŠ‚çœå†…å­˜å’Œè¿­ä»£æ—¶é—´ã€‚*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_clear</span><span class="params">(<span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (hmap-&gt;n &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        hmap-&gt;n = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">/* å°† buckets æ•°ç»„æ¸…0 */</span></span><br><span class="line">        <span class="built_in">memset</span>(hmap-&gt;buckets, <span class="number">0</span>, (hmap-&gt;mask + <span class="number">1</span>) * <span class="keyword">sizeof</span> *hmap-&gt;buckets);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exchanges hash maps &#x27;a&#x27; and &#x27;b&#x27;. */</span></span><br><span class="line"><span class="comment">/* æ³¨æ„æ­¤å¤„ä¸æ˜¯æŒ‡é’ˆèµ‹å€¼ï¼ï¼è€Œæ˜¯ç»“æ„ä½“èµ‹å€¼ï¼ˆæ¯ä¸ªæˆå‘˜èµ‹å€¼ï¼‰*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_swap</span><span class="params">(<span class="keyword">struct</span> hmap *a, <span class="keyword">struct</span> hmap *b)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">tmp</span> =</span> *a;</span><br><span class="line">    *a = *b;</span><br><span class="line">    *b = tmp;</span><br><span class="line">    hmap_moved(a);</span><br><span class="line">    hmap_moved(b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Adjusts &#x27;hmap&#x27; to compensate for having moved position in memory (e.g. due</span></span><br><span class="line"><span class="comment"> * to realloc()). */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_moved</span><span class="params">(<span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!hmap-&gt;mask) &#123;</span><br><span class="line">        hmap-&gt;buckets = &amp;hmap-&gt;one;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1. å…ˆä»¥æ–°çš„å®¹é‡å¤§å°new_mask+1åˆ›å»ºä¸€ä¸ªä¸´æ—¶hmapï¼Œ</span></span><br><span class="line"><span class="comment"> * 2. å†éå†åŸhmapä¸­çš„èŠ‚ç‚¹ï¼Œè°ƒç”¨hmap_insert æ’å…¥åˆ°ä¸´æ—¶hmapä¸­ã€‚</span></span><br><span class="line"><span class="comment"> * 3. äº¤æ¢ä¸¤ä¸ªhmap, swap(hmap, tmp);</span></span><br><span class="line"><span class="comment"> * 4. é”€æ¯tmp(å³åŸæ¥çš„hmap)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">resize</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="type">size_t</span> new_mask, <span class="type">const</span> <span class="type">char</span> *where)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">tmp</span>;</span></span><br><span class="line">    <span class="type">size_t</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å†æ¬¡æ£€æŸ¥æŒ‡å®šçš„maskæ˜¯å¦åˆç†ï¼ˆ2^n - 1ï¼‰ */</span></span><br><span class="line">    <span class="comment">// ovs_assert(is_pow2(new_mask + 1));</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. å…ˆä»¥æ–°çš„å®¹é‡å¤§å°new_mask+1åˆ›å»ºä¸€ä¸ªä¸´æ—¶hmap */</span></span><br><span class="line">    hmap_init(&amp;tmp);</span><br><span class="line">    <span class="keyword">if</span> (new_mask) &#123;</span><br><span class="line">        tmp.buckets = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span> *tmp.buckets * (new_mask + <span class="number">1</span>));</span><br><span class="line">        tmp.mask = new_mask;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= tmp.mask; i++) &#123;</span><br><span class="line">            tmp.buckets[i] = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n_big_buckets = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> biggest_count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> n_biggest_buckets = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">/* 2. å†éå†åŸhmapä¸­çš„èŠ‚ç‚¹ï¼Œè°ƒç”¨hmap_insert æ’å…¥åˆ°ä¸´æ—¶hmapä¸­ */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= hmap-&gt;mask; i++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">node</span>, *<span class="title">next</span>;</span></span><br><span class="line">        <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (node = hmap-&gt;buckets[i]; node; node = next) &#123;</span><br><span class="line">            next = node-&gt;next;</span><br><span class="line">            hmap_insert_fast(&amp;tmp, node, node-&gt;hash);</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (count &gt; <span class="number">5</span>) &#123;</span><br><span class="line">            n_big_buckets++;</span><br><span class="line">            <span class="keyword">if</span> (count &gt; biggest_count) &#123;</span><br><span class="line">                biggest_count = count;</span><br><span class="line">                n_biggest_buckets = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (count == biggest_count) &#123;</span><br><span class="line">                n_biggest_buckets++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 3. äº¤æ¢ä¸¤ä¸ªhmap, swap(hmap, tmp); */</span></span><br><span class="line">    hmap_swap(hmap, &amp;tmp);</span><br><span class="line">    <span class="comment">/* 4. é”€æ¯tmp (å³åŸæ¥çš„hmap) */</span></span><br><span class="line">    hmap_destroy(&amp;tmp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if (n_big_buckets) &#123;</span></span><br><span class="line">    <span class="comment">//     static struct vlog_rate_limit rl = VLOG_RATE_LIMIT_INIT(10, 10);</span></span><br><span class="line">    <span class="comment">//     COVERAGE_INC(hmap_pathological);</span></span><br><span class="line">    <span class="comment">//     VLOG_DBG_RL(&amp;rl, &quot;%s: %d bucket%s with 6+ nodes, &quot;</span></span><br><span class="line">    <span class="comment">//                 &quot;including %d bucket%s with %d nodes &quot;</span></span><br><span class="line">    <span class="comment">//                 &quot;(%&quot;PRIuSIZE&quot; nodes total across %&quot;PRIuSIZE&quot; buckets)&quot;,</span></span><br><span class="line">    <span class="comment">//                 where,</span></span><br><span class="line">    <span class="comment">//                 n_big_buckets, n_big_buckets &gt; 1 ? &quot;s&quot; : &quot;&quot;,</span></span><br><span class="line">    <span class="comment">//                 n_biggest_buckets, n_biggest_buckets &gt; 1 ? &quot;s&quot; : &quot;&quot;,</span></span><br><span class="line">    <span class="comment">//                 biggest_count,</span></span><br><span class="line">    <span class="comment">//                 hmap-&gt;n, hmap-&gt;mask + 1);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* hmapçš„bucketsçš„å¤§å°å¿…é¡»æ˜¯2^nï¼Œcapacityåªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œ</span></span><br><span class="line"><span class="comment"> * ç»è¿‡è®¡ç®—ï¼Œå®é™…å–çš„å¤§å°æ˜¯ &lt;= capacity çš„ä¸€ä¸ª2^n çš„æ•°ï¼Œè€Œmaskåˆ™æ˜¯2^n - 1.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">size_t</span></span><br><span class="line"><span class="title function_">calc_mask</span><span class="params">(<span class="type">size_t</span> capacity)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> mask = capacity / <span class="number">2</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">4</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">16</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> SIZE_MAX &gt; UINT32_MAX</span></span><br><span class="line">    mask |= mask &gt;&gt; <span class="number">32</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If we need to dynamically allocate buckets we might as well allocate at</span></span><br><span class="line"><span class="comment">     * least 4 of them. */</span></span><br><span class="line">    mask |= (mask &amp; <span class="number">1</span>) &lt;&lt; <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¦‚æœéœ€è¦ï¼Œæ‰©å®¹â€œhmapâ€ä»¥ä¼˜åŒ–æœç´¢çš„æ€§èƒ½ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;where&#x27; ç”¨äºDEBUGæ—¥å¿—è®°å½•ã€‚é€šå¸¸ä½¿ç”¨ hmap_insert() è‡ªåŠ¨æä¾›è°ƒç”¨è€…çš„æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> * å’Œ &#x27;where&#x27; çš„è¡Œå·ã€‚*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_expand_at</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="type">const</span> <span class="type">char</span> *where)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> new_mask = calc_mask(hmap-&gt;n);</span><br><span class="line">    <span class="keyword">if</span> (new_mask &gt; hmap-&gt;mask) &#123;</span><br><span class="line">        <span class="comment">// COVERAGE_INC(hmap_expand);</span></span><br><span class="line">        resize(hmap, new_mask, where);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¦‚æœéœ€è¦ï¼Œæ”¶ç¼©â€œhmapâ€ä»¥ä¼˜åŒ–è¿­ä»£çš„æ€§èƒ½</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;where&#x27; ç”¨äºDEBUGæ—¥å¿—è®°å½•ã€‚é€šå¸¸ä½¿ç”¨ hmap_insert() è‡ªåŠ¨æä¾›è°ƒç”¨è€…çš„æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> * å’Œ &#x27;where&#x27; çš„è¡Œå·ã€‚*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_shrink_at</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="type">const</span> <span class="type">char</span> *where)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> new_mask = calc_mask(hmap-&gt;n);</span><br><span class="line">    <span class="keyword">if</span> (new_mask &lt; hmap-&gt;mask) &#123;</span><br><span class="line">        <span class="comment">// COVERAGE_INC(hmap_shrink);</span></span><br><span class="line">        resize(hmap, new_mask, where);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¦‚æœæœ‰å¿…è¦ï¼Œæ‰©å®¹&#x27;hmap&#x27;ï¼Œä»¥ä¼˜åŒ–å½“å®ƒæœ‰&#x27;n&#x27;ä¸ªå…ƒç´ æ—¶çš„æœç´¢æ€§èƒ½ã€‚</span></span><br><span class="line"><span class="comment"> * (ä½†æ˜¯åœ¨ä¸€ä¸ªå·²åˆ†é…å®¹é‡è¿œè¿œé«˜äºå½“å‰èŠ‚ç‚¹æ•°é‡çš„å“ˆå¸Œæ˜ å°„ä¸­ï¼Œè¿­ä»£é€Ÿåº¦ä¼šå¾ˆæ…¢)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &#x27;where&#x27; ç”¨äºDEBUGæ—¥å¿—è®°å½•ã€‚é€šå¸¸ä½¿ç”¨ hmap_insert() è‡ªåŠ¨æä¾›è°ƒç”¨è€…çš„æºæ–‡ä»¶</span></span><br><span class="line"><span class="comment"> * å’Œ &#x27;where&#x27; çš„è¡Œå·ã€‚*/</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_reserve_at</span><span class="params">(<span class="keyword">struct</span> hmap *hmap, <span class="type">size_t</span> n, <span class="type">const</span> <span class="type">char</span> *where)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> new_mask = calc_mask(n);</span><br><span class="line">    <span class="keyword">if</span> (new_mask &gt; hmap-&gt;mask) &#123;</span><br><span class="line">        <span class="comment">// COVERAGE_INC(hmap_reserve);</span></span><br><span class="line">        resize(hmap, new_mask, where);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Adjusts &#x27;hmap&#x27; to compensate for &#x27;old_node&#x27; having moved position in memory</span></span><br><span class="line"><span class="comment"> * to &#x27;node&#x27; (e.g. due to realloc()). */</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">hmap_node_moved</span><span class="params">(<span class="keyword">struct</span> hmap *hmap,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> hmap_node *old_node, <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> **<span class="title">bucket</span> =</span> &amp;hmap-&gt;buckets[node-&gt;hash &amp; hmap-&gt;mask];</span><br><span class="line">    <span class="keyword">while</span> (*bucket != old_node) &#123;</span><br><span class="line">        bucket = &amp;(*bucket)-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    *bucket = node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä»&#x27;hmap&#x27;ä¸­é€‰æ‹©å¹¶è¿”å›ä¸€ä¸ªéšæœºé€‰æ‹©çš„èŠ‚ç‚¹ï¼Œè¯¥ hmap ä¸èƒ½ä¸ºç©º</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * I wouldn&#x27;t depend on this algorithm to be fair, since I haven&#x27;t analyzed it.</span></span><br><span class="line"><span class="comment"> * But it does at least ensure that any node in &#x27;hmap&#x27; can be chosen. */</span></span><br><span class="line"><span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_random_node</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">bucket</span>, *<span class="title">node</span>;</span></span><br><span class="line">    <span class="type">size_t</span> n, i;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Choose a random non-empty bucket. */</span></span><br><span class="line">    <span class="comment">// for (;;) &#123;</span></span><br><span class="line">    <span class="comment">//     bucket = hmap-&gt;buckets[random_uint32() &amp; hmap-&gt;mask];</span></span><br><span class="line">    <span class="comment">//     if (bucket) &#123;</span></span><br><span class="line">    <span class="comment">//         break;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Count nodes in bucket. */</span></span><br><span class="line">    <span class="comment">// n = 0;</span></span><br><span class="line">    <span class="comment">// for (node = bucket; node; node = node-&gt;next) &#123;</span></span><br><span class="line">    <span class="comment">//     n++;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Choose random node from bucket. */</span></span><br><span class="line">    <span class="comment">// i = random_range(n);</span></span><br><span class="line">    <span class="comment">// i = n-1;</span></span><br><span class="line">    <span class="comment">// for (node = bucket; i-- &gt; 0; node = node-&gt;next) &#123;</span></span><br><span class="line">    <span class="comment">//     continue;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns the next node in &#x27;hmap&#x27; in hash order, or NULL if no nodes remain in</span></span><br><span class="line"><span class="comment"> * &#x27;hmap&#x27;.  Uses &#x27;*pos&#x27; to determine where to begin iteration, and updates</span></span><br><span class="line"><span class="comment"> * &#x27;*pos&#x27; to pass on the next iteration into them before returning.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * It&#x27;s better to use plain HMAP_FOR_EACH and related functions, since they are</span></span><br><span class="line"><span class="comment"> * faster and better at dealing with hmaps that change during iteration.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Before beginning iteration, set &#x27;*pos&#x27; to all zeros. */</span></span><br><span class="line"><span class="keyword">struct</span> hmap_node *</span><br><span class="line"><span class="title function_">hmap_at_position</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap,</span></span><br><span class="line"><span class="params">                 <span class="keyword">struct</span> hmap_position *pos)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> offset;</span><br><span class="line">    <span class="type">size_t</span> b_idx;</span><br><span class="line"></span><br><span class="line">    offset = pos-&gt;offset;</span><br><span class="line">    <span class="keyword">for</span> (b_idx = pos-&gt;bucket; b_idx &lt;= hmap-&gt;mask; b_idx++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">node</span>;</span></span><br><span class="line">        <span class="type">size_t</span> n_idx;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (n_idx = <span class="number">0</span>, node = hmap-&gt;buckets[b_idx]; node != <span class="literal">NULL</span>;</span><br><span class="line">             n_idx++, node = node-&gt;next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (n_idx == offset) &#123;</span><br><span class="line">                <span class="keyword">if</span> (node-&gt;next) &#123;</span><br><span class="line">                    pos-&gt;bucket = node-&gt;hash &amp; hmap-&gt;mask;</span><br><span class="line">                    pos-&gt;offset = offset + <span class="number">1</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    pos-&gt;bucket = (node-&gt;hash &amp; hmap-&gt;mask) + <span class="number">1</span>;</span><br><span class="line">                    pos-&gt;offset = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> node;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        offset = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pos-&gt;bucket = <span class="number">0</span>;</span><br><span class="line">    pos-&gt;offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Returns true if &#x27;node&#x27; is in &#x27;hmap&#x27;, false otherwise. */</span></span><br><span class="line"><span class="type">bool</span></span><br><span class="line"><span class="title function_">hmap_contains</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmap *hmap, <span class="type">const</span> <span class="keyword">struct</span> hmap_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> *<span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (p = hmap_first_in_bucket(hmap, node-&gt;hash); p; p = p-&gt;next) &#123;</span><br><span class="line">        <span class="keyword">if</span> (p == node) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span>  __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* hmap.h */</span></span></span><br></pre></td></tr></table></figure><h2 id="smap"><a href="#smap" class="headerlink" title="smap"></a>smap</h2><p><strong>a map from string to string.</strong></p><p>åŒæ ·æ˜¯åœ¨<code>hmap</code>ä¸Šè¿›è¡Œæ‰©å±•ï¼Œè¯¥ç»“æ„çš„<code>key</code>å’Œ<code>value</code>å‡ä¸ºå­—ç¬¦ä¸²ï¼Œ<code>hash</code>ç”±<code>key</code>è®¡ç®—å¾—åˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">smap</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">map</span>;</span>           <span class="comment">/* Contains &quot;struct smap_node&quot;s. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">smap_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">node</span>;</span>     <span class="comment">/* In struct smap&#x27;s &#x27;map&#x27; hmap. */</span></span><br><span class="line">    <span class="type">char</span> *key;</span><br><span class="line">    <span class="type">char</span> *value;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="simap"><a href="#simap" class="headerlink" title="simap"></a>simap</h2><p><strong>A map from strings to unsigned integers.</strong></p><p>ä¸<code>smap</code>ç±»ä¼¼ï¼Œ<code>hash</code>å€¼æ˜¯ç”±å­—ç¬¦ä¸²<code>name</code>è®¡ç®—å¾—åˆ°ï¼Œåªä¸è¿‡<code>value</code>å˜ä¸ºäº†<code>unsigned int</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simap</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">map</span>;</span>            <span class="comment">/* Contains &quot;struct simap_node&quot;s. */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">simap_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">node</span>;</span>      <span class="comment">/* In struct simap&#x27;s &#x27;map&#x27; hmap. */</span></span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> data;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="shash"><a href="#shash" class="headerlink" title="shash"></a>shash</h2><p><strong>a map from string(char *name) to</strong> <code>void *data</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shash_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">node</span>;</span></span><br><span class="line">    <span class="type">char</span> *name;</span><br><span class="line">    <span class="type">void</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shash</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">map</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>SHASH_FOR_EACH</strong>ï¼šéå†<code>SHASH</code>è¿™ä¸ªmapä¸­çš„èŠ‚ç‚¹ï¼Œå°†èŠ‚ç‚¹åœ°å€èµ‹å€¼ç»™<code>SHASH_NODE</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SHASH_FOR_EACH(SHASH_NODE, SHASH)                               \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_INIT (SHASH_NODE, node, &amp;(SHASH)-&gt;map,                \</span></span><br><span class="line"><span class="meta">                        BUILD_ASSERT_TYPE(SHASH_NODE, struct shash_node *), \</span></span><br><span class="line"><span class="meta">                        BUILD_ASSERT_TYPE(SHASH, struct shash *))</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shash</span> <span class="title">wanted_ports</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shash_node</span> *<span class="title">port_node</span>;</span></span><br><span class="line">SHASH_FOR_EACH (port_node, &amp;wanted_ports) &#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">ovsrec_port</span> *<span class="title">port_cfg</span> =</span> port_node-&gt;data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä»–æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å‘ shash ä¸­æ’å…¥ä¸€ä¸ªelemï¼Œæ’å…¥æ—¶å…ˆåšæ£€æŸ¥ï¼Œå¦‚æœå·²ç»å­˜åœ¨ï¼Œå°±è¿”å›falseï¼Œä¸å­˜åœ¨æ‰æ·»åŠ  */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">shash_add_once</span><span class="params">(<span class="keyword">struct</span> shash *, <span class="type">const</span> <span class="type">char</span> *, <span class="type">const</span> <span class="type">void</span> *)</span>;</span><br><span class="line"><span class="comment">/* å­—é¢æ„æ€ï¼Œå¦‚æœshä¸­å·²ç»å­˜åœ¨è¯¥key(name)ï¼Œé‚£å°±æ›¿æ¢valueä¸ºæ–°çš„dataï¼Œå¹¶è¿”å›æ—§çš„dataï¼ˆå¾—freeæ‰ï¼‰ã€‚</span></span><br><span class="line"><span class="comment"> * å¦‚æœshä¸­ä¸å­˜åœ¨è¯¥nameï¼Œé‚£å°±å°†å…¶åŠ è¿›å»ã€‚å­—ç¬¦ä¸²nameä¼šè¢«æ‹·è´ï¼ï¼dataä¸ä¼šè¢«æ‹·è´ã€‚ */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">shash_replace</span><span class="params">(<span class="keyword">struct</span> shash *sh, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">void</span> *data)</span>;</span><br><span class="line"><span class="comment">/* åŒä¸Šï¼Œä½†nameä¹Ÿä¸ä¼šè¢«æ‹·è´ */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">shash_replace_nocopy</span><span class="params">(<span class="keyword">struct</span> shash *, <span class="type">char</span> *name, <span class="type">const</span> <span class="type">void</span> *data)</span>;</span><br></pre></td></tr></table></figure><hr><h2 id="sset"><a href="#sset" class="headerlink" title="sset"></a>sset</h2><p><strong>A set of strings.</strong></p><p><code>hash</code>å€¼æ˜¯ç”±<code>name</code>è®¡ç®—å¾—åˆ°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sset_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">hmap_node</span>;</span></span><br><span class="line">    <span class="type">char</span> name[<span class="number">1</span>];   <span class="comment">/* ä¸å®šé•¿ç»“æ„ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sset</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">map</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>sset_add</strong>ï¼šæ·»åŠ ä¸€ä¸ªå­—ç¬¦ä¸²<code>name</code>åˆ°<code>sset</code>ä¸­ï¼Œå¦‚æœ<code>name</code>å·²ç»å­˜åœ¨ï¼Œåˆ™è¿”å›<code>NULL</code>ï¼Œå¦åˆ™è¿”å›æ–°å»ºçš„<code>sset_node</code>èŠ‚ç‚¹ã€‚</p><p>æ³¨æ„ä¼ é€’çš„å­—ç¬¦ä¸²ä¼šè¿›è¡Œæ‹·è´ï¼Œ<code>malloc</code> çš„å¤§å°æ˜¯åŸºäºå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> sset_node *</span><br><span class="line"><span class="title function_">sset_add</span><span class="params">(<span class="keyword">struct</span> sset *<span class="built_in">set</span>, <span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> length = <span class="built_in">strlen</span>(name);</span><br><span class="line">    <span class="type">uint32_t</span> hash = hash_name__(name, length);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (sset_find__(<span class="built_in">set</span>, name, hash)</span><br><span class="line">            ? <span class="literal">NULL</span></span><br><span class="line">            : sset_add__(<span class="built_in">set</span>, name, length, hash));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> sset_node *</span><br><span class="line"><span class="title function_">sset_add__</span><span class="params">(<span class="keyword">struct</span> sset *<span class="built_in">set</span>, <span class="type">const</span> <span class="type">char</span> *name, <span class="type">size_t</span> length, <span class="type">size_t</span> hash)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sset_node</span> *<span class="title">node</span> =</span> xmalloc(length + <span class="keyword">sizeof</span> *node); <span class="comment">/* mallocçš„å¤§å°æ˜¯åŸºäºå­—ç¬¦ä¸²çš„é•¿åº¦ */</span></span><br><span class="line">    <span class="built_in">memcpy</span>(node-&gt;name, name, length + <span class="number">1</span>);</span><br><span class="line">    hmap_insert(&amp;<span class="built_in">set</span>-&gt;<span class="built_in">map</span>, &amp;node-&gt;hmap_node, hash);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="hmapx"><a href="#hmapx" class="headerlink" title="hmapx"></a>hmapx</h2><p><strong>A set of</strong> <code>void *</code> <strong>pointers</strong>.</p><p>åœ¨<code>hmap</code>ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ç°äº†ä¸€ä¸ª<code>set</code>ã€‚</p><p><code>hmap</code>åœ¨ä½¿ç”¨æ—¶ï¼Œå¾€å¾€æ˜¯å°†<code>hmap_node</code>åµŒå…¥åˆ°æŸä¸ªç»“æ„ä½“ä¸­ï¼Œç»“æ„ä½“æ˜¯å¯ä»¥ç”¨æˆ·è‡ªå®šä¹‰çš„ã€‚è€Œä¸”è¯¥èŠ‚ç‚¹çš„<code>key</code>ä¹Ÿå°±æ˜¯<code>hash</code>å€¼æ˜¯ç”¨æˆ·æŒ‡å®šçš„ã€‚</p><p><code>hmapx</code>å°±æ²¡æœ‰<code>hmap</code>é‚£æ ·çš„é€šç”¨æ€§ï¼Œ<code>hmapx_node</code>å°±æ˜¯ä¸Šé¢æè¿°çš„åµŒå…¥äº†<code>hmap_node</code>çš„ç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“åªæœ‰ä¸€ä¸ªæˆå‘˜<code>void *data</code>ã€‚å¦ä¸€ä¸ªç‰¹æ®Šåœ¨äºèŠ‚ç‚¹çš„<code>hash</code>å€¼ä¸èƒ½æŒ‡å®šï¼Œè€Œæ˜¯åŸºäº<code>data</code>çš„åœ°å€è‡ªåŠ¨è®¡ç®—ã€‚</p><p><code>hmapx</code>ä¹Ÿå¯ä»¥çœ‹ä½œ<code>key-value</code>ï¼Œ<code>key</code>æ˜¯<code>void *data</code>ï¼Œ<code>value</code>ä¹Ÿæ˜¯ï¼Œæ‰€ä»¥ä¸ä¼šå­˜åœ¨ä¸¤ä¸ªèŠ‚ç‚¹ç›¸åŒï¼Œä¹Ÿå°±æ˜¯å®ç°äº†<code>set</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmapx_node</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap_node</span> <span class="title">hmap_node</span>;</span></span><br><span class="line">    <span class="type">void</span> *data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hmapx</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmap</span> <span class="title">map</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> hmapx_node *</span><br><span class="line"><span class="title function_">hmapx_add</span><span class="params">(<span class="keyword">struct</span> hmapx *<span class="built_in">map</span>, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">uint32_t</span> hash = hash_pointer(data, <span class="number">0</span>);  <span class="comment">/* åŸºäºdataå­˜å‚¨çš„åœ°å€è®¡ç®—hash */</span></span><br><span class="line">    <span class="keyword">return</span> (hmapx_find__(<span class="built_in">map</span>, data, hash)</span><br><span class="line">            ? <span class="literal">NULL</span></span><br><span class="line">            : hmapx_add__(<span class="built_in">map</span>, data, hash));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>hmapx</code>æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨æŸä¸ª<code>data</code>æ—¶ï¼Œæ˜¯é€šè¿‡ç›´æ¥æ¯”è¾ƒ<code>data</code>æŒ‡é’ˆæ˜¯å¦ç›¸ç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> hmapx_node *</span><br><span class="line"><span class="title function_">hmapx_find</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmapx *<span class="built_in">map</span>, <span class="type">const</span> <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> hmapx_find__(<span class="built_in">map</span>, data, hash_pointer(data, <span class="number">0</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> hmapx_node *</span><br><span class="line"><span class="title function_">hmapx_find__</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> hmapx *<span class="built_in">map</span>, <span class="type">const</span> <span class="type">void</span> *data, <span class="type">size_t</span> hash)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hmapx_node</span> *<span class="title">node</span>;</span></span><br><span class="line"></span><br><span class="line">    HMAP_FOR_EACH_IN_BUCKET (node, hmap_node, hash, &amp;<span class="built_in">map</span>-&gt;<span class="built_in">map</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node-&gt;data == data) &#123;   <span class="comment">/* æ¯”è¾ƒæŒ‡é’ˆæ˜¯å¦ç›¸ç­‰ */</span></span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>HMAPX_FOR_EACH</strong>ï¼šéå†<code>hmapx</code>ä¸­çš„æ¯ä¸€ä¸ª<code>hmapx_node</code>èŠ‚ç‚¹ã€‚<code>struct hmap_node *NODE;</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAPX_FOR_EACH(NODE, HMAPX)                                     \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_INIT(NODE, hmap_node, &amp;(HMAPX)-&gt;map,                  \</span></span><br><span class="line"><span class="meta">                       BUILD_ASSERT_TYPE(NODE, struct hmapx_node *),    \</span></span><br><span class="line"><span class="meta">                       BUILD_ASSERT_TYPE(HMAPX, struct hmapx *))</span></span><br></pre></td></tr></table></figure><p><strong>HMAPX_FOR_EACH_SAFE</strong>ï¼šä¸<code>HMAP_FOR_EACH_SAFE</code>ç±»ä¼¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HMAPX_FOR_EACH_SAFE(NODE, NEXT, HMAPX)                          \</span></span><br><span class="line"><span class="meta">    HMAP_FOR_EACH_SAFE_INIT(NODE, NEXT, hmap_node, &amp;(HMAPX)-&gt;map,       \</span></span><br><span class="line"><span class="meta">                            BUILD_ASSERT_TYPE(NODE, struct hmapx_node *), \</span></span><br><span class="line"><span class="meta">                            BUILD_ASSERT_TYPE(NEXT, struct hmapx_node *), \</span></span><br><span class="line"><span class="meta">                            BUILD_ASSERT_TYPE(HMAPX, struct hmapx *))</span></span><br></pre></td></tr></table></figure><h2 id="hash"><a href="#hash" class="headerlink" title="hash"></a>hash</h2><hr><h2 id="cmap"><a href="#cmap" class="headerlink" title="cmap"></a>cmap</h2><blockquote><p><a href="https://www.youtube.com/watch?v=GPiJUtdiUlo">How Cuckoo Hashing Work Part 1 (Introduction to Cuckoo Hashing)</a><br><a href="https://www.youtube.com/watch?v=wGjOZhK11ms">How Cuckoo Hashing Work Part 2 - Introduction to Cuckoo Hashing</a></p><p><a href="https://jishuin.proginn.com/p/763bfbd338d0">äº”å¤§ç±»å…±13ç§å“ˆå¸Œç®—æ³•</a></p></blockquote><p><strong>Concurrent hash map.</strong></p><p>å®ç°ä¸å†æ˜¯åŸºäº<code>hmap</code>ï¼Œå®Œå…¨æ˜¯å¦ä¸€å¥—æ–¹å¼ï¼Œæœ€ä¸»è¦çš„ç‰¹ç‚¹æ˜¯<strong>æ”¯æŒå¹¶å‘æ“ä½œ</strong>ã€‚</p><p>åŸºæœ¬ç»“æ„ä¸<code>hmap</code>ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸€ç§å“ˆå¸Œæ¡¶ï¼Œ<code>mask</code>å’Œ<code>n</code>çš„æ„ä¹‰ä¹Ÿç›¸åŒã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmap</span> &#123;</span></span><br><span class="line">    OVSRCU_TYPE(<span class="keyword">struct</span> cmap_impl *) impl;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmap_impl</span> &#123;</span></span><br><span class="line">    PADDED_MEMBERS_CACHELINE_MARKER(CACHE_LINE_SIZE, cacheline0,</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> n;             <span class="comment">/* Number of in-use elements. */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> max_n;         <span class="comment">/* Max elements before enlarging. */</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> min_n;         <span class="comment">/* Min elements before shrinking. */</span></span><br><span class="line">        <span class="type">uint32_t</span> mask;              <span class="comment">/* Number of &#x27;buckets&#x27;, minus one. */</span></span><br><span class="line">        <span class="type">uint32_t</span> basis;             <span class="comment">/* Basis for rehashing client&#x27;s</span></span><br><span class="line"><span class="comment">                                       hash values. */</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    PADDED_MEMBERS_CACHELINE_MARKER(CACHE_LINE_SIZE, cacheline1,</span><br><span class="line">        <span class="keyword">struct</span> cmap_bucket buckets[<span class="number">1</span>];</span><br><span class="line">    );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="skiplist"><a href="#skiplist" class="headerlink" title="skiplist"></a>skiplist</h2><blockquote><p>lib&#x2F;skiplist.h<br>lib&#x2F;skiplist.c</p><p><a href="https://www.jianshu.com/p/9d8296562806">Skip Listâ€“è·³è¡¨</a></p></blockquote><p><img src="/../images/OpenVSwitch-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/webp.webp" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Skiplist container */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">skiplist</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">skiplist_node</span> *<span class="title">header</span>;</span> <span class="comment">/* Pointer to head node (not first</span></span><br><span class="line"><span class="comment">                                   * data node). */</span></span><br><span class="line">    skiplist_comparator *cmp;     <span class="comment">/* Pointer to the skiplist&#x27;s comparison</span></span><br><span class="line"><span class="comment">                                   * function. */</span></span><br><span class="line">    <span class="type">void</span> *cfg;                    <span class="comment">/* Pointer to optional comparison</span></span><br><span class="line"><span class="comment">                                   * configuration, used by the comparator. */</span></span><br><span class="line">    <span class="type">int</span> level;                    <span class="comment">/* Maximum level currently in use. */</span></span><br><span class="line">    <span class="type">uint32_t</span> size;                <span class="comment">/* Current number of nodes in skiplist. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="pvector"><a href="#pvector" class="headerlink" title="pvector"></a>pvector</h2><blockquote><p>lib&#x2F;pvector.h</p></blockquote><p><strong>Concurrent Priority Vector</strong>.</p><p>ä¼˜å…ˆçº§<code>vector</code>ï¼Œæ”¯æŒå¹¶å‘æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pvector_entry</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> priority;</span><br><span class="line">    <span class="type">void</span> *ptr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pvector_impl</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_size_t</span> size;   <span class="comment">/* Number of entries in the vector. */</span></span><br><span class="line">    <span class="type">size_t</span> allocated;     <span class="comment">/* Number of allocated entries. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pvector_entry</span> <span class="title">vector</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Concurrent priority vector. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pvector</span> &#123;</span></span><br><span class="line">    OVSRCU_TYPE(<span class="keyword">struct</span> pvector_impl *) impl;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pvector_impl</span> *<span class="title">temp</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="ds"><a href="#ds" class="headerlink" title="ds"></a>ds</h2><blockquote><p>include&#x2F;openvswitch&#x2F;dynamic-string.h</p></blockquote><p>åŠ¨æ€æ‰©å®¹çš„å­—ç¬¦ä¸²ç»“æ„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ds</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> *<span class="built_in">string</span>;       <span class="comment">/* Null-terminated string. */</span></span><br><span class="line">    <span class="type">size_t</span> length;      <span class="comment">/* Bytes used, not including null terminator. */</span></span><br><span class="line">    <span class="type">size_t</span> allocated;   <span class="comment">/* Bytes allocated, not including null terminator. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="svec"><a href="#svec" class="headerlink" title="svec"></a>svec</h2><blockquote><p>lib&#x2F;svec.h</p></blockquote><p>å­—ç¬¦ä¸²<code>vector</code>ï¼Œå¯è‡ªåŠ¨æ‰©å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svec</span> &#123;</span></span><br><span class="line">    <span class="type">char</span> **names;</span><br><span class="line">    <span class="type">size_t</span> n;</span><br><span class="line">    <span class="type">size_t</span> allocated;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>svec</code>ä¸­çš„å­—ç¬¦ä¸²å¯èƒ½æ˜¯æ— åºçš„ï¼Œæä¾›äº†æ–¹æ³•<code>svec_sort</code>å¯¹å…¶æŒ‰å­—å…¸åºæ’åºï¼ˆå¿«æ’ï¼‰ï¼Œè°ƒç”¨å…¶æŸäº›æ–¹æ³•è¦æ±‚å…ˆå¯¹å…¶æ’åºã€‚</p><hr><h2 id="pbytes"><a href="#pbytes" class="headerlink" title="pbytes"></a>pbytes</h2><blockquote><p>lib&#x2F;byteq.h</p></blockquote><p><strong>General-purpose circular queue of bytes.</strong> ä»¥å­—èŠ‚ä¸ºå•ä½çš„å¾ªç¯é˜Ÿåˆ—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">byteq</span> &#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> *buffer;            <span class="comment">/* Circular queue. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> size;          <span class="comment">/* Number of bytes allocated for &#x27;buffer&#x27;. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> head;          <span class="comment">/* Head of queue. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> tail;          <span class="comment">/* Chases the head. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="ovs-rcu"><a href="#ovs-rcu" class="headerlink" title="ovs-rcu"></a>ovs-rcu</h2><blockquote><p>lib&#x2F;ovs-rcu.h</p><p><a href="https://blog.csdn.net/qq_33095733/article/details/123708142">Linux RCUæœºåˆ¶</a></p></blockquote><p> åŸå­æŒ‡é’ˆå˜é‡å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°ä¸€ä¸ªæ— é”ç®—æ³•ï¼›ä½†æœ‰ä¸€ä¸ªå¤§é—®é¢˜ï¼šå½“ writer å°†è¿™ä¸ªé’ˆæŒ‡å‘ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯èƒ½æ­£åœ¨è¯»æ—§çš„ç‰ˆæœ¬ï¼Œé—®é¢˜æ˜¯ï¼Œå½“æ‰€æœ‰ç”¨åˆ°è¿™ä¸ªæ—§çš„ç‰ˆæœ¬çš„çº¿ç¨‹å®Œæˆæ“ä½œåï¼Œæ€ä¹ˆ free è¿™ä¸ªæ—§çš„ç‰ˆæœ¬ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h2 id="ovs-thread"><a href="#ovs-thread" class="headerlink" title="ovs-thread"></a>ovs-thread</h2><blockquote><p>lib&#x2F;ovs-thread.h<br>lib&#x2F;ovs-thread.c</p></blockquote><h3 id="ä¸€æ¬¡æ€§åˆå§‹åŒ–"><a href="#ä¸€æ¬¡æ€§åˆå§‹åŒ–" class="headerlink" title="ä¸€æ¬¡æ€§åˆå§‹åŒ–"></a>ä¸€æ¬¡æ€§åˆå§‹åŒ–</h3><p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼ŒæŸäº›åˆå§‹åŒ–å‡½æ•°è¦æ±‚æ‰§è¡Œä¸€æ¬¡ï¼Œå¹¶ä¸”ä¹Ÿ<strong>åªèƒ½æ‰§è¡Œä¸€æ¬¡</strong>ã€‚æ‰€ä»¥éœ€è¦ä¸€äº›æœºåˆ¶æ¥ä¿è¯ã€‚</p><p>åœ¨<code>pthread</code>åº“ä¸­ï¼Œå®ç°äº†å‡½æ•°<code>pthread_once(once,void (*init)(void)))</code>ï¼Œå…¶ä¸­<code>once</code>æ˜¯ä¸€ä¸ªé™æ€å˜é‡ï¼Œç”¨äºè®°å½•è¯¥åˆå§‹åŒ–æ“ä½œæ˜¯å¦æ‰§è¡Œè¿‡ï¼Œè€Œ<code>init</code>æ˜¯è¿›è¡Œåˆå§‹åŒ–æ“ä½œçš„å‡½æ•°ã€‚</p><p><code>ovs</code>å¯¹æ­¤è¿›è¡Œäº†ä¸€ç‚¹æ‰©å±•ï¼Œæˆ–è€…è¯´å®ç°äº†ä¸€å¥—ç±»ä¼¼çš„æœºåˆ¶ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ovsthread_once</span> &#123;</span></span><br><span class="line">    <span class="type">bool</span> done;               <span class="comment">/* Non-atomic, false negatives possible. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ovs_mutex</span> <span class="title">mutex</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><hr><h2 id="poll-loop"><a href="#poll-loop" class="headerlink" title="poll-loop"></a>poll-loop</h2><blockquote><p>include&#x2F;openvswitch&#x2F;poll-loop.h</p><p>è¿™é‡Œä¹Ÿæ¶‰åŠåˆ°çº¿ç¨‹ä¸€æ¬¡æ€§åˆå§‹åŒ–å’Œçº¿ç¨‹ç‰¹æœ‰æ•°æ®ï¼Œå‚è§ã€ŠLinux-Unixç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹ç¬¬31ç« ã€‚</p></blockquote><hr><h2 id="coverage"><a href="#coverage" class="headerlink" title="coverage"></a>coverage</h2><blockquote><p>lib&#x2F;coverage.h<br>lib&#x2F;coverage.c</p><p><a href="https://segmentfault.com/a/1190000011375770">gcovçš„ä¾‹å­</a></p></blockquote><p><strong>ç»Ÿè®¡ä»£ç è¦†ç›–ç‡</strong>ï¼ˆç”¨äºæ£€æŸ¥æŸæ®µä»£ç æ‰§è¡Œäº†å¤šå°‘æ¬¡ï¼‰ï¼Œå¯ä»¥çœ‹çœ‹<a href="https://segmentfault.com/a/1190000011375770">gcov</a>çš„ä¾‹å­ï¼Œä¸è¿‡<code>OVS</code>ä¸­ä½¿ç”¨çš„<code>coverage</code>å¾ˆè½»é‡çº§ï¼Œè€Œä¸”éœ€è¦ä¸»åŠ¨è°ƒç”¨<code>COVERAGE_INC</code>æ‰èƒ½è¿›è¡Œç»Ÿè®¡ã€‚</p><hr><h2 id="json"><a href="#json" class="headerlink" title="json"></a>json</h2><blockquote><p>include&#x2F;openvswitch&#x2F;json.h<br>lib&#x2F;json.c</p><p><a href="https://www.runoob.com/json/json-syntax.html">JSON è¯­æ³•</a></p></blockquote><p><strong>JSON çš„ä¸¤ç§ç»“æ„</strong>ï¼š</p><p><strong>1ã€å¯¹è±¡ï¼š</strong>å¤§æ‹¬å· <strong>{}</strong> ä¿å­˜çš„å¯¹è±¡æ˜¯ä¸€ä¸ªæ— åºçš„<strong>åç§°&#x2F;å€¼</strong>å¯¹é›†åˆã€‚ä¸€ä¸ªå¯¹è±¡ä»¥å·¦æ‹¬å· <strong>{</strong> å¼€å§‹ï¼Œ å³æ‹¬å· <strong>}</strong> ç»“æŸã€‚æ¯ä¸ªâ€é”®â€åè·Ÿä¸€ä¸ªå†’å· <strong>:<strong>ï¼Œ</strong>åç§°&#x2F;å€¼</strong>å¯¹ä½¿ç”¨é€—å· <strong>,</strong> åˆ†éš”ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;èœé¸Ÿæ•™ç¨‹&quot;</span> <span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;www.runoob.com&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><strong>2ã€æ•°ç»„ï¼š</strong>ä¸­æ‹¬å· <strong>[]</strong> ä¿å­˜çš„æ•°ç»„æ˜¯å€¼ï¼ˆvalueï¼‰çš„æœ‰åºé›†åˆã€‚ä¸€ä¸ªæ•°ç»„ä»¥å·¦ä¸­æ‹¬å· <strong>[</strong> å¼€å§‹ï¼Œ å³ä¸­æ‹¬å· <strong>]</strong> ç»“æŸï¼Œå€¼ä¹‹é—´ä½¿ç”¨é€—å· <strong>,</strong> åˆ†éš”ã€‚</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;sites&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;èœé¸Ÿæ•™ç¨‹&quot;</span> <span class="punctuation">,</span> <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;www.runoob.com&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;google&quot;</span> <span class="punctuation">,</span> <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;www.google.com&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;å¾®åš&quot;</span> <span class="punctuation">,</span> <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span><span class="string">&quot;www.weibo.com&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª<code>json</code>å¯¹è±¡ä¸­ï¼Œæ•°æ®æ˜¯ä»¥<code>key:value</code>çš„å½¢å¼å­˜åœ¨çš„ï¼Œ<code>key</code>æ€»æ˜¯å­—ç¬¦ä¸²<code>&quot;string&quot;</code>ï¼Œ<code>value</code>æ˜¯å¯ä»¥åµŒå¥—çš„ï¼Œå¯ä»¥æ˜¯ï¼š</p><ul><li>æ•°å­—ï¼ˆæ•´æ•°æˆ–æµ®ç‚¹æ•°ï¼‰<code>&quot;key&quot; : 3.14</code></li><li>å­—ç¬¦ä¸²ï¼ˆåœ¨åŒå¼•å·ä¸­ï¼‰<code>&quot;key&quot; : &quot;value&quot;</code></li><li>é€»è¾‘å€¼ï¼ˆtrue æˆ– falseï¼‰<code>&quot;key&quot; : true</code></li><li>æ•°ç»„ï¼ˆåœ¨ä¸­æ‹¬å·ä¸­ï¼Œå¤šä¸ª<code>value</code>ï¼‰<code>&quot;key&quot; : [3.14, 6, 7, 8]</code></li><li>å¯¹è±¡ï¼ˆåœ¨å¤§æ‹¬å·ä¸­ï¼‰<code>&quot;key&quot; : &#123; &quot;subkey&quot;: &quot;subvalue&quot; &#125;</code></li><li>null, <code>&quot;key&quot; : null</code></li></ul><p>åœ¨<code>ovs</code>ä¸­ï¼Œ<code>json</code>çš„<code>value</code>çš„ç»“æ„ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* A JSON value. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">json</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">json_type</span> <span class="title">type</span>;</span></span><br><span class="line">    <span class="type">size_t</span> count;  <span class="comment">/* typeä¸ºobjectæ—¶ï¼Œè¡¨ç¤ºå¯¹è±¡ä¸­é”®å€¼å¯¹çš„ä¸ªæ•°ï¼Œå…¶ä»–ç±»å‹æ—¶count=1 */</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">shash</span> *<span class="title">object</span>;</span>   <span class="comment">/* Contains &quot;struct json *&quot;s. */</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">json_array</span> <span class="title">array</span>;</span></span><br><span class="line">        <span class="type">long</span> <span class="type">long</span> <span class="type">int</span> integer;</span><br><span class="line">        <span class="type">double</span> real;</span><br><span class="line">        <span class="type">char</span> *<span class="built_in">string</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>value</code>åªå¯èƒ½æ˜¯ä¸Šé¢åˆ—ä¸¾çš„å‡ ç§ç±»å‹ä¹‹ä¸€ï¼Œå› æ­¤è¿™é‡Œç”¨<code>union</code>ç»“æ„ã€‚å¹¶é€šè¿‡<code>json_type</code>æŒ‡ç¤º<code>value</code>çš„ç±»å‹ï¼Œä»è€Œè¿›è¡Œä¸åŒçš„æ“ä½œã€‚å¦å¤–ï¼Œå¯¹äºé€»è¾‘å€¼<code>true/false</code>ä»¥åŠ<code>null</code>ï¼Œåªéœ€è¦ç”¨<code>json_type</code>å°±è¶³ä»¥è¯´æ˜ï¼Œå› æ­¤<code>union</code>ä¸­å¹¶ä¸å­˜åœ¨è¿™ä¸‰è€…çš„æˆå‘˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Type of a JSON value. */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">json_type</span> &#123;</span></span><br><span class="line">    JSON_NULL,                  <span class="comment">/* null */</span></span><br><span class="line">    JSON_FALSE,                 <span class="comment">/* false */</span></span><br><span class="line">    JSON_TRUE,                  <span class="comment">/* true */</span></span><br><span class="line">    JSON_OBJECT,                <span class="comment">/* &#123;&quot;a&quot;: b, &quot;c&quot;: d, ...&#125; */</span></span><br><span class="line">    JSON_ARRAY,                 <span class="comment">/* [1, 2, 3, ...] */</span></span><br><span class="line">    JSON_INTEGER,               <span class="comment">/* 123. */</span></span><br><span class="line">    JSON_REAL,                  <span class="comment">/* 123.456. */</span></span><br><span class="line">    JSON_STRING,                <span class="comment">/* &quot;...&quot; */</span></span><br><span class="line">    JSON_N_TYPES                <span class="comment">/* æ²¡æœ‰å®ç° */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>json</code>æ•°ç»„ä¸­å­˜å‚¨çš„å€¼ä¹Ÿéƒ½æ˜¯ä¸€ä¸ª<code>value</code>ï¼Œåˆ†é…å†…å­˜é‡‡ç”¨äº†<code>c++</code>ä¸­<code>vector</code>è¿™äº›å®¹å™¨ç±»ä¼¼çš„ç­–ç•¥ï¼Œå…ˆé¢„åˆ†é…<code>n_allocated</code>å¤§å°çš„å®¹é‡ï¼Œå½“å®é™…åœ¨ä½¿ç”¨çš„æ•°é‡<code>n</code>å˜å¤§åï¼Œå†æ‰©å®¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* A JSON array. */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">json_array</span> &#123;</span></span><br><span class="line">    <span class="type">size_t</span> n, n_allocated;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">json</span> **<span class="title">elems</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œåˆ†æçš„éƒ½æ˜¯<code>value</code>ï¼Œ<code>json</code>å¯¹è±¡é‡Œé¢ä¸è¿˜æœ‰å­—ç¬¦ä¸²<code>key</code>å—ï¼Ÿ</strong>å…¶å®å·²ç»çœ‹åˆ°äº†ï¼Œåªæ˜¯æ¯”è¾ƒéšè”½ã€‚</p><p>åœ¨ä¸Šé¢çš„<code>union</code>ä¸­ï¼Œ<code>json</code>å¯¹è±¡æ˜¯ç”¨<code>struct shash *object;</code>è¡¨ç¤ºï¼Œè€Œ<code>shash</code>ï¼ˆçœ‹çœ‹å‰é¢ï¼‰æ˜¯*<em>a map from string(char <em>name) to</em></em> <code>void *data</code>ï¼Œè¿™é‡Œçš„<code>name</code>å°±æ˜¯<code>key</code>ï¼Œ<code>data</code>å½“ç„¶å°±æ˜¯æŒ‡å‘<code>struct json</code>äº†ã€‚</p><p><strong>åˆ›å»º</strong><code>value</code>ï¼š</p><blockquote><p>è¿™é‡Œéƒ½æ˜¯å‡ ç§<code>value</code>ï¼Œä¸¥æ ¼æ¥è¯´å®ƒå¹¶ä¸æ˜¯<code>json</code>å¯¹è±¡ã€‚å› ä¸ºå®ƒ<strong>ä¸èƒ½å•ç‹¬å­˜åœ¨</strong>ï¼Œæ²¡æœ‰<code>key</code>ï¼ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_null_create</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_boolean_create</span><span class="params">(<span class="type">bool</span>)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_string_create</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *)</span>; <span class="comment">/* ä¼šå¤åˆ¶ä¼ å…¥çš„å­—ç¬¦ä¸² */</span></span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_string_create_nocopy</span><span class="params">(<span class="type">char</span> *)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_integer_create</span><span class="params">(<span class="type">long</span> <span class="type">long</span> <span class="type">int</span>)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_real_create</span><span class="params">(<span class="type">double</span>)</span>;</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º<code>array</code>ç±»å‹çš„<code>json</code>å¯¹è±¡</strong>ï¼š</p><blockquote><p>è¿™å°±æ˜¯å‰é¢æåˆ°çš„<code>json</code>çš„ä¸¤ç§ç»“æ„ä¹‹ä¸€ï¼šæ•°ç»„ã€‚å¯ä»¥å•ç‹¬å­˜åœ¨ï¼Œå“ªæ€•æ˜¯ä¸€ä¸ªç©ºçš„ï¼Œåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure><p>å¦‚æœå…¶ä¸­æœ‰å¯¹è±¡ï¼ˆä¸æ˜¯ä¸Šé¢çš„<code>value</code>ï¼‰ï¼Œåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;key1&quot;</span><span class="punctuation">:</span> <span class="string">&quot;value1&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span><span class="attr">&quot;key2&quot;</span><span class="punctuation">:</span> <span class="number">3.14</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªç©ºçš„ array å¯¹è±¡ */</span></span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_array_create_empty</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">/* å‘æŒ‡å®šçš„ array å¯¹è±¡ä¸­æ’å…¥ä¸€ä¸ªæˆå‘˜elementï¼å¹¶ä¸ä¼šæ‹·è´element */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">json_array_add</span><span class="params">(<span class="keyword">struct</span> json *, <span class="keyword">struct</span> json *element)</span>;</span><br><span class="line"><span class="comment">/* å¦‚æœåˆ†é…çš„ç©ºé—´å¤§å°n_allocated &gt; n, å°±æ”¶ç¼©åˆ° n */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">json_array_trim</span><span class="params">(<span class="keyword">struct</span> json *)</span>;</span><br><span class="line"><span class="comment">/* elementsæ˜¯jsonå¯¹è±¡æ•°ç»„ï¼Œé•¿åº¦ä¸ºnï¼Œåˆ›å»ºä¸€ä¸ªarrayå¯¹è±¡æ¥å­˜å‚¨elementsï¼Œä¸ä¼šè¿›è¡Œæ‹·è´ï¼Œn_allocated=n */</span></span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_array_create</span><span class="params">(<span class="keyword">struct</span> json **elements, <span class="type">size_t</span> n)</span>;</span><br><span class="line"><span class="comment">/* ä¸‹é¢ä¸‰ä¸ªå‡½æ•°ç±»ä¼¼ï¼Œä¼ å…¥å‚æ•°å°±æ˜¯åˆ›å»ºçš„arrayå¯¹è±¡ä¸­çš„æˆå‘˜ï¼Œn_allocatedå’Œnå°±æ˜¯ä¼ å…¥å‚æ•°çš„æ•°é‡ */</span></span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_array_create_1</span><span class="params">(<span class="keyword">struct</span> json *)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_array_create_2</span><span class="params">(<span class="keyword">struct</span> json *, <span class="keyword">struct</span> json *)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_array_create_3</span><span class="params">(<span class="keyword">struct</span> json *, <span class="keyword">struct</span> json *, <span class="keyword">struct</span> json *)</span>;</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º<code>object</code>ç±»å‹çš„<code>json</code>å¯¹è±¡</strong>ï¼š</p><blockquote><p>è¿™æ˜¯<code>json</code>çš„å¦ä¸€ç§ç»“æ„ï¼Œä¸€ä¸ªå®Œæ•´çš„å¯¹è±¡ï¼å¦‚æœä¸ºç©ºï¼Œåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>æ’å…¥æˆå‘˜åï¼Œåºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²ä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;key1&quot;</span><span class="punctuation">:</span><span class="string">&quot;value1&quot;</span> <span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;key2&quot;</span><span class="punctuation">:</span> <span class="number">3.14</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºä¸€ä¸ªç©ºçš„ json object å¯¹è±¡ï¼Œæ˜¯ä¸€ä¸ªshashç»“æ„ï¼ */</span></span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_object_create</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">/* å‘ object ä¸­æ’å…¥ä¸€ä¸ªé”®å€¼å¯¹ï¼Œé”®ä¸ºnameï¼Œå€¼ä¸ºä¸€ä¸ªjson value.</span></span><br><span class="line"><span class="comment"> * å¦‚æœè¯¥objectä¸­å·²ç»å­˜åœ¨è¯¥nameï¼Œåˆ™ä¼šç”¨æ–°çš„valueæ›¿æ¢æ—§çš„ï¼Œå¹¶freeæ—§çš„value</span></span><br><span class="line"><span class="comment"> * nameä¼šè¢«æ‹·è´ï¼Œvalueä¸ä¼š */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">json_object_put</span><span class="params">(<span class="keyword">struct</span> json *object, <span class="type">const</span> <span class="type">char</span> *name, <span class="keyword">struct</span> json *value)</span>;</span><br><span class="line"><span class="comment">/* åŒä¸Šï¼Œä½†nameä¹Ÿä¸ä¼šè¢«æ‹·è´ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">json_object_put_nocopy</span><span class="params">(<span class="keyword">struct</span> json *, <span class="type">char</span> *name, <span class="keyword">struct</span> json *value)</span>;</span><br><span class="line"><span class="comment">/* æ’å…¥ä¸€ä¸ªå€¼ä¸ºå­—ç¬¦ä¸²çš„jsonå€¼ï¼Œæ˜¯åŸºäºä¼ å…¥å‚æ•°valueåˆ›å»º */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">json_object_put_string</span><span class="params">(<span class="keyword">struct</span> json *,</span></span><br><span class="line"><span class="params">                            <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *value)</span>;</span><br><span class="line"><span class="comment">/* åŒä¸Šï¼Œåªä¸è¿‡å­—ç¬¦ä¸²æ˜¯é‡‡ç”¨ç±»ä¼¼äºprintfçš„æ–¹å¼æ ¼å¼åŒ–å¾—åˆ°çš„ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">json_object_put_format</span><span class="params">(<span class="keyword">struct</span> json *,</span></span><br><span class="line"><span class="params">                            <span class="type">const</span> <span class="type">char</span> *name, <span class="type">const</span> <span class="type">char</span> *format, ...)</span></span><br><span class="line">    <span class="title function_">OVS_PRINTF_FORMAT</span><span class="params">(<span class="number">3</span>, <span class="number">4</span>)</span>;</span><br></pre></td></tr></table></figure><p><strong>åˆ›å»º<code>json</code>å¯¹è±¡çš„å…¶ä»–æ–¹å¼</strong>ï¼šå‡½æ•°åå·²ç»è¯´å¾—å¾ˆæ¸…æ¥šäº†ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_from_string</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_from_file</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file_name)</span>;</span><br><span class="line"><span class="keyword">struct</span> json *<span class="title function_">json_from_stream</span><span class="params">(FILE *stream)</span>;</span><br></pre></td></tr></table></figure><p>è¿˜æä¾›äº†ä¸€äº›å…¶ä»–æœ‰ç”¨çš„æ–¹æ³•ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* å°†typeè½¬ä¸ºå­—ç¬¦ä¸²å¹¶è¿”å›ï¼Œæ³¨æ„æ˜¯ const char *ï¼Œä¸èƒ½ä¿®æ”¹å­—ç¬¦ä¸²çš„å†…å®¹ */</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">json_type_to_string</span><span class="params">(<span class="keyword">enum</span> json_type)</span>;</span><br></pre></td></tr></table></figure><blockquote><p><strong>const char *<strong>ä¸</strong>char const *</strong> æ•ˆæœä¸€æ ·ï¼Œéƒ½æ˜¯ä¸å…è®¸ä¿®æ”¹æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ç©ºé—´çš„å€¼ï¼Œå³æŠŠå€¼ä½œä¸ºå¸¸é‡ï¼Œè€Œ<strong>char * const</strong>åˆ™æ˜¯ä¸å…è®¸ä¿®æ”¹æŒ‡é’ˆè‡ªèº«ï¼Œä¸èƒ½å†æŒ‡å‘å…¶ä»–åœ°æ–¹ï¼ŒæŠŠæŒ‡é’ˆè‡ªå·±å½“ä½œå¸¸é‡ä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨<strong>char * const</strong> å®šä¸€ä¸ªå¸¸é‡æŒ‡é’ˆçš„æ—¶å€™ä¸€å®šè®°å¾—èµ‹åˆå§‹å€¼ï¼Œå¦åˆ™å†å…¶ä»–åœ°æ–¹å°±æ²¡æ³•èµ‹å€¼äº†ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* æ‹¿jsonå®ä¾‹è®¡ç®—hashå€¼ï¼Œè¯¥å®ä¾‹å¯ä»¥æ˜¯ä¸Šé¢çš„ä»»ä½•enum json_type */</span></span><br><span class="line"><span class="type">size_t</span> <span class="title function_">json_hash</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> json *, <span class="type">size_t</span> basis)</span>;</span><br><span class="line"><span class="comment">/* åˆ¤æ–­ä¸¤ä¸ªjsonå¯¹è±¡æ˜¯å¦ç›¸ç­‰ï¼Œä¹ŸåŒºåˆ†ç±»å‹ï¼Œå¦‚æœæ˜¯ç®€å•ç±»å‹ï¼Œæ•´æ•°ã€å®æ•°ï¼Œ</span></span><br><span class="line"><span class="comment"> * å°±åˆ¤æ–­å€¼æ˜¯å¦ç›¸ç­‰ã€‚å¦‚æœæ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå°±é€šè¿‡ strcmp è¿›è¡Œæ¯”è¾ƒã€‚</span></span><br><span class="line"><span class="comment"> * å¦‚æœæ˜¯objectæˆ–arrayï¼Œç”±äºå€¼å¯ä»¥åµŒå¥—ï¼Œæ‰€ä»¥æ¯”è¾ƒæ—¶ä¹Ÿè¦åµŒå¥—åœ°è°ƒç”¨ json_equal è¿›è¡Œæ¯”è¾ƒ */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">json_equal</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> json *, <span class="type">const</span> <span class="keyword">struct</span> json *)</span>;</span><br></pre></td></tr></table></figure><hr>]]></content>
      
      
      <categories>
          
          <category> OpenVSwitch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> OpenVSwitch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è§£æå‘½ä»¤è¡Œé€‰é¡¹</title>
      <link href="/2022/10/05/Linux%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9/"/>
      <url>/2022/10/05/Linux%E8%A7%A3%E6%9E%90%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%80%89%E9%A1%B9/</url>
      
        <content type="html"><![CDATA[<p>æ”¯æŒçŸ­é€‰é¡¹å’Œé•¿é€‰é¡¹ï¼</p><ul><li><strong>çŸ­é€‰é¡¹</strong>ï¼šå½¢å¦‚<code>-a</code>ï¼Œ<code>-v</code>ï¼Œä»¥<code>-</code>åŠ å•ä¸ªå­—ç¬¦ç»„æˆã€‚<code>-</code>å«åšé€‰é¡¹æ ‡è¯†ç¬¦ï¼Œé€‰é¡¹æ ‡è¯†ç¬¦åé¢å¯ä»¥ç´§è·Ÿä¸€ä¸ªå­—ç¬¦ï¼Œè¿™ä¸ªå­—ç¬¦å«åš<strong>é€‰é¡¹å­—ç¬¦</strong>ã€‚é€‰é¡¹å­—ç¬¦åé¢å¯ä»¥<strong>ç´§è·Ÿ</strong>ä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ï¼Œè¿™äº›å­—ç¬¦å«åš<strong>é€‰é¡¹å‚æ•°</strong>ã€‚å¦‚<code>-lpthread</code>é€‰é¡¹å­—ç¬¦ä¸º<code>l</code>ï¼Œå‚æ•°ä¸º<code>pthread</code>ã€‚</li><li><strong>é•¿é€‰é¡¹</strong>ï¼šå½¢å¦‚<code>--all</code>ï¼Œ<code>--version</code>ï¼Œä»¥<code>--</code>åŠ ä¸€ä¸ªå•è¯ç»„æˆï¼Œç”¨<code>=</code>è·Ÿå‚æ•°ã€‚å¦‚<code>--data=format</code>é€‰é¡¹ä¸º<code>data</code>ï¼Œå‚æ•°ä¸º<code>format</code>ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-lpthread -d format</span><br><span class="line">--data=format</span><br></pre></td></tr></table></figure><h2 id="çŸ­é€‰é¡¹è§£æ-getopt"><a href="#çŸ­é€‰é¡¹è§£æ-getopt" class="headerlink" title="çŸ­é€‰é¡¹è§£æ getopt()"></a>çŸ­é€‰é¡¹è§£æ <code>getopt()</code></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getopt</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">           <span class="type">const</span> <span class="type">char</span> *optstring)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> *optarg;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> optind, opterr, optopt;</span><br></pre></td></tr></table></figure><ul><li><code>argc, argv</code>ä¸º<code>main</code>å‡½æ•°å‚æ•°ä¸­çš„<code>argc, argv</code>ï¼Œä»£è¡¨å‘½ä»¤è¡Œå‚æ•°ï¼</li><li><code>optstring</code>ä¸º</li><li><code>optind</code>ä¸º<code>argv</code>ä¸­ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„é€‰é¡¹ä¸‹æ ‡ã€‚é»˜è®¤å€¼ä¸º1ï¼Œå½“ç„¶å¦‚æœè¦é‡æ–°è§£æ<code>argv</code>ï¼Œå¯ä»¥æ‰‹åŠ¨é‡ç½®å…¶ä¸º1ã€‚</li></ul><h2 id="é•¿å‘½ä»¤"><a href="#é•¿å‘½ä»¤" class="headerlink" title="é•¿å‘½ä»¤"></a>é•¿å‘½ä»¤</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">parse_client_options</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">        OPT_SRCIP = <span class="number">256</span>,</span><br><span class="line">        OPT_DSTIP,</span><br><span class="line">        OPT_SRCPORT,</span><br><span class="line">        OPT_DSTPORT</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// : é€‰é¡¹åé¢å¿…é¡»æœ‰å‚æ•°</span></span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> *short_options = <span class="string">&quot;hp:t:s:n:i:b:&quot;</span>;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">long_options</span>[] =</span> &#123;</span><br><span class="line">        &#123;<span class="string">&quot;help&quot;</span>,      no_argument,       <span class="literal">NULL</span>, <span class="string">&#x27;h&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;srcip&quot;</span>,     required_argument, <span class="literal">NULL</span>, OPT_SRCIP &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;dstip&quot;</span>,     required_argument, <span class="literal">NULL</span>, OPT_DSTIP &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;srcport&quot;</span>,   required_argument, <span class="literal">NULL</span>, OPT_SRCPORT &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;dstport&quot;</span>,   required_argument, <span class="literal">NULL</span>, OPT_DSTPORT &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;proto&quot;</span>,     required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;p&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;tos&quot;</span>,       required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;t&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;pktsize&quot;</span>,   required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;s&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;interval&quot;</span>,  required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;i&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;bandwidth&quot;</span>, required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;b&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;pktnums&quot;</span>,   required_argument, <span class="literal">NULL</span>, <span class="string">&#x27;n&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0</span>,         <span class="number">0</span>,                 <span class="number">0</span>,  <span class="number">0</span> &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line">    <span class="keyword">while</span>((opt = getopt_long_only(</span><br><span class="line">                 argc, argv, short_options, long_options, <span class="literal">NULL</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>: client_help_info(); <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">                pkts.proto = atoi(optarg);</span><br><span class="line">                <span class="keyword">if</span> (pkts.proto != TCP &amp;&amp; pkts.proto != UDP) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;å‚æ•°é”™è¯¯: %dï¼Œåªèƒ½ä¸ºTCP(6)/UDP(17)\n&quot;</span>, pkts.proto);</span><br><span class="line">                    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>: pkts.tos = atoi(optarg); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                pkts.pktsize = atoi(optarg);</span><br><span class="line">                <span class="keyword">if</span> (pkts.pktsize &lt; <span class="number">64</span> || pkts.pktsize &gt; <span class="number">1500</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;æ•°æ®åŒ…å¤§å°åº”è¯¥åœ¨[64, 1500]çš„èŒƒå›´å†…\n&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>: pkts.pktnums = atoi(optarg); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>: pkts.interval = atoi(optarg); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>: pkts.bandwidth = atoi(optarg); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OPT_SRCIP: <span class="built_in">strncpy</span>(pkts.srcip, optarg, <span class="number">16</span>); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OPT_DSTIP: <span class="built_in">strncpy</span>(pkts.dstip, optarg, <span class="number">16</span>); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OPT_SRCPORT: pkts.srcport = atoi(optarg); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OPT_DSTPORT: pkts.dstport = atoi(optarg); <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                client_help_info();</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çŸ­å‘½ä»¤-only"><a href="#çŸ­å‘½ä»¤-only" class="headerlink" title="çŸ­å‘½ä»¤ only"></a>çŸ­å‘½ä»¤ only</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * è§£æå‘½ä»¤è¡Œå‚æ•°å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">parse_args</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> &#123;</span><br><span class="line">    <span class="type">int</span> opt;</span><br><span class="line"></span><br><span class="line">    mdelay = <span class="number">1000000</span>;      <span class="comment">// é»˜è®¤åˆ·æ–°ç‡ä¸º1ç§’</span></span><br><span class="line">    x1 = <span class="number">0</span>;                <span class="comment">// é»˜è®¤åŒºåŸŸä¸ºå…¨å±</span></span><br><span class="line">    x2 = vinfo.xres - <span class="number">1</span>;</span><br><span class="line">    y1 = <span class="number">0</span>;</span><br><span class="line">    y2 = vinfo.yres - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((opt = getopt(argc, argv, <span class="string">&quot;hrsd:m:x:y:&quot;</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (opt) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>: <span class="comment">// å…¨å±åˆ·æ–°æ ‡å¿—</span></span><br><span class="line">                rect = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">                show_fps = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>: <span class="comment">// å¸§é—´éš” ms</span></span><br><span class="line">                mdelay = atoi(optarg) * <span class="number">1000</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">                mode = atoi(optarg);</span><br><span class="line">                <span class="keyword">if</span> (mode &gt; <span class="number">1</span> || mode &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;mode must be 0 or 1\n\n&quot;</span>);</span><br><span class="line">                    help_info();</span><br><span class="line">                    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: <span class="comment">// æŒ‡å®šxåŒºåŸŸ</span></span><br><span class="line">                <span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%d:%d&quot;</span>, &amp;x1, &amp;x2);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;y&#x27;</span>: <span class="comment">// æŒ‡å®šyåŒºåŸŸ</span></span><br><span class="line">                <span class="built_in">sscanf</span>(optarg, <span class="string">&quot;%d:%d&quot;</span>, &amp;y1, &amp;y2);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;y1, y2: %d, %d\n&quot;</span>, y1, y2);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>: <span class="comment">// FALLTHROUGH</span></span><br><span class="line">            <span class="keyword">default</span>: <span class="comment">/* &#x27;?&#x27; */</span></span><br><span class="line">                help_info();</span><br><span class="line">                <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–èµ„æ–™"><a href="#å…¶ä»–èµ„æ–™" class="headerlink" title="å…¶ä»–èµ„æ–™"></a>å…¶ä»–èµ„æ–™</h2><ul><li><a href="https://www.cnblogs.com/liwei0526vip/p/4873111.html">getoptä¾‹å­</a></li><li><a href="https://blog.csdn.net/liao20081228/article/details/76557548">getoptç³»åˆ—å‡½æ•°</a></li><li><a href="https://blog.csdn.net/Mculover666/article/details/106646339">getopt</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> c </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>C++ä¸‰æ–¹åº“</title>
      <link href="/2022/09/19/Cpp%E4%B8%89%E6%96%B9%E5%BA%93/"/>
      <url>/2022/09/19/Cpp%E4%B8%89%E6%96%B9%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<h2 id="fmt"><a href="#fmt" class="headerlink" title="fmt"></a>fmt</h2><p>æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œå¥½åƒå·²ç»çº³å…¥C++20æ ‡å‡†åº“ï¼Œä½¿ç”¨å¾ˆæ–¹ä¾¿ï¼è€Œä¸”è¯´æ˜¯æ¯”<code>printf</code>è¿˜å¿«~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/fmtlib/fmt.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">fmt</span>/</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j</span><br><span class="line"></span><br><span class="line">sudo make install</span><br><span class="line"><span class="comment"># g++ test.cpp -o debug -lfmt</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/fmtlib/fmt">github ä»“åº“ï¼ŒREADMEä¸­æ–‡æ¡£ä¹Ÿè¾ƒè¯¦ç»†ã€ä½¿ç”¨ç®€å•</a></p><p><a href="https://hackingcpp.com/cpp/libs/fmt.html">å®˜æ–¹æ–‡æ¡£ã€æœ‰ä»£ç ç¤ºä¾‹</a></p></blockquote><h2 id="fmtlog"><a href="#fmtlog" class="headerlink" title="fmtlog"></a>fmtlog</h2><p>åŸºäº<code>fmt</code>çš„æ—¥å¿—åº“ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„ä»¥<code>fmt</code>çš„æ–¹å¼æ ¼å¼åŒ–æ—¥å¿—è¾“å‡ºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/MengRao/fmtlog.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> fmtlog</span><br><span class="line">git submodule init</span><br><span class="line">git submodule update</span><br><span class="line">./build.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># g++ test.cpp -o debug -lfmt -lfmtlog-static # å¥½åƒåªèƒ½ä½¿ç”¨é™æ€åº“</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/MengRao/fmtlog">å®˜æ–¹ä»“åº“ï¼Œä¹Ÿåªæœ‰è¿™é‡Œçš„READMEä½œä¸ºå®˜æ–¹æ–‡æ¡£</a></p></blockquote><h2 id="spdlog"><a href="#spdlog" class="headerlink" title="spdlog"></a>spdlog</h2><p>åŒæ ·æ”¯æŒ<code>fmt</code>æ ¼å¼è¾“å‡ºçš„æ—¥å¿—åº“ï¼Œç›¸å¯¹æ›´æˆç†Ÿä¸€ç‚¹ã€‚</p><p><a href="https://zhuanlan.zhihu.com/p/427038912">https://zhuanlan.zhihu.com/p/427038912</a></p><p><a href="https://www.modb.pro/db/251872">https://www.modb.pro/db/251872</a></p><h2 id="hiredis"><a href="#hiredis" class="headerlink" title="hiredis"></a>hiredis</h2><p><code>C</code>è¯­è¨€ç‰ˆæœ¬çš„<code>Redis Client</code>ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/redis/hiredis.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> hiredis</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">sudo make install</span><br><span class="line"><span class="comment"># g++ test.cpp -o debug -lhiredis</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/redis/hiredis">å®˜æ–¹ä»“åº“ï¼Œä¹Ÿåªæœ‰è¿™é‡Œçš„READMEä½œä¸ºå®˜æ–¹æ–‡æ¡£</a></p><p><a href="https://github.com/redis/hiredis/blob/79ae5ffc693b57688b4c76141fd2c94868ebdbff/hiredis.h#L305">hiredis.h å¤´æ–‡ä»¶ï¼Œå¯ä»¥çœ‹ redis çš„API</a></p><p><a href="https://tangming.github.io/2019/10/14/redis-hiredis-introduction/">åˆ«äººç¿»è¯‘çš„å®˜æ–¹æ–‡æ¡£ï¼Œä¾›å‚è€ƒ</a></p></blockquote><p>Hiredisæä¾›äº†åŒæ­¥ã€å¼‚æ­¥ä»¥åŠå›å¤è§£æä¸‰ç§APIã€‚</p><h3 id="åŒæ­¥API"><a href="#åŒæ­¥API" class="headerlink" title="åŒæ­¥API"></a>åŒæ­¥API</h3><p>è¦ä½¿ç”¨åŒæ­¥ APIï¼Œåªéœ€è¦å¼•å…¥å‡ ä¸ªå‡½æ•°è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¸¤ä¸ªé‡è¦ç»“æ„ä½“ */</span></span><br><span class="line">redisContext *ctx;  <span class="comment">// è¿æ¥ä¸Šä¸‹æ–‡ï¼Œå»ºç«‹è¿æ¥æ—¶åˆ›å»º</span></span><br><span class="line">redisReply *reply;  <span class="comment">// redisCommandè¿”å›å€¼ï¼Œæ³¨æ„é‡Šæ”¾å†…å­˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* å’ŒredisæœåŠ¡å™¨å»ºç«‹TCPè¿æ¥ */</span></span><br><span class="line">redisContext *<span class="title function_">redisConnect</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ip, <span class="type">int</span> port)</span>;</span><br><span class="line">redisContext *<span class="title function_">redisConnectWithTimeout</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ip, <span class="type">int</span> port, <span class="type">const</span> <span class="keyword">struct</span> timeval tv)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å‘é€æŒ‡ä»¤åˆ°redisæœåŠ¡å™¨ï¼Œå¹¶å–å¾—ç»“æœ */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">redisCommand</span><span class="params">(redisContext *c, <span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">redisCommandArgv</span><span class="params">(redisContext *c, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">size_t</span> *argvlen)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* é‡Šæ”¾å†…å­˜ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">freeReplyObject</span><span class="params">(<span class="type">void</span> *reply)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">redisFree</span><span class="params">(redisContext *c)</span>;    <span class="comment">// æ–­å¼€è¿æ¥ï¼Œå…³é—­å¥—æ¥å­—</span></span><br></pre></td></tr></table></figure><h4 id="redisConnect"><a href="#redisConnect" class="headerlink" title="redisConnect"></a>redisConnect</h4><p><code>Hiredis</code>é€šè¿‡<code>redisConnect</code>åˆ›å»ºä¸€ä¸ª<code>redisContext</code>æ¥å®ç°ä¸<code>Redis</code>è¿›è¡Œè¿æ¥ï¼Œ<code>context</code>ä¸­åŒ…å«äº†è¿æ¥çš„ä¿¡æ¯ã€‚<code>redisContext</code>ä¸­åŒ…å«æœ‰ä¸€ä¸ªæ•´å½¢çš„<code>err</code>å˜é‡å’Œä¸€ä¸ªå­—ç¬¦ç±»å‹çš„<code>errstr</code>å˜é‡ï¼Œå½“åˆ›å»ºè¿æ¥å¤±è´¥ï¼Œ<code>err</code>ä¸ºéé›¶å€¼ï¼Œ<code>errstr</code>ä¸ºé”™è¯¯çš„è¡¨è¿°ã€‚<strong>å½“ä½¿ç”¨<code>redisConnect</code>åˆ›å»ºè¿æ¥åï¼Œåº”è¯¥æ£€æŸ¥<code>err</code>å‚æ•°ä»¥åˆ¤æ–­è¿æ¥æ˜¯å¦æˆåŠŸ</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">redisContext *c = redisConnect(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>);</span><br><span class="line"><span class="keyword">if</span> (c == <span class="literal">NULL</span> || c-&gt;err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (c) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Error: %s\n&quot;</span>, c-&gt;errstr);</span><br><span class="line">        <span class="comment">// handle error</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Can&#x27;t allocate redis context\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä½¿ç”¨ timeout */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span> =</span> &#123;<span class="number">2</span>, <span class="number">0</span>&#125;;    <span class="comment">// &#123;s, us&#125;;</span></span><br><span class="line">redisContext *c = redisConnectWithTimeout(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>, timeout);</span><br></pre></td></tr></table></figure><h4 id="redisCommand"><a href="#redisCommand" class="headerlink" title="redisCommand"></a>redisCommand</h4><p>ç»™æ•°æ®åº“å‘é€æŒ‡ä»¤ï¼ŒæŒ‡ä»¤ä¸é€šè¿‡<code>redis-cli</code>ä½¿ç”¨æ—¶ä¸€è‡´~</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">reply = redisCommand(context, <span class="string">&quot;SET foo bar&quot;</span>);</span><br><span class="line">reply = redisCommand(context, <span class="string">&quot;SET foo %s&quot;</span>, value)</span><br><span class="line">reply = redisCommand(context, <span class="string">&quot;SET foo:%s %s&quot;</span>, key, value);</span><br><span class="line">reply = redisCommand(context, <span class="string">&quot;GET key&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ³¨æ„æ¯æ¬¡è°ƒç”¨ redisCommand éƒ½éœ€è¦ free(reply) */</span></span><br><span class="line">freeReplyObject(reply);</span><br></pre></td></tr></table></figure><h4 id="redisCommandArgv"><a href="#redisCommandArgv" class="headerlink" title="redisCommandArgv"></a>redisCommandArgv</h4><p>æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// argv: å‘½ä»¤å­—ç¬¦ä¸²æ•°ç»„ï¼Œ &#123;&quot;SET FOO 1&quot;, &quot;GET FOO&quot;, &quot;SET FOO 2&quot;, &quot;GET FOO&quot;&#125;;</span></span><br><span class="line"><span class="comment">// argc: å‘½ä»¤argvçš„æ•°é‡</span></span><br><span class="line"><span class="comment">// argvlen: agrvä¸­æ¯ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æ•°ç»„ &#123;9, 7, 9, 7&#125;ã€‚argvlenä¸ºNULLæ—¶ï¼Œåˆ™è°ƒç”¨strlenè®¡ç®—é•¿åº¦</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šreply æŒ‡é’ˆï¼Œå’ŒredisCommandä¸€è‡´ã€‚æ³¨æ„æ­¤æ—¶replyä¸­åŒ…å«å¤šä¸ªè¿”å›å€¼ï¼Œä½äºreply-&gt;elementæ•°ç»„ä¸­</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">redisCommandArgv</span><span class="params">(redisContext *c, <span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">size_t</span> *argvlen)</span>;</span><br></pre></td></tr></table></figure><h2 id="redis-plus-plus"><a href="#redis-plus-plus" class="headerlink" title="redis-plus-plus"></a>redis-plus-plus</h2><p>åŸºäº<code>hiredis</code>å®ç°çš„<code>c++</code>ç‰ˆæœ¬çš„<code>redis</code>å®¢æˆ·ç«¯~</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/sewenew/redis-plus-plus.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> redis-plus-plus</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DREDIS_PLUS_PLUS_CXX_STANDARD=17 ..</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">sudo make install</span><br><span class="line"><span class="comment"># g++ test.cpp -o debug -lhiredis -lredis++</span></span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/sewenew/redis-plus-plus">github ä»“åº“ï¼Œå…¶READMEä¸­æœ‰è¾ƒè¯¦ç»†çš„æ–‡æ¡£</a></p></blockquote><h2 id="cpp-httplib"><a href="#cpp-httplib" class="headerlink" title="cpp-httplib"></a>cpp-httplib</h2><p>å¯åˆ›å»º<code>HTTP Server</code>ï¼Œä¹Ÿå¯åˆ›å»º<code>HTTP Client</code>ç”¨äºå‘é€<code>get/post</code>ç­‰è¯·æ±‚ã€‚</p><p>ç›¸å…³æ–¹æ³•å¥½åƒéƒ½åœ¨<code>httplib.h</code>è¿™ä¸ªå¤´æ–‡ä»¶ä¸­ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/yhirose/cpp-httplib.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> cpp-httplib</span><br><span class="line"><span class="built_in">mkdir</span> -p build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -DCMAKE_BUILD_TYPE=Release ..</span><br><span class="line">sudo cmake --build . --target install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¥½åƒåªéœ€è¦å°†httplib.hæ‹·è´åˆ°includeç›®å½•ä¸‹å°±è¡Œ</span></span><br><span class="line">s@ys:build$ sudo cmake --build . --target install</span><br><span class="line">Install the project...</span><br><span class="line">-- Install configuration: <span class="string">&quot;Release&quot;</span></span><br><span class="line">-- Installing: /usr/local/include/httplib.h</span><br><span class="line">-- Installing: /usr/local/lib/cmake/httplib/httplibConfig.cmake</span><br><span class="line">-- Installing: /usr/local/lib/cmake/httplib/httplibConfigVersion.cmake</span><br><span class="line">-- Installing: /usr/local/lib/cmake/httplib/FindBrotli.cmake</span><br><span class="line">-- Installing: /usr/local/lib/cmake/httplib/httplibTargets.cmake</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://github.com/yhirose/cpp-httplib/blob/master/httplib.h">httplib.h ç›´æ¥çœ‹è¯¥æ–‡ä»¶æ‰¾API</a></p><p><a href="https://segmentfault.com/a/1190000022419921">ä¸€ç‚¹è§£è¯»</a></p></blockquote><p>å¸¸ç”¨ç±»å’Œä¸€äº›ç»“æ„ï¼š</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span>;       <span class="comment">// æœåŠ¡ç«¯ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span>;   <span class="comment">// çº¿ç¨‹æ± ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Client</span>;       <span class="comment">// å®¢æˆ·ç«¯ç±»</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Request</span>;     <span class="comment">// è¯·æ±‚æ•°æ®ç±»</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Result</span>;       <span class="comment">// è¯·æ±‚è¿”å›ç±»ï¼ŒåŒ…å« Response</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Response</span>;    <span class="comment">// å“åº”æ•°æ®ç±»</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Result</span> &#123;</span><br><span class="line">    std::unique_ptr&lt;Response&gt; res_;</span><br><span class="line">    Error err_;</span><br><span class="line">    Headers request_headers_;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Response</span> &#123;</span><br><span class="line">    std::string version;</span><br><span class="line">    <span class="type">int</span> status = <span class="number">-1</span>;        <span class="comment">// çŠ¶æ€ä½ï¼Œ200/403...</span></span><br><span class="line">    std::string reason;</span><br><span class="line">    Headers headers;</span><br><span class="line">    std::string body;       <span class="comment">// å“åº” body</span></span><br><span class="line">    std::string location;   <span class="comment">// Redirect location</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å®¢æˆ·ç«¯"><a href="#å®¢æˆ·ç«¯" class="headerlink" title="å®¢æˆ·ç«¯"></a>å®¢æˆ·ç«¯</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;httplib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ›å»ºClientå¯¹è±¡ */</span></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">Client</span><span class="params">(<span class="type">const</span> std::string &amp;scheme_host_port)</span></span>;</span><br><span class="line"><span class="function">httplib::Client <span class="title">cli</span><span class="params">(<span class="string">&quot;http://192.168.1.147:18181&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">explicit</span> <span class="title">Client</span><span class="params">(<span class="type">const</span> std::string &amp;host, <span class="type">int</span> port)</span></span>;</span><br><span class="line"><span class="function">httplib::Client <span class="title">cli</span><span class="params">(<span class="string">&quot;http://192.168.1.147&quot;</span>, <span class="number">18181</span>)</span></span>;</span><br></pre></td></tr></table></figure><h4 id="Getè¯·æ±‚"><a href="#Getè¯·æ±‚" class="headerlink" title="Getè¯·æ±‚"></a>Getè¯·æ±‚</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* get è¯·æ±‚ */</span></span><br><span class="line">httplib::Headers headers = &#123;&#123; <span class="string">&quot;Authorization&quot;</span>, <span class="string">&quot;Basic b25vczpyb2Nrcw==&quot;</span> &#125;&#125;;</span><br><span class="line"></span><br><span class="line">Result <span class="title function_">Get</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;path)</span>;</span><br><span class="line">Result <span class="title function_">Get</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;path, <span class="type">const</span> Headers &amp;headers)</span>;</span><br><span class="line">Result res = cli.Get(<span class="string">&quot;/onos/v1/flows/of:0000000000001111&quot;</span>, headers);</span><br><span class="line"></span><br><span class="line">cli.set_default_headers(headers);   <span class="comment">// è®¾ç½®é»˜è®¤Header</span></span><br><span class="line">Result res = cli.Get(<span class="string">&quot;/onos/v1/flows/of:0000000000001111&quot;</span>);</span><br></pre></td></tr></table></figure><h4 id="è¿”å›å€¼"><a href="#è¿”å›å€¼" class="headerlink" title="è¿”å›å€¼"></a>è¿”å›å€¼</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Result res = cli.Get(<span class="string">&quot;/onos/v1/flows/of:0000000000001111&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Resulté‡è½½äº† bool() å’Œ -&gt;ï¼Œå¯ç›´æ¥ä½¿ç”¨-&gt;è®¿é—®Responseçš„å€¼ */</span></span><br><span class="line"><span class="keyword">if</span> (res) &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; res-&gt;status &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; res-&gt;get_header_value(<span class="string">&quot;Content-Type&quot;</span>) &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; res-&gt;body &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; res.error() &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">auto</span> err = res.error();</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;HTTP error: &quot;</span> &lt;&lt; httplib::to_string(err) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="Postè¯·æ±‚"><a href="#Postè¯·æ±‚" class="headerlink" title="Postè¯·æ±‚"></a>Postè¯·æ±‚</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Result <span class="title function_">Post</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;path)</span>;</span><br><span class="line">Result <span class="title function_">Post</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;path, <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;body,</span></span><br><span class="line"><span class="params">            <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;content_type)</span>;</span><br><span class="line">Result <span class="title function_">Post</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;path, <span class="type">const</span> Headers &amp;headers,</span></span><br><span class="line"><span class="params">            <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;body, <span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span> &amp;content_type)</span>;</span><br></pre></td></tr></table></figure><h2 id="json"><a href="#json" class="headerlink" title="json"></a>json</h2><p>è§£æjsonå­—ç¬¦ä¸²ï¼Œè¿”å›jsonå¯¹è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://github.com/nlohmann/json.git</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> json/</span><br><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake ..</span><br><span class="line">make -j</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><blockquote><p><a href="https://json.nlohmann.me/api/basic_json/">æ–‡æ¡£ API</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> C++ </tag>
            
            <tag> Redis </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç½‘ç»œç¼–ç¨‹-å¹¶å‘æœåŠ¡å™¨</title>
      <link href="/2022/08/02/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
      <url>/2022/08/02/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      
        <content type="html"><![CDATA[<p>å‰é¢<code>socket</code>ä¸­åˆ›å»ºçš„<code>server</code>åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œåªèƒ½è¿æ¥ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚è¦å®ç°å¯åŒæ—¶è¿æ¥å¤šä¸ªå®¢æˆ·ç«¯ï¼Œæœ‰å‡ ç§æ–¹æ³•ï¼š</p><ul><li>ä¸ºæ¯ä¸€ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ª<strong>å­è¿›ç¨‹</strong>å¤„ç†ã€‚</li><li>ä¸ºæ¯ä¸€ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ª<strong>å­çº¿ç¨‹</strong>å¤„ç†ã€‚</li><li>å•çº¿ç¨‹ï¼Œä½†ä½¿ç”¨<code>select, poll, epoll</code>ç­‰ <strong><code>IO</code> å¤ç”¨</strong>ç®—æ³•ã€‚</li></ul><h2 id="å¤šè¿›ç¨‹å¹¶å‘"><a href="#å¤šè¿›ç¨‹å¹¶å‘" class="headerlink" title="å¤šè¿›ç¨‹å¹¶å‘"></a>å¤šè¿›ç¨‹å¹¶å‘</h2><p>æ¯äº§ç”Ÿä¸€ä¸ªè¿æ¥æ—¶ï¼Œå°±åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹å»å¤„ç†ï¼Œçˆ¶è¿›ç¨‹åªè´Ÿè´£ç›‘å¬ä»¥åŠ<strong>å›æ”¶å­è¿›ç¨‹</strong>ï¼</p><p>å›æ”¶å­è¿›ç¨‹ä¸èƒ½æ”¾åœ¨çˆ¶è¿›ç¨‹çš„å¾ªç¯é€»è¾‘ä¸­ï¼Œä¸€ç§åŠæ³•æ˜¯é€šè¿‡æ³¨å†Œä¿¡å·<code>SIGCHLD</code>æ•æ‰å‡½æ•°ï¼Œåœ¨ä¿¡å·å¤„ç†å‡½æ•°ä¸­å®Œæˆå­è¿›ç¨‹å›æ”¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> socket()             <span class="comment">// åˆ›å»ºç›‘å¬å¥—æ¥å­— lfd</span></span><br><span class="line"><span class="number">2.</span> bind()</span><br><span class="line"><span class="number">3.</span> listen()</span><br><span class="line"><span class="number">4.</span> <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    cfd = accept()      <span class="comment">// ä¸å®¢æˆ·ç«¯é€šä¿¡çš„ socket fd</span></span><br><span class="line">    pid = fork()        <span class="comment">// åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;     <span class="comment">// å­è¿›ç¨‹</span></span><br><span class="line">        close(lfd)      <span class="comment">// å…³é—­ç”¨äºå»ºç«‹è¿æ¥çš„å¥—æ¥å­— lfd</span></span><br><span class="line">        read()          <span class="comment">// è¯»æ•°æ®ï¼Œå¹¶å¤„ç†</span></span><br><span class="line">        ....</span><br><span class="line">        write()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;   <span class="comment">// çˆ¶è¿›ç¨‹</span></span><br><span class="line">        close(cfd)      <span class="comment">// çˆ¶è¿›ç¨‹ä¸­ä¸éœ€è¦ çœŸè¿æ¥ çš„ fd</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> <span class="keyword">while</span>(waitpid());    <span class="comment">// çˆ¶è¿›ç¨‹å›æ”¶å­è¿›ç¨‹ï¼Œé€šè¿‡ä¿¡å·æ•æ‰å‡½æ•°ï¼š`SIGCHLD`</span></span><br></pre></td></tr></table></figure><h2 id="å¤šçº¿ç¨‹å¹¶å‘"><a href="#å¤šçº¿ç¨‹å¹¶å‘" class="headerlink" title="å¤šçº¿ç¨‹å¹¶å‘"></a>å¤šçº¿ç¨‹å¹¶å‘</h2><p>ä¸å¤šè¿›ç¨‹å¹¶å‘ç±»ä¼¼ï¼Œåªæ˜¯ä¸ºæ¯ä¸€ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚ä¸å¤šè¿›ç¨‹ç›¸æ¯”ï¼Œå›æ”¶å­çº¿ç¨‹æ›´ç®€å•ï¼š</p><ul><li>å¯ç›´æ¥ä½¿ç”¨<code>pthread_detach</code>åˆ†ç¦»å­çº¿ç¨‹ï¼Œè‡ªåŠ¨å›æ”¶ï¼Œè¯¥æ–¹æ¡ˆæ— æ³•æ¥æ”¶çº¿ç¨‹è¿”å›å€¼ã€‚</li><li>ä¹Ÿå¯åˆ›å»ºä¸€ä¸ªå­çº¿ç¨‹ï¼Œä¸“é—¨ç”¨äºå›æ”¶ç”¨äºå¤„ç†è¿æ¥çš„å­çº¿ç¨‹ï¼ˆå…„å¼Ÿçº¿ç¨‹å¯äº’ç›¸å›æ”¶ï¼‰ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> socket()             <span class="comment">// åˆ›å»ºç›‘å¬å¥—æ¥å­— lfd</span></span><br><span class="line"><span class="number">2.</span> bind()</span><br><span class="line"><span class="number">3.</span> listen()</span><br><span class="line"><span class="number">4.</span> <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    cfd = accept()      <span class="comment">// ä¸å®¢æˆ·ç«¯é€šä¿¡çš„ socket fd</span></span><br><span class="line">    pthread_create(&amp;tid, <span class="literal">NULL</span>, thread_main, <span class="literal">NULL</span>)   <span class="comment">// åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line">    pthread_detach(tid)    <span class="comment">// åˆ†ç¦»å­çº¿ç¨‹ï¼Œè‡ªåŠ¨å›æ”¶</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> thread_main() &#123;      <span class="comment">// å­çº¿ç¨‹å¤„ç†å‡½æ•°</span></span><br><span class="line">    close(lfd)          <span class="comment">// å…³é—­ç”¨äºå»ºç«‹è¿æ¥çš„å¥—æ¥å­— lfd</span></span><br><span class="line">    read()              <span class="comment">// è¯»æ•°æ®ï¼Œå¹¶å¤„ç†</span></span><br><span class="line">    ....</span><br><span class="line">    write()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¤šè·¯IOå¤ç”¨"><a href="#å¤šè·¯IOå¤ç”¨" class="headerlink" title="å¤šè·¯IOå¤ç”¨"></a>å¤šè·¯IOå¤ç”¨</h2><p>åœ¨ä¸Šé¢çš„å¤šè¿›ç¨‹æˆ–å¤šçº¿ç¨‹å¹¶å‘æœåŠ¡å™¨ä¸­ï¼Œçˆ¶è¿›ç¨‹æ€»æ˜¯é˜»å¡ç­‰å¾…è¿æ¥ï¼ˆé˜»å¡åœ¨<code>lfd</code>ï¼‰ã€å­è¿›ç¨‹å¤§éƒ¨åˆ†æ—¶é—´é˜»å¡ç­‰å¾…æ¶ˆæ¯ï¼ˆé˜»å¡åœ¨<code>cfd</code>ï¼‰ï¼Œæ— æ³•åšå…¶ä»–äº‹æƒ…ã€‚å¤šè·¯IOè½¬æ¥æœåŠ¡å™¨ä¹Ÿå«åšå¤šä»»åŠ¡IOæœåŠ¡å™¨ï¼Œè¯¥ç±»æœåŠ¡å™¨å®ç°çš„ä¸»æ—¨æ€æƒ³æ˜¯ï¼Œä¸å†ç”±åº”ç”¨ç¨‹åºè‡ªå·±ç›‘è§†å®¢æˆ·ç«¯è¿æ¥ï¼Œå–è€Œä»£ä¹‹<strong>ç”±å†…æ ¸æ›¿åº”ç”¨ç¨‹åºç›‘è§†æ–‡ä»¶</strong>ã€‚</p><p>ä¸å¤šè¿›ç¨‹å’Œå¤šçº¿ç¨‹æŠ€æœ¯ç›¸æ¯”ï¼Œ<code>I/O</code>å¤šè·¯å¤ç”¨æŠ€æœ¯çš„<strong>æœ€å¤§ä¼˜åŠ¿æ˜¯ç³»ç»Ÿå¼€é”€å°</strong>ï¼Œç³»ç»Ÿä¸å¿…åˆ›å»ºè¿›ç¨‹&#x2F;çº¿ç¨‹ï¼Œä¹Ÿä¸å¿…ç»´æŠ¤è¿™äº›è¿›ç¨‹&#x2F;çº¿ç¨‹ï¼Œä»è€Œå¤§å¤§å‡å°äº†ç³»ç»Ÿçš„å¼€é”€ã€‚</p><p><code>select, poll, epoll</code>éƒ½æ˜¯ç›‘å¬<strong>æ–‡ä»¶æè¿°ç¬¦</strong>ï¼Œä¼ é€’ç»™è¿™äº›ç›‘å¬å‡½æ•°çš„å‚æ•°éƒ½æ˜¯éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œè¿”å›å€¼ä¸ºæœ‰å¯¹åº”ç›‘å¬äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ã€‚<strong>è¿™äº›å‡½æ•°ç›‘å¬æ–‡ä»¶æè¿°ç¬¦ï¼Œæ²¡æœ‰é™åˆ¶å¿…é¡»æ˜¯<code>socket</code>å»ºç«‹çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ™®é€šæ–‡ä»¶ã€ç®¡é“ç­‰æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦éƒ½å¯ä»¥è¢«ç›‘å¬</strong>ã€‚</p><h2 id="Select"><a href="#Select" class="headerlink" title="Select"></a>Select</h2><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<code>select</code>ç›‘å¬å¯¹åº”çš„<code>socket fd</code>ï¼Œè¿æ¥è¯·æ±‚ä¹Ÿå°±æ˜¯<code>lfd</code>ä¸Šæœ‰æ¶ˆæ¯åˆ°è¾¾ï¼Œå…¶ä»–å®¢æˆ·ç«¯çš„è¯·æ±‚ä¹Ÿå°±æ˜¯å¯¹åº”çš„<code>cfd</code>ä¸Šæœ‰æ¶ˆæ¯åˆ°è¾¾ã€‚</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20220802151005095.png" alt="image-20220802151005095"></p><p><code>select</code>å‡½æ•°ä¸­ï¼Œæœ‰ä¸‰ä¸ªä¼ å…¥ä¼ å‡ºå‚æ•°ï¼Œ<strong>ä¼ å…¥</strong>è¡¨ç¤ºè¦ç›‘å¬çš„è¯»ã€å†™ã€å¼‚å¸¸æ–‡ä»¶æè¿°ç¬¦ï¼Œ<strong>ä¼ å‡º</strong>è¡¨ç¤ºæœ‰å¯¹åº”äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8/v2-320be0c91e2a376199b1d5eef626758e_b.gif" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/select.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> nfds, fd_set *readfds, fd_set *writefds,</span></span><br><span class="line"><span class="params">            fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>nfds</code>ï¼šè¦ç›‘å¬çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦<code>+1</code></li><li><code>readfds</code>ï¼š<strong>ä¼ å…¥ä¼ å‡ºå‚æ•°</strong>ï¼Œè¦ç›‘å¬çš„è¯»é›†åˆ</li><li><code>writefds</code>ï¼š<strong>ä¼ å…¥ä¼ å‡ºå‚æ•°</strong>ï¼Œè¦ç›‘å¬çš„å†™é›†åˆï¼Œä¸€èˆ¬ä¼  NULL</li><li><code>exceptfds</code>ï¼š<strong>ä¼ å…¥ä¼ å‡ºå‚æ•°</strong>ï¼Œè¦ç›‘å¬çš„å¼‚å¸¸é›†åˆï¼Œä¸€èˆ¬ä¼  NULL</li><li><code>timeout</code>ï¼š<ul><li><code>&gt;0</code> è®¾ç½®ç›‘å¬è¶…æ—¶æ—¶é•¿</li><li><code>NULL</code> é˜»å¡ç›‘å¬</li><li><code>0</code> éé˜»å¡ç›‘å¬ï¼Œè½®è¯¢</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li><code>&gt;=0</code> æ‰€æœ‰ç›‘å¬é›†åˆï¼ˆ3ä¸ªï¼‰ä¸­ï¼Œæ»¡è¶³å¯¹åº”äº‹ä»¶çš„æ€»æ•°</li><li><code>-1</code> å¼‚å¸¸ï¼Œ<code>errno</code></li></ul></li></ul><p><code>fd_set</code> æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶é›†åˆï¼Œåœ¨cæ ‡å‡†åº“ä¸­å…¶é•¿åº¦æ˜¯å›ºå®šçš„ï¼ˆ1024ï¼‰ï¼Œæ¯ä¸€ä½è¡¨ç¤ºå¯¹åº”ä½çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œç›¸å…³çš„ä¿®æ”¹åªèƒ½é€šè¿‡æä¾›çš„æ“ä½œå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">FD_CLR</span><span class="params">(<span class="type">int</span> fd, fd_set *<span class="built_in">set</span>)</span>;   <span class="comment">// å°†ä¸€ä¸ªæè¿°ç¬¦ç§»å‡ºç›‘å¬é›†åˆ</span></span><br><span class="line"><span class="type">int</span>  <span class="title function_">FD_ISSET</span><span class="params">(<span class="type">int</span> fd, fd_set *<span class="built_in">set</span>)</span>; <span class="comment">// åˆ¤æ–­æè¿°ç¬¦æ˜¯å¦åœ¨ç›‘å¬é›†åˆä¸­</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_SET</span><span class="params">(<span class="type">int</span> fd, fd_set *<span class="built_in">set</span>)</span>;   <span class="comment">// å°†ä¸€ä¸ªæè¿°ç¬¦åŠ å…¥ç›‘å¬é›†åˆ</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">FD_ZERO</span><span class="params">(fd_set *<span class="built_in">set</span>)</span>;          <span class="comment">// æ¸…é›¶ç›‘å¬é›†åˆ</span></span><br></pre></td></tr></table></figure><h3 id="Select-åŸºæœ¬æµç¨‹"><a href="#Select-åŸºæœ¬æµç¨‹" class="headerlink" title="Select åŸºæœ¬æµç¨‹"></a>Select åŸºæœ¬æµç¨‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lfd = socket();     <span class="comment">// åˆ›å»ºç›‘å¬å¥—æ¥å­— lfd</span></span><br><span class="line">bind();</span><br><span class="line">listen();</span><br><span class="line">fd_set rset;        <span class="comment">// åˆ›å»ºè¯»ç›‘å¬é›†åˆ</span></span><br><span class="line">fd_set allset;      <span class="comment">// ç”±äºä½œä¸ºselectå‚æ•°çš„rsetæ¯æ¬¡è°ƒç”¨éƒ½ä¼šè¢«ä¿®æ”¹ï¼Œç”¨allsetä½œä¸ºç›‘å¬é›†åˆ</span></span><br><span class="line">FD_ZERO(&amp;allset);   <span class="comment">// æ¸…ç©º</span></span><br><span class="line">FD_SET(lfd, allset) <span class="comment">// å°† lfd åŠ å…¥ç›‘å¬é›†åˆ</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    rset = allset;  <span class="comment">// ä¿å­˜ç›‘å¬é›†åˆ</span></span><br><span class="line">    ret = select(lfd+<span class="number">1</span>, &amp;rset, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);   <span class="comment">// ç›‘å¬å¯¹åº”é›†åˆ</span></span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (FD_ISSET(lfd, &amp;rset)) &#123;</span><br><span class="line">            cfd = accept();</span><br><span class="line">            FD_SET(cfd, &amp;allset);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (i = lfd+<span class="number">1</span>; i &lt;= maxfd; i++) &#123;  <span class="comment">// éå†é›†åˆï¼Œå¤„ç†å¯¹åº”äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">if</span> (FD_ISSET(lfd, &amp;rset)) &#123;</span><br><span class="line">                read()</span><br><span class="line">                ....    <span class="comment">// å¤„ç†æ•°æ®</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Select-ä¼˜ç¼ºç‚¹"><a href="#Select-ä¼˜ç¼ºç‚¹" class="headerlink" title="Select ä¼˜ç¼ºç‚¹"></a>Select ä¼˜ç¼ºç‚¹</h3><p><strong>ä¼˜ç‚¹</strong>ï¼šè·¨å¹³å°ï¼</p><p><strong>ç¼ºç‚¹</strong>ï¼š</p><ul><li>ç›‘å¬ä¸Šé™å—æ–‡ä»¶æè¿°ç¬¦é™åˆ¶ï¼Œæœ€å¤§1024ï¼ˆä¸æ˜¯æ•°é‡æœ€å¤§1024ï¼Œè€Œæ˜¯æ–‡ä»¶æè¿°ç¬¦çš„å¤§å°ä¸èƒ½è¶…è¿‡1024ï¼‰ã€‚</li><li>æ£€æµ‹æ»¡è¶³æ¡ä»¶çš„<code>fd</code>æ¯”è¾ƒéº»çƒ¦ï¼Œæé«˜äº†ç¼–ç éš¾åº¦ï¼<strong>ä½†æ£€æµ‹é€»è¾‘å†™å¥½äº†ï¼Œæ€§èƒ½å¹¶ä¸æ¯”åé¢çš„<code>poll, epoll</code>ä½</strong>ã€‚</li></ul><p>æ£€æµ‹æ¡ä»¶è¿™é‡Œï¼Œå¦‚æœæ–‡ä»¶æè¿°ç¬¦å¾ˆåˆ†æ•£ï¼Œæ¯”å¦‚ 3 å’Œ 1023ï¼Œå¦‚æœéå†<code>fd_set</code>ï¼Œæ•ˆç‡å¾ˆä½ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯ç”¨ä¸€ä¸ªæ•°ç»„æ¥è®°å½•éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåªä¸è¿‡éœ€è¦è‡ªå·±å®ç°ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚</p><h2 id="Poll"><a href="#Poll" class="headerlink" title="Poll"></a>Poll</h2><p><code>Poll</code>åªæ˜¯ä¸€ä¸ªåŠæˆå“ï¼Œå¯¹ä¸Šé¢çš„<code>Select</code>è¿›è¡Œäº†ä¸€ç‚¹ä¼˜åŒ–ï¼š</p><ul><li>å®ƒæœ¬èº«å°±ç”¨æ•°ç»„æ¥è®°å½•æ–‡ä»¶æè¿°ç¬¦ï¼Œæ–¹ä¾¿å¤„ç†å¾ˆåˆ†æ•£çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>ä¸åœ¨å—é™ä¸æ–‡ä»¶æè¿°ç¬¦çš„å¤§å°ï¼Œç›‘å¬æ–‡ä»¶æè¿°ç¬¦çš„å¤§å°ä¸å—é™ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">poll</span><span class="params">(<span class="keyword">struct</span> pollfd *fds, <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>   fd;         <span class="comment">// å¾…ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">    <span class="type">short</span> events;     <span class="comment">// å¾…ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„ç›‘å¬æ—¶é—´ï¼šPOLLIN, POLLOUT, POLLERR</span></span><br><span class="line">    <span class="type">short</span> revents;    <span class="comment">// ä¼ å…¥æ—¶ç»™0ã€‚å¦‚æœæ»¡è¶³å¯¹åº”æ—¶é—´ï¼Œè¿”å›é0ï¼šPOLLIN, POLLOUT, POLLERR</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>fds</code>ï¼šç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ã€æ•°ç»„ã€‘</li><li><code>nfds</code>ï¼šç›‘å¬æ•°ç»„çš„ï¼Œå®é™…æœ‰æ•ˆç›‘å¬ä¸ªæ•°</li><li><code>timeout</code>ï¼šå•ä½ <code>ms</code><ul><li><code>&gt;0</code> è®¾ç½®ç›‘å¬è¶…æ—¶æ—¶é•¿</li><li><code>-1</code> é˜»å¡ç›‘å¬</li><li><code>0</code> éé˜»å¡ç›‘å¬</li></ul></li><li>è¿”å›å€¼ï¼š- è¿”å›å€¼ï¼š<ul><li><code>&gt;=0</code> æ»¡è¶³å¯¹åº”ç›‘å¬äº‹ä»¶çš„æ€»æ•°ã€‚</li><li><code>-1</code> å¼‚å¸¸ï¼Œ<code>errno</code></li></ul></li></ul><h3 id="Poll-åŸºæœ¬æµç¨‹"><a href="#Poll-åŸºæœ¬æµç¨‹" class="headerlink" title="Poll åŸºæœ¬æµç¨‹"></a>Poll åŸºæœ¬æµç¨‹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">lfd = socket();     <span class="comment">// åˆ›å»ºç›‘å¬å¥—æ¥å­— lfd</span></span><br><span class="line">bind();</span><br><span class="line">listen();</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">fds</span>[1024];</span>    <span class="comment">// ç›‘å¬æ•°ç»„</span></span><br><span class="line">fds[<span class="number">0</span>].fd = lfd;</span><br><span class="line">fds[<span class="number">0</span>].events = POLLIN;</span><br><span class="line">fds[<span class="number">0</span>].revents = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    ret = poll(fds, maxi+<span class="number">1</span>, <span class="number">-1</span>);   <span class="comment">// ç›‘å¬å¯¹åº”é›†åˆ</span></span><br><span class="line">    <span class="keyword">if</span> (ret &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= maxi; i++) &#123;</span><br><span class="line">            <span class="comment">// éå†æ•°ç»„ï¼Œä¾æ¬¡åˆ¤æ–­æ˜¯å¦æœ‰å¯¹åº”äº‹ä»¶</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Poll-ä¼˜ç¼ºç‚¹"><a href="#Poll-ä¼˜ç¼ºç‚¹" class="headerlink" title="Poll ä¼˜ç¼ºç‚¹"></a>Poll ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p><ul><li>è‡ªå¸¦æ•°ç»„ç»“æ„ï¼Œå¯å°†ç›‘å¬äº‹ä»¶é›†åˆå’Œè¿”å›äº‹ä»¶é›†åˆåˆ†ç¦»ã€‚</li><li>å¯æ‹“å±•ç›‘å¬ä¸Šé™ï¼Œè¶…å‡º1024é™åˆ¶ã€‚</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸èƒ½è·¨å¹³å°ï¼Œåªèƒ½åœ¨ <code>Linux / Unix</code> ä¸‹ä½¿ç”¨ã€‚</li><li>ä»ç„¶æ— æ³•ç›´æ¥å®šä½æ»¡è¶³ç›‘å¬äº‹ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li>ç¼–ç éš¾åº¦è¾ƒå¤§ã€‚</li></ul><h3 id="çªç ´1024é™åˆ¶"><a href="#çªç ´1024é™åˆ¶" class="headerlink" title="çªç ´1024é™åˆ¶"></a>çªç ´1024é™åˆ¶</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¿›ç¨‹å¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šé™å°±<code>1024</code>ï¼Œå½“æœåŠ¡å™¨è¿æ¥çš„å®¢æˆ·ç«¯è¶…è¿‡1024æ—¶ï¼Œå°±æ— æ³•å†ä¸ºå…¶åˆ†é…æ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ— æ³•å»ºç«‹è¿æ¥ã€‚</p><p><strong>æŸ¥çœ‹é™åˆ¶</strong>ï¼š</p><ul><li><code>cat /proc/sys/fs/file-max</code>ï¼šå½“å‰è®¡ç®—æœºæ‰€èƒ½æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶ä¸ªæ•°ã€‚å—ç¡¬ä»¶å½±å“ã€‚</li><li><code>ulimit -a</code>ï¼ˆ<code>open files</code>ï¼‰ï¼šå½“å‰ç”¨æˆ·ä¸‹çš„è¿›ç¨‹ï¼Œé»˜è®¤å¯æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚ç¼ºçœä¸º 1024</li></ul><p><strong>ä¿®æ”¹é™åˆ¶</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># sudo vim /etc/security/limits.conf    # åœ¨æ–‡ä»¶æœ«å°¾åŠ å…¥ä¸€ä¸‹å†…å®¹</span></span><br><span class="line">*               soft    nofile          65536   <span class="comment"># è®¾ç½®é»˜è®¤å€¼ï¼Œå¯ä»¥ç›´æ¥å€ŸåŠ©å‘½ä»¤ulimitä¿®æ”¹ã€‚ã€æ³¨é”€ç”¨æˆ·ï¼Œä½¿å…¶ç”Ÿæ•ˆã€‘</span></span><br><span class="line">*               hard    nofile          100000  <span class="comment"># è®¾ç½®å‘½ä»¤ä¸Šé™</span></span><br></pre></td></tr></table></figure><p>æ¥ç€å°±å¯ä½¿ç”¨<code>ulimit -n num</code>ä¿®æ”¹è¿›ç¨‹å¯æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šé™ï¼Œå—åˆ°ä¸Šé¢è®¾ç½®çš„<code>hard</code>é™åˆ¶ã€‚</p><h2 id="Epoll"><a href="#Epoll" class="headerlink" title="Epoll"></a>Epoll</h2><p>åœ¨<code>man epoll</code>ä¸­å¯¹<code>epoll</code>æœ‰è¾ƒè¯¦ç»†çš„æè¿°ã€‚å…¶åœ¨å†…æ ¸ä¸­çš„å®ç°é‡‡ç”¨äº†ä¸¤ç§æ•°æ®ç»“æ„ï¼š</p><ul><li><strong>ç›‘å¬çº¢é»‘æ ‘</strong>ï¼Œç”¨äºç»´æŠ¤ç›‘å¬çš„æè¿°ç¬¦åˆ—è¡¨ã€‚</li><li><strong>å°±ç»ªé“¾è¡¨</strong>ï¼Œç»´æŠ¤ä¸€ä¸ªæœ‰ç›‘å¬äº‹ä»¶å“åº”çš„æè¿°ç¬¦åˆ—è¡¨ã€‚</li></ul><p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä½¿ç”¨<code>epoll_ctl()</code>å‘ç›‘å¬çº¢é»‘æ ‘ä¸­æ·»åŠ ã€åˆ é™¤æ–‡ä»¶æè¿°ç¬¦ã€‚æœ‰æ•°æ®åˆ°è¾¾æ—¶ï¼Œé€šè¿‡å›è°ƒå‡½æ•°ï¼Œå°†å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æ’å…¥åˆ°å°±ç»ªé“¾è¡¨ä¸­ï¼›å½“ä½¿ç”¨<code>epoll_wait()</code>æ—¶ï¼Œåªåˆ¤æ–­è¯¥<strong>å°±ç»ªé“¾è¡¨</strong>æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±è¿”å›å°±ç»ªé“¾è¡¨ã€‚</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8/v2-70f8e9bc1a028d252c01c32329e49341_b.gif" alt="img"></p><p>ä½¿ç”¨çº¢é»‘æ ‘åªæ˜¯ä¸ºäº†ç®¡ç†éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼ŒåŸç†ä¸Šæ¥è®²ï¼Œä½¿ç”¨æ™®é€šçš„æ•°ç»„ä¹Ÿå¯ä»¥è®°å½•éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œæ¯”å¦‚æ–¹æ¡ˆä¸€ï¼šæ·»åŠ ç›‘å¬çš„æè¿°ç¬¦é€šè¿‡éå†æ•°ç»„æ‰¾åˆ°ç¬¬ä¸€ä¸ªç©ºä½ï¼Œåˆ é™¤æ“ä½œç¬¦ä¹Ÿéœ€è¦éå†æ•°ç»„ç¡®å®šä½ç½®ï¼ˆè€Œä¸”ä¼šç•™ä¸‹ç©ºä½ï¼‰ã€‚è¿™ç§æ–¹å¼ä½¿ç”¨çš„ç©ºé—´å¤æ‚åº¦ä½ï¼Œä½†æ—¶é—´å¤æ‚åº¦é«˜ã€‚æ–¹æ¡ˆäºŒï¼šç›´æ¥ä½¿ç”¨ä¸€ä¸ªè¶³å¤Ÿé•¿çš„æ•°ç»„ï¼Œç”¨æ–‡ä»¶æè¿°ç¬¦ä¸‹æ ‡åšæ˜ å°„ã€‚æ·»åŠ ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯<code>O(1)</code>ï¼Œå•ç©ºé—´å¤æ‚åº¦å¾ˆé«˜ï¼Œå› ä¸ºå¹¶ä¸ä»…ä»…æ˜¯è®°å½•æ–‡ä»¶æè¿°ç¬¦<code>int</code>ï¼Œè¿˜éœ€è¦è®°å½•éœ€è¦ç›‘å¬çš„äº‹ä»¶ç­‰ä¿¡æ¯ã€‚è€Œçº¢é»‘æ ‘å°±æ˜¯å¯¹æ—¶é—´ã€ç©ºé—´å¤æ‚åº¦æŠ˜ä¸­çš„ä¸€ä¸ªæ–¹æ¡ˆï¼Œç©ºé—´å¤æ‚åº¦ä½ï¼Œæ—¶é—´å¤æ‚åº¦<code>O(\log n)</code>ã€‚</p><p>è¿˜æœ‰ä¸€ç§æ–¹æ¡ˆï¼šç”¨å“ˆå¸Œè¡¨æ¥ç®¡ç†éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä½†å“ˆå¸Œè¡¨æœ‰ä¸ªè‡´å‘½ç¼ºé™·ï¼Œæ²¡æœ‰äººçŸ¥é“å“ˆå¸Œè¡¨å¢åˆ çš„æ—¶å€™ä¼šåœ¨ä»€ä¹ˆæ—¶å€™æ‰©å®¹&#x2F;ç¼©å®¹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´æŸä¸ª <code>epoll_ctl</code> æ“ä½œå¢åˆ æ–‡ä»¶æè¿°ç¬¦çš„æ—¶å€™ï¼Œä¼šæ¯”å…¶å®ƒæ“ä½œé•¿å‡ ç™¾å€ã€‚è€Œä¸ºäº†ä¿è¯å¯¹å¤–æä¾›çš„æœåŠ¡çš„è´¨é‡ï¼Œæ¯æ¬¡ <code>epoll_ctl</code> çš„æ—¶é—´åº”è¯¥è‡³å°‘æ˜¯å¹³å‡çš„ã€‚</p><h3 id="epoll-create-å‡½æ•°"><a href="#epoll-create-å‡½æ•°" class="headerlink" title="epoll_create å‡½æ•°"></a>epoll_create å‡½æ•°</h3><p>åˆ›å»ºä¸€æ£µç›‘å¬çº¢é»‘æ ‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>size</code>ï¼šåˆ›å»ºçš„çº¢é»‘æ ‘çš„ç›‘å¬èŠ‚ç‚¹æ•°é‡ï¼Œä»…ä¾›å†…æ ¸å‚è€ƒã€‚</li><li>è¿”å›å€¼ï¼š<ul><li><code>&gt;0</code> æŒ‡å‘æ–°åˆ›å»ºçš„çº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹çš„ <code>fd</code>ã€‚</li><li><code>-1</code> å¤±è´¥ï¼Œ<code>errno</code>ã€‚</li></ul></li></ul><h3 id="epoll-ctl-å‡½æ•°"><a href="#epoll-ctl-å‡½æ•°" class="headerlink" title="epoll_ctl å‡½æ•°"></a>epoll_ctl å‡½æ•°</h3><p>æ“ä½œç›‘å¬çº¢é»‘æ ‘ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>epfd</code>ï¼š<code>epoll_create</code>å‡½æ•°çš„è¿”å›å€¼ï¼Œçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹</li><li><code>op</code>ï¼šå¯¹è¯¥ç›‘å¬çº¢é»‘æ•°æ‰€åšçš„æ“ä½œï¼š<ul><li><code>EPOLL_CTL_ADD</code> æ·»åŠ <code>fd</code>åˆ° ç›‘å¬çº¢é»‘æ ‘ï¼›</li><li><code>EPOLL_CTL_MOD</code> ä¿®æ”¹<code>fd</code>åœ¨ ç›‘å¬çº¢é»‘æ ‘ä¸Šçš„ç›‘å¬äº‹ä»¶ï¼›</li><li><code>EPOLL_CTL_DEL</code> å°†ä¸€ä¸ª<code>fd</code>ä» ç›‘å¬çº¢é»‘æ ‘ä¸Šæ‘˜ä¸‹ï¼ˆå–æ¶ˆç›‘å¬ï¼‰ã€‚</li></ul></li><li><code>fd</code>ï¼šå¾…ç›‘å¬çš„ <code>fd</code>ã€‚</li><li><code>event</code>ï¼šæœ¬è´¨ <code>struct epoll_event</code> ç»“æ„ä½“ å˜é‡åœ°å€</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">epoll_data</span> &#123;</span>  <span class="comment">// union è”åˆä½“</span></span><br><span class="line">    <span class="type">void</span>        *ptr;</span><br><span class="line">    <span class="type">int</span>          fd;    <span class="comment">// ä¼ å‡ºå‚æ•°ï¼Œå¯¹åº”ç›‘å¬æ—¶é—´çš„ fd</span></span><br><span class="line">    <span class="type">uint32_t</span>     u32;   <span class="comment">// æ— ç”¨</span></span><br><span class="line">    <span class="type">uint64_t</span>     u64;   <span class="comment">// æ— ç”¨</span></span><br><span class="line">&#125; <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span>     events;    <span class="comment">// ç›‘å¬äº‹ä»¶ç±»å‹ EPOLLIN/ EPOLLOUT/ EPOLL</span></span><br><span class="line">    <span class="type">epoll_data_t</span> data;      <span class="comment">/* User data variable */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="epoll-wait-å‡½æ•°"><a href="#epoll-wait-å‡½æ•°" class="headerlink" title="epoll_wait å‡½æ•°"></a>epoll_wait å‡½æ•°</h3><p>åˆ¤æ–­è¯¥<strong>å°±ç»ªé“¾è¡¨</strong>æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºå°±è¿”å›å°±ç»ªé“¾è¡¨ï¼Œå¦åˆ™é˜»å¡ç­‰å¾…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events,</span></span><br><span class="line"><span class="params">                <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>epfd</code>ï¼š<code>epoll_create</code>å‡½æ•°çš„è¿”å›å€¼ï¼Œçº¢é»‘æ ‘çš„æ ¹èŠ‚ç‚¹ã€‚</li><li><code>events</code>ï¼šä¼ å‡ºå‚æ•°ï¼Œ<strong>æ•°ç»„</strong>ï¼Œæ»¡è¶³ç›‘å¬æ¡ä»¶çš„é‚£äº› <code>fd</code> ç»“æ„ä½“ã€‚æ•°ç»„å¤§å°é¢„å…ˆå°±ç»™å®š<code>LEN</code>ï¼</li><li><code>maxevents</code>ï¼š<code>events</code>æ•°ç»„ å…ƒç´ çš„æ€»ä¸ªæ•°ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„<code>LEN</code>ã€‚</li><li><code>timeout</code>ï¼šå•ä½ <code>ms</code><ul><li><code>&gt;0</code> è®¾ç½®ç›‘å¬è¶…æ—¶æ—¶é•¿</li><li><code>-1</code> é˜»å¡ç›‘å¬</li><li><code>0</code> éé˜»å¡ç›‘å¬</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li><code>&gt;=0</code> æ»¡è¶³å¯¹åº”ç›‘å¬äº‹ä»¶çš„æ€»æ•°ï¼Œä¹Ÿå°±æ˜¯<code>events</code>ä¸­æœ‰æ•ˆæˆå‘˜çš„æ•°é‡ã€‚</li><li><code>-1</code> å¼‚å¸¸ï¼Œ<code>errno</code></li></ul></li></ul><h3 id="ETå’ŒLTæ¨¡å¼"><a href="#ETå’ŒLTæ¨¡å¼" class="headerlink" title="ETå’ŒLTæ¨¡å¼"></a>ETå’ŒLTæ¨¡å¼</h3><p><code>epoll</code>æ˜¯<code>Linux</code>ä¸‹å¤šè·¯å¤ç”¨IOæ¥å£<code>select/poll</code>çš„å¢å¼ºç‰ˆæœ¬ï¼Œå®ƒèƒ½æ˜¾è‘—æé«˜ç¨‹åºåœ¨å¤§é‡å¹¶å‘è¿æ¥ä¸­åªæœ‰å°‘é‡æ´»è·ƒçš„æƒ…å†µä¸‹çš„ç³»ç»ŸCPUåˆ©ç”¨ç‡ï¼Œå› ä¸ºå®ƒä¼šå¤ç”¨æ–‡ä»¶æè¿°ç¬¦é›†åˆæ¥ä¼ é€’ç»“æœè€Œä¸ç”¨è¿«ä½¿å¼€å‘è€…æ¯æ¬¡ç­‰å¾…äº‹ä»¶ä¹‹å‰éƒ½å¿…é¡»é‡æ–°å‡†å¤‡è¦è¢«ä¾¦å¬çš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå¦ä¸€ç‚¹åŸå› å°±æ˜¯è·å–äº‹ä»¶çš„æ—¶å€™ï¼Œå®ƒæ— é¡»éå†æ•´ä¸ªè¢«ä¾¦å¬çš„æè¿°ç¬¦é›†ï¼Œåªè¦éå†é‚£äº›è¢«å†…æ ¸IOäº‹ä»¶å¼‚æ­¥å”¤é†’è€ŒåŠ å…¥<code>Ready</code>é˜Ÿåˆ—çš„æè¿°ç¬¦é›†åˆå°±è¡Œäº†ã€‚</p><p><code>epoll</code>äº‹ä»¶æœ‰ä¸¤ç§æ¨¡å‹ï¼š</p><ul><li><code>Edge Triggered (ET)</code> è¾¹ç¼˜è§¦å‘ï¼ˆä¸Šå‡æ²¿ï¼‰åªæœ‰æ•°æ®åˆ°æ¥æ‰è§¦å‘ï¼Œä¸ç®¡ç¼“å­˜åŒºä¸­æ˜¯å¦è¿˜æœ‰æ•°æ®ã€‚</li><li><code>Level Triggered (LT)</code> æ°´å¹³è§¦å‘ï¼ˆé«˜ç”µå¹³ï¼‰åªè¦æœ‰æ•°æ®éƒ½ä¼šè§¦å‘ã€‚</li></ul><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8/image-20220802175026443.png" alt="image-20220802175026443"></p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/367591714">æ·±å…¥æµ…å‡ºç†è§£selectã€pollã€epollçš„å®ç°</a></li><li><a href="https://www.bilibili.com/video/BV1iJ411S7UA?p=75&vd_source=ae9b8ed3bda4e74634d81a57039d0b6e">Linuxç½‘ç»œç¼–ç¨‹</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> socket </tag>
            
            <tag> select </tag>
            
            <tag> poll </tag>
            
            <tag> epoll </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç½‘ç»œç¼–ç¨‹-ç½‘å¡æ”¶åŒ…</title>
      <link href="/2022/07/30/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85/"/>
      <url>/2022/07/30/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç”¨ä¸€å¼ å›¾è§£é‡Š <code>linux</code> ç³»ç»Ÿæ¥æ”¶ç½‘ç»œæŠ¥æ–‡çš„è¿‡ç¨‹ã€‚</p><ol><li>é¦–å…ˆç½‘ç»œæŠ¥æ–‡é€šè¿‡ç‰©ç†ç½‘çº¿å‘é€åˆ°ç½‘å¡ï¼Œ</li><li>ç½‘ç»œé©±åŠ¨ç¨‹åºä¼šæŠŠç½‘ç»œä¸­çš„æŠ¥æ–‡è¯»å‡ºæ¥æ”¾åˆ° <code>ring buffer</code> ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹ä½¿ç”¨ DMAï¼ˆDirect Memory Accessï¼‰ï¼Œä¸éœ€è¦ <code>CPU</code> å‚ä¸</li><li><strong>å†…æ ¸</strong>ä» <code>ring buffer</code> ä¸­è¯»å–æŠ¥æ–‡è¿›è¡Œå¤„ç†ï¼Œæ‰§è¡Œ <code>IP</code> å’Œ <code>TCP/UDP</code> å±‚çš„é€»è¾‘ï¼Œæœ€åæŠŠæŠ¥æ–‡æ”¾åˆ°åº”ç”¨ç¨‹åºçš„ <code>socket buffer</code> ä¸­</li><li>åº”ç”¨ç¨‹åºä» <code>socket buffer</code> ä¸­è¯»å–æŠ¥æ–‡è¿›è¡Œå¤„ç†</li></ol><p>æ³¨æ„å›¾ä¸­çš„å‡ ä¸ª <code>buffer</code> ç¼“å†²åŒºï¼</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85/006tKfTcgy1fnf8b0c64xj31hc0u0goa.jpg" alt="img"></p><h2 id="step1ï¼šç½‘å¡åˆ°ringbuffer"><a href="#step1ï¼šç½‘å¡åˆ°ringbuffer" class="headerlink" title="step1ï¼šç½‘å¡åˆ°ringbuffer"></a>step1ï¼šç½‘å¡åˆ°<code>ringbuffer</code></h2><p><code>NIC</code> åœ¨æ¥æ”¶åˆ°æ•°æ®åŒ…ä¹‹åï¼Œé¦–å…ˆéœ€è¦å°†æ•°æ®åŒæ­¥åˆ°å†…æ ¸ä¸­ï¼Œè¿™ä¸­é—´çš„æ¡¥æ¢æ˜¯ <code>rx ring buffer</code>ã€‚å®ƒæ˜¯ç”± <code>NIC</code> å’Œé©±åŠ¨ç¨‹åºï¼ˆå†…æ ¸ï¼‰å…±äº«çš„ä¸€ç‰‡åŒºåŸŸï¼Œäº‹å®ä¸Šï¼Œ<code>rx ring buffer</code> å­˜å‚¨çš„å¹¶ä¸æ˜¯å®é™…çš„ <code>packet</code> æ•°æ®ï¼Œè€Œæ˜¯ä¸€ä¸ªæè¿°ç¬¦ï¼Œè¿™ä¸ªæè¿°ç¬¦æŒ‡å‘äº†å®ƒçœŸæ­£çš„å­˜å‚¨åœ°å€ï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š</p><ol><li>é©±åŠ¨åœ¨<strong>å†…å­˜ä¸­åˆ†é…</strong>ä¸€ç‰‡ç¼“å†²åŒºç”¨æ¥æ¥æ”¶æ•°æ®åŒ…ï¼Œå«åš <code>sk_buffer</code>ï¼›</li><li>å°†ä¸Šè¿°<strong>ç¼“å†²åŒºçš„åœ°å€å’Œå¤§å°</strong>ï¼ˆå³æ¥æ”¶æè¿°ç¬¦ï¼‰ï¼ŒåŠ å…¥åˆ° <code>rx ring buffer</code>ã€‚æè¿°ç¬¦ä¸­çš„ç¼“å†²åŒºåœ°å€æ˜¯ <code>DMA</code> ä½¿ç”¨çš„ç‰©ç†åœ°å€ï¼›</li><li>é©±åŠ¨é€šçŸ¥ç½‘å¡æœ‰ä¸€ä¸ªæ–°çš„æè¿°ç¬¦ï¼›</li><li>ç½‘å¡ä» <code>rx ring buffer</code> ä¸­å–å‡ºæè¿°ç¬¦ï¼Œä»è€Œè·çŸ¥ç¼“å†²åŒºçš„åœ°å€å’Œå¤§å°ï¼›</li><li>ç½‘å¡æ”¶åˆ°æ–°çš„æ•°æ®åŒ…ï¼›</li><li>ç½‘å¡å°†æ–°æ•°æ®åŒ…é€šè¿‡ <code>DMA</code> ç›´æ¥å†™åˆ° <code>sk_buffer</code> ä¸­ã€‚</li></ol><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85/20201031120523515.png" alt="img"></p><h3 id="ç¡¬ä¸­æ–­ä¸è½¯ä¸­æ–­"><a href="#ç¡¬ä¸­æ–­ä¸è½¯ä¸­æ–­" class="headerlink" title="ç¡¬ä¸­æ–­ä¸è½¯ä¸­æ–­"></a>ç¡¬ä¸­æ–­ä¸è½¯ä¸­æ–­</h3><p>å†…æ ¸å’Œç½‘ç»œè®¾å¤‡é©±åŠ¨æ˜¯é€šè¿‡<strong>ä¸­æ–­</strong>çš„æ–¹å¼æ¥å¤„ç†çš„ã€‚å½“è®¾å¤‡ä¸Šæœ‰æ•°æ®åˆ°è¾¾çš„æ—¶å€™ï¼Œä¼šç»™CPUçš„ç›¸å…³å¼•è„šä¸Šè§¦å‘ä¸€ä¸ªç”µå‹å˜åŒ–ï¼Œä»¥é€šçŸ¥CPUæ¥å¤„ç†æ•°æ®ã€‚å¯¹äºç½‘ç»œæ¨¡å—æ¥è¯´ï¼Œç”±äºå¤„ç†è¿‡ç¨‹æ¯”è¾ƒå¤æ‚å’Œè€—æ—¶ï¼Œå¦‚æœåœ¨ä¸­æ–­å‡½æ•°ä¸­å®Œæˆæ‰€æœ‰çš„å¤„ç†ï¼Œå°†ä¼šå¯¼è‡´ä¸­æ–­å¤„ç†å‡½æ•°ï¼ˆä¼˜å…ˆçº§è¿‡é«˜ï¼‰å°†è¿‡åº¦å æ®CPUï¼Œå°†å¯¼è‡´CPUæ— æ³•å“åº”å…¶å®ƒè®¾å¤‡ï¼Œä¾‹å¦‚é¼ æ ‡å’Œé”®ç›˜çš„æ¶ˆæ¯ã€‚å› æ­¤Linuxä¸­æ–­å¤„ç†å‡½æ•°æ˜¯<strong>åˆ†ä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨çš„</strong>ã€‚</p><p>ä¸ŠåŠéƒ¨é€šè¿‡<strong>ç¡¬ä¸­æ–­</strong>åªè¿›è¡Œæœ€ç®€å•çš„å·¥ä½œï¼Œå¿«é€Ÿå¤„ç†ç„¶åé‡Šæ”¾CPUï¼Œæ¥ç€CPUå°±å¯ä»¥å…è®¸å…¶å®ƒä¸­æ–­è¿›æ¥ã€‚å‰©ä¸‹å°†ç»å¤§éƒ¨åˆ†çš„å·¥ä½œéƒ½æ”¾åˆ°ä¸‹åŠéƒ¨ä¸­ï¼Œå¯ä»¥æ…¢æ…¢ä»å®¹å¤„ç†ã€‚</p><p>ä¸‹åŠéƒ¨å®ç°æ–¹å¼æ˜¯<strong>è½¯ä¸­æ–­</strong>ï¼Œç”±<code>ksoftirqd</code>å†…æ ¸çº¿ç¨‹å…¨æƒå¤„ç†ã€‚å’Œç¡¬ä¸­æ–­ä¸åŒçš„æ˜¯ï¼Œ<strong>ç¡¬ä¸­æ–­æ˜¯é€šè¿‡ç»™CPUç‰©ç†å¼•è„šæ–½åŠ ç”µå‹å˜åŒ–</strong>ï¼Œè€Œ<strong>è½¯ä¸­æ–­æ˜¯é€šè¿‡ç»™å†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„äºŒè¿›åˆ¶å€¼ä»¥é€šçŸ¥è½¯ä¸­æ–­å¤„ç†ç¨‹åº</strong>ã€‚</p><p>å½“ <code>NIC</code> æŠŠæ•°æ®åŒ…é€šè¿‡ <code>DMA</code> å¤åˆ¶åˆ°å†…æ ¸ç¼“å†²åŒº <code>sk_buffer</code> åï¼Œ<code>NIC</code> ç«‹å³å‘èµ·ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ã€‚<code>CPU</code> æ¥æ”¶åï¼Œé¦–å…ˆè¿›å…¥ä¸ŠåŠéƒ¨åˆ†ï¼Œ<strong>ç½‘å¡ä¸­æ–­å¯¹åº”çš„ä¸­æ–­å¤„ç†ç¨‹åºæ˜¯ç½‘å¡é©±åŠ¨ç¨‹åºçš„ä¸€éƒ¨åˆ†</strong>ï¼Œä¹‹åç”±å®ƒå‘èµ·è½¯ä¸­æ–­ï¼Œè¿›å…¥ä¸‹åŠéƒ¨åˆ†ï¼Œå¼€å§‹æ¶ˆè´¹ <code>sk_buffer</code> ä¸­çš„æ•°æ®ï¼Œäº¤ç»™å†…æ ¸åè®®æ ˆå¤„ç†ã€‚</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85/20201031120547192.png" alt="img"></p><p>Linux å°†ä¸­æ–­å¤„ç†è¿‡ç¨‹åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µï¼Œä¹Ÿå°±æ˜¯ä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ï¼š</p><ul><li><strong>ä¸ŠåŠéƒ¨ç”¨æ¥å¿«é€Ÿå¤„ç†ä¸­æ–­</strong>ï¼Œå®ƒåœ¨ä¸­æ–­ç¦æ­¢æ¨¡å¼ä¸‹è¿è¡Œï¼Œä¸»è¦å¤„ç†è·Ÿç¡¬ä»¶ç´§å¯†ç›¸å…³çš„æˆ–æ—¶é—´æ•æ„Ÿçš„å·¥ä½œã€‚ç‰¹ç‚¹å¿«é€Ÿæ‰§è¡Œï¼›</li><li><strong>ä¸‹åŠéƒ¨ç”¨æ¥å»¶è¿Ÿå¤„ç†ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œ</strong>ï¼Œé€šå¸¸ä»¥å†…æ ¸çº¿ç¨‹çš„æ–¹å¼è¿è¡Œã€‚ç‰¹ç‚¹å»¶è¿Ÿæ‰§è¡Œï¼›</li></ul><p>ä¸ŠåŠéƒ¨åˆ†ç¡¬ä»¶ä¸­æ–­ä¼šæ‰“æ–­ <code>CPU</code> æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åç«‹å³æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºã€‚è€Œä¸‹åŠéƒ¨ä»¥å†…æ ¸çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸ª <code>CPU</code> éƒ½å¯¹åº”ä¸€ä¸ªè½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹ï¼Œåå­—ä¸º <strong>ksoftirqd&#x2F;CPU ç¼–å·</strong>ï¼Œæ¯”å¦‚è¯´ï¼Œ 0 å· <code>CPU</code> å¯¹åº”çš„è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„åå­—å°±æ˜¯ <code>ksoftirqd/0</code>ã€‚</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BD%91%E5%8D%A1%E6%94%B6%E5%8C%85/640.png" alt="å›¾ç‰‡"></p><p>ä¸­æ–­ï¼Œ<code>CPU</code> èƒ½å¿«é€Ÿå“åº”ç½‘å¡çš„è¯·æ±‚ï¼Œä½†æ˜¯å¤§é‡æ•°æ®åŒ…éœ€è¦æ¥æ”¶æ—¶ï¼Œä¸­æ–­å¤„ç†ä¼šé™ä½ CPU æ•ˆç‡ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç°åœ¨çš„å†…æ ¸åŠé©±åŠ¨éƒ½é‡‡ç”¨ä¸€ç§å« NAPIï¼ˆnew APIï¼‰çš„æ–¹å¼è¿›è¡Œæ•°æ®å¤„ç†ï¼Œå…¶åŸç†å¯ä»¥ç®€å•ç†è§£ä¸º ä¸­æ–­ + è½®è¯¢ï¼Œåœ¨æ•°æ®é‡å¤§æ—¶ï¼Œä¸€æ¬¡ä¸­æ–­åé€šè¿‡è½®è¯¢æ¥æ”¶ä¸€å®šæ•°é‡åŒ…å†è¿”å›ï¼Œé¿å…äº§ç”Ÿå¤šæ¬¡ä¸­æ–­ã€‚</p><h2 id="ç½‘å¡é©±åŠ¨"><a href="#ç½‘å¡é©±åŠ¨" class="headerlink" title="ç½‘å¡é©±åŠ¨"></a>ç½‘å¡é©±åŠ¨</h2><p>åœ¨Linuxçš„æºä»£ç ä¸­ï¼Œç½‘ç»œè®¾å¤‡é©±åŠ¨å¯¹åº”çš„é€»è¾‘ä½äº<code>driver/net/ethernet</code>, å…¶ä¸­<code>intel</code>ç³»åˆ—ç½‘å¡çš„é©±åŠ¨åœ¨<code>driver/net/ethernet/intel</code>ç›®å½•ä¸‹ã€‚åè®®æ ˆæ¨¡å—ä»£ç ä½äº<code>kernel</code>å’Œ<code>net</code>ç›®å½•ã€‚</p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5Njg5NDgwNA==&mid=2247484058&idx=1&sn=a2621bc27c74b313528eefbc81ee8c0f&chksm=a6e303a191948ab7d06e574661a905ddb1fae4a5d9eb1d2be9f1c44491c19a82d95957a0ffb6&mpshare=1&scene=1&srcid=0801EnmPgBQZzVQEFjKyk7Kf&sharer_sharetime=1659361715354&sharer_shareid=79e6c1a7d49dcf7edce97768c5697437&exportkey=A547iSBR/stoMtY7WMXZFeY=&acctmode=0&pass_ticket=R9O4qICOXJkDEx0M/33HtH07gcJjvMuCt3NQ8MdRXsskdX0VpO4g9c0oKimWlRqQ&wx_header=0#rd">å›¾è§£Linuxç½‘ç»œåŒ…æ¥æ”¶è¿‡ç¨‹</a></p></li><li><p><a href="https://mp.weixin.qq.com/s?__biz=MjM5Njg5NDgwNA==&mid=2247485146&idx=1&sn=e5bfc79ba915df1f6a8b32b87ef0ef78&chksm=a6e307e191948ef748dc73a4b9a862a22ce1db806a486afce57475d4331d905827d6ca161711&mpshare=1&scene=1&srcid=0801OygzsBuKUWkHSLS3Paez&sharer_sharetime=1659361696355&sharer_shareid=79e6c1a7d49dcf7edce97768c5697437&exportkey=A+NSOu0RlBer2zr5GcM2j8k=&acctmode=0&pass_ticket=R9O4qICOXJkDEx0M/33HtH07gcJjvMuCt3NQ8MdRXsskdX0VpO4g9c0oKimWlRqQ&wx_header=0#rd">æ‹†è§£ Linux ç½‘ç»œåŒ…å‘é€è¿‡ç¨‹</a></p></li><li><p>ã€ŠLinux è®¾å¤‡é©±åŠ¨ Edition 3ã€‹</p></li><li><p><a href="https://cizixs.com/2018/01/13/linux-udp-packet-drop-debug/">linux ç³»ç»Ÿ UDP ä¸¢åŒ…é—®é¢˜åˆ†ææ€è·¯</a></p></li><li><p><a href="https://mp.weixin.qq.com/s/JR-qqjNG9ClHCYoRiFg-CQ">æ·±å…¥ç†è§£Linuxç½‘ç»œä¹‹ç½‘ç»œæ€§èƒ½ä¼˜åŒ–å»ºè®®</a></p></li><li><p><a href="https://www.codenong.com/cs109400686/">DPDK ç½‘å¡æ”¶åŒ…æµç¨‹</a></p></li><li><p><a href="https://xiaolincoding.com/network/1_base/how_os_deal_network_package.html#linux-%E6%8E%A5%E6%94%B6%E7%BD%91%E7%BB%9C%E5%8C%85%E7%9A%84%E6%B5%81%E7%A8%8B">Linux æ¥æ”¶ç½‘ç»œåŒ…çš„æµç¨‹</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVSwitch-æµ‹è¯•æ‹“æ‰‘</title>
      <link href="/2022/07/18/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/"/>
      <url>/2022/07/18/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="center">topo1</th></tr></thead><tbody><tr><td align="center"><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/PKTGEN-OVS-DPDK-TESTPMD.png"></td></tr><tr><td align="center"><strong>topo2</strong></td></tr><tr><td align="center"><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/QEMU-OVS-QEMU.png" alt="ovs-ovs"></td></tr><tr><td align="center"><strong>topo3</strong></td></tr><tr><td align="center"><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/ovs-ovs.png" alt="ovs-ovs"></td></tr><tr><td align="center"><strong>topo4</strong></td></tr><tr><td align="center"><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/ovs-ovs-ovs.png" alt="ovs-ovs-ovs"></td></tr><tr><td align="center"><strong>topo5</strong></td></tr><tr><td align="center"><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/ovs-ovs-ovs2.png" alt="ovs-ovs-ovs2"></td></tr></tbody></table><h2 id="topo1"><a href="#topo1" class="headerlink" title="topo1"></a>topo1</h2><p><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/PKTGEN-OVS-DPDK-TESTPMD.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 vhost-user1 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user1 <span class="built_in">type</span>=dpdkvhostuser ofport_request=1</span><br><span class="line">ovs-vsctl add-port br0 vhost-user2 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user2 <span class="built_in">type</span>=dpdkvhostuser ofport_request=2</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pktgen</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-pktgen \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">pktgen -c 0x19 --main-lcore 3 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;0.0&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># testpmd</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-testpmd \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0xE0 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user2,mac=00:00:00:00:00:02,path=/var/run/openvswitch/vhost-user2&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0xc0 --forward-mode=rxonly</span><br></pre></td></tr></table></figure><h2 id="topo2"><a href="#topo2" class="headerlink" title="topo2"></a>topo2</h2><p><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/QEMU-OVS-QEMU.png" alt="ovs-ovs"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 vhost-user1 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user1 <span class="built_in">type</span>=dpdkvhostuser ofport_request=1</span><br><span class="line">ovs-vsctl add-port br0 vhost-user2 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user2 <span class="built_in">type</span>=dpdkvhostuser ofport_request=2</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨QEMUè™šæ‹Ÿæœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºäºvhost-user1, vhost-user2åˆ›å»ºè™šæ‹Ÿæœº</span></span><br><span class="line">qemu-system-x86_64 -enable-kvm -m 2048 -smp 4 \</span><br><span class="line">    -chardev socket,<span class="built_in">id</span>=char0,path=/usr/local/var/run/openvswitch/vhost-user1 \</span><br><span class="line">    -netdev <span class="built_in">type</span>=vhost-user,<span class="built_in">id</span>=mynet1,chardev=char0,vhostforce \</span><br><span class="line">    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:01 \</span><br><span class="line">    -object memory-backend-file,<span class="built_in">id</span>=mem,size=2048M,mem-path=/dev/hugepages,share=on \</span><br><span class="line">    -numa node,memdev=mem -mem-prealloc \</span><br><span class="line">    -net user,hostfwd=tcp::10021-:22 -net nic \</span><br><span class="line">    ./qemu-vm1.img</span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -enable-kvm -m 2048 -smp 4 \</span><br><span class="line">    -chardev socket,<span class="built_in">id</span>=char0,path=/usr/local/var/run/openvswitch/vhost-user2 \</span><br><span class="line">    -netdev <span class="built_in">type</span>=vhost-user,<span class="built_in">id</span>=mynet1,chardev=char0,vhostforce \</span><br><span class="line">    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:02 \</span><br><span class="line">    -object memory-backend-file,<span class="built_in">id</span>=mem,size=2048M,mem-path=/dev/hugepages,share=on \</span><br><span class="line">    -numa node,memdev=mem -mem-prealloc \</span><br><span class="line">    -net user,hostfwd=tcp::10022-:22 -net nic \</span><br><span class="line">    ./qemu-vm2.img &amp;</span><br></pre></td></tr></table></figure><h2 id="topo3"><a href="#topo3" class="headerlink" title="topo3"></a>topo3</h2><p><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/ovs-ovs.png" alt="ovs-ovs"></p><p><strong>æ‹“æ‰‘æ­å»º</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sudo dpdk-hugepages.py -p 1G --setup 4G</span><br><span class="line">sudo modprobe openvswitch</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºå®¹å™¨</span></span><br><span class="line">sudo docker create -it --name=s1 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0</span><br><span class="line">sudo docker create -it --name=s2 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0</span><br><span class="line">sudo docker start s1</span><br><span class="line">sudo docker start s2</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  veth-peer</span></span><br><span class="line">sudo ip <span class="built_in">link</span> add p1_2 <span class="built_in">type</span> veth peer name p2_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev p1_2 name p1_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev p2_1 name p2_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨OVS</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################ s1 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s1 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1001</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ifconfig s1 192.168.1.12 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s1 p1_2 -- <span class="built_in">set</span> Interface p1_2 ofport_request=12</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s1 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s2 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s2 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x08</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s2 -- <span class="built_in">set</span> bridge s2 datapath_type=netdev</span><br><span class="line">ifconfig s2 192.168.1.21 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s2 p2_1 -- <span class="built_in">set</span> Interface p2_1 ofport_request=21</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s2 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br></pre></td></tr></table></figure><h2 id="topo4"><a href="#topo4" class="headerlink" title="topo4"></a>topo4</h2><p><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/ovs-ovs-ovs.png" alt="ovs-ovs-ovs"></p><p><strong>æ‹“æ‰‘æ­å»º</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sdpdk-hugepages.py -p 1G --setup 6G</span><br><span class="line">sudo modprobe openvswitch</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºå®¹å™¨</span></span><br><span class="line">sudo docker create -it --name=s1 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0</span><br><span class="line">sudo docker create -it --name=s2 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0</span><br><span class="line">sudo docker create -it --name=s3 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0</span><br><span class="line">sudo docker start s1 s2 s3</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  veth-peer</span></span><br><span class="line">sudo ip <span class="built_in">link</span> add s1_2 <span class="built_in">type</span> veth peer name s2_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> add s3_2 <span class="built_in">type</span> veth peer name s2_3 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> add s1_3 <span class="built_in">type</span> veth peer name s3_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s1_2 name s1_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s1_3 name s1_3 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s2_1 name s2_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s2_3 name s2_3 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s3_1 name s3_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s3) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s3_2 name s3_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s3) up</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨OVS</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################ s1 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s1 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1001</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:01&quot;</span></span><br><span class="line">ifconfig s1 192.168.10.1 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s1 s1_2 -- <span class="built_in">set</span> Interface s1_2 ofport_request=12</span><br><span class="line">ovs-vsctl add-port s1 s1_3 -- <span class="built_in">set</span> Interface s1_3 ofport_request=13</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s1 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s2 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s2 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x08</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s2 -- <span class="built_in">set</span> bridge s2 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s2 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:02&quot;</span></span><br><span class="line">ifconfig s2 192.168.10.2 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s2 s2_1 -- <span class="built_in">set</span> Interface s2_1 ofport_request=21</span><br><span class="line">ovs-vsctl add-port s2 s2_3 -- <span class="built_in">set</span> Interface s2_3 ofport_request=23</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s2 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s3 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s3 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x20</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s3 -- <span class="built_in">set</span> bridge s3 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s3 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:03&quot;</span></span><br><span class="line">ifconfig s3 192.168.10.3 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s3 s3_1 -- <span class="built_in">set</span> Interface s3_1 ofport_request=31</span><br><span class="line">ovs-vsctl add-port s3 s3_2 -- <span class="built_in">set</span> Interface s3_2 ofport_request=32</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s3vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br></pre></td></tr></table></figure><p><strong>è½¬å‘æµè¡¨</strong>ï¼š1&lt;-&gt;2 ï¼Œ2&lt;-&gt;3 ï¼Œ1&lt;-&gt;3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s1</span></span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.1,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.2,actions=output:s1_2</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.3,actions=output:s1_3</span><br><span class="line"><span class="comment"># s2</span></span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.2,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.1,actions=output:s2_1</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.3,actions=output:s2_3</span><br><span class="line"><span class="comment"># s3</span></span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.3,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.1,actions=output:s3_1</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.2,actions=output:s3_2</span><br><span class="line"><span class="comment"># arp</span></span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.3 00:00:00:00:10:03</span><br></pre></td></tr></table></figure><h2 id="topo5"><a href="#topo5" class="headerlink" title="topo5"></a>topo5</h2><p><strong>è½¬å‘æµè¡¨2</strong>ï¼š1&lt;-&gt;2&lt;-&gt;3 (1ä¸3ä¸ç›´è¿)</p><p><img src="/../images/OpenVSwitch-%E6%B5%8B%E8%AF%95%E6%8B%93%E6%89%91/ovs-ovs-ovs2.png" alt="ovs-ovs-ovs2"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s1</span></span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.1,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.2,actions=output:s1_2</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.3,actions=output:s1_2</span><br><span class="line"><span class="comment"># s2</span></span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.2,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.1,actions=output:s2_1</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.3,actions=output:s2_3</span><br><span class="line"><span class="comment"># s3</span></span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.3,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.1,actions=output:s3_2</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.2,actions=output:s3_2</span><br><span class="line"><span class="comment"># arp</span></span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.3 00:00:00:00:10:03</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> OpenVSwitch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenVSwitch </tag>
            
            <tag> DPDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç½‘ç»œç¼–ç¨‹-åˆ†æå·¥å…·</title>
      <link href="/2022/07/17/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/"/>
      <url>/2022/07/17/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/</url>
      
        <content type="html"><![CDATA[<table><thead><tr><th align="left">åç§°</th><th align="left">åŠŸèƒ½</th></tr></thead><tbody><tr><td align="left"><strong>dstat</strong></td><td align="left">æŸ¥çœ‹å„ç§ç³»ç»Ÿèµ„æºçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå¯ä¿å­˜åˆ°æ–‡ä»¶ï¼</td></tr><tr><td align="left"><strong>iftop</strong></td><td align="left">display bandwidth usage on an interface by host. å¯æŒ‡å®šTCP&#x2F;UDPç«¯å£</td></tr><tr><td align="left"><strong>ip</strong></td><td align="left">show &#x2F; manipulate routing, network devices, interfaces and tunnels</td></tr><tr><td align="left"><strong>ip link</strong></td><td align="left"></td></tr><tr><td align="left"><strong>ip route</strong></td><td align="left"></td></tr><tr><td align="left"><strong>iptables</strong></td><td align="left">administration tool for IPv4&#x2F;IPv6 packet filtering and NAT</td></tr><tr><td align="left"><strong>lsof</strong></td><td align="left">list open files. æŸ¥çœ‹ç«¯å£è¢«è°å ç”¨</td></tr><tr><td align="left"><strong>nc</strong></td><td align="left">arbitrary TCP and UDP connections and listens.</td></tr><tr><td align="left"><strong>netstat</strong></td><td align="left">æ‰“å°ç½‘ç»œè¿æ¥ã€è·¯ç”±è¡¨ã€è¿æ¥çš„æ•°æ®ç»Ÿè®¡ã€ä¼ªè£…è¿æ¥ä»¥åŠå¹¿æ’­åŸŸæˆå‘˜</td></tr><tr><td align="left"><strong>ss</strong></td><td align="left">another utility to investigate sockets.</td></tr><tr><td align="left"><strong>tcpdump</strong></td><td align="left">æŠ“åŒ…å·¥å…·</td></tr><tr><td align="left"><strong>telnet</strong></td><td align="left">user interface to the TELNET protocol.</td></tr><tr><td align="left"><strong>wrk</strong></td><td align="left">http å‹æµ‹å·¥å…·</td></tr><tr><td align="left"><strong>top</strong></td><td align="left"></td></tr></tbody></table><h2 id="dstat"><a href="#dstat" class="headerlink" title="dstat"></a>dstat</h2><blockquote><ul><li><a href="https://www.cnblogs.com/zh-dream/p/12081455.html">dstatå‘½ä»¤è¯¦è§£</a></li></ul></blockquote><h2 id="iftop"><a href="#iftop" class="headerlink" title="iftop"></a>iftop</h2><blockquote><ul><li><a href="https://www.cnblogs.com/yinzhengjie/p/6223467.html">iftopå‘½ä»¤è¯¦è§£</a></li></ul></blockquote><h2 id="ip"><a href="#ip" class="headerlink" title="ip"></a>ip</h2><h2 id="ip-route"><a href="#ip-route" class="headerlink" title="ip route"></a>ip route</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ip route add &lt;your_network_address&gt;/24 dev &lt;your_interface&gt;</span><br></pre></td></tr></table></figure><h2 id="iptables"><a href="#iptables" class="headerlink" title="iptables"></a>iptables</h2><blockquote><ul><li><a href="https://wangchujiang.com/linux-command/c/iptables.html">iptables ä¸­æ–‡æ–‡æ¡£</a></li><li><a href="https://linux.die.net/man/8/iptables">iptables - Linux man page</a></li><li><a href="https://blog.51cto.com/yangzhiming/1982814">Ubuntu iptablesé…ç½®</a></li></ul></blockquote><p><strong>æ³¨æ„ï¼šè§„åˆ™çš„æ¬¡åºéå¸¸å…³é”®ï¼Œ<code>è°çš„è§„åˆ™è¶Šä¸¥æ ¼ï¼Œåº”è¯¥æ”¾çš„è¶Šé å‰</code>ï¼Œè€Œæ£€æŸ¥è§„åˆ™çš„æ—¶å€™ï¼Œæ˜¯æŒ‰ç…§ä»ä¸Šå¾€ä¸‹çš„æ–¹å¼è¿›è¡Œæ£€æŸ¥çš„ã€‚</strong></p><p>1ã€<code>Ubuntu</code> é»˜è®¤æœ‰è£…<code>iptables</code>ï¼Œå¯é€šè¿‡<code>dpkg -l</code>æˆ–<code>which iptables</code>ç¡®è®¤</p><p>2ã€<code>Ubuntu</code> é»˜è®¤æ²¡æœ‰<code>iptables</code>é…ç½®æ–‡ä»¶ï¼Œéœ€é€šè¿‡<code>iptables-save &gt; /etc/network/iptables.up.rules</code>ç”Ÿæˆ</p><p>3ã€<code>iptables</code>é…ç½®æ–‡ä»¶è·¯å¾„åŠæ–‡ä»¶åå»ºè®®ä¸º<code>/etc/network/iptables.up.rules</code>ï¼Œå› ä¸ºæ‰§è¡Œ<code>iptables-apply</code>é»˜è®¤æŒ‡å‘è¯¥æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡-wå‚æ•°æŒ‡å®šæ–‡ä»¶</p><p>4ã€<code>Ubuntu</code> æ²¡æœ‰é‡å¯<code>iptables</code>çš„å‘½ä»¤ï¼Œæ‰§è¡Œ<code>iptables-apply</code>ç”Ÿæ•ˆ</p><p>5ã€<code>Ubuntu iptables</code>é»˜è®¤é‡å¯æœåŠ¡å™¨åæ¸…ç©ºï¼Œéœ€åœ¨<code>/etc/network/interfaces</code>é‡Œå†™å…¥<code>pre-up iptables-restore &lt; /etc/network/iptables.up.rules</code>æ‰ä¼šå¼€æœºç”Ÿæ•ˆ</p><h2 id="lsof"><a href="#lsof" class="headerlink" title="lsof"></a>lsof</h2><blockquote><ul><li><a href="https://wangchujiang.com/linux-command/c/lsof.html">lsof æ–‡æ¡£</a></li></ul></blockquote><h2 id="nc"><a href="#nc" class="headerlink" title="nc"></a>nc</h2><blockquote><ul><li><a href="https://www.cnblogs.com/zhaijiahui/p/9028402.html#autoid-3-2-3">ncå·¥å…·ä½¿ç”¨</a></li></ul></blockquote><h2 id="ss"><a href="#ss" class="headerlink" title="ss"></a>ss</h2><blockquote><ul><li><a href="https://www.cnblogs.com/machangwei-8/p/10352986.html">sså‘½ä»¤è¯¦è§£</a></li></ul></blockquote><h2 id="tcpdump"><a href="#tcpdump" class="headerlink" title="tcpdump"></a>tcpdump</h2><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7/20200628111325.png" alt="img"></p><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>tcpdump -n</code></td><td>ä¸æŠŠIPè½¬åŒ–æˆåŸŸåï¼Œç›´æ¥æ˜¾ç¤º ï¼Œ<strong>è‹¥ä¸åŠ ï¼Œä½¿ç”¨<code>ctrl+c</code>åœæ­¢æ—¶ä¼šå¾ˆæ…¢</strong></td></tr><tr><td><code>tcpdump -nn</code></td><td>ä¸æŠŠåè®®å’Œç«¯å£å·è½¬åŒ–æˆåå­—ï¼Œé€Ÿåº¦ä¼šæ›´å¿«</td></tr><tr><td><code>tcpdump host www.baidu.com</code></td><td>æŠ“å–æŸä¸ªç½‘ç«™</td></tr><tr><td><code>tcpdump host 192.168.10.100</code></td><td>åŸºäº<strong>IPåœ°å€</strong>è¿‡æ»¤</td></tr><tr><td><code>tcpdump host src 192.168.10.100</code></td><td>åŸºäº<strong>æºIPåœ°å€</strong>è¿‡æ»¤</td></tr><tr><td><code>tcpdump ip dst 192.168.10.100</code></td><td>åŸºäº<strong>ç›®çš„IPåœ°å€</strong>è¿‡æ»¤</td></tr><tr><td><code>tcpdump net 192.168.10.0/24</code></td><td>åŸºäº<strong>ç½‘æ®µ</strong>è¿›è¡Œè¿‡æ»¤</td></tr><tr><td><code>tcpdump tcp port 8088</code></td><td>åŸºäº<strong>ç«¯å£</strong>è¿›è¡Œè¿‡æ»¤</td></tr><tr><td><code>tcpdump -nn tcp src port 10000</code></td><td>åŸºäºä¼ è¾“å±‚åè®®+ç«¯å£è¿‡æ»¤</td></tr><tr><td><code>tcpdump port 80 or port 8088</code></td><td>åŒæ—¶æŒ‡å®šä¸¤ä¸ªç«¯å£</td></tr><tr><td><code>tcpdump portrange 8000-8080</code></td><td>æŒ‡å®šä¸€ä¸ªç«¯å£èŒƒå›´</td></tr><tr><td><code>tcpdump icmp</code></td><td>åŸºäºåè®®è¿›è¡Œè¿‡æ»¤<code>ip ip6 arp icmp rarp</code></td></tr><tr><td><code>tcpdump ip proto 6</code></td><td>åŸºæœ¬IPåè®®çš„ç‰ˆæœ¬è¿›è¡Œè¿‡æ»¤</td></tr><tr><td><code>tcpdump -i eth0</code></td><td>è¿‡æ»¤æŒ‡å®šç½‘å¡çš„æ•°æ®åŒ…</td></tr><tr><td><code>tcpdump -e</code></td><td>æ¯è¡Œçš„æ‰“å°è¾“å‡ºä¸­å°†åŒ…æ‹¬æ•°æ®åŒ…çš„<strong>æ•°æ®é“¾è·¯å±‚å¤´éƒ¨ä¿¡æ¯</strong></td></tr><tr><td><code>tcpdump ether host src [mac]</code></td><td>æ ¹æ® mac åœ°å€è¿›è¡Œè¿‡æ»¤</td></tr><tr><td><code>tcpdump -c 100</code></td><td><strong>æ•è·100ä¸ªåŒ…å°±é€€å‡º</strong></td></tr><tr><td><code>tcpdump -A</code></td><td><strong>ä»¥ASCIIç æ–¹å¼æ˜¾ç¤º</strong>æ¯ä¸€ä¸ªæ•°æ®åŒ…(ä¸æ˜¾ç¤ºé“¾è·¯å±‚å¤´éƒ¨ä¿¡æ¯)</td></tr><tr><td><code>tcpdump -w icmp.pcap</code></td><td>æŠ“åˆ°çš„åŒ…æ•°æ®ç”Ÿæˆåˆ°æ–‡ä»¶ä¸­ï¼Œä»¥<code>.pcap</code>ä¸ºåç¼€</td></tr><tr><td><code>tcpdump -r icmp.pcap</code></td><td>ä»æ–‡ä»¶ä¸­è¯»å–åŒ…æ•°æ®</td></tr></tbody></table><ul><li><p><strong>ç»„åˆè¿‡æ»¤</strong></p><ul><li>andï¼šæ‰€æœ‰çš„æ¡ä»¶éƒ½éœ€è¦æ»¡è¶³ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º <code>&amp;&amp;</code></li><li>orï¼šåªè¦æœ‰ä¸€ä¸ªæ¡ä»¶æ»¡è¶³å°±å¯ä»¥ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º <code>||</code></li><li>notï¼šå–åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ <code>!</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -nn <span class="string">&#x27;ether src 04:42:1a:ea:da:ad &amp;&amp; ip src 192.168.0.3 and udp src port 10000&#x27;</span></span><br></pre></td></tr></table></figure></li><li><p><strong>æ§åˆ¶è¯¦ç»†å†…å®¹çš„è¾“å‡º</strong></p><ul><li><code>-v</code>ï¼šäº§ç”Ÿè¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚åŒ…çš„TTLï¼Œidæ ‡è¯†ï¼Œæ•°æ®åŒ…é•¿åº¦ï¼Œä»¥åŠIPåŒ…çš„ä¸€äº›é€‰é¡¹ã€‚åŒæ—¶å®ƒè¿˜ä¼šæ‰“å¼€ä¸€äº›é™„åŠ çš„åŒ…å®Œæ•´æ€§æ£€æµ‹ï¼Œæ¯”å¦‚å¯¹IPæˆ–ICMPåŒ…å¤´éƒ¨çš„æ ¡éªŒå’Œã€‚</li><li><code>-vv</code>ï¼šäº§ç”Ÿæ¯”-væ›´è¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚NFSå›åº”åŒ…ä¸­çš„é™„åŠ åŸŸå°†ä¼šè¢«æ‰“å°, SMBæ•°æ®åŒ…ä¹Ÿä¼šè¢«å®Œå…¨è§£ç ã€‚ï¼ˆæ‘˜è‡ªç½‘ç»œï¼Œç›®å‰æˆ‘è¿˜æœªä½¿ç”¨è¿‡ï¼‰</li><li><code>-vvv</code>ï¼šäº§ç”Ÿæ¯”-vvæ›´è¯¦ç»†çš„è¾“å‡ºã€‚æ¯”å¦‚ telent æ—¶æ‰€ä½¿ç”¨çš„SB, SE é€‰é¡¹å°†ä¼šè¢«æ‰“å°, å¦‚æœtelnetåŒæ—¶ä½¿ç”¨çš„æ˜¯å›¾å½¢ç•Œé¢ï¼Œå…¶ç›¸åº”çš„å›¾å½¢é€‰é¡¹å°†ä¼šä»¥16è¿›åˆ¶çš„æ–¹å¼æ‰“å°å‡ºæ¥ï¼ˆæ‘˜è‡ªç½‘ç»œï¼Œç›®å‰æˆ‘è¿˜æœªä½¿ç”¨è¿‡ï¼‰</li></ul></li><li><p><strong>æ§åˆ¶æ—¶é—´çš„æ˜¾ç¤º</strong></p><ul><li><code>-t</code>ï¼šåœ¨æ¯è¡Œçš„è¾“å‡ºä¸­ä¸è¾“å‡ºæ—¶é—´</li><li><code>-tt</code>ï¼šåœ¨æ¯è¡Œçš„è¾“å‡ºä¸­ä¼šè¾“å‡ºæ—¶é—´æˆ³</li><li><code>-ttt</code>ï¼šè¾“å‡ºæ¯ä¸¤è¡Œæ‰“å°çš„æ—¶é—´é—´éš”(ä»¥æ¯«ç§’ä¸ºå•ä½)</li><li><code>-tttt</code>ï¼šåœ¨æ¯è¡Œæ‰“å°çš„æ—¶é—´æˆ³ä¹‹å‰æ·»åŠ æ—¥æœŸçš„æ‰“å°ï¼ˆæ­¤ç§é€‰é¡¹ï¼Œè¾“å‡ºçš„æ—¶é—´æœ€ç›´è§‚ï¼‰</li></ul></li><li><p><strong>æ˜¾ç¤ºæ•°æ®åŒ…çš„å¤´éƒ¨</strong></p><ul><li><code>-x</code>ï¼šä»¥16è¿›åˆ¶çš„å½¢å¼æ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®ï¼ˆä½†ä¸åŒ…æ‹¬æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨ï¼‰</li><li><code>-xx</code>ï¼šä»¥16è¿›åˆ¶çš„å½¢å¼æ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®ï¼ˆåŒ…æ‹¬æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨ï¼‰</li><li><code>-X</code>ï¼šä»¥16è¿›åˆ¶å’Œ ASCIIç å½¢å¼æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®(ä½†ä¸åŒ…æ‹¬è¿æ¥å±‚çš„å¤´éƒ¨)ï¼Œè¿™åœ¨åˆ†æä¸€äº›æ–°åè®®çš„æ•°æ®åŒ…å¾ˆæ–¹ä¾¿ã€‚</li><li><code>-XX</code>ï¼šä»¥16è¿›åˆ¶å’Œ ASCIIç å½¢å¼æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®(åŒ…æ‹¬è¿æ¥å±‚çš„å¤´éƒ¨)ï¼Œè¿™åœ¨åˆ†æä¸€äº›æ–°åè®®çš„æ•°æ®åŒ…å¾ˆæ–¹ä¾¿ã€‚</li></ul></li></ul><blockquote><ul><li><a href="https://www.cnblogs.com/wongbingming/p/13212306.html">æ¨èå…ˆçœ‹è¿™ä¸ªï¼šå…¨ç½‘æœ€è¯¦ç»†çš„ tcpdump ä½¿ç”¨æŒ‡å—</a></li><li><a href="https://github.com/mylxsw/growing-up/blob/master/doc/tcpdump%E7%AE%80%E6%98%8E%E6%95%99%E7%A8%8B.md">tcpdumpç®€æ˜æ•™ç¨‹</a></li><li><a href="https://colobu.com/2019/07/16/a-tcpdump-tutorial-with-examples/">tcpdump ç¤ºä¾‹æ•™ç¨‹</a></li></ul></blockquote><h2 id="netstat"><a href="#netstat" class="headerlink" title="netstat"></a>netstat</h2><p>æ‰“å°ç½‘ç»œè¿æ¥ã€è·¯ç”±è¡¨ã€è¿æ¥çš„æ•°æ®ç»Ÿè®¡ã€ä¼ªè£…è¿æ¥ä»¥åŠå¹¿æ’­åŸŸæˆå‘˜ã€‚</p><blockquote><p><a href="https://wangchujiang.com/reference/docs/netstat.html">Netstat å¤‡å¿˜æ¸…å•</a></p></blockquote><table><thead><tr><th>å‘½ä»¤</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>netstat -a</code></td><td>åˆ—å‡º <code>tcp</code>, <code>udp</code> å’Œ <code>unix</code> åè®®ä¸‹æ‰€æœ‰å¥—æ¥å­—çš„æ‰€æœ‰è¿æ¥</td></tr><tr><td><code>netstat -t</code></td><td>åªåˆ—å‡º <code>TCP</code> åè®®çš„è¿æ¥</td></tr><tr><td><code>netstat -u</code></td><td>åªåˆ—å‡º <code>UDP</code> åè®®çš„è¿æ¥</td></tr><tr><td><code>netstat -ant</code></td><td>ç¦ç”¨åå‘åŸŸåè§£æï¼ˆä¸æ˜¾ç¤ºä¸»æœºåï¼‰ï¼ŒåŠ å¿«æŸ¥è¯¢é€Ÿåº¦</td></tr><tr><td><code>netstat -tnl</code></td><td>åªåˆ—å‡ºç›‘å¬ä¸­çš„è¿æ¥ï¼Œ<code>-l</code></td></tr><tr><td><code>netstat -nlpt</code></td><td>è·å–è¿›ç¨‹åã€è¿›ç¨‹å·ä»¥åŠç”¨æˆ· IDï¼Œ<code>-p</code> è¿›ç¨‹ä¿¡æ¯</td></tr><tr><td><code>netstat -ltpe</code></td><td>ä½¿ç”¨ <code>-ep</code> é€‰é¡¹å¯ä»¥åŒæ—¶æŸ¥çœ‹è¿›ç¨‹åå’Œç”¨æˆ·åã€‚</td></tr><tr><td><code>netstat -s</code></td><td>æ‰“å°ç»Ÿè®¡æ•°æ®</td></tr><tr><td><code>netstat -rn</code></td><td>æ˜¾ç¤ºå†…æ ¸è·¯ç”±ä¿¡æ¯</td></tr><tr><td><code>netstat -i</code></td><td>æ‰“å°ç½‘ç»œæ¥å£</td></tr><tr><td><code>netstat -ct</code></td><td>ä½¿ç”¨ <code>netstat</code> çš„ <code>-c</code> é€‰é¡¹æŒç»­è¾“å‡ºä¿¡æ¯</td></tr><tr><td><code>netstat -g</code></td><td>æ˜¾ç¤ºå¤šæ’­ç»„ä¿¡æ¯</td></tr></tbody></table><h2 id="telnet"><a href="#telnet" class="headerlink" title="telnet"></a>telnet</h2><h2 id="wrk"><a href="#wrk" class="headerlink" title="wrk"></a>wrk</h2><h2 id="top"><a href="#top" class="headerlink" title="top"></a>top</h2><p>Linux çš„ top å‘½ä»¤ç”¨äºå®æ—¶æ˜¾ç¤ºç³»ç»Ÿä¸­<strong>å„ä¸ªè¿›ç¨‹</strong>çš„ CPU å’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚</p><blockquote><p><a href="https://www.cnblogs.com/ggjucheng/archive/2012/01/08/2316399.html">topå‘½ä»¤è¯¦è§£</a></p></blockquote><p>top èƒ½æŸ¥çœ‹çš„ä¿¡æ¯æœ‰ï¼š</p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://linux.cn/article-2434-1.html">netstat çš„10ä¸ªåŸºæœ¬ç”¨æ³•</a></li><li><a href="https://www.binarytides.com/linux-ss-command/">ss çš„10ä¸ªåŸºæœ¬ç”¨æ³•</a></li><li><a href="https://linux.cn/article-2493-1.html">å¦‚ä½•åœ¨Linuxä¸‹ç»Ÿè®¡é«˜é€Ÿç½‘ç»œä¸­çš„æµé‡</a></li><li><a href="https://blog.csdn.net/zqixiao_09/article/details/79165925">Linuxä¸‹è·¯ç”±é…ç½®</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redisç¬”è®°</title>
      <link href="/2022/06/24/Redis%E7%AC%94%E8%AE%B0/"/>
      <url>/2022/06/24/Redis%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<p>Redis æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ã€é”®å€¼å¯¹æ•°æ®åº“ï¼Œ<strong>æ•°æ®ç›´æ¥å­˜å‚¨åœ¨å†…å­˜ä¸­</strong>ï¼Œåªæœ‰éœ€è¦æŒä¹…åŒ–æ—¶æ‰å†™å…¥ç¡¬ç›˜ã€‚</p><h2 id="å®‰è£…å¯åŠ¨"><a href="#å®‰è£…å¯åŠ¨" class="headerlink" title="å®‰è£…å¯åŠ¨"></a>å®‰è£…å¯åŠ¨</h2><p>ubuntu ä¸‹ä½¿ç”¨ apt å®‰è£…çš„ redis ç‰ˆæœ¬è¾ƒè€ï¼Œå¯é‡‡ç”¨æºç å®‰è£…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.redis.io/releases/redis-6.2.6.tar.gz &amp;&amp; tar xzf redis-6.2.6.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> redis-stable &amp;&amp; make -j</span><br><span class="line">make <span class="built_in">test</span></span><br><span class="line">sudo make install</span><br><span class="line">sudo <span class="built_in">mkdir</span> /etc/redis &amp;&amp; sudo <span class="built_in">cp</span> redis.conf /etc/redis <span class="comment"># å¤åˆ¶é…ç½®æ–‡ä»¶åˆ° /etc</span></span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåï¼Œä¼šæœ‰ä»¥ä¸‹å‘½ä»¤å¯ç”¨ï¼š</p><ul><li><strong>redis-cli</strong>: Rediså®¢æˆ·ç«¯</li><li><strong>redis-server</strong>: RedisæœåŠ¡å™¨å¯åŠ¨å‘½ä»¤</li><li><strong>redis-benchmark</strong>: æ€§èƒ½æµ‹è¯•å·¥å…·</li><li><strong>redis-check-aof</strong>: ä¿®å¤æœ‰é—®é¢˜çš„AOFæ–‡ä»¶</li><li><strong>redis-check-rdb</strong>: ä¿®å¤æœ‰é—®é¢˜çš„RDBæ–‡ä»¶</li><li><strong>redis-sentinel</strong>: Redisé›†ç¾¤ä½¿ç”¨</li></ul><p>è®¾ç½®å¥½é…ç½®æ–‡ä»¶åï¼Œå¯åŠ¨æ–¹æ³•ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><p><code>Redis</code> å¯åŠ¨æ—¶æœ‰å¾ˆå¤šé…ç½®å‚æ•°ï¼Œè¿™äº›å‚æ•°è®¾ç½®å‡åœ¨ <code>redis.conf</code> ä¸­ï¼Œä¸”æœ‰æ³¨é‡Šå’Œåˆ†ç±»ï¼Œ<strong>æ³¨æ„ï¼šredis é…ç½®æ–‡ä»¶ä¸­æ³¨é‡Šå¿…é¡»ä»¥ # å¼€å¤´ï¼Œä¸”å¿…é¡»å•ç‹¬ä¸€è¡Œ</strong>ã€‚</p><p><strong>é™¤äº†åœ¨å¯åŠ¨å‰é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶çš„æ–¹å¼ä¿®æ”¹é…ç½®ï¼Œå¯åŠ¨åä¹Ÿå¯é€šè¿‡<code>CONFIG SET/GET</code>å‘½ä»¤ä¿®æ”¹ã€æŸ¥çœ‹é…ç½®ã€‚</strong></p><p><code>Redis</code> çš„æ‰€æœ‰ç‰¹æ€§å’ŒåŠŸèƒ½éƒ½åœ¨é…ç½®æ–‡ä»¶ä¸­æœ‰æ‰€ä½“ç°ï¼Œå»ºè®®ä»”ç»†äº†è§£ã€‚</p><p><strong>NETWORK</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1 ::1  <span class="comment"># å…è®¸æŒ‡å®šåœ°å€çš„hostè®¿é—®serverï¼Œå¦‚æœè¦å…¨éƒ¨éƒ½èƒ½è®¿é—®ï¼Œæ³¨é‡Šæ‰è¯¥è¡Œ</span></span><br><span class="line">                    <span class="comment"># æ³¨æ„ï¼Œå³ä½¿æ³¨é‡Šæ‰äº†bindï¼Œä½†protect-modeå¯åŠ¨äº†çš„ï¼Œ</span></span><br><span class="line">                    <span class="comment"># å¹¶ä¸”æ²¡æœ‰ç»™serverè®¾ç½®å¯†ç ï¼Œå¤–éƒ¨ä»ç„¶æ— æ³•è®¿é—®</span></span><br><span class="line">protected-mode <span class="built_in">yes</span>  <span class="comment"># ä¿æŠ¤æ¨¡å¼ï¼Œç¦æ­¢å…¶ä»–ä¸»æœºåœ¨æ— å¯†ç çš„æ–¹å¼ä¸‹è®¿é—®æœ¬æœºçš„redis-server</span></span><br><span class="line">port 6379           <span class="comment"># ç›‘å¬ç«¯å£å·</span></span><br><span class="line">tcp-backlog         <span class="comment"># è¿æ¥é˜Ÿåˆ—=æœªå®Œæˆä¸‰æ¬¡æ¡æ‰‹é˜Ÿåˆ—+å·²ç»å®Œæˆä¸‰æ¬¡æ¡æ‰‹é˜Ÿåˆ—ï¼Œé«˜å¹¶å‘ç¯å¢ƒä¸‹éœ€è¦é«˜ backlog å€¼</span></span><br><span class="line"><span class="built_in">timeout</span> 0           <span class="comment"># å®¢æˆ·ç«¯Nç§’ç©ºé—²åï¼Œå…³é—­è¿æ¥ï¼Œ0æ°¸ä¸å…³é—­</span></span><br><span class="line">tcp-keepalive 300   <span class="comment"># å¯¹è®¿é—®å®¢æˆ·ç«¯çš„ä¸€ç§å¿ƒè·³æ£€æµ‹ï¼Œæ¯ä¸ªnç§’æ£€æµ‹ä¸€æ¬¡ï¼Œå»ºè®®è®¾60</span></span><br><span class="line">unixsocket /tmp/redis.sock <span class="comment"># ä½¿ç”¨unixsocketè¿æ¥ï¼Œæ¯” ip+port æ•ˆç‡æ›´é«˜</span></span><br></pre></td></tr></table></figure><p><strong>GENERAL</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">daemonize <span class="built_in">yes</span>       <span class="comment"># è®¾ç½®å®ˆæŠ¤è¿›ç¨‹ï¼ˆåå°å¯åŠ¨ï¼‰ï¼Œå…³é—­å½“å‰ç»ˆç«¯åä¸ä¼šå…³é—­redis</span></span><br><span class="line">loglevel notice     <span class="comment"># æ—¥å¿—çº§åˆ«ï¼Œæ€»å…±æ”¯æŒå››ä¸ªçº§åˆ«ï¼šdebugã€verboseã€noticeã€warning</span></span><br><span class="line">logfile <span class="string">&quot;&quot;</span>          <span class="comment"># æŒ‡å®šæ—¥å¿—æ–‡ä»¶åç§°</span></span><br><span class="line">databases 16        <span class="comment"># è®¾ç½®åº“çš„æ•°é‡</span></span><br></pre></td></tr></table></figure><p><strong>SNAPSHOTTING</strong> ä¿å­˜æ•°æ®åˆ°ç£ç›˜æ–‡ä»¶ <strong>RDB</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">save 3600 1 300 100 60 10000</span><br><span class="line">                    <span class="comment"># æŒ‡å®šåœ¨å¤šé•¿æ—¶é—´å†…ï¼Œæœ‰å¤šå°‘æ¬¡æ›´æ–°æ“ä½œï¼Œå°±å°†æ•°æ®åŒæ­¥åˆ°æ•°æ®æ–‡ä»¶ï¼Œå¯å¤šä¸ªæ¡ä»¶é…åˆ</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span>  <span class="comment"># æŒ‡å®šå­˜å‚¨è‡³æœ¬åœ°æ•°æ®åº“æ—¶æ˜¯å¦å‹ç¼©æ•°æ®ï¼Œé»˜è®¤ä¸º yesï¼ŒRedis é‡‡ç”¨ LZF å‹ç¼©ï¼Œ</span></span><br><span class="line">                    <span class="comment"># å¦‚æœä¸ºäº†èŠ‚çœ CPU æ—¶é—´ï¼Œå¯ä»¥å…³é—­è¯¥é€‰é¡¹ï¼Œä½†ä¼šå¯¼è‡´æ•°æ®åº“æ–‡ä»¶å˜çš„å·¨å¤§</span></span><br><span class="line">dbfilename dump.rdb <span class="comment"># æŒ‡å®šæœ¬åœ°æ•°æ®åº“æ–‡ä»¶å</span></span><br><span class="line"><span class="built_in">dir</span> ./              <span class="comment"># æŒ‡å®šæœ¬åœ°æ•°æ®åº“æ–‡ä»¶çš„å­˜æ”¾è·¯å¾„</span></span><br></pre></td></tr></table></figure><p><strong>REPLICATION</strong> åŒæ­¥åˆ°ä»æœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">replicaof &lt;masterip&gt; &lt;masterport&gt;</span><br><span class="line">                    <span class="comment"># è®¾ç½®å½“æœ¬æœºä¸º slave æœåŠ¡æ—¶ï¼Œè®¾ç½® master æœåŠ¡çš„ IP åœ°å€åŠç«¯å£ï¼Œ</span></span><br><span class="line">                    <span class="comment"># åœ¨ Redis å¯åŠ¨æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä» master è¿›è¡Œæ•°æ®åŒæ­¥</span></span><br><span class="line">masterauth &lt;master-password&gt;</span><br><span class="line">                    <span class="comment"># å½“ master æœåŠ¡è®¾ç½®äº†å¯†ç ä¿æŠ¤æ—¶ï¼Œslave æœåŠ¡è¿æ¥ master çš„å¯†ç </span></span><br></pre></td></tr></table></figure><p><strong>SECURITY</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">requirepass 123456  <span class="comment"># è®¾ç½®serverå¯†ç ï¼Œé»˜è®¤ä¸å¸¦å¯†ç ï¼ï¼ï¼</span></span><br></pre></td></tr></table></figure><p><strong>CLIENTS</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">maxclients 120      <span class="comment"># æœ€å¤šè¿æ¥çš„å®¢æˆ·ç«¯æ•°ç›®ï¼Œè®¾ç½®åŒä¸€æ—¶é—´æœ€å¤§å®¢æˆ·ç«¯è¿æ¥æ•°ï¼Œé»˜è®¤æ— é™åˆ¶ï¼Œ</span></span><br><span class="line">                    <span class="comment"># Redis å¯åŒæ—¶æ‰“å¼€çš„å®¢æˆ·ç«¯è¿æ¥æ•°ä¸ºRedisè¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°</span></span><br></pre></td></tr></table></figure><p><strong>MEMORY</strong>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">maxmemory &lt;bytes&gt;   <span class="comment"># æŒ‡å®š Redis æœ€å¤§å†…å­˜é™åˆ¶ï¼ŒRedis æ•°æ®éƒ½åœ¨å†…å­˜ä¸­ï¼Œè¾¾åˆ°æœ€å¤§å†…å­˜åï¼Œ</span></span><br><span class="line">                    <span class="comment"># Redis ä¼šå…ˆå°è¯•æ¸…é™¤éƒ¨åˆ†keyï¼Œæ¸…é™¤ç­–ç•¥ç”± maxmemory-policy æŒ‡å®š</span></span><br><span class="line">                    <span class="comment"># è‹¥æ— æ³•æœ‰æ•ˆæ¸…é™¤ï¼Œå°†æ— æ³•å†è¿›è¡Œå†™å…¥æ“ä½œï¼Œä½†ä»ç„¶å¯ä»¥è¿›è¡Œè¯»å–æ“ä½œã€‚</span></span><br><span class="line">                    <span class="comment"># Redis æ–°çš„ vm æœºåˆ¶ï¼Œä¼šæŠŠ Key å­˜æ”¾å†…å­˜ï¼ŒValue ä¼šå­˜æ”¾åœ¨ swap åŒº</span></span><br><span class="line">maxmemory-policy noeviction</span><br><span class="line">                    <span class="comment"># volatile-lruï¼šä½¿ç”¨ LRU ç®—æ³•ç§»é™¤ keyï¼Œåªå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ï¼›</span></span><br><span class="line">                    <span class="comment"># allkeys-lruï¼šåœ¨æ‰€æœ‰é›†åˆ key ä¸­ï¼Œä½¿ç”¨ LRU ç®—æ³•ç§»é™¤ key</span></span><br><span class="line">                    <span class="comment"># LRUæ˜¯æ·˜æ±°æœ€é•¿æ—¶é—´æ²¡æœ‰è¢«ä½¿ç”¨çš„ï¼ŒLFUæ˜¯æ·˜æ±°ä¸€æ®µæ—¶é—´å†…ï¼Œä½¿ç”¨æ¬¡æ•°æœ€å°‘çš„</span></span><br><span class="line">                    <span class="comment"># volatile-lfuï¼šä½¿ç”¨ LFU ç®—æ³•ç§»é™¤ keyï¼Œåªå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ï¼›</span></span><br><span class="line">                    <span class="comment"># allkeys-lfuï¼šåœ¨æ‰€æœ‰é›†åˆ key ä¸­ï¼Œä½¿ç”¨ LFU ç®—æ³•ç§»é™¤ key</span></span><br><span class="line">                    <span class="comment"># volatile-randomï¼šåœ¨è¿‡æœŸé›†åˆä¸­ç§»é™¤éšæœºçš„ keyï¼Œåªå¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®</span></span><br><span class="line">                    <span class="comment"># allkeys-randomï¼šåœ¨æ‰€æœ‰é›†åˆ key ä¸­ï¼Œç§»é™¤éšæœºçš„ key</span></span><br><span class="line">                    <span class="comment"># volatile-ttlï¼šç§»é™¤é‚£äº› TTL å€¼æœ€å°çš„ keyï¼Œå³é‚£äº›æœ€è¿‘è¦è¿‡æœŸçš„ key</span></span><br><span class="line">                    <span class="comment"># noevictionï¼šä¸è¿›è¡Œç§»é™¤ã€‚é’ˆå¯¹å†™æ“ä½œï¼Œåªæ˜¯è¿”å›é”™è¯¯ä¿¡æ¯</span></span><br></pre></td></tr></table></figure><p><strong>APPEND ONLY MODE</strong> ä¿å­˜å†™æ“ä½œåˆ°æ–‡ä»¶ <strong>AOF</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">appendonly no       <span class="comment"># æ˜¯å¦å¯ç”¨AOFï¼Œå°†å†™æ“ä½œè®°å½•åˆ°æ–‡ä»¶ï¼Œä»¥ä¾¿é‡å¯æ—¶æ¢å¤æ•°æ®</span></span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line">                    <span class="comment"># æŒ‡å®šä¿å­˜æ“ä½œä¿¡æ¯çš„æ–‡ä»¶å</span></span><br><span class="line">appenddirname <span class="string">&quot;&quot;</span>    <span class="comment"># æŒ‡å®šä¿å­˜æ“ä½œä¿¡æ¯çš„æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">appendfsync no      <span class="comment"># æŒ‡å®šæ›´æ–°æ“ä½œè®°å½•çš„æ¡ä»¶ï¼š</span></span><br><span class="line">                    <span class="comment"># noï¼šè¡¨ç¤ºä¸ä¸»åŠ¨è¿›è¡ŒåŒæ­¥ï¼ŒæŠŠåŒæ­¥æ—¶æœºäº¤ç»™æ“ä½œç³»ç»Ÿã€‚</span></span><br><span class="line">                    <span class="comment"># alwaysï¼šå§‹ç»ˆåŒæ­¥ï¼Œæ¯æ¬¡Redisçš„å†™å…¥éƒ½ä¼šç«‹åˆ»è®°å…¥æ—¥å¿—ï¼›æ€§èƒ½è¾ƒå·®ä½†æ•°æ®å®Œæ•´æ€§æ¯”è¾ƒå¥½</span></span><br><span class="line">                    <span class="comment"># everysecï¼šè¡¨ç¤ºæ¯ç§’åŒæ­¥ä¸€æ¬¡ï¼Œå¦‚æœå®•æœºï¼Œæœ¬ç§’çš„æ•°æ®å¯èƒ½ä¸¢å¤±ã€‚</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">                    <span class="comment"># AOF é‡‡ç”¨æ–‡ä»¶è¿½åŠ æ–¹å¼ï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ä¸ºé¿å…å‡ºç°æ­¤ç§æƒ…å†µï¼Œæ–°å¢äº†é‡å†™æœºåˆ¶,</span></span><br><span class="line">                    <span class="comment"># å½“AOF æ–‡ä»¶çš„å¤§å°è¶…è¿‡æ‰€è®¾å®šçš„é˜ˆå€¼æ—¶ï¼ŒRedis å°±ä¼šå¯åŠ¨ AOF æ–‡ä»¶çš„å†…å®¹å‹ç¼©ï¼Œ</span></span><br><span class="line">                    <span class="comment"># åªä¿ç•™å¯ä»¥æ¢å¤æ•°æ®çš„æœ€å°æŒ‡ä»¤é›†</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">                    <span class="comment"># è®¾ç½®é‡å†™çš„åŸºå‡†å€¼ï¼Œæœ€å°æ–‡ä»¶ 64MBã€‚è¾¾åˆ°è¿™ä¸ªå€¼å¼€å§‹é‡å†™</span></span><br></pre></td></tr></table></figure><h3 id="Docker-è¿è¡Œ"><a href="#Docker-è¿è¡Œ" class="headerlink" title="Docker è¿è¡Œ"></a>Docker è¿è¡Œ</h3><p><code>Redis</code> å®˜æ–¹æœ‰æä¾›é•œåƒï¼Œå¯ç›´æ¥<code>docker pull redis:6.2.6</code>æ‹‰å–ã€‚</p><p>ä¸»è¦æ˜¯å¯åŠ¨æ—¶çš„ç«¯å£å’Œæ–‡ä»¶æ˜ å°„ï¼Œéœ€è¦æ ¹æ®<code>Redis</code>å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„å’Œä½¿ç”¨çš„ç«¯å£ç¡®å®šã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. å‡†å¤‡ä¸€ä¸ªç©ºæ–‡ä»¶å¤¹å­˜æ”¾redisç›¸å…³çš„æ•°æ®</span></span><br><span class="line"><span class="built_in">mkdir</span> redisdata &amp;&amp; <span class="built_in">cd</span> redisdata</span><br><span class="line"><span class="comment"># 2. åˆ›å»ºå¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢ç»™äº†ä¸€ä¸ªç¤ºä¾‹</span></span><br><span class="line">vim redis.conf</span><br><span class="line"><span class="comment"># 3. æ‹‰å– redis é•œåƒ</span></span><br><span class="line">docker pull redis:6.2.6</span><br><span class="line"><span class="comment"># 4. å¯åŠ¨å®¹å™¨ï¼Œä¸‹é¢éåå°è¿è¡Œï¼Œä½¿ç”¨ `-d` åå°è¿è¡Œ</span></span><br><span class="line">docker run --name redis -p 6379:6379 -v $(<span class="built_in">pwd</span>):/data \</span><br><span class="line">    redis:6.2.6 redis-server /data/redis.conf</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„äº‹é¡¹</strong>ï¼š</p><ol><li><p><strong>é…ç½®æ–‡ä»¶çš„ä¸­è®¾ç½®ä¸å¯¹ä¼šé€ æˆå®¹å™¨å¯åŠ¨ååˆé©¬ä¸Š</strong><code>Exit</code>ï¼Œä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># bind 127.0.0.1 ::1</span></span><br><span class="line"><span class="comment"># daemonize å¿…é¡»è®¾ç½®ä¸ºé»˜è®¤çš„ no</span></span><br><span class="line">daemonize no</span><br><span class="line"><span class="comment"># è®¾ç½®RDBå¤‡ä»½æ–‡ä»¶ç›®å½•</span></span><br><span class="line"><span class="built_in">dir</span> /data/</span><br><span class="line"><span class="comment"># ç›®å½•ä¸å­˜åœ¨ä¹Ÿä¼šå¯¼è‡´å®¹å™¨è‡ªåŠ¨åœæ­¢</span></span><br><span class="line">logfile <span class="string">&quot;/data/redis-server.log&quot;</span></span><br><span class="line"><span class="comment"># è®¾ç½®å¯†ç </span></span><br><span class="line">requirepass 123456</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®æ–‡ä»¶ä¸­çš„ç›¸å…³è·¯å¾„è¦æœ‰æ•ˆã€‚</p></li><li><p>å¦‚æœåœ¨ <code>Docker</code> ä¸­è¿è¡Œ <code>Redis</code> ï¼Œå¹¶ä¸”è®¾ç½® <code>daemonize</code> ä¸º <code>yes</code>ï¼Œå³å°† <code>Redis</code> è¿›ç¨‹å®ˆæŠ¤åŒ–æ—¶ï¼Œæœ€ç»ˆçš„ <code>Docker exec</code> è¿›ç¨‹ï¼ˆå¯åŠ¨ <code>Redis</code> çš„é‚£ä¸ªè¿›ç¨‹ï¼‰å°±æ— äº‹å¯åšäº†ï¼Œæ‰€ä»¥è¯¥è¿›ç¨‹é€€å‡ºï¼Œå®¹å™¨ä¹Ÿéšä¹‹ç»“æŸã€‚<a href="https://stackoverflow.com/questions/50790197/why-redis-in-docker-need-set-daemonize-to-no">æ¥è‡ª stackoverflow ä¸Šçš„å›ç­”</a></p></li><li><p>å¦‚æœå¸Œæœ› <code>redis</code> <strong>åå°è¿è¡Œå¯ä»¥ä½¿ç”¨ <code>-d</code> é€‰é¡¹</strong>ï¼Œä¸è¿‡è¿™æ ·å¯åŠ¨å¤±è´¥æ—¶éš¾ä»¥æŸ¥çœ‹é”™è¯¯çš„æ—¥å¿—ä¿¡æ¯ï¼Œæ‰€ä»¥å¯ä»¥å…ˆä¸å¸¦è¯¥é€‰é¡¹æµ‹è¯•æ˜¯å¦å¯æ­£å¸¸å¯åŠ¨ã€‚æ— è¯¯åå†ä½¿ç”¨<code>-d</code>é€‰é¡¹ã€‚</p></li><li><p><strong>å¯åŠ¨å¤±è´¥åï¼Œè®°å¾—åˆ é™¤æ‰è¯¥å®¹å™¨</strong>ï¼Œå†é‡æ–°å°è¯•å¯åŠ¨ï¼Œå¦åˆ™åå­—å†²çªå¯¼è‡´å¯åŠ¨å¤±è´¥ã€‚</p></li></ol><p>ä¹Ÿå¯ä»¥è‡ªåˆ¶é•œåƒï¼Œå°†è®¾ç½®å¥½çš„é…ç½®æ–‡ä»¶æ‹·è´åˆ°å®¹å™¨ä¸­ã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> redis</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> redis.conf /etc/redis/redis.conf</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [ <span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/etc/redis/redis.conf&quot;</span>]</span></span><br></pre></td></tr></table></figure><h2 id="åŸºç¡€æ“ä½œ"><a href="#åŸºç¡€æ“ä½œ" class="headerlink" title="åŸºç¡€æ“ä½œ"></a>åŸºç¡€æ“ä½œ</h2><h3 id="redis-cli"><a href="#redis-cli" class="headerlink" title="redis-cli"></a>redis-cli</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -h 127.0.0.1 -p 6379 -a password</span><br><span class="line"><span class="comment">#  -h &lt;hostname&gt;      Server hostname (default: 127.0.0.1).</span></span><br><span class="line"><span class="comment">#  -s &lt;socket&gt;        Server socket (overrides hostname and port).</span></span><br><span class="line"><span class="comment">#  -a &lt;password&gt;      Password to use when connecting to the server.</span></span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>auth</strong> passwd</td><td align="left">æˆæƒ</td></tr><tr><td align="left"><strong>ping</strong></td><td align="left">æµ‹è¯•è¿é€šæ€§</td></tr><tr><td align="left"><strong>shutdown</strong></td><td align="left">å…³é—­æ•°æ®åº“æœåŠ¡è¿›ç¨‹ <code>redis-server</code></td></tr><tr><td align="left"><strong>select</strong> index</td><td align="left">åˆ‡æ¢æ•°æ®åº“</td></tr><tr><td align="left"><strong>create</strong> index</td><td align="left">åˆ›å»ºæ•°æ®åº“</td></tr><tr><td align="left"><strong>drop</strong> index</td><td align="left">åˆ é™¤æ•°æ®åº“</td></tr></tbody></table><h3 id="Key"><a href="#Key" class="headerlink" title="Key"></a>Key</h3><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>keys</strong> *</td><td align="left">æŸ¥çœ‹å½“å‰åº“çš„æ‰€æœ‰key</td></tr><tr><td align="left"><strong>exists</strong> key</td><td align="left">æŸ¥çœ‹keyæ˜¯å¦å­˜åœ¨</td></tr><tr><td align="left"><strong>del</strong> key</td><td align="left">åˆ é™¤key</td></tr><tr><td align="left"><strong>unlink</strong> key</td><td align="left">åˆ é™¤keyï¼Œåªæ˜¯å°†keyä»æ•°æ®åº“ä¸­åˆ é™¤ï¼ŒçœŸæ­£çš„åˆ é™¤ä¼šåœ¨åç»­å¼‚æ­¥æ“ä½œ</td></tr><tr><td align="left"><strong>type</strong> key</td><td align="left">æŸ¥çœ‹keyçš„ç±»å‹</td></tr><tr><td align="left"><strong>expire</strong> key seconds</td><td align="left">è®¾ç½®keyçš„è¿‡æœŸæ—¶é—´</td></tr><tr><td align="left"><strong>ttl</strong> key</td><td align="left">æŸ¥çœ‹keyçš„è¿‡æœŸæ—¶é—´</td></tr><tr><td align="left"><strong>dbsize</strong></td><td align="left">æŸ¥çœ‹å½“å‰åº“çš„keyæ•°é‡</td></tr><tr><td align="left"><strong>flushdb</strong></td><td align="left">æ¸…ç©ºå½“å‰åº“</td></tr><tr><td align="left"><strong>flushall</strong></td><td align="left">æ¸…ç©ºæ‰€æœ‰åº“</td></tr></tbody></table><p>è™½ç„¶ <code>Redis</code> æ˜¯ <code>key-value</code> çš„æ–¹å¼å­˜å‚¨æ•°æ®ï¼Œ<code>key</code> ä¸ <code>key</code> ä¹‹é—´æ²¡æœ‰å…³ç³»ï¼Œä½†é€šå¸¸å¯ä»¥é€šè¿‡ <code>key</code> çš„å‘½åæ¥æä¾›ä¸€å®šçš„â€œä¿¡æ¯â€ï¼Œ<code>Redis</code> çš„å®˜æ–¹æ–‡æ¡£æ¨èä½¿ç”¨å†’å·<code>:</code>ä½œä¸ºé”®åçš„åˆ†éš”ç¬¦ï¼Œå› ä¸ºå®ƒå¯ä»¥æé«˜å¯è¯»æ€§å’Œç»´æŠ¤æ€§ï¼Œå¹¶ä¸”å¯ä»¥åˆ©ç”¨<code>SCAN</code>å‘½ä»¤è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚å¹¶ä¸”é€šå¸¸åœ¨ä½¿ç”¨ <code>GUI</code> å·¥å…·æŸ¥çœ‹æ•°æ®æ—¶ï¼Œä¹Ÿä¼šç”¨<code>:</code>æ¥åˆ†ç»„ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">set</span> <span class="string">md|dv:label:json</span> <span class="number">0</span></span><br><span class="line"><span class="string">set</span> <span class="string">md|dv:a94de756-b776-496b-bfe1-a6f3edd1d0cd</span> <span class="number">0</span></span><br><span class="line"><span class="string">set</span> <span class="string">md|dv:0f0a1014-43be-4531-95ee-34fdffc0b681</span> <span class="number">0</span></span><br><span class="line"><span class="string">set</span> <span class="string">md|dv:service:name:device-rest</span> <span class="number">0</span></span><br><span class="line"><span class="string">set</span> <span class="string">md|dv:label:float</span> <span class="number">0</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‡ ä¸ª <code>key</code> åœ¨ <code>redis-desktop-manager</code> ä¸­æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š</p><p><img src="/../images/Redis%E7%AC%94%E8%AE%B0/image-20230307231649741.png" alt="image-20230307231649741"></p><p>æ³¨æ„ï¼šæ˜¯ä»¥ <code>:</code> åˆ†å‰²ï¼Œ<code>key</code>ä¸­çš„<code>|</code>æ²¡æœ‰å®é™…æ„ä¹‰ã€‚</p><h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><p>String æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼Œå¯ä»¥åŒ…å«ä»»ä½•æ•°æ®ã€‚å¦‚jpgå›¾ç‰‡æˆ–è€…åºåˆ—åŒ–çš„å¯¹è±¡ï¼Œä½†æœ€å¤§é•¿åº¦512MBã€‚</p><p>String çš„æ•°æ®ç»“æ„ä¸ºåŠ¨æ€å­—ç¬¦ä¸²ï¼Œå½“å­—ç¬¦ä¸²å°äº1Mbæ—¶ï¼ŒåŠ å€æ‰©å®¹ï¼›å¤§äº1Mbæ—¶ï¼Œä¸€æ¬¡æ‰©å®¹å¢åŠ 1Mbã€‚</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>set</strong> key value</td><td align="left">è®¾ç½®keyçš„å€¼ï¼Œå¦‚æœkeyå­˜åœ¨ï¼Œåˆ™è¦†ç›–</td></tr><tr><td align="left"><strong>get</strong> key</td><td align="left">æŸ¥çœ‹ key å¯¹åº”çš„å€¼</td></tr><tr><td align="left"><strong>append</strong> key value</td><td align="left">åœ¨keyçš„å€¼åé¢è¿½åŠ value</td></tr><tr><td align="left"><strong>strlen</strong> key</td><td align="left">æŸ¥çœ‹keyçš„é•¿åº¦</td></tr><tr><td align="left"><strong>setnx</strong> key value</td><td align="left">åªæœ‰å½“keyä¸å­˜åœ¨æ—¶ï¼Œæ‰è®¾ç½®keyçš„å€¼ï¼Œå¦åˆ™ä¸è®¾ç½®</td></tr><tr><td align="left"><strong>incr</strong> key</td><td align="left">å°†keyçš„å€¼å¢åŠ 1</td></tr><tr><td align="left"><strong>decr</strong> key</td><td align="left">å°†keyçš„å€¼å‡å°‘1</td></tr><tr><td align="left"><strong>incrby</strong> key increment</td><td align="left">å°†keyçš„å€¼å¢åŠ increment</td></tr><tr><td align="left"><strong>decrby</strong> key decrement</td><td align="left">å°†keyçš„å€¼å‡å°‘decrement</td></tr></tbody></table><p><strong>æ‰¹é‡æ“ä½œçš„å‘½ä»¤</strong>ï¼š</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>mset</strong> key1 value1 â€¦ keyN valueN</td><td align="left">è®¾ç½®å¤šä¸ªkeyçš„å€¼</td></tr><tr><td align="left"><strong>mget</strong> key1 â€¦ keyN</td><td align="left">è·å–å¤šä¸ªkeyçš„å€¼</td></tr><tr><td align="left"><strong>msetnx</strong> key1 value1 â€¦ keyN valueN</td><td align="left">åªæœ‰å½“æ‰€æœ‰keyéƒ½ä¸å­˜åœ¨æ—¶ï¼Œæ‰è®¾ç½®å¤šä¸ªkeyçš„å€¼ï¼Œä¸€ä¸ªå¤±è´¥åˆ™å…¨éƒ¨å¤±è´¥</td></tr><tr><td align="left"><strong>getrange</strong> key start end</td><td align="left">è·å–keyçš„å€¼çš„ä¸€éƒ¨åˆ† [start, end], åŒ…å«start å’Œend</td></tr><tr><td align="left"><strong>setrange</strong> key offset value</td><td align="left">è®¾ç½®keyçš„å€¼çš„ä¸€éƒ¨åˆ† [offset, offset+value.length()], <br />å¦‚æœoffset+value.length()å¤§äºkeyçš„é•¿åº¦ï¼Œåˆ™æ‰©å±•keyçš„é•¿åº¦</td></tr><tr><td align="left"><strong>setex</strong> key seconds value</td><td align="left">è®¾ç½®keyçš„å€¼å¹¶è®¾ç½®è¿‡æœŸæ—¶é—´</td></tr><tr><td align="left"><strong>getset</strong> key value</td><td align="left">è®¾ç½®keyçš„å€¼ï¼Œå¹¶è¿”å›keyçš„æ—§å€¼</td></tr></tbody></table><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><p>åˆ—è¡¨æ˜¯å€¼çš„ç»“æ„ï¼Œå¤šä¸ªå­—ç¬¦ä¸²çš„é›†åˆï¼Œåº•å±‚æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œå¯¹ä¸¤ç«¯çš„æ“ä½œæ€§èƒ½å¾ˆé«˜ï¼Œå¯¹ä¸­é—´çš„æ“ä½œæ€§èƒ½è¾ƒå·®ã€‚</p><p>åº•å±‚ï¼šquicklistï¼Œå°†éƒ¨åˆ†æ•°æ®ç»„åˆä¸ºä¸€ä¸ªziplistï¼Œå¤šä¸ªziplisté€šè¿‡å‰åæŒ‡é’ˆç»„åˆä¸ºåŒå‘é“¾è¡¨ï¼ˆquicklistï¼‰ï¼Œé¿å…å¯¹å•ä¸ªå°å€¼å¦‚ int åˆ†é…ä¸¤ä¸ªå‰åæŒ‡é’ˆï¼ŒèŠ‚çº¦ç©ºé—´ã€‚</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>lpush</strong> key value</td><td align="left">åœ¨keyçš„å·¦è¾¹æ·»åŠ ä¸€ä¸ªå€¼ï¼ˆä¹Ÿå¯åŒæ—¶æ’å…¥å¤šä¸ªå€¼ï¼‰</td></tr><tr><td align="left"><strong>rpush</strong> key value</td><td align="left">åœ¨keyçš„å³è¾¹æ·»åŠ ä¸€ä¸ªå€¼</td></tr><tr><td align="left"><strong>lrange</strong> key start stop</td><td align="left">è·å–keyçš„å€¼çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…å«startå’Œstop</td></tr><tr><td align="left"><strong>lpop</strong> key</td><td align="left">åˆ é™¤å¹¶è¿”å›keyçš„å·¦è¾¹çš„å€¼ï¼ˆå€¼åœ¨é”®åœ¨ï¼Œå€¼ç©ºé”®æ¶ˆï¼‰</td></tr><tr><td align="left"><strong>rpop</strong> key</td><td align="left">åˆ é™¤å¹¶è¿”å›keyçš„å³è¾¹çš„å€¼</td></tr><tr><td align="left"><strong>lpoplpush</strong> source destination</td><td align="left">å°†sourceçš„å·¦è¾¹çš„å€¼ç§»åŠ¨åˆ°destinationçš„å³è¾¹</td></tr><tr><td align="left"><strong>lpoprpush</strong> source destination</td><td align="left">å°†sourceçš„å·¦è¾¹çš„å€¼ç§»åŠ¨åˆ°destinationçš„å³è¾¹</td></tr><tr><td align="left"><strong>rpoprpush</strong> source destination</td><td align="left">å°†sourceçš„å³è¾¹çš„å€¼ç§»åŠ¨åˆ°destinationçš„å·¦è¾¹</td></tr><tr><td align="left"><strong>rpoplpush</strong> source destination</td><td align="left">å°†sourceçš„å³è¾¹çš„å€¼ç§»åŠ¨åˆ°destinationçš„å·¦è¾¹</td></tr><tr><td align="left"><strong>lindex</strong> key index</td><td align="left">è·å–keyçš„å€¼çš„ç¬¬indexä¸ªå…ƒç´ </td></tr><tr><td align="left"><strong>llen</strong> key</td><td align="left">è·å–keyçš„å€¼çš„é•¿åº¦</td></tr><tr><td align="left"><strong>linsert</strong> key before</td><td align="left">after pivot value</td></tr><tr><td align="left"><strong>lrem</strong> key count value</td><td align="left">ä»å·¦è¾¹åˆ é™¤countä¸ªå€¼ä¸ºvalueçš„å…ƒç´ </td></tr><tr><td align="left"><strong>lset</strong> key index value</td><td align="left">è®¾ç½®keyçš„å€¼çš„ç¬¬indexä¸ªå…ƒç´ çš„å€¼</td></tr></tbody></table><h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><p>å€¼éƒ¨åˆ†ä¹Ÿæ˜¯ field-value ç»“æ„ï¼</p><p>åº•å±‚æœ‰ä¸¤ç§ï¼šå½“æ•°æ®è¾ƒå°‘æ—¶ç”¨zipistï¼Œå½“æ•°æ®è¾ƒå¤šæ—¶ç”¨hashtableã€‚</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>hset</strong> key field value</td><td align="left">è®¾ç½®keyçš„å€¼çš„fieldçš„å€¼</td></tr><tr><td align="left"><strong>hget</strong> key field</td><td align="left">è·å–keyçš„å€¼çš„fieldçš„å€¼</td></tr><tr><td align="left"><strong>hmset</strong> key field1 value1 â€¦ fieldN valueN</td><td align="left">è®¾ç½®keyçš„å€¼çš„å¤šä¸ªfieldçš„å€¼</td></tr><tr><td align="left"><strong>hexists</strong> key field</td><td align="left">åˆ¤æ–­keyçš„å€¼æ˜¯å¦åŒ…å«field</td></tr><tr><td align="left"><strong>hkeys</strong> key</td><td align="left">è·å–keyçš„å€¼çš„æ‰€æœ‰field</td></tr><tr><td align="left"><strong>hvals</strong> key</td><td align="left">è·å–keyçš„å€¼çš„æ‰€æœ‰value</td></tr><tr><td align="left"><strong>hlen</strong> key</td><td align="left">è·å–keyçš„å€¼çš„é•¿åº¦</td></tr><tr><td align="left"><strong>hdel</strong> key field</td><td align="left">åˆ é™¤keyçš„å€¼çš„field</td></tr><tr><td align="left"><strong>hincrby</strong> key field increment</td><td align="left">è®¾ç½®keyçš„å€¼çš„fieldçš„å€¼åŠ increment</td></tr><tr><td align="left"><strong>hsetnx</strong> key field value</td><td align="left">åªæœ‰åœ¨keyçš„å€¼çš„fieldä¸å­˜åœ¨æ—¶ï¼Œæ‰è®¾ç½®keyçš„å€¼çš„fieldçš„å€¼</td></tr></tbody></table><h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><p>string ç±»å‹çš„æ— åºé›†åˆï¼Œåº•å±‚ä¸ºå“ˆå¸Œè¡¨ï¼Œä¸listç±»ä¼¼ï¼Œä½†æ˜¯æ²¡æœ‰é‡å¤çš„å€¼ï¼Œæ¯ä¸ªå€¼éƒ½æ˜¯å”¯ä¸€çš„ã€‚</p><p>åº•å±‚ï¼šå­—å…¸ï¼Œç”¨hashå®ç°ã€‚</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>sadd</strong> key value</td><td align="left">å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°keyçš„é›†åˆä¸­</td></tr><tr><td align="left"><strong>smembers</strong> key</td><td align="left">è·å–keyçš„å€¼çš„æ‰€æœ‰å…ƒç´ </td></tr><tr><td align="left"><strong>sismember</strong> key value</td><td align="left">åˆ¤æ–­keyçš„å€¼æ˜¯å¦åŒ…å«value</td></tr><tr><td align="left"><strong>scard</strong> key</td><td align="left">è·å–keyçš„å€¼çš„é•¿åº¦</td></tr><tr><td align="left"><strong>srem</strong> key value</td><td align="left">åˆ é™¤keyçš„å€¼ä¸­çš„value</td></tr><tr><td align="left"><strong>spop</strong> key</td><td align="left">éšæœºè·å–å¹¶åˆ é™¤keyçš„å€¼ä¸­çš„ä¸€ä¸ªå…ƒç´ </td></tr><tr><td align="left"><strong>srandmember</strong> key</td><td align="left">éšæœºè·å–keyçš„å€¼ä¸­çš„ä¸€ä¸ªå…ƒç´ ï¼Œä½†ä¸åˆ é™¤</td></tr><tr><td align="left"><strong>smove</strong> source destination value</td><td align="left">å°†sourceçš„å€¼ä¸­çš„valueç§»åŠ¨åˆ°destinationçš„å€¼ä¸­</td></tr><tr><td align="left"><strong>sinter</strong> source1 â€¦ sourceN</td><td align="left">è·å–æ‰€æœ‰sourceçš„å€¼çš„äº¤é›†</td></tr><tr><td align="left"><strong>sunion</strong> source1 â€¦ sourceN</td><td align="left">è·å–æ‰€æœ‰sourceçš„å€¼çš„å¹¶é›†</td></tr><tr><td align="left"><strong>sdiff</strong> source1 â€¦ sourceN</td><td align="left">è·å–æ‰€æœ‰sourceçš„å€¼çš„å·®é›†</td></tr></tbody></table><h3 id="Zset"><a href="#Zset" class="headerlink" title="Zset"></a>Zset</h3><p>ä¸setç±»ä¼¼ï¼Œä½†æ˜¯ä¸€ä¸ªæœ‰åºé›†åˆï¼Œæ¯ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªscoreï¼Œscoreè¶Šå°ï¼Œç¼–å·è¶Šå°</p><p>åº•å±‚ï¼šhash + è·³è·ƒè¡¨</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>zadd</strong> key score value</td><td align="left">å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°keyçš„æœ‰åºé›†åˆä¸­</td></tr><tr><td align="left"><strong>zrange</strong> key start stop [withscores]</td><td align="left">è·å–keyçš„å€¼çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…å«startå’Œstop</td></tr><tr><td align="left"><strong>zrangebyscore</strong> key min max [withscores]</td><td align="left">è·å–keyçš„å€¼çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…å«minå’Œmax</td></tr><tr><td align="left"><strong>zrevrangebyscore</strong> key max min [withscores]</td><td align="left">è·å–keyçš„å€¼çš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…å«maxå’Œmin</td></tr><tr><td align="left"><strong>zincrby</strong> key increment value</td><td align="left">è®¾ç½®keyçš„å€¼çš„fieldçš„å€¼åŠ increment</td></tr><tr><td align="left"><strong>zrem</strong> key value</td><td align="left">åˆ é™¤keyæŒ‡å®šå€¼çš„field</td></tr><tr><td align="left"><strong>zcount</strong> key min max</td><td align="left">è·å–æŒ‡å®šåŒºé—´çš„å…ƒç´ ä¸ªæ•°</td></tr><tr><td align="left"><strong>zrank</strong> key value</td><td align="left">è·å–keyçš„å€¼çš„fieldçš„ç¼–å·ï¼Œä»0å¼€å§‹</td></tr></tbody></table><h3 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h3><p>bitmaps æœ¬èº«ä¸æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œå°±æ˜¯å­—ç¬¦ä¸²ï¼Œä½†å¯ä»¥å¯¹ä½è¿›è¡Œæ“ä½œã€‚å¯ä»¥æŠŠbitmapsæƒ³è±¡æˆä¸€ä¸ªä»¥ä½ä¸ºå•ä½çš„æ•°ç»„ï¼Œæ¯ä¸€ä½åªèƒ½å­˜å‚¨0æˆ–1ï¼Œæ•°ç»„çš„ä¸‹æ ‡åœ¨bitmapsä¸­å«åšåç§»é‡offsetã€‚</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>setbit</strong> key offset value</td><td align="left">value åªèƒ½æ˜¯ 0 æˆ– 1</td></tr><tr><td align="left"><strong>getbit</strong> key offset</td><td align="left">è·å–åç§»ä½ä¸Šçš„å€¼</td></tr><tr><td align="left"><strong>bitcount</strong> key [start end]</td><td align="left">è·å–æŒ‡å®šåŒºé—´ï¼ˆæœªæŒ‡å®šåŒºé—´åˆ™å…¨éƒ¨ï¼‰çš„<code>1</code>å…ƒç´ ä¸ªæ•°ï¼Œ<strong>åŒºé—´å•ä½æ˜¯å­—èŠ‚byte è€Œä¸æ˜¯ bit</strong></td></tr><tr><td align="left"><strong>bitop</strong> operation destkey srckey1 â€¦ srckeyN</td><td align="left">è¿›è¡ŒæŒ‡å®šæ“ä½œï¼Œæ“ä½œç±»å‹æœ‰ï¼šand, or, xor, not</td></tr></tbody></table><h3 id="Geo"><a href="#Geo" class="headerlink" title="Geo"></a>Geo</h3><p>å°±æ˜¯å…ƒç´ çš„äºŒç»´åæ ‡ï¼Œåœ¨åœ°å›¾ä¸Šå°±æ˜¯ç»çº¬åº¦ã€‚redisæä¾›äº†ç»çº¬åº¦è®¾ç½®ã€æŸ¥è¯¢ã€èŒƒå›´æŸ¥è¯¢ã€è·ç¦»æŸ¥è¯¢ã€ç»çº¬åº¦Hashç­‰åŠŸèƒ½ã€‚</p><p>æœ‰æ•ˆçš„ç»çº¬åº¦èŒƒå›´æ˜¯ï¼š-180&lt;&#x3D;ç»åº¦&lt;&#x3D;180, -85&lt;&#x3D;çº¬åº¦&lt;&#x3D;85ï¼Œåæ ‡ä½ç½®è¶…è¿‡èŒƒå›´æ—¶ï¼Œè¿”å›é”™è¯¯ã€‚</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>geoadd</strong> key longitude latitude member [longitude latitude member â€¦]</td><td align="left">å°†ä¸€ä¸ªæˆ–å¤šä¸ªå€¼æ’å…¥åˆ°keyçš„Geoä¸­</td></tr><tr><td align="left"><strong>geodist</strong> key member1 member2</td><td align="left">è·å–ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»</td></tr><tr><td align="left"><strong>geopos</strong> key member1 member2</td><td align="left">è·å–ä¸¤ä¸ªå…ƒç´ çš„åæ ‡</td></tr><tr><td align="left"><strong>geodist</strong> key member1 member2 [m&#x2F;km&#x2F;ft&#x2F;mi]</td><td align="left">è·å–ä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„è·ç¦»</td></tr><tr><td align="left"><strong>georadius</strong> key longitude latitude radius [m&#x2F;km&#x2F;ft&#x2F;mi]</td><td align="left">è·å–æŒ‡å®šèŒƒå›´å†…çš„å…ƒç´ </td></tr></tbody></table><h2 id="äº‹ç‰©"><a href="#äº‹ç‰©" class="headerlink" title="äº‹ç‰©"></a>äº‹ç‰©</h2><p>Redis äº‹åŠ¡æ˜¯ä¸€ä¸ªå•ç‹¬çš„éš”ç¦»æ“ä½œï¼šäº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­ã€‚</p><p><strong>Redis äº‹åŠ¡çš„ä¸»è¦ä½œç”¨å°±æ˜¯ä¸²è”å¤šä¸ªå‘½ä»¤é˜²æ­¢åˆ«çš„å‘½ä»¤æ’é˜Ÿã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi           <span class="comment"># å¼€å§‹è®°å½•</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> k1 v1   <span class="comment"># å‘½ä»¤å…¥é˜Ÿ</span></span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> k2 v1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span>        <span class="comment"># æ‰§è¡Œå‘½ä»¤</span></span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) OK</span><br><span class="line">127.0.0.1:6379&gt; get k3          <span class="comment"># æŸ¥çœ‹äº‹ç‰©æ‰§è¡Œæƒ…å†µ</span></span><br><span class="line"><span class="string">&quot;v3&quot;</span></span><br></pre></td></tr></table></figure><p>ä»è¾“å…¥ Multi å‘½ä»¤å¼€å§‹ï¼Œè¾“å…¥çš„å‘½ä»¤éƒ½ä¼šä¾æ¬¡è¿›å…¥å‘½ä»¤é˜Ÿåˆ—ä¸­ï¼Œä½†ä¸ä¼šæ‰§è¡Œï¼Œç›´åˆ°è¾“å…¥ Exec åï¼ŒRedis ä¼šå°†ä¹‹å‰çš„å‘½ä»¤é˜Ÿåˆ—ä¸­çš„å‘½ä»¤ä¾æ¬¡æ‰§è¡Œã€‚ç»„é˜Ÿçš„è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡ discard æ¥æ”¾å¼ƒç»„é˜Ÿã€‚</p><h3 id="é”™è¯¯"><a href="#é”™è¯¯" class="headerlink" title="é”™è¯¯"></a>é”™è¯¯</h3><p>é”™è¯¯å¯èƒ½å‘ç”Ÿåœ¨<strong>ç»„é˜Ÿé˜¶æ®µ</strong>ï¼Œæˆ–è€…<strong>æ‰§è¡Œé˜¶æ®µ</strong>ã€‚</p><ul><li><strong>ç»„é˜Ÿä¸­æŸä¸ªå‘½ä»¤å‡ºç°äº†æŠ¥å‘Šé”™è¯¯ï¼Œæ‰§è¡Œæ—¶æ•´ä¸ªçš„æ‰€æœ‰é˜Ÿåˆ—éƒ½ä¼šè¢«å–æ¶ˆã€‚</strong></li><li><strong>å¦‚æœæ‰§è¡Œé˜¶æ®µæŸä¸ªå‘½ä»¤æŠ¥å‡ºäº†é”™è¯¯ï¼Œåˆ™åªæœ‰æŠ¥é”™çš„å‘½ä»¤ä¸ä¼šè¢«æ‰§è¡Œï¼Œè€Œå…¶ä»–çš„å‘½ä»¤éƒ½ä¼šæ‰§è¡Œï¼Œä¸ä¼šå›æ»šã€‚</strong></li></ul><h3 id="äº‹åŠ¡ä¸‰ç‰¹æ€§"><a href="#äº‹åŠ¡ä¸‰ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡ä¸‰ç‰¹æ€§"></a>äº‹åŠ¡ä¸‰ç‰¹æ€§</h3><ol><li><strong>å•ç‹¬çš„éš”ç¦»æ“ä½œ</strong><br> äº‹åŠ¡ä¸­çš„æ‰€æœ‰å‘½ä»¤éƒ½ä¼šåºåˆ—åŒ–ã€æŒ‰é¡ºåºåœ°æ‰§è¡Œã€‚äº‹åŠ¡åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šè¢«å…¶ä»–å®¢æˆ·ç«¯å‘é€æ¥çš„å‘½ä»¤è¯·æ±‚æ‰€æ‰“æ–­ã€‚</li><li><strong>æ²¡æœ‰éš”ç¦»çº§åˆ«çš„æ¦‚å¿µ</strong><br> é˜Ÿåˆ—ä¸­çš„å‘½ä»¤æ²¡æœ‰æäº¤ä¹‹å‰éƒ½ä¸ä¼šå®é™…è¢«æ‰§è¡Œï¼Œå› ä¸ºäº‹åŠ¡æäº¤å‰ä»»ä½•æŒ‡ä»¤éƒ½ä¸ä¼šè¢«å®é™…æ‰§è¡Œ</li><li><strong>ä¸ä¿è¯åŸå­æ€§</strong><br> äº‹åŠ¡ä¸­å¦‚æœæœ‰ä¸€æ¡å‘½ä»¤æ‰§è¡Œå¤±è´¥ï¼Œå…¶åçš„å‘½ä»¤ä»ç„¶ä¼šè¢«æ‰§è¡Œï¼Œæ²¡æœ‰å›æ»š</li></ol><h2 id="hiredis-x2F-redis"><a href="#hiredis-x2F-redis" class="headerlink" title="hiredis&#x2F;redis++"></a>hiredis&#x2F;redis++</h2><p>å¼‚æ­¥æ“ä½œçš„å‘½ä»¤ï¼Œæˆ–ä½¿ç”¨äº†å›è°ƒå‡½æ•°çš„æ“ä½œæ²¡æœ‰ç»™å‡ºä¾‹å­ã€‚</p><h3 id="redis-cli-å»ºç«‹è¿æ¥"><a href="#redis-cli-å»ºç«‹è¿æ¥" class="headerlink" title="redis-cli å»ºç«‹è¿æ¥"></a>redis-cli å»ºç«‹è¿æ¥</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sw/redis++/redis++.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">sw::<span class="function">redis::Redis <span class="title">redis</span><span class="params">(<span class="string">&quot;tcp://127.0.0.1:6379&quot;</span>)</span></span>;</span><br><span class="line">sw::<span class="function">redis::Redis <span class="title">redis</span><span class="params">(<span class="string">&quot;tcp://127.0.0.1:6379&quot;</span>, <span class="string">&quot;password&quot;</span>)</span></span>;</span><br></pre></td></tr></table></figure><h3 id="Key-ops"><a href="#Key-ops" class="headerlink" title="Key ops"></a>Key ops</h3><table><thead><tr><th align="left">cmd</th><th align="left"><code>redis++</code></th></tr></thead><tbody><tr><td align="left"><strong>keys</strong> *</td><td align="left"><code>std::vector&lt;std::string&gt; keys = redis.keys(&quot;*&quot;);</code></td></tr><tr><td align="left"><strong>exists</strong> key</td><td align="left"><code>bool exists = redis.exists(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>del</strong> key</td><td align="left"><code>int deleted = redis.del(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>unlink</strong> key</td><td align="left"><code>int unlinked = redis.unlink(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>type</strong> key</td><td align="left"><code>sw::redis::RedisType type = redis.type(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>expire</strong> key seconds</td><td align="left"><code>bool success = redis.expire(&quot;key&quot;, 60);</code></td></tr><tr><td align="left"><strong>ttl</strong> key</td><td align="left"><code>long long ttl = redis.ttl(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>dbsize</strong></td><td align="left"><code>long long size = redis.dbsize();</code></td></tr><tr><td align="left"><strong>flushdb</strong></td><td align="left"><code>bool success = redis.flushdb();</code></td></tr><tr><td align="left"><strong>flushall</strong></td><td align="left"><code>bool success = redis.flushall();</code></td></tr></tbody></table><h3 id="String-ops"><a href="#String-ops" class="headerlink" title="String ops"></a>String ops</h3><table><thead><tr><th align="left">cmd</th><th align="left"><code>redis++</code></th></tr></thead><tbody><tr><td align="left"><strong>set</strong> key value</td><td align="left"><code>bool success = redis.set(&quot;key&quot;, &quot;value&quot;);</code></td></tr><tr><td align="left"><strong>get</strong> key</td><td align="left"><code>std::string value = redis.get(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>append</strong> key value</td><td align="left"><code>int length = redis.append(&quot;key&quot;, &quot;value&quot;);</code></td></tr><tr><td align="left"><strong>strlen</strong> key</td><td align="left"><code>int length = redis.strlen(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>setnx</strong> key value</td><td align="left"><code>bool success = redis.setnx(&quot;key&quot;, &quot;value&quot;);</code></td></tr><tr><td align="left"><strong>incr</strong> key</td><td align="left"><code>long long result = redis.incr(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>decr</strong> key</td><td align="left"><code>long long result = redis.decr(&quot;key&quot;);</code></td></tr><tr><td align="left"><strong>incrby</strong> key increment</td><td align="left"><code>long long result = redis.incrby(&quot;key&quot;, 10);</code></td></tr><tr><td align="left"><strong>decrby</strong> key decrement</td><td align="left"><code>long long result = redis.decrby(&quot;key&quot;, 10);</code></td></tr></tbody></table><p><strong>æ‰¹é‡æ“ä½œçš„å‘½ä»¤</strong>ï¼š</p><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>mset</strong> key1 value1 â€¦ keyN valueN</td><td align="left"><code>bool success = redis.mset(&#123;&quot;key1&quot;, &quot;value1&quot;, &quot;key2&quot;, &quot;value2&quot;&#125;);</code></td></tr><tr><td align="left"><strong>mget</strong> key1 â€¦ keyN</td><td align="left"><code>std::vector&lt;std::string&gt; values = redis.mget(&#123;&quot;key1&quot;, &quot;key2&quot;&#125;);</code></td></tr><tr><td align="left"><strong>msetnx</strong> key1 value1 â€¦ keyN valueN</td><td align="left"><code>bool success = redis.msetnx(&#123;&quot;key1&quot;, &quot;value1&quot;, &quot;key2&quot;, &quot;value2&quot;&#125;);</code></td></tr><tr><td align="left"><strong>getrange</strong> key start end</td><td align="left"><code>std::string sub = redis.getrange(&quot;key&quot;, 1, 3);</code></td></tr><tr><td align="left"><strong>setrange</strong> key offset value</td><td align="left"><code>int length = redis.setrange(&quot;key&quot;, 1, &quot;new&quot;);</code></td></tr><tr><td align="left"><strong>setex</strong> key seconds value</td><td align="left"><code>bool success = redis.setex(&quot;key&quot;, 60, &quot;value&quot;);</code></td></tr><tr><td align="left"><strong>getset</strong> key value</td><td align="left">è®¾ç½®keyçš„å€¼ï¼Œå¹¶è¿”å›keyçš„æ—§å€¼</td></tr></tbody></table><h3 id="List-ops"><a href="#List-ops" class="headerlink" title="List ops"></a>List ops</h3><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>lpush</strong> key value</td><td align="left"><code>int length = redis.lpush(&quot;list&quot;, &quot;element1&quot;, &quot;element2&quot;);</code></td></tr><tr><td align="left"><strong>rpush</strong> key value</td><td align="left"><code>int length = redis.rpush(&quot;list&quot;, &quot;element1&quot;, &quot;element2&quot;);</code></td></tr><tr><td align="left"><strong>lrange</strong> key start stop</td><td align="left"><code>std::vector&lt;std::string&gt; elements = redis.lrange(&quot;list&quot;, 0, -1);</code></td></tr><tr><td align="left"><strong>lpop</strong> key</td><td align="left"><code>std::string element = redis.lpop(&quot;list&quot;);</code></td></tr><tr><td align="left"><strong>rpop</strong> key</td><td align="left"><code>std::string element = redis.rpop(&quot;list&quot;);</code></td></tr><tr><td align="left"><strong>lpoplpush</strong> source destination</td><td align="left"><code>bool success = redis.lpoplpush(&quot;source&quot;, &quot;destination&quot;);</code></td></tr><tr><td align="left"><strong>lpoprpush</strong> source destination</td><td align="left"><code>bool success = redis.lpoprpush(&quot;source&quot;, &quot;destination&quot;);</code></td></tr><tr><td align="left"><strong>rpoprpush</strong> source destination</td><td align="left"><code>bool success = redis.rpoprpush(&quot;source&quot;, &quot;destination&quot;);</code></td></tr><tr><td align="left"><strong>rpoplpush</strong> source destination</td><td align="left"><code>bool success = redis.rpoplpush(&quot;source&quot;, &quot;destination&quot;);</code></td></tr><tr><td align="left"><strong>llen</strong> key</td><td align="left"><code>int64_t len = redis.llen(&quot;mylist&quot;);</code></td></tr><tr><td align="left"><strong>lindex</strong> key index</td><td align="left">è·å–keyçš„å€¼çš„ç¬¬indexä¸ªå…ƒç´ </td></tr><tr><td align="left"><strong>linsert</strong> key before</td><td align="left">after pivot value</td></tr><tr><td align="left"><strong>lrem</strong> key count value</td><td align="left">ä»å·¦è¾¹åˆ é™¤countä¸ªå€¼ä¸ºvalueçš„å…ƒç´ </td></tr><tr><td align="left"><strong>lset</strong> key index value</td><td align="left">è®¾ç½®keyçš„å€¼çš„ç¬¬indexä¸ªå…ƒç´ çš„å€¼</td></tr></tbody></table><h3 id="Hash-ops"><a href="#Hash-ops" class="headerlink" title="Hash ops"></a>Hash ops</h3><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>hset</strong> key field value</td><td align="left"><code>bool success = redis.hset(&quot;hash&quot;, &quot;field&quot;, &quot;value&quot;);</code></td></tr><tr><td align="left"><strong>hget</strong> key field</td><td align="left"><code>std::string value = redis.hget(&quot;hash&quot;, &quot;field&quot;);</code></td></tr><tr><td align="left"><strong>hmset</strong> key field1 value1 â€¦ fieldN valueN</td><td align="left"><code>bool success = redis.hmset(&quot;hash&quot;, &#123;&#123;"field1", "value1"&#125;, &#123;"field2", "value2"&#125;&#125;);</code></td></tr><tr><td align="left"><strong>hexists</strong> key field</td><td align="left"><code>bool exists = redis.hexists(&quot;hash&quot;, &quot;field&quot;);</code></td></tr><tr><td align="left"><strong>hkeys</strong> key</td><td align="left"><code>std::vector&lt;std::string&gt; fields = redis.hkeys(&quot;hash&quot;);</code></td></tr><tr><td align="left"><strong>hvals</strong> key</td><td align="left"><code>std::vector&lt;std::string&gt; values = redis.hvals(&quot;hash&quot;);</code></td></tr><tr><td align="left"><strong>hlen</strong> key</td><td align="left"><code>int count = redis.hlen(&quot;hash&quot;);</code></td></tr><tr><td align="left"><strong>hdel</strong> key field</td><td align="left"><code>bool success = redis.hdel(&quot;hash&quot;, &quot;field&quot;);</code></td></tr><tr><td align="left"><strong>hincrby</strong> key field increment</td><td align="left"><code>int value = redis.hincrby(&quot;hash&quot;, &quot;field&quot;, 1);</code></td></tr><tr><td align="left"><strong>hsetnx</strong> key field value</td><td align="left"><code>bool success = redis.hsetnx(&quot;hash&quot;, &quot;field&quot;, &quot;value&quot;);</code></td></tr></tbody></table><h3 id="Set-ops"><a href="#Set-ops" class="headerlink" title="Set ops"></a>Set ops</h3><table><thead><tr><th align="left">cmd</th><th align="left">explain</th></tr></thead><tbody><tr><td align="left"><strong>sadd</strong> key value</td><td align="left"><code>int count = redis.sadd(&quot;set&quot;, &#123;&quot;elem1&quot;, &quot;elem2&quot;, &quot;elem3&quot;&#125;);</code></td></tr><tr><td align="left"><strong>smembers</strong> key</td><td align="left"><code>std::vector&lt;std::string&gt; members = redis.smembers(&quot;set&quot;);</code></td></tr><tr><td align="left"><strong>sismember</strong> key value</td><td align="left"><code>bool exist = redis.sismember(&quot;set&quot;, &quot;elem&quot;);</code></td></tr><tr><td align="left"><strong>scard</strong> key</td><td align="left"><code>int count = redis.scard(&quot;set&quot;);</code></td></tr><tr><td align="left"><strong>srem</strong> key value</td><td align="left"><code>int count = redis.srem(&quot;set&quot;, &#123;&quot;elem1&quot;, &quot;elem2&quot;&#125;);</code></td></tr><tr><td align="left"><strong>spop</strong> key</td><td align="left"><code>std::string elem = redis.spop(&quot;set&quot;);</code></td></tr><tr><td align="left"><strong>srandmember</strong> key</td><td align="left"><code>std::vector&lt;std::string&gt; elems = redis.srandmember(&quot;set&quot;, 2);</code></td></tr><tr><td align="left"><strong>smove</strong> source destination value</td><td align="left"><code>bool success = redis.smove(&quot;set1&quot;, &quot;set2&quot;, &quot;elem&quot;);</code></td></tr><tr><td align="left"><strong>sinter</strong> source1 â€¦ sourceN</td><td align="left"><code>std::vector&lt;std::string&gt; elems = redis.sinter(&#123;&quot;set1&quot;, &quot;set2&quot;&#125;);</code></td></tr></tbody></table><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://www.runoob.com/redis/redis-tutorial.html">redis èœé¸Ÿæ•™ç¨‹</a></li><li><a href="https://redis.io/commands/">å®˜æ–¹å‘½ä»¤æ–‡æ¡£æŸ¥è¯¢</a></li><li><a href="https://redis.io/docs/clients/">Rediså®˜æ–¹æ¨èçš„å„è¯­è¨€çš„clientåº“</a></li><li><a href="https://www.runoob.com/w3cnote/python-redis-intro.html">python ä¸­é€šè¿‡redis-pyä½¿ç”¨redis</a></li><li><a href="https://www.bilibili.com/video/BV1Rv41177Af">ã€å°šç¡…è°·ã€‘Redis 6 å…¥é—¨åˆ°ç²¾é€š</a> æœ‰è®²ä¹‰</li></ul>]]></content>
      
      
      <categories>
          
          <category> Redis </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> Redis </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVSwitch-æ§åˆ¶å™¨ONOS</title>
      <link href="/2022/06/03/OpenVSwitch-%E6%8E%A7%E5%88%B6%E5%99%A8ONOS/"/>
      <url>/2022/06/03/OpenVSwitch-%E6%8E%A7%E5%88%B6%E5%99%A8ONOS/</url>
      
        <content type="html"><![CDATA[<h2 id="å®‰è£…å¯åŠ¨"><a href="#å®‰è£…å¯åŠ¨" class="headerlink" title="å®‰è£…å¯åŠ¨"></a>å®‰è£…å¯åŠ¨</h2><p>ç›´æ¥ä½¿ç”¨ <code>docker</code> å®‰è£…æœ€æ–¹ä¾¿ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull onosproject/onos</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ï¼Œåšç«¯å£æ˜ å°„ï¼Œä¸éœ€è¦çš„å¯ä»¥å»æ‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -t -d -p 8181:8181 -p 8101:8101 -p 6653:6653 -p 6640:6640 --name onos onosproject/onos</span><br></pre></td></tr></table></figure><ul><li>8181 - REST API å’Œ GUI</li><li>8101 - ONOS CLI</li><li>9876 - é›†ç¾¤å†…é€šä¿¡</li><li>6653 - Openflow é€šä¿¡ï¼ŒOVS è¿æ¥æ§åˆ¶å™¨ä½¿ç”¨æ­¤ç«¯å£ï¼ˆæµè¡¨ç›¸å…³æ“ä½œï¼‰</li><li>6640 - OVSDBï¼ŒOVS ç½‘æ¡¥ã€ç«¯å£ç›¸å…³çš„é…ç½®</li></ul><p>å¯ç”¨åº”ç”¨ï¼Œç”¨äºæ§åˆ¶OVSæ—¶ï¼Œæ‰“å¼€ä¸‹é¢çš„åº”ç”¨ï¼Œå¯é€šè¿‡<code>UI</code> ç•Œé¢æ“ä½œï¼Œä¹Ÿå¯åœ¨å®¹å™¨ä¸­ç”¨å‘½ä»¤è¡Œæ–¹å¼å¯ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it onos bash</span><br><span class="line"><span class="built_in">cd</span> bin</span><br><span class="line">./onos-app localhost activate org.onosproject.openflow-base</span><br><span class="line">./onos-app localhost activate org.onosproject.ofagent</span><br><span class="line">./onos-app localhost activate org.onosproject.fwd</span><br><span class="line">./onos-app localhost activate org.onosproject.drivers.ovsdb</span><br><span class="line">./onos-app localhost activate org.onosproject.proxyarp</span><br><span class="line">./onos-app localhost activate org.onosproject.lldpprovider</span><br></pre></td></tr></table></figure><p><code>lldpprovider</code> æ˜¯ç”¨äºæ‹“æ‰‘å‘ç°çš„ï¼Œå¯ç”¨è¯¥åº”ç”¨åï¼Œåœ¨ <code>UI/topology</code> å¯ä»¥çœ‹åˆ°èŠ‚ç‚¹æ˜¯å¦æœ‰é“¾è·¯ç›´è¿ã€‚</p><h3 id="å¸¸ç”¨é¡µé¢"><a href="#å¸¸ç”¨é¡µé¢" class="headerlink" title="å¸¸ç”¨é¡µé¢"></a>å¸¸ç”¨é¡µé¢</h3><ol><li>UI é¡µé¢åœ°å€ï¼š<a href="http://localhost:8181/onos/ui/">http://localhost:8181/onos/ui/</a> ç”¨æˆ·åï¼šonosï¼Œå¯†ç ï¼šrocks</li><li>RESTFUL æ¥å£æ–‡æ¡£ï¼š<a href="http://localhost:8181/onos/v1/docs/">http://localhost:8181/onos/v1/docs/</a></li><li>æµè¡¨ç»„æˆè¯´æ˜ï¼š<a href="https://wiki.onosproject.org/display/ONOS/Flow+Rules">https://wiki.onosproject.org/display/ONOS/Flow+Rules</a></li><li>ONOS wikiï¼Œä¹Ÿå°±æ˜¯å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://wiki.onosproject.org/">https://wiki.onosproject.org</a></li></ol><h3 id="è¿æ¥ONOS-CLI"><a href="#è¿æ¥ONOS-CLI" class="headerlink" title="è¿æ¥ONOS CLI"></a>è¿æ¥ONOS CLI</h3><ol><li>æ‰“å¼€ç»ˆç«¯å¹¶è¾“å…¥ä»¥ä¸‹å‘½ä»¤ï¼Œä»¥è¿æ¥åˆ°ONOSçš„è¿œç¨‹å‘½ä»¤è¡Œç•Œé¢ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">phpCopy code</span><br><span class="line">ssh &lt;username&gt;@&lt;onos-ip-address&gt; -p 8101</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œ<code>&lt;username&gt;</code> æ˜¯æ‚¨è¿æ¥åˆ°ONOSçš„ç”¨æˆ·åï¼Œ<code>&lt;onos-ip-address&gt;</code> æ˜¯ONOSçš„IPåœ°å€ã€‚</p><ol><li>æŒ‰å›è½¦é”®æ‰§è¡Œå‘½ä»¤ï¼Œå¹¶è¾“å…¥æ‚¨çš„å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰ã€‚</li><li>è¿æ¥æˆåŠŸåï¼Œæ‚¨å°†çœ‹åˆ°ONOSçš„CLIç•Œé¢ï¼Œç±»ä¼¼äºä»¥ä¸‹å†…å®¹ï¼š</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yamlCopy</span> <span class="string">codeWelcome</span> <span class="string">to</span> <span class="string">ONOS</span></span><br><span class="line">     <span class="string">________</span>  <span class="string">________</span>  <span class="string">________</span>  <span class="string">________</span> </span><br><span class="line">    <span class="string">|\</span>   <span class="string">__</span>  <span class="string">\|\</span>   <span class="string">__</span>  <span class="string">\|\</span>   <span class="string">__</span>  <span class="string">\|\</span>   <span class="string">___</span> <span class="string">\</span> </span><br><span class="line">    <span class="string">\</span> <span class="string">\</span>  <span class="string">\|\</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\|\</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\|\</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\_|\</span> <span class="string">\</span> </span><br><span class="line">     <span class="string">\</span> <span class="string">\</span>   <span class="string">____\</span> <span class="string">\</span>  <span class="string">\\\</span>  <span class="string">\</span> <span class="string">\</span>   <span class="string">__</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\</span> <span class="string">\\</span> <span class="string">\</span> </span><br><span class="line">      <span class="string">\</span> <span class="string">\</span>  <span class="string">\___|\</span> <span class="string">\</span>  <span class="string">\\\</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\</span> <span class="string">\</span>  <span class="string">\_\\</span> <span class="string">\</span> </span><br><span class="line">       <span class="string">\</span> <span class="string">\__\</span>    <span class="string">\</span> <span class="string">\_______\</span> <span class="string">\__\</span> <span class="string">\__\</span> <span class="string">\_______\</span></span><br><span class="line">        <span class="string">\|__|</span>     <span class="string">\|_______|\|__|\|__|\|_______|</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Documentation:</span> <span class="string">wiki.onosproject.org</span>         </span><br><span class="line"><span class="attr">Tutorials:</span>     <span class="string">tutorials.onosproject.org</span>     </span><br><span class="line"><span class="attr">Mailing lists:</span> <span class="string">lists.onosproject.org</span>         </span><br><span class="line"></span><br><span class="line"><span class="string">Come</span> <span class="string">help</span> <span class="string">out!</span> <span class="attr">Find out how at:</span> <span class="string">contribute.onosproject.org</span></span><br><span class="line"></span><br><span class="line"><span class="string">onos&gt;</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨ï¼Œæ‚¨å¯ä»¥åœ¨CLIä¸­æ‰§è¡Œå„ç§ONOSå‘½ä»¤ä»¥ç®¡ç†å’Œç›‘æ§ONOSæ§åˆ¶å™¨å’Œç½‘ç»œã€‚</p><h3 id="æ¸…æ¥šæ‰€æœ‰é…ç½®"><a href="#æ¸…æ¥šæ‰€æœ‰é…ç½®" class="headerlink" title="æ¸…æ¥šæ‰€æœ‰é…ç½®"></a>æ¸…æ¥šæ‰€æœ‰é…ç½®</h3><ol><li>æ‰“å¼€ç»ˆç«¯å¹¶è¿æ¥åˆ°ONOSçš„CLIã€‚</li><li>åœ¨CLIä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ä»¥æ¸…é™¤ç¼“å­˜ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">onos&gt; clear storage</span><br></pre></td></tr></table></figure><p>æŒ‰å›è½¦é”®æ‰§è¡Œå‘½ä»¤ã€‚</p><p>è¿™å°†æ¸…é™¤ONOSçš„æ‰€æœ‰ç¼“å­˜ï¼ŒåŒ…æ‹¬ç½‘ç»œæ‹“æ‰‘ã€è®¾å¤‡ã€ä¸»æœºã€æµè¡¨ç­‰ã€‚è¯·æ³¨æ„ï¼Œåœ¨æ‰§è¡Œæ­¤å‘½ä»¤ä¹‹å‰ï¼Œæ‚¨éœ€è¦ç¡®ä¿ONOSæ§åˆ¶å™¨å·²ç»åœæ­¢å¯¹ç½‘ç»œçš„æ§åˆ¶ï¼Œä»¥é¿å…æ•°æ®ä¸¢å¤±æˆ–ç½‘ç»œä¸­æ–­ã€‚</p><h2 id="OVS-è¿æ¥æ§åˆ¶å™¨"><a href="#OVS-è¿æ¥æ§åˆ¶å™¨" class="headerlink" title="OVS è¿æ¥æ§åˆ¶å™¨"></a>OVS è¿æ¥æ§åˆ¶å™¨</h2><ol><li>è¦æŒ‡å®šOPENFLOW åè®®ä¸º <code>OPENFLOW13,OPENFLOW10</code>ï¼Œ<strong>ä»…æŒ‡å®šä¸º<code>OPENFLOW13</code>æ—¶ï¼Œè¿æ¥æ§åˆ¶å™¨åå°†æ— æ³•ä½¿ç”¨<code>ofctl</code>æŸ¥çœ‹æµè¡¨</strong>ã€‚</li><li>å°†<code>ovs bridge</code> è¿æ¥åˆ°æ§åˆ¶å™¨åçš„ <code>deviceId</code> ä¸º<code>bridge</code>å¯¹åº”çš„<code>datapath-id</code>ï¼Œå¯ä»¥å…ˆæŒ‡å®šè¯¥å€¼ï¼Œå†è¿æ¥æ§åˆ¶å™¨ã€‚ä¸‹å‘æµè¡¨æ—¶ä¼šç”¨åˆ°ã€‚</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 other_config:datapath-id=0x0000000000000012</span><br><span class="line">ifconfig s1 192.168.1.12 netmask 255.255.255.0 up</span><br><span class="line"></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 protocols=OpenFlow13,OpenFlow10</span><br><span class="line">ovs-vsctl set-controller s1 tcp:172.17.0.2:6653</span><br></pre></td></tr></table></figure><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ›å»ºå®¹å™¨</span></span><br><span class="line">sudo docker create --<span class="built_in">rm</span> -it --name=s1 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk</span><br><span class="line">sudo docker create --<span class="built_in">rm</span> -it --name=s2 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk</span><br><span class="line">sudo docker start s1</span><br><span class="line">sudo docker start s2</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  veth-peerï¼Œè¿æ¥ä¸¤å®¹å™¨</span></span><br><span class="line">sudo ip <span class="built_in">link</span> add p1_2 <span class="built_in">type</span> veth peer name p2_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev p1_2 name p1_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev p2_1 name p2_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br><span class="line">docker <span class="built_in">exec</span> -it s1 tc qdisc add dev p1_2 root netem delay 1</span><br><span class="line">docker <span class="built_in">exec</span> -it s2 tc qdisc add dev p2_1 root netem delay 1</span><br><span class="line"></span><br><span class="line"><span class="comment">############################### s1 ä¸­å¯åŠ¨OVS ##################################</span></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1001</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x4</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 other_config:datapath-id=0x0000000000000012</span><br><span class="line">ovs-vsctl add-port s1 p1_2 -- <span class="built_in">set</span> Interface p1_2 ofport_request=12</span><br><span class="line">ifconfig s1 192.168.1.12 netmask 255.255.255.0 up</span><br><span class="line"></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 protocols=OpenFlow13,OpenFlow10</span><br><span class="line">ovs-vsctl set-controller s1 tcp:172.17.0.2:6653</span><br><span class="line"></span><br><span class="line"><span class="comment">############################### s2 ä¸­å¯åŠ¨OVS ##################################</span></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x40</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line">ovs-vsctl add-br s2 -- <span class="built_in">set</span> bridge s2 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 other_config:datapath-id=0x0000000000000021</span><br><span class="line">ovs-vsctl add-port s2 p2_1 -- <span class="built_in">set</span> Interface p2_1 ofport_request=21</span><br><span class="line">ifconfig s2 192.168.1.21 netmask 255.255.255.0 up</span><br><span class="line"></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s2 protocols=OpenFlow13,OpenFlow10</span><br><span class="line">ovs-vsctl set-controller s2 tcp:172.17.0.2:6653</span><br></pre></td></tr></table></figure><h2 id="ä¸‹å‘æµè¡¨"><a href="#ä¸‹å‘æµè¡¨" class="headerlink" title="ä¸‹å‘æµè¡¨"></a>ä¸‹å‘æµè¡¨</h2><p>ä¸‹å‘çš„<code>ARP</code>æµè¡¨åªèƒ½åŒ¹é…<code>MAC</code>åœ°å€ï¼Œä½†ä¸€èˆ¬ä¸éœ€è¦æ‰‹åŠ¨ä¸‹å‘ã€‚ç½‘ç»œæ‹“æ‰‘æ¯”è¾ƒå°æ—¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡<code>arp -s &#123;ip&#125; &#123;mac&#125;</code>æ‰‹åŠ¨é…ç½®ã€‚</p><p><strong>é™åˆ¶</strong>ï¼šåŒ¹é…çš„ä»¥å¤ªç±»å‹ä¸ä¸ºIPæ—¶ï¼Œæ— æ³•åŒ¹é…ç›®çš„IPæˆ–æºIPï¼å³ARPå’ŒMPLSç±»å‹çš„ï¼Œåªèƒ½å’ŒMACåœ°å€ä¸€èµ·ä½œä¸ºåŒ¹é…åŸŸã€‚å®é™…ä¸Šè¿™æ‰æ˜¯æ­£ç¡®çš„ï¼Œæ¯”å¦‚MPLSç±»å‹çš„æ•°æ®åŒ…ï¼ŒOVSè§£ææ—¶ï¼Œå¹¶ä¸ä¼šè§£æä¸‰å±‚çš„åè®®ã€‚MPLSæ˜¯ä¸€ç§éš§é“åè®®ï¼Œå¹¶ä¸å…³å¿ƒä¹Ÿä¸ä¼šè®°å½•ä¸‹ä¸€å±‚çš„åè®®ç±»å‹ï¼Œå› æ­¤æ— æ³•è§£æã€‚<code>ovs-ofctl</code>å¹¶ä¸ä¼šæç¤ºè¿™ç§æ—¢åŒ¹é…MPLSæ ‡ç­¾åˆåŒ¹é…IPè¿™ç§â€œé€»è¾‘â€é”™è¯¯ã€‚</p><h2 id="æºç ç¼–è¯‘"><a href="#æºç ç¼–è¯‘" class="headerlink" title="æºç ç¼–è¯‘"></a>æºç ç¼–è¯‘</h2><p><a href="https://gerrit.onosproject.org/plugins/gitiles/onos">https://gerrit.onosproject.org/plugins/gitiles/onos</a></p><p><a href="https://bazel.build/install/ubuntu">https://bazel.build/install/ubuntu</a></p><h3 id="ç¼–è¯‘-ONOS-é•œåƒ"><a href="#ç¼–è¯‘-ONOS-é•œåƒ" class="headerlink" title="ç¼–è¯‘ ONOS é•œåƒ"></a>ç¼–è¯‘ ONOS é•œåƒ</h3><p><a href="https://github.com/Yo-gurts/onos/blob/master/Dockerfile">onos</a>ä»“åº“ä¸­å·²æœ‰å†™å¥½äº†çš„<code>Dockerfile</code>ï¼Œå°†æ•´ä¸ªé¡¹ç›®<code>clone</code>åˆ°æœ¬åœ°åï¼Œå³å¯ç›´æ¥ç¼–è¯‘é•œåƒã€‚è¯¥<code>Dockerfile</code>ä¸æ˜¯ä»ç½‘ä¸Šä¸‹è½½æºç ï¼Œè€Œæ˜¯ä»å½“å‰ç›®å½•<code>COPY</code>ï¼Œæ‰€ä»¥ä¿®æ”¹æºç åç›´æ¥ç¼–è¯‘å°±è¡Œã€‚</p><p>ä½†æ˜¯ <code>ONOS</code> ç¼–è¯‘è¿‡ç¨‹éœ€è¦ä»<code>github</code>æˆ–ä¸€äº›å¤–ç½‘åœ°å€ä¸‹è½½ç›¸å…³ç¼–è¯‘å·¥å…·ï¼Œå¯¼è‡´ç¼–è¯‘ç¼“æ…¢æˆ–è€…ç›´æ¥å¤±è´¥ã€‚éœ€è¦é…ç½®ä»£ç†ä½¿ç”¨ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build --network=host --build-arg http_proxy=http://127.0.0.1:8889 --build-arg https_proxy=http://127.0.0.1:8889  -t onos .</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„æ–¹å¼åœ¨æŸäº›æƒ…å†µä¸‹å·²ç»å¤Ÿç”¨äº†ï¼Œä½†å¯èƒ½å¡åœ¨<code>onos-gui-npm-install</code>ï¼Œéœ€è¦è¿›ä¸€æ­¥å¤„ç†ã€‚</p><ul><li>ä¸€ç§æ–¹å¼æ˜¯ä¿®æ”¹ <code>Dockerfile</code>ï¼Œå¢åŠ  <code>--action_env</code> æŒ‡å®šä»£ç†ã€‚</li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cat</span> WORKSPACE-docker &gt;&gt; WORKSPACE &amp;&amp; bazelisk build onos \</span></span><br><span class="line"><span class="language-bash">+    --action_env=https_proxy=http://127.0.0.1:8889 \</span></span><br><span class="line"><span class="language-bash">     --<span class="built_in">jobs</span> <span class="variable">$&#123;JOBS&#125;</span> \</span></span><br><span class="line"><span class="language-bash">     --verbose_failures \</span></span><br><span class="line"><span class="language-bash">     --java_runtime_version=dockerjdk_11</span></span><br></pre></td></tr></table></figure><ul><li>å¦ä¸€ç§æ–¹å¼æ˜¯ä¿®æ”¹<code>web/gui/BUILD</code>ã€‚</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> onos/web/gui</span><br><span class="line">sudo vi BUILD</span><br><span class="line"><span class="comment">#ä¿®æ”¹ onos-gui-npm-install</span></span><br><span class="line">åœ¨$<span class="variable">$NPM</span> $<span class="variable">$NPM_ARGS</span> installåé¢åŠ ä¸Š</span><br><span class="line">--registry https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line"><span class="comment">#ä¿®æ”¹ onos-gui-npm-build</span></span><br><span class="line">åœ¨$<span class="variable">$ROOT</span>/$<span class="variable">$NPM</span> $<span class="variable">$NPM_ARGS</span> run build --no-cacheååŠ ä¸Š</span><br><span class="line">--registry https://registry.npm.taobao.org</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> onos/web/gui2-fw-lib</span><br><span class="line">sudo vi BUILD</span><br><span class="line"><span class="comment">#ä¿®æ”¹ onos-gui2-fw-npm-install</span></span><br><span class="line">åœ¨npm $<span class="variable">$NPM_ARGS</span> installåé¢åŠ ä¸Š</span><br><span class="line">--registry https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥å°è¯•ä¸¤ç§æ–¹æ³•éƒ½ç”¨ã€‚æ­¤å¤–ï¼Œä¹Ÿå¯ä»¥å…ˆå°†<code>bazelisk build onos</code>ä¹‹å‰çš„ç¼–è¯‘ä¸ºä¸€ä¸ªé•œåƒï¼ˆå…å»å®‰è£…ç¼–è¯‘å·¥å…·çš„æ­¥éª¤ï¼‰ï¼Œå¯åŠ¨å®¹å™¨ï¼Œå†æ…¢æ…¢ç¼–è¯‘ï¼Œé€šè¿‡<code>docker commit</code>å°†å®Œæˆç¼–è¯‘çš„å®¹å™¨ä¿å­˜ä¸ºé•œåƒï¼Œå†å‚è€ƒ<code>Dockerfile</code>è¿›è¡ŒäºŒé˜¶æ®µçš„ç¼–è¯‘è¿‡ç¨‹ï¼ˆæ­¤æ³•æœ€å¯é ï¼‰ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://wiki.onosproject.org/display/ONOS/Downloads">onos å®˜ç½‘é¢„ç¼–è¯‘çš„ä¸‹è½½é¡µé¢</a></li><li><a href="https://github.com/opennetworkinglab/onos">onos github</a></li><li><a href="https://chentingz.github.io/2019/10/28/%E3%80%8CONOS%20x%20Mininet%E3%80%8D%E4%BB%8E0%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BA%E7%8E%AF%E5%A2%83/#0x05-%E6%B5%8B%E8%AF%95%E7%8E%AF%E5%A2%83">ã€ŒONOS x Mininetã€ä»0å¼€å§‹æ­å»ºç¯å¢ƒ</a></li><li><a href="https://feisky.gitbooks.io/sdn/content/sdn/onos.html">ONOSä»‹ç»</a></li><li><a href="http://developer.huawei.com/ict/cn/site-sdn-onos/article/onos-paradigm">ONOSæ¶æ„åˆ†æ</a></li><li><a href="http://www.sdnlab.com/6371.html">ONOSç™½çš®ä¹¦ä¸Šç¯‡ä¹‹ONOSç®€ä»‹</a></li><li><a href="http://www.sdnlab.com/6800.html">ONOSç™½çš®ä¹¦ä¸­ç¯‡ä¹‹ONOSæ¶æ„</a></li><li><a href="https://zhuanlan.zhihu.com/p/387616511?utm_id=0">ONOSç¼–è¯‘è¿‡ç¨‹çš„é—®é¢˜</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> OpenVSwitch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenVSwitch </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVSwitch-DPDK-æ€§èƒ½æµ‹è¯•</title>
      <link href="/2022/05/23/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/"/>
      <url>/2022/05/23/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<blockquote><p>OVSåŸºäºDPDKçš„æ•°æ®é€šè·¯ç»•è¿‡äº†å†…æ ¸åè®®æ ˆï¼Œå¹¶ä¸”åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå¸¦æ¥äº†ä¸€å®šçš„æ€§èƒ½æå‡ï¼Œä½†ä¹Ÿå¼•å…¥äº†å¾ˆå¤šéœ€è¦é…ç½®çš„å‚æ•°ï¼Œè€Œä¸”è¿™äº›å‚æ•°å’Œæ€§èƒ½å¯†åˆ‡ç›¸å…³ã€‚</p></blockquote><h2 id="å‚æ•°è¯´æ˜"><a href="#å‚æ•°è¯´æ˜" class="headerlink" title="å‚æ•°è¯´æ˜"></a>å‚æ•°è¯´æ˜</h2><blockquote><p><a href="https://man7.org/linux/man-pages/man5/ovs-vswitchd.conf.db.5.html">ovsdb å®˜æ–¹æ–‡æ¡£</a>ï¼Œä¸‹é¢çš„å‚æ•°è¡¨æ ¼åªæ˜¯ç®€å•ç¿»è¯‘äº†ä¸€ä¸‹ä½œç”¨ï¼Œä»…ä¾›å‚è€ƒï¼Œå…·ä½“ä¿¡æ¯è¿˜å¾—çœ‹å®˜æ–¹æ–‡æ¡£</p></blockquote><p><code>ovsdb</code>ä¸­å­˜å‚¨ç€<code>OVS</code>æ‰€æœ‰é…ç½®ä¿¡æ¯ï¼Œå¹¶æŒ‰ç»“æ„åˆ’åˆ†ä¸ºä¸€å¼ å¼ è¡¨<code>TABLE</code>ï¼Œè¿™é‡Œåªå…³æ³¨å…¶ä¸­ä¸<code>dpdk</code>æœ‰å…³çš„é…ç½®å‚æ•°ã€‚</p><h3 id="Open-vSwitch-Table"><a href="#Open-vSwitch-Table" class="headerlink" title="Open_vSwitch Table"></a>Open_vSwitch Table</h3><style>table th:first-of-type {    width: 40%;}table th:nth-of-type(2) {    width: 60%;}</style><table><thead><tr><th>å‚æ•°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>other_config:dpdk-init=true</code></td><td>æ˜¯å¦å¯ç”¨<code>dpdk</code>æ•°æ®é€šè·¯</td></tr><tr><td><code>other_config:dpdk-lcore-mask=0x1</code></td><td>æŒ‡å®šåœ¨å“ªäº›<code>core</code>ä¸Šåˆ›å»º<code>lcore</code>çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ç”¨äº<code>dpdk</code>åº“å†…éƒ¨æ¶ˆæ¯å¤„ç†ï¼Œå¦‚æ—¥å¿—ç­‰ï¼›è‹¥æ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸º<code>cpu affinity list</code>ä¸­çš„ç¬¬ä¸€ä¸ªã€‚<strong>ä¸ºè¾¾åˆ°æœ€ä½³æ€§èƒ½ï¼Œæœ€å¥½å°†å…¶è®¾ç½®åœ¨å•ä¸ª<code>core</code>ä¸Š</strong></td></tr><tr><td><code>other_config:pmd-cpu-mask=0x30</code></td><td>è®¾ç½®åœ¨å“ªäº›<code>core</code>ä¸Šåˆ›å»º<code>pmd</code>çº¿ç¨‹ï¼›è‹¥æ²¡æœ‰æŒ‡å®šï¼Œåˆ™é»˜è®¤åœ¨æ¯ä¸ª<code>NUMA</code>èŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ª<code>pmd</code>çº¿ç¨‹ï¼Œå¹¶ç»‘å®šåˆ°å¯¹åº”<code>NUMA</code>çš„<code>core</code>ä¸Š</td></tr><tr><td><code>other_config:smc-enable=true</code></td><td>æ˜¯å¦å¯ç”¨<code>SMC</code>ç¼“å­˜ï¼Œç›¸å¯¹äº<code>EMC</code>ï¼Œå†…å­˜æ›´é«˜æ•ˆï¼›å½“æµè¡¨çš„æ•°é‡è¶…è¿‡8192æ—¶ï¼Œ<code>SMC</code>å°¤å…¶æœ‰ç”¨ã€‚<strong>é»˜è®¤ä¸º<code>false</code></strong></td></tr><tr><td><code>other_config:per-port-memory=true</code></td><td>æ˜¯å¦ä½¿ç”¨æ¯ç«¯å£å†…å­˜æ¨¡å‹ï¼›é»˜è®¤æœ‰ç›¸åŒMTUå’ŒCPU socketçš„è®¾å¤‡å…±äº«å†…å­˜æ± </td></tr><tr><td><code>other_config:dpdk-alloc-mem</code></td><td>æŒ‡å®šé¢„å…ˆä»<code>hugepage</code>ä¸Šåˆ†é…çš„å†…å­˜å¤§å°ï¼Œå•ä½ä¸º<code>MB</code>ï¼Œä¸<code>socket(cpu)</code>æ— å…³ï¼›æ¨èç”¨<code>dpdk-socket-mem</code>æŒ‡å®š</td></tr><tr><td><code>other_config:dpdk-socket-mem=&quot;1024,1024&quot;</code></td><td>æŒ‡å®šé¢„å…ˆä»<code>hugepage</code>ä¸Šä¸ºæ¯ä¸ª<code>socket(cpu)</code>åˆ†é…çš„å†…å­˜å¤§å°ï¼›å€¼ç”¨é€—å·åˆ†å‰²ï¼Œå¦‚å¯¹4ä¸ªCPU socketçš„ç³»ç»Ÿï¼Œâ€1024,0,1024â€ï¼Œè¡¨ç¤ºä¸ºç¬¬0å’Œç¬¬3ä¸ªCPUåˆ†é…1024Mbã€‚<code>dpdk-alloc-mem</code>å’Œ<code>dpdk-socket-mem</code>éƒ½æ²¡æœ‰æŒ‡å®šçš„è¯ï¼Œä¼šä¸ºæ¯ä¸ªNUMAç”¨DPDKåº“ä¸­è®¾å®šçš„é»˜è®¤å€¼ã€‚è‹¥åŒæ—¶æŒ‡å®šäº†ï¼Œåˆ™é‡‡ç”¨<code>dpdk-socket-mem</code>ã€‚ä¿®æ”¹åï¼Œéœ€è¦é‡å¯å®ˆæŠ¤è¿›ç¨‹æ‰ç”Ÿæ•ˆ</td></tr><tr><td><code>other_config:dpdk-socket-limit</code></td><td>é™åˆ¶æ¯ä¸€ä¸ª<code>socket(cpu)</code>æœ€å¤§å¯ç”¨çš„å†…å­˜å¤§å°ï¼ˆä¸Šé¢çš„<code>dpdk-socket-mem</code>å¯åŠ¨æ€æ‰©å®¹ï¼‰ã€‚å€¼ç”¨é€—å·åˆ†å‰²ï¼Œå¦‚å¯¹4ä¸ªCPU socketçš„ç³»ç»Ÿï¼Œâ€2048,0,0â€ï¼Œå€¼ä¸º0è¡¨ç¤ºä¸è®¾é™åˆ¶ã€‚æœªæŒ‡å®šæ—¶ï¼Œ<strong>é»˜è®¤ä¸ºä¸è®¾é™åˆ¶</strong></td></tr><tr><td><code>other_config:dpdk-hugepage-dir</code></td><td>æŒ‡å®š<code>hugetlbfs</code>æŒ‚è½½ç‚¹çš„è·¯å¾„ï¼Œé»˜è®¤ä¸º<code>/dev/hugepages</code></td></tr><tr><td><code>other_config:dpdk-extra</code></td><td>ä¸º <code>DPDK</code> æŒ‡å®šå…¶ä»– <code>EAL</code> å‘½ä»¤è¡Œå‚æ•°</td></tr><tr><td><code>other_config:vhost-sock-dir</code></td><td>æŒ‡å®šä¸º<code>vhost-user</code>ç”Ÿæˆçš„<code>socket</code>æ–‡ä»¶è·¯å¾„ï¼Œè¯¥å€¼ä¸ºåŸºäº<code>external_ids:rundir</code>çš„ç›¸å¯¹è·¯å¾„ã€‚æœªæŒ‡å®šæ—¶ï¼Œåˆ™ç”Ÿæˆåœ¨<code>external_ids:rundir</code>ç›®å½•ä¸‹</td></tr><tr><td><code>other_config:tx-flush-interval=0</code></td><td>æŒ‡å®šä¸€ä¸ªæ•°æ®åŒ…åœ¨<code>output batch</code>ä¸­å¯ç­‰å¾…çš„æœ€å¤§æ—¶é—´ï¼ˆä¸ºäº†å‡‘è¶³32ä¸ªæ‰¹é‡å‘é€ï¼‰ï¼Œ<strong>å•ä½å¾®ç§’<code>us</code><strong>ï¼›è¯¥å€¼å¯è°ƒèŠ‚ååç‡å’Œç½‘ç»œå»¶è¿Ÿçš„å¹³è¡¡ï¼Œå€¼è¶Šå°ï¼šç½‘ç»œå»¶è¿Ÿè¶Šä½ï¼Œä½†ååç‡ä¹Ÿç›¸å¯¹ä½ï¼›</strong>é»˜è®¤å€¼ä¸º0</strong></td></tr><tr><td><code>other_config:pmd-perf-metrics=true</code></td><td>æ˜¯å¦ä½¿èƒ½è®°å½•<code>PMD</code>çš„è¯¦ç»†æ€§èƒ½æ•°æ®ï¼Œ<strong>é»˜è®¤ä¸ºfalse</strong></td></tr><tr><td><code>other_config:pmd-rxq-assign=cycles</code></td><td>æŒ‡å®šæ¥å—é˜Ÿåˆ—å¦‚ä½•åˆ†é…åˆ°<code>core</code>ï¼›æœ‰ä¸‰ç§ç®—æ³•ï¼š<code>cycles/roundrobin/group</code>ã€‚<strong>é»˜è®¤ä¸º<code>cycles</code></strong></td></tr><tr><td><code>other_config:pmd-rxq-isolate=true</code></td><td>æŒ‡å®šä¸€ä¸ª<code>core</code>åœ¨åˆ†é…ï¼ˆé€šè¿‡<code>pmd-rxq-affinity</code>ï¼‰ä¸€ä¸ªæ¥å—é˜Ÿåˆ—åï¼Œæ˜¯å¦è¦ <code>isolate</code>ã€‚è‹¥è¯¥å€¼ä¸º<code>false</code>ï¼Œè¡¨ç¤ºå…è®¸OVSå†å°†å…¶ä»–<code>RXQ</code>åˆ†é…ç»™è¯¥<code>core</code>ã€‚**é»˜è®¤ä¸º <code>true</code>**ã€‚</td></tr><tr><td><code>other_config:emc-insert-inv-prob</code></td><td>é…ç½®æµè¡¨æ’å…¥åˆ°<code>EMC</code>çš„æ¦‚ç‡ï¼ˆ<code>1 / emc-insert-inv-prob</code>ï¼‰ï¼Œ1è¡¨ç¤º100%æ’å…¥</td></tr><tr><td><code>other_config:vhost-postcopy-support=true</code></td><td>æ²¡çœ‹æ‡‚ï¼Œä½†å®æµ‹å‘ç°å¯¹<code>vhost-user</code>ç«¯å£<strong>æ€§èƒ½æœ‰ä¸€å®šæå‡</strong>ï¼</td></tr></tbody></table><p>å¯¹è¿™äº›å‚æ•°çš„ä¿®æ”¹ä¸»è¦é€šè¿‡ä»¥ä¸‹æ–¹å¼ï¼ˆéœ€è¦æ³¨æ„æŸäº›å‚æ•°è®¾ç½®åéœ€è¦é‡å¯<code>OVS</code>æ‰ä¼šç”Ÿæ•ˆï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl <span class="built_in">set</span> open_vswitch . other_config:vhost-postcopy-support=<span class="literal">true</span></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> open_vswitch . other_config:per-port-memory=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="æµ‹è¯•è¯´æ˜"><a href="#æµ‹è¯•è¯´æ˜" class="headerlink" title="æµ‹è¯•è¯´æ˜"></a>æµ‹è¯•è¯´æ˜</h2><blockquote><p><strong>æ³¨ï¼šæ­¤å¤„æµ‹è¯•çš„éƒ½æ˜¯åŸç‰ˆ<code>OVS</code>ï¼Œæ²¡æœ‰ç»è¿‡ä¿®æ”¹</strong>ï¼æœªä½œç‰¹æ®Šè¯´æ˜ï¼Œåˆ™è¡¨ç¤ºåŸºäºä»¥ä¸‹å¹³å°å¾—åˆ°çš„æµ‹è¯•ç»“æœ</p><ul><li>ovs-2.16.0</li><li>dpdk-20.11.6</li><li>å¤„ç†å™¨ï¼ši7-12700k</li><li>ç³»ç»Ÿï¼šubuntu:22.04</li><li>å†…æ ¸ï¼š5.15.0-52-generic</li></ul></blockquote><p>ä¸»è¦å¯¹æ¯”<code>OVS</code>å†…æ ¸æ•°æ®é€šè·¯ä¸<code>DPDK</code>æ•°æ®é€šè·¯çš„ååç‡æƒ…å†µï¼Œä»¥åŠä¸åŒé…ç½®å‚æ•°ä¸‹å¯¹æ€§èƒ½çš„å½±å“ã€‚</p><p>é™¤äº†<code>OVS</code>çš„é…ç½®å‚æ•°ï¼Œç½‘å¡æ”¯æŒçš„åŠŸèƒ½<code>ethtool --show-features &#123;eth0&#125;</code>ã€æ”¶å‘åŒ…å·¥å…·åŠå…¶é…ç½®å‚æ•°ç­‰éƒ½å¯èƒ½å½±å“æœ€ç»ˆçš„æµ‹è¯•ç»“æœï¼</p><table><thead><tr><th align="center"><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/PKTGEN-OVS-DPDK-TESTPMD.png" alt="pktgen-testpmd"><br />topo1</th><th align="center"><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/QEMU-OVS-QEMU.png" alt="qemu"><br />topo2</th></tr></thead><tbody><tr><td align="center"><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/ovs-dpdk-virtualport.png" alt="ovs-dpdk-virtualport"><br />topo3</td><td align="center"><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/ovs-virtualport.png" alt="ovs-virtualport"><br />topo4</td></tr></tbody></table><p>æŒ‡æ ‡ï¼šæ¥æ”¶å¸¦å®½ï¼</p><ol><li><code>Topo1</code>ï¼šæµ‹è¯•ä¸åŒé…ç½®å‚æ•°ä¸‹çš„æ€§èƒ½å¯¹æ¯”ã€‚</li><li><code>Topo2</code>ï¼šä½¿ç”¨å…¶ä»–å‘åŒ…å·¥å…·<code>iperf</code>ï¼ˆå¯åœ¨<code>veth</code>ç±»ç«¯å£ä¸Šä½¿ç”¨ï¼‰åŒ<code>topo1</code>è¿›è¡Œå¯¹æ¯”æµ‹è¯•ã€‚</li><li><code>Topo3</code>ï¼šä½¿ç”¨<code>veth</code>ç­‰ç«¯å£æ—¶ï¼Œä¸ä¼šå¯åŠ¨<code>PMD</code>çº¿ç¨‹ï¼Œæµ‹è¯•æ­¤æ—¶çš„æ€§èƒ½ã€‚</li><li><code>Topo4</code>ï¼šä¸ä½¿ç”¨<code>DPDK</code>ï¼Œå’Œ<code>topo3</code>æµ‹è¯•æµç¨‹ä¸€è‡´ï¼Œä¸¤è€…å¯¹æ¯”ã€‚</li></ol><hr><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/physics-port.png" alt="physics-port"></p><p>åœ¨ä¸¤å°ä¸»æœºä¸Šå¯åŠ¨<code>OVS</code>ï¼Œåˆ†åˆ«æµ‹è¯•<code>OVS/OVS-DPDK</code>çš„è½¬å‘èƒ½åŠ›ã€‚</p><hr><h2 id="base"><a href="#base" class="headerlink" title="base"></a>base</h2><p>é¦–å…ˆæµ‹è¯•åœ¨ä¸ä½¿ç”¨<code>OVS</code>ï¼Œå•ç‹¬ä¸¤ä¸ªè™šæ‹Ÿç«¯å£ç›´æ¥è¿æ¥çš„æƒ…å†µä¸‹ï¼Œ<strong>é“¾è·¯</strong>çš„å¸¦å®½ã€‚</p><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/netns-topo.png" alt="netns"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">sudo ip netns add A</span><br><span class="line">sudo ip netns add B</span><br><span class="line"></span><br><span class="line">sudo ip <span class="built_in">link</span> add ethA <span class="built_in">type</span> veth peer name ethB</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev ethA name ethA netns A up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev ethB name ethB netns B up</span><br><span class="line">sudo ip netns <span class="built_in">exec</span> A ifconfig ethA 10.0.0.10/24 up</span><br><span class="line">sudo ip netns <span class="built_in">exec</span> B ifconfig ethB 10.0.0.11/24 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># terminal B: Bä½œä¸ºServer</span></span><br><span class="line">sudo ip netns <span class="built_in">exec</span> B iperf -s -i 1</span><br><span class="line"><span class="comment"># terminal A: Aä½œä¸ºClient</span></span><br><span class="line">sudo ip netns <span class="built_in">exec</span> B iperf -s -i 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä»–å¯èƒ½ç”¨åˆ°çš„å‘½ä»¤</span></span><br><span class="line">ip netns list</span><br><span class="line">ip netns delete A</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><table><thead><tr><th></th><th>æµ‹è¯•ç¯å¢ƒ</th><th>iperf-tcp</th></tr></thead><tbody><tr><td>c1</td><td><code>veth-veth</code>ç›´è¿</td><td>102 Gbps</td></tr><tr><td>c2</td><td>docker é»˜è®¤äº¤æ¢æœº<code>docker0</code></td><td>79.7 Gbps</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># terminal A</span></span><br><span class="line">$ sudo ip netns <span class="built_in">exec</span> A iperf -c 10.0.0.11</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Client connecting to 10.0.0.11, TCP port 5001</span><br><span class="line">TCP window size: 85.0 KByte (default)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">[  1] <span class="built_in">local</span> 10.0.0.10 port 44154 connected with 10.0.0.11 port 5001</span><br><span class="line">[ ID] Interval       Transfer     Bandwidth</span><br><span class="line">[  1] 0.0000-10.0099 sec   119 GBytes   102 Gbits/sec</span><br><span class="line"></span><br><span class="line"><span class="comment"># terminal B</span></span><br><span class="line">$ sudo ip netns <span class="built_in">exec</span> B iperf -s -i 1</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨ï¼š<code>iperf</code>ä¹Ÿæ”¯æŒæ‰“<code>udp</code>æµè¿›è¡Œæµ‹è¯•ï¼Œä½†å®é™…æµ‹å‡ºæ¥çš„å¸¦å®½è¿œä¸å¦‚<code>tcp</code>ï¼Œ<a href="https://stackoverflow.com/questions/47035263/iperf-tcp-much-faster-than-udp-why">iperf TCP much faster than UDP, why?</a>ï¼Œè™½ç„¶è¿™é‡Œè¯´è°ƒæ•´å‘åŒ…å¤§å°ï¼Œä½†å¹¶æ²¡æœ‰ç”¨ï¼Œ<code>iperf</code>é»˜è®¤çš„æŠ¥æ–‡å¤§å°å°±æ˜¯æœ€å¤§å€¼<code>1470</code>ï¼Œè°ƒå¤§ååè€Œéœ€è¦åˆ‡ç‰‡å¤„ç†ï¼Œå¯¼è‡´é€Ÿç‡æ›´ä½ã€‚</p><p>ä»æµ‹è¯•æƒ…å†µæ¥çœ‹ï¼Œåº”è¯¥æ˜¯<code>iperf</code>å‘é€ç«¯çš„å‘é€é€Ÿç‡ä¸è¶³ï¼Œå¯¼è‡´æµ‹å‡ºçš„å¸¦å®½è¿œå°äº<code>tcp</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server</span></span><br><span class="line">sudo ip netns <span class="built_in">exec</span> B iperf -s -i 1 -u</span><br><span class="line"></span><br><span class="line"><span class="comment"># client</span></span><br><span class="line">sudo ip netns <span class="built_in">exec</span> A iperf -u -c 10.0.0.11 -b 10g</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">Client connecting to 10.0.0.11, UDP port 5001</span><br><span class="line">Sending 1470 byte datagrams, IPG target: 1.18 us (kalman adjust)</span><br><span class="line">UDP buffer size:  208 KByte (default)</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">[  1] <span class="built_in">local</span> 10.0.0.10 port 50645 connected with 10.0.0.11 port 5001</span><br><span class="line">[ ID] Interval       Transfer     Bandwidth</span><br><span class="line">[  1] 0.0000-10.0047 sec  8.37 GBytes  7.19 Gbits/sec</span><br><span class="line">[  1] Sent 6113230 datagrams</span><br><span class="line">[  1] Server Report:</span><br><span class="line">[ ID] Interval       Transfer     Bandwidth        Jitter   Lost/Total Datagrams</span><br><span class="line">[  1] 0.0000-10.0046 sec  8.26 GBytes  7.09 Gbits/sec   0.001 ms 88036/6123229 (1.4%)</span><br></pre></td></tr></table></figure></blockquote><h2 id="vhost-user"><a href="#vhost-user" class="headerlink" title="vhost-user"></a>vhost-user</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-lcore-mask=0x1</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x6</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 vhost-user1 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user1 <span class="built_in">type</span>=dpdkvhostuser ofport_request=1</span><br><span class="line">ovs-vsctl add-port br0 vhost-user2 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user2 <span class="built_in">type</span>=dpdkvhostuser ofport_request=2</span><br><span class="line"></span><br><span class="line"><span class="comment"># vhost-user3</span></span><br><span class="line">ovs-vsctl add-port br0 vhost-user3 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user3 <span class="built_in">type</span>=dpdkvhostuser ofport_request=3</span><br></pre></td></tr></table></figure><table><thead><tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr></thead><tbody><tr><td><code>pmd=0x1</code></td><td>*</td><td>*</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>pktgen=0x30</code></td><td></td><td></td><td></td><td></td><td>*</td><td>*</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>testpmd=0x300</code></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>*</td><td>*</td><td></td><td></td></tr></tbody></table><p><code>pktgen</code>å’Œ<code>testpmd</code>å¥½åƒä¹Ÿé‡‡ç”¨äº†<code>PMD</code>è½®è¯¢é©±åŠ¨ç±»ä¼¼çš„æ–¹å¼è¿è¡Œï¼Œä¼šå æ»¡æŸäº›æ ¸ï¼Œåœ¨é…ç½®å‚æ•°æ—¶éœ€è¦å°†<code>core</code>é”™å¼€ï¼Œå¦åˆ™å½±å“æ€§èƒ½ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pktgen</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-pktgen \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">pktgen -c 0x30 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;5.0&quot;</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># testpmd</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-testpmd \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0x300 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user2,mac=00:00:00:00:00:02,path=/var/run/openvswitch/vhost-user2&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0x200 --forward-mode=rxonly</span><br></pre></td></tr></table></figure><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/image-20220703163105375.png" alt="image-20220703163105375"></p><p>å¯ä»¥çœ‹åˆ°CPUçš„å ç”¨æƒ…å†µä¸é…ç½®ä¸€è‡´ï¼<code>Pktgen</code>å ç”¨äº†ä¸¤ä¸ªæ ¸ã€‚</p><h3 id="æµ‹è¯•ç»“æœ-1"><a href="#æµ‹è¯•ç»“æœ-1" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><table><thead><tr><th></th><th></th><th>pktgen-64byte</th><th>pktgen-1500byte</th></tr></thead><tbody><tr><td>c1</td><td>é»˜è®¤æµè¡¨ Normal</td><td>3 016 608 216 bps</td><td>42 754 318 664 bps</td></tr><tr><td></td><td></td><td>6 284 600 pps</td><td>3 572 386 pps</td></tr><tr><td>c2</td><td>c1 + åŒ¹é…å…¥ç«¯å£æµè¡¨</td><td>7 849 813 576 bps</td><td>88 330 499 920 bps</td></tr><tr><td></td><td></td><td>16 353 825 pps</td><td>7 380 556 pps</td></tr><tr><td>c3</td><td>c2 + vhost-postcopy-support</td><td>8 086 507 608 bps</td><td>96 284 271 416 bps</td></tr><tr><td></td><td></td><td>16 846 890 pps</td><td>8 045 142 pps</td></tr><tr><td></td><td>ä¸‹é¢çš„2send,1recv, 2pmd</td><td></td><td>125975200120 bps</td></tr><tr><td></td><td></td><td></td><td>10 525 949 pps</td></tr></tbody></table><p><code>c2</code>ï¼šé…ç½®åŒ¹é…å…¥ç«¯å£çš„æµè¡¨ï¼›</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ovs-ofctl add-flow br0 in_port=vhost-user1,actions=output:vhost-user2</span><br><span class="line">ovs-ofctl add-flow br0 in_port=vhost-user3,actions=output:vhost-user4</span><br><span class="line">ovs-ofctl add-flow br0 in_port=vhost-user5,actions=output:vhost-user6</span><br></pre></td></tr></table></figure><p><code>c3</code>ï¼šé…ç½®<code>vhost-postcopy-support=true</code>ï¼›</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl <span class="built_in">set</span> open_vswitch . other_config:vhost-postcopy-support=<span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="2send-1recv"><a href="#2send-1recv" class="headerlink" title="2send-1recv"></a>2send-1recv</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-lcore-mask=0x1</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0xE</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 vhost-user1 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user1 <span class="built_in">type</span>=dpdkvhostuser ofport_request=1</span><br><span class="line">ovs-vsctl add-port br0 vhost-user2 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user2 <span class="built_in">type</span>=dpdkvhostuser ofport_request=2</span><br><span class="line">ovs-vsctl add-port br0 vhost-user3 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user3 <span class="built_in">type</span>=dpdkvhostuser ofport_request=3</span><br><span class="line">ovs-vsctl add-port br0 vhost-user4 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user4 <span class="built_in">type</span>=dpdkvhostuser ofport_request=4</span><br><span class="line">ovs-vsctl add-port br0 vhost-user5 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user5 <span class="built_in">type</span>=dpdkvhostuser ofport_request=5</span><br><span class="line">ovs-vsctl add-port br0 vhost-user6 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user6 <span class="built_in">type</span>=dpdkvhostuser ofport_request=6</span><br></pre></td></tr></table></figure><table><thead><tr><th></th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th><th>11</th><th>12</th></tr></thead><tbody><tr><td><code>pmd=0x6</code></td><td></td><td>*</td><td>*</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>pktgen1=0x30</code></td><td></td><td></td><td></td><td></td><td>*</td><td>*</td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td><code>pktgen2=0xc0</code></td><td></td><td></td><td></td><td></td><td></td><td></td><td>*</td><td>*</td><td></td><td></td><td></td><td></td></tr><tr><td><code>testpmd=0x300</code></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>*</td><td>*</td><td></td><td></td></tr><tr><td><code>testpmd=0xc00</code></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>*</td><td>*</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pktgen</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-pktgen3 \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen:20.11.3 /bin/bash</span><br><span class="line"></span><br><span class="line">pktgen -c 0x30 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;5.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pktgen</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-pktgen2 \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">pktgen -c 0xc0 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:03,path=/var/run/openvswitch/vhost-user3&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;7.0&quot;</span></span><br><span class="line"></span><br><span class="line">pktgen -c 0xc000 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:05,path=/var/run/openvswitch/vhost-user5&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;15.0&quot;</span></span><br><span class="line"></span><br><span class="line">pktgen -c 0xc00 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:04,path=/var/run/openvswitch/vhost-user4&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;11.0&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sequence &lt;<span class="built_in">seq</span><span class="comment">#&gt; &lt;portlist&gt; dst &lt;Mac&gt; src &lt;Mac&gt; dst &lt;IP&gt; src &lt;IP&gt; sport &lt;val&gt; dport &lt;val&gt; ipv4|ipv6 udp|tcp|icmp vlan &lt;val&gt; size &lt;val&gt; [teid &lt;val&gt;]</span></span><br><span class="line">sequence 0 0 dst 00:00:00:00:11:11 src 00:00:00:00:22:22 dst 192.168.1.1/24 src 192.168.1.3/24 sport 10001 dport 10003 ipv4 udp vlan 3000 size 1500</span><br><span class="line">sequence 2 0 dst 00:00:00:00:11:11 src 00:00:00:00:22:22 dst 192.168.1.1/24 src 192.168.1.4/24 sport 10001 dport 10004 ipv4 udp vlan 4000 size 1500</span><br><span class="line"></span><br><span class="line">sequence &lt;<span class="built_in">seq</span><span class="comment">#&gt; &lt;portlist&gt; &lt;dst-Mac&gt; &lt;src-Mac&gt; &lt;dst-IP&gt; &lt;src-IP&gt; &lt;sport&gt; &lt;dport&gt; ipv4|ipv6 udp|tcp|icmp &lt;vlanid&gt; &lt;pktsize&gt; [&lt;teid&gt;]</span></span><br><span class="line">sequence 1 0 dst-Mac 00:00:00:00:11:11 src-Mac 00:00:00:00:22:22 dst-IP 192.168.1.1 src-IP 192.168.1.3/24</span><br><span class="line"></span><br><span class="line"><span class="comment"># range</span></span><br><span class="line"><span class="built_in">set</span> 0 dst ip min 192.168.1.1</span><br><span class="line"><span class="built_in">set</span> 0 dst ip max 192.168.1.2</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.1.1,actions=output:vhost-user2</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.1.2,actions=output:vhost-user4</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-testpmd2 \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen:20.11.3 /bin/bash</span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0x300 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user2,mac=00:00:00:00:00:02,path=/var/run/openvswitch/vhost-user2&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0x200 --forward-mode=rxonly</span><br><span class="line"></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-testpmd2 \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=pktgen3 \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen:20.11.3 /bin/bash</span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0xc00 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user4,mac=00:00:00:00:00:04,path=/var/run/openvswitch/vhost-user4&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0x800 --forward-mode=rxonly</span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0x30000 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user6,mac=00:00:00:00:00:06,path=/var/run/openvswitch/vhost-user6&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0x20000 --forward-mode=rxonly</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ovs-ofctl add-flow br0 in_port=vhost-user1,actions=output:vhost-user2</span><br><span class="line">ovs-ofctl add-flow br0 in_port=vhost-user3,actions=output:vhost-user2</span><br></pre></td></tr></table></figure><hr><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1-------3</span><br><span class="line">  pmd1</span><br><span class="line">2-------4</span><br><span class="line"></span><br><span class="line">1---pmd1----3</span><br><span class="line">2---pmd2----4</span><br></pre></td></tr></table></figure><table><thead><tr><th>æœåŠ¡å™¨ 1500byteï¼Œæ”¶ç«¯æµ‹é€Ÿ</th><th>pps</th><th>bps</th></tr></thead><tbody><tr><td>1pmd, 1-&gt;2</td><td>4014497</td><td>48 045502408</td></tr><tr><td>1pmd, 1-&gt;2, 3-&gt;2</td><td>3821682</td><td>45 737967984</td></tr><tr><td>1pmd, 1-&gt;2, 3-&gt;4, (2,4çš„ç»“æœå·®ä¸å¤š)</td><td>1842978</td><td>22 056772136</td></tr><tr><td>2pmd, 1-&gt;2, 3-&gt;2</td><td>5644703</td><td>67 485371880</td></tr><tr><td>2pmd, 1-&gt;2, 3-&gt;4, (2,4çš„ç»“æœå·®ä¸å¤š)</td><td>3983405</td><td>47 673395952</td></tr><tr><td>2pmd, 1-&gt;2, 3-&gt;2, 4-&gt;2</td><td>5347450</td><td>63 864672136</td></tr><tr><td>3pmd, 1-&gt;2, 3-&gt;2, 4-&gt;2 (åº”è¯¥æ˜¯æ”¶ç«¯å¤„ç†èƒ½åŠ›é™åˆ¶)</td><td>5332282</td><td>63 816064880</td></tr><tr><td>3pmd, 1-&gt;2, 3-&gt;4, 5-&gt;6 (2,4,6çš„ç»“æœå·®ä¸å¤š)</td><td>3733353</td><td>44 680773688</td></tr></tbody></table><h2 id="QEMU"><a href="#QEMU" class="headerlink" title="QEMU"></a>QEMU</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-lcore-mask=0x1</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 vhost-user1 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user1 <span class="built_in">type</span>=dpdkvhostuser ofport_request=1</span><br><span class="line">ovs-vsctl add-port br0 vhost-user2 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user2 <span class="built_in">type</span>=dpdkvhostuser ofport_request=2</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨QEMUè™šæ‹Ÿæœº</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŸºäºvhost-user1, vhost-user2åˆ›å»ºè™šæ‹Ÿæœº</span></span><br><span class="line">qemu-system-x86_64 -enable-kvm -m 2048 -smp 4 \</span><br><span class="line">    -chardev socket,<span class="built_in">id</span>=char0,path=/usr/local/var/run/openvswitch/vhost-user1 \</span><br><span class="line">    -netdev <span class="built_in">type</span>=vhost-user,<span class="built_in">id</span>=mynet1,chardev=char0,vhostforce \</span><br><span class="line">    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:01 \</span><br><span class="line">    -object memory-backend-file,<span class="built_in">id</span>=mem,size=2048M,mem-path=/dev/hugepages,share=on \</span><br><span class="line">    -numa node,memdev=mem -mem-prealloc \</span><br><span class="line">    -net user,hostfwd=tcp::10021-:22 -net nic \</span><br><span class="line">    ./qemu-vm1.img</span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -enable-kvm -m 2048 -smp 4 \</span><br><span class="line">    -chardev socket,<span class="built_in">id</span>=char0,path=/usr/local/var/run/openvswitch/vhost-user2 \</span><br><span class="line">    -netdev <span class="built_in">type</span>=vhost-user,<span class="built_in">id</span>=mynet1,chardev=char0,vhostforce \</span><br><span class="line">    -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:02 \</span><br><span class="line">    -object memory-backend-file,<span class="built_in">id</span>=mem,size=2048M,mem-path=/dev/hugepages,share=on \</span><br><span class="line">    -numa node,memdev=mem -mem-prealloc \</span><br><span class="line">    -net user,hostfwd=tcp::10022-:22 -net nic \</span><br><span class="line">    ./qemu-vm2.img &amp;</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ-2"><a href="#æµ‹è¯•ç»“æœ-2" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><table><thead><tr><th></th><th></th><th>iperf-tcp</th></tr></thead><tbody><tr><td>c1</td><td>é»˜è®¤æµè¡¨ Normal</td><td>22.3 Gbps</td></tr><tr><td>c2</td><td>c1 + åŒ¹é…å…¥ç«¯å£æµè¡¨</td><td>22.4 Gbps</td></tr><tr><td>c3</td><td>c2 + vhost-postcopy-support</td><td>22.3 Gbps</td></tr></tbody></table><blockquote><p>è¿™ä¸‰ç§æƒ…å†µä¸‹ï¼Œé€Ÿç‡å‡ ä¹ä¸€è‡´ï¼è€Œä¸”ä½¿ç”¨<code>iperf-udp</code>æµ‹è¯•æ—¶ï¼ŒæŒ‡å®šå¸¦å®½å°äº<code>5Gbps</code>æ—¶ï¼Œæµ‹è¯•é€Ÿç‡æ¯”è¾ƒæ­£å¸¸ã€‚ä½†è‹¥æŒ‡å®šçš„å¸¦å®½å¤§äº<code>5g</code>ï¼Œä¼šå¯¼è‡´é€Ÿç‡ä¸¥é‡ä¸‹é™ï¼Œä¸º<code>1.5Gbps</code>å·¦å³ã€‚</p><p>ä¸è¿‡è¿™é‡Œä¹Ÿæ¶‰åŠåˆ°é…ç½®<code>qemu</code>è™šæ‹Ÿæœºçš„ç›¸å…³å‚æ•°ï¼Œæ²¡è¿›ä¸€æ­¥è°ƒè¯•ã€‚</p></blockquote><h2 id="ç‰©ç†ç½‘å¡"><a href="#ç‰©ç†ç½‘å¡" class="headerlink" title="ç‰©ç†ç½‘å¡"></a>ç‰©ç†ç½‘å¡</h2><blockquote><p>è¿™é‡Œä¸ºåœ¨ä¸¤å°ç‰©ç†æœåŠ¡å™¨ä¸Šåšæµ‹è¯•ï¼Œæ¯å°æœåŠ¡å™¨ç”¨ä¸¤å¼ ç½‘å¡ï¼Œæ¯å¼ ç½‘å¡ä¸¤ä¸ªç«¯å£ï¼Œä¸€å¼ ç½‘å¡ä¸ºå…‰å£ï¼Œå¦ä¸€å¼ åˆ™æ˜¯æ­£å¸¸çš„RJ45æ¥å£ã€‚é™¤ä¸€ä¸ªRJ45å£æ¥å…¥ç½‘ç»œå¤–ï¼Œå…¶ä½™ç«¯å£éƒ½ä¸¤ä¸¤ç›´è¿ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ lspci | grep Eth</span><br><span class="line">3d:00.0 Ethernet controller: Intel Corporation Ethernet Connection X722 <span class="keyword">for</span> 10GBASE-T (rev 09)</span><br><span class="line">3d:00.1 Ethernet controller: Intel Corporation Ethernet Connection X722 <span class="keyword">for</span> 10GBASE-T (rev 09)</span><br><span class="line">af:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">af:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">$ <span class="built_in">uname</span> -a</span><br><span class="line">Linux uestc 5.15.0-52-generic <span class="comment">#58~20.04.1-Ubuntu SMP</span></span><br><span class="line"></span><br><span class="line">$ lscpu <span class="comment"># ä¸¤å°æœåŠ¡å™¨CPU é¢‘ç‡ç¨æœ‰å·®åˆ«</span></span><br><span class="line">Model name:                      Intel(R) Xeon(R) Gold 6133 CPU @ 2.50GHz</span><br><span class="line">Stepping:                        4</span><br><span class="line">CPU MHz:                         1000.000</span><br><span class="line">CPU max MHz:                     3000.0000</span><br><span class="line">CPU min MHz:                     1000.0000</span><br><span class="line">BogoMIPS:                        5000.00</span><br><span class="line">-----------------------------------------------</span><br><span class="line">Model name:                      Intel(R) Xeon(R) Gold 6145 CPU @ 2.00GHz</span><br><span class="line">Stepping:                        4</span><br><span class="line">CPU MHz:                         1000.120</span><br><span class="line">CPU max MHz:                     3700.0000</span><br><span class="line">CPU min MHz:                     1000.0000</span><br><span class="line">BogoMIPS:                        4000.00</span><br></pre></td></tr></table></figure></blockquote><h3 id="ovs"><a href="#ovs" class="headerlink" title="ovs"></a>ovs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl start</span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=system</span><br><span class="line"></span><br><span class="line"><span class="comment"># Server A</span></span><br><span class="line">ifconfig br0 192.168.5.80</span><br><span class="line">ovs-vsctl add-port br0 eno0</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.5.40,actions=output:eno0</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.5.80,actions=output:LOCAL</span><br><span class="line"></span><br><span class="line"><span class="comment"># Server B</span></span><br><span class="line">ifconfig br0 192.168.5.40</span><br><span class="line">ovs-vsctl add-port br0 eno1</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.5.80,actions=output:eno1</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.5.40,actions=output:LOCAL</span><br></pre></td></tr></table></figure><h3 id="ovs-dpdk"><a href="#ovs-dpdk" class="headerlink" title="ovs-dpdk"></a>ovs-dpdk</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-lcore-mask=0x1</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x2</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line">ovs-vsctl add-br br1 -- <span class="built_in">set</span> bridge br1 datapath_type=netdev</span><br><span class="line"></span><br><span class="line"><span class="comment"># server A</span></span><br><span class="line">ifconfig br1 192.168.6.80</span><br><span class="line">modprobe vfio enable_unsafe_noiommu_mode=1</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/module/vfio/parameters/enable_unsafe_noiommu_mode</span><br><span class="line">ifconfig eno0 down</span><br><span class="line">ifconfig ens1f0 down</span><br><span class="line">ifconfig ens1f1 down</span><br><span class="line">dpdk-devbind.py --<span class="built_in">bind</span>=vfio-pci 0000:60:00.0</span><br><span class="line">dpdk-devbind.py --<span class="built_in">bind</span>=vfio-pci 0000:18:00.0</span><br><span class="line">dpdk-devbind.py --<span class="built_in">bind</span>=vfio-pci 0000:18:00.1</span><br><span class="line">ovs-vsctl add-port br1 rj45 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface rj45 <span class="built_in">type</span>=dpdk options:dpdk-devargs=0000:60:00.0</span><br><span class="line">ovs-ofctl add-flow br1 ip,nw_dst=192.168.6.40,actions=output:rj45</span><br><span class="line">ovs-ofctl add-flow br1 ip,nw_dst=192.168.6.80,actions=output:LOCAL</span><br><span class="line"></span><br><span class="line"><span class="comment"># server B</span></span><br><span class="line">ifconfig br1 192.168.4.80</span><br><span class="line">modprobe vfio enable_unsafe_noiommu_mode=1</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/module/vfio/parameters/enable_unsafe_noiommu_mode</span><br><span class="line">ifconfig eno1 down</span><br><span class="line">ifconfig ens802f0 down</span><br><span class="line">ifconfig ens802f1 down</span><br><span class="line">dpdk-devbind.py --<span class="built_in">bind</span>=vfio-pci 0000:3d:00.0</span><br><span class="line">dpdk-devbind.py --<span class="built_in">bind</span>=vfio-pci 0000:af:00.0</span><br><span class="line">dpdk-devbind.py --<span class="built_in">bind</span>=vfio-pci 0000:af:00.1</span><br><span class="line"></span><br><span class="line">ovs-vsctl add-port br1 rj45 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface rj45 <span class="built_in">type</span>=dpdk options:dpdk-devargs=0000:3d:00.0</span><br><span class="line">ovs-ofctl add-flow br1 ip,nw_dst=192.168.6.80,actions=output:rj45</span><br><span class="line">ovs-ofctl add-flow br1 ip,nw_dst=192.168.6.40,actions=output:LOCAL</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ-3"><a href="#æµ‹è¯•ç»“æœ-3" class="headerlink" title="æµ‹è¯•ç»“æœ"></a>æµ‹è¯•ç»“æœ</h3><table><thead><tr><th></th><th></th><th>iperf-tcp</th></tr></thead><tbody><tr><td>c1</td><td>æ— OVSï¼Œç½‘å£ç›´è¿ï¼ˆRJ45ä¸å…‰å£å·®ä¸å¤šï¼‰</td><td>9.38 Gbps</td></tr><tr><td>c2</td><td>OVSï¼ŒRJ45ä¸å…‰å£åŒæ ·å·®ä¸å¤š</td><td>9.41 Gbps</td></tr><tr><td>c3</td><td>OVS-DPDKï¼Œ(ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¿™ä¹ˆæ…¢)</td><td>3.89 Gbps</td></tr><tr><td>c4</td><td>OVS-DPDK-pktgen</td><td>9.8 Gbps</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server A: pktgen</span></span><br><span class="line">ovs-ofctl add-flow br1 in_port=vhost-user1,actions=output:g1</span><br><span class="line"></span><br><span class="line"><span class="comment"># server B: testpmd</span></span><br><span class="line">ovs-ofctl add-flow br1 in_port=g1,actions=output:vhost-user1</span><br></pre></td></tr></table></figure><h3 id="vhost-user-1"><a href="#vhost-user-1" class="headerlink" title="vhost-user"></a>vhost-user</h3><h3 id="OVS-OVS"><a href="#OVS-OVS" class="headerlink" title="OVS-OVS"></a>OVS-OVS</h3><p>è¡¥ï¼šè¯¥æ–¹æ¡ˆä½¿ç”¨<code>veth pair</code>è¿æ¥ä¸¤å®¹å™¨ï¼Œæœ¬æƒ³å€Ÿæ­¤æµ‹è¯•OVS-DPDKçš„è½¬å‘æ€§èƒ½ï¼Œä½†<a href="https://www.cnblogs.com/dream397/p/13964154.html#%E5%9F%BA%E4%BA%8E%E5%86%85%E6%A0%B8%E5%8D%8F%E8%AE%AE%E6%A0%88%E7%9A%84%E5%BA%94%E7%94%A8">ä½¿ç”¨<code>veth</code>ç«¯å£ä¼šè®©OVSå›è½åˆ°system datapath</a>ï¼Œè€Œä¸”æ­å»ºä¸‹é¢çš„æ‹“æ‰‘å¹¶å¯åŠ¨OVSåï¼Œä¼šå‘ç°æ²¡æœ‰æ ¸è¢«å æ»¡ï¼ˆPMDè¿è¡Œæ—¶ä¸ä¼šä¼‘çœ ï¼‰ã€‚å½“æ·»åŠ äº†<code>vhost-user</code>ç«¯å£åï¼Œæ‰ä¼šçœ‹åˆ°æœ‰ä¸ªæ ¸è·‘æ»¡äº†ã€‚</p><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/OVS%20%E6%B5%81%E7%A8%8B%E5%9B%BE-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95.drawio-16567289755781.png" alt="OVS æµç¨‹å›¾-æ€§èƒ½æµ‹è¯•.drawio"></p><p><strong>æ‹“æ‰‘æ­å»º</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dpdk-hugepages.py -p 1G --setup 4G</span><br><span class="line">modprobe openvswitch</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºå®¹å™¨</span></span><br><span class="line">sudo docker create -it --name=s1 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-qdisc</span><br><span class="line">sudo docker create -it --name=s2 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-qdisc</span><br><span class="line">sudo docker start s1</span><br><span class="line">sudo docker start s2</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  veth-peer</span></span><br><span class="line">sudo ip <span class="built_in">link</span> add p1_2 <span class="built_in">type</span> veth peer name p2_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev p1_2 name p1_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev p2_1 name p2_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨OVS</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################ s1 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s1 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1001</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ifconfig s1 192.168.1.12 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s1 p1_2 -- <span class="built_in">set</span> Interface p1_2 ofport_request=12</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s1 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s2 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s2 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x08</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s2 -- <span class="built_in">set</span> bridge s2 datapath_type=netdev</span><br><span class="line">ifconfig s2 192.168.1.21 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s2 p2_1 -- <span class="built_in">set</span> Interface p2_1 ofport_request=21</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s2 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br></pre></td></tr></table></figure><h3 id="OVS-OVS-OVS"><a href="#OVS-OVS-OVS" class="headerlink" title="OVS-OVS-OVS"></a>OVS-OVS-OVS</h3><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/OVS%20%E6%B5%81%E7%A8%8B%E5%9B%BE-ovs-ovs-ovs.png" alt="OVS æµç¨‹å›¾-ovs-ovs-ovs"></p><p><strong>æ‹“æ‰‘æ­å»º</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">dpdk-hugepages.py -p 1G --setup 6G</span><br><span class="line">modprobe openvswitch</span><br><span class="line"></span><br><span class="line"><span class="comment">## åˆ›å»ºå®¹å™¨</span></span><br><span class="line">sudo docker create -it --name=s1 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-vlog</span><br><span class="line">sudo docker create -it --name=s2 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-vlog</span><br><span class="line">sudo docker create -it --name=s3 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-vlog</span><br><span class="line">sudo docker start s1 s2 s3</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  veth-peer</span></span><br><span class="line">sudo ip <span class="built_in">link</span> add s1_2 <span class="built_in">type</span> veth peer name s2_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> add s3_2 <span class="built_in">type</span> veth peer name s2_3 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> add s1_3 <span class="built_in">type</span> veth peer name s3_1 &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s1_2 name s1_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s1_3 name s1_3 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s2_1 name s2_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s2_3 name s2_3 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s3_1 name s3_1 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s3) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s3_2 name s3_2 netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s3) up</span><br></pre></td></tr></table></figure><p><strong>å¯åŠ¨OVS</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################ s1 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s1 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1001</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:01&quot;</span></span><br><span class="line">ifconfig s1 192.168.10.1 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s1 s1_2 -- <span class="built_in">set</span> Interface s1_2 ofport_request=12</span><br><span class="line">ovs-vsctl add-port s1 s1_3 -- <span class="built_in">set</span> Interface s1_3 ofport_request=13</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s1 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s2 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s2 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x08</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s2 -- <span class="built_in">set</span> bridge s2 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s2 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:02&quot;</span></span><br><span class="line">ifconfig s2 192.168.10.2 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s2 s2_1 -- <span class="built_in">set</span> Interface s2_1 ofport_request=21</span><br><span class="line">ovs-vsctl add-port s2 s2_3 -- <span class="built_in">set</span> Interface s2_3 ofport_request=23</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s2 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s3 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s3 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x20</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s3 -- <span class="built_in">set</span> bridge s3 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s3 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:03&quot;</span></span><br><span class="line">ifconfig s3 192.168.10.3 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s3 s3_1 -- <span class="built_in">set</span> Interface s3_1 ofport_request=31</span><br><span class="line">ovs-vsctl add-port s3 s3_2 -- <span class="built_in">set</span> Interface s3_2 ofport_request=32</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s3vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br></pre></td></tr></table></figure><p><strong>è½¬å‘æµè¡¨</strong>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s1</span></span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.1,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.2,actions=output:s1_2</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.3,actions=output:s1_3</span><br><span class="line"><span class="comment"># s2</span></span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.2,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.1,actions=output:s2_1</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.3,actions=output:s2_3</span><br><span class="line"><span class="comment"># s3</span></span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.3,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.1,actions=output:s3_1</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.2,actions=output:s3_2</span><br><span class="line"><span class="comment"># arp</span></span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.3 00:00:00:00:10:03</span><br></pre></td></tr></table></figure><p><strong>è½¬å‘æµè¡¨2</strong>ï¼š1&lt;-&gt;2&lt;-&gt;3 (1ä¸3ä¸ç›´è¿)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s1</span></span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.1,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.2,actions=output:s1_2</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.3,actions=output:s1_2</span><br><span class="line"><span class="comment"># s2</span></span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.2,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.1,actions=output:s2_1</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.3,actions=output:s2_3</span><br><span class="line"><span class="comment"># s3</span></span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.3,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.1,actions=output:s3_2</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.2,actions=output:s3_2</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•ATS"><a href="#æµ‹è¯•ATS" class="headerlink" title="æµ‹è¯•ATS"></a>æµ‹è¯•ATS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl <span class="built_in">set</span> interface s1_2 other_config:qdisc-params=<span class="string">&quot;rate:1=10000&quot;</span> <span class="comment"># 10M</span></span><br><span class="line">ovs-appctl vlog/set dpif_qdisc:file:dbg</span><br><span class="line"><span class="comment"># s1</span></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> interface s1_2 other_config:qdisc=ATS</span><br><span class="line"><span class="comment"># s2</span></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> interface s2_3 other_config:qdisc=ATS</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> interface s2_1 other_config:qdisc=ATS</span><br><span class="line"><span class="comment"># s3</span></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> interface s3_2 other_config:qdisc=ATS</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################ s1 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s1 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1001</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s1 -- <span class="built_in">set</span> bridge s1 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s1 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:01&quot;</span></span><br><span class="line">ifconfig s1 192.168.10.1 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s1 s1_2 -- <span class="built_in">set</span> Interface s1_2 ofport_request=12</span><br><span class="line">ovs-vsctl add-port s1 s1_3 -- <span class="built_in">set</span> Interface s1_3 ofport_request=13</span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.3 00:00:00:00:10:03</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.1,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.2,actions=output:s1_2</span><br><span class="line">ovs-ofctl add-flow s1 ip,nw_dst=192.168.10.3,actions=output:s1_2</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s1 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s2 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s2 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x08</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-appctl vlog/set dpif_qdisc:file:dbg</span><br><span class="line">ovs-vsctl add-br s2 -- <span class="built_in">set</span> bridge s2 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s2 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:02&quot;</span></span><br><span class="line">ifconfig s2 192.168.10.2 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s2 s2_1 -- <span class="built_in">set</span> Interface s2_1 ofport_request=21</span><br><span class="line">ovs-vsctl add-port s2 s2_3 -- <span class="built_in">set</span> Interface s2_3 ofport_request=23</span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.3 00:00:00:00:10:03</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.2,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.1,actions=output:s2_1</span><br><span class="line">ovs-ofctl add-flow s2 ip,nw_dst=192.168.10.3,actions=output:s2_3</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s2 vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################################ s3 ####################################</span></span><br><span class="line">docker <span class="built_in">exec</span> -it s3 bash</span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=1002</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x20</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br s3 -- <span class="built_in">set</span> bridge s3 datapath_type=netdev</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> bridge s3 other_config:hwaddr=<span class="string">&quot;00:00:00:00:10:03&quot;</span></span><br><span class="line">ifconfig s3 192.168.10.3 netmask 255.255.255.0 up</span><br><span class="line">ovs-vsctl add-port s3 s3_1 -- <span class="built_in">set</span> Interface s3_1 ofport_request=31</span><br><span class="line">ovs-vsctl add-port s3 s3_2 -- <span class="built_in">set</span> Interface s3_2 ofport_request=32</span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.3 00:00:00:00:10:03</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.3,actions=output:LOCAL</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.1,actions=output:s3_2</span><br><span class="line">ovs-ofctl add-flow s3 ip,nw_dst=192.168.10.2,actions=output:s3_2</span><br><span class="line"><span class="comment"># ovs-vsctl add-port s3vhost-user1 -- set Interface vhost-user1 type=dpdkvhostuser ofport_request=2</span></span><br></pre></td></tr></table></figure><h3 id="veth-OVS-veth"><a href="#veth-OVS-veth" class="headerlink" title="veth-OVS-veth"></a>veth-OVS-veth</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sudo docker create -it --name=s1 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-vlog</span><br><span class="line">sudo docker create -it --name=s2 --privileged -v /dev/hugepages:/dev/hugepages -v /root/run:/root/run ovs-dpdk:2.16.0-vlog</span><br><span class="line">sudo docker start s1 s2</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  veth-peer</span></span><br><span class="line">sudo ip <span class="built_in">link</span> add sh_1 <span class="built_in">type</span> veth peer name s1_h &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> add sh_2 <span class="built_in">type</span> veth peer name s2_h &gt; /dev/null</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s1_h name s1_h netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s1) up</span><br><span class="line">sudo ip <span class="built_in">link</span> <span class="built_in">set</span> dev s2_h name s2_h netns $(sudo docker inspect -f <span class="string">&#x27;&#123;&#123;.State.Pid&#125;&#125;&#x27;</span> s2) up</span><br><span class="line">ifconfig sh_1 up</span><br><span class="line">ifconfig sh_2 up</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it s1 bash</span><br><span class="line">ifconfig s1_h 192.168.10.1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev s1_h address 00:00:00:00:10:01</span><br><span class="line">arp -s 192.168.10.2 00:00:00:00:10:02</span><br><span class="line"></span><br><span class="line">docker <span class="built_in">exec</span> -it s2 bash</span><br><span class="line">ifconfig s2_h 192.168.10.2</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev s2_h address 00:00:00:00:10:02</span><br><span class="line">arp -s 192.168.10.1 00:00:00:00:10:01</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 sh_1 -- <span class="built_in">set</span> Interface sh_1 ofport_request=11</span><br><span class="line">ovs-vsctl add-port br0 sh_2 -- <span class="built_in">set</span> Interface sh_2 ofport_request=12</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.10.1,actions=output:sh_1</span><br><span class="line">ovs-ofctl add-flow br0 ip,nw_dst=192.168.10.2,actions=output:sh_2</span><br><span class="line"></span><br><span class="line"><span class="comment">## ATS</span></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> interface sh_1 other_config:qdisc=ATS</span><br><span class="line">ovs-vsctl <span class="built_in">set</span> interface sh_2 other_config:qdisc=ATS</span><br></pre></td></tr></table></figure><h3 id="PKTGEN-OVS-TESTPMD"><a href="#PKTGEN-OVS-TESTPMD" class="headerlink" title="PKTGEN-OVS-TESTPMD"></a>PKTGEN-OVS-TESTPMD</h3><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/OVS%20%E6%B5%81%E7%A8%8B%E5%9B%BE-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95.drawio%20(1).png" alt="OVS æµç¨‹å›¾-æ€§èƒ½æµ‹è¯•.drawio (1)"></p><p>ç”±äºä¸Šé¢çš„æ‹“æ‰‘å­˜åœ¨è¿æ¥é—®é¢˜ï¼Œåªå¥½ç”¨å•èŠ‚ç‚¹æµ‹è¯•OVSçš„é€Ÿç‡ä¸PMDçš„å…³ç³»ï¼Œè¿™é‡ŒOVSå°±ç›´æ¥éƒ¨ç½²åœ¨ä¸»æœºä¸Šï¼Œpktgenå’Œtestpmdæ”¾ç½®åœ¨Dockerä¸­è¿è¡Œã€‚</p><p><strong>æ‹“æ‰‘æ­å»º</strong>ï¼šåŸºæœ¬æ‹“æ‰‘æ­å»ºæ–¹æ³•å¦‚ä¸‹ï¼Œä½†å®é™…æµ‹è¯•æ—¶ä¼šä¿®æ”¹å‚æ•°ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## åˆ é™¤ä¹‹å‰çš„é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br><span class="line"></span><br><span class="line"><span class="comment">## æ·»åŠ  bridge</span></span><br><span class="line">ovs-vsctl add-br br0 -- <span class="built_in">set</span> bridge br0 datapath_type=netdev</span><br><span class="line">ovs-vsctl add-port br0 vhost-user1 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user1 <span class="built_in">type</span>=dpdkvhostuser ofport_request=1</span><br><span class="line">ovs-vsctl add-port br0 vhost-user2 \</span><br><span class="line">    -- <span class="built_in">set</span> Interface vhost-user2 <span class="built_in">type</span>=dpdkvhostuser ofport_request=2</span><br><span class="line"></span><br><span class="line"><span class="comment">## å¯åŠ¨å®¹å™¨</span></span><br><span class="line"><span class="comment"># pktgen</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-pktgen \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">pktgen -c 0x19 --main-lcore 3 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;0.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># testpmd</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> --privileged --name=app-testpmd \</span><br><span class="line">    -v /dev/hugepages:/dev/hugepages \</span><br><span class="line">    -v /usr/local/var/run/openvswitch:/var/run/openvswitch \</span><br><span class="line">    pktgen20:latest /bin/bash</span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0xE0 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user2,mac=00:00:00:00:00:02,path=/var/run/openvswitch/vhost-user2&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0xc0 --forward-mode=rxonly</span><br></pre></td></tr></table></figure><p><strong>å‚æ•°è¯´æ˜</strong>ï¼š</p><ul><li><p><code>pmd-cpu-mask</code>ï¼šæŒ‡å®šåœ¨å“ªäº›æ ¸ä¸Šé¢ç»‘å®šPMDçº¿ç¨‹ï¼Œå³æŒ‡å®šäº†PMDåˆ›å»ºçš„æ•°é‡ã€‚</p></li><li><p><code>dpdk-lcore-mask</code>ï¼šæŒ‡å®šåœ¨å“ªäº›æ ¸ä¸Šåˆ›å»ºlcore çº¿ç¨‹ï¼Œè¯¥çº¿ç¨‹ç”¨äº dpdk åº“å†…éƒ¨æ¶ˆæ¯å¤„ç†ï¼Œå¦‚æ—¥å¿—ç­‰ã€‚</p></li><li><p><code>-c</code>ï¼šæŒ‡å®šåœ¨å“ªäº›æ ¸ä¸Šè¿è¡ŒPktgenå‘åŒ…æˆ–æ¥æ”¶çº¿ç¨‹ã€‚</p></li><li><p><code>-m</code>ï¼šæŒ‡å®šæ ¸ä¸ç«¯å£çš„å¯¹åº”å…³ç³»ï¼Œæ³¨æ„è¿™é‡Œçš„ç¼–å·ä»0å¼€å§‹æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â€œ1.0, 2.1, 3.2â€               - core 1 handles port 0 rx/tx,</span><br><span class="line">                                core 2 handles port 1 rx/tx</span><br><span class="line">                                core 3 handles port 2 rx/tx</span><br><span class="line">1.[0-2], 2.3, ...             - core 1 handle ports 0,1,2 rx/tx,</span><br><span class="line">                                core 2 handle port 3 rx/tx</span><br><span class="line">[1:2].0, [4:6].1, ...         - core 1 handles port 0 rx,</span><br><span class="line">                                core 2 handles port 0 tx,</span><br></pre></td></tr></table></figure></li><li><p><code>--coremask=0xXX</code>ï¼šæŒ‡å®šåœ¨å“ªäº›æ ¸ä¸Šè¿è¡ŒåŒ…è½¬å‘ã€‚</p></li></ul><h4 id="æµ‹è¯•1"><a href="#æµ‹è¯•1" class="headerlink" title="æµ‹è¯•1"></a>æµ‹è¯•1</h4><p>CPUä¸º <code>i7-12700k</code>ï¼Œç³»ç»Ÿä¸º <code>Ubuntu 20.04</code>ï¼</p><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/image-20220703165153359.png" alt="image-20220703165153359"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x2</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-lcore-mask=0x1</span><br><span class="line"></span><br><span class="line">pktgen -c 0x30 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;5.0&quot;</span></span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0x300 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user2,mac=00:00:00:00:00:02,path=/var/run/openvswitch/vhost-user2&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0x200 --forward-mode=rxonly</span><br></pre></td></tr></table></figure><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/image-20220703163105375.png" alt="image-20220703163105375"></p><p>å¯ä»¥çœ‹åˆ°CPUçš„å ç”¨æƒ…å†µä¸é…ç½®ä¸€è‡´ï¼<code>Pktgen</code>å ç”¨äº†ä¸¤ä¸ªæ ¸ã€‚</p><p><strong>æœªé…ç½®æµè¡¨çš„æƒ…å†µä¸‹çš„é€Ÿç‡ä¸é…ç½®æµè¡¨åçš„é€Ÿç‡æ˜æ˜¾æœ‰åŒºåˆ«</strong>ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœªé…ç½®æµè¡¨æƒ…å†µä¸‹ï¼Œå®‰è£…é»˜è®¤çš„ Normal è½¬å‘</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®åŒ…å¤§å°ä¸º 64 BYTEï¼Œæµ‹å¾—æ¥æ”¶é€Ÿç‡ä¸º 3 Gbps</span></span><br><span class="line">testpmd&gt; show port stats all</span><br><span class="line">  <span class="comment">######################## NIC statistics for port 0  ########################</span></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:      6284600          Rx-bps:   3 016 608 216</span><br><span class="line">  Tx-pps:            0          Tx-bps:            0</span><br><span class="line">  <span class="comment">############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®åŒ…å¤§å°ä¸º 1500 BYTEï¼Œæµ‹å¾—æ¥æ”¶é€Ÿç‡ä¸º 42 Gbps</span></span><br><span class="line">testpmd&gt; show port stats all</span><br><span class="line">  <span class="comment">######################## NIC statistics for port 0  ########################</span></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:      3572386          Rx-bps:  42 754 318 664</span><br><span class="line">  Tx-pps:            0          Tx-bps:            0</span><br><span class="line">  <span class="comment">############################################################################</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################################################################</span></span><br><span class="line">ovs-ofctl add-flow br0 in_port=vhost-user1,actions=output:vhost-user2</span><br><span class="line"><span class="comment">############################################################################</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ•°æ®åŒ…å¤§å°ä¸º 64 BYTEï¼Œæµ‹å¾—æ¥æ”¶é€Ÿç‡ä¸º 7.8 Gbps</span></span><br><span class="line">testpmd&gt; show port stats all</span><br><span class="line">  <span class="comment">######################## NIC statistics for port 0  ########################</span></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:     16353825          Rx-bps:   7 849 813 576</span><br><span class="line">  Tx-pps:            0          Tx-bps:            0</span><br><span class="line">  <span class="comment">############################################################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ•°æ®åŒ…å¤§å°ä¸º 1500 BYTEï¼Œæµ‹å¾—æ¥æ”¶é€Ÿç‡ä¸º 88 Gbps</span></span><br><span class="line">testpmd&gt; show port stats all</span><br><span class="line">  <span class="comment">######################## NIC statistics for port 0  ########################</span></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:      7380556          Rx-bps:  88 330 499 920</span><br><span class="line">  Tx-pps:            0          Tx-bps:            0</span><br><span class="line">  <span class="comment">############################################################################</span></span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•2"><a href="#æµ‹è¯•2" class="headerlink" title="æµ‹è¯•2"></a>æµ‹è¯•2</h4><p><img src="/../images/OpenVSwitch-DPDK-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/image-20220703171156821.png" alt="image-20220703171156821"></p><p>ä¸Šé¢è®¾ç½®æµè¡¨åï¼Œè½¬å‘é€Ÿç‡æœ‰äº†å¾ˆå¤šæå‡ï¼Œä½†ç“¶é¢ˆåœ¨å“ªä¸€ä¸ªé˜¶æ®µï¼ˆå‘åŒ…ã€è½¬å‘ã€æ”¶åŒ…ï¼‰è¿˜ä¸ç¡®å®šï¼Œå¯èƒ½ä»ç„¶åœ¨è½¬å‘è¿™é‡Œï¼Œå› æ­¤å…ˆæµ‹è¯•å¯ç”¨ä¸¤ä¸ªPMDçº¿ç¨‹åçš„é€Ÿç‡ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x6</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-lcore-mask=0x1</span><br><span class="line"></span><br><span class="line">ovs-vsctl <span class="built_in">set</span> Interface vhost-user1 options:n_rxq=2</span><br><span class="line"></span><br><span class="line">pktgen -c 0x30 -n 1 --socket-mem 1024 --file-prefix pktgen --no-pci  \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user1,mac=00:00:00:00:00:01,path=/var/run/openvswitch/vhost-user1&#x27;</span> \</span><br><span class="line">-- -T -P -m <span class="string">&quot;5.0&quot;</span></span><br><span class="line"></span><br><span class="line">dpdk-testpmd -c 0x300 -n 1 --socket-mem 1024 --file-prefix testpmd --no-pci \</span><br><span class="line">--vdev <span class="string">&#x27;net_virtio_user2,mac=00:00:00:00:00:02,path=/var/run/openvswitch/vhost-user2&#x27;</span> \</span><br><span class="line">-- -i -a --coremask=0x200 --forward-mode=rxonly</span><br></pre></td></tr></table></figure><p>æ ¹æ®æ—¥å¿—ï¼Œç¡®å®å¯ç”¨äº†2ä¸ªPMDçº¿ç¨‹ï¼Œä½†å¹¶æ²¡æœ‰å°†<code>vhost-user1</code>è®¾ç½®ä¸ºåŒæ¥æ”¶é˜Ÿåˆ—ï¼æŒ‰ç…§æ–‡æ¡£ä¸­çš„æè¿°<a href="http://www.openvswitch.org/support/dist-docs/ovs-vswitchd.conf.db.5.html">n_rxq</a> Not supported by DPDK vHost interfaces. ä½†æ˜¯åœ¨<a href="https://www.intel.com/content/www/us/en/developer/articles/technical/configure-vhost-user-multiqueue-for-ovs-with-dpdk.html">Intel çš„æ–‡æ¡£</a>ä¸­ä¹Ÿæ˜¯ç”¨æ­¤å‚æ•°è®¾ç½®çš„ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2022-07-03T09:32:20.070Z|00075|dpif_netdev|INFO|PMD thread on numa_id: 0, core <span class="built_in">id</span>:  1 created.</span><br><span class="line">2022-07-03T09:32:20.073Z|00076|dpif_netdev|INFO|PMD thread on numa_id: 0, core <span class="built_in">id</span>:  2 created.</span><br><span class="line">2022-07-03T09:32:20.073Z|00077|dpif_netdev|INFO|There are 2 pmd threads on numa node 0</span><br><span class="line">...</span><br><span class="line">2022-07-03T09:32:20.191Z|00086|dpif_netdev|INFO|Core  1 on numa node 0 assigned port <span class="string">&#x27;vhost-user1&#x27;</span> rx queue 0 (measured processing cycles 0).</span><br><span class="line">2022-07-03T09:32:20.191Z|00087|dpif_netdev|INFO|Core  2 on numa node 0 assigned port <span class="string">&#x27;vhost-user2&#x27;</span> rx queue 0 (measured processing cycles 0).</span><br></pre></td></tr></table></figure><p>ç”±äºä¸€ä¸ªæ¥æ”¶é˜Ÿåˆ—åªèƒ½äº¤ç»™ä¸€ä¸ªPMDå¤„ç†ï¼Œæ‰€ä»¥è¿™é‡Œè™½ç„¶è®¾ç½®ä¸¤ä¸ªPMDï¼Œä½†ä»ç„¶åªæœ‰ä¸€ä¸ªPMDåœ¨è½¬å‘åŒ…ï¼Œè™½ç„¶ç›¸æ¯”ä¹‹å‰ï¼Œä¸ç”¨å»è½®è¯¢<code>vhost-user2</code>ç«¯å£ä¸Šçš„é˜Ÿåˆ—ï¼Œä¸è¿‡ä¸çŸ¥é“è½®è¯¢ä¸€ä¸ªç©ºé˜Ÿåˆ—çš„å¼€é”€å¤§å°ã€‚</p><p>æ­¤æƒ…å†µä¸‹ï¼Œå®é™…æµ‹å¾—æ¥æ”¶é€Ÿç‡ä»ç„¶ä¸º 88 Gbpsï¼Œæ•…ä»ç„¶ä¸ç¡®å®šç“¶é¢ˆåœ¨å“ªï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ•°æ®åŒ…å¤§å°ä¸º 1500 BYTEï¼Œæµ‹å¾—æ¥æ”¶é€Ÿç‡ä¸º 88 Gbps</span></span><br><span class="line">testpmd&gt; show port stats all</span><br><span class="line">  <span class="comment">######################## NIC statistics for port 0  ########################</span></span><br><span class="line">  Throughput (since last show)</span><br><span class="line">  Rx-pps:      7421329          Rx-bps:  88818467544</span><br><span class="line">  Tx-pps:            0          Tx-bps:            0</span><br><span class="line">  <span class="comment">############################################################################</span></span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><p><a href="https://man7.org/linux/man-pages/man5/ovs-vswitchd.conf.db.5.html#Open_vSwitch_TABLE">Open_vSwitch å®ˆæŠ¤è¿›ç¨‹é…ç½®</a><br><a href="https://zhuanlan.zhihu.com/p/269782783">CPU socket</a><br><a href="https://bbs.huaweicloud.com/forum/thread-71514-1-1.html">æŸ¥çœ‹ç½‘å¡å½’å±å“ªä¸ªCPU socket</a><br><a href="https://www.cxyzjd.com/article/sinat_20184565/93471205">OVS DPDKè®¾å¤‡å†…å­˜æ¨¡å‹</a></p>]]></content>
      
      
      <categories>
          
          <category> OpenVSwitch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenVSwitch </tag>
            
            <tag> DPDK </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç½‘ç»œç¼–ç¨‹-çº¿ç¨‹æ± </title>
      <link href="/2022/05/16/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E6%B1%A0/"/>
      <url>/2022/05/16/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E6%B1%A0/</url>
      
        <content type="html"><![CDATA[<p>åœ¨å¤šä»»åŠ¡å¹¶å‘å¤„ç†çš„åœºæ™¯ä¸‹ï¼Œå¦‚æœæ¯æ¥ä¸€ä¸ªä»»åŠ¡ï¼Œå°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œè™½ç„¶åŠŸèƒ½ä¸Šæ²¡é—®é¢˜ï¼Œä½†ç”±äºçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ä¼šå¸¦æ¥å¾ˆå¤§çš„å¼€é”€ã€‚çº¿ç¨‹æ± å°±æ˜¯é€šè¿‡é¢„å…ˆåˆ›å»ºä¸€å®šæ•°é‡çš„çº¿ç¨‹ï¼Œå½“æœ‰ä»»åŠ¡æ¥æ—¶ï¼Œå°±å°†ä»»åŠ¡åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹å»å¤„ç†ï¼</p><h2 id="çº¿ç¨‹æ± æ¨¡å‹"><a href="#çº¿ç¨‹æ± æ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ± æ¨¡å‹"></a>çº¿ç¨‹æ± æ¨¡å‹</h2><p>ä¸‹é¢æ˜¯çº¿ç¨‹æ± çš„ç»“æ„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">threadpool_t</span> &#123;</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> lock;           <span class="comment">/* ç”¨äºé”ä½æœ¬ç»“æ„ä½“ */</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> thread_counter; <span class="comment">/* è®°å½•å¿™çŠ¶æ€çº¿ç¨‹ä¸ªæ•°çš„é” */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_cond_t</span> queue_not_full;  <span class="comment">/* å½“ä»»åŠ¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œæ·»åŠ ä»»åŠ¡ä»»åŠ¡çš„çº¿ç¨‹é˜»å¡ï¼Œç­‰å¾…æ­¤æ¡ä»¶å˜é‡ */</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> queue_not_empty; <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œé€šçŸ¥ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> *threads;             <span class="comment">/* å­˜æ”¾çº¿ç¨‹æ± ä¸­æ¯ä¸ªçº¿ç¨‹çš„ tid æ•°ç»„ */</span></span><br><span class="line">    <span class="type">pthread_t</span> adjust_tid;           <span class="comment">/* å­˜ç®¡ç†çº¿ç¨‹tid */</span></span><br><span class="line">    <span class="type">threadpool_task_t</span> *task_queue;  <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ•°ç»„é¦–åœ°å€ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> min_thr_num;                <span class="comment">/* çº¿ç¨‹æ± æœ€å°çº¿ç¨‹æ•° */</span></span><br><span class="line">    <span class="type">int</span> max_thr_num;                <span class="comment">/* çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•° */</span></span><br><span class="line">    <span class="type">int</span> live_thr_num;               <span class="comment">/* å½“å‰å­˜æ´»çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line">    <span class="type">int</span> busy_thr_num;               <span class="comment">/* å¿™çŠ¶æ€çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line">    <span class="type">int</span> wait_exit_thr_num;          <span class="comment">/* è¦é”€æ¯çš„çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> queue_front;                <span class="comment">/* task_queue é˜Ÿå¤´ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="type">int</span> queue_rear;                 <span class="comment">/* task_queue é˜Ÿå°¾ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="type">int</span> queue_size;                 <span class="comment">/* task_queue é˜Ÿä¸­å®é™…ä»»åŠ¡æ•° */</span></span><br><span class="line">    <span class="type">int</span> queue_max_size;             <span class="comment">/* task_queue é˜Ÿä¸­å¯å®¹çº³çš„ä»»åŠ¡æ•°ä¸Šé™ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> shutdown;                  <span class="comment">/* æ ‡å¿—ä½ï¼Œçº¿ç¨‹æ± ä½¿ç”¨çŠ¶æ€ï¼Œtrueæˆ–false */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="çº¿ç¨‹æ•°ç»„å’Œä»»åŠ¡é˜Ÿåˆ—"><a href="#çº¿ç¨‹æ•°ç»„å’Œä»»åŠ¡é˜Ÿåˆ—" class="headerlink" title="çº¿ç¨‹æ•°ç»„å’Œä»»åŠ¡é˜Ÿåˆ—"></a>çº¿ç¨‹æ•°ç»„å’Œä»»åŠ¡é˜Ÿåˆ—</h3><p>çº¿ç¨‹æ± çš„æ ¸å¿ƒä¹Ÿå°±æ˜¯çº¿ç¨‹æ•°ç»„å’Œä»»åŠ¡é˜Ÿåˆ—ï¼</p><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B%E6%B1%A0/threadpool1.png" alt="image"></p><p><strong>1. çº¿ç¨‹æ•°ç»„ï¼šthreadsã€‚</strong></p><p>æ³¨æ„æ­¤å¤„çš„å®ç°ä¸­ï¼Œçº¿ç¨‹çš„æ•°é‡ä¸æ˜¯å›ºå®šçš„ï¼Œå¯åœ¨æœ€å°çº¿ç¨‹æ•°å’Œæœ€å¤§çº¿ç¨‹æ•°ä¹‹é—´åŠ¨æ€è°ƒæ•´ã€‚å½“çªå‘ä»»åŠ¡æ•°é‡å¤§äºæœ€å°çº¿ç¨‹æ•°æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ›å»ºæ–°çº¿ç¨‹ä»¥å¤„ç†çªå‘ä»»åŠ¡ï¼Œä»»åŠ¡å¤„ç†å®Œä¹‹åï¼Œè‹¥æ²¡æœ‰å…¶ä»–ä»»åŠ¡éœ€è¦å¤„ç†ï¼Œ<strong>ç®¡ç†çº¿ç¨‹</strong>ä¼šå®šæ—¶å›æ”¶ç©ºé—²çš„çº¿ç¨‹ï¼Œä½†ä¿è¯çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°ä¸ä¼šå°äºæœ€å°çº¿ç¨‹æ•°ã€‚</p><p>å½“çªå‘ä»»åŠ¡æ•°é‡å¤§äºæœ€å¤§çº¿ç¨‹æ•°æ—¶ï¼Œçº¿ç¨‹æ± åˆ›å»ºçš„çº¿ç¨‹æ•°ä¼šè¢«é™åˆ¶åœ¨æœ€å¤§çº¿ç¨‹æ•°ã€‚</p><p>åŸºäºä¸Šè¿°åŸç†ï¼Œçº¿ç¨‹æ± ç»“æ„ä¸­ï¼Œä»¥ä¸‹5ä¸ªæˆå‘˜å˜é‡ç”¨äºè¾…åŠ©ç®¡ç†çº¿ç¨‹æ•°ç»„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pthread_t</span> *threads;     <span class="comment">/* å­˜æ”¾çº¿ç¨‹æ± ä¸­æ¯ä¸ªçº¿ç¨‹çš„ tid æ•°ç»„ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> min_thr_num;        <span class="comment">/* çº¿ç¨‹æ± æœ€å°çº¿ç¨‹æ•° */</span></span><br><span class="line"><span class="type">int</span> max_thr_num;        <span class="comment">/* çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•° */</span></span><br><span class="line"><span class="type">int</span> live_thr_num;       <span class="comment">/* å½“å‰å­˜æ´»çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line"><span class="type">int</span> busy_thr_num;       <span class="comment">/* å¿™çŠ¶æ€çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line"><span class="type">int</span> wait_exit_thr_num;  <span class="comment">/* è¦é”€æ¯çš„çº¿ç¨‹ä¸ªæ•° */</span></span><br></pre></td></tr></table></figure><p><strong>2. ä»»åŠ¡é˜Ÿåˆ—ï¼štask_queueã€‚</strong></p><p>ä¸çº¿ç¨‹æ•°ç»„ä¸åŒï¼Œä»»åŠ¡é˜Ÿåˆ—æ˜¯ä¸€ä¸ªå›ºå®šå¤§å°çš„<strong>å¾ªç¯é˜Ÿåˆ—</strong>ï¼Œç”¨äºå­˜æ”¾å¾…å¤„ç†çš„ä»»åŠ¡ï¼Œçº¿ç¨‹æ± éœ€è¦å¤„ç†çš„<strong>ä»»åŠ¡ç±»å‹</strong>å’Œ<strong>å‚æ•°</strong>ä¸ä¸€ï¼Œæ— æ³•é¢„å…ˆå®šä¹‰åœ¨çº¿ç¨‹ä¸­ï¼Œåªèƒ½é€šè¿‡ä»»åŠ¡ä¼ å…¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­å­˜å‚¨çš„å†…å®¹è¦åŒ…æ‹¬**ä»»åŠ¡ç±»å‹<code>ï¼ˆvoid *(*func)(void*arg)ï¼‰</code><strong>å’Œ</strong>å‚æ•°<code>ï¼ˆvoid *argï¼‰</code>**ã€‚</p><p>ä½¿ç”¨çº¿ç¨‹æ± æ—¶ï¼Œåªéœ€è°ƒç”¨å‡½æ•°å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—å°¾éƒ¨å³å¯ï¼Œçº¿ç¨‹æ± ä¼šè‡ªåŠ¨ä¸ºä»»åŠ¡åˆ†é…çº¿ç¨‹å¤„ç†ã€‚ä½†å½“ä»»åŠ¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šæ‹’ç»æ·»åŠ æ–°ä»»åŠ¡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *(*function)(<span class="type">void</span> *);  <span class="comment">/* å‡½æ•°æŒ‡é’ˆï¼Œå›è°ƒå‡½æ•° */</span></span><br><span class="line">    <span class="type">void</span> *arg;                  <span class="comment">/* ä¸Šé¢å‡½æ•°çš„å‚æ•° */</span></span><br><span class="line">&#125; <span class="type">threadpool_task_t</span>;            <span class="comment">/* å„å­çº¿ç¨‹ä»»åŠ¡ç»“æ„ä½“ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">threadpool_task_t</span> *task_queue;  <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ•°ç»„é¦–åœ°å€ */</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> queue_front;                <span class="comment">/* task_queue é˜Ÿå¤´ä¸‹æ ‡ */</span></span><br><span class="line"><span class="type">int</span> queue_rear;                 <span class="comment">/* task_queue é˜Ÿå°¾ä¸‹æ ‡ */</span></span><br><span class="line"><span class="type">int</span> queue_size;                 <span class="comment">/* task_queue é˜Ÿä¸­å®é™…ä»»åŠ¡æ•° */</span></span><br><span class="line"><span class="type">int</span> queue_max_size;             <span class="comment">/* task_queue é˜Ÿä¸­å¯å®¹çº³çš„ä»»åŠ¡æ•°ä¸Šé™ */</span></span><br></pre></td></tr></table></figure><h3 id="çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹"><a href="#çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹"></a>çº¿ç¨‹æ± ç®¡ç†çº¿ç¨‹</h3><p>çº¿ç¨‹æ± ä¸­é™¤äº†ä¸“é—¨ç”¨äºå¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ï¼Œè¿˜éœ€è¦æœ‰ä¸€ä¸ª<strong>ç®¡ç†çº¿ç¨‹</strong>ï¼Œç”¨äºç®¡ç†çº¿ç¨‹æ± ä¸­çš„ä»»åŠ¡çº¿ç¨‹ã€‚çº¿ç¨‹æ± çš„åŠ¨æ€æ‰©å®¹å’Œé”€æ¯éƒ½æ˜¯é€šè¿‡ç®¡ç†çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œç®¡ç†çº¿ç¨‹<strong>å®šæœŸ</strong>æ ¹æ®å½“å‰çº¿ç¨‹æ•°ç»„å’Œä»»åŠ¡æ•°ç»„æƒ…å†µï¼Œå†³å®šæ˜¯å¦éœ€è¦æ‰©å®¹æˆ–é”€æ¯çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pthread_t</span> adjust_tid;           <span class="comment">/* å­˜ç®¡ç†çº¿ç¨‹tid */</span></span><br></pre></td></tr></table></figure><h3 id="æ¡ä»¶å˜é‡ä¸äº’æ–¥é”"><a href="#æ¡ä»¶å˜é‡ä¸äº’æ–¥é”" class="headerlink" title="æ¡ä»¶å˜é‡ä¸äº’æ–¥é”"></a>æ¡ä»¶å˜é‡ä¸äº’æ–¥é”</h3><p>çº¿ç¨‹æ± çš„ä»»åŠ¡åˆ†é…ä¹Ÿå¯çœ‹ä½œ<strong>ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</strong>ï¼Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„å…ƒç´ æ˜¯<strong>äº§å“</strong>ï¼Œçº¿ç¨‹æ± ä¸­çš„æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æ˜¯<strong>æ¶ˆè´¹è€…</strong>ï¼Œå‘çº¿ç¨‹æ± ä¸­æ·»åŠ ä»»åŠ¡çš„æ˜¯<strong>ç”Ÿäº§è€…</strong>ï¼ˆä¸€èˆ¬ä¸ºä¸»çº¿ç¨‹ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œçº¿ç¨‹æ± å¯ä»¥çœ‹ä½œ<strong>å•ç”Ÿäº§è€…ã€å¤šæ¶ˆè´¹è€…æ¨¡å‹</strong>ã€‚</p><p>ä¸€ä¸ªä»»åŠ¡åªéœ€è¦ä¹Ÿåªèƒ½åˆ†é…ç»™ä¸€ä¸ªä»»åŠ¡çº¿ç¨‹å¤„ç†ï¼å› æ­¤ï¼Œéœ€è¦é…åˆæ¡ä»¶å˜é‡å’Œäº’æ–¥é”æ¥å®ç°ä»»åŠ¡åˆ†é…ã€‚</p><ul><li><p><strong>æ¶ˆè´¹è€…</strong>ï¼šæ²¡æœ‰ä»»åŠ¡æ—¶ï¼Œä»»åŠ¡çº¿ç¨‹éƒ½é˜»å¡åœ¨æ¡ä»¶å˜é‡<code>queue_not_empty</code>ä¸Šï¼Œç­‰å¾…æ–°ä»»åŠ¡åˆ°æ¥ã€‚</p></li><li><p><strong>ç”Ÿäº§è€…</strong>ï¼šä»»åŠ¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œä¸»çº¿ç¨‹<code>pthreadpool_add</code>é˜»å¡åœ¨æ¡ä»¶å˜é‡<code>queue_not_full</code>ä¸Šï¼Œç­‰å¾…ä»»åŠ¡é˜Ÿåˆ—ç©ºé—´å¯ç”¨ã€‚</p></li><li><p><code>thread_counter</code>ï¼šè®°å½•å¿™çŠ¶æ€çº¿ç¨‹ä¸ªæ•°çš„é”ï¼</p></li></ul><p><em>æ­¤å¤„å¯ä»¥å…ˆå›é¡¾åŸºäºæ¡ä»¶å˜é‡å®ç°çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼æ­¤å¤„çš„ä»»åŠ¡çº¿ç¨‹å¤„ç†é€»è¾‘ä¸æ¶ˆè´¹è€…ä¸€è‡´ï¼</em></p><h2 id="threadpool-create-å‡½æ•°"><a href="#threadpool-create-å‡½æ•°" class="headerlink" title="threadpool_create å‡½æ•°"></a>threadpool_create å‡½æ•°</h2><p>æ ¹æ®è¾“å…¥çš„å‚æ•°åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå¹¶è¿”å›çº¿ç¨‹æ± çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">threadpool_t</span> *<span class="title function_">threadpool_create</span><span class="params">(<span class="type">int</span> min_thr_num, <span class="type">int</span> max_thr_num, <span class="type">int</span> queue_max_size)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>min_thr_num</code>ï¼šçº¿ç¨‹æ± ä¸­æœ€å°‘å«æœ‰çº¿ç¨‹æ•°</li><li><code>max_thr_num</code>ï¼šçº¿ç¨‹æ± ä¸­æœ€å¤šæœ€å¤šçº¿ç¨‹æ•°</li><li><code>queue_max_size</code>ï¼šçº¿ç¨‹æ± ä¸­ä»»åŠ¡é˜Ÿåˆ—çš„æœ€å¤§å®¹é‡</li><li>è¿”å›å€¼ï¼šçº¿ç¨‹æ± æŒ‡é’ˆï¼Œå¦‚æœåˆ›å»ºå¤±è´¥ï¼Œè¿”å›NULL</li></ul><h2 id="threadpool-add-å‡½æ•°"><a href="#threadpool-add-å‡½æ•°" class="headerlink" title="threadpool_add å‡½æ•°"></a>threadpool_add å‡½æ•°</h2><p>æ·»åŠ ä¸€ä¸ªä»»åŠ¡åˆ°çº¿ç¨‹æ± çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœçº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™é˜»å¡ç­‰å¾…ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">threadpool_add</span><span class="params">(<span class="type">threadpool_t</span> *pool, <span class="type">void</span>*(*function)(<span class="type">void</span> *arg), <span class="type">void</span> *arg)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>pool</code>ï¼šçº¿ç¨‹æ± æŒ‡é’ˆ</li><li><code>function</code>ï¼šä»»åŠ¡å‡½æ•°</li><li><code>arg</code>ï¼šä»»åŠ¡å‡½æ•°å‚æ•°</li><li>è¿”å›å€¼ï¼š0ï¼Œæ·»åŠ æˆåŠŸï¼›ä¸ä¼šå¤±è´¥ï¼Œåªä¼šé˜»å¡ç­‰å¾…ï¼</li></ul><h2 id="threadpool-destroy-å‡½æ•°"><a href="#threadpool-destroy-å‡½æ•°" class="headerlink" title="threadpool_destroy å‡½æ•°"></a>threadpool_destroy å‡½æ•°</h2><p>é”€æ¯ç®¡ç†çº¿ç¨‹ã€é€šçŸ¥æ‰€æœ‰ç©ºé—²çº¿ç¨‹ç»“æŸã€ç­‰å¾…å¿™çº¿ç¨‹ç»“æŸï¼Œé‡Šæ”¾çº¿ç¨‹æ± æ‰€å ç©ºé—´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">threadpool_destroy</span><span class="params">(<span class="type">threadpool_t</span> *pool)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>pool</code>ï¼šçº¿ç¨‹æ± æŒ‡é’ˆ</li><li>è¿”å›å€¼ï¼š0ï¼Œé”€æ¯æˆåŠŸï¼›pool ä¸ºNULL æ—¶ï¼Œè¿”å›-1ã€‚</li></ul><h2 id="å®ç°ä»£ç "><a href="#å®ç°ä»£ç " class="headerlink" title="å®ç°ä»£ç "></a>å®ç°ä»£ç </h2><p>ä¸‹é¢çš„ç®€å•å®ç°å¯ä»¥ç”¨æ¥ç†è§£çº¿ç¨‹æ± çš„åŸç†ï¼Œä½†æ€§èƒ½å¹¶ä¸ç†æƒ³ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;threadpool.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_TIME 10                 <span class="comment">/* 10sæ£€æµ‹ä¸€æ¬¡ */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_WAIT_TASK_NUM 10            <span class="comment">/* å¦‚æœqueue_size &gt; MIN_WAIT_TASK_NUM æ·»åŠ æ–°çš„çº¿ç¨‹åˆ°çº¿ç¨‹æ±  */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_THREAD_VARY 10          <span class="comment">/* æ¯æ¬¡åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„ä¸ªæ•° */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">void</span> *(*function)(<span class="type">void</span> *);          <span class="comment">/* å‡½æ•°æŒ‡é’ˆï¼Œå›è°ƒå‡½æ•° */</span></span><br><span class="line">    <span class="type">void</span> *arg;                          <span class="comment">/* ä¸Šé¢å‡½æ•°çš„å‚æ•° */</span></span><br><span class="line">&#125; <span class="type">threadpool_task_t</span>;                    <span class="comment">/* å„å­çº¿ç¨‹ä»»åŠ¡ç»“æ„ä½“ */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* æè¿°çº¿ç¨‹æ± ç›¸å…³ä¿¡æ¯ */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">threadpool_t</span> &#123;</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> lock;           <span class="comment">/* ç”¨äºé”ä½æœ¬ç»“æ„ä½“ */</span></span><br><span class="line">    <span class="type">pthread_mutex_t</span> thread_counter; <span class="comment">/* è®°å½•å¿™çŠ¶æ€çº¿ç¨‹ä¸ªæ•°çš„é” */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_cond_t</span> queue_not_full;  <span class="comment">/* å½“ä»»åŠ¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œæ·»åŠ ä»»åŠ¡ä»»åŠ¡çš„çº¿ç¨‹é˜»å¡ï¼Œç­‰å¾…æ­¤æ¡ä»¶å˜é‡ */</span></span><br><span class="line">    <span class="type">pthread_cond_t</span> queue_not_empty; <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºæ—¶ï¼Œé€šçŸ¥ç­‰å¾…ä»»åŠ¡çš„çº¿ç¨‹ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> *threads;             <span class="comment">/* å­˜æ”¾çº¿ç¨‹æ± ä¸­æ¯ä¸ªçº¿ç¨‹çš„tid æ•°ç»„ */</span></span><br><span class="line">    <span class="type">pthread_t</span> adjust_tid;           <span class="comment">/* å­˜ç®¡ç†çº¿ç¨‹tid */</span></span><br><span class="line">    <span class="type">threadpool_task_t</span> *task_queue;  <span class="comment">/* ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ•°ç»„é¦–åœ°å€ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> min_thr_num;                <span class="comment">/* çº¿ç¨‹æ± æœ€å°çº¿ç¨‹æ•° */</span></span><br><span class="line">    <span class="type">int</span> max_thr_num;                <span class="comment">/* çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•° */</span></span><br><span class="line">    <span class="type">int</span> live_thr_num;               <span class="comment">/* å½“å‰å­˜æ´»çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line">    <span class="type">int</span> busy_thr_num;               <span class="comment">/* å¿™çŠ¶æ€çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line">    <span class="type">int</span> wait_exit_thr_num;          <span class="comment">/* è¦é”€æ¯çš„çº¿ç¨‹ä¸ªæ•° */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> queue_front;                <span class="comment">/* task_queue é˜Ÿå¤´ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="type">int</span> queue_rear;                 <span class="comment">/* task_queue é˜Ÿå°¾ä¸‹æ ‡ */</span></span><br><span class="line">    <span class="type">int</span> queue_size;                 <span class="comment">/* task_queue é˜Ÿä¸­å®é™…ä»»åŠ¡æ•° */</span></span><br><span class="line">    <span class="type">int</span> queue_max_size;             <span class="comment">/* task_queue é˜Ÿä¸­å¯å®¹çº³çš„ä»»åŠ¡æ•°ä¸Šé™ */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">bool</span> shutdown;                  <span class="comment">/* æ ‡å¿—ä½ï¼Œçº¿ç¨‹æ± ä½¿ç”¨çŠ¶æ€ï¼Œtrueæˆ–false */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">threadpool_thread</span><span class="params">(<span class="type">void</span> *threadpool)</span>;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">adjust_thread</span><span class="params">(<span class="type">void</span> *threadpool)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">is_thread_alive</span><span class="params">(<span class="type">pthread_t</span> tid)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">threadpool_free</span><span class="params">(<span class="type">threadpool_t</span> *pool)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">threadpool_t</span> *<span class="title function_">threadpool_create</span><span class="params">(<span class="type">int</span> min_thr_num, <span class="type">int</span> max_thr_num, <span class="type">int</span> queue_max_size)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">threadpool_t</span> *pool = <span class="literal">NULL</span>;          <span class="comment">/* çº¿ç¨‹æ±  ç»“æ„ä½“ */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ((pool = (<span class="type">threadpool_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">threadpool_t</span>))) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;malloc threadpool failed!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pool-&gt;min_thr_num = min_thr_num;</span><br><span class="line">        pool-&gt;max_thr_num = max_thr_num;</span><br><span class="line">        pool-&gt;busy_thr_num = <span class="number">0</span>;</span><br><span class="line">        pool-&gt;live_thr_num = min_thr_num;               <span class="comment">/* æ´»ç€çš„çº¿ç¨‹æ•° åˆå€¼=æœ€å°çº¿ç¨‹æ•° */</span></span><br><span class="line">        pool-&gt;wait_exit_thr_num = <span class="number">0</span>;</span><br><span class="line">        pool-&gt;queue_size = <span class="number">0</span>;                           <span class="comment">/* æœ‰0ä¸ªäº§å“ */</span></span><br><span class="line">        pool-&gt;queue_max_size = queue_max_size;          <span class="comment">/* æœ€å¤§ä»»åŠ¡é˜Ÿåˆ—æ•° */</span></span><br><span class="line">        pool-&gt;queue_front = <span class="number">0</span>;</span><br><span class="line">        pool-&gt;queue_rear = <span class="number">0</span>;</span><br><span class="line">        pool-&gt;shutdown = <span class="literal">false</span>;                         <span class="comment">/* ä¸å…³é—­çº¿ç¨‹æ±  */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æ ¹æ®æœ€å¤§çº¿ç¨‹ä¸Šé™æ•°ï¼Œ ç»™å·¥ä½œçº¿ç¨‹æ•°ç»„å¼€è¾Ÿç©ºé—´, å¹¶æ¸…é›¶ */</span></span><br><span class="line">        pool-&gt;threads = (<span class="type">pthread_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">pthread_t</span>)*max_thr_num);</span><br><span class="line">        <span class="keyword">if</span> (pool-&gt;threads == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;malloc threads failed!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(pool-&gt;threads, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="type">pthread_t</span>)*max_thr_num);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ç»™ ä»»åŠ¡é˜Ÿåˆ— å¼€è¾Ÿç©ºé—´ */</span></span><br><span class="line">        pool-&gt;task_queue = (<span class="type">threadpool_task_t</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="type">threadpool_task_t</span>)*queue_max_size);</span><br><span class="line">        <span class="keyword">if</span> (pool-&gt;task_queue == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;malloc task failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* åˆå§‹åŒ–äº’æ–¥çã€æ¡ä»¶å˜é‡ */</span></span><br><span class="line">        <span class="keyword">if</span> (pthread_mutex_init(&amp;(pool-&gt;lock), <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">                || pthread_mutex_init(&amp;(pool-&gt;thread_counter), <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">                || pthread_cond_init(&amp;(pool-&gt;queue_not_empty), <span class="literal">NULL</span>) != <span class="number">0</span></span><br><span class="line">                || pthread_cond_init(&amp;(pool-&gt;queue_not_full), <span class="literal">NULL</span>) != <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;init lock or cond failed!\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å¯åŠ¨ min_thr_num ä¸ª work thread */</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; min_thr_num; i++) &#123;</span><br><span class="line">            pthread_create(&amp;pool-&gt;threads[i], <span class="literal">NULL</span>, threadpool_thread, (<span class="type">void</span> *)pool);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;start thread 0x%x ... \n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)pool-&gt;threads[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_create(&amp;(pool-&gt;adjust_tid), <span class="literal">NULL</span>, adjust_thread, (<span class="type">void</span> *)pool);     <span class="comment">/* åˆ›å»ºç®¡ç†è€…çº¿ç¨‹ */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> pool;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    threadpool_free(pool);      <span class="comment">/* å‰é¢ä»£ç è°ƒç”¨å¤±è´¥æ—¶ï¼Œé‡Šæ”¾pollå­˜å‚¨ç©ºé—´ */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å‘çº¿ç¨‹æ± ä¸­ æ·»åŠ ä¸€ä¸ªä»»åŠ¡ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">threadpool_add</span><span class="params">(<span class="type">threadpool_t</span> *pool, <span class="type">void</span>*(*function)(<span class="type">void</span> *arg), <span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* == ä¸ºçœŸï¼Œé˜Ÿåˆ—å·²ç»æ»¡ï¼Œ è°ƒwaité˜»å¡ */</span></span><br><span class="line">    <span class="keyword">while</span> ((pool-&gt;queue_size == pool-&gt;queue_max_size) &amp;&amp; (!pool-&gt;shutdown)) &#123;</span><br><span class="line">        pthread_cond_wait(&amp;(pool-&gt;queue_not_full), &amp;(pool-&gt;lock));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;shutdown) &#123;</span><br><span class="line">        pthread_cond_broadcast(&amp;(pool-&gt;queue_not_empty));</span><br><span class="line">        pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¸…ç©º å·¥ä½œçº¿ç¨‹ è°ƒç”¨çš„å›è°ƒå‡½æ•° çš„å‚æ•°arg */</span></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;task_queue[pool-&gt;queue_rear].arg != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        pool-&gt;task_queue[pool-&gt;queue_rear].arg = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ·»åŠ ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—é‡Œ */</span></span><br><span class="line">    pool-&gt;task_queue[pool-&gt;queue_rear].function = function;</span><br><span class="line">    pool-&gt;task_queue[pool-&gt;queue_rear].arg = arg;</span><br><span class="line">    pool-&gt;queue_rear = (pool-&gt;queue_rear + <span class="number">1</span>) % pool-&gt;queue_max_size;       <span class="comment">/* é˜Ÿå°¾æŒ‡é’ˆç§»åŠ¨, æ¨¡æ‹Ÿç¯å½¢ */</span></span><br><span class="line">    pool-&gt;queue_size++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ·»åŠ å®Œä»»åŠ¡åï¼Œé˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œå”¤é†’çº¿ç¨‹æ± ä¸­ ç­‰å¾…å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹ */</span></span><br><span class="line">    pthread_cond_signal(&amp;(pool-&gt;queue_not_empty));</span><br><span class="line">    pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* çº¿ç¨‹æ± ä¸­å„ä¸ªå·¥ä½œçº¿ç¨‹ */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">threadpool_thread</span><span class="params">(<span class="type">void</span> *threadpool)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">threadpool_t</span> *pool = (<span class="type">threadpool_t</span> *)threadpool;</span><br><span class="line">    <span class="type">threadpool_task_t</span> task;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">/* åˆšåˆ›å»ºå‡ºçº¿ç¨‹ï¼Œç­‰å¾…ä»»åŠ¡é˜Ÿåˆ—é‡Œæœ‰ä»»åŠ¡ï¼Œå¦åˆ™é˜»å¡ç­‰å¾…ä»»åŠ¡é˜Ÿåˆ—é‡Œæœ‰ä»»åŠ¡åå†å”¤é†’æ¥æ”¶ä»»åŠ¡ */</span></span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* queue_size == 0 è¯´æ˜æ²¡æœ‰ä»»åŠ¡ï¼Œè°ƒ wait é˜»å¡åœ¨æ¡ä»¶å˜é‡ä¸Š, è‹¥æœ‰ä»»åŠ¡ï¼Œè·³è¿‡è¯¥while */</span></span><br><span class="line">        <span class="keyword">while</span> ((pool-&gt;queue_size == <span class="number">0</span>) &amp;&amp; (!pool-&gt;shutdown)) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is waiting\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)pthread_self());</span><br><span class="line">            pthread_cond_wait(&amp;(pool-&gt;queue_not_empty), &amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* æ¸…é™¤æŒ‡å®šæ•°ç›®çš„ç©ºé—²çº¿ç¨‹ï¼Œå¦‚æœè¦ç»“æŸçš„çº¿ç¨‹ä¸ªæ•°å¤§å°0ï¼Œç»“æŸçº¿ç¨‹ */</span></span><br><span class="line">            <span class="keyword">if</span> (pool-&gt;wait_exit_thr_num &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                pool-&gt;wait_exit_thr_num--;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* å¦‚æœçº¿ç¨‹æ± ä¸­çº¿ç¨‹ä¸ªæ•°å¤§äºæœ€å°å€¼æ—¶ï¼Œå¯ä»¥ç»“æŸçº¿ç¨‹ */</span></span><br><span class="line">                <span class="keyword">if</span> (pool-&gt;live_thr_num &gt; pool-&gt;min_thr_num) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is exiting\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)pthread_self());</span><br><span class="line">                    pool-&gt;live_thr_num--;</span><br><span class="line">                    pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line">                    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å¦‚æœæŒ‡å®šäº†trueï¼Œè¦å…³é—­çº¿ç¨‹æ± é‡Œçš„æ¯ä¸ªçº¿ç¨‹ï¼Œè‡ªè¡Œé€€å‡ºå¤„ç†---é”€æ¯çº¿ç¨‹æ±  */</span></span><br><span class="line">        <span class="keyword">if</span> (pool-&gt;shutdown) &#123;</span><br><span class="line">            pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x is exiting\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)pthread_self());</span><br><span class="line">            pthread_detach(pthread_self());</span><br><span class="line">            pthread_exit(<span class="literal">NULL</span>);     <span class="comment">/* çº¿ç¨‹è‡ªè¡Œç»“æŸ */</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ä»ä»»åŠ¡é˜Ÿåˆ—é‡Œè·å–ä»»åŠ¡, æ˜¯ä¸€ä¸ªå‡ºé˜Ÿæ“ä½œ */</span></span><br><span class="line">        task.function = pool-&gt;task_queue[pool-&gt;queue_front].function;</span><br><span class="line">        task.arg = pool-&gt;task_queue[pool-&gt;queue_front].arg;</span><br><span class="line"></span><br><span class="line">        pool-&gt;queue_front = (pool-&gt;queue_front + <span class="number">1</span>) % pool-&gt;queue_max_size;       <span class="comment">/* å‡ºé˜Ÿï¼Œæ¨¡æ‹Ÿç¯å½¢é˜Ÿåˆ— */</span></span><br><span class="line">        pool-&gt;queue_size--;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ä»»åŠ¡å–å‡ºåï¼Œç«‹å³å°† çº¿ç¨‹æ± ç é‡Šæ”¾ */</span></span><br><span class="line">        pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* é€šçŸ¥å¯ä»¥æœ‰æ–°çš„ä»»åŠ¡æ·»åŠ è¿›æ¥ */</span></span><br><span class="line">        pthread_cond_broadcast(&amp;(pool-&gt;queue_not_full));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* æ‰§è¡Œä»»åŠ¡ */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x start working\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)pthread_self());</span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;thread_counter));                            <span class="comment">/* å¿™çŠ¶æ€çº¿ç¨‹æ•°å˜é‡ç */</span></span><br><span class="line">        pool-&gt;busy_thr_num++;                                                   <span class="comment">/* å¿™çŠ¶æ€çº¿ç¨‹æ•°+1 */</span></span><br><span class="line">        pthread_mutex_unlock(&amp;(pool-&gt;thread_counter));</span><br><span class="line"></span><br><span class="line">        (*(task.function))(task.arg);                                           <span class="comment">/* æ‰§è¡Œå›è°ƒå‡½æ•°ä»»åŠ¡ */</span></span><br><span class="line">        <span class="comment">//task.function(task.arg);                                              /* æ‰§è¡Œå›è°ƒå‡½æ•°ä»»åŠ¡ */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* ä»»åŠ¡ç»“æŸå¤„ç† */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread 0x%x end working\n&quot;</span>, (<span class="type">unsigned</span> <span class="type">int</span>)pthread_self());</span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;thread_counter));</span><br><span class="line">        pool-&gt;busy_thr_num--;                                       <span class="comment">/* å¤„ç†æ‰ä¸€ä¸ªä»»åŠ¡ï¼Œå¿™çŠ¶æ€æ•°çº¿ç¨‹æ•°-1 */</span></span><br><span class="line">        pthread_mutex_unlock(&amp;(pool-&gt;thread_counter));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç®¡ç†çº¿ç¨‹ */</span></span><br><span class="line"><span class="type">void</span> *<span class="title function_">adjust_thread</span><span class="params">(<span class="type">void</span> *threadpool)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">threadpool_t</span> *pool = (<span class="type">threadpool_t</span> *)threadpool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(!pool-&gt;shutdown) &#123;</span><br><span class="line">        sleep(DEFAULT_TIME);                        <span class="comment">/* å®šæ—¶ å¯¹çº¿ç¨‹æ± ç®¡ç† */</span></span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line">        <span class="type">int</span> queue_size = pool-&gt;queue_size;          <span class="comment">/* å…³æ³¨ ä»»åŠ¡æ•° */</span></span><br><span class="line">        <span class="type">int</span> live_thr_num = pool-&gt;live_thr_num;      <span class="comment">/* å­˜æ´» çº¿ç¨‹æ•° */</span></span><br><span class="line">        pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;thread_counter));</span><br><span class="line">        <span class="type">int</span> busy_thr_num = pool-&gt;busy_thr_num;      <span class="comment">/* å¿™ç€çš„çº¿ç¨‹æ•° */</span></span><br><span class="line">        pthread_mutex_unlock(&amp;(pool-&gt;thread_counter));</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* åˆ›å»ºæ–°çº¿ç¨‹ ç®—æ³•ï¼š ä»»åŠ¡æ•°å¤§äºæœ€å°çº¿ç¨‹æ± ä¸ªæ•°, ä¸”å­˜æ´»çš„çº¿ç¨‹æ•°å°‘äºæœ€å¤§çº¿ç¨‹ä¸ªæ•°æ—¶ å¦‚ï¼š30&gt;=10 &amp;&amp; 40&lt;100*/</span></span><br><span class="line">        <span class="keyword">if</span> (queue_size &gt;= MIN_WAIT_TASK_NUM &amp;&amp; live_thr_num &lt; pool-&gt;max_thr_num) &#123;</span><br><span class="line">            pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line">            <span class="type">int</span> add = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*ä¸€æ¬¡å¢åŠ  DEFAULT_THREAD ä¸ªçº¿ç¨‹*/</span></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pool-&gt;max_thr_num &amp;&amp; add &lt; DEFAULT_THREAD_VARY</span><br><span class="line">                    &amp;&amp; pool-&gt;live_thr_num &lt; pool-&gt;max_thr_num; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pool-&gt;threads[i] == <span class="number">0</span> || !is_thread_alive(pool-&gt;threads[i])) &#123;</span><br><span class="line">                    pthread_create(&amp;(pool-&gt;threads[i]), <span class="literal">NULL</span>, threadpool_thread, (<span class="type">void</span> *)pool);</span><br><span class="line">                    add++;</span><br><span class="line">                    pool-&gt;live_thr_num++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* é”€æ¯å¤šä½™çš„ç©ºé—²çº¿ç¨‹ ç®—æ³•ï¼šå¿™çº¿ç¨‹X2 å°äº å­˜æ´»çš„çº¿ç¨‹æ•° ä¸” å­˜æ´»çš„çº¿ç¨‹æ•° å¤§äº æœ€å°çº¿ç¨‹æ•°æ—¶*/</span></span><br><span class="line">        <span class="keyword">if</span> ((busy_thr_num * <span class="number">2</span>) &lt; live_thr_num  &amp;&amp;  live_thr_num &gt; pool-&gt;min_thr_num) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* ä¸€æ¬¡é”€æ¯DEFAULT_THREADä¸ªçº¿ç¨‹, éš¨æ©Ÿ10å€‹å³å¯ */</span></span><br><span class="line">            pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line">            pool-&gt;wait_exit_thr_num = DEFAULT_THREAD_VARY;      <span class="comment">/* è¦é”€æ¯çš„çº¿ç¨‹æ•° è®¾ç½®ä¸º10 */</span></span><br><span class="line">            pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; DEFAULT_THREAD_VARY; i++) &#123;</span><br><span class="line">                <span class="comment">/* é€šçŸ¥å¤„åœ¨ç©ºé—²çŠ¶æ€çš„çº¿ç¨‹, ä»–ä»¬ä¼šè‡ªè¡Œç»ˆæ­¢*/</span></span><br><span class="line">                pthread_cond_signal(&amp;(pool-&gt;queue_not_empty));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">threadpool_destroy</span><span class="params">(<span class="type">threadpool_t</span> *pool)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pool-&gt;shutdown = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*å…ˆé”€æ¯ç®¡ç†çº¿ç¨‹*/</span></span><br><span class="line">    pthread_join(pool-&gt;adjust_tid, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pool-&gt;live_thr_num; i++) &#123;</span><br><span class="line">        <span class="comment">/*é€šçŸ¥æ‰€æœ‰çš„ç©ºé—²çº¿ç¨‹*/</span></span><br><span class="line">        pthread_cond_broadcast(&amp;(pool-&gt;queue_not_empty));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; pool-&gt;live_thr_num; i++) &#123;</span><br><span class="line">        pthread_join(pool-&gt;threads[i], <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    threadpool_free(pool);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">threadpool_free</span><span class="params">(<span class="type">threadpool_t</span> *pool)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (pool == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;task_queue) &#123;</span><br><span class="line">        <span class="built_in">free</span>(pool-&gt;task_queue);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;threads) &#123;</span><br><span class="line">        <span class="built_in">free</span>(pool-&gt;threads);</span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line">        pthread_mutex_destroy(&amp;(pool-&gt;lock));</span><br><span class="line">        pthread_mutex_lock(&amp;(pool-&gt;thread_counter));</span><br><span class="line">        pthread_mutex_destroy(&amp;(pool-&gt;thread_counter));</span><br><span class="line">        pthread_cond_destroy(&amp;(pool-&gt;queue_not_empty));</span><br><span class="line">        pthread_cond_destroy(&amp;(pool-&gt;queue_not_full));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(pool);</span><br><span class="line">    pool = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">threadpool_all_threadnum</span><span class="params">(<span class="type">threadpool_t</span> *pool)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> all_threadnum = <span class="number">-1</span>;                 <span class="comment">// æ€»çº¿ç¨‹æ•°</span></span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;(pool-&gt;lock));</span><br><span class="line">    all_threadnum = pool-&gt;live_thr_num;     <span class="comment">// å­˜æ´»çº¿ç¨‹æ•°</span></span><br><span class="line">    pthread_mutex_unlock(&amp;(pool-&gt;lock));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_threadnum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">threadpool_busy_threadnum</span><span class="params">(<span class="type">threadpool_t</span> *pool)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> busy_threadnum = <span class="number">-1</span>;                <span class="comment">// å¿™çº¿ç¨‹æ•°</span></span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;(pool-&gt;thread_counter));</span><br><span class="line">    busy_threadnum = pool-&gt;busy_thr_num;</span><br><span class="line">    pthread_mutex_unlock(&amp;(pool-&gt;thread_counter));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> busy_threadnum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">is_thread_alive</span><span class="params">(<span class="type">pthread_t</span> tid)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> kill_rc = pthread_kill(tid, <span class="number">0</span>);     <span class="comment">//å‘0å·ä¿¡å·ï¼Œæµ‹è¯•çº¿ç¨‹æ˜¯å¦å­˜æ´»</span></span><br><span class="line">    <span class="keyword">if</span> (kill_rc == ESRCH) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://www.bilibili.com/video/BV1iJ411S7UA?p=91">çº¿ç¨‹æ± åŸç†åˆ†æ</a></li><li><a href="https://github.com/progschj/ThreadPool">A simple C++11 Thread Pool implementation</a></li><li><a href="https://github.com/search?q=threadpool">github threadpool</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> çº¿ç¨‹ </tag>
            
            <tag> çº¿ç¨‹æ±  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>OpenVSwitch-ç¼–è¯‘åŠå¯åŠ¨</title>
      <link href="/2022/05/12/OpenVSwitch-%E7%BC%96%E8%AF%91%E5%8F%8A%E5%90%AF%E5%8A%A8/"/>
      <url>/2022/05/12/OpenVSwitch-%E7%BC%96%E8%AF%91%E5%8F%8A%E5%90%AF%E5%8A%A8/</url>
      
        <content type="html"><![CDATA[<h2 id="åŸºäºå†…æ ¸çš„OVS"><a href="#åŸºäºå†…æ ¸çš„OVS" class="headerlink" title="åŸºäºå†…æ ¸çš„OVS"></a>åŸºäºå†…æ ¸çš„OVS</h2><p>é¦–å…ˆéªŒè¯å†…æ ¸ç‰ˆæœ¬<code>uname -r</code>ä¸ä½ ä¸‹è½½çš„OVSç‰ˆæœ¬æ˜¯å¦åŒ¹é…ï¼ˆå¿…é¡»ï¼‰ï¼Œç›®å‰ ovs-2.16 æœ€é«˜åªæ”¯æŒå†…æ ¸5.8ï¼</p><p><a href="https://docs.openvswitch.org/en/latest/faq/releases/">linuxå†…æ ¸ä¸ovsç‰ˆæœ¬åŒ¹é…å…³ç³»ã€ovsç‰ˆæœ¬ä¸DPDKç‰ˆæœ¬åŒ¹é…å…³ç³»</a></p><p>ä»¥ <code>OVS-2.16.0</code> ä¸ºä¾‹ï¼Œç¼–è¯‘è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–æºç </span></span><br><span class="line">wget https://github.com/openvswitch/ovs/archive/refs/tags/v2.16.0.zip &amp;&amp; unzip v2.16.0.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–åŒ…</span></span><br><span class="line">sudo apt install build-essential fakeroot</span><br><span class="line">dpkg-checkbuilddeps <span class="comment"># æ£€æŸ¥ä¾èµ–å¹¶æ‰‹åŠ¨å®‰è£…ç¼ºå°‘çš„æ¨¡å—</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ovs-2.16.0</span><br><span class="line">./boot.sh</span><br><span class="line">./configure --with-linux=/lib/modules/$(<span class="built_in">uname</span> -r)/build</span><br><span class="line">make -j     <span class="comment"># -j é»˜è®¤è®©æ‰€æœ‰æ ¸åŒæ—¶è¿›è¡Œç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šç¼–è¯‘æ ¸æ•°</span></span><br><span class="line"></span><br><span class="line">sudo make install   <span class="comment"># å®‰è£…ovs</span></span><br><span class="line">sudo insmod datapath/linux/openvswitch.ko <span class="comment"># å®‰è£…å†…æ ¸æ¨¡å—ï¼ŒæŠ¥é”™å¤„ç†è§ä¸‹æ–‡</span></span><br><span class="line">sudo make modules_install</span><br><span class="line">sudo modprobe openvswitch</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥é”™å¤„ç†ï¼Œä¸€èˆ¬æ˜¯ç¼ºå¤±ä¾èµ–æ¨¡å—ï¼Œé€šè¿‡modprobeå®‰è£…å°±å¥½</span></span><br><span class="line">modinfo ./datapath/linux/openvswitch.ko | grep depends <span class="comment"># æŸ¥çœ‹ç¼ºå°‘ä¾èµ–æ¨¡å—</span></span><br><span class="line">sudo modprobe nf_conntrack</span><br><span class="line">sudo modprobe nf_nat</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å·¥å…· ovs-ctl</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:/usr/local/share/openvswitch/scripts&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc \</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export DB_SOCK=/usr/local/var/run/openvswitch/db.sock&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc</span><br></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/u010710985/article/details/119980125">å®‰è£…å†…æ ¸æ¨¡å—æ—¶æŠ¥é”™çš„è§£å†³åŠæ³•</a></p><h2 id="åŸºäºDPDKçš„OVS"><a href="#åŸºäºDPDKçš„OVS" class="headerlink" title="åŸºäºDPDKçš„OVS"></a>åŸºäºDPDKçš„OVS</h2><p><strong>ä¸‹é¢çš„DPDKç¼–è¯‘æ–¹å¼éƒ½æ˜¯åŸºäºmesonï¼Œä»DPDK 19ç‰ˆæœ¬å¼€å§‹æ‰èƒ½ä½¿ç”¨mesonè¿›è¡Œç¼–è¯‘ï¼</strong></p><p>åŒæ ·æ³¨æ„OVSçš„ç‰ˆæœ¬ä¸DPDKç‰ˆæœ¬æ˜¯å¦åŒ¹é…ï¼Œovs-2.16 é€‚é…äº†DPDK-20.11.5ï¼ŒDPDKçš„ç‰ˆæœ¬<code>20.11.n</code>ä¸€å®šè¦é€‰æœ€æ–°ç‰ˆï¼Œè¿™ç§æ›´æ–°ä¸€èˆ¬æ˜¯ä¿®å¤äº†ä¸€äº› bugã€‚</p><h3 id="ç¼–è¯‘å®‰è£…DPDK"><a href="#ç¼–è¯‘å®‰è£…DPDK" class="headerlink" title="ç¼–è¯‘å®‰è£…DPDK"></a>ç¼–è¯‘å®‰è£…DPDK</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–æºç </span></span><br><span class="line">wget https://fast.dpdk.org/rel/dpdk-20.11.5.tar.xz</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘å·¥å…· meson ninjaï¼Œä»v19å¼€å§‹ä½¿ç”¨mesonè¿›è¡ŒDPDKçš„ç¼–è¯‘ï¼</span></span><br><span class="line">sudo pip3 install meson ninja</span><br><span class="line">sudo apt install libnuma-dev libpcap-dev libfdt-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> dpdk-stable-20.11.3</span><br><span class="line"><span class="comment"># ç¼–è¯‘ ä½¿ç”¨`| tee file`æ˜¯å°†æ—¥å¿—æ˜¾ç¤ºåœ¨ç»ˆç«¯çš„åŒæ—¶ï¼Œä¿å­˜åˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">meson build | <span class="built_in">tee</span> ../meson.build</span><br><span class="line">ninja -C build</span><br><span class="line"><span class="comment"># å®‰è£…åº“ å°†DPDKçš„ç›¸å…³åº“æ–‡ä»¶å¤åˆ¶åˆ°æ ¹ç›®å½•ä¸‹çš„ç›¸å…³å¼•ç”¨ç›®å½•</span></span><br><span class="line">sudo ninja -C build install</span><br><span class="line"><span class="comment"># æ›´æ–°ç¼“å­˜ (usually run when a new library is installed)</span></span><br><span class="line">sudo ldconfig</span><br><span class="line"><span class="comment"># æµ‹è¯•ä¸€ä¸‹ libdpdk æ˜¯å¦å®‰è£…æˆåŠŸ</span></span><br><span class="line">pkg-config --modversion libdpdk</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸è½½ dpdk</span></span><br><span class="line">sudo ninja uninstall</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘å®‰è£…-OVS-DPDK"><a href="#ç¼–è¯‘å®‰è£…-OVS-DPDK" class="headerlink" title="ç¼–è¯‘å®‰è£… OVS-DPDK"></a>ç¼–è¯‘å®‰è£… OVS-DPDK</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># get ovs v2.16.0</span></span><br><span class="line">wget https://github.com/openvswitch/ovs/archive/refs/tags/v2.16.0.zip</span><br><span class="line"><span class="comment"># å®‰è£…ä¾èµ–åŒ…</span></span><br><span class="line">sudo apt install build-essential fakeroot</span><br><span class="line">dpkg-checkbuilddeps <span class="comment"># æ£€æŸ¥ä¾èµ–å¹¶æ‰‹åŠ¨å®‰è£…ç¼ºå°‘çš„æ¨¡å—</span></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> ovs-2.16.0</span><br><span class="line">./boot.sh</span><br><span class="line">./configure --with-dpdk=static CFLAGS=<span class="string">&quot;-Ofast -msse4.2 -mpopcnt&quot;</span></span><br><span class="line">make -j     <span class="comment"># å¤šçº¿ç¨‹ç¼–è¯‘</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å•å…ƒæµ‹è¯•ï¼ˆå¯ä»¥è·³è¿‡ï¼‰</span></span><br><span class="line">make check TESTSUITEFLAGS=-j8</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… ovs</span></span><br><span class="line">sudo make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨å·¥å…· ovs-ctl</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:/usr/local/share/openvswitch/scripts&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export DB_SOCK=/usr/local/var/run/openvswitch/db.sock&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ˜¯å¦å¯ç”¨äº† dpdk</span></span><br><span class="line">ovs-vswitchd --version</span><br><span class="line"><span class="comment"># ovs-vswitchd (Open vSwitch) 2.16.0</span></span><br><span class="line"><span class="comment"># DPDK 20.11.5</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ<code>make -j</code>ç¼–è¯‘æ—¶ï¼Œå‡ºç°é”™è¯¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/OpenSSL/__init__.py&quot;</span>, line 8, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    from OpenSSL import crypto, SSL</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3/dist-packages/OpenSSL/crypto.py&quot;</span>, line 3279, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    _lib.OpenSSL_add_all_algorithms()</span><br><span class="line">AttributeError: module <span class="string">&#x27;lib&#x27;</span> has no attribute <span class="string">&#x27;OpenSSL_add_all_algorithms&#x27;</span></span><br><span class="line">make: *** [Makefile:6819: lib/vswitch-idl.ovsidl] Error 1</span><br></pre></td></tr></table></figure><p>æ ¹æ®<a href="https://levelup.gitconnected.com/fix-attributeerror-module-lib-has-no-attribute-openssl-521a35d83769">è¿™ç¯‡æ–‡ç« </a>çš„è§£å†³åŠæ³•ï¼š</p><p>Upgrading <code>pip</code> to the latest version will probably fix the issue for you.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --upgrade pip</span><br></pre></td></tr></table></figure><p>If this doesnâ€™t seem to be enough, you will then have to upgrade <code>pyOpenSSL</code>. You need to make sure that the install <code>pyopenssl</code> version is greater than <code>v22.1.0</code> therefore,</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install --upgrade openssl</span><br><span class="line"></span><br><span class="line"><span class="comment"># alternatively</span></span><br><span class="line">python3 -m pip install openssl&gt;22.1.0</span><br></pre></td></tr></table></figure><p>If for any reason you canâ€™t upgrade openssl (due to conflicts with other dependencies you have) the last resort (which I wouldnâ€™t recommend otherwise), is to downgrade <code>cryptography</code> module to an older version:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m pip install cryptography==38.0.4</span><br></pre></td></tr></table></figure><h2 id="ç”ŸæˆDockeré•œåƒ"><a href="#ç”ŸæˆDockeré•œåƒ" class="headerlink" title="ç”ŸæˆDockeré•œåƒ"></a>ç”ŸæˆDockeré•œåƒ</h2><p><strong>å‰æï¼šä¸»æœºä¸Šå…ˆå®‰è£…å¥½OVSï¼</strong></p><p>æ³¨æ„ï¼š<strong>dockerä¸å®¿ä¸»æœºæ˜¯å…±äº«å†…æ ¸çš„ï¼</strong>ï¼Œå³ä½¿æ˜¯åœ¨ docker ä¸­ä½¿ç”¨ OVSï¼Œæ— è®ºæ˜¯åŸºäºå†…æ ¸çš„è¿˜æ˜¯åŸºäº DPDK çš„ï¼Œéƒ½ä¼šç”¨åˆ°å†…æ ¸æ¨¡å—<code>openvswitch</code>ï¼Œåªæœ‰åœ¨ä¸»æœºä¸Šå®‰è£… OVS åæ‰å¸¦æœ‰è¿™ä¸ªæ¨¡å—ï¼Œå¹¶ä¸”æ¯æ¬¡å…³æœºã€é‡å¯åï¼Œéƒ½éœ€è¦é‡æ–°åŠ è½½<code>modprobe</code>è¯¥æ¨¡å—ï¼Œå¦åˆ™åœ¨dockerä¸­å¯åŠ¨ OVS æ—¶ä¼šæŠ¥ä¸‹é¢çš„é”™è¯¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@72a4b64ba608:~<span class="comment"># ovs-ctl start</span></span><br><span class="line"> * /usr/local/etc/openvswitch/conf.db does not exist</span><br><span class="line"> * Creating empty database /usr/local/etc/openvswitch/conf.db</span><br><span class="line"><span class="built_in">nice</span>: cannot <span class="built_in">set</span> niceness: Permission denied</span><br><span class="line"> * Starting ovsdb-server</span><br><span class="line"> * system ID not configured, please use --system-id</span><br><span class="line"> * Configuring Open vSwitch system IDs</span><br><span class="line">/usr/local/share/openvswitch/scripts/ovs-kmod-ctl: 112: modprobe: not found <span class="comment">############# !!!! ################</span></span><br><span class="line"> * Inserting openvswitch module</span><br><span class="line">/usr/local/share/openvswitch/scripts/ovs-kmod-ctl: 112: rmmod: not found</span><br><span class="line"> * removing bridge module</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°åŸå› æ˜¯ï¼Œå¯åŠ¨ OVS æ—¶è¦åˆ¤æ–­å†…æ ¸ä¸­æ˜¯å¦æœ‰ openvswitch æ¨¡å—ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±éœ€è¦åŠ è½½ï¼ˆé€šè¿‡å‘½ä»¤ modprobeï¼‰ï¼Œä½† docker ä¸­å¹¶æ²¡æœ‰ modprobe å‘½ä»¤ï¼Œå› æ­¤æŠ¥é”™ï¼Œè§£å†³åŠæ³•å°±æ˜¯åœ¨ä¸»æœºä¸Šå…ˆåŠ è½½è¯¥æ¨¡å—åˆ°å†…æ ¸ï¼ˆå‰ææ˜¯ä¸»æœºä¸Šå®‰è£…è¿‡OVSï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo modprobe openvswitch</span><br></pre></td></tr></table></figure><h3 id="åŸºäºå†…æ ¸çš„-Dockerfile"><a href="#åŸºäºå†…æ ¸çš„-Dockerfile" class="headerlink" title="åŸºäºå†…æ ¸çš„ Dockerfile"></a>åŸºäºå†…æ ¸çš„ Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span> as build</span><br><span class="line"><span class="keyword">ARG</span> ovs_version=<span class="number">2.16</span>.<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential fakeroot cmake wget unzip \</span></span><br><span class="line"><span class="language-bash">  graphviz autoconf automake debhelper dh-autoreconf libssl-dev libtool python3-all python3-sphinx \</span></span><br><span class="line"><span class="language-bash">  python3-twisted python3-zope.interface libunbound-dev libunwind-dev</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ç¼–è¯‘ OVS</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget https://codeload.github.com/openvswitch/ovs/zip/refs/tags/v<span class="variable">$&#123;ovs_version&#125;</span> -O ovs-<span class="variable">$&#123;ovs_version&#125;</span>.zip \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; unzip ovs-<span class="variable">$&#123;ovs_version&#125;</span>.zip</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> ovs-<span class="variable">$&#123;ovs_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ./boot.sh \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ./configure --with-linux=/lib/modules/$(<span class="built_in">uname</span> -r)/build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -j \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /usr/local /usr/local/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; apt-get -y --no-install-recommends install python3-all iproute2 net-tools \</span></span><br><span class="line"><span class="language-bash">     vim iperf iftop tcpdump \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; ldconfig \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:/usr/local/share/openvswitch/scripts&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;export DB_SOCK=/usr/local/var/run/openvswitch/db.sock&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc</span></span><br></pre></td></tr></table></figure><h3 id="åŸºäº-DPDK-çš„-Dockerfile"><a href="#åŸºäº-DPDK-çš„-Dockerfile" class="headerlink" title="åŸºäº DPDK çš„ Dockerfile"></a>åŸºäº DPDK çš„ Dockerfile</h3><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span> as build</span><br><span class="line"><span class="keyword">ARG</span> dpdk_version=<span class="number">20.11</span>.<span class="number">5</span></span><br><span class="line"><span class="keyword">ARG</span> ovs_version=<span class="number">2.16</span>.<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential python3-pip liblua5.3-dev \</span></span><br><span class="line"><span class="language-bash">    cmake wget unzip libnuma-dev pciutils libpcap-dev libelf-dev linux-headers-generic \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; pip3 install meson ninja pyelftools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ç¼–è¯‘ DPDK</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget -q https://fast.dpdk.org/rel/dpdk-<span class="variable">$&#123;dpdk_version&#125;</span>.tar.xz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar xf dpdk-<span class="variable">$&#123;dpdk_version&#125;</span>.tar.xz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> dpdk-stable-<span class="variable">$&#123;dpdk_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; meson build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ninja -C build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ninja -C build install \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> -r build/lib /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ç¼–è¯‘ OVS</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget https://codeload.github.com/openvswitch/ovs/zip/refs/tags/v<span class="variable">$&#123;ovs_version&#125;</span> -O ovs-<span class="variable">$&#123;ovs_version&#125;</span>.zip \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; unzip ovs-<span class="variable">$&#123;ovs_version&#125;</span>.zip</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> ovs-<span class="variable">$&#123;ovs_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ./boot.sh \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ./configure --with-dpdk=static CFLAGS=<span class="string">&quot;-Ofast -msse4.2 -mpopcnt&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -j \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ç›¸å…³æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /usr/local /usr/local/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get -y --no-install-recommends install liblua5.3 libnuma-dev pciutils \</span></span><br><span class="line"><span class="language-bash">    libpcap-dev python3 iproute2 net-tools iputils-ping vim iperf iftop tcpdump \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ldconfig \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:/usr/local/share/openvswitch/scripts&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;export DB_SOCK=/usr/local/var/run/openvswitch/db.sock&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc</span></span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰-OVS-DPDK-çš„-Dockerfile"><a href="#è‡ªå®šä¹‰-OVS-DPDK-çš„-Dockerfile" class="headerlink" title="è‡ªå®šä¹‰ OVS-DPDK çš„ Dockerfile"></a>è‡ªå®šä¹‰ OVS-DPDK çš„ Dockerfile</h3><p>å¦‚æœå¯¹OVSï¼ŒDPDKæœ‰ä»»ä½•ä¿®æ”¹ï¼Œéœ€è¦å°†æºä»£ç æ‹·è´åˆ°å®¹å™¨ä¸­è¿›è¡Œç¼–è¯‘ï¼Œå‡†å¤‡ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶å‡†å¤‡ä»¥ä¸‹æ–‡ä»¶ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Dockerfile</span><br><span class="line">dpdk-stable-20.11.5 <span class="comment"># DPDKçš„æºç </span></span><br><span class="line">ovs-2.16.0          <span class="comment"># OVSçš„æºç </span></span><br><span class="line">bin                 <span class="comment"># å…¶ä»–ä¸€äº›å¯æ‰§è¡Œæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p><code>Dockerfile</code> æ–‡ä»¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š</p><p><em>ä¸ºäº†é¿å…é‡å¤ç¼–è¯‘ï¼Œä¸è¦ä½¿ç”¨<code>COPY . .</code>ï¼Œå¹¶ä¸”COPYæ–‡ä»¶åº”è¯¥åˆ†åˆ«è¿è¡Œ</em></p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span> as build</span><br><span class="line"><span class="keyword">ARG</span> dpdk_version=<span class="number">20.11</span>.<span class="number">5</span></span><br><span class="line"><span class="keyword">ARG</span> ovs_version=<span class="number">2.16</span>.<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential python3-pip liblua5.3-dev \</span></span><br><span class="line"><span class="language-bash">    cmake wget libnuma-dev pciutils libpcap-dev libelf-dev linux-headers-generic \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; pip3 install meson ninja pyelftools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†æœ¬åœ°æ–‡ä»¶å¤åˆ¶åˆ°dockerä¸­</span></span><br><span class="line"><span class="comment"># ç¼–è¯‘ DPDKï¼ŒCOPY æ–‡ä»¶å¤¹æ—¶å¿…é¡»æŒ‡å®šç›®çš„æ–‡ä»¶å¤¹åï¼</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> dpdk-stable-<span class="variable">$&#123;dpdk_version&#125;</span> dpdk-stable-<span class="variable">$&#123;dpdk_version&#125;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> dpdk-stable-<span class="variable">$&#123;dpdk_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; meson build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ninja -C build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ninja -C build install \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> -r build/lib /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ OVS</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ovs-<span class="variable">$&#123;ovs_version&#125;</span> ovs-<span class="variable">$&#123;ovs_version&#125;</span></span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> ovs-<span class="variable">$&#123;ovs_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; sh boot.sh \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ./configure --with-dpdk=static CFLAGS=<span class="string">&quot;-Ofast -msse4.2 -mpopcnt&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make -j \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶ç¼–è¯‘åçš„æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /usr/local /usr/local/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get -y --no-install-recommends install liblua5.3 libnuma-dev pciutils \</span></span><br><span class="line"><span class="language-bash">    libpcap-dev python3 iproute2 net-tools iputils-ping vim iperf iftop tcpdump \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ldconfig \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;export PATH=$PATH:/usr/local/share/openvswitch/scripts&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">echo</span> <span class="string">&#x27;export DB_SOCK=/usr/local/var/run/openvswitch/db.sock&#x27;</span> | <span class="built_in">tee</span> -a /root/.bashrc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶å…¶ä»–å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> bin/* /usr/bin/</span></span><br></pre></td></tr></table></figure><p>è‹¥ä½¿ç”¨ <code>apt-get update</code> æ—¶æ¯”è¾ƒæ…¢ï¼Œå¯ä»¥åœ¨ä¸Šæ–¹æ›´æ¢é˜¿é‡Œäº‘æºã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get clean</span></span><br></pre></td></tr></table></figure><h3 id="Pktgen-å’Œ-testpmd-çš„-Dockerfile"><a href="#Pktgen-å’Œ-testpmd-çš„-Dockerfile" class="headerlink" title="Pktgen å’Œ testpmd çš„ Dockerfile"></a>Pktgen å’Œ testpmd çš„ Dockerfile</h3><p><code>pktgen</code> ç”¨æ¥ç”Ÿæˆã€å‘é€æ•°æ®åŒ…ï¼Œ<code>testpmd</code> ç”¨æ¥æ¥æ”¶æ•°æ®åŒ…ï¼Œä¸¤è€…éƒ½æ˜¯é’ˆå¯¹DPDKçš„ã€‚</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span> as build</span><br><span class="line"><span class="comment"># æŒ‡å®šä½¿ç”¨çš„DPDK, pktgen ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">ARG</span> dpdk_version=<span class="number">20.11</span>.<span class="number">5</span></span><br><span class="line"><span class="keyword">ARG</span> pktgen_version=<span class="number">20.11</span>.<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get -y install build-essential python3-pip liblua5.3-dev \</span></span><br><span class="line"><span class="language-bash">    cmake wget libnuma-dev pciutils libpcap-dev libelf-dev linux-headers-generic \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; pip3 install meson ninja pyelftools</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /opt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ç¼–è¯‘ DPDK</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget -q https://fast.dpdk.org/rel/dpdk-<span class="variable">$&#123;dpdk_version&#125;</span>.tar.xz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar xf dpdk-<span class="variable">$&#123;dpdk_version&#125;</span>.tar.xz</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> dpdk-stable-<span class="variable">$&#123;dpdk_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; meson build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ninja -C build \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ninja -C build install \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> -r build/lib /usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># patch to make pktgen compile on arm. Got tip from</span></span><br><span class="line"><span class="comment"># https://medium.com/codex/nvidia-mellanox-bluefield-2-smartnic-dpdk-rig-for-dive-part-ii-change-mode-of-operation-a994f0f0e543</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/#  error Platform.*//&#x27;</span> /usr/local/include/rte_spinlock.h</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i <span class="string">&#x27;s/#  error Platform.*//&#x27;</span> /usr/local/include/rte_atomic_32.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># downlaod and unpack pktgen</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> wget -q https://git.dpdk.org/apps/pktgen-dpdk/snapshot/pktgen-dpdk-pktgen-<span class="variable">$&#123;pktgen_version&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tar xf pktgen-dpdk-pktgen-<span class="variable">$&#123;pktgen_version&#125;</span>.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># building pktgen</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> pktgen-dpdk-pktgen-<span class="variable">$&#123;pktgen_version&#125;</span> \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tools/pktgen-build.sh clean \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; tools/pktgen-build.sh buildlua \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> -r usr/local /usr/ \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">mkdir</span> -p /usr/local/share/lua/5.3/ \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; <span class="built_in">cp</span> Pktgen.lua /usr/local/share/lua/5.3/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################</span></span><br><span class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">20.04</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /usr/local /usr/local/</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /root</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; apt-get -y --no-install-recommends install liblua5.3 libnuma-dev pciutils libpcap-dev python3 iproute2 \</span></span><br><span class="line"><span class="language-bash">    &amp;&amp; ldconfig</span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆé•œåƒï¼š<code>docker build -t pktgen:20.11.3 .</code></p><h2 id="OVS-å¯åŠ¨åŠé…ç½®"><a href="#OVS-å¯åŠ¨åŠé…ç½®" class="headerlink" title="OVS å¯åŠ¨åŠé…ç½®"></a>OVS å¯åŠ¨åŠé…ç½®</h2><p>åŸºäºå†…æ ¸çš„æ•°æ®é€šè·¯æ—¶ï¼ŒOVSå¯åŠ¨éœ€è¦é…ç½®çš„å†…å®¹ä¸å¤šï¼ä½†åŸºäºOVS-DPDKçš„æ•°æ®é€šè·¯ï¼Œæ¶‰åŠåˆ°çš„å‚æ•°è®¾ç½®æ¯”è¾ƒéº»çƒ¦ï¼</p><h3 id="åŸºäºå†…æ ¸æ•°æ®é€šè·¯"><a href="#åŸºäºå†…æ ¸æ•°æ®é€šè·¯" class="headerlink" title="åŸºäºå†…æ ¸æ•°æ®é€šè·¯"></a>åŸºäºå†…æ ¸æ•°æ®é€šè·¯</h3><p>ä»¥é»˜è®¤å‚æ•°å¯åŠ¨å¯ç›´æ¥ä½¿ç”¨<code>ovs-ctl</code>å‘½ä»¤ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ovs-ctl start</span><br></pre></td></tr></table></figure><h3 id="åŸºäº-DPDK-çš„æ•°æ®é€šè·¯"><a href="#åŸºäº-DPDK-çš„æ•°æ®é€šè·¯" class="headerlink" title="åŸºäº DPDK çš„æ•°æ®é€šè·¯"></a>åŸºäº DPDK çš„æ•°æ®é€šè·¯</h3><p>DPDKçš„æ•°æ®é€šè·¯éœ€è¦ä¸€äº›é¢å¤–çš„é…ç½®ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ—§çš„é…ç½®ä¿¡æ¯</span></span><br><span class="line"><span class="built_in">rm</span> /usr/local/etc/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/run/openvswitch/*</span><br><span class="line"><span class="built_in">rm</span> /usr/local/var/log/openvswitch/*</span><br><span class="line"></span><br><span class="line"><span class="comment">## 0. è®¾ç½®hugepages</span></span><br><span class="line">dpdk-hugepages.py -p 1G --setup 4G</span><br><span class="line"></span><br><span class="line"><span class="comment">## 1. å¯åŠ¨ovsdbï¼Œå…ˆä¸å¯åŠ¨ovs-vswitchd</span></span><br><span class="line">ovs-ctl --no-ovs-vswitchd start --system-id=random</span><br><span class="line"></span><br><span class="line"><span class="comment">## 2. é…ç½®ä½¿ç”¨DPDKï¼Œå¯ä»¥é…ç½®ä»ä»»ä½•ç»™å®š NUMA èŠ‚ç‚¹ä½¿ç”¨çš„å†…å­˜é‡</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x02</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 3. å¯åŠ¨ ovs-vswitchd ï¼ˆå¯åŠ¨å®Œæˆï¼‰</span></span><br><span class="line">ovs-ctl --no-ovsdb-server --db-sock=<span class="string">&quot;<span class="variable">$DB_SOCK</span>&quot;</span> start</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šé¢çš„æ–¹å¼å¯åŠ¨æ—¶ï¼Œæ— æ³•æŒ‡å®šç›¸å…³æ–‡ä»¶çš„è·¯å¾„ï¼Œä¸‹é¢æ˜¯æœ€åŸå§‹çš„å¯åŠ¨æµç¨‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®åº“æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/etc/openvswitch</span><br><span class="line">ovsdb-tool create /usr/local/etc/openvswitch/conf.db \</span><br><span class="line">    /usr/local/share/openvswitch/vswitch.ovsschema</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨æ•°æ®åº“</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/var/run/openvswitch</span><br><span class="line"><span class="built_in">mkdir</span> -p /usr/local/var/log/openvswitch</span><br><span class="line">ovsdb-server --remote=punix:/usr/local/var/run/openvswitch/db.sock \</span><br><span class="line">    --remote=db:Open_vSwitch,Open_vSwitch,manager_options \</span><br><span class="line">    --private-key=db:Open_vSwitch,SSL,private_key \</span><br><span class="line">    --certificate=db:Open_vSwitch,SSL,certificate \</span><br><span class="line">    --bootstrap-ca-cert=db:Open_vSwitch,SSL,ca_cert \</span><br><span class="line">    --pidfile --detach --log-file</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆå§‹åŒ–æ•°æ®åº“</span></span><br><span class="line">ovs-vsctl --no-wait init</span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®ä½¿ç”¨DPDK, pmd-cpu-mask è¦ç”¨16è¿›åˆ¶</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:pmd-cpu-mask=0x6</span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-socket-mem=<span class="string">&quot;1024&quot;</span></span><br><span class="line">ovs-vsctl --no-wait <span class="built_in">set</span> Open_vSwitch . other_config:dpdk-init=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ Open vSwitch å®ˆæŠ¤è¿›ç¨‹</span></span><br><span class="line">ovs-vswitchd --pidfile --detach --log-file=/root/logfile/ovs-vswitchd.log</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://docs.openvswitch.org/en/latest/faq/releases/">linuxå†…æ ¸ä¸ovsç‰ˆæœ¬åŒ¹é…å…³ç³»ã€ovsç‰ˆæœ¬ä¸DPDKç‰ˆæœ¬åŒ¹é…å…³ç³»</a></li><li><a href="https://blog.csdn.net/u010710985/article/details/119980125">å®‰è£…å†…æ ¸æ¨¡å—æ—¶æŠ¥é”™çš„è§£å†³åŠæ³•</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> OpenVSwitch </category>
          
      </categories>
      
      
        <tags>
            
            <tag> OpenVSwitch </tag>
            
            <tag> DPDK </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç½‘ç»œç¼–ç¨‹-socket</title>
      <link href="/2022/05/08/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-socket/"/>
      <url>/2022/05/08/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-socket/</url>
      
        <content type="html"><![CDATA[<h2 id="socket-å¥—æ¥å­—"><a href="#socket-å¥—æ¥å­—" class="headerlink" title="socket å¥—æ¥å­—"></a>socket å¥—æ¥å­—</h2><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-socket/image-20220508224718687.png" alt="image-20220508224718687"></p><p>å›¾ä¸­ä¸¤ä¸ªè™šçº¿æ¡†è¡¨ç¤ºä¸¤ä¸ªå¥—æ¥å­—ï¼Œåœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œå¥—æ¥å­—ä¸€å®šæ˜¯æˆå¯¹å‡ºç°çš„ã€‚ä¸€ç«¯çš„å‘é€ç¼“å†²åŒºå¯¹åº”å¯¹ç«¯çš„æ¥æ”¶ç¼“å†²åŒºã€‚</p><p>ä¸€ä¸ªsocketåªæœ‰ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå³å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºä½¿ç”¨åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚</p><p>ç½‘ç»œå¥—æ¥å­—æœ¬è´¨ï¼šä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘ä¸€ä¸ªå¥—æ¥å­—ï¼ˆè¯¥å¥—æ¥å­—å†…éƒ¨ç”±å†…æ ¸å€ŸåŠ©ä¸¤ä¸ªç¼“å†²åŒºå®ç°ï¼‰ã€‚</p><h2 id="ç½‘ç»œåœ°å€"><a href="#ç½‘ç»œåœ°å€" class="headerlink" title="ç½‘ç»œåœ°å€"></a>ç½‘ç»œåœ°å€</h2><h3 id="å­—èŠ‚åºè½¬æ¢"><a href="#å­—èŠ‚åºè½¬æ¢" class="headerlink" title="å­—èŠ‚åºè½¬æ¢"></a>å­—èŠ‚åºè½¬æ¢</h3><p>ç”±äºå†å²é—ç•™é—®é¢˜ï¼Œç½‘ç»œæ•°æ®æµé‡‡ç”¨å¤§ç«¯å­—èŠ‚åºï¼Œè€Œ pc æœ¬åœ°ä¸€èˆ¬é‡‡ç”¨çš„å°æ®µå­—èŠ‚åºï¼Œæ‰€ä»¥åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œéœ€è¦è½¬æ¢å­—èŠ‚åºã€‚</p><ul><li>å°ç«¯æ³•ï¼šï¼ˆpcæœ¬åœ°å­˜å‚¨ï¼‰é«˜ä½å­˜é«˜åœ°å€ï¼Œåœ°ä½å­˜ä½åœ°å€ã€‚</li><li>å¤§ç«¯æ³•ï¼šï¼ˆç½‘ç»œå­˜å‚¨ï¼‰é«˜ä½å­˜ä½åœ°å€ï¼Œåœ°ä½å­˜é«˜åœ°å€ã€‚</li></ul><p>å­—èŠ‚åºåªå½±å“ä¸åŒå­—èŠ‚é—´çš„é¡ºåºï¼Œå¦‚æœåªçœ‹å•å­—èŠ‚å†…éƒ¨ï¼Œå¤§å°ç«¯éƒ½ä¸€æ ·ã€‚<strong>ä¸å­˜åœ¨<code>00001111</code>å˜ä¸º<code>11110000</code>ï¼</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// h: host, to, n: network, l: long, s: short</span></span><br><span class="line"><span class="comment">// htonä¹Ÿå°±æ˜¯ä¸»æœºåˆ°ç½‘ç»œçš„è½¬æ¢ï¼Œntohæ˜¯ç½‘ç»œåˆ°ä¸»æœºçš„è½¬æ¢</span></span><br><span class="line"><span class="comment">// l, s å¯¹åº” 32ä½å’Œ 16ä½æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ ipv4 åœ°å€ å’Œ ç«¯å£å·</span></span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">htonl</span><span class="params">(<span class="type">uint32_t</span> hostlong)</span>;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">htons</span><span class="params">(<span class="type">uint16_t</span> hostshort)</span>;</span><br><span class="line"><span class="type">uint32_t</span> <span class="title function_">ntohl</span><span class="params">(<span class="type">uint32_t</span> netlong)</span>;</span><br><span class="line"><span class="type">uint16_t</span> <span class="title function_">ntohs</span><span class="params">(<span class="type">uint16_t</span> netshort)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example1:</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> a = <span class="number">0x00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span>;</span><br><span class="line">htonl(a) = <span class="number">0x01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>;</span><br><span class="line"><span class="comment">// example2:</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> b = <span class="number">0xff</span> f0 <span class="number">00</span> <span class="number">00</span>;</span><br><span class="line">htonl(b) = <span class="number">0x00</span> <span class="number">00</span> f0 ff;</span><br></pre></td></tr></table></figure><h3 id="inet-pton-å‡½æ•°"><a href="#inet-pton-å‡½æ•°" class="headerlink" title="inet_pton å‡½æ•°"></a>inet_pton å‡½æ•°</h3><p>å°†ä¸€ä¸ªç‚¹åˆ†åè¿›åˆ¶çš„ <code>IP</code> åœ°å€ï¼ˆå­—ç¬¦ä¸²ï¼‰è½¬æ¢ä¸ºä¸€ä¸ª32ä½çš„æ•´æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">inet_pton</span><span class="params">(<span class="type">int</span> af, <span class="type">const</span> <span class="type">char</span> *src, <span class="type">void</span> *dst)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">char</span> *ip = <span class="string">&quot;192.168.1.1&quot;</span>;</span><br><span class="line"><span class="type">int</span> ip_int = <span class="number">0</span>;</span><br><span class="line">inet_pton(AF_INET, ip, &amp;ip_int);</span><br></pre></td></tr></table></figure><ul><li>afï¼šåœ°å€æ—ï¼Œå¯ä»¥æ˜¯<code>AF_INET(ipv4)</code>ã€<code>AF_INET6(ipv6)</code></li><li>srcï¼šè¦è½¬æ¢çš„ <code>IP</code> åœ°å€ï¼Œå¦‚ï¼š<code>&quot;192.168.1.1&quot;</code></li><li>dstï¼šè½¬æ¢åçš„ç½‘ç»œå­—èŠ‚åºçš„ <code>IP</code> åœ°å€ï¼Œæ•´æ•°ï¼Œå¦‚ï¼š<code>&amp;ipv4_addr</code></li><li>è¿”å›å€¼ï¼š<ul><li>1ï¼ŒæˆåŠŸ</li><li>0ï¼Œå¼‚å¸¸ï¼Œè¯´æ˜ <code>src</code> ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„ipåœ°å€</li><li>-1ï¼Œ<code>af</code> ä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„åœ°å€æ—</li></ul></li></ul><h3 id="inet-ntop-å‡½æ•°"><a href="#inet-ntop-å‡½æ•°" class="headerlink" title="inet_ntop å‡½æ•°"></a>inet_ntop å‡½æ•°</h3><p>å°†ä¸€ä¸ªç½‘ç»œå­—èŠ‚åºçš„IPåœ°å€è½¬æ¢ä¸ºä¸€ä¸ªç‚¹åˆ†åè¿›åˆ¶çš„IPåœ°å€ï¼ˆå­—ç¬¦ä¸²ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *<span class="title function_">inet_ntop</span><span class="params">(<span class="type">int</span> af, <span class="type">const</span> <span class="type">void</span> *src,</span></span><br><span class="line"><span class="params">                        <span class="type">char</span> *dst, <span class="type">socklen_t</span> size)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line"><span class="type">char</span> ipv4_str[<span class="number">16</span>];</span><br><span class="line">inet_ntop(AF_INET, &amp;client_addr.sin_addr.s_addr, ipv4_str, <span class="keyword">sizeof</span>(ipv4_str));</span><br></pre></td></tr></table></figure><ul><li>afï¼šåœ°å€æ—ï¼Œå¯ä»¥æ˜¯<code>AF_INET(ipv4)</code>ã€<code>AF_INET6(ipv6)</code></li><li>scrï¼šç½‘ç»œå­—èŠ‚åºçš„IPåœ°å€</li><li>dstï¼šè½¬æ¢åçš„ç‚¹åˆ†åè¿›åˆ¶çš„IPåœ°å€ï¼Œç¼“å†²åŒºï¼Œ<code>char buf[16]</code></li><li>sizeï¼šdst çš„å¤§å°</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› dst, å¤±è´¥è¿”å› NULL</li></ul><h3 id="inet-addr-å‡½æ•°"><a href="#inet-addr-å‡½æ•°" class="headerlink" title="inet_addr å‡½æ•°"></a>inet_addr å‡½æ•°</h3><p>å°†ä¸€ä¸ªç‚¹åˆ†åè¿›åˆ¶çš„IPåœ°å€ï¼ˆå­—ç¬¦ä¸²ï¼‰è½¬æ¢ä¸ºä¸€ä¸ª32ä½çš„æ•´æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">in_addr_t</span> <span class="title function_">inet_addr</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cp)</span>;</span><br></pre></td></tr></table></figure><ul><li>cpï¼šè¦è½¬æ¢çš„IPåœ°å€ï¼Œå¦‚ï¼š<code>192.168.10.1</code></li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›ç½‘ç»œå­—èŠ‚åºçš„IPåœ°å€ï¼Œå¤±è´¥è¿”å› <code>INADDR_NONE(-1, 0xffffffff)</code></li></ul><p>ä½¿ç”¨è¿™ä¸ªå‡½æ•°å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œå› ä¸º <code>INADDR_NONE</code> ä¹Ÿæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„IPåœ°å€<code>255.255.255.255</code>ï¼</p><h3 id="sockaddr-ç»“æ„"><a href="#sockaddr-ç»“æ„" class="headerlink" title="sockaddr ç»“æ„"></a>sockaddr ç»“æ„</h3><p>åŒæ ·æ˜¯å†å²é—ç•™é—®é¢˜ï¼Œsocket ç›¸å…³çš„å‡½æ•°å¤§å¤šéƒ½æ˜¯ä½¿ç”¨ <code>struct sockaddr</code> ç»“æ„ï¼Œä½†ç°åœ¨ä½¿ç”¨çš„å¾€å¾€æ˜¯ <code>struct sockaddr_in</code>ï¼Œå› æ­¤åœ¨ä¼ é€’å‚æ•°æ—¶ï¼Œè¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ã€‚</p><p>å¯åœ¨ <code>man 7 ip</code> ä¸­æŸ¥çœ‹ç›¸å…³è¯´æ˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span> sa_family;</span><br><span class="line">    <span class="type">char</span>        sa_data[<span class="number">14</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span>    sin_family; <span class="comment">/* address family: AF_INET */</span></span><br><span class="line">    <span class="type">in_port_t</span>      sin_port;   <span class="comment">/* 16ä½ ç½‘ç»œå­—èŠ‚åºçš„ç«¯å£å· */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span>   <span class="comment">/* internet address */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> &#123;</span></span><br><span class="line">    <span class="type">uint32_t</span>       s_addr;     <span class="comment">/* ç½‘ç»œå­—èŠ‚åºçš„ IPåœ°å€ */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">addr.sin_family = AF_INET;</span><br><span class="line">addr.sin_port = htons(<span class="number">80</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å®š ip åœ°å€ï¼Œæ–¹æ³•ä¸€</span></span><br><span class="line"><span class="type">int</span> ipv4_addr;</span><br><span class="line">inet_pton(AF_INET, <span class="string">&quot;192.168.1.1&quot;</span>, (<span class="type">void</span>*)&amp;ipv4_addr);</span><br><span class="line">addr.sin_addr.s_addr = ipv4_addr;</span><br><span class="line"><span class="comment">// æŒ‡å®š ip åœ°å€ï¼Œæ–¹æ³•äºŒ</span></span><br><span class="line">addr.sin_addr.s_addr = htonl(INADDR_ANY); <span class="comment">// è¡¨ç¤ºå–å‡ºç³»ç»Ÿä¸­ä»»æ„æœ‰æ•ˆçš„IP åœ°å€ï¼ˆäºŒè¿›åˆ¶ç±»å‹ï¼‰</span></span><br></pre></td></tr></table></figure><h2 id="socket-åˆ›å»ºæµç¨‹"><a href="#socket-åˆ›å»ºæµç¨‹" class="headerlink" title="socket åˆ›å»ºæµç¨‹"></a>socket åˆ›å»ºæµç¨‹</h2><p><img src="/../images/Linux%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B-socket/image-20220509201419178.png" alt="image-20220509201419178"></p><p><strong>æœåŠ¡å™¨ç«¯</strong>ï¼š</p><ol><li><code>socket()</code> åˆ›å»ºä¸€ä¸ª socketï¼ˆsocket1ï¼‰</li><li><code>bind()</code> ç»‘å®š IP + portï¼ˆè®¾ç½® socket1ï¼‰</li><li><code>listen()</code> è®¾ç½®<strong>åŒæ—¶</strong>ç›‘å¬ä¸Šé™ï¼ˆsocket1ç”¨äºç›‘å¬ï¼‰</li><li><code>accept()</code> é˜»å¡ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ï¼ˆä¼ å…¥socket1ä»¥å»ºç«‹è¿æ¥ï¼Œåˆ›å»ºsocket2ç”¨äºé€šä¿¡ï¼‰</li><li><code>read()/write()</code> æ–‡ä»¶å¤„ç†çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œè¿™é‡Œå°±ç›´æ¥åƒè®¿é—®æ­£å¸¸æ–‡ä»¶ä¸€æ ·è®¿é—®socket2</li></ol><p><strong>å®¢æˆ·ç«¯</strong>ï¼š</p><ol><li><code>socket()</code> åˆ›å»ºä¸€ä¸ª socketï¼ˆsocket3ï¼‰</li><li><code>connect()</code> æŒ‡å®šæœåŠ¡å™¨çš„åœ°å€ç»“æ„ï¼ˆIP+portï¼‰è¿æ¥æœåŠ¡å™¨ï¼ˆè®¾ç½®socket3ï¼‰</li><li><code>read()/write()</code></li></ol><p>æ³¨æ„ï¼Œåœ¨ä¸Šå›¾çš„æµç¨‹ä¸­ï¼Œæœ€ç»ˆä¼šæœ‰3ä¸ª socket ç»“æ„ï¼ŒæœåŠ¡å™¨ç«¯çš„ socket1 ä»…ç”¨äºç›‘å¬ï¼Œå¹¶ä¸è´Ÿè´£å®é™…çš„ä¸å®¢æˆ·ç«¯é€šä¿¡ï¼Œ<code>accept()</code> å‡½æ•°é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œ<code>accept()</code> å‡½æ•°ä¸­ä¼šæ–°å»ºä¸€ä¸ª socket2 ä¸å®¢æˆ·ç«¯ socket3 ç»‘å®šï¼Œå®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡ã€‚</p><h3 id="socket-å‡½æ•°"><a href="#socket-å‡½æ•°" class="headerlink" title="socket å‡½æ•°"></a>socket å‡½æ•°</h3><p>åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ï¼Œå¹¶è¿”å›ä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">socket</span><span class="params">(<span class="type">int</span> domain, <span class="type">int</span> type, <span class="type">int</span> protocol)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">int</span> sockfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);   <span class="comment">// TCP</span></span><br><span class="line"><span class="type">int</span> sockfd = socket(AF_INET, SOCK_DGRAM, <span class="number">0</span>);    <span class="comment">// UDP</span></span><br></pre></td></tr></table></figure><ul><li>domainï¼šåœ°å€æ—ï¼Œå¸¸ç”¨ä¸‰ä¸ªä¸º <code>AF_INET(ipv4)</code>ã€<code>AF_INET6(ipv6)</code>ã€<code>AF_UNIX(æœ¬åœ°å¥—æ¥å­—)</code></li><li>typeï¼šå¥—æ¥å­—ç±»å‹ï¼Œå¸¸ç”¨ä¸¤ä¸ªä¸º <code>SOCK_STREAM(TCP)</code>ã€<code>SOCK_DGRAM(UDP)</code></li><li>protocolï¼šåè®®ï¼Œä¸€èˆ¬è®¾ç½®ä¸º 0</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›å¥—æ¥å­—æè¿°ç¬¦ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® errno</li></ul><h3 id="bind-å‡½æ•°"><a href="#bind-å‡½æ•°" class="headerlink" title="bind å‡½æ•°"></a>bind å‡½æ•°</h3><p>ç»™ socket ç»‘å®šä¸€ä¸ªåœ°å€ç»“æ„ï¼ˆ<code>IP + port</code>ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">bind</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr,</span></span><br><span class="line"><span class="params">        <span class="type">socklen_t</span> addrlen)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span></span><br><span class="line">addr.sin_family = AF_INET; <span class="comment">// ç±»å‹è¦ä¸ socket åˆ›å»ºæ—¶çš„ domain ä¸€è‡´</span></span><br><span class="line">addr.sin_port = htons(<span class="number">80</span>);</span><br><span class="line">addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">bind(socket1, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr));</span><br></pre></td></tr></table></figure><ul><li>sockfdï¼šå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</li><li>addrï¼šåœ°å€ç»“æ„ï¼ˆä¼ å…¥å‚æ•°ï¼‰</li><li>addrlenï¼šåœ°å€ç»“æ„çš„å¤§å° <code>sizeof(addr)</code></li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® errno</li></ul><h3 id="listen-å‡½æ•°"><a href="#listen-å‡½æ•°" class="headerlink" title="listen å‡½æ•°"></a>listen å‡½æ•°</h3><p>è®¾ç½®<strong>åŒæ—¶</strong>ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ä¸Šé™æ•°ï¼ˆåŒæ—¶è¿›è¡ŒTCPä¸‰æ¬¡æ¡æ‰‹çš„å®¢æˆ·ç«¯æ•°é‡ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">listen</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> backlog)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line">listen(sockfd, <span class="number">5</span>);</span><br></pre></td></tr></table></figure><ul><li>sockfdï¼šå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</li><li>backlogï¼šä¸Šé™æ•°é‡ï¼Œæœ€å¤§å€¼ä¸º <code>128</code>ï¼</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® errno</li></ul><h3 id="accept-å‡½æ•°"><a href="#accept-å‡½æ•°" class="headerlink" title="accept å‡½æ•°"></a>accept å‡½æ•°</h3><p>é˜»å¡ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥ï¼Œå½“æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ª socket2 ä¸å®¢æˆ·ç«¯ socket3 ç»‘å®šï¼Œå®ç°å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯çš„é€šä¿¡ï¼Œè¿”å›æ–°å»ºçš„ socket2 çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">accept</span><span class="params">(<span class="type">int</span> sockfd, <span class="keyword">struct</span> sockaddr *addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line"><span class="type">socklen_t</span> client_addrlen = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line"><span class="type">int</span> sockfd2;</span><br><span class="line">again:</span><br><span class="line">    sockfd2 = accept(sockfd1, (<span class="keyword">struct</span> sockaddr *)&amp;client_addr, &amp;client_addrlen);</span><br><span class="line">    <span class="keyword">if</span> (sockfd2 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (errno == EINTR || errno == ECONNABORTED)</span><br><span class="line">            <span class="keyword">goto</span> again;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            perror(<span class="string">&quot;accept error&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><ul><li>sockfdï¼šä¼ å…¥çš„å¥—æ¥å­—ï¼Œä¸Šé¢ç»‘å®šäº†åœ°å€çš„ socket1</li><li>addrï¼šä¼ å‡ºå‚æ•°ï¼Œè¿”å›æˆåŠŸå»ºç«‹è¿æ¥çš„<strong>å®¢æˆ·ç«¯</strong>çš„åœ°å€ç»“æ„</li><li>addrlenï¼šä¼ å…¥ä¼ å‡ºå‚æ•°ï¼Œä¼ å…¥ä¸ºå‚2 addr çš„å¤§å°ï¼Œä¼ å‡ºä¸ºå®¢æˆ·ç«¯çš„ addr çš„å®é™…å¤§å°</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›æ–°å»ºçš„ socket2 æ–‡ä»¶æè¿°ç¬¦ï¼Œå¤±è´¥è¿”å› -1ï¼Œå¹¶è®¾ç½® errnoï¼š<ul><li>EINTRï¼šè¢«ä¿¡å·ä¸­æ–­</li><li>ECONNABORTEDï¼šè¿æ¥è¢«æ‹’ç»</li></ul></li></ul><h3 id="connect-å‡½æ•°"><a href="#connect-å‡½æ•°" class="headerlink" title="connect å‡½æ•°"></a>connect å‡½æ•°</h3><p>å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨ï¼</p><p>å®¢æˆ·ç«¯ socket å¯ä»¥ä¸éœ€è¦æ‰‹åŠ¨ bindï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç»‘å®šæœ¬åœ°çš„åœ°å€ç»“æ„ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">connect</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="keyword">struct</span> sockaddr *addr,</span></span><br><span class="line"><span class="params">            <span class="type">socklen_t</span> addrlen)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">server_addr.sin_family = AF_INET;</span><br><span class="line">server_addr.sin_port = htons(<span class="number">80</span>);</span><br><span class="line">server_addr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.1.1&quot;</span>);</span><br><span class="line">connect(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;server_addr, <span class="keyword">sizeof</span>(server_addr));</span><br></pre></td></tr></table></figure><ul><li>sockfdï¼šå¥—æ¥å­—æ–‡ä»¶æè¿°ç¬¦</li><li>addrï¼šæœåŠ¡å™¨çš„åœ°å€ç»“æ„</li><li>addrlenï¼šåœ°å€ç»“æ„çš„å¤§å° <code>sizeof(addr)</code></li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›Ÿ 0ï¼Œå¤±è´¥è¿”å›Ÿ -1ï¼Œå¹¶è®¾ç½® errno</li></ul><h3 id="TCP-example"><a href="#TCP-example" class="headerlink" title="TCP example"></a>TCP example</h3><p>ç®€å•çš„ TCP æ”¶å‘æµ‹è¯•ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æœåŠ¡å™¨ç«¯</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_PORT 10001</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º socket</span></span><br><span class="line">    <span class="type">int</span> socketfd1 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. ç»‘å®šåœ°å€(ip, port)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_port = htons(SERVER_PORT);</span><br><span class="line">    server_addr.sin_addr.s_addr = htonl(INADDR_ANY);</span><br><span class="line">    <span class="type">int</span> res = bind(socketfd1, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr,</span><br><span class="line">                    <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. è®¾ç½®ç›‘å¬ä¸Šé™</span></span><br><span class="line">    res = listen(socketfd1, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. é˜»å¡ç­‰å¾…è¿æ¥</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_addr</span>;</span></span><br><span class="line">    <span class="type">socklen_t</span> len = <span class="keyword">sizeof</span>(client_addr);</span><br><span class="line">    <span class="type">int</span> socketfd2 = accept(socketfd1, (<span class="keyword">struct</span> sockaddr*)&amp;client_addr, &amp;len);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. read è¯»å–æ•°æ®</span></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1500</span>];</span><br><span class="line"></span><br><span class="line">    read(socketfd2, buf, <span class="number">1500</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv data: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *data = <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">    write(socketfd2, data, <span class="built_in">strlen</span>(data));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    close(socketfd1);</span><br><span class="line">    close(socketfd2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®¢æˆ·ç«¯</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_PORT 10001</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SERVER_IP <span class="string">&quot;192.168.0.8&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1. åˆ›å»º socket</span></span><br><span class="line">    <span class="type">int</span> socketfd3 = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. è¿æ¥åˆ°æœåŠ¡å™¨</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">server_addr</span>;</span></span><br><span class="line">    server_addr.sin_family = AF_INET;</span><br><span class="line">    server_addr.sin_port = htons(SERVER_PORT);</span><br><span class="line">    server_addr.sin_addr.s_addr = inet_addr(SERVER_IP);</span><br><span class="line">    <span class="type">int</span> res = connect(socketfd3, (<span class="keyword">struct</span> sockaddr*)&amp;server_addr,</span><br><span class="line">                      <span class="keyword">sizeof</span>(server_addr));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. write å†™æ•°æ®</span></span><br><span class="line">    <span class="type">char</span> *data = <span class="string">&quot;hello world!&quot;</span>;</span><br><span class="line">    write(socketfd3, data, <span class="built_in">strlen</span>(data));</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1500</span>];</span><br><span class="line">    read(socketfd3, buf, <span class="number">1500</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;recv data: %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">    close(socketfd3);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>nc</code> å‘½ä»¤ä¹Ÿå¯ä»¥ç”¨æ¥åšå®¢æˆ·ç«¯æµ‹è¯•ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 192.168.0.8 10001</span><br></pre></td></tr></table></figure><h2 id="read-å‡½æ•°"><a href="#read-å‡½æ•°" class="headerlink" title="read å‡½æ•°"></a>read å‡½æ•°</h2><p>ä»æŒ‡å®šçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ€å¤šè¯»å– <code>count</code> ä¸ªå­—èŠ‚å­˜æ”¾åˆ°ç¼“å†²åŒº <code>buf</code> ä¸­ï¼Œè¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨ç½‘ç»œç¼–ç¨‹ä¸­ï¼Œread å‡½æ•°çš„è¿”å›å€¼éœ€è¦ä»”ç»†åŒºåˆ†ï¼š</p><ol><li><code>&gt;0</code> å®é™…è¯»åˆ°çš„å­—èŠ‚æ•°ï¼›</li><li><code>=0</code> å·²ç»è¯»åˆ°ç»“å°¾ï¼Œè¯´æ˜<strong>å¯¹ç«¯socketå·²å…³é—­</strong>ï¼ˆé‡ç‚¹ï¼ï¼ï¼‰ï¼›</li><li><code>-1</code> åº”è¯¥è¿›ä¸‹ä¸€æ­¥åˆ¤æ–­ <code>errno</code> çš„å€¼ï¼š<ul><li><code>EAGAIN/ENOULDBLOCK</code> è®¾ç½®äº†éé˜»å¡æ–¹å¼è¯»ï¼Œæ²¡æœ‰æ•°æ®åˆ°è¾¾</li><li><code>EINTR</code> æ…¢é€Ÿç³»ç»Ÿè°ƒç”¨è¢« ä¸­æ–­</li><li>å…¶ä»–æƒ…å†µï¼Œå¼‚å¸¸</li></ul></li></ol><h2 id="write-å‡½æ•°"><a href="#write-å‡½æ•°" class="headerlink" title="write å‡½æ•°"></a>write å‡½æ•°</h2><p>å°†ç¼“å†²åŒº <code>buf</code> ä¸­çš„ <code>count</code> ä¸ªå­—èŠ‚æ•°æ®å†™å…¥åˆ° <code>fd</code> å¯¹åº”çš„æ–‡ä»¶ä¸­ï¼Œè¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br></pre></td></tr></table></figure><h2 id="recv-x2F-recvfrom-å‡½æ•°"><a href="#recv-x2F-recvfrom-å‡½æ•°" class="headerlink" title="recv&#x2F;recvfrom å‡½æ•°"></a>recv&#x2F;recvfrom å‡½æ•°</h2><p>ä»æŒ‡å®šçš„ <code>sockfd</code> ä¸Šæ¥æ”¶ï¼ˆè¯»å–ï¼‰æ•°æ®å†™å…¥åˆ°ç¼“å†²åŒº <code>buf</code>ä¸­ï¼Œ<code>buf</code>çš„é•¿åº¦æ˜¯<code>len</code>ï¼Œè¿”å›å®é™…æ¥æ”¶çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recv</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvfrom</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">                 <span class="keyword">struct</span> sockaddr *src_addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure><p><code>flags</code> å‚æ•°å¯ä»¥ç”¨æ¥æŒ‡å®šè¯¥å‡½æ•°çš„ç‰¹æ®Šè¡Œä¸ºã€‚å¸¸ç”¨çš„ <code>flags</code> å‚æ•°å€¼æœ‰ï¼š</p><ul><li><code>0</code>ï¼šä¸è®¾ç½®æ ‡å¿—ã€‚</li><li><code>MSG_PEEK</code>ï¼šè¯¥æ ‡å¿—ä¼šå¯¼è‡´ <code>recv</code> å‡½æ•°è¿”å›å¥—æ¥å­—ä¸­çš„æ•°æ®ï¼Œä½†ä¸ä¼šä»ç¼“å†²åŒºä¸­åˆ é™¤æ•°æ®ã€‚ä¸‹ä¸€æ¬¡è°ƒç”¨ <code>recv</code> å‡½æ•°ä¼šå†æ¬¡è¿”å›ç›¸åŒçš„æ•°æ®ã€‚è¿™ä¸ªæ ‡å¿—å¯¹æ£€æŸ¥æ¥æ”¶åˆ°çš„æ•°æ®è€Œä¸æ¶ˆè€—å®ƒå¾ˆæœ‰ç”¨ã€‚</li><li><code>MSG_WAITALL</code>ï¼šè¯¥æ ‡å¿—å¯¼è‡´ <code>recv</code> å‡½æ•°é˜»å¡ï¼Œç›´åˆ°æ¥æ”¶åˆ°è¯·æ±‚çš„å­—èŠ‚æ•°æˆ–è¿æ¥å…³é—­ã€‚å¦‚æœåœ¨æ¥æ”¶åˆ°è¯·æ±‚çš„å­—èŠ‚æ•°ä¹‹å‰è¿æ¥å…³é—­ï¼Œ<code>recv</code> å‡½æ•°ä¼šè¿”å›å·²æ¥æ”¶çš„å­—èŠ‚æ•°ã€‚</li><li><code>MSG_OOB</code>ï¼šè¯¥æ ‡å¿—å¯¼è‡´ <code>recv</code> å‡½æ•°è¿”å›å¸¦å¤–æ•°æ®ï¼Œå¦‚æœæœ‰å¯ç”¨çš„å¸¦å¤–æ•°æ®ã€‚å¸¦å¤–æ•°æ®æ˜¯å•ç‹¬ä»æ­£å¸¸æ•°æ®æµå‘é€çš„æ•°æ®ï¼Œé€šå¸¸ç”¨äºç´§æ€¥æ•°æ®ã€‚</li><li><code>MSG_DONTWAIT</code>ï¼šè¯¥æ ‡å¿—ç­‰åŒäº <code>O_NONBLOCK</code> æ–‡ä»¶çŠ¶æ€æ ‡å¿—ã€‚å½“è®¾ç½®è¯¥æ ‡å¿—æ—¶ï¼Œ<code>recv</code> å‡½æ•°ä¸ä¼šé˜»å¡ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å¯ç”¨ï¼Œåˆ™è¿”å› <code>-1</code> å¹¶å¸¦æœ‰é”™è¯¯ä»£ç  <code>EAGAIN</code> æˆ– <code>EWOULDBLOCK</code>ã€‚</li></ul><p>è¿™äº›æ ‡å¿—å¯ä»¥ä½¿ç”¨ä½è¿ç®—ç¬¦ <code>|</code> ç»„åˆï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> n = recv(sockfd, buffer, <span class="number">1024</span>, MSG_PEEK | MSG_WAITALL);</span><br></pre></td></tr></table></figure><h2 id="send-x2F-sendto-å‡½æ•°"><a href="#send-x2F-sendto-å‡½æ•°" class="headerlink" title="send&#x2F;sendto å‡½æ•°"></a>send&#x2F;sendto å‡½æ•°</h2><p>å°†ç¼“å†²åŒº<code>buf</code>ä¸­çš„<code>len</code>ä¸ªå­—èŠ‚çš„æ•°æ®å‘é€åˆ°å¯¹åº”çš„<code>sockfd</code>ï¼Œè¿”å›å®é™…å‘é€çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">send</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">sendto</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">               <span class="type">const</span> <span class="keyword">struct</span> sockaddr *dest_addr, <span class="type">socklen_t</span> addrlen)</span>;</span><br></pre></td></tr></table></figure><blockquote><p><code>send()</code> &#x2F; <code>write()</code> çš„ä¸€ç‚¹åŒºåˆ«ï¼š</p><p>é¦–å…ˆï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ç³»ç»Ÿè°ƒç”¨ï¼Œéƒ½æ˜¯ç”¨æ¥å‘æ–‡ä»¶æè¿°ç¬¦ï¼ˆåŒ…æ‹¬<code>Socket</code>æ–‡ä»¶æè¿°ç¬¦ï¼‰å†™å…¥æ•°æ®çš„ã€‚åŒºåˆ«åœ¨äºï¼Œ<code>send()</code> ç³»ç»Ÿè°ƒç”¨å¯ä»¥æŒ‡å®šä¸€äº›å¯é€‰çš„å‚æ•°ï¼Œä¾‹å¦‚<code>flags</code>å‚æ•°ç”¨æ¥æŒ‡å®šå‘é€æ•°æ®çš„æ–¹å¼ï¼Œå¦‚éé˜»å¡æ–¹å¼å’Œå¸¦å¤–æ–¹å¼ç­‰ã€‚<code>send()</code>å‡½æ•°æ¯”<code>write()</code>å‡½æ•°æ›´åŠ çµæ´»ï¼Œå› æ­¤åœ¨ç½‘ç»œç¼–ç¨‹ä¸­æ›´å¸¸ç”¨ã€‚</p></blockquote><h2 id="get-x2F-setsockopt-å‡½æ•°"><a href="#get-x2F-setsockopt-å‡½æ•°" class="headerlink" title="get&#x2F;setsockopt å‡½æ•°"></a>get&#x2F;setsockopt å‡½æ•°</h2><p>ç”¨äºè®¾ç½®å¥—æ¥å­—çš„ä¸€äº›ç‰¹æ®Šé€‰é¡¹ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>          <span class="comment">/* See NOTES */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params">               <span class="type">void</span> *optval, <span class="type">socklen_t</span> *optlen)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setsockopt</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">int</span> level, <span class="type">int</span> optname,</span></span><br><span class="line"><span class="params">               <span class="type">const</span> <span class="type">void</span> *optval, <span class="type">socklen_t</span> optlen)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>socket</code>ï¼šè¡¨ç¤ºéœ€è¦è®¾ç½®é€‰é¡¹çš„å¥—æ¥å­—çš„æè¿°ç¬¦ã€‚</li><li><code>level</code>ï¼šè¡¨ç¤ºé€‰é¡¹çš„åè®®å±‚ï¼Œé€šå¸¸æ˜¯ <code>SOL_SOCKET</code>ï¼Œè¡¨ç¤ºå¥—æ¥å­—é€‰é¡¹ã€‚</li><li><code>optname</code>ï¼šè¡¨ç¤ºé€‰é¡¹çš„åç§°ï¼Œæ ¹æ®ä¸åŒçš„åè®®å±‚ï¼Œé€‰é¡¹å¯èƒ½ä¸åŒã€‚</li><li><code>optval</code>ï¼šæŒ‡å‘åŒ…å«é€‰é¡¹å€¼çš„ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚</li><li><code>optlen</code>ï¼šç¼“å†²åŒºçš„å¤§å°ã€‚</li></ul><h3 id="SO-SNDBUF-x2F-SO-RCVBUF"><a href="#SO-SNDBUF-x2F-SO-RCVBUF" class="headerlink" title="SO_SNDBUF&#x2F;SO_RCVBUF"></a>SO_SNDBUF&#x2F;SO_RCVBUF</h3><p><code>SO_SNDBUF</code> é€‰é¡¹æ§åˆ¶å‘é€ç¼“å†²åŒºçš„å¤§å°ï¼Œå³ä»åº”ç”¨ç¨‹åºå‘é€åˆ°å¥—æ¥å­—çš„æ•°æ®åœ¨å†…æ ¸ä¸­çš„ç¼“å†²åŒºå¤§å°ã€‚å¦‚æœåº”ç”¨ç¨‹åºå‘é€çš„æ•°æ®é‡å¤§äºè¯¥ç¼“å†²åŒºå¤§å°ï¼Œåˆ™å¿…é¡»ç­‰å¾…å…ˆå‰å‘é€çš„æ•°æ®å®Œæˆå‘é€æ‰èƒ½ç»§ç»­å‘é€æ•°æ®ã€‚</p><p><code>SO_RCVBUF</code> é€‰é¡¹æ§åˆ¶æ¥æ”¶ç¼“å†²åŒºçš„å¤§å°ï¼Œå³ä»ç½‘ç»œæ¥æ”¶åˆ°çš„æ•°æ®åœ¨å†…æ ¸ä¸­çš„ç¼“å†²åŒºå¤§å°ã€‚å¦‚æœä»ç½‘ç»œæ¥æ”¶çš„æ•°æ®é‡å¤§äºè¯¥ç¼“å†²åŒºå¤§å°ï¼Œåˆ™æ–°æ¥æ”¶åˆ°çš„æ•°æ®å¯èƒ½ä¼šè¦†ç›–å…ˆå‰æœªè¯»å–çš„æ•°æ®ã€‚</p><p>é€šè¿‡ä½¿ç”¨ <code>setsockopt</code> å‡½æ•°ï¼Œå¯ä»¥ä¿®æ”¹å‘é€ç¼“å†²åŒºå’Œæ¥æ”¶ç¼“å†²åŒºçš„å¤§å°ï¼Œä»¥é€‚åº”åº”ç”¨ç¨‹åºçš„æ•°æ®ä¼ è¾“éœ€æ±‚ã€‚ä½†æ˜¯ï¼Œä¿®æ”¹ç¼“å†²åŒºå¤§å°å¹¶ä¸èƒ½ä¿è¯æ€§èƒ½æå‡ï¼Œå› ä¸ºå®é™…æƒ…å†µå¯èƒ½å—åˆ°è®¸å¤šå› ç´ çš„å½±å“ã€‚</p><h3 id="SO-LINGER"><a href="#SO-LINGER" class="headerlink" title="SO_LINGER"></a>SO_LINGER</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linger</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> l_onoff;        <span class="comment">/* Nonzero to linger on close.  */</span></span><br><span class="line">    <span class="type">int</span> l_linger;       <span class="comment">/* Time to linger.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>SO_LINGER</code> é€‰é¡¹æ˜¯ä¸€ä¸ªå¥—æ¥å­—é€‰é¡¹ï¼Œç”¨äºæ§åˆ¶åœ¨å…³é—­å¥—æ¥å­—æ—¶æ˜¯å¦ç­‰å¾…æ­£åœ¨å‘é€çš„æ•°æ®çš„å®Œæˆã€‚</p><p>å½“å…³é—­å¥—æ¥å­—æ—¶ï¼Œå¦‚æœæœ‰æ•°æ®æ­£åœ¨å‘é€ï¼Œé‚£ä¹ˆé€šå¸¸æœ‰ä¸¤ç§å¤„ç†æ–¹å¼ï¼š</p><ul><li>å¦‚æœæœªå¯ç”¨ <code>SO_LINGER</code> é€‰é¡¹ï¼Œé‚£ä¹ˆå¥—æ¥å­—ä¼šç«‹å³å…³é—­ï¼Œæœªå‘é€å®Œçš„æ•°æ®ä¼šè¢«ä¸¢å¼ƒã€‚</li><li>å¦‚æœå¯ç”¨äº† <code>SO_LINGER</code> é€‰é¡¹ï¼Œåˆ™å¥—æ¥å­—å°†ç­‰å¾…æ‰€æœ‰æ­£åœ¨å‘é€çš„æ•°æ®å®Œæˆï¼Œç›´åˆ°æŒ‡å®šçš„æ—¶é—´åˆ°è¾¾ä¸ºæ­¢ã€‚</li></ul><p>å…·ä½“çš„ï¼Œå¯ä»¥ä½¿ç”¨ <code>setsockopt</code> å‡½æ•°å¯ç”¨ <code>SO_LINGER</code> é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥æŒ‡å®šç­‰å¾…çš„æ—¶é—´ï¼Œè¯¥ç»“æ„ä½“ç”±ä¸¤ä¸ªæˆå‘˜ï¼š</p><ul><li><code>l_onoff</code>ï¼šç”¨äºæ§åˆ¶æ˜¯å¦å¯ç”¨ <code>SO_LINGER</code> é€‰é¡¹ã€‚</li><li><code>l_linger</code>ï¼šè¡¨ç¤ºç­‰å¾…æ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚</li></ul><p>å¦‚æœ <code>l_onoff</code> è®¾ç½®ä¸ºéé›¶å€¼ï¼Œåˆ™å¯ç”¨ <code>SO_LINGER</code> é€‰é¡¹ï¼Œå¹¶ä½¿ç”¨ <code>l_linger</code> æŒ‡å®šçš„ç­‰å¾…æ—¶é—´ã€‚å¦‚æœ <code>l_onoff</code> è®¾ç½®ä¸ºé›¶ï¼Œåˆ™ç¦ç”¨ <code>SO_LINGER</code> é€‰é¡¹ï¼Œå…³é—­å¥—æ¥å­—æ—¶ä¸ç­‰å¾…æ•°æ®çš„å®Œæˆã€‚</p><h3 id="SO-KEEPALIVE"><a href="#SO-KEEPALIVE" class="headerlink" title="SO_KEEPALIVE"></a>SO_KEEPALIVE</h3><p><code>SO_KEEPALIVE</code> é€‰é¡¹ç”¨äºæ§åˆ¶æ˜¯å¦å¯ç”¨ TCP è¿æ¥çš„ keep-alive æ£€æµ‹æœºåˆ¶ã€‚å½“å¯ç”¨è¯¥é€‰é¡¹æ—¶ï¼Œå¦‚æœä¸¤ç«¯åœ¨ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æ•°æ®äº¤äº’ï¼ŒTCP åè®®ä¼šå‘é€ keep-alive æ•°æ®åŒ…æ¥æ£€æµ‹å¯¹ç«¯æ˜¯å¦ä»ç„¶å¯ç”¨ã€‚å¦‚æœå¤šæ¬¡å°è¯•åå¯¹ç«¯ä»ç„¶æ— æ³•å“åº”ï¼Œåˆ™å¯ä»¥æ–­å¼€è¯¥è¿æ¥ã€‚</p><p>è¿™ä¸ªé€‰é¡¹å¯ä»¥ç”¨äºé˜²æ­¢é•¿æ—¶é—´ç©ºé—²çš„è¿æ¥è¢«ç½‘ç»œä¸­æ–­ï¼Œä»è€Œå¯¼è‡´ä¸å¿…è¦çš„ç­‰å¾…å’Œé‡è¯•ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®ƒä¹Ÿå¯ä»¥ç”¨äºæ£€æµ‹å¯¹ç«¯çš„ä¸å­˜åœ¨æˆ–æ•…éšœã€‚</p><h3 id="SO-REUSEADDR"><a href="#SO-REUSEADDR" class="headerlink" title="SO_REUSEADDR"></a>SO_REUSEADDR</h3><p><code>SO_REUSEADDR</code> é€‰é¡¹ç”¨äºæ§åˆ¶åœ¨åŒä¸€ä¸ªä¸»æœºä¸Šæ˜¯å¦å…è®¸å¤šä¸ªå¥—æ¥å­—ç»‘å®šåˆ°åŒä¸€ç«¯å£ã€‚</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªå¥—æ¥å­—å·²ç»ç»‘å®šåˆ°æŸä¸ªç«¯å£ï¼Œé‚£ä¹ˆå…¶ä»–å¥—æ¥å­—å°†ä¸èƒ½å†ç»‘å®šåˆ°è¯¥ç«¯å£ã€‚è¿™ç§é™åˆ¶æœ‰åŠ©äºé˜²æ­¢åœ¨åŒä¸€ç«¯å£ä¸Šçš„ç«äº‰å†²çªã€‚</p><p>ä½†æ˜¯ï¼Œæœ‰æ—¶éœ€è¦å¤šä¸ªå¥—æ¥å­—å…±äº«åŒä¸€ç«¯å£ï¼Œä¾‹å¦‚å½“åŒä¸€ä¸»æœºä¸Šæœ‰å¤šä¸ªæœåŠ¡å™¨ç¨‹åºè¿è¡Œæ—¶ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>SO_REUSEADDR</code> é€‰é¡¹æ¥å…è®¸å¤šä¸ªå¥—æ¥å­—ç»‘å®šåˆ°åŒä¸€ç«¯å£ã€‚</p><h3 id="SO-REUSEPORT"><a href="#SO-REUSEPORT" class="headerlink" title="SO_REUSEPORT"></a>SO_REUSEPORT</h3><p><code>SO_REUSEPORT</code> é€‰é¡¹æ˜¯ä¸€ç§æ‰©å±•çš„å¥—æ¥å­—é€‰é¡¹ï¼Œä¸»è¦ç”¨äºå…è®¸å¤šä¸ªå¥—æ¥å­—ç»‘å®šåˆ°åŒä¸€ç«¯å£ï¼Œä»è€Œå…±äº«åŒä¸€ä¸ªç«¯å£ã€‚è¿™ä¸ªé€‰é¡¹ä¸ <code>SO_REUSEADDR</code> é€‰é¡¹ç±»ä¼¼ï¼Œä½†æ˜¯æä¾›äº†æ›´å¤šçš„çµæ´»æ€§å’Œæ›´é«˜çš„æ€§èƒ½ã€‚</p><p>åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœä¸€ä¸ªå¥—æ¥å­—å·²ç»ç»‘å®šåˆ°æŸä¸ªç«¯å£ï¼Œé‚£ä¹ˆå…¶ä»–å¥—æ¥å­—å°†ä¸èƒ½å†ç»‘å®šåˆ°è¯¥ç«¯å£ã€‚ä½†æ˜¯ï¼Œå¦‚æœå¤šä¸ªå¥—æ¥å­—éƒ½å¯ç”¨äº† <code>SO_REUSEPORT</code> é€‰é¡¹ï¼Œé‚£ä¹ˆå¤šä¸ªå¥—æ¥å­—å°±å¯ä»¥åŒæ—¶ç»‘å®šåˆ°åŒä¸€ç«¯å£ã€‚</p><p>è¿™ä¸ªé€‰é¡¹å¯¹äºæé«˜ç½‘ç»œæœåŠ¡çš„æ€§èƒ½å’Œå¯é æ€§éå¸¸é‡è¦ï¼Œå› ä¸ºå®ƒå¯ä»¥å…è®¸å¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹å…±äº«åŒä¸€ç«¯å£ï¼Œä»è€Œåˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ã€‚</p><p>ä½¿ç”¨ <code>setsockopt</code> å‡½æ•°ï¼Œå¯ä»¥åœ¨å¥—æ¥å­—åˆ›å»ºåå¯ç”¨æˆ–ç¦ç”¨ <code>SO_REUSEPORT</code> é€‰é¡¹ã€‚è¯·æ³¨æ„ï¼Œ<code>SO_REUSEPORT</code> é€‰é¡¹å¯èƒ½åªåœ¨æŸäº›æ“ä½œç³»ç»Ÿä¸Šå¯ç”¨ï¼Œå¹¶ä¸”å¯èƒ½éœ€è¦åœ¨ç¼–è¯‘å¥—æ¥å­—åº”ç”¨ç¨‹åºæ—¶å¯ç”¨ç‰¹å®šçš„å®å®šä¹‰æ‰èƒ½ä½¿ç”¨è¯¥é€‰é¡¹ã€‚</p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://www.bilibili.com/video/BV1iJ411S7UA?p=18&spm_id_from=pageDriver">listen å’Œ accpet å‡½æ•°è¯´æ˜</a></li><li><a href="https://xiaolincoding.com/network/3_tcp/tcp_interview.html">TCP ä¸‰æ¬¡æ¡æ‰‹ä¸å››æ¬¡æŒ¥æ‰‹</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> socket </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-åŒæ­¥ä¸é”</title>
      <link href="/2022/05/06/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E5%90%8C%E6%AD%A5%E4%B8%8E%E9%94%81/"/>
      <url>/2022/05/06/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E5%90%8C%E6%AD%A5%E4%B8%8E%E9%94%81/</url>
      
        <content type="html"><![CDATA[<p>ç¼–ç¨‹ä¸­ã€é€šä¿¡ä¸­æ‰€è¯´çš„åŒæ­¥ä¸ç”Ÿæ´»ä¸­å¤§å®¶å°è±¡ä¸­çš„åŒæ­¥æ¦‚å¿µç•¥æœ‰å·®å¼‚ã€‚â€œåŒâ€å­—åº”æ˜¯æŒ‡ååŒã€ååŠ©ã€äº’ç›¸é…åˆã€‚<strong>ä¸»æ—¨åœ¨ååŒæ­¥è°ƒï¼ŒæŒ‰é¢„å®šçš„å…ˆåæ¬¡åºè¿è¡Œ</strong></p><p>çº¿ç¨‹åŒæ­¥ï¼ŒæŒ‡ä¸€ä¸ªçº¿ç¨‹å‘å‡ºæŸä¸€åŠŸèƒ½è°ƒç”¨æ—¶ï¼Œåœ¨æ²¡æœ‰å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸è¿”å›ã€‚åŒæ—¶å…¶å®ƒçº¿ç¨‹ä¸ºä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œä¸èƒ½è°ƒç”¨è¯¥åŠŸèƒ½ã€‚</p><p>çº¿ç¨‹åŒæ­¥å¯ä»¥é€šè¿‡é”æ¥å®ç°ï¼ä¸é”ç›¸å…³çš„éƒ¨åˆ†å‡½æ•°çš„<code>man page</code>éœ€è¦å•ç‹¬å®‰è£…ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install manpages-posix-dev</span><br></pre></td></tr></table></figure><h2 id="mutex-äº’æ–¥é‡ï¼ˆäº’æ–¥é”ï¼‰"><a href="#mutex-äº’æ–¥é‡ï¼ˆäº’æ–¥é”ï¼‰" class="headerlink" title="mutex äº’æ–¥é‡ï¼ˆäº’æ–¥é”ï¼‰"></a>mutex äº’æ–¥é‡ï¼ˆäº’æ–¥é”ï¼‰</h2><p>æ¯ä¸ªçº¿ç¨‹åœ¨å¯¹èµ„æºæ“ä½œå‰éƒ½å°è¯•å…ˆåŠ é”ï¼ŒæˆåŠŸåŠ é”æ‰èƒ½æ“ä½œï¼Œæ“ä½œç»“æŸè§£é”ã€‚</p><p>èµ„æºè¿˜æ˜¯å…±äº«çš„ï¼Œçº¿ç¨‹é—´ä¹Ÿè¿˜æ˜¯<strong>ç«äº‰</strong>çš„ï¼Œä½†é€šè¿‡â€œé”â€å°±å°†èµ„æºçš„è®¿é—®å˜æˆäº’æ–¥æ“ä½œã€‚</p><p>äº’æ–¥é”å®è´¨ä¸Šæ˜¯æ“ä½œç³»ç»Ÿæä¾›çš„ä¸€æŠŠâ€œå»ºè®®é”â€ï¼ˆåˆç§°â€œååŒé”â€ï¼‰ï¼Œå»ºè®®ç¨‹åºä¸­æœ‰å¤šçº¿ç¨‹è®¿é—®å…±äº«èµ„æºçš„æ—¶å€™ä½¿ç”¨è¯¥æœºåˆ¶ã€‚ä½†ï¼Œå¹¶æ²¡æœ‰å¼ºåˆ¶é™å®šã€‚å› æ­¤ï¼Œå³ä½¿æœ‰äº† mutexï¼Œå¦‚æœæœ‰çº¿ç¨‹ä¸æŒ‰è§„åˆ™æ¥è®¿é—®æ•°æ®ï¼Œä¾ç„¶ä¼šé€ æˆæ•°æ®æ··ä¹±ã€‚</p><p><strong>å°½é‡ä¿è¯é”çš„ç²’åº¦ï¼Œè¶Šå°è¶Šå¥½ï¼ˆè®¿é—®å…±äº«æ•°æ®å‰ï¼ŒåŠ é”ã€‚è®¿é—®ç»“æŸç«‹å³è§£é”ï¼‰</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">pthead_mutex_t</span> muetx = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="comment">// ä¸‹é¢å‡ ä¸ªå‡½æ•°éƒ½æ˜¯ æˆåŠŸè¿”å› 0ï¼Œ å¤±è´¥è¿”å›é”™è¯¯å·</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_init</span><span class="params">(<span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="comment">// é”€æ¯é”</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_destroy</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="comment">// åŠ é”ï¼Œè‹¥å½“å‰é”å·²è¢«å…¶å®ƒçº¿ç¨‹åŠ é”ï¼Œåˆ™é˜»å¡ï¼Œç›´åˆ°è¢«å…¶å®ƒçº¿ç¨‹è§£é”</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_lock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="comment">// trylock å°è¯•åŠ é”ï¼ŒæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å› EBUSYï¼Œä¸ä¼šé˜»å¡</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_trylock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="comment">// è§£é”</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_unlock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br></pre></td></tr></table></figure><h3 id="pthread-mutex-init-å‡½æ•°"><a href="#pthread-mutex-init-å‡½æ•°" class="headerlink" title="pthread_mutex_init å‡½æ•°"></a>pthread_mutex_init å‡½æ•°</h3><p>åˆå§‹åŒ–äº’æ–¥é”ã€‚</p><p>å¦‚æœäº’æ–¥é” mutex æ˜¯é™æ€åˆ†é…çš„ï¼ˆå®šä¹‰åœ¨å…¨å±€ï¼Œæˆ–åŠ äº† static å…³é”®å­—ä¿®é¥°ï¼‰ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨å®è¿›è¡Œåˆå§‹åŒ–ã€‚</p><p><code>pthead_mutex_t muetx = PTHREAD_MUTEX_INITIALIZER;</code></p><p>å±€éƒ¨å˜é‡åº”é‡‡ç”¨åŠ¨æ€åˆå§‹åŒ–ï¼Œå³ä½¿ç”¨ <code>pthread_mutex_init(&amp;mutex, NULL);</code> åˆå§‹åŒ–ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_init</span><span class="params">(<span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">pthread_mutexattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br></pre></td></tr></table></figure><ul><li><p>mutexï¼šäº’æ–¥é”çš„åœ°å€</p></li><li><p>attrï¼šäº’æ–¥é”çš„å±æ€§ï¼Œå¦‚æœä¸º NULLï¼Œåˆ™ä½¿ç”¨é»˜è®¤å±æ€§ï¼ˆçº¿ç¨‹é—´å…±äº«ï¼‰</p></li><li><p>è¿”å›å€¼ï¼š0ï¼ˆæˆåŠŸï¼‰ï¼Œé 0ï¼ˆå¤±è´¥ï¼‰</p></li><li><p>restrictï¼šé™å®šè¯¥æŒ‡é’ˆä¸èƒ½æ‹·è´åˆ°å…¶ä»–æŒ‡é’ˆï¼Œ<code>*restrict p = &amp;a, *p2 = *p</code>ä¼šæŠ¥é”™ã€‚</p></li></ul><blockquote><p>pthread_mutexattr_t çš„é€‰é¡¹åŒ…æ‹¬ï¼š</p><ol><li>PTHREAD_MUTEX_NORMALï¼šæ™®é€šé”ã€‚æ™®é€šé”ä¸å…è®¸é€’å½’è°ƒç”¨ï¼Œå¦‚æœçº¿ç¨‹è¯•å›¾å¯¹å·²ç»æ‹¥æœ‰çš„é”å†æ¬¡åŠ é”ï¼Œå®ƒå°†é˜»å¡ã€‚</li><li>PTHREAD_MUTEX_RECURSIVEï¼šé€’å½’é”ã€‚é€’å½’é”å…è®¸çº¿ç¨‹å¤šæ¬¡åŠ é”ï¼Œæ¯æ¬¡å¿…é¡»è§£é”ä¸€æ¬¡ã€‚</li><li>PTHREAD_MUTEX_ERRORCHECKï¼šæ£€æŸ¥é”ã€‚æ£€æŸ¥é”ä¸æ™®é€šé”ç›¸ä¼¼ï¼Œä½†å®ƒè¿˜å…è®¸çº¿ç¨‹æ£€æŸ¥æ˜¯å¦å½“å‰å·²ç»æ‹¥æœ‰è¯¥é”ã€‚</li><li>PTHREAD_MUTEX_DEFAULTï¼šé»˜è®¤é”ç±»å‹ã€‚é»˜è®¤é”ç±»å‹æ˜¯æ™®é€šé”ã€‚</li></ol><p>ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦ä½¿ç”¨ä¸åŒç±»å‹çš„äº’æ–¥é‡ï¼Œä¾‹å¦‚é€’å½’é”ç”¨äºå¤„ç†é€’å½’å‡½æ•°ï¼Œæ£€æŸ¥é”ç”¨äºæ£€æµ‹é”™è¯¯ï¼Œè€Œæ™®é€šé”æ˜¯ä¸€èˆ¬çš„äº’æ–¥é‡ã€‚</p></blockquote><h3 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h3><ol><li>çº¿ç¨‹è¯•å›¾å¯¹åŒä¸€ä¸ªäº’æ–¥é‡ A åŠ é”ä¸¤æ¬¡ã€‚</li><li>çº¿ç¨‹ 1 æ‹¥æœ‰ A é”ï¼Œè¯·æ±‚è·å¾— B é”ï¼›çº¿ç¨‹ 2 æ‹¥æœ‰ B é”ï¼Œè¯·æ±‚è·å¾— A é”ã€‚</li></ol><h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><p>æµ‹è¯•1ï¼šåœ¨ä¸åŠ é”çš„æƒ…å†µä¸‹ï¼Œä¸‹é¢çš„<code>i++</code>å’Œ<code>printf</code>ä¹‹é—´å¯èƒ½è¢«å¦ä¸€ä¸ªçº¿ç¨‹æ‰“æ–­ï¼Œå¯¼è‡´è¾“å‡ºçš„<code>i</code>çš„å¤§å°ä¸è¿ç»­ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *args)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread_func: %d \n&quot;</span>, i);</span><br><span class="line">        usleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;main_func: %d \n&quot;</span>, i);</span><br><span class="line">        usleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// result:</span></span><br><span class="line"><span class="comment">// thread_func: 17982</span></span><br><span class="line"><span class="comment">// main_func: 17982</span></span><br><span class="line"><span class="comment">// thread_func: 17984</span></span><br><span class="line"><span class="comment">// main_func: 17984</span></span><br><span class="line"><span class="comment">// thread_func: 17986</span></span><br><span class="line"><span class="comment">// main_func: 17986</span></span><br><span class="line"><span class="comment">// thread_func: 17988</span></span><br><span class="line"><span class="comment">// main_func: 17988</span></span><br><span class="line"><span class="comment">// thread_func: 17990</span></span><br><span class="line"><span class="comment">// main_func: 17990</span></span><br><span class="line"><span class="comment">// thread_func: 17992</span></span><br><span class="line"><span class="comment">// main_func: 17992</span></span><br><span class="line"><span class="comment">// thread_func: 17994</span></span><br></pre></td></tr></table></figure><p>åŠ é”ä¿è¯æ•°æ®ä¸è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">pthread_mutex_t</span> mutex_i = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *args)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;mutex_i);  <span class="comment">// ä¸Šé”</span></span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread_func: %d \n&quot;</span>, i);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex_i);  <span class="comment">// è§£é”</span></span><br><span class="line">        usleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    pthread_create(&amp;tid, <span class="literal">NULL</span>, thread_func, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;mutex_i);  <span class="comment">// ä¸Šé”</span></span><br><span class="line">        i++;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;main_func: %d \n&quot;</span>, i);</span><br><span class="line">        pthread_mutex_unlock(&amp;mutex_i);  <span class="comment">// è§£é”</span></span><br><span class="line">        usleep(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// result:</span></span><br><span class="line"><span class="comment">// main_func: 19946</span></span><br><span class="line"><span class="comment">// thread_func: 19947</span></span><br><span class="line"><span class="comment">// main_func: 19948</span></span><br><span class="line"><span class="comment">// thread_func: 19949</span></span><br><span class="line"><span class="comment">// main_func: 19950</span></span><br><span class="line"><span class="comment">// thread_func: 19951</span></span><br><span class="line"><span class="comment">// main_func: 19952</span></span><br><span class="line"><span class="comment">// thread_func: 19953</span></span><br><span class="line"><span class="comment">// main_func: 19954</span></span><br><span class="line"><span class="comment">// thread_func: 19955</span></span><br><span class="line"><span class="comment">// main_func: 19956</span></span><br></pre></td></tr></table></figure><h2 id="rwlock-è¯»å†™é”"><a href="#rwlock-è¯»å†™é”" class="headerlink" title="rwlock è¯»å†™é”"></a>rwlock è¯»å†™é”</h2><ul><li>è¯»å…±äº«ï¼Œå†™ç‹¬å ã€‚</li><li>å†™é”ä¼˜å…ˆçº§é«˜äºè¯»é”ï¼ˆè¯»é”å†™é”åŒæ—¶æ¥ï¼Œä¼˜å…ˆå¤„ç†å†™é”ã€‚è¯»é”åŠ é”æˆåŠŸåï¼Œå†™é”ä¹Ÿå¿…é¡»ç­‰å¾…è¯»é”é‡Šæ”¾ï¼‰ã€‚</li><li>é”è¿˜æ˜¯åªæœ‰ä¸€æŠŠï¼Œä½†åˆ†<strong>ä»¥è¯»æ¨¡å¼åŠ é”</strong>å’Œ<strong>ä»¥å†™æ¨¡å¼åŠ é”</strong>ä¸¤ç§ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">pthread_rwlock_t</span> rwlock = PTHREAD_RWLOCK_INITIALIZER;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–è¯»å†™é”</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_init</span><span class="params">(<span class="type">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">pthread_rwlockattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_destroy</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span>;</span><br><span class="line"><span class="comment">// åŠ è¯»é”ï¼Œ</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_wrlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_rdlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_trywrlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_tryrdlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_rwlock_unlock</span><span class="params">(<span class="type">pthread_rwlock_t</span> *rwlock)</span>;</span><br></pre></td></tr></table></figure><h2 id="cond-æ¡ä»¶å˜é‡"><a href="#cond-æ¡ä»¶å˜é‡" class="headerlink" title="cond æ¡ä»¶å˜é‡"></a>cond æ¡ä»¶å˜é‡</h2><p>æ¡ä»¶å˜é‡æœ¬èº«ä¸æ˜¯é”ï¼ä½†å®ƒä¹Ÿå¯ä»¥é€ æˆçº¿ç¨‹é˜»å¡ã€‚é€šå¸¸ä¸äº’æ–¥é”é…åˆä½¿ç”¨ã€‚ç»™å¤šçº¿ç¨‹æä¾›ä¸€ä¸ªä¼šåˆçš„åœºæ‰€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€åˆå§‹åŒ–</span></span><br><span class="line"><span class="type">pthread_cond_t</span> cond = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–æ¡ä»¶å˜é‡</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_init</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="type">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_destroy</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é˜»å¡ç­‰å¾…æ¡ä»¶å˜é‡æ»¡è¶³</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_wait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">        <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span>;</span><br><span class="line"><span class="comment">// é˜»å¡ç­‰å¾…æ¡ä»¶å˜é‡æ»¡è¶³ï¼Œæœ€é•¿ç­‰å¾…åˆ° abstime æ—¶åˆ»</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_timedwait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">        <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="keyword">struct</span> timespec *<span class="keyword">restrict</span> abstime)</span>;</span><br><span class="line"><span class="comment">// å”¤é†’ï¼ˆè‡³å°‘ï¼‰ä¸€ä¸ªé˜»å¡åœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ï¼Œä¸€èˆ¬å°±ç†è§£ä¸ºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ã€‚</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_signal</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span>;</span><br><span class="line"><span class="comment">// å”¤é†’æ‰€æœ‰é˜»å¡åœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_broadcast</span><span class="params">(<span class="type">pthread_cond_t</span> *cond)</span>;</span><br></pre></td></tr></table></figure><h3 id="pthread-cond-wait-å‡½æ•°"><a href="#pthread-cond-wait-å‡½æ•°" class="headerlink" title="pthread_cond_wait å‡½æ•°"></a>pthread_cond_wait å‡½æ•°</h3><p>é˜»å¡ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_wait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">        <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span>;</span><br></pre></td></tr></table></figure><ul><li>condï¼šæ¡ä»¶å˜é‡çš„åœ°å€</li><li>mutexï¼šäº’æ–¥é”çš„åœ°å€</li><li>è¿”å›å€¼ï¼š0ï¼ˆæˆåŠŸï¼‰ï¼Œé 0ï¼ˆå¤±è´¥ï¼‰</li></ul><p>å‡½æ•°ä½œç”¨ï¼š</p><ol><li>é˜»å¡ç­‰å¾…æ¡ä»¶å˜é‡ <code>cond</code> æ»¡è¶³</li><li>é‡Šæ”¾å·²æŒæ¡çš„äº’æ–¥é”ï¼ˆè§£é”äº’æ–¥é‡ï¼‰ç›¸å½“äº <code>pthread_mutex_unlock(&amp;mutex)</code>; <strong>1.2.ä¸¤æ­¥ä¸ºä¸€ä¸ªåŸå­æ“ä½œ</strong>ã€‚</li><li>å½“è¢«å”¤é†’ï¼Œ<code>pthread_cond_wait</code> å‡½æ•°è¿”å›æ—¶ï¼Œ<strong>è§£é™¤é˜»å¡å¹¶é‡æ–°ç”³è¯·è·å–äº’æ–¥é”</strong> <code>pthread_mutex_lock(&amp;mutex)</code>;</li></ol><p><strong>æ³¨æ„ï¼š<code>pthread_cond_broadcast</code>ä¼šå”¤é†’æ‰€æœ‰é˜»å¡åœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹ï¼Œä½†å¹¶ä¸æ„å‘³è¿™æ‰€æœ‰çº¿ç¨‹ä¼šåŒæ—¶æ”¶åˆ°<code>pthread_cond_wait</code>å‡½æ•°è¿”å›ï¼Œå› ä¸ºè¯¥å‡½æ•°è¿”å›å‰è¿˜æœ‰è·å–äº’æ–¥é”è¿™ä¸€æ­¥ï¼Œä»»æ„ä¸€ä¸ªçº¿ç¨‹è·å–é”åï¼Œå…¶ä»–çº¿ç¨‹éƒ½ä¼šé˜»å¡ç­‰å¾…ï¼æ‰€ä»¥ï¼Œå®é™…ä¸Šçº¿ç¨‹çš„å”¤é†’ä»»ç„¶æœ‰å…ˆåé¡ºåºï¼</strong></p><p>æ­¤å‡½æ•°çš„åŸç†ä¸å¤ªå¥½ç†è§£ï¼Œå»ºè®®çœ‹è§†é¢‘ä»‹ç»<a href="https://www.bilibili.com/video/BV1KE411q7ee?p=176&t=290.8">æ¡ä»¶å˜é‡åŸç†</a>ï¼</p><h3 id="pthread-cond-timedwait-å‡½æ•°"><a href="#pthread-cond-timedwait-å‡½æ•°" class="headerlink" title="pthread_cond_timedwait å‡½æ•°"></a>pthread_cond_timedwait å‡½æ•°</h3><p>é˜»å¡ç­‰å¾…ä¸€ä¸ªæ¡ä»¶å˜é‡ï¼Œæœ€é•¿ç­‰å¾…åˆ° abstime æ—¶åˆ»ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">pthread_cond_timedwait</span><span class="params">(<span class="type">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span><br><span class="line"><span class="params">        <span class="type">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex,</span></span><br><span class="line"><span class="params">        <span class="type">const</span> <span class="keyword">struct</span> timespec *<span class="keyword">restrict</span> abstime)</span>;</span><br></pre></td></tr></table></figure><ul><li>condï¼šæ¡ä»¶å˜é‡çš„åœ°å€</li><li>mutexï¼šäº’æ–¥é”çš„åœ°å€</li><li>abstimeï¼šç­‰å¾…çš„æ—¶é—´ï¼Œç»å¯¹æ—¶é—´ï¼ˆå³ä»1970å¹´1æœˆ1æ—¥é›¶æ—¶èµ·çš„çº³ç§’æ•°ï¼‰</li><li>è¿”å›å€¼ï¼š0ï¼ˆæˆåŠŸï¼‰ï¼Œé 0ï¼ˆå¤±è´¥ï¼‰</li></ul><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°</h3><p>æ¡ä»¶å˜é‡å’Œäº’æ–¥é‡æ˜¯å¯¹äº§å“åˆ—è¡¨åŠ é”ï¼Œæ— è®ºæ˜¯ç”Ÿäº§è€…è¿˜æ˜¯æ¶ˆè´¹è€…ï¼Œæƒ³è¦ç”Ÿäº§æˆ–æ¶ˆè´¹äº§å“ï¼Œéƒ½éœ€è¦å…ˆè·å¾—é”ï¼Œæ‰èƒ½å¯¹äº§å“åˆ—è¡¨è¿›è¡Œæ“ä½œï¼</p><p>è¿™é‡Œç”¨åˆ°çš„æ ¸å¿ƒå‡½æ•°å°±æ˜¯[pthread_cond_wait](#pthread_cond_wait å‡½æ•°)ï¼Œåªè¦ç†è§£è¯¥å‡½æ•°çš„é€»è¾‘ï¼Œå°±å®¹æ˜“ç†è§£ä¸‹é¢çš„æ¨¡å‹ï¼</p><p>æ­¤å¤„å®ç°çš„äº§å“æ˜¯åç”Ÿäº§çš„äº§å“å…ˆè¢«æ¶ˆè´¹ï¼ˆæ ˆï¼‰ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> num;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">product</span>;</span></span><br><span class="line"><span class="type">pthread_cond_t</span> has_product = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="type">pthread_mutex_t</span> lock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        pthread_mutex_lock(&amp;lock);  <span class="comment">// åŠ é”é˜²æ­¢å…¶ä»–æ¶ˆè´¹è€…æŠ¢å </span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å¤šæ¶ˆè´¹è€…æ—¶ï¼Œè¿™é‡Œå¿…é¡»ç”¨whileï¼Œå› ä¸ºé€šè¿‡broadcastæ–¹å¼å”¤é†’æ‰€æœ‰é˜»å¡çº¿ç¨‹æ—¶ï¼ˆå”¤é†’æ—¶æ‰€æœ‰çº¿ç¨‹è¦å»äº‰é”ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">           æœ‰å¯èƒ½å…¶ä»–çº¿ç¨‹å…ˆè·å¾—é”ï¼Œä¹Ÿå°±å…ˆæ¶ˆè´¹äº†äº§å“ï¼Œåˆ°æœ¬çº¿ç¨‹æ—¶ï¼Œå¯èƒ½å·²ç»æ²¡æœ‰äº§å“äº†ï¼Œå› æ­¤è¿˜è¦å…ˆåˆ¤æ–­æ˜¯å¦æœ‰äº§å“ï¼ */</span></span><br><span class="line">        <span class="keyword">while</span>(product == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="comment">// æ³¨æ„ç†è§£æ­¤å‡½æ•°ä¼šè¿›è¡Œçš„æ“ä½œï¼ˆè§£é”+é˜»å¡ï¼Œæ”¶åˆ°å”¤é†’è§£é™¤é˜»å¡+åŠ é”ï¼‰</span></span><br><span class="line">            pthread_cond_wait(&amp;has_product, &amp;lock);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        p = product;</span><br><span class="line">        product = product-&gt;next;    <span class="comment">// æ¨¡æ‹Ÿæ¶ˆè´¹ä¸€ä¸ªäº§å“</span></span><br><span class="line">        <span class="comment">// å°† printf ä¹Ÿæ”¾åœ¨é”çš„èŒƒå›´ï¼Œè¿™æ ·æ‰èƒ½è§‚å¯Ÿåˆ°äº§å“æ˜¯åç”Ÿäº§å…ˆè¢«æ¶ˆè´¹</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;consumer %lu --- product %d\n&quot;</span>, pthread_self(), p-&gt;num);</span><br><span class="line">        pthread_mutex_unlock(&amp;lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(p);</span><br><span class="line">        sleep(rand() % <span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        p = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> msg));</span><br><span class="line">        p-&gt;num = rand() % <span class="number">1000</span> + <span class="number">1</span>;    <span class="comment">// æ¨¡æ‹Ÿç”Ÿäº§ä¸€ä¸ªäº§å“</span></span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;lock);</span><br><span class="line">        <span class="comment">// å°† printf ä¹Ÿæ”¾åœ¨é”çš„èŒƒå›´ï¼Œè¿™æ ·æ‰èƒ½è§‚å¯Ÿåˆ°äº§å“æ˜¯åç”Ÿäº§å…ˆè¢«æ¶ˆè´¹</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;producer %lu --- product %d\n&quot;</span>, pthread_self(), p-&gt;num);</span><br><span class="line">        p-&gt;next = product;</span><br><span class="line">        product = p;    <span class="comment">// è¿™ç§å®ç°æ˜¯æ ˆçš„æ–¹å¼ï¼Œåç”Ÿäº§çš„äº§å“å…ˆå‡º</span></span><br><span class="line">        pthread_mutex_unlock(&amp;lock);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†ä¸€ä¸ªé˜»å¡åœ¨è¯¥æ¡ä»¶å˜é‡ä¸Šçš„çº¿ç¨‹å”¤é†’</span></span><br><span class="line">        <span class="comment">// pthread_cond_signal(&amp;has_product);</span></span><br><span class="line">        pthread_cond_broadcast(&amp;has_product);</span><br><span class="line">        sleep(rand() % <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> cons, prod;</span><br><span class="line">    pthread_create(&amp;prod, <span class="literal">NULL</span>, producer, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;cons, <span class="literal">NULL</span>, consumer, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">pthread_t</span> cons1, cons2; <span class="comment">// æ¨¡æ‹Ÿå¤šæ¶ˆè´¹è€…</span></span><br><span class="line">    pthread_create(&amp;cons1, <span class="literal">NULL</span>, consumer, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;cons2, <span class="literal">NULL</span>, consumer, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(cons1, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(cons2, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(prod, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(cons, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="sem-ä¿¡å·é‡"><a href="#sem-ä¿¡å·é‡" class="headerlink" title="sem ä¿¡å·é‡"></a>sem ä¿¡å·é‡</h2><p>è¿›åŒ–ç‰ˆçš„äº’æ–¥é”ï¼ŒåŠ é”çš„çº¿ç¨‹æ•°é‡ N å¯ä»¥è‡ªå®šä¹‰ï¼Œå³åŒæ—¶è®¿é—®æ•°æ®çš„çº¿ç¨‹æ•°é‡å¯ä»¥ä¸º Nã€‚</p><p><strong>åˆå€¼ä¸ºNï¼Œå¹¶ä¸æ˜¯æœ€å¤§å€¼ä¸ºNï¼Œä½†è‹¥è°ƒç”¨sem_postï¼ŒNå€¼è¿˜ä¼šå˜å¤§ï¼</strong></p><p>åŒæ ·æ˜¯å»ºè®®é”ï¼Œè™½ç„¶æ”¯æŒå¤šæ¬¡åŠ é”ï¼Œä½†ä¿¡å·é‡æœ¬èº«å¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¸ç´Šä¹±ï¼Œè€Œæ˜¯éœ€è¦åº•å±‚æ•°æ®ç»“æ„æ”¯æŒå¹¶å‘æ“ä½œã€‚</p><p><strong>ä¿¡å·å’Œä¿¡å·é‡æ¯«æ— å…³ç³»ï¼ï¼</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_init</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">int</span> pshared, <span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_destroy</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_wait</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_trywait</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_timedwait</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">const</span> <span class="keyword">struct</span> timespec *abs_timeout)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_post</span><span class="params">(<span class="type">sem_t</span> *sem)</span>;</span><br></pre></td></tr></table></figure><p>ä¿¡å·é‡å¯ä»¥åº”ç”¨ä¸çº¿ç¨‹ã€<strong>è¿›ç¨‹</strong>ä¹‹é—´çš„åŒæ­¥ï¼</p><h3 id="sem-init-å‡½æ•°"><a href="#sem-init-å‡½æ•°" class="headerlink" title="sem_init å‡½æ•°"></a>sem_init å‡½æ•°</h3><p>åˆå§‹åŒ–ä¿¡å·é‡ï¼Œå¯ä»¥è®¾ç½®æ˜¯å¦å…±äº«ï¼Œä»¥åŠåˆå§‹å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sem_init</span><span class="params">(<span class="type">sem_t</span> *sem, <span class="type">int</span> pshared, <span class="type">unsigned</span> <span class="type">int</span> value)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>sem</code>ï¼šä¿¡å·é‡çš„åœ°å€</li><li><code>pshared</code>ï¼šæ˜¯å¦å…±äº«ï¼Œ<code>0</code>ï¼ˆç”¨äºçº¿ç¨‹é—´åŒæ­¥ï¼‰ï¼Œ<code>1</code>ï¼ˆ<strong>ç”¨äºè¿›ç¨‹é—´åŒæ­¥ï¼Œåœ¨è¿›ç¨‹é—´å…±äº«</strong>ï¼‰</li><li><code>value</code>ï¼šN å€¼ï¼Œå¯åŒæ—¶è®¿é—®æ•°æ®çš„çº¿ç¨‹æ•°é‡.</li><li>è¿”å›å€¼ï¼š0ï¼ˆæˆåŠŸï¼‰ï¼Œ-1ï¼ˆå¤±è´¥ï¼‰</li></ul><h3 id="3ç±»ä¿¡å·é‡"><a href="#3ç±»ä¿¡å·é‡" class="headerlink" title="3ç±»ä¿¡å·é‡"></a>3ç±»ä¿¡å·é‡</h3><p>ä¿¡å·é‡æœ‰ä¸‰ç§ç±»å‹ï¼š</p><ul><li><strong>Posâ…¸ æœ‰åä¿¡å·é‡</strong>ï¼šå¯ç”¨äºè¿›ç¨‹æˆ–çº¿ç¨‹é—´çš„åŒæ­¥ã€‚</li><li><strong>Posix æ— åä¿¡å·é‡</strong>ï¼šåŸºäºå†…å­˜çš„ä¿¡å·é‡ï¼Œå­˜æ”¾åœ¨å†…å­˜åŒºä¸­ï¼Œå¯ç”¨äºè¿›ç¨‹æˆ–çº¿ç¨‹é—´çš„åŒæ­¥ã€‚<strong>å¸¸ç”¨äºå¤šçº¿ç¨‹é—´åŒæ­¥</strong>ã€‚</li><li><strong>System Vä¿¡å·é‡ï¼ˆIPCæœºåˆ¶ï¼‰</strong>ï¼š<strong>åœ¨å†…æ ¸ä¸­ç»´æŠ¤</strong>ï¼Œå¯ç”¨äºè¿›ç¨‹æˆ–çº¿ç¨‹é—´çš„åŒæ­¥ã€‚å¸¸ç”¨äºè¿›ç¨‹é—´åŒæ­¥ã€‚</li></ul><p>åœ¨å¤šçº¿ç¨‹ä¸‹ï¼Œå…¨å±€å˜é‡å¯åœ¨çº¿ç¨‹é—´å…±äº«ï¼Œå› æ­¤å°†ä¿¡å·é‡è®¾ç½®ä¸ºå…¨å±€å˜é‡å³å¯ã€‚ä½†åœ¨å¤šè¿›ç¨‹ç¯å¢ƒä¸‹ï¼Œæ¯ä¸ªè¿›ç¨‹é—´å¹¶ä¸å…±äº«å˜é‡ï¼è¿™ä¸‰ç±»ä¿¡å·é‡çš„å…±äº«æœºåˆ¶ä¸ºï¼š</p><ul><li><strong>æœ‰åä¿¡å·é‡</strong>é€šè¿‡æ–‡ä»¶ç³»ç»Ÿä¸­çš„<strong>è·¯å¾„åå¯¹åº”çš„æ–‡ä»¶å</strong>è¿›è¡Œç»´æŠ¤ï¼ˆ<strong>ä¿¡å·é‡åªæ˜¯é€šè¿‡æ–‡ä»¶åè¿›è¡Œæ ‡è¯†</strong>ï¼Œä¿¡å·é‡çš„å€¼å¹¶ä¸å­˜æ”¾åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œé™¤éä¿¡å·é‡å­˜æ”¾åœ¨ç©ºé—´æ˜ å°„åˆ°è¿™ä¸ªæ–‡ä»¶ä¸Šï¼‰ã€‚</li><li><strong>æ— åä¿¡å·é‡</strong>é€šè¿‡ç”¨æˆ·ç©ºé—´å†…å­˜è¿›è¡Œç»´æŠ¤ï¼Œæ— åä¿¡å·é‡è¦æƒ³åœ¨è¿›ç¨‹é—´é€šä¿¡ï¼Œ<strong>è¯¥å†…å­˜å¿…é¡»ä¸ºå…±äº«å†…å­˜åŒº</strong>*ã€‚å¦‚ä¸Šé¢çš„<code>pshared</code>å‚æ•°ï¼</li><li><strong>System Vä¿¡å·é‡ï¼ˆIPCæœºåˆ¶ï¼‰</strong>å¹¶ä¸åœ¨ç”¨æˆ·ç©ºé—´åˆ›å»ºï¼Œå®ƒç”±å†…æ ¸ç»´æŠ¤ã€‚å®ƒçš„æ ‡è¯†æ˜¯ä½¿ç”¨<code>IPC Key</code>ï¼</li></ul><h3 id="ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°2"><a href="#ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°2" class="headerlink" title="ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°2"></a>ç”Ÿäº§è€…æ¶ˆè´¹è€…å®ç°2</h3><p>è¿™ä¸ªä¸ä¸Šé¢åŸºäºæ¡ä»¶å˜é‡çš„å®ç°é€»è¾‘ä¸åŒï¼Œå»ºè®®å…ˆçœ‹è§†é¢‘<a href="https://www.bilibili.com/video/BV1KE411q7ee?p=183&spm_id_from=pageDriver">åŸºäºä¿¡å·é‡å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</a>ç†è§£å®ç°çš„åŸç†ï¼Œå†çœ‹å…·ä½“å®ç°ä»£ç ã€‚</p><p>æ³¨æ„ï¼Œå¯¹ä¿¡å·é‡åˆå§‹åŒ–æ—¶ï¼Œå°† <code>product_num</code> åˆå§‹åŒ–ä¸º0ï¼Œä½†ä»ç„¶å¯ä»¥è°ƒç”¨<code>sem_post</code>, <code>sem_wait</code>ç­‰å‡½æ•°ï¼Œè¿™ä¸ä¸Šé¢æ‰€è¯´çš„æœ€å¤šåªèƒ½æœ‰ N (è¿™é‡Œä¸º0) æ˜¯ä¸æ˜¯çŸ›ç›¾?æ€ä¹ˆå®ç°å¤šä¸ªæ¶ˆè´¹è€…ï¼Ÿ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM 10</span></span><br><span class="line"></span><br><span class="line"><span class="type">sem_t</span> blank_num;</span><br><span class="line"><span class="type">sem_t</span> product_num;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> products[NUM];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">producer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        sem_wait(&amp;blank_num);   <span class="comment">// ç©ºæ ¼ä¸ºç©ºæ—¶é˜»å¡ blank_num--</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç”Ÿäº§ä¸€ä¸ªäº§å“</span></span><br><span class="line">        products[i] = rand() % <span class="number">1000</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;produce product: %d in index: %d\n&quot;</span>, products[i], i);</span><br><span class="line">        sem_post(&amp;product_num); <span class="comment">// product_num++</span></span><br><span class="line"></span><br><span class="line">        i = (i+<span class="number">1</span>) % NUM;    <span class="comment">// ç¯å½¢é˜Ÿåˆ—</span></span><br><span class="line">        sleep(rand() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">consumer</span><span class="params">(<span class="type">void</span> *arg)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        sem_wait(&amp;product_num); <span class="comment">// å½“äº§å“ä¸ºç©ºæ—¶é˜»å¡ product_num--</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¶ˆè´¹äº§å“</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;consume product: %d in index: %d\n&quot;</span>, products[i], i);</span><br><span class="line">        sem_post(&amp;blank_num);   <span class="comment">// blank_num++</span></span><br><span class="line"></span><br><span class="line">        i = (i+<span class="number">1</span>) % NUM;</span><br><span class="line">        sleep(rand() % <span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> prod, cons;</span><br><span class="line"></span><br><span class="line">    sem_init(&amp;product_num, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    sem_init(&amp;blank_num, <span class="number">0</span>, NUM);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;prod, <span class="literal">NULL</span>, producer, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;cons, <span class="literal">NULL</span>, consumer, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    pthread_join(prod, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_join(cons, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯¹æ¯”æ€»ç»“"><a href="#å¯¹æ¯”æ€»ç»“" class="headerlink" title="å¯¹æ¯”æ€»ç»“"></a>å¯¹æ¯”æ€»ç»“</h2><table><thead><tr><th>pthread_mutex_t</th><th>pthread_rwlock_t</th><th>pthread_cond_t</th><th>sem_t</th></tr></thead><tbody><tr><td>pthread_mutex_init</td><td>pthread_rwlock_init</td><td>pthread_cond_init</td><td>sem_init</td></tr><tr><td>pthread_mutex_lock</td><td>pthread_rwlock_wrlock<br />pthread_rwlock_rdlock</td><td>pthread_cond_wait</td><td>sem_wait</td></tr><tr><td>pthread_mutex_trylock</td><td>pthread_rwlock_trywrlock<br />pthread_rwlock_tryrdlock</td><td></td><td>sem_trywait</td></tr><tr><td></td><td></td><td>pthread_cond_timedwait</td><td>sem_timedwait</td></tr><tr><td>pthread_mutex_unlock</td><td>pthread_rwlock_unlock</td><td>pthread_cond_signal<br />pthread_cond_broadcast</td><td>sem_post</td></tr><tr><td>pthread_mutex_destroy</td><td>pthread_rwlock_destroy</td><td>pthread_cond_destroy</td><td>sem_destroy</td></tr></tbody></table><p>ä¸‹é¢çš„æ–¹æ³•æœ‰åŠ©äºç†è§£å…¶å®ç°åŸç†ï¼Œä½†ä¸æ˜¯çœŸå®æƒ…å†µï¼š</p><ul><li><code>mutex</code>å¯ä»¥çœ‹ä½œä¸€ä¸ªæ•´æ•°ï¼Œä¸”åªæœ‰ä¸¤ç§å–å€¼ï¼š0å’Œ1ã€‚<ul><li>init ï¼šå°† <code>i</code> çš„å€¼è®¾ç½®ä¸º1ã€‚</li><li>lock ï¼šç›¸å½“äº <code>i--</code>ï¼Œå°† <code>i</code> çš„å€¼ä» 1 å˜ä¸º 0ã€‚å¦‚æœ <code>i</code> ä¸º0ï¼Œåˆ™é˜»å¡ã€‚</li><li>unlock ï¼šç›¸å½“äº <code>i++</code>ï¼Œè‹¥ i å·²ç»ä¸º 1ï¼Œi å°†ä¸ä¼šå˜åŒ–ã€‚</li></ul></li><li><code>sem</code> ç›¸å½“äºåˆå€¼ä¸º N çš„äº’æ–¥é‡<ul><li>init ï¼šåˆå§‹åŒ– <code>i</code>ï¼Œåˆå§‹å€¼ä¸º Nã€‚</li><li>wait ï¼šç›¸å½“äº <code>i--</code>ï¼Œè‹¥ <code>i</code> ä¸º0ï¼Œåˆ™é˜»å¡ã€‚</li><li>post ï¼šç›¸å½“äº <code>i++</code>ï¼Œè‹¥ <code>i</code> å·²ç»è¾¾åˆ° Nï¼Œè¿˜æ˜¯ä¼š <code>++</code>ï¼ï¼ˆæ³¨æ„ä¸ <code>mutex</code> åŒºåˆ†ï¼‰</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mutex</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_mutex_t</span> m;</span><br><span class="line">    pthread_mutex_init(&amp;m, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_mutex_unlock(&amp;m);</span><br><span class="line">    pthread_mutex_lock(&amp;m);     <span class="built_in">printf</span>(<span class="string">&quot;lock 1\n&quot;</span>);</span><br><span class="line">    pthread_mutex_lock(&amp;m);     <span class="built_in">printf</span>(<span class="string">&quot;lock 2\n&quot;</span>); <span class="comment">// é˜»å¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// sem</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">sem_t</span> s;</span><br><span class="line">    sem_init(&amp;s, <span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">    sem_post(&amp;s);</span><br><span class="line">    sem_wait(&amp;s);   <span class="built_in">printf</span>(<span class="string">&quot;wait 1\n&quot;</span>);</span><br><span class="line">    sem_wait(&amp;s);   <span class="built_in">printf</span>(<span class="string">&quot;wait 2\n&quot;</span>);</span><br><span class="line">    sem_wait(&amp;s);   <span class="built_in">printf</span>(<span class="string">&quot;wait 3\n&quot;</span>);</span><br><span class="line">    sem_wait(&amp;s);   <span class="built_in">printf</span>(<span class="string">&quot;wait 4\n&quot;</span>);</span><br><span class="line">    sem_wait(&amp;s);   <span class="built_in">printf</span>(<span class="string">&quot;wait 5\n&quot;</span>); <span class="comment">// é˜»å¡</span></span><br><span class="line">    sem_destroy(&amp;s);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å†…æ ¸é”"><a href="#å†…æ ¸é”" class="headerlink" title="å†…æ ¸é”"></a>å†…æ ¸é”</h2><p>ä¸Šé¢å‡ ç§é”éƒ½æ˜¯åœ¨ç”¨æˆ·æ€ä½¿ç”¨ï¼Œåœ¨å†…æ ¸ä¸­ï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„å®ç°ã€‚</p><table><thead><tr><th>å¤´æ–‡ä»¶</th><th>ç»“æ„</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>&lt;asm/semaphore.h&gt;</code></td><td><code>struct semaphore</code></td><td>ä¿¡å·é‡&#x2F;äº’æ–¥é‡</td></tr><tr><td><code>&lt;linux/rwsem.h&gt;</code></td><td><code>struct rw_semaphore</code></td><td>è¯»å†™é”</td></tr><tr><td><code>&lt;linux/completion.h&gt;</code></td><td><code>struct completion</code></td><td>ç±»ä¼¼æ¡ä»¶å˜é‡</td></tr><tr><td><code>&lt;linux/spinlock.h&gt;</code></td><td><code>spinlock_t</code></td><td>è‡ªæ—‹é”</td></tr><tr><td><code>&lt;linux/spinlock.h&gt;</code></td><td><code>rwlock_t</code></td><td>è‡ªæ—‹è¯»å†™é”</td></tr></tbody></table><p>åŠ é”æ€»ä¼šå½±å“ç³»ç»Ÿçš„æ€§èƒ½ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹å¯ä»¥è€ƒè™‘ä¸åŠ é”çš„ç®—æ³•ï¼å¦‚ï¼šç¯å½¢é˜Ÿåˆ—ã€åŸå­å˜é‡ã€ä½æ“ä½œã€é¡ºåºé”<code>seqlock</code>ã€è¯»å–-æ‹·è´-æ›´æ–°(RCU)ã€‚</p><h2 id="é”é™·é˜±"><a href="#é”é™·é˜±" class="headerlink" title="é”é™·é˜±"></a>é”é™·é˜±</h2><ol><li>ä¸å…è®¸ä¸€ä¸ªæŒé”è€…ç¬¬ 2 æ¬¡è¯·æ±‚é”ï¼</li><li>è·å¾—å¤šä¸ªé”å¯èƒ½æ˜¯å±é™©çš„ï¼Œå½“å¤šä¸ªé”å¿…é¡»è·å¾—æ—¶ï¼Œå®ƒä»¬åº”å½“ä¸€ç›´ä»¥åŒæ ·é¡ºåºè·å¾—ï¼</li><li>å°½é‡ä¿è¯é”çš„ç²’åº¦ï¼Œè¶Šå°è¶Šå¥½ï¼ˆè®¿é—®å…±äº«æ•°æ®å‰ï¼ŒåŠ é”ï¼Œè®¿é—®ç»“æŸç«‹å³è§£é”ï¼‰ã€‚</li></ol><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=172&spm_id_from=pageDriver">è¯»å†™é”ä¼˜å…ˆçº§</a></li><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=176&t=290.8">æ¡ä»¶å˜é‡åŸç†</a></li><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=180&t=471.6">ç”Ÿäº§è€…-å¤šä¸ªæ¶ˆè´¹è€…</a></li><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=183&spm_id_from=pageDriver">åŸºäºä¿¡å·é‡å®ç°ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹</a></li><li>ã€ŠLinux è®¾å¤‡é©±åŠ¨ç¨‹åºã€‹</li><li><a href="https://blog.csdn.net/qq_28812525/article/details/105229968">ä¿¡å·é‡ç±»å‹</a></li><li>ã€ŠLinux&#x2F;UNIXç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œâ€“45.2&#x2F;47ã€‹</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> åŒæ­¥ </tag>
            
            <tag> é” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-çº¿ç¨‹</title>
      <link href="/2022/05/04/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B/"/>
      <url>/2022/05/04/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<h2 id="çº¿ç¨‹æ¦‚å¿µ"><a href="#çº¿ç¨‹æ¦‚å¿µ" class="headerlink" title="çº¿ç¨‹æ¦‚å¿µ"></a>çº¿ç¨‹æ¦‚å¿µ</h2><blockquote><p>è™½ç„¶å¯ä»¥ä½¿ç”¨è¯¸å¤šè¿›ç¨‹æ¥ç›¸äº’åä½œå®ç°éœ€è¦å¹¶å‘æ‰èƒ½å®Œæˆçš„åŠŸèƒ½ï¼Œä½†è¿›ç¨‹é—´çš„åä½œæœ‰ç€é‡è¦çš„é™åˆ¶ï¼š<strong>æ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´</strong>ã€‚è¿™ç§é™åˆ¶å¯¼è‡´è¿›ç¨‹ä¹‹é—´çš„åä½œå­˜åœ¨æ˜æ˜¾ç¼ºé™·ï¼šå¦‚æœç›¸äº’åä½œçš„è¿›ç¨‹éœ€è¦åŠ¨æ€å…±äº«å¤§é‡çš„æ•°æ®ï¼Œåˆ™æ“ä½œèµ·æ¥ååˆ†éº»çƒ¦ã€‚å°±åƒä¸€ç¾¤äººä¹‹é—´çš„åä½œä¸€æ ·ï¼Œç”±äºæ¯ä¸ªäººéƒ½æ˜¯ç‹¬ç«‹çš„ä¸ªä½“ï¼Œå„æœ‰ä¸åŒçš„å–œå¥½å’Œä¹ æƒ¯ï¼Œåä½œéš¾å…äº§ç”Ÿè¯¯è§£å’Œæ²Ÿé€šå›°éš¾ã€‚å¦‚æœä¸€ä»¶äº‹æƒ…è®©ä¸€ä¸ªäººæ¥å¤„ç†ï¼Œåä½œä¸Šå°±ä¸ä¼šå‘ç”Ÿé—®é¢˜ã€‚å› æ­¤ï¼Œå¦‚æœèƒ½å¤Ÿè®©ä¸€ä¸ªè¿›ç¨‹å†…éƒ¨å®ç°å¹¶å‘æ¥å®Œæˆä¸€ä¸ªå¤æ‚çš„ä»»åŠ¡ï¼Œåä½œä¸Šçš„éš¾åº¦å°±ä¼šå°‘å¾ˆå¤šã€‚</p><p>åœ¨è¿›ç¨‹å†…éƒ¨å®ç°å¹¶å‘å°±æ˜¯è¿›ç¨‹å‡ºç°çš„åŠ¨æœºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B/image-20221128233112246.png" alt="image-20221128233112246"></p></blockquote><p>Linux ä¸‹ï¼Œçº¿ç¨‹åˆç§°ä¸º<code>LWP: light weight process</code>ï¼Œè½»é‡çº§è¿›ç¨‹ã€‚</p><table><thead><tr><th>è¿›ç¨‹</th><th>çº¿ç¨‹</th></tr></thead><tbody><tr><td><strong>æœ‰ç‹¬ç«‹çš„è¿›ç¨‹åœ°å€ç©ºé—´</strong></td><td>æ²¡æœ‰ç‹¬ç«‹çš„åœ°å€ç©ºé—´ï¼Œå¤šä¸ªçº¿ç¨‹å…±äº«</td></tr><tr><td>æœ‰ç‹¬ç«‹çš„ PCB</td><td>æœ‰ç‹¬ç«‹çš„ PCB ï¼ˆä½†PCBä¸­æŒ‡å‘å†…å­˜èµ„æºçš„ä¸‰çº§é¡µè¡¨ç›¸åŒï¼‰</td></tr><tr><td>åˆ†é…èµ„æºçš„æœ€å°å•ä½</td><td>CPU æ‰§è¡Œçš„æœ€å°å•ä½</td></tr><tr><td>æŸ¥çœ‹ <code>ps aux / ps ajx</code></td><td>æŸ¥çœ‹çº¿ç¨‹å· <code>ps -Lf è¿›ç¨‹id</code></td></tr></tbody></table><p><strong>ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ UNIX è¿›ç¨‹åªæ˜¯å¤šçº¿ç¨‹ç¨‹åºçš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œè¯¥è¿›ç¨‹åªåŒ…å«ä¸€ä¸ªçº¿ç¨‹ã€‚</strong></p><p>è¿›ç¨‹ä¸­åˆ›å»ºçº¿ç¨‹åï¼ŒåŸè¿›ç¨‹ä¹Ÿé™ä¸ºçº¿ç¨‹äº†ï¼è¿›ç¨‹ç›¸å½“äºç‹¬å±…ï¼Œåˆ›å»ºçº¿ç¨‹åå°±å˜æˆåˆç§Ÿï¼ˆå…±äº«åœ°å€ç©ºé—´ï¼‰ã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B/image-20220504212829735.png" alt="image-20220504212829735"></p><p>çº¿ç¨‹æ˜¯ CPU æ‰§è¡Œçš„æœ€å°å•ä½ï¼Œä»¥ä¸‹å›¾ä¸ºä¾‹ï¼ŒAåˆ†é…çš„CPUæ—¶é—´ä¸º<code>3/5</code>ï¼Œè€Œ B, C å„åªæœ‰ <code>1/5</code>ã€‚ä½†ä¹Ÿä¸æ˜¯è¯´çº¿ç¨‹è¶Šå¤šè¶Šå¥½ï¼Œå¦‚ä¸‹å›¾å³ä¸ºçš„æ›²çº¿ã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E7%BA%BF%E7%A8%8B/image-20220504213809444.png" alt="image-20220504213809444"></p><h3 id="çº¿ç¨‹å…±äº«èµ„æº"><a href="#çº¿ç¨‹å…±äº«èµ„æº" class="headerlink" title="çº¿ç¨‹å…±äº«èµ„æº"></a>çº¿ç¨‹å…±äº«èµ„æº</h3><ol><li>æ–‡ä»¶æè¿°ç¬¦è¡¨</li><li>æ¯ç§ä¿¡å·çš„å¤„ç†æ–¹å¼</li><li>å½“å‰å·¥ä½œç›®å½•</li><li>ç”¨æˆ· ID å’Œç»„ ID</li><li>å†…å­˜åœ°å€ç©ºé—´ (text&#x2F;data&#x2F;bss&#x2F;heap&#x2F;å…±äº«åº“ <strong>å…¨å±€å˜é‡</strong>)ï¼Œä¸åŒ…æ‹¬æ ˆã€‚</li></ol><h3 id="çº¿ç¨‹éå…±äº«èµ„æº"><a href="#çº¿ç¨‹éå…±äº«èµ„æº" class="headerlink" title="çº¿ç¨‹éå…±äº«èµ„æº"></a>çº¿ç¨‹éå…±äº«èµ„æº</h3><ol><li>çº¿ç¨‹ ID</li><li>å¤„ç†å™¨ç°åœºå’Œæ ˆæŒ‡é’ˆï¼ˆå†…æ ¸æ ˆï¼‰</li><li>ç‹¬ç«‹çš„æ ˆç©ºé—´ï¼ˆç”¨æˆ·ç©ºé—´æ ˆï¼‰</li><li>errno å˜é‡</li><li>ä¿¡å·å±è”½å­—</li><li>è°ƒåº¦ä¼˜å…ˆçº§</li></ol><h3 id="çº¿ç¨‹çš„ä¼˜ç¼ºç‚¹"><a href="#çº¿ç¨‹çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="çº¿ç¨‹çš„ä¼˜ç¼ºç‚¹"></a>çº¿ç¨‹çš„ä¼˜ç¼ºç‚¹</h3><p>ä¼˜ç‚¹ï¼š</p><ol><li>æé«˜ç¨‹åºå¹¶å‘æ€§</li><li>å¼€é”€å°</li><li>æ•°æ®é€šä¿¡ã€å…±äº«æ•°æ®æ–¹ä¾¿ã€‚åªéœ€å°†æ•°æ®å¤åˆ¶åˆ°å…±äº«ï¼ˆå…¨å±€æˆ–å †ï¼‰å˜é‡ä¸­å³å¯ã€‚</li></ol><p>ç¼ºç‚¹ï¼š</p><ol><li>åº“å‡½æ•°ï¼Œä¸ç¨³å®š</li><li>è°ƒè¯•ã€ç¼–å†™å›°éš¾ã€gdb ä¸æ”¯æŒ</li><li>å¯¹ä¿¡å·æ”¯æŒä¸å¥½ã€‚</li></ol><p>ä¼˜ç‚¹ç›¸å¯¹çªå‡ºï¼Œç¼ºç‚¹å‡ä¸æ˜¯ç¡¬ä¼¤ã€‚Linux ä¸‹ç”±äºå®ç°æ–¹æ³•å¯¼è‡´è¿›ç¨‹ã€çº¿ç¨‹å·®åˆ«ä¸æ˜¯å¾ˆå¤§ã€‚</p><h2 id="å¸¸ç”¨-API"><a href="#å¸¸ç”¨-API" class="headerlink" title="å¸¸ç”¨ API"></a>å¸¸ç”¨ API</h2><p>çº¿ç¨‹ç›¸å…³çš„å‡½æ•°çš„<code>man page</code>å¯èƒ½éœ€è¦é¢å¤–ä¸‹è½½ï¼Œ<code>sudo apt install manpages-posix manpages-posix-dev</code>ï¼Œä¹Ÿå¯é€šè¿‡<code>man -k pthread</code>æŸ¥çœ‹ç›¸å…³çš„å‡½æ•°ã€‚</p><blockquote><p>é™¤äº†ä¸Šé¢ä¸‹è½½<code>manpage</code>ï¼Œä¹Ÿå¯ä»¥<a href="https://man7.org/linux/man-pages/index.html">åœ¨çº¿æŸ¥çœ‹manpage</a></p><p><code>Pthread</code>ç›¸å…³çš„æºç ä¹Ÿå¯<a href="https://sourceware.org/git/?p=glibc.git;a=tree;f=nptl;h=d0ce23d37e9b77d6ff82ffdee0f7a1f8f137aa41;hb=HEAD">åœ¨çº¿æŸ¥çœ‹</a></p><p><a href="https://elixir.bootlin.com/glibc/glibc-2.36/source">glibc source code</a></p></blockquote><h3 id="pthread-self"><a href="#pthread-self" class="headerlink" title="pthread_self"></a>pthread_self</h3><p>è·å–çº¿ç¨‹ idï¼Œç±»ä¼¼ä¸è¿›ç¨‹ä¸­çš„ <code>getpid()</code>ï¼</p><p>çº¿ç¨‹ id æ˜¯åœ¨<strong>è¿›ç¨‹åœ°å€ç©ºé—´å†…éƒ¨</strong>ï¼Œç”¨æ¥æ ‡è¯†çº¿ç¨‹èº«ä»½çš„ idã€‚é€šè¿‡ <code>ps -LF è¿›ç¨‹id</code> å¾—åˆ°çš„æ˜¯çº¿ç¨‹å·<code>LWP</code>ï¼Œæ˜¯æ“ä½œç³»ç»Ÿç”¨æ¥åŒºåˆ†ä»¥åˆ†é…CPUèµ„æºæ ‡è¯†ï¼Œä¸è¿›ç¨‹IDçš„åŠŸèƒ½ç±»ä¼¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_t</span> <span class="title function_">pthread_self</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><ul><li>è¿”å›å€¼ï¼šçº¿ç¨‹ id</li></ul><h3 id="pthread-create"><a href="#pthread-create" class="headerlink" title="pthread_create"></a>pthread_create</h3><p>åˆ›å»ºçº¿ç¨‹ï¼Œç¼–è¯‘å’Œé“¾æ¥æ—¶åŠ  <code>-lpthread</code>ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_create</span><span class="params">(<span class="type">pthread_t</span> *thread, <span class="type">const</span> <span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                    <span class="type">void</span> *(*start_routine) (<span class="type">void</span> *), <span class="type">void</span> *arg)</span>;</span><br></pre></td></tr></table></figure><ul><li>threadï¼šçº¿ç¨‹ idï¼Œä¼ å‡ºå‚æ•°</li><li>attr: çº¿ç¨‹å±æ€§ï¼Œé»˜è®¤ä¸º NULL</li><li>start_routineï¼šçº¿ç¨‹å…¥å£å‡½æ•°ï¼Œå‡½æ•°åŸå‹è¦ä¸ <code>void *(*start_routine) (void *arg)</code> ä¸€è‡´</li><li>argï¼šä¸Šä¸€ä¸ªå‚æ•°â€œä¼ å…¥çº¿ç¨‹å…¥å£å‡½æ•°â€çš„å‚æ•°</li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 å¤±è´¥ï¼Œè¿”å›çš„æ˜¯ errno</li></ul><p>å¾ªç¯åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is %dth thread, pid = %d, tid = %ld\n&quot;</span>, (<span class="type">int</span>)arg, getpid(), pthread_self());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> ret, i;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        ret = pthread_create(&amp;tid, <span class="literal">NULL</span>, thread_func, (<span class="type">void</span> *)i);</span><br><span class="line">        <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;pthread_create error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;main: pid = %d, tid = %ld\n&quot;</span>, getpid(), pthread_self());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢çš„ä»£ç ä¸­ï¼Œçº¿ç¨‹å…¥å£å‡½æ•°çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•´å‹å˜é‡ï¼Œè€Œä¸æ˜¯æŒ‡é’ˆï¼</p><p>é€šè¿‡å€¼ä¼ é€’ï¼Œé¿å…ä¸ä¸»çº¿ç¨‹ä¸­çš„å˜é‡å†²çªã€‚è‹¥ä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå› ä¸ºçº¿ç¨‹åˆ›å»ºéœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œè€Œè¿™æ®µæ—¶é—´å†…ï¼Œä¸»çº¿ç¨‹å¯èƒ½ä¼šæ”¹å˜è¿™ä¸ªæŒ‡é’ˆçš„å€¼ã€‚å¯¼è‡´ç»“æœä¸é¢„æœŸä¸ä¸€è‡´ã€‚</p><p>æ£€æŸ¥çº¿ç¨‹è¿”å›é”™è¯¯å·ï¼Œä¸èƒ½ä½¿ç”¨ <code>perror()</code>ï¼Œåªèƒ½ç”¨ <code>strerror()</code>ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;pthread_create error: %s\n&quot;</span>, strerror(ret));</span><br></pre></td></tr></table></figure><h3 id="pthread-exit"><a href="#pthread-exit" class="headerlink" title="pthread_exit"></a>pthread_exit</h3><p>åœ¨çº¿ç¨‹å‡½æ•°å‡½æ•°å†…éƒ¨è°ƒç”¨ï¼Œç›´æ¥ç»“æŸå½“å‰çº¿ç¨‹ï¼Œå¯è®¾ç½®çº¿ç¨‹é€€å‡ºå€¼ã€‚ç»“æŸä¹‹åä»ç„¶éœ€è¦ <code>pthread_join</code> å›æ”¶çº¿ç¨‹èµ„æºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_exit</span><span class="params">(<span class="type">void</span> *retval)</span>;</span><br></pre></td></tr></table></figure><ul><li>retvalï¼šé€€å‡ºå€¼ï¼Œæ— åˆ™è®¾ NULL</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i = (<span class="type">int</span>)arg;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">// exit(0);         // é€€å‡ºè¿›ç¨‹ï¼ˆä¼šæŠŠæ‰€æœ‰çº¿ç¨‹éƒ½é€€å‡ºï¼ï¼‰</span></span><br><span class="line">        <span class="comment">// return NULL;     // é€€å‡ºåˆ°è°ƒç”¨è€…</span></span><br><span class="line">        pthread_exit(<span class="literal">NULL</span>); <span class="comment">// é€€å‡ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">        pthread_exit((<span class="type">void</span>*)<span class="number">0</span>); <span class="comment">// è®¾å®šçº¿ç¨‹é€€å‡ºå€¼</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is %dth thread, pid = %d, tid = %ld\n&quot;</span>, i, getpid(), pthread_self());</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="pthread-join"><a href="#pthread-join" class="headerlink" title="pthread_join"></a>pthread_join</h3><p>é˜»å¡å›æ”¶çº¿ç¨‹ï¼Œç±»ä¼¼äºè¿›ç¨‹ä¸­çš„ <code>waitpid()</code>ï¼<strong>æ³¨æ„ï¼Œå›æ”¶çº¿ç¨‹ä¸ä¸€å®šæ˜¯ç”±çˆ¶çº¿ç¨‹å®Œæˆï¼Œå…„å¼Ÿçº¿ç¨‹ä¹‹é—´å¯äº’ç›¸å›æ”¶ï¼</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_join</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">void</span> **retval)</span>;</span><br></pre></td></tr></table></figure><ul><li>retvalï¼šçº¿ç¨‹çš„è¿”å›å€¼ï¼Œä¼ å‡ºå‚æ•°</li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 å¤±è´¥ï¼Œè¿”å›çš„æ˜¯ errno</li></ul><h3 id="pthread-cancel"><a href="#pthread-cancel" class="headerlink" title="pthread_cancel"></a>pthread_cancel</h3><p>æ€æ­»çº¿ç¨‹ï¼Œç±»ä¼¼äºè¿›ç¨‹ä¸­çš„ <code>kill()</code>ï¼</p><p>è¢«æ€æ­»çš„çº¿ç¨‹ä¼šè°ƒç”¨ <code>pthread_exit()</code>ï¼Œå¹¶ä¸”ä¼šè¿”å› <code>PTHREAD_CANCELED</code>ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_cancel</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br></pre></td></tr></table></figure><ul><li>threadï¼šè¦æ€æ­»çš„çº¿ç¨‹ id</li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 å¤±è´¥ï¼Œè¿”å›çš„æ˜¯ errno</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// pthread_testcancel()</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢çš„çº¿ç¨‹å‡½æ•°ä¸­ï¼Œç”±äºæ²¡æœ‰è¿›å…¥ç³»ç»Ÿè°ƒç”¨ï¼Œæ— æ³•ç”¨ <code>pthread_cancel()</code> æ¥æ€æ­»çº¿ç¨‹ï¼</p><p><code>pthread_cancel</code> åªæœ‰çº¿ç¨‹è¿›å…¥ç³»ç»Ÿè°ƒç”¨åï¼Œæ‰èƒ½è¢«æ€æ­»ï¼å¦‚æœå­çº¿ç¨‹é€»è¾‘ä¸Šæ²¡æœ‰è°ƒç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥åœ¨ç¨‹åºä¸­æ‰‹åŠ¨æ·»åŠ å–æ¶ˆç‚¹ <code>pthread_testcancel()</code>ã€‚</p><h3 id="pthread-detach"><a href="#pthread-detach" class="headerlink" title="pthread_detach"></a>pthread_detach</h3><p>è®¾ç½®çº¿ç¨‹åˆ†ç¦»ï¼Œè¿™æ ·çº¿ç¨‹ç»“æŸæ—¶ï¼Œçº¿ç¨‹èµ„æº PCB ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ä¸»çº¿ç¨‹å›æ”¶ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_detach</span><span class="params">(<span class="type">pthread_t</span> thread)</span>;</span><br></pre></td></tr></table></figure><ul><li>threadï¼šè¦åˆ†ç¦»çš„çº¿ç¨‹ id</li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 å¤±è´¥ï¼Œè¿”å›çš„æ˜¯ errno</li></ul><p>åˆ†ç¦»åï¼Œå†æ¬¡è°ƒç”¨ <code>pthread_join()</code> æ—¶ï¼Œä¼šæŠ¥é”™ <code>Invalid argument</code>ï¼</p><h3 id="pthread-cleanup-push-x2F-pop"><a href="#pthread-cleanup-push-x2F-pop" class="headerlink" title="pthread_cleanup_push&#x2F;pop"></a>pthread_cleanup_push&#x2F;pop</h3><p><code>pthread_cleanup_push</code> å’Œ <code>pthread_cleanup_pop</code> æ˜¯ C è¯­è¨€ POSIX çº¿ç¨‹åº“ (pthreads) ä¸­çš„å‡½æ•°ï¼Œå®ƒä»¬ç”¨äºåœ¨çº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨æ‰§è¡Œæ¸…ç†åŠ¨ä½œã€‚</p><ul><li><code>pthread_cleanup_push</code> ç”¨äºæ³¨å†Œæ¸…ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨çº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨ã€‚è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¸…ç†å‡½æ•°çš„åœ°å€ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œè¯¥æŒ‡é’ˆç”¨äºä¼ é€’ç»™æ¸…ç†å‡½æ•°çš„å‚æ•°ã€‚</li><li><code>pthread_cleanup_pop</code> ç”¨äºå¼¹å‡ºæœ€è¿‘æ³¨å†Œçš„æ¸…ç†å‡½æ•°ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ºéé›¶å€¼ï¼Œåˆ™ç«‹å³è°ƒç”¨æ¸…ç†å‡½æ•°ã€‚å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸ºé›¶ï¼Œåˆ™åœ¨çº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨æ¸…ç†å‡½æ•°ã€‚</li></ul><p>åªæœ‰åœ¨<code>push</code>å’Œ<code>pop</code>è¿™ä¸¤ä¸ªå‡½æ•°ä¸­é—´çº¿ç¨‹é€€å‡ºæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œå¯¹åº”çš„æ¸…ç†å‡½æ•°ã€‚é€€å‡ºçš„åŸå› æœ‰ï¼š</p><ul><li>å…¶ä»–çº¿ç¨‹ä½¿ç”¨ <code>pthread_cancel()</code> æ€æ­»äº†æ­¤çº¿ç¨‹ã€‚</li><li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† <code>pthread_exit()</code>ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_cleanup_push</span><span class="params">(<span class="type">void</span> (*routine)(<span class="type">void</span> *),</span></span><br><span class="line"><span class="params">                          <span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pthread_cleanup_pop</span><span class="params">(<span class="type">int</span> execute)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* example */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">cleanup</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Cleaning up: &quot;</span> &lt;&lt; *(<span class="type">int</span> *)arg &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> *i = (<span class="type">int</span> *)arg;</span><br><span class="line"></span><br><span class="line">    pthread_cleanup_push(cleanup, i);</span><br><span class="line">    <span class="type">int</span> cnt = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span>(cnt--) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (cnt == <span class="number">3</span>)</span><br><span class="line">            pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; cnt &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_cleanup_pop(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>routine</code>ï¼šæ¸…ç†å‡½æ•°æŒ‡é’ˆï¼›</li><li><code>arg</code>ï¼šæ¸…ç†å‡½æ•°çš„ä¼ å…¥å‚æ•°ã€‚</li><li><code>execute</code>ï¼šç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå®ƒæ§åˆ¶æ¸…ç†å‡½æ•°æ˜¯åœ¨çº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨ï¼Œè¿˜æ˜¯åœ¨è¯¥å‡½æ•°è¢«è°ƒç”¨æ—¶ç«‹å³è°ƒç”¨ã€‚<ul><li>å¦‚æœç¬¬äºŒä¸ªå‚æ•°ä¸º 0ï¼Œåˆ™åœ¨çº¿ç¨‹é€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨æ¸…ç†å‡½æ•°ã€‚</li><li>å¦‚æœç¬¬äºŒä¸ªå‚æ•°é 0ï¼Œåˆ™åœ¨è¯¥å‡½æ•°è¢«è°ƒç”¨æ—¶ç«‹å³è°ƒç”¨æ¸…ç†å‡½æ•°ã€‚</li></ul></li></ul><h3 id="è¿›ç¨‹çº¿ç¨‹å¯¹æ¯”"><a href="#è¿›ç¨‹çº¿ç¨‹å¯¹æ¯”" class="headerlink" title="è¿›ç¨‹çº¿ç¨‹å¯¹æ¯”"></a>è¿›ç¨‹çº¿ç¨‹å¯¹æ¯”</h3><table><thead><tr><th>è¿›ç¨‹</th><th>çº¿ç¨‹</th></tr></thead><tbody><tr><td><code>fork()</code></td><td><code>pthread_create()</code></td></tr><tr><td><code>getpid()</code></td><td><code>pthread_self()</code></td></tr><tr><td><code>exit()</code></td><td><code>pthread_exit()</code></td></tr><tr><td><code>wait()/waitpid()</code></td><td><code>pthread_join()</code></td></tr><tr><td><code>kill()</code></td><td><code>pthread_cancel()</code></td></tr><tr><td></td><td><code>pthread_detach()</code></td></tr></tbody></table><h2 id="çº¿ç¨‹å±æ€§"><a href="#çº¿ç¨‹å±æ€§" class="headerlink" title="çº¿ç¨‹å±æ€§"></a>çº¿ç¨‹å±æ€§</h2><blockquote><p><a href="https://elixir.bootlin.com/glibc/glibc-2.36/source/sysdeps/nptl/internaltypes.h#L26">pthread_attr</a></p></blockquote><p>åœ¨çº¿ç¨‹åˆ›å»ºæ—¶ï¼Œå°±å¯ä»¥è®¾ç½®çº¿ç¨‹çš„å±æ€§ï¼Œä¸»è¦æœ‰ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pthread_attr</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_param</span>  <span class="title">schedparam</span>;</span>     <span class="comment">/* çº¿ç¨‹çš„è°ƒåº¦å‚æ•°ï¼šä¼˜å…ˆçº§ */</span></span><br><span class="line">    <span class="type">int</span>                 schedpolicy;    <span class="comment">/* çº¿ç¨‹è°ƒåº¦ç­–ç•¥ */</span></span><br><span class="line">    <span class="type">int</span>                 flags;          <span class="comment">/* çº¿ç¨‹çš„åˆ†ç¦»çŠ¶æ€ã€ä½œç”¨åŸŸå±æ€§ */</span></span><br><span class="line">    <span class="type">size_t</span>              guardsize;      <span class="comment">/* çº¿ç¨‹æ ˆæœ«å°¾çš„è­¦æˆ’ç¼“å†²åŒºå¤§å° */</span></span><br><span class="line">    <span class="type">void</span> *              stackaddr;      <span class="comment">/* çº¿ç¨‹æ ˆçš„ä½ç½®ï¼ˆæœ€ä½åœ°å€ï¼‰ */</span></span><br><span class="line">    <span class="type">size_t</span> s            tacksize;       <span class="comment">/* çº¿ç¨‹æ ˆçš„ä½ç½®ï¼ˆæœ€ä½åœ°å€ï¼‰ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Allocated via a call to __pthread_attr_extension once needed.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pthread_attr_extension</span> *<span class="title">extension</span>;</span></span><br><span class="line">    <span class="type">void</span> *unused;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sched_param</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> sched_priority;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pthread_attr_extension</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Affinity map.  */</span></span><br><span class="line">    <span class="type">cpu_set_t</span> *cpuset;</span><br><span class="line">    <span class="type">size_t</span> cpusetsize;</span><br><span class="line"></span><br><span class="line">    <span class="type">sigset_t</span> sigmask;</span><br><span class="line">    <span class="type">bool</span> sigmask_set;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ä¸ç›´æ¥å¯¹çº¿ç¨‹å±æ€§å®ä¾‹è¿›è¡Œä¿®æ”¹ï¼Œè€Œæ˜¯é€šè¿‡æä¾›çš„å‡½æ•°æ¥è®¾ç½®ï¼<strong>ä¸‹é¢ä»‹ç»çš„å‡½æ•°éƒ½æ˜¯å¯¹çº¿ç¨‹å±æ€§å®ä¾‹è¿›è¡Œäº†ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰§è¡Œæ‰§è¡Œå‡½æ•°åä¹Ÿè¿˜æ²¡æœ‰ä»»ä½•ä¸€ä¸ªçº¿ç¨‹å—åˆ°è¿™äº›å±æ€§çš„å½±å“ã€‚åªæœ‰ç”¨è¯¥å®ä¾‹å»åˆ›å»ºæ–°çº¿ç¨‹æ—¶æ‰ç”Ÿæ•ˆ</strong>ã€‚</p><p>å¦‚æœæƒ³ä¿®æ”¹å½“å‰è¿è¡Œä¸­çš„çº¿ç¨‹çš„å±æ€§ï¼Œå¾€å¾€æœ‰å¯¹åº”çš„ä¸å¸¦<code>attr</code>çš„å‡½æ•°ã€‚</p><p><code>man pthread_attr_init</code>ä¸­æœ‰è·å–çº¿ç¨‹å±æ€§å¹¶æ‰“å°è¾“å‡ºçš„ä¾‹å­ï¼Œå¯ä»¥æŸ¥çœ‹çº¿ç¨‹çš„é»˜è®¤å±æ€§ã€‚</p><h3 id="pthread-attr-init-x2F-destroy"><a href="#pthread-attr-init-x2F-destroy" class="headerlink" title="pthread_attr_init&#x2F;destroy"></a>pthread_attr_init&#x2F;destroy</h3><p>å¯¹çº¿ç¨‹å±æ€§å®ä¾‹åˆå§‹åŒ–å’Œé”€æ¯çš„å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pthread_attr_t</span> attr;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_init</span><span class="params">(<span class="type">pthread_attr_t</span> *attr)</span>;    <span class="comment">// åˆå§‹åŒ–çº¿ç¨‹å±æ€§</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_destroy</span><span class="params">(<span class="type">pthread_attr_t</span> *attr)</span>; <span class="comment">// é”€æ¯çº¿ç¨‹å±æ€§</span></span><br></pre></td></tr></table></figure><ul><li>attrï¼šçº¿ç¨‹å±æ€§ç»“æ„ä½“æŒ‡é’ˆ</li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 å¤±è´¥ï¼Œè¿”å›çš„æ˜¯ errno</li></ul><p><code>init</code> ä¸ <code>destroy</code> å‡½æ•°è¦é…å¥—ä½¿ç”¨ï¼Œç±»ä¼¼äº <code>malloc()</code> ä¸ <code>free()</code>ï¼</p><p>å¯ä»¥çœ‹åˆ°ä¸Šé¢<code>pthread_attr</code>çš„ç»“æ„ä½“ä¸­æœ‰æŒ‡é’ˆæˆå‘˜ï¼Œå°±ä¼šæ¶‰åŠåˆ°åŠ¨æ€å†…å­˜åˆ†é…<code>malloc</code>å’Œå†…å­˜é‡Šæ”¾<code>free</code>ï¼Œå› æ­¤æ¯æ¬¡ç”¨å®Œ<code>attr</code>åéœ€è¦è°ƒç”¨<code>destroy</code>é‡Šæ”¾å†…å­˜ï¼Œé¿å…å†…å­˜æ³„éœ²ã€‚</p><h3 id="pthread-attr-setdetachstate-x2F-get"><a href="#pthread-attr-setdetachstate-x2F-get" class="headerlink" title="pthread_attr_setdetachstate&#x2F;get"></a>pthread_attr_setdetachstate&#x2F;get</h3><p>è®¾ç½®çº¿ç¨‹åˆ†ç¦»ï¼Œè¿™æ ·çº¿ç¨‹ç»“æŸæ—¶ï¼Œçº¿ç¨‹èµ„æº PCB ä¼šè¢«è‡ªåŠ¨é‡Šæ”¾ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ä¸»çº¿ç¨‹å›æ”¶ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setdetachstate</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> detachstate)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getdetachstate</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> *detachstate)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>attr</code>ï¼šçº¿ç¨‹å±æ€§ç»“æ„ä½“æŒ‡é’ˆ</li><li><code>detachstate</code>ï¼šçº¿ç¨‹åˆ†ç¦»çŠ¶æ€ï¼Œå¯ä»¥æ˜¯ä»¥ä¸‹å€¼ï¼š<ul><li><code>PTHREAD_CREATE_JOINABLE</code>ï¼šçº¿ç¨‹åˆ†ç¦»çŠ¶æ€ä¸ºéåˆ†ç¦»ï¼ˆé»˜è®¤é€‰é¡¹ï¼‰</li><li><code>PTHREAD_CREATE_DETACHED</code>ï¼šçº¿ç¨‹åˆ†ç¦»çŠ¶æ€ä¸ºåˆ†ç¦»</li></ul></li><li>è¿”å›å€¼ï¼š0 æˆåŠŸï¼Œé 0 å¤±è´¥ï¼Œè¿”å›çš„æ˜¯ <code>errno</code></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">thread_func</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread func. \n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="type">pthread_attr_t</span> attr;</span><br><span class="line">    pthread_attr_init(&amp;attr);</span><br><span class="line">    <span class="comment">// è®¾ç½®çº¿ç¨‹å±æ€§ä¸º åˆ†ç¦»</span></span><br><span class="line">    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> ret = pthread_create(&amp;tid, &amp;attr, thread_func, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pthread_create error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pthread_attr_destroy(&amp;attr);</span><br><span class="line">    ret = pthread_join(tid, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) <span class="comment">// æŠ¥é”™è¯´æ˜è®¾ç½®çº¿ç¨‹åˆ†ç¦»çŠ¶æ€æˆåŠŸ</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pthread join error: %s\n&quot;</span>, strerror(ret));</span><br><span class="line">    <span class="comment">// ä¸»çº¿ç¨‹ç»“æŸï¼Œå­çº¿ç¨‹ä¹Ÿè¢« ç»“æŸï¼</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="pthread-attr-setschedpolicy-x2F-get"><a href="#pthread-attr-setschedpolicy-x2F-get" class="headerlink" title="pthread_attr_setschedpolicy&#x2F;get"></a>pthread_attr_setschedpolicy&#x2F;get</h3><p>è®¾ç½®çº¿ç¨‹è°ƒåº¦çš„ç­–ç•¥ï¼Œæ”¯æŒçš„æœ‰ï¼š<code>SCHED_FIFO</code>, <code>SCHED_RR</code>, <code>SCHED_OTHER</code>ï¼Œå…³äºè¿™å‡ ç§ç­–ç•¥çš„æè¿°è§ï¼š<a href="https://man7.org/linux/man-pages/man7/sched.7.html#DESCRIPTION">man7 sched</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setschedpolicy</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> policy)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getschedpolicy</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> *policy)</span>;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›ï¼Œå¤±è´¥è¿”å›é”™è¯¯å·ã€‚</p><ul><li><code>SCHED_FIFO</code>ï¼šè®¾ç½®äº†è¯¥ç­–ç•¥çš„çº¿ç¨‹ä¼šä¸€ç›´è¿è¡Œï¼Œç›´åˆ°å®ƒè¢«IOé˜»å¡æˆ–è¢«æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹æŠ¢å ï¼Œæˆ–è€…å®ƒè°ƒç”¨<code>sched_yield</code>ã€‚</li><li><code>SCHED_RR</code>ï¼šåŸºäº<code>SCHED_FIFO</code>ï¼Œä½†è®¾ç½®äº†æœ€å¤§æ‰§è¡Œæ—¶é—´<code>quantum</code>ï¼Œæ‰§è¡Œè¿™ä¹ˆé•¿æ—¶é—´åå°±ä¼šä¸­æ­¢ï¼Œå¹¶æ”¾å…¥è¯¥ä¼˜å…ˆçº§çš„è°ƒåº¦é˜Ÿåˆ—æœ«å°¾ã€‚</li><li><code>SCHED_OTHER</code>ï¼š<code>Linux</code>çš„é»˜è®¤ç­–ç•¥ï¼Œæ˜¯ä¸€ç§ç›¸å¯¹<em>å…¬å¹³</em>çš„è°ƒåº¦ç­–ç•¥ï¼Œç±»ä¼¼ä¸æ—¶é—´ç‰‡è½®è½¬ï¼Œä½†é«˜ä¼˜å…ˆçº§åˆ†é…çš„æ—¶é—´ä¼šæ›´å¤šã€‚</li></ul><h3 id="pthread-attr-setschedparam-x2F-get"><a href="#pthread-attr-setschedparam-x2F-get" class="headerlink" title="pthread_attr_setschedparam&#x2F;get"></a>pthread_attr_setschedparam&#x2F;get</h3><p><code>SCHED_FIFO</code>æ˜¯åŸºäºä¼˜å…ˆçº§æŠ¢å çš„ï¼Œè¯¥å‡½æ•°ç”¨äºè®¾ç½®çº¿ç¨‹è¿›è¡Œè°ƒåº¦æ—¶çš„ä¼˜å…ˆçº§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setschedparam</span><span class="params">(<span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                               <span class="type">const</span> <span class="keyword">struct</span> sched_param *param)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getschedparam</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                               <span class="keyword">struct</span> sched_param *param)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> sched_param &#123;</span><br><span class="line">    <span class="type">int</span> sched_priority;     <span class="comment">/* Scheduling priority */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="pthread-attr-setinheritsched-x2F-get"><a href="#pthread-attr-setinheritsched-x2F-get" class="headerlink" title="pthread_attr_setinheritsched&#x2F;get"></a>pthread_attr_setinheritsched&#x2F;get</h3><p>è®¾ç½®çº¿ç¨‹çš„ç»§æ‰¿å±æ€§ï¼Œå…¶å®åªæœ‰<strong>è°ƒåº¦å±æ€§</strong>å¯ä»¥ç»§æ‰¿ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setinheritsched</span><span class="params">(<span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> inheritsched)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getinheritsched</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                                 <span class="type">int</span> *inheritsched)</span>;</span><br></pre></td></tr></table></figure><p><code>inheritsched</code>åªæœ‰ä¸¤ç§å–å€¼ï¼š</p><ul><li><code>PTHREAD_INHERIT_SCHED</code>ï¼šæ–°çº¿ç¨‹å°†ç»§æ‰¿è°ƒç”¨<code>pthread_create</code>çš„çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥ã€‚</li><li><code>PTHREAD_EXPLICIT_SCHED</code>ï¼šæ–°çº¿ç¨‹çš„è°ƒåº¦ç­–ç•¥ä»¥çº¿ç¨‹å±æ€§ä¸­æŒ‡å®šçš„ä¸ºå‡†ã€‚</li></ul><p><strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä½¿ç”¨<code>pthread_attr_setschedpolicy</code>æ—¶ï¼Œå¿…é¡»ä¹Ÿè¦è®¾ç½®<code>PTHREAD_EXPLICIT_SCHED</code>ï¼Œå¦åˆ™è°ƒåº¦ç­–ç•¥ä¸ä¼šç”Ÿæ•ˆ</strong>ã€‚</p><h3 id="pthread-attr-setscope-x2F-get"><a href="#pthread-attr-setscope-x2F-get" class="headerlink" title="pthread_attr_setscope&#x2F;get"></a>pthread_attr_setscope&#x2F;get</h3><p>çº¿ç¨‹ä½œç”¨åŸŸå±æ€§æè¿°ç‰¹å®šçº¿ç¨‹å°†ä¸å“ªäº›çº¿ç¨‹ç«äº‰èµ„æºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setscope</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> scope)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getscope</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">int</span> *scope)</span>;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹å¯ä»¥åœ¨ä¸¤ç§ç«äº‰åŸŸå†…ç«äº‰èµ„æºï¼Œä¹Ÿæ˜¯<code>scope</code>çš„ä¸¤ç§å–å€¼ï¼š</p><ul><li><code>PTHREAD_SCOPE_SYSTEM</code>ï¼šç³»ç»ŸåŸŸï¼Œä¸ç³»ç»Ÿä¸­çš„æ‰€æœ‰çº¿ç¨‹ã€‚ä¸€ä¸ªå…·æœ‰ç³»ç»ŸåŸŸçš„çº¿ç¨‹å°†ä¸æ•´ä¸ªç³»ç»Ÿä¸­æ‰€æœ‰å…·æœ‰ç³»ç»ŸåŸŸçš„çº¿ç¨‹æŒ‰ç…§ä¼˜å…ˆçº§ç«äº‰å¤„ç†å™¨èµ„æºï¼Œè¿›è¡Œè°ƒåº¦ã€‚</li><li><code>PTHREAD_SCOPE_PROCESS</code>ï¼šè¿›ç¨‹åŸŸï¼Œä¸åŒä¸€è¿›ç¨‹å†…çš„å…¶ä»–çº¿ç¨‹ç«äº‰ã€‚</li></ul><h3 id="pthread-attr-setguardsize-x2F-get"><a href="#pthread-attr-setguardsize-x2F-get" class="headerlink" title="pthread_attr_setguardsize&#x2F;get"></a>pthread_attr_setguardsize&#x2F;get</h3><p>è®¾ç½®çº¿ç¨‹æ ˆä¿æŠ¤åŒºçš„å¤§å°ï¼Œ<strong>é»˜è®¤ä¿æŠ¤å¤§å°ä¸ç³»ç»Ÿé¡µé¢å¤§å°ç›¸åŒ</strong>ã€‚</p><p>åœ¨çº¿ç¨‹æ ˆçš„æœ«å°¾åˆ†é…ä¹‹ä¸€è‡³å°‘<code>guardsize</code>å­—èŠ‚çš„åŒºåŸŸä½œä¸ºå †æ ˆä¿æŠ¤åŒºï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æº¢å‡ºå®ƒçš„å †æ ˆåˆ°ä¿æŠ¤åŒºï¼Œåœ¨å¤§å¤šæ•°ç¡¬æ¶æ„ä¸Šï¼Œä¼šäº§ç”Ÿ<code>SIGSEGV</code>ä¿¡å·ï¼Œä»è€Œé€šçŸ¥å®ƒæº¢å‡ºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setguardsize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> guardsize)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getguardsize</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> *guardsize)</span>;</span><br></pre></td></tr></table></figure><h3 id="pthread-attr-setstackaddr-x2F-get"><a href="#pthread-attr-setstackaddr-x2F-get" class="headerlink" title="pthread_attr_setstackaddr&#x2F;get"></a>pthread_attr_setstackaddr&#x2F;get</h3><p>å½“è¿›ç¨‹æ ˆåœ°å€ç©ºé—´ä¸å¤Ÿç”¨æ—¶ï¼ŒæŒ‡å®šæ–°å»ºçº¿ç¨‹ä½¿ç”¨ç”±<code>malloc</code>åˆ†é…çš„ç©ºé—´ä½œä¸ºè‡ªå·±çš„æ ˆç©ºé—´ã€‚</p><p><a href="https://man7.org/linux/man-pages/man3/pthread_attr_setstackaddr.3.html#NOTES">Do not use these functions!</a></p><h3 id="pthread-attr-setstacksize-x2F-get"><a href="#pthread-attr-setstacksize-x2F-get" class="headerlink" title="pthread_attr_setstacksize&#x2F;get"></a>pthread_attr_setstacksize&#x2F;get</h3><p>è®¾ç½®çº¿ç¨‹æ ˆçš„å¤§å°ï¼Œé»˜è®¤çº¿ç¨‹æ ˆçš„å¤§å°ä¸º<code>8M</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setstacksize</span><span class="params">(<span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> stacksize)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getstacksize</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr, <span class="type">size_t</span> *stacksize)</span>;</span><br></pre></td></tr></table></figure><p>å½“è¿›ç¨‹ä¸­æœ‰å¾ˆå¤šçº¿ç¨‹æ—¶ï¼Œå¯èƒ½éœ€è¦å‡å°æ¯ä¸ªçº¿ç¨‹æ ˆçš„é»˜è®¤å¤§å°ï¼Œé˜²æ­¢è¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸å¤Ÿç”¨ã€‚</p><p>å½“çº¿ç¨‹è°ƒç”¨çš„å‡½æ•°ä¼šåˆ†é…å¾ˆå¤§çš„å±€éƒ¨å˜é‡æˆ–è€…å‡½æ•°è°ƒç”¨å±‚æ¬¡å¾ˆæ·±æ—¶ï¼Œå¯èƒ½éœ€è¦å¢å¤§çº¿ç¨‹æ ˆçš„é»˜è®¤å¤§å°ã€‚</p><h3 id="pthread-attr-setaffinity-np-x2F-get"><a href="#pthread-attr-setaffinity-np-x2F-get" class="headerlink" title="pthread_attr_setaffinity_np&#x2F;get"></a>pthread_attr_setaffinity_np&#x2F;get</h3><p>è®¾ç½®çº¿ç¨‹çš„CPUäº²å’Œæ€§ï¼Œè®©çº¿ç¨‹åœ¨æŒ‡å®šçš„æŸä¸€ä¸ªæ ¸æˆ–ä¸€ç»„æ ¸ä¸Šè¿è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_setaffinity_np</span><span class="params">(<span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                                <span class="type">size_t</span> cpusetsize, <span class="type">const</span> <span class="type">cpu_set_t</span> *cpuset)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_attr_getaffinity_np</span><span class="params">(<span class="type">const</span> <span class="type">pthread_attr_t</span> *attr,</span></span><br><span class="line"><span class="params">                                <span class="type">size_t</span> cpusetsize, <span class="type">cpu_set_t</span> *cpuset)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>cpusetsize</code>ï¼šåº”è¯¥æŒ‡å®š <code>cpuset</code> å‚æ•°çš„å­—èŠ‚æ•°ï¼Œé€šå¸¸è®¾å®šä¸º<code>sizeof(cpu_set_t)</code>ã€‚</li><li><code>cpuset</code>ï¼šæ ¸çš„æ©ç ã€‚</li></ul><p>è™½ç„¶ <code>cpu_set_t</code> æ•°æ®ç±»å‹å®ç°ä¸ºä¸€ä¸ªä½æ©ç ï¼Œä½†åº”è¯¥å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªä¸é€æ˜çš„ç»“æ„ã€‚</p><p>æ‰€æœ‰å¯¹è¿™ä¸ªç»“æ„çš„æ“ä½œéƒ½åº”è¯¥ä½¿ç”¨å®æ¥å®Œæˆï¼Œä¸‹é¢æ˜¯éƒ¨åˆ†å¸¸ç”¨çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* man CPU_SET */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">CPU_ZERO</span><span class="params">(<span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;          <span class="comment">/* å°† set åˆå§‹åŒ–ä¸ºç©º */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CPU_SET</span><span class="params">(<span class="type">int</span> cpu, <span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;  <span class="comment">/* å°† CPU cpu æ·»åŠ åˆ° set ä¸­ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CPU_CLR</span><span class="params">(<span class="type">int</span> cpu, <span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;  <span class="comment">/* ä» set ä¸­åˆ é™¤ CPU cpu */</span></span><br><span class="line"><span class="type">int</span>  <span class="title function_">CPU_ISSET</span><span class="params">(<span class="type">int</span> cpu, <span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;<span class="comment">/* åœ¨ CPU cpu æ˜¯ set çš„ä¸€ä¸ªæˆå‘˜æ—¶è¿”å› true */</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢å®å‚æ•°<code>cpu</code>ç¼–å·æ˜¯ä»0å¼€å§‹ã€‚</p><h3 id="pthread-getattr-np"><a href="#pthread-getattr-np" class="headerlink" title="pthread_getattr_np"></a>pthread_getattr_np</h3><p>è·å–å½“å‰çº¿ç¨‹çš„å±æ€§ï¼Œå†™å…¥åˆ°<code>attr</code>ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_getattr_np</span><span class="params">(<span class="type">pthread_t</span> thread, <span class="type">pthread_attr_t</span> *attr)</span>;</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œæ—¶è°ƒæ•´çº¿ç¨‹å±æ€§"><a href="#è¿è¡Œæ—¶è°ƒæ•´çº¿ç¨‹å±æ€§" class="headerlink" title="è¿è¡Œæ—¶è°ƒæ•´çº¿ç¨‹å±æ€§"></a>è¿è¡Œæ—¶è°ƒæ•´çº¿ç¨‹å±æ€§</h3><p>é™¤äº†ä¸Šé¢åœ¨çº¿ç¨‹åˆ›å»ºæ—¶è®¾ç½®å±æ€§ï¼Œéƒ¨åˆ†å±æ€§ä¹Ÿæ”¯æŒè¿è¡Œæ—¶è¿›è¡Œè°ƒæ•´ã€‚</p><table><thead><tr><th>é™æ€è®¾ç½®</th><th>è¿è¡Œæ—¶</th></tr></thead><tbody><tr><td><code>pthread_attr_setschedparam</code></td><td><code>pthread_setschedparam</code></td></tr><tr><td><code>pthread_attr_setaffinity_np</code></td><td><code>pthread_setaffinity_np</code></td></tr></tbody></table><h3 id="CPUäº²å’Œæ€§"><a href="#CPUäº²å’Œæ€§" class="headerlink" title="CPUäº²å’Œæ€§"></a>CPUäº²å’Œæ€§</h3><p>è®¾ç½®è¿›ç¨‹åœ¨æŸä¸€ä¸ªæ ¸æˆ–ä¸€ç»„æ ¸ä¸Šè¿è¡Œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯ä»¥æå‡æ€§èƒ½ã€‚å¦‚æœè¯¥è¿›ç¨‹æœ‰å¤šä¸ªçº¿ç¨‹ï¼Œå®ƒä»¬éƒ½åªèƒ½åœ¨æŒ‡å®šçš„ä¸€ç»„æ ¸ä¸Šé¢è¿è¡Œã€‚ä¹Ÿå¯å•ç‹¬ä¸ºæŸä¸€ä¸ªçº¿ç¨‹è®¾ç½®äº²å’Œæ€§ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sched_setaffinity</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">size_t</span> cpusetsize,</span></span><br><span class="line"><span class="params">                        <span class="type">const</span> <span class="type">cpu_set_t</span> *mask)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sched_getaffinity</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">size_t</span> cpusetsize,</span></span><br><span class="line"><span class="params">                        <span class="type">cpu_set_t</span> *mask)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>pid</code>ï¼šè¦è®¾ç½®çš„è¿›ç¨‹å·ï¼Œä¹Ÿå¯ç®€å•çš„ç”¨<code>0</code>æ¥è¡¨ç¤ºè°ƒç”¨è¿›ç¨‹ï¼Œä¹Ÿå¯ç”¨<code>gettid()</code>ä¼ å…¥çº¿ç¨‹å·</li><li><code>cpusetsize</code>ï¼šåº”è¯¥æŒ‡å®š <code>mask</code> å‚æ•°çš„å­—èŠ‚æ•°ï¼Œé€šå¸¸è®¾å®šä¸º<code>sizeof(cpu_set_t)</code></li><li><code>mask</code>ï¼šæ ¸çš„æ©ç ã€‚</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›<code>-1</code>ï¼Œå¹¶è®¾ç½®<code>errno</code><ul><li>å¦‚æœ<code>mask</code>ä¸­æŒ‡å®šçš„ CPU ä¸ç³»ç»Ÿä¸­çš„æ‰€æœ‰ CPU éƒ½ä¸åŒ¹é…ï¼Œè¿”å›<code>EINVAL</code>é”™è¯¯</li></ul></li></ul><p><code>taskset -p PID</code> å¯æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„<code>mask</code>ï¼Œå¯é€šè¿‡ <code>taskset -pc $pid</code> æ¥è·å–æŸçº¿ç¨‹ä¸CPUæ ¸å¿ƒçš„äº²å’Œæ€§ã€‚</p><h2 id="çº¿ç¨‹æ³¨æ„äº‹é¡¹"><a href="#çº¿ç¨‹æ³¨æ„äº‹é¡¹" class="headerlink" title="çº¿ç¨‹æ³¨æ„äº‹é¡¹"></a>çº¿ç¨‹æ³¨æ„äº‹é¡¹</h2><ol><li>ä¸»çº¿ç¨‹é€€å‡ºå…¶ä»–çº¿ç¨‹ä¸é€€å‡ºï¼Œä¸»çº¿ç¨‹åº”è°ƒç”¨ pthread_exit</li><li>é¿å…åƒµå°¸çº¿ç¨‹ï¼š<ul><li>pthread_join</li><li>pthread_detach</li><li>pthread_create æŒ‡å®šåˆ†ç¦»å±æ€§</li><li>è¢« join çº¿ç¨‹å¯èƒ½åœ¨ join å‡½æ•°è¿”å›å‰å°±é‡Šæ”¾å®Œè‡ªå·±çš„æ‰€æœ‰å†…å­˜èµ„æºï¼Œæ‰€ä»¥ä¸åº”å½“è¿”å›è¢«å›æ”¶çº¿ç¨‹æ ˆä¸­çš„å€¼;</li></ul></li><li>malloc å’Œ mmap ç”³è¯·çš„å†…å­˜å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é‡Šæ”¾</li><li>åº”é¿å…åœ¨å¤šçº¿ç¨‹æ¨¡å‹ä¸­è°ƒç”¨ fork é™¤éï¼Œé©¬ä¸Š execï¼Œå­è¿›ç¨‹ä¸­åªæœ‰è°ƒç”¨ fork çš„çº¿ç¨‹å­˜åœ¨ï¼Œå…¶ä»–çº¿ç¨‹åœ¨å­è¿›ç¨‹ä¸­å‡ pthread_exit</li><li>ä¿¡å·çš„å¤æ‚è¯­ä¹‰å¾ˆéš¾å’Œå¤šçº¿ç¨‹å…±å­˜ï¼Œåº”é¿å…åœ¨å¤šçº¿ç¨‹å¼•å…¥ä¿¡å·æœºåˆ¶ ï¼ˆå¤šçº¿ç¨‹ä¸­ï¼Œä¿¡å·ç”±å“ªä¸ªçº¿ç¨‹å¤„ç†ä¸ç¡®å®šï¼æ¯ä¸ªçº¿ç¨‹å„æœ‰ä¿¡å·å±è”½å­—maskï¼Œå…±äº«æœªå†³ä¿¡å·é›†ï¼Œå¦‚æœæƒ³æŒ‡å®šæŸä¸ªçº¿ç¨‹å¤„ç†ç‰¹å®šä¿¡å·ï¼Œå¯é€šè¿‡è®¾ç½®å…¶ä»–çº¿ç¨‹çš„ä¿¡å·å±è”½å­—ï¼‰</li></ol><h2 id="ä¸€æ¬¡æ€§åˆå§‹åŒ–"><a href="#ä¸€æ¬¡æ€§åˆå§‹åŒ–" class="headerlink" title="ä¸€æ¬¡æ€§åˆå§‹åŒ–"></a>ä¸€æ¬¡æ€§åˆå§‹åŒ–</h2><blockquote><p>Linux-Unixç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œâ€”â€”31.2èŠ‚</p></blockquote><p>å¤šçº¿ç¨‹ç¨‹åºæœ‰æ—¶æœ‰è¿™æ ·çš„éœ€æ±‚ï¼šä¸ç®¡åˆ›å»ºäº†å¤šå°‘çº¿ç¨‹ï¼Œæœ‰äº›åˆå§‹åŒ–åŠ¨ä½œåªèƒ½å‘ç”Ÿä¸€æ¬¡ã€‚å¦‚æœç”±ä¸»çº¿ç¨‹æ¥åˆ›å»ºæ–°çº¿ç¨‹ï¼Œé‚£ä¹ˆè¿™ä¸€ç‚¹æ˜“å¦‚åæŒï¼Œå¯ä»¥åœ¨åˆ›å»ºä¾èµ–äºè¯¥åˆå§‹åŒ–çš„çº¿ç¨‹ä¹‹å‰è¿›è¡Œåˆå§‹åŒ–ã€‚ä¸è¿‡ï¼Œå¯¹äºåº“å‡½æ•°è€Œè¨€ï¼Œè¿™æ ·å¤„ç†å°±ä¸å¯è¡Œï¼Œå› ä¸ºè°ƒç”¨è€…åœ¨åˆæ¬¡è°ƒç”¨åº“å‡½æ•°ä¹‹å‰å¯èƒ½å·²ç»åˆ›å»ºäº†è¿™äº›çº¿ç¨‹ã€‚æ•…è€Œéœ€è¦è¿™æ ·çš„åº“å‡½æ•°ï¼šæ— è®ºé¦–æ¬¡ä¸ºä»»ä½•çº¿ç¨‹æ‰€è°ƒç”¨ï¼Œéƒ½ä¼šæ‰§è¡Œåˆå§‹åŒ–åŠ¨ä½œã€‚</p><h3 id="pthread-once-å‡½æ•°"><a href="#pthread-once-å‡½æ•°" class="headerlink" title="pthread_once å‡½æ•°"></a>pthread_once å‡½æ•°</h3><p>ä¿è¯æ— è®ºå¤šå°‘çº¿ç¨‹ã€æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡<code>pthread_once</code>ï¼Œéƒ½åªä¼šæ‰§è¡Œä¸€æ¬¡<code>init_routine</code>åˆå§‹åŒ–å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_once</span><span class="params">(<span class="type">pthread_once_t</span> *once_control,</span></span><br><span class="line"><span class="params">                 <span class="type">void</span> (*init_routine)(<span class="type">void</span>))</span>;</span><br><span class="line"><span class="type">pthread_once_t</span> once_control = PTHREAD_ONCE_INIT;</span><br></pre></td></tr></table></figure><ul><li><code>once_control</code>ï¼šå¿…é¡»æ˜¯ä¸€æŒ‡é’ˆï¼ŒæŒ‡å‘åˆå§‹åŒ–ä¸º <code>PTHREAD_ONCE_INIT</code> çš„é™æ€å˜é‡ã€‚</li><li><code>init_routine</code>ï¼šéœ€è¦æ‰§è¡Œçš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æ²¡æœ‰ä»»ä½•å‚æ•°ã€‚</li><li>æˆåŠŸè¿”å›<code>0</code>ã€‚</li></ul><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=148&spm_id_from=pageDriver">çº¿ç¨‹åŸç†â€“ä¸‰çº§é¡µè¡¨</a></li><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=153&spm_id_from=pageDriver">å¾ªç¯åˆ›å»ºå­çº¿ç¨‹</a></li><li><a href="https://man7.org/linux/man-pages/index.html">åœ¨çº¿æŸ¥çœ‹manpage</a></li><li><a href="https://elixir.bootlin.com/glibc/glibc-2.36/source">glibc source code</a></li><li><a href="https://www.cnblogs.com/FREMONT/p/9480376.html">çº¿ç¨‹å±æ€§</a></li><li><a href="https://blog.csdn.net/qq_38232598/article/details/114263105">çº¿ç¨‹&#x2F;è¿›ç¨‹å’Œæ ¸ç»‘å®šï¼ˆCPUäº²å’Œæ€§ï¼‰</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> çº¿ç¨‹ </tag>
            
            <tag> è¿›ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-ä¿¡å·</title>
      <link href="/2022/05/02/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E4%BF%A1%E5%8F%B7/"/>
      <url>/2022/05/02/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E4%BF%A1%E5%8F%B7/</url>
      
        <content type="html"><![CDATA[<h2 id="ä¿¡å·"><a href="#ä¿¡å·" class="headerlink" title="ä¿¡å·"></a>ä¿¡å·</h2><ol><li>ä¿¡å·æ˜¯è½¯ä»¶å±‚é¢ä¸Šçš„â€œä¸­æ–­â€ã€‚ä¸€æ—¦ä¿¡å·äº§ç”Ÿï¼Œæ— è®ºç¨‹åºæ‰§è¡Œåˆ°ä»€ä¹ˆä½ç½®ï¼Œå¿…é¡»ç«‹å³åœæ­¢è¿è¡Œï¼Œå¤„ç†ä¿¡å·ï¼Œå¤„ç†ç»“æŸï¼Œå†ç»§ç»­æ‰§è¡Œåç»­æŒ‡ä»¤ã€‚</li><li>æ‰€æœ‰ä¿¡å·çš„äº§ç”ŸåŠå¤„ç†å…¨éƒ¨éƒ½æ˜¯ç”±ã€å†…æ ¸ã€‘å®Œæˆçš„ã€‚</li><li>ç®€å•ã€ä¸èƒ½æºå¸¦å¤§é‡ä¿¡æ¯ã€æ»¡è¶³æ¡ä»¶æ‰å‘é€ã€‚</li></ol><h3 id="ä¿¡å·çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#ä¿¡å·çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="ä¿¡å·çš„ç”Ÿå‘½å‘¨æœŸ"></a>ä¿¡å·çš„ç”Ÿå‘½å‘¨æœŸ</h3><ol><li>äº§ç”Ÿï¼š</li><li>æœªå†³ï¼šäº§ç”Ÿä¸é€’è¾¾ä¹‹é—´çŠ¶æ€ã€‚</li><li>é€’è¾¾ï¼šäº§ç”Ÿå¹¶ä¸”é€è¾¾åˆ°è¿›ç¨‹ã€‚ç›´æ¥è¢«å†…æ ¸å¤„ç†æ‰ã€‚</li><li>å¤„ç†ï¼šæ‰§è¡Œé»˜è®¤å¤„ç†åŠ¨ä½œã€å¿½ç•¥ã€æ•æ‰ï¼ˆè‡ªå®šä¹‰ï¼‰</li></ol><p>é˜»å¡ä¿¡å·é›†ï¼ˆä¿¡å·å±è”½å­—ï¼‰ï¼šè¿›ç¨‹æ§åˆ¶å—PCBä¸­çš„å˜é‡ï¼ˆä½å›¾ï¼‰ï¼Œç”¨æ¥è®°å½•ä¿¡å·çš„å±è”½çŠ¶æ€ã€‚è¢«å±è”½çš„ä¿¡å·ï¼Œåœ¨è§£é™¤å±è”½å‰ï¼Œä¸€ç›´å¤„äºæœªå†³æ€ã€‚</p><p>æœªå†³ä¿¡å·é›†ï¼šè¿›ç¨‹æ§åˆ¶å—PCBä¸­çš„å˜é‡ï¼ˆä½å›¾ï¼‰ï¼Œç”¨æ¥è®°å½•ä¿¡å·çš„å¤„ç†çŠ¶æ€ã€‚</p><ul><li>ä¿¡å·äº§ç”Ÿæ—¶ï¼Œæœªå†³ä¿¡å·é›†ä¸­å¯¹åº”ä½ç«‹åˆ»ç¿»è½¬ä¸º1ï¼Œè¡¨ç¤ºä¿¡å·å¤„äºæœªå†³çŠ¶æ€ã€‚ä¿¡å·è¢«å¤„ç†åå¯¹åº”ä½ç¿»è½¬å›0ï¼Œè¿™ä¸€è¿‡ç¨‹å¾€å¾€éå¸¸çŸ­æš‚ã€‚</li><li>ä¿¡å·äº§ç”Ÿåï¼Œç”±äºæŸäº›åŸå› ï¼ˆä¸»è¦æ˜¯é˜»å¡ï¼‰ä¸èƒ½é€’è¾¾ï¼Œä¸€ç›´å¤„ç†æœªå†³çŠ¶æ€ã€‚</li><li>è®¾ç½®é˜»å¡åï¼ŒåŒä¸€ä¿¡å·å¤šæ¬¡äº§ç”Ÿï¼Œä¹Ÿåªèƒ½è®°å½•ä¸€æ¬¡ï¼ˆä¹Ÿåªä¼šè¢«å¤„ç†ä¸€æ¬¡ï¼‰ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* Signal handlers: */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">signal_struct</span>    *<span class="title">signal</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sighand_struct</span>   *<span class="title">sighand</span>;</span></span><br><span class="line">    <span class="type">sigset_t</span>                blocked;</span><br><span class="line">    <span class="type">sigset_t</span>                real_blocked;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Restored if set_restore_sigmask() was used: */</span></span><br><span class="line">    <span class="type">sigset_t</span>                saved_sigmask; <span class="comment">// ä¿¡å·å±è”½å­—</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigpending</span>       <span class="title">pending</span>;</span>    <span class="comment">// æœªå†³ä¿¡å·é›†</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>           sas_ss_sp;</span><br><span class="line">    <span class="type">size_t</span>                  sas_ss_size;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span>            sas_ss_flags;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="äº§ç”Ÿä¿¡å·"><a href="#äº§ç”Ÿä¿¡å·" class="headerlink" title="äº§ç”Ÿä¿¡å·"></a>äº§ç”Ÿä¿¡å·</h3><ol><li>æŒ‰é”®äº§ç”Ÿï¼Œå¦‚ï¼š<code>ctrl+c, ctrl+z, ctrl+\</code></li><li>ç³»ç»Ÿè°ƒç”¨äº§ç”Ÿï¼Œå¦‚ï¼š<code>kill, raise, abort</code></li><li>è½¯ä»¶æ¡ä»¶äº§ç”Ÿï¼Œå¦‚ï¼šå®šæ—¶å™¨<code>alarm</code>ï¼Œæˆ–è€…è¯¥è¿›ç¨‹çš„æŸä¸ªå­è¿›ç¨‹é€€å‡º</li><li>ç¡¬ä»¶å¼‚å¸¸äº§ç”Ÿï¼Œå¦‚ï¼šéæ³•è®¿é—®å†…å­˜ï¼ˆæ®µé”™è¯¯ï¼‰ã€é™¤0ï¼ˆæµ®ç‚¹æ•°ä¾‹å¤–ï¼‰ã€å†…å­˜å¯¹é½å‡ºé”™ï¼ˆæ€»çº¿é”™è¯¯ï¼‰</li><li>å‘½ä»¤äº§ç”Ÿï¼Œ å¦‚ï¼š<code>kill -9</code></li></ol><h3 id="ä¿¡å·å››è¦ç´ "><a href="#ä¿¡å·å››è¦ç´ " class="headerlink" title="ä¿¡å·å››è¦ç´ "></a>ä¿¡å·å››è¦ç´ </h3><p><strong>ç¼–å·ã€åç§°ã€äº‹ä»¶ã€é»˜è®¤å¤„ç†åŠ¨ä½œ</strong>ï¼</p><p>æ€»è®¡æœ‰64ä¸ªä¿¡å·ï¼ˆ<strong>å¯é€šè¿‡<code>kill -l</code>æŸ¥çœ‹ä¿¡å·åç§°åŠç¼–å·</strong>ï¼‰ï¼Œ<code>man 7 signal</code>ä¹Ÿå¯æŸ¥çœ‹ä¿¡å·ã€‚å‰32ä¸ªä¸ºå¸¸è§„ä¿¡å·ï¼Œå32ä¸ªä¸ºå®æ—¶ä¿¡å·ã€‚</p><p>ä¿¡å·åˆ°è¾¾åï¼Œè¿›ç¨‹è§†å…·ä½“ä¿¡å·æ‰§è¡Œå¦‚ä¸‹é»˜è®¤æ“ä½œä¹‹ä¸€ï¼š</p><ul><li>Term   ç»ˆæ­¢ï¼ˆæ€æ­»ï¼‰è¿›ç¨‹ï¼Œè¿™æœ‰æ—¶æ˜¯æŒ‡è¿›ç¨‹å¼‚å¸¸ç»ˆæ­¢ï¼Œè€Œä¸æ˜¯è¿›ç¨‹å› è°ƒç”¨ <code>exit()</code> è€Œå‘ç”Ÿçš„æ­£å¸¸ç»ˆæ­¢ã€‚</li><li>Ign    å¿½ç•¥ä¿¡å·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå†…æ ¸å°†ä¿¡å·ä¸¢å¼ƒï¼Œä¿¡å·å¯¹è¿›ç¨‹æ²¡æœ‰äº§ç”Ÿä»»ä½•å½±å“</li><li>Core   äº§ç”Ÿæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼ŒåŒæ—¶è¿›ç¨‹ç»ˆæ­¢ï¼šæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶åŒ…å«å¯¹è¿›ç¨‹è™šæ‹Ÿå†…å­˜çš„é•œåƒï¼Œå¯å°†å…¶åŠ è½½åˆ°è°ƒè¯•å™¨ä¸­ä»¥æ£€æŸ¥è¿›ç¨‹ç»ˆæ­¢æ—¶çš„çŠ¶æ€</li><li>Stop   åœæ­¢è¿›ç¨‹ï¼šæš‚åœè¿›ç¨‹çš„æ‰§è¡Œ</li><li>Cont   äºä¹‹å‰æš‚åœåå†åº¦æ¢å¤è¿›ç¨‹çš„æ‰§è¡Œ</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">åç§°       ç¼–å·      åŠ¨ä½œ      äº‹ä»¶</span><br><span class="line">Signal   x86/ARM   Action   Comment</span><br><span class="line">â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span><br><span class="line">SIGHUP       1      Term    Hangup detected on controlling terminal</span><br><span class="line">SIGINT       2      Term    Interrupt from keyboard</span><br><span class="line">SIGQUIT      3      Core    Quit from keyboard</span><br><span class="line">SIGILL       4      Core    Illegal Instruction</span><br><span class="line">SIGTRAP      5      Core    Trace/breakpoint <span class="built_in">trap</span></span><br><span class="line">SIGABRT      6      Core    Abort signal from abort(3)</span><br><span class="line">SIGIOT       6      Core    IOT <span class="built_in">trap</span>. A synonym <span class="keyword">for</span> SIGABRT</span><br><span class="line">SIGBUS       7      Core    Bus error (bad memory access)</span><br><span class="line">SIGFPE       8      Core    Floating-point exception</span><br><span class="line">SIGKILL      9      Term    Kill signal</span><br><span class="line">SIGUSR1     10      Term    User-defined signal 1</span><br><span class="line">SIGSEGV     11      Core    Invalid memory reference</span><br><span class="line">SIGUSR2     12      Term    User-defined signal 2</span><br><span class="line">SIGPIPE     13      Term    Broken pipe: write to pipe with no</span><br><span class="line">SIGALRM     14      Term    Timer signal from alarm(2)</span><br><span class="line">SIGTERM     15      Term    Termination signal</span><br><span class="line">SIGSTKFLT   16      Term    Stack fault on coprocessor (unused)</span><br><span class="line">SIGCHLD     17      Ign     Child stopped or terminated</span><br><span class="line">SIGCONT     18      Cont    Continue <span class="keyword">if</span> stopped</span><br><span class="line">SIGSTOP     19      Stop    Stop process</span><br><span class="line">SIGTSTP     20      Stop    Stop typed at terminal see also seccomp(2)</span><br><span class="line">SIGTTIN     21      Stop    Terminal input <span class="keyword">for</span> background process</span><br><span class="line">SIGTTOU     22      Stop    Terminal output <span class="keyword">for</span> background process</span><br><span class="line">SIGURG      23      Ign     Urgent condition on socket (4.2BSD)</span><br><span class="line">SIGXCPU     24      Core    CPU time <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">SIGXFSZ     25      Core    File size <span class="built_in">limit</span> exceeded (4.2BSD);</span><br><span class="line">SIGVTALRM   26      Term    Virtual alarm clock (4.2BSD)</span><br><span class="line">SIGPROF     27      Term    Profiling timer expired</span><br><span class="line">SIGWINCH    28      Ign     Window resize signal (4.3BSD, Sun)</span><br><span class="line">SIGIO       29      Term    I/O now possible (4.2BSD)</span><br><span class="line">SIGPWR      30      Term    Power failure (System V)</span><br><span class="line">SIGSYS      31      Core    Bad system call (SVr4);</span><br><span class="line">SIGUNUSED   31      Core    Synonymous with SIGSYS</span><br></pre></td></tr></table></figure><p><code>SIGKILL(9), SIGSTOP(19)</code> ä¸èƒ½è¢«æ•æ‰ã€é˜»å¡ã€å¿½ç•¥ã€‚</p><p>é‡ç‚¹æ˜¯ä¸‹é¢çš„ä¿¡å·ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SIGHUP       1   Term   å½“ç”¨æˆ·é€€å‡ºshellæ—¶ï¼Œç”±è¯¥shellå¯åŠ¨çš„æ‰€æœ‰è¿›ç¨‹éƒ½ä¼šæ”¶åˆ°è¯¥ä¿¡å·ã€‚</span><br><span class="line">SIGINT       2   Term   ç”¨æˆ·æŒ‰ä¸‹ ctrl+c</span><br><span class="line">SIGQUIT      3   Core   ç”¨æˆ·æŒ‰ä¸‹ ctrl+\</span><br><span class="line">SIGABRT      6   Core   è°ƒç”¨ abort() å‡½æ•°</span><br><span class="line">SIGBUS       7   Core   éæ³•è®¿é—®å†…å­˜åœ°å€ï¼ŒåŒ…æ‹¬å†…å­˜å¯¹é½å‡ºé”™</span><br><span class="line">SIGFPE       8   Core   æµ®ç‚¹æ•°é”™è¯¯ã€æº¢å‡ºã€é™¤æ•°ä¸º0ç­‰æ‰€æœ‰è¿ç®—é”™è¯¯</span><br><span class="line">SIGKILL      9   Term   Killä¿¡å·ï¼Œä¸èƒ½è¢«æ•æ‰ã€é˜»å¡ã€å¿½ç•¥</span><br><span class="line">SIGUSR1     10   Term   ç”¨æˆ·å®šä¹‰çš„ä¿¡å·1</span><br><span class="line">SIGSEGV     11   Core   è¿›è¡Œäº†æ— æ•ˆçš„å†…å­˜è®¿é—®</span><br><span class="line">SIGUSR2     12   Term   ç”¨æˆ·å®šä¹‰çš„ä¿¡å·2</span><br><span class="line">SIGPIPE     13   Term   å‘ä¸€ä¸ªæ²¡æœ‰è¯»ç«¯å£çš„ç®¡é“å†™æ•°æ®</span><br><span class="line">SIGALRM     14   Term   å®šæ—¶å™¨è¶…æ—¶</span><br><span class="line">SIGTERM     15   Term   ç»“æŸä¿¡å·ï¼Œ<span class="built_in">kill</span>ç¼ºçœå‘é€æ­¤ä¿¡å·ï¼Œä¸KILLSIGä¸åŒï¼Œå¯ä»¥é˜»å¡ã€å¿½ç•¥</span><br><span class="line">SIGCHLD     17   Ign    å­è¿›ç¨‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆè¿›ç¨‹æ¢å¤æ‰§è¡Œä¹Ÿå¯èƒ½å‘é€ï¼‰ï¼Œé»˜è®¤å¿½ç•¥æ­¤ä¿¡å·</span><br></pre></td></tr></table></figure><h3 id="SIGSEGV"><a href="#SIGSEGV" class="headerlink" title="SIGSEGV"></a>SIGSEGV</h3><p>æ®µé”™è¯¯ï¼Œè¿›è¡Œäº†<strong>éæ³•çš„å†…å­˜</strong>è®¿é—®ï¼ä»€ä¹ˆä¸ºéæ³•å‘¢ï¼Ÿè¿›ç¨‹ä¸­ä½¿ç”¨çš„åœ°å€æ˜¯è™šæ‹Ÿåœ°å€ï¼Œè™šæ‹Ÿåœ°å€æ˜¯æŒ‰é¡µåˆ’åˆ†çš„ï¼Œæ¯ä¸ªè™šæ‹Ÿé¡µå¯¹åº”ä¸€ä¸ªå®é™…çš„ç‰©ç†é¡µï¼Œä½†å¹¶ä¸æ˜¯ä¸€å¼€å§‹å°±ä¸ºæ¯ä¸€ä¸ªè™šæ‹Ÿé¡µåˆ†é…äº†ä¸€ä¸ªç‰©ç†é¡µï¼Œè€Œæ˜¯ç”¨åˆ°äº†æ‰åˆ†é…ã€‚ç”³è¯·å†…å­˜æ—¶ä¹ŸåŒæ ·åªç”³è¯·è™šæ‹Ÿå†…å­˜ï¼Œåªè¦è™šæ‹Ÿå†…å­˜åœ°å€æœ‰æ•ˆï¼Œå°±æ˜¯åˆæ³•çš„ã€‚</p><p>ä»¥å †å†…ä¸ºä¾‹ï¼Œå †æ˜¯ä¸€æ®µé•¿åº¦å¯å˜çš„<strong>è¿ç»­è™šæ‹Ÿå†…å­˜</strong>ï¼Œå§‹äºè¿›ç¨‹çš„<strong>æœªåˆå§‹åŒ–æ•°æ®æ®µæœ«å°¾</strong>ï¼Œé€šå¸¸å°†å †çš„å†…å­˜è¾¹ç•Œï¼ˆå †é¡¶ï¼‰ç§°ä¸º<code>program break</code>ï¼Œæœ€åˆï¼Œ<code>program break</code> æ­£å¥½ä½äºæœªåˆå§‹åŒ–æ•°æ®æ®µæœ«å°¾ä¹‹åã€‚åœ¨å †ä¸Šåˆ†é…å†…å­˜é‚£é¦–å…ˆå¾—æ‰©å±•å †çš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯æŠ¬å‡å †é¡¶<code>program break</code>ï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥è®¿é—®<strong>æ–°åˆ†é…åŒºåŸŸå†…</strong>çš„ä»»ä½•å†…å­˜åœ°å€ã€‚ï¼ˆè¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœä¸€å¼€å§‹ç›´æ¥è®¿é—®å †åŒºåŸŸå¤–çš„åœ°å€ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>)); <span class="comment">// sbrk(0) è¿”å›å †é¡¶çš„åœ°å€</span></span><br><span class="line">    getchar();  getchar();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;è®¿é—®å †é¡¶ä»¥ä¸Šçš„å†…å­˜: %d\n&quot;</span>, (<span class="type">int</span> *)(sbrk(<span class="number">0</span>) + <span class="number">100</span>));</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> *t = <span class="built_in">malloc</span>(<span class="number">20000</span>*<span class="keyword">sizeof</span>(<span class="type">int</span>)); <span class="comment">// å¯ä»¥çœ‹åˆ°å †é¡¶æå‡</span></span><br><span class="line">    t[<span class="number">10000</span>] = <span class="number">10000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;access array t: %p\n&quot;</span>, t);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;access array t[10000]: %d, addr: %p\n&quot;</span>, t[<span class="number">10000</span>], t+<span class="number">10000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    getchar();  getchar();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¶…è¿‡128k ä¸ä¼šè°ƒæ•´program break, è€Œæ˜¯ä½¿ç”¨mmap</span></span><br><span class="line">    <span class="type">int</span> *t2 = <span class="built_in">malloc</span>(<span class="number">50000</span>*<span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    t2[<span class="number">10000</span>] = <span class="number">10000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;access array t2: %p\n&quot;</span>, t2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;access array t2[10000]: %d, %p\n&quot;</span>, t2[<span class="number">10000</span>], t2+<span class="number">10000</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;program break: %p\n&quot;</span>, sbrk(<span class="number">0</span>));</span><br><span class="line">    getchar();  getchar();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ <code>/proc/pid/maps</code> æ–‡ä»¶å¯ä»¥æŸ¥çœ‹è¿›ç¨‹çš„å†…å­˜å¸ƒå±€ï¼ˆæ˜¾ç¤ºçš„æ˜¯è™šæ‹Ÿåœ°å€ï¼‰ã€‚å¦‚æœ<strong>æŒ‡é’ˆæŒ‡å‘çš„åœ°å€ä¸åœ¨è¯¥æ–‡ä»¶ä¸­ä»»ä½•ä¸€ä¸ªå†…å­˜æ®µèŒƒå›´å†…</strong>ï¼Œå°±è¯´æ˜è¯¥å†…å­˜åœ°å€æ˜¯â€œéæ³•çš„ã€æ— æ•ˆçš„â€ã€‚ä¸è¿‡å³ä½¿å†…å­˜åœ°å€åˆæ³•ï¼Œå¦‚æœ<strong>æ²¡æœ‰å¯¹åº”å†…å­˜æ®µçš„è®¿é—®æƒé™</strong>ï¼Œä¹Ÿä¼šæŠ¥â€œéæ³•çš„å†…å­˜è®¿é—®â€ã€‚ä½¿ç”¨è¯¥åœ°å€æ—¶ï¼Œä¼šå…ˆé€šè¿‡MMUä¸­æŸ¥è¯¢ï¼Œå¦‚æœæ˜¯å‡ºç°äº†é¡µçš„æƒé™é”™è¯¯ï¼Œæˆ–è€…æ˜¯æ“ä½œç³»ç»Ÿå‘ç°å¹¶æ²¡æœ‰é¡µé¢å¯ä»¥æ¢å…¥ï¼ˆæœªåˆ†é…çš„ï¼‰ï¼Œé‚£ä¹ˆå®ƒä¼šè§¦å‘ä¸€ä¸ªâ€œè½¯ä¸­æ–­â€ã€‚åœ¨Linuxä¸­ï¼Œæ‰€è°“çš„è½¯ä¸­æ–­å…¶å®å°±æ˜¯ä¸€ä¸ªä¿¡å·(<code>signal</code>)ï¼Œç”±äºè®¿é—®éæ³•å†…å­˜åœ°å€å¯¼è‡´çš„é”™è¯¯å«ä½œæ®µé”™è¯¯<code>(segment fault)</code>ï¼Œå®ƒä¼šå‘å°„ä¸€ä¸ª<code>SIGSEGV</code>ä¿¡å·ï¼Œé»˜è®¤çš„è¡Œä¸ºå°±æ˜¯ç»ˆæ­¢è¿™ä¸ªç¨‹åºã€‚</p><p>åœ¨ä¸Šé¢çš„æµ‹è¯•ä»£ç ä¸­ï¼Œåœ¨å¹¶æ²¡æœ‰è°ƒç”¨ä»»ä½•<code>malloc()</code>æ—¶ï¼Œé€šè¿‡ <code>/proc/pid/maps</code> æ–‡ä»¶å¯ä»¥çœ‹åˆ°å †é¡¶çš„ä½ç½®åœ¨ä¸€ä¸ªå¤§å°ä¸º<code>132k</code>çš„å†…å­˜ç«¯çš„èµ·å§‹ä½ç½®ï¼Œæ­¤æ—¶å“ªæ€•ç›´æ¥è®¿é—®å †é¡¶ä»¥ä¸Šçš„æ•°æ®ï¼ˆåªè¦ä¸è¶…è¿‡<code>132k</code>çš„èŒƒå›´ï¼‰éƒ½ä¸ä¼šæŠ¥æ®µé”™è¯¯ï¼è€Œè¿›è¡Œä»»ä½•å¤§å°çš„<code>malloc(1)</code>è°ƒç”¨ï¼Œä½¿å¾—å †é¡¶æå‡<code>132k</code>ã€‚ä¹Ÿå°±æ˜¯è¯´è™½ç„¶å †å¤§å°ä¸º0ï¼Œä½†å®é™…ä¸Šæ“ä½œç³»ç»Ÿå·²ç»ä¸ºè¯¥è¿›ç¨‹åˆ†é…äº†<code>132k</code>çš„å †å†…å­˜ã€‚</p><h2 id="kill-å‡½æ•°"><a href="#kill-å‡½æ•°" class="headerlink" title="kill å‡½æ•°"></a>kill å‡½æ•°</h2><p>å‘æŒ‡å®šè¿›ç¨‹å‘é€æŒ‡å®šçš„ä¿¡å·ã€‚é»˜è®¤å‘é€çš„ä¿¡å·ä¸º<code>SIGTERM</code>ï¼Œè¯¥ä¿¡å·å¯ä»¥è¢«æ•è·ï¼Œæ‰€ä»¥ä¸ä¸€å®šèƒ½æ€æ­»è¿›ç¨‹ï¼Œä½†<code>SIGKILL(9)</code>æ€»èƒ½<strong>ä¸€å‡»å¿…æ€</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">kill</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> sig)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;pid:%d, ppid:%d\n&quot;</span>, getpid(), getppid());</span><br><span class="line">    kill(getppid(), SIGBUS); <span class="comment">// å‘çˆ¶è¿›ç¨‹å‘é€SIGBUSä¿¡å·</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;parent\n&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>sigï¼šä¿¡å·ç¼–å·ï¼Œä¸æ¨èç›´æ¥ä½¿ç”¨æ•°å­—ï¼Œåº”ä½¿ç”¨å®åã€‚</li><li>pidï¼šè¿›ç¨‹ç¼–å·<ul><li>pid &gt; 0ï¼šæŒ‡å®šè¿›ç¨‹ç¼–å·</li><li>pid &#x3D; 0ï¼šå‘ç»™ä¸killè°ƒç”¨è€…å±äºåŒä¸€è¿›ç¨‹ç»„çš„æ‰€æœ‰è¿›ç¨‹ï¼ŒåŒ…æ‹¬è°ƒç”¨è¿›ç¨‹è‡ªèº«</li><li>pid &#x3D; -1ï¼šå‘ç»™è¿›ç¨‹æœ‰æƒé™å‘é€çš„ æ‰€æœ‰è¿›ç¨‹ï¼Œé™¤å» initï¼ˆè¿›ç¨‹ ID ä¸º 1ï¼‰å’Œè°ƒç”¨è¿›ç¨‹è‡ªèº«ã€‚å¦‚æœç‰¹æƒçº§è¿›ç¨‹å‘èµ·è¿™ä¸€è°ƒç”¨ï¼Œé‚£ä¹ˆä¼šå‘é€ä¿¡å·ç»™ç³»ç»Ÿä¸­çš„æ‰€æœ‰è¿›ç¨‹</li><li>pid &lt; -1ï¼šå‘ç»™è¿›ç¨‹ç»„ç¼–å·ä¸ºabs(pid)çš„è¿›ç¨‹ç»„ä¸­çš„ æ‰€æœ‰è¿›ç¨‹</li></ul></li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</li></ul><p>è¿›ç¨‹ç»„: æ¯ä¸ªè¿›ç¨‹éƒ½å±äºä¸€ä¸ªè¿›ç¨‹ç»„ï¼Œè¿›ç¨‹ç»„æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹é›†åˆï¼Œä»–ä»¬ç›¸äº’å…³è”ï¼Œå…±åŒå®Œæˆä¸€ä¸ªå®ä½“ä»»åŠ¡ï¼Œæ¯ä¸ªè¿›ç¨‹ç»„éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹ç»„é•¿ï¼Œé»˜è®¤è¿›ç¨‹ç»„ID ä¸è¿›ç¨‹ç»„é•¿ID ç›¸åŒã€‚</p><p>æƒé™ä¿æŠ¤: super ç”¨æˆ·(root)å¯ä»¥å‘é€ä¿¡å·ç»™ä»»æ„ç”¨æˆ·ï¼Œæ™®é€šç”¨æˆ·æ˜¯ä¸èƒ½å‘ç³»ç»Ÿç”¨æˆ·å‘é€ä¿¡å·çš„ã€‚ kill -9 (root ç”¨æˆ·çš„pid) æ˜¯ä¸å¯ä»¥çš„ã€‚åŒæ ·ï¼Œæ™®é€šç”¨æˆ·ä¹Ÿä¸èƒ½å‘å…¶ä»–æ™®é€šç”¨æˆ·å‘é€ä¿¡å·ï¼Œç»ˆæ­¢å…¶è¿›ç¨‹ã€‚ åªèƒ½å‘è‡ªå·±åˆ›å»ºçš„è¿›ç¨‹å‘é€ä¿¡å·ã€‚æ™®é€šç”¨æˆ·åŸºæœ¬è§„åˆ™æ˜¯: <strong>å‘é€è€…å®é™…æˆ–æœ‰æ•ˆç”¨æˆ·ID &#x3D;&#x3D; æ¥æ”¶è€…å®é™…æˆ–æœ‰æ•ˆç”¨æˆ·ID</strong></p><h3 id="SIGQUIT"><a href="#SIGQUIT" class="headerlink" title="SIGQUIT"></a>SIGQUIT</h3><p>å½“ç”¨æˆ·åœ¨é”®ç›˜ä¸Šé”®å…¥é€€å‡ºå­—ç¬¦ï¼ˆé€šå¸¸ä¸º <code>Control-\</code>ï¼‰æ—¶ï¼Œè¯¥ä¿¡å·å°†å‘å¾€å‰å°è¿›ç¨‹ç»„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥ä¿¡å·ç»ˆæ­¢è¿›ç¨‹ï¼Œå¹¶ç”Ÿæˆå¯ç”¨äºè°ƒè¯•çš„æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ã€‚è¿›ç¨‹å¦‚æœé™·å…¥æ— é™å¾ªç¯ï¼Œæˆ–è€…ä¸å†å“åº”æ—¶ï¼Œä½¿ç”¨ <code>SIGQUIT</code> ä¿¡å·å°±å¾ˆåˆé€‚ã€‚é”®å…¥ <code>Control-\</code>ï¼Œå†è°ƒç”¨ <code>gdb</code> è°ƒè¯•å™¨åŠ è½½åˆšæ‰ç”Ÿæˆçš„æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œæ¥ç€ç”¨ <code>backtrace</code> å‘½ä»¤æ¥è·å–å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œå°±èƒ½å‘ç°æ­£åœ¨æ‰§è¡Œçš„æ˜¯ç¨‹åºçš„å“ªéƒ¨åˆ†ä»£ç ã€‚</p><h2 id="alarm-å‡½æ•°"><a href="#alarm-å‡½æ•°" class="headerlink" title="alarm å‡½æ•°"></a>alarm å‡½æ•°</h2><p>è®¾ç½®å®šæ—¶å™¨ï¼ˆé—¹é’Ÿï¼‰ï¼ŒæŒ‡å®šçš„ seconds åï¼Œå†…æ ¸ç»™è¿›ç¨‹å‘é€ SIGALRM ä¿¡å·ï¼Œé»˜è®¤åŠ¨ä½œä¸ºç»ˆæ­¢è¿›ç¨‹ã€‚</p><p><strong>æ¯ä¸ªè¿›ç¨‹æœ‰ä¸”åªæœ‰ä¸€ä¸ªå®šæ—¶å™¨</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="title function_">alarm</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> seconds)</span>;</span><br></pre></td></tr></table></figure><ul><li>secondsï¼šè®¾ç½®å®šæ—¶å™¨è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºç§’</li><li>è¿”å›å€¼ï¼šè¿”å›ä¹‹å‰è®¾ç½®çš„å®šæ—¶å™¨å‰©ä½™çš„æ—¶é—´ï¼Œä¹‹å‰æ²¡æœ‰è®¾ç½®è¿”å›0ã€‚æ— å¤±è´¥ï¼</li></ul><p>è®¡æ—¶ä¸è¿›ç¨‹çŠ¶æ€æ— å…³ï¼Œè‡ªç„¶è®¡æ—¶æ³•ã€‚</p><h2 id="setitimer-å‡½æ•°"><a href="#setitimer-å‡½æ•°" class="headerlink" title="setitimer å‡½æ•°"></a>setitimer å‡½æ•°</h2><p>ä¸ alarm åŠŸèƒ½ç±»ä¼¼ï¼Œç²¾åº¦ä¸ºå¾®ç§’ï¼Œå¯ä»¥å®ç°å‘¨æœŸå®šæ—¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getitimer</span><span class="params">(<span class="type">int</span> which, <span class="keyword">struct</span> itimerval *curr_value)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setitimer</span><span class="params">(<span class="type">int</span> which, <span class="type">const</span> <span class="keyword">struct</span> itimerval *new_value,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> itimerval *old_value)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">it_interval</span>;</span> <span class="comment">/* å‘¨æœŸå®šæ—¶ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">it_value</span>;</span>    <span class="comment">/* ä¸‹ä¸€æ¬¡æ—¶é—´ */</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> &#123;</span></span><br><span class="line">    <span class="type">time_t</span>      tv_sec;         <span class="comment">/* seconds */</span></span><br><span class="line">    <span class="type">suseconds_t</span> tv_usec;        <span class="comment">/* microseconds */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example ç¬¬ä¸€æ¬¡ä¸¤ç§’åæ‰§è¡Œï¼Œåç»­æ¯éš”äº”ç§’æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">myfunc</span><span class="params">(<span class="type">int</span> signo)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;hello\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    signal(SIGALRM, myfunc); <span class="comment">// æ³¨å†Œä¿¡å·çš„å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> <span class="title">new_value</span>;</span></span><br><span class="line">    new_value.it_interval.tv_sec = <span class="number">5</span>;</span><br><span class="line">    new_value.it_interval.tv_usec = <span class="number">0</span>;</span><br><span class="line">    new_value.it_value.tv_sec = <span class="number">2</span>;</span><br><span class="line">    new_value.it_value.tv_usec = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    setitimer(ITIMER_REAL, &amp;new_value, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>whichï¼šå®šæ—¶å™¨ç±»å‹<ul><li>ITIMER_REALï¼šçœŸå®æ—¶é—´ï¼ˆè‡ªç„¶è®¡æ—¶ï¼‰ï¼Œå‘é€ä¿¡å· SIGALRM</li><li>ITIMER_VIRTUALï¼šè™šæ‹Ÿç©ºé—´è®¡æ—¶ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰ï¼Œå‘é€ä¿¡å· SIGVTALRMã€‚è¿›ç¨‹å ç”¨CPUæ—¶é—´</li><li>ITIMER_PROFï¼šè¿è¡Œæ—¶è®¡æ—¶ï¼ˆç”¨æˆ·+å†…æ ¸ï¼‰ï¼Œå‘é€ä¿¡å· SIGPROFã€‚è¿›ç¨‹å ç”¨CPUæ—¶é—´åŠç³»ç»Ÿè°ƒç”¨æ—¶é—´</li></ul></li><li>new_valueï¼šè®¾ç½®æ–°çš„å®šæ—¶å™¨å€¼ï¼Œå¦‚æœä¸º NULLï¼Œåˆ™ä¸è®¾ç½®æ–°çš„å®šæ—¶å™¨å€¼ï¼Œåªè¿”å›æ—§çš„å®šæ—¶å™¨å€¼</li><li>old_valueï¼šè¿”å›æ—§çš„å®šæ—¶å™¨å€¼ï¼Œå¦‚æœä¸º NULLï¼Œåˆ™ä¸è¿”å›æ—§çš„å®šæ—¶å™¨å€¼</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</li></ul><p><code>time</code> å‘½ä»¤æŸ¥çœ‹ç¨‹åºæ‰§è¡Œæ—¶é—´ï¼Œrealæ€»æ—¶é—´ï¼Œuserç”¨æˆ·ç©ºé—´æ—¶é—´ï¼Œsysç³»ç»Ÿç©ºé—´æ—¶é—´ã€‚</p><h2 id="raise-å‡½æ•°"><a href="#raise-å‡½æ•°" class="headerlink" title="raise å‡½æ•°"></a>raise å‡½æ•°</h2><p>æœ‰æ—¶ï¼Œè¿›ç¨‹éœ€è¦å‘è‡ªèº«å‘é€ä¿¡å·ã€‚<code>raise()</code>å‡½æ•°å°±æ‰§è¡Œäº†è¿™ä¸€ä»»åŠ¡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">raise</span><span class="params">(<span class="type">int</span> sig)</span>;</span><br></pre></td></tr></table></figure><p>åœ¨å•çº¿ç¨‹ç¨‹åºä¸­ï¼Œè°ƒç”¨ <code>raise()</code>ç›¸å½“äºå¯¹ <code>kill()</code>çš„å¦‚ä¸‹è°ƒç”¨ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kill(getpid(), sig);</span><br></pre></td></tr></table></figure><p>æ”¯æŒçº¿ç¨‹çš„ç³»ç»Ÿä¼šå°† <code>raise(sig)</code> å®ç°ä¸ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pthread_kill(pthread_self(), sig);</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼Œ<code>raise()</code>å‡ºé”™å°†è¿”å›é 0 å€¼ï¼ˆä¸ä¸€å®šä¸ºâ€“1ï¼‰ã€‚è°ƒç”¨ <code>raise()</code> å”¯ä¸€å¯èƒ½å‘ç”Ÿçš„é”™è¯¯ä¸º EINVALï¼Œå³ sig æ— æ•ˆã€‚</p><h2 id="abort-å‡½æ•°"><a href="#abort-å‡½æ•°" class="headerlink" title="abort å‡½æ•°"></a>abort å‡½æ•°</h2><p>å‡½æ•° <code>abort()</code> ç»ˆæ­¢å…¶è°ƒç”¨è¿›ç¨‹ï¼Œå¹¶ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">abort</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>å‡½æ•° abort()é€šè¿‡äº§ç”Ÿ SIGABRT ä¿¡å·æ¥ç»ˆæ­¢è°ƒç”¨è¿›ç¨‹ã€‚å¯¹ SIGABRT çš„é»˜è®¤åŠ¨ä½œæ˜¯äº§ç”Ÿæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶å¹¶ç»ˆæ­¢è¿›ç¨‹ã€‚è°ƒè¯•å™¨å¯ä»¥åˆ©ç”¨æ ¸å¿ƒè½¬å‚¨æ–‡ä»¶æ¥æ£€æµ‹è°ƒç”¨ <code>abort()</code> æ—¶çš„ç¨‹åºçŠ¶æ€ã€‚</p><p>å¦‚æœ abort()æˆåŠŸç»ˆæ­¢äº†è¿›ç¨‹ï¼Œé‚£ä¹ˆè¿˜å°†åˆ·æ–° stdio æµå¹¶å°†å…¶å…³é—­ã€‚</p><h2 id="ä¿¡å·é›†æ“ä½œå‡½æ•°"><a href="#ä¿¡å·é›†æ“ä½œå‡½æ•°" class="headerlink" title="ä¿¡å·é›†æ“ä½œå‡½æ•°"></a>ä¿¡å·é›†æ“ä½œå‡½æ•°</h2><p>ä¿¡å·é›†<code>sigset_t</code>è™½ç„¶æ˜¯ä½å›¾ï¼Œä½†ä¸€èˆ¬ä¸å…è®¸ç›´æ¥å¯¹PCBä¸­çš„ä¿¡å·é›†è¿›è¡Œæ“ä½œï¼Œè€Œæ˜¯å…ˆè‡ªå®šä¹‰ä¸€ä¸ªä¿¡å·é›†ï¼Œç„¶åæ“ä½œè¿™ä¸ªä¿¡å·é›†ï¼Œæœ€åå†æŠŠä¿¡å·é›†é€šè¿‡æä¾›çš„å‡½æ•°ä¸PCBä¸­çš„ä¿¡å·é›†è¿›è¡Œè¿ç®—ï¼ˆä¸ã€æˆ–ã€è¦†ç›–ç­‰ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sigemptyset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;     <span class="comment">// å…¨éƒ¨æ¸…é›¶</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigfillset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;      <span class="comment">// å…¨éƒ¨ç½®1</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaddset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>; <span class="comment">// å°† signum ç½®1</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigdelset</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>; <span class="comment">// å°† signum ç½®0</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigismember</span><span class="params">(<span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">int</span> signum)</span>; <span class="comment">// åˆ¤æ–­ signum æ˜¯å¦ä¸º1</span></span><br></pre></td></tr></table></figure><h2 id="sigprocmask-å‡½æ•°"><a href="#sigprocmask-å‡½æ•°" class="headerlink" title="sigprocmask å‡½æ•°"></a>sigprocmask å‡½æ•°</h2><p>è®¾ç½®æ˜¯å¦å±è”½ä¿¡å·ï¼Œç±»ä¼¼å‡½æ•°ï¼š<code>pthread_sigmask</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigprocmask</span><span class="params">(<span class="type">int</span> how, <span class="type">const</span> <span class="type">sigset_t</span> *<span class="built_in">set</span>, <span class="type">sigset_t</span> *oldset)</span>;</span><br></pre></td></tr></table></figure><ul><li>howï¼šæ“ä½œæ–¹å¼<ul><li>SIG_BLOCKï¼šè®¾ç½®å±è”½ï¼Œ<code>mask = mask | set</code></li><li>SIG_UNBLOCKï¼šè§£é™¤å±è”½ï¼Œ<code>mask = mask &amp; ~set</code></li><li>SIG_SETMASKï¼šè¦†ç›–ï¼Œä¸æ¨èä½¿ç”¨ï¼Œ<code>mask = set</code></li></ul></li><li>setï¼šè‡ªå®šä¹‰çš„ä¼ å…¥ä¿¡å·é›†</li><li>oldsetï¼šè¿”å›æ—§çš„ä¿¡å·é›†</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</li></ul><h2 id="sigpending-å‡½æ•°"><a href="#sigpending-å‡½æ•°" class="headerlink" title="sigpending å‡½æ•°"></a>sigpending å‡½æ•°</h2><p>è¯»å–å½“å‰è¿›ç¨‹çš„æœªå†³ä¿¡å·é›†ã€‚å¹¶å°†å…¶ç½®äº set æŒ‡å‘çš„ sigset_t ç»“æ„ä¸­ã€‚éšåå¯ä»¥ä½¿ç”¨ <code>sigismember()</code>å‡½æ•°æ¥æ£€æŸ¥ setã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigpending</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line">sigpending(&amp;<span class="built_in">set</span>);</span><br></pre></td></tr></table></figure><ul><li>setï¼šä¼ å‡ºå‚æ•°ï¼Œè¿”å›æœªå†³ä¿¡å·é›†</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›-1</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">print_set</span><span class="params">(<span class="type">sigset_t</span> *<span class="built_in">set</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">1</span>; i &lt; <span class="number">33</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sigismember(<span class="built_in">set</span>, i))</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;has : %d\n&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">sigset_t</span> pend, in;</span><br><span class="line">    sigemptyset(&amp;in);</span><br><span class="line">    sigaddset(&amp;in, SIGINT);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;in, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        sigpending(&amp;pend);</span><br><span class="line">        print_set(&amp;pend);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="signal-å‡½æ•°"><a href="#signal-å‡½æ•°" class="headerlink" title="signal å‡½æ•°"></a>signal å‡½æ•°</h2><p>UNIX ç³»ç»Ÿæä¾›äº†ä¸¤ç§æ–¹æ³•æ¥æ”¹å˜ä¿¡å·å¤„ç½®ï¼š<code>signal()</code> å’Œ <code>sigaction()</code>ã€‚<code>signal()</code>çš„è¡Œä¸ºåœ¨ä¸åŒ UNIX å®ç°é—´å­˜åœ¨å·®å¼‚ï¼Œè¿™ä¹Ÿæ„å‘³ç€å¯¹å¯ç§»æ¤æ€§æœ‰æ‰€è¿½æ±‚çš„ç¨‹åºç»ä¸èƒ½ä½¿ç”¨æ­¤è°ƒç”¨æ¥å»ºç«‹ä¿¡å·å¤„ç†å™¨å‡½æ•°ã€‚æ•…æ­¤ï¼Œ<code>sigaction()</code>æ˜¯å»ºç«‹ä¿¡å·å¤„ç†å™¨çš„é¦–é€‰ APIï¼ˆå¼ºåŠ›æ¨ï¼‰ã€‚</p><p>æ³¨å†Œä¸€ä¸ªä¿¡å·æ•æ‰å‡½æ•°ï¼Œå½“æ”¶åˆ°ä¿¡å·æ—¶ï¼Œè°ƒç”¨è¯¥å‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">void</span> <span class="params">(*<span class="type">sighandler_t</span>)</span><span class="params">(<span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">sighandler_t</span> <span class="title function_">signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">sighandler_t</span> handler)</span>;</span><br></pre></td></tr></table></figure><ul><li>signumï¼šè¦æ³¨å†Œçš„ä¿¡å·ç¼–å·ï¼Œ<strong>è¯¥å‚æ•°å¯ä»¥æ˜¯é™¤å» <code>SIGKILL</code> å’Œ <code>SIGSTOP</code> ä¹‹å¤–çš„ä»»ä½•ä¿¡å·</strong>ã€‚</li><li>handlerï¼šä¿¡å·å¤„ç†å‡½æ•°ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å‡½æ•°æŒ‡é’ˆï¼Œå‡½æ•°çš„å‚æ•°æ˜¯ä¿¡å·ç¼–å·</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›ä¹‹å‰çš„ä¿¡å·å¤„ç†å‡½æ•°ï¼Œå¤±è´¥è¿”å›<code>SIG_ERR</code>ï¼Œå¹¶è®¾ç½®errno</li></ul><p>åœ¨ä¸º <code>signal()</code>æŒ‡å®š handler å‚æ•°æ—¶ï¼Œå¯ä»¥ä»¥å¦‚ä¸‹å€¼æ¥ä»£æ›¿å‡½æ•°åœ°å€ï¼š</p><ul><li><strong>SIG_DFL</strong> å°†ä¿¡å·å¤„ç½®é‡ç½®ä¸ºé»˜è®¤å€¼ã€‚è¿™é€‚ç”¨äºå°†ä¹‹å‰ signal()è°ƒç”¨æ‰€æ”¹å˜çš„ä¿¡å·å¤„ç½®è¿˜åŸã€‚</li><li><strong>SIG_IGN</strong> å¿½ç•¥è¯¥ä¿¡å·ã€‚å¦‚æœä¿¡å·ä¸“ä¸ºæ­¤è¿›ç¨‹è€Œç”Ÿï¼Œé‚£ä¹ˆå†…æ ¸ä¼šé»˜é»˜å°†å…¶ä¸¢å¼ƒã€‚è¿›ç¨‹ç”šè‡³ä»æœªçŸ¥é“æ›¾ç»äº§ç”Ÿäº†è¯¥ä¿¡å·ã€‚</li></ul><h2 id="sigaction-å‡½æ•°"><a href="#sigaction-å‡½æ•°" class="headerlink" title="sigaction å‡½æ•°"></a>sigaction å‡½æ•°</h2><p>åŒ signal å‡½æ•°ï¼Œæ³¨å†Œä¸€ä¸ªä¿¡å·æ•æ‰å‡½æ•°ï¼Œåœ¨å»ºç«‹ä¿¡å·å¤„ç†å™¨ç¨‹åºæ—¶ï¼Œ<code>sigaction()</code>è¾ƒä¹‹ <code>signal()</code>å‡½æ•°å¯ç§»æ¤æ€§æ›´ä½³ã€‚</p><p><code>sigaction()</code>å…è®¸åœ¨è·å–ä¿¡å·å¤„ç½®çš„åŒæ—¶æ— éœ€å°†å…¶æ”¹å˜ï¼Œå¹¶ä¸”ï¼Œè¿˜å¯è®¾ç½®å„ç§å±æ€§å¯¹è°ƒç”¨ä¿¡å·å¤„ç†å™¨ç¨‹åºæ—¶çš„è¡Œä¸ºæ–½ä»¥æ›´åŠ ç²¾å‡†çš„æ§åˆ¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sigaction</span><span class="params">(<span class="type">int</span> signum, <span class="type">const</span> <span class="keyword">struct</span> sigaction *act,</span></span><br><span class="line"><span class="params">                <span class="keyword">struct</span> sigaction *oldact)</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> &#123;</span></span><br><span class="line">    <span class="type">void</span>     (*sa_handler)(<span class="type">int</span>);   <span class="comment">// ä¿¡å·å¤„ç†å‡½æ•°</span></span><br><span class="line">    <span class="type">void</span>     (*sa_sigaction)(<span class="type">int</span>, <span class="type">siginfo_t</span> *, <span class="type">void</span> *); <span class="comment">// ä¸€èˆ¬ä¸ç”¨</span></span><br><span class="line">    <span class="type">sigset_t</span>   sa_mask; <span class="comment">// ä¿¡å·å±è”½å­—ï¼Œåªä½œç”¨äºä¿¡å·æ•æ‰å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼</span></span><br><span class="line">    <span class="type">int</span>        sa_flags; <span class="comment">// =0 æ—¶ï¼Œä¿¡å·æ•æ‰å‡½æ•°æ‰§è¡ŒæœŸé—´å±è”½å½“å‰ä¿¡å·</span></span><br><span class="line">    <span class="type">void</span>     (*sa_restorer)(<span class="type">void</span>);  <span class="comment">// åºŸå¼ƒ</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_set</span><span class="params">(<span class="type">int</span> signo)</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;catch you : %d\n&quot;</span>, signo);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>, <span class="title">oldact</span>;</span></span><br><span class="line">    act.sa_handler = print_set;</span><br><span class="line">    sigemptyset(&amp;act.sa_mask);</span><br><span class="line">    act.sa_flags = <span class="number">0</span>;</span><br><span class="line">    sigaction(SIGINT, &amp;act, &amp;oldact);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¿¡å·æ•æ‰ç‰¹æ€§"><a href="#ä¿¡å·æ•æ‰ç‰¹æ€§" class="headerlink" title="ä¿¡å·æ•æ‰ç‰¹æ€§"></a>ä¿¡å·æ•æ‰ç‰¹æ€§</h3><ol><li>è¿›ç¨‹æ­£å¸¸è¿è¡Œæ—¶ï¼Œé»˜è®¤ PCB ä¸­æœ‰ä¸€ä¸ªä¿¡å·å±è”½å®‡ï¼Œå‡å®šä¸º Xï¼Œå®ƒå†³å®šäº†è¿›ç¨‹è‡ªåŠ¨å±è”½å“ªäº›ä¿¡å·ã€‚å½“æ³¨å†Œäº†æŸä¸ªä¿¡å·æ•æ‰å‡½æ•°ï¼Œæ•æ‰åˆ°è¯¥ä¿¡å·ä»¥åï¼Œè¦è°ƒç”¨è¯¥å‡½æ•°ã€‚è€Œè¯¥å‡½æ•°æœ‰å¯èƒ½æ‰§è¡Œå¾ˆé•¿æ—¶é—´ï¼Œåœ¨è¿™æœŸé—´æ‰€å±è”½çš„ä¿¡å·ä¸ç”±Xæ¥æŒ‡å®šã€‚è€Œæ˜¯ç”¨ sa_mask æ¥æŒ‡å®šã€‚è°ƒç”¨å®Œä¿¡å·å¤„ç†å‡½æ•°ï¼Œå†æ¢å¤ä¸º Xã€‚</li><li>XXX ä¿¡å·æ•æ‰å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼ŒXXX ä¿¡å·è‡ªåŠ¨è¢«å±è”½ï¼ˆsa_flags&#x3D;0ï¼‰ã€‚</li><li>é˜»å¡çš„å¸¸è§„ä¿¡å·ä¸æ”¯æŒæ’é˜Ÿï¼Œäº§ç”Ÿå¤šæ¬¡åªè®°å½•ä¸€æ¬¡ã€‚(å 32 ä¸ªå®æ—¶ä¿¡å·æ”¯æŒæ’é˜Ÿ)</li><li>XXX ä¿¡å·æ•æ‰å‡½æ•°æ‰§è¡ŒæœŸé—´ï¼Œè‹¥ä¿¡å· B æœªè¢«å±è”½ï¼Œå½“ä¿¡å· B é€’è¾¾æ—¶ï¼Œä¼šä»å½“å‰çš„æ‰§è¡Œå‡½æ•°è·³è½¬åˆ° B ä¿¡å·çš„å¤„ç†å‡½æ•°ã€‚ï¼ˆä¿¡å·å°±åƒä¸­æ–­ï¼Œæ¥äº†å°±æ‰“æ–­å½“å‰æ“ä½œï¼‰ã€‚</li></ol><h3 id="sa-flags"><a href="#sa-flags" class="headerlink" title="sa_flags"></a>sa_flags</h3><ul><li><strong>SA_RESTART</strong>ï¼šå½“ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¢«ä¿¡å·ä¸­æ–­æ—¶ï¼Œä¿¡å·å¤„ç†ç»“æŸæ¢å¤æ‰§è¡Œç³»ç»Ÿè°ƒç”¨ã€‚ï¼ˆä¸å¹¸çš„æ˜¯ï¼Œå¹¶éæ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨éƒ½å¯ä»¥é€šè¿‡æŒ‡å®š SA_RESTART æ¥è¾¾åˆ°è‡ªåŠ¨é‡å¯çš„ç›®çš„ã€‚ï¼‰</li><li><strong>SA_NODEFER</strong>ï¼šæ•è·è¯¥ä¿¡å·æ—¶ï¼Œä¸ä¼šåœ¨æ‰§è¡Œå¤„ç†å™¨ç¨‹åºæ—¶å°†è¯¥ä¿¡å·è‡ªåŠ¨æ·»åŠ åˆ°è¿›ç¨‹æ©ç ä¸­ï¼ˆå³ä¸å±è”½å½“å‰ä¿¡å·ï¼‰ã€‚</li></ul><h3 id="å¯é‡å…¥å‡½æ•°"><a href="#å¯é‡å…¥å‡½æ•°" class="headerlink" title="å¯é‡å…¥å‡½æ•°"></a>å¯é‡å…¥å‡½æ•°</h3><p>SUSv3 å¯¹å¯é‡å…¥å‡½æ•°çš„å®šä¹‰æ˜¯ï¼š<strong>å‡½æ•°ç”±ä¸¤æ¡æˆ–å¤šæ¡çº¿ç¨‹è°ƒç”¨æ—¶ï¼Œå³ä¾¿æ˜¯äº¤å‰æ‰§è¡Œï¼Œå…¶æ•ˆæœä¹Ÿä¸å„çº¿ç¨‹ä»¥æœªå®šä¹‰é¡ºåºä¾æ¬¡è°ƒç”¨æ—¶ä¸€è‡´ã€‚</strong></p><p>æ›´æ–°å…¨å±€å˜é‡æˆ–é™æ€æ•°æ®ç»“æ„çš„å‡½æ•°å¯èƒ½æ˜¯ä¸å¯é‡å…¥çš„ï¼Œåœ¨ C è¯­è¨€æ ‡å‡†å‡½æ•°åº“ä¸­ï¼Œè¿™ç§å¯èƒ½æ€§éå¸¸æ™®éã€‚åªç”¨åˆ°æœ¬åœ°å˜é‡çš„å‡½æ•°è‚¯å®šæ˜¯å¯é‡å…¥çš„ã€‚</p><p><code>malloc()</code>å’Œ <code>free()</code>å°±ç»´æŠ¤æœ‰ä¸€ä¸ªé’ˆå¯¹å·²é‡Šæ”¾å†…å­˜å—çš„é“¾è¡¨ï¼Œç”¨äºä»å †ä¸­é‡æ–°åˆ†é…å†…å­˜ã€‚</p><p>å°†é™æ€æ•°æ®ç»“æ„ç”¨äºå†…éƒ¨è®°è´¦çš„å‡½æ•°ä¹Ÿæ˜¯ä¸å¯é‡å…¥çš„ã€‚å…¶ä¸­æœ€æ˜æ˜¾çš„ä¾‹å­å°±æ˜¯ <strong>stdio å‡½æ•°åº“æˆå‘˜ï¼ˆ<code>printf()</code>ã€<code>scanf()</code>ç­‰ï¼‰</strong>ï¼Œå®ƒä»¬ä¼šä¸ºç¼“å†²åŒº I&#x2F;O æ›´æ–°å†…éƒ¨æ•°æ®ç»“æ„ã€‚å¦‚æœåœ¨ä¿¡å·å¤„ç†å™¨å‡½æ•°ä¸­è°ƒç”¨äº† printf()ï¼Œè€Œä¸»ç¨‹åºåˆåœ¨è°ƒç”¨ printf()æˆ–å…¶ä»– stdio å‡½æ•°æœŸé—´é­åˆ°äº†å¤„ç†å™¨å‡½æ•°çš„ä¸­æ–­ï¼Œé‚£ä¹ˆæœ‰æ—¶å°±ä¼šçœ‹åˆ°å¥‡æ€ªçš„è¾“å‡ºï¼Œç”šè‡³å¯¼è‡´ç¨‹åºå´©æºƒæˆ–è€…æ•°æ®çš„æŸåã€‚</p><h3 id="å¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°"><a href="#å¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°" class="headerlink" title="å¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°"></a>å¼‚æ­¥ä¿¡å·å®‰å…¨å‡½æ•°</h3><p>å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°æ˜¯æŒ‡å½“ä»ä¿¡å·å¤„ç†å™¨å‡½æ•°è°ƒç”¨æ—¶ï¼Œå¯ä»¥ä¿è¯å…¶å®ç°æ˜¯å®‰å…¨çš„ã€‚å¦‚æœæŸä¸€å‡½æ•°æ˜¯å¯é‡å…¥çš„ï¼Œåˆæˆ–è€…ä¿¡å·å¤„ç†å™¨å‡½æ•°æ— æ³•å°†å…¶ä¸­æ–­æ—¶ï¼Œå°±ç§°è¯¥å‡½æ•°æ˜¯å¼‚æ­¥ä¿¡å·å®‰å…¨çš„ã€‚</p><h2 id="pause-å‡½æ•°"><a href="#pause-å‡½æ•°" class="headerlink" title="pause å‡½æ•°"></a>pause å‡½æ•°</h2><p>è°ƒç”¨ <code>pause()</code>å°†æš‚åœè¿›ç¨‹çš„æ‰§è¡Œï¼Œç›´è‡³ä¿¡å·å¤„ç†å™¨å‡½æ•°ä¸­æ–­è¯¥è°ƒç”¨ä¸ºæ­¢ï¼ˆå³æœ‰ä¿¡å·åˆ°è¾¾ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pause</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>å¤„ç†ä¿¡å·æ—¶ï¼Œ<code>pause()</code>é­åˆ°ä¸­æ–­ï¼Œå¹¶æ€»æ˜¯è¿”å›âˆ’1ï¼Œå¹¶å°† errno ç½®ä¸º EINTRã€‚</p><h2 id="SIGCHLD-ä¿¡å·"><a href="#SIGCHLD-ä¿¡å·" class="headerlink" title="SIGCHLD ä¿¡å·"></a>SIGCHLD ä¿¡å·</h2><p>å­è¿›ç¨‹çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œçˆ¶è¿›ç¨‹ä¼šæ”¶åˆ° SIGCHLD ä¿¡å·ã€‚</p><ul><li>å­è¿›ç¨‹ç»ˆæ­¢æ—¶ã€‚</li><li>å­è¿›ç¨‹æ¥æ”¶åˆ° SIGSTOP ä¿¡å·åœæ­¢æ—¶ã€‚</li><li>å­è¿›ç¨‹å¤„åœ¨åœæ­¢æ€ï¼Œæ¥å—åˆ°SIGCONT åå”¤é†’æ—¶</li></ul><p>å€ŸåŠ© SIGCHILD ä¿¡å·å›æ”¶å­è¿›ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">catch_chld</span><span class="params">(<span class="type">int</span> signo)</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> wpid;</span><br><span class="line">    <span class="comment">// æ³¨æ„è¿™é‡Œä½¿ç”¨çš„é˜»å¡çš„æ–¹å¼å›æ”¶ï¼å½“ä¸å­˜åœ¨å¾…å›æ”¶çš„å­è¿›ç¨‹æ—¶ï¼Œè¿”å›-1ã€‚</span></span><br><span class="line">    <span class="keyword">while</span>((wpid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;catch child id: %d\n&quot;</span>, wpid);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">sigset_t</span> <span class="built_in">set</span>;</span><br><span class="line">    <span class="comment">// å…ˆé˜»å¡ä¿¡å·ï¼Œé˜²æ­¢çˆ¶è¿›ç¨‹è¿˜æœªæ³¨å†Œå¤„ç†å‡½æ•°ï¼Œå­è¿›ç¨‹å°±ç»“æŸäº†</span></span><br><span class="line">    sigaddset(&amp;<span class="built_in">set</span>, SIGCHLD);</span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;<span class="built_in">set</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">15</span>; i++)</span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">15</span>) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act</span>;</span></span><br><span class="line">        act.sa_handler = catch_chld;</span><br><span class="line">        sigemptyset(&amp;act.sa_mask);</span><br><span class="line">        act.sa_flags = <span class="number">0</span>;</span><br><span class="line">        sigaction(SIGCHLD, &amp;act, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="comment">// è§£é™¤é˜»å¡</span></span><br><span class="line">        <span class="comment">// sigdelset(&amp;set, SIGCHLD);</span></span><br><span class="line">        sigprocmask(SIG_UNBLOCK, &amp;<span class="built_in">set</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i&#x27;m parent, pid = %d\n&quot;</span>, getpid());</span><br><span class="line">        <span class="keyword">while</span>(<span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;i&#x27;m child, pid = %d\n&quot;</span>, getpid());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>äº†è§£ä¿¡å·äº§ç”Ÿæ¡ä»¶ï¼Œä¿¡å·é»˜è®¤å¤„ç†æ–¹å¼ï¼Œä¿®æ”¹ä¿¡å·é»˜è®¤å¤„ç†æ–¹å¼ã€‚</li><li>ä¿¡å·å¤„ç†å‡½æ•°è¦ç®€æ´ï¼ä¸”å¿…é¡»ä¿è¯ä¸º<strong>å¯é‡å…¥å‡½æ•°</strong>æˆ–<strong>å¼‚æ­¥ä¿¡å·å®‰å…¨çš„å‡½æ•°</strong>ã€‚</li><li><code>SIGKILL, SIGSTOP</code>æ— æ³•æ•è·ï¼Œæ— æ³•ä¿®æ”¹å¤„ç†æ–¹å¼ã€‚</li><li><code>SIGCHLD</code>ä¿¡å·ä¸ä¸€å®šæ˜¯å­è¿›ç¨‹ç»“æŸï¼</li><li><code>SIGABRT</code>ä¿¡å·ï¼ˆ<code>control + \</code>ï¼‰å¯ç”Ÿæˆæ ¸å¿ƒè½¬å‚¨æ–‡ä»¶ï¼Œéå¸¸æ–¹ä¾¿è°ƒè¯•ç¨‹åºã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a href="https://elixir.bootlin.com/linux/v5.4.190/source/include/linux/sched.h#L913">PCB ä¸­ä¿¡å·ç›¸å…³å†…å®¹ L913~L923</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-è¿›ç¨‹é€šä¿¡</title>
      <link href="/2022/04/25/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/"/>
      <url>/2022/04/25/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/</url>
      
        <content type="html"><![CDATA[<h2 id="è¿›ç¨‹é€šä¿¡"><a href="#è¿›ç¨‹é€šä¿¡" class="headerlink" title="è¿›ç¨‹é€šä¿¡"></a>è¿›ç¨‹é€šä¿¡</h2><p>è¿›ç¨‹ä¹‹é—´æ˜¯å­˜åœ¨å†…å­˜éš”ç¦»çš„ï¼Œæ‰€ä»¥è¿›ç¨‹é—´é€šä¿¡ç›¸å¯¹äºçº¿ç¨‹é—´é€šä¿¡æ¯”è¾ƒéº»çƒ¦ï¼Œå¯¹äºä¸¤ä¸ªå®Œå…¨éš”ç¦»çš„äº‹ç‰©è‚¯å®šæ˜¯æ²¡åŠæ³•è¿›è¡Œé€šä¿¡çš„ï¼ä¸è¿‡å¥½åœ¨è¿›ç¨‹å¹¶ä¸æ˜¯å®Œå…¨éš”ç¦»çš„ï¼Œæ¯ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­éƒ½æœ‰ä¸€æ®µå…±ç”¨çš„å†…æ ¸ç©ºé—´ï¼Œè¿™å°±ç›¸å½“äºåœ¨ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´æ¶äº†ä¸€åº§æ¡¥ã€‚æ‰€ä»¥ä¸‹é¢ä»‹ç»çš„å¾ˆå¤šé€šä¿¡æ–¹æ³•éƒ½æ˜¯åŸºäºè¿™åº§æ¡¥ï¼ˆå†…æ ¸ï¼‰å®ç°çš„ã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/4-%E8%BF%9B%E7%A8%8B%E7%A9%BA%E9%97%B4.jpg" alt="img"></p><blockquote><p>æœ¬æ–‡ä¸­çš„éƒ¨åˆ†å›¾ç‰‡æ¥æºäºï¼š<a href="https://xiaolincoding.com/os/4_process/process_commu.html#%E7%AE%A1%E9%81%93">å°æ—coding</a></p></blockquote><h3 id="æ ‡è¯†"><a href="#æ ‡è¯†" class="headerlink" title="æ ‡è¯†"></a>æ ‡è¯†</h3><p>ä¸è¿‡å†…æ ¸åœ°å€ç©ºé—´ä¹Ÿä¸èƒ½éšä¾¿ç»™å„ä¸ªè¿›ç¨‹ç”¨ï¼Œè€Œä¸”ç©ºé—´é‚£ä¹ˆå¤§ï¼Œè¿›ç¨‹æ€ä¹ˆçŸ¥é“è¦å»å“ªé‡Œè¯»å†™å‘¢ï¼Ÿç¬¬ä¸€ä¸ªé—®é¢˜å¥½è§£å†³ï¼Œæ¯å½“â€™æˆ‘â€™éœ€è¦å’Œå…¶ä»–è¿›ç¨‹é€šä¿¡ï¼Œæˆ‘å°±å…ˆå‘å†…æ ¸ç”³è¯·ä¸€å—â€œä¸­ç»§å†…å­˜â€ï¼Œç„¶åå°±å¯ä»¥å‘è¯¥åœ°å€ä¸­å†™æ•°æ®äº†ã€‚ä¸è¿‡ç¬¬äºŒä¸ªé—®é¢˜ï¼Œå…¶ä»–éœ€è¦è¯»æ•°æ®çš„è¿›ç¨‹æ€ä¹ˆçŸ¥é“å»å“ªé‡Œè¯»å‘¢ï¼Ÿç»™è¯»è¿›ç¨‹æŒ‡å®šå†…å­˜åœ°å€ï¼Ÿä½†è¿›ç¨‹æœªå¯åŠ¨çš„æ—¶å€™æ˜¯ä¸å¯èƒ½çŸ¥é“â€™æˆ‘â€™å‘å†…æ ¸ç”³è¯·çš„å†…å­˜åœ°å€ä¿¡æ¯çš„ã€‚å”‰ï¼Œåœ†ä¸äº†è¯äº†ï¼Œåæ­£å°±æ˜¯æƒ³ä¸€æƒ³æ–‡ä»¶çš„ä½¿ç”¨ï¼Œæˆ‘åŒæ ·ä¸çŸ¥é“æ–‡ä»¶çš„å†…å­˜åœ°å€ï¼Œä½†æˆ‘åªè¦çŸ¥é“æ–‡ä»¶çš„è·¯å¾„ï¼Œä¸ç®¡å¼€å¤šå°‘ä¸ªè¿›ç¨‹å»æ‰“å¼€è¯¥æ–‡ä»¶ï¼Œè¯»åˆ°çš„éƒ½æ˜¯ç›¸åŒçš„å†…å®¹ï¼ˆè™½ç„¶æ–‡ä»¶æ˜¯å­˜å‚¨åœ¨ç£ç›˜è€Œä¸æ˜¯å†…å­˜ä¸Šï¼Œä¸è¿‡é“ç†ç±»ä¼¼ï¼‰ã€‚</p><p>è¿™é‡Œçš„â€œè·¯å¾„+æ–‡ä»¶åâ€å°±æ„æˆäº†è¿™ä¸ªæ–‡ä»¶å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ï¼Œæˆ‘ä»¬åœ¨è¿›ç¨‹é€šä¿¡æ—¶ï¼Œ<strong>ä¹Ÿéœ€è¦ä¸€ä¸ªèƒ½å”¯ä¸€æ ‡è¯†â€œä¸­ç»§å†…å­˜â€çš„æ ‡è¯†ç¬¦</strong>ï¼Œå®é™…ä¸Šï¼Œ<code>Unix Socket</code>ã€<code>fifo</code>å°±æ˜¯é‡‡ç”¨äº†â€œè·¯å¾„+æ–‡ä»¶åâ€ä½œä¸ºæ ‡è¯†ï¼è€Œä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜è¿™ä¸‰ç§é€šä¿¡æ–¹å¼åœ¨Linuxä¸Šæœ‰ä¸¤ç§æ ‡å‡†å®ç°ï¼Œ<code>System V</code>å’Œ<code>POSIX</code>ï¼Œå‰è€…é€šè¿‡åœ¨ä½¿ç”¨<strong>ä¸€ä¸ªæ•´æ•°</strong><code>key</code>æ¥æ ‡è¯†å¯¹è±¡ï¼Œåè€…ä½¿ç”¨<strong>å¯¹è±¡å</strong>æ¥å®ç°ï¼ˆè·Ÿæ–‡ä»¶å¾ˆåƒäº†ï¼‰ã€‚<code>Socket</code>ä½¿ç”¨<code>ip+port</code>ä½œä¸ºæ ‡è¯†ã€‚</p><p>è™½ç„¶å¤§éƒ¨åˆ†è¿›ç¨‹é—´é€šä¿¡éƒ½éœ€è¦é€šè¿‡â€œå”¯ä¸€æ ‡è¯†â€å»è·å–å¯¹åº”çš„ä¸­ç»§å¯¹è±¡ï¼Œä¸è¿‡ä¹Ÿä¸ç»å¯¹ï¼Œç”±äºåœ¨<code>fork</code>æ—¶ï¼Œå­è¿›ç¨‹ä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„ä¿¡æ¯ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥åŸºäºæ­¤è®¾è®¡ï¼Œæ¯”å¦‚ç®¡é“<code>pipe</code>ã€‚</p><table><thead><tr><th>æ–¹å¼</th><th>æ ‡è¯†</th><th>é™åˆ¶</th></tr></thead><tbody><tr><td>pipe</td><td>æ— ï¼ˆåªèƒ½ç”¨äºæœ‰è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ï¼‰</td><td>å®¹é‡</td></tr><tr><td>fifo</td><td>è·¯å¾„+æ–‡ä»¶å<code>/tmp/myfifo</code></td><td>å®¹é‡</td></tr><tr><td>System V ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜</td><td>æ•´æ•°</td><td>ipcs -l</td></tr><tr><td>POSIX æ¶ˆæ¯é˜Ÿåˆ—</td><td></td><td>æ¶ˆæ¯å¤§å°ã€æ•°é‡</td></tr><tr><td>POSIX ä¿¡å·é‡ã€æ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜</td><td>å¯¹è±¡å<code>/myobject</code></td><td></td></tr><tr><td>æ–‡ä»¶æ˜ å°„ï¼ˆå†…å­˜æ˜ å°„ï¼‰</td><td>è·¯å¾„+æ–‡ä»¶å<code>/tmp/myfile</code></td><td></td></tr><tr><td>åŒ¿åæ˜ å°„ï¼ˆå†…å­˜æ˜ å°„ï¼‰</td><td>æ— ï¼ˆåªèƒ½ç”¨äºæœ‰è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹é—´ï¼‰</td><td></td></tr><tr><td>Unix Domain Socket</td><td>è·¯å¾„+æ–‡ä»¶å <code>/tmp/mysock.sock</code></td><td></td></tr><tr><td>Socket</td><td>IP + port</td><td></td></tr></tbody></table><h3 id="æ–¹å¼æ±‡æ€»"><a href="#æ–¹å¼æ±‡æ€»" class="headerlink" title="æ–¹å¼æ±‡æ€»"></a>æ–¹å¼æ±‡æ€»</h3><p>Linux ä¸‹ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œç”¨äºè¿›ç¨‹é€šä¿¡çš„å¯¹è±¡ä¹Ÿä¸ä¾‹å¤–ï¼Œæ‰€ä»¥<code>pipe</code>ã€<code>fifo</code>ã€<code>socket</code>ç”šè‡³æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæ‰“å¼€åéƒ½ä¼šåˆ†é…ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œé€šè¿‡æ–‡ä»¶æè¿°ç¬¦æ¥è¯»å†™æ•°æ®ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—æœ‰ç‚¹ç‰¹æ®Šï¼‰ã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/processIPC.png" alt="processIPC"></p><h2 id="pipe"><a href="#pipe" class="headerlink" title="pipe"></a>pipe</h2><blockquote><p>æ ‡è¯†ï¼šæ— ï¼Œé€šè¿‡ fork æ—¶å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦çš„åŸç†ã€‚</p></blockquote><p><code>Pipe</code> ç®¡é“<strong>å¹¶ä¸ä¼š</strong>åœ¨å†…æ ¸æˆ–æ–‡ä»¶ç³»ç»Ÿä¸Šäº§ç”Ÿå”¯ä¸€çš„æ ‡è¯†ï¼Œå®ƒåŸºäº<code>fork()</code>è°ƒç”¨æ—¶ï¼Œå­è¿›ç¨‹ä¼šæ‹·è´çˆ¶è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦åˆ—è¡¨ï¼Œè¾¾åˆ°å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ä¸ªç®¡é“çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä»è€Œå®ç°è¿›ç¨‹é—´é€šä¿¡ã€‚ä¹Ÿå°±é™åˆ¶äº†<code>Pipe</code>ç®¡é“åªèƒ½ç”¨äºæœ‰è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹é—´é€šä¿¡ã€‚</p><p><code>fork()</code>ä¹‹å‰åˆ›å»ºç®¡é“<code>pipe(fd[2])</code>ï¼Œè¿™æ ·æ¯ä¸ªå­è¿›ç¨‹éƒ½æœ‰è¯»ç«¯<code>fd[0]</code>å’Œå†™ç«¯<code>fd[1]</code>ã€‚ä¸æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ä¸€æ ·ï¼Œå¯ä»¥ä½¿ç”¨ <code>read()</code>å’Œ<code>write()</code>ç³»ç»Ÿè°ƒç”¨æ¥åœ¨ç®¡é“ä¸Šæ‰§è¡Œ I&#x2F;Oã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/7-%E7%AE%A1%E9%81%93-pipe-fork-%E5%8D%95%E5%90%91%E9%80%9A%E4%BF%A1.jpg" alt="img"></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">pipe</span><span class="params">(<span class="type">int</span> pipefd[<span class="number">2</span>])</span>;</span><br></pre></td></tr></table></figure><ul><li><code>pipefd[0]</code> è¯»ç«¯</li><li><code>pipefd[1]</code> å†™ç«¯</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å› <code>0</code></li><li>å¤±è´¥ç¿»è¯‘ <code>-1</code> ï¼Œå¹¶è®¾ç½® <code>errno</code></li></ul></li></ul><h3 id="example"><a href="#example" class="headerlink" title="example"></a>example</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd[<span class="number">2</span>];</span><br><span class="line">    pipe(fd);   <span class="comment">// åˆ›å»º pipe</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *str = <span class="string">&quot;child write date!\n&quot;</span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>];  <span class="comment">// = &quot;&quot;;  // ä¸è®¾ç½®ä¸ºç©ºå¯èƒ½ä¼šå‡ºç°å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;  <span class="comment">// child process</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child: %d, %d\n&quot;</span>, fd[<span class="number">0</span>], fd[<span class="number">1</span>]);</span><br><span class="line">        close(fd[<span class="number">0</span>]);   <span class="comment">// å…³é—­è¯»ç«¯</span></span><br><span class="line">        <span class="type">int</span> ret = write(fd[<span class="number">1</span>], str, <span class="built_in">strlen</span>(str));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child write bytes ret: %d, len: %ld\n&quot;</span>, ret, <span class="built_in">strlen</span>(str));</span><br><span class="line">        close(fd[<span class="number">1</span>]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent: %d, %d\n&quot;</span>, fd[<span class="number">0</span>], fd[<span class="number">1</span>]);</span><br><span class="line">        close(fd[<span class="number">1</span>]);   <span class="comment">// å…³é—­å†™ç«¯</span></span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> ret = read(fd[<span class="number">0</span>], buf, <span class="number">18</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent read bytes ret: %d, len: %ld\n&quot;</span>, ret, <span class="built_in">strlen</span>(buf));</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;read buf: %s&quot;</span>, buf);    <span class="comment">// å¯¹æ¯”ä¸¤ç§è¾“å‡ºæ–¹å¼</span></span><br><span class="line">        write(STDOUT_FILENO, buf, ret);</span><br><span class="line">        close(fd[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç®¡é“çš„è¯»å†™è¡Œä¸º"><a href="#ç®¡é“çš„è¯»å†™è¡Œä¸º" class="headerlink" title="ç®¡é“çš„è¯»å†™è¡Œä¸º"></a>ç®¡é“çš„è¯»å†™è¡Œä¸º</h3><p><strong>æœ€å¥½åŒæ—¶åªæœ‰ä¸€ä¸ªè¯»ç«¯å’Œä¸€ä¸ªå†™ç«¯</strong>ï¼</p><ul><li><p>ä¸€ä¸ªç®¡é“æ˜¯ä¸€ä¸ªå­—èŠ‚æµï¼Œä¸å­˜åœ¨æ¶ˆæ¯æˆ–æ¶ˆæ¯è¾¹ç•Œçš„æ¦‚å¿µã€‚</p></li><li><p>é€šè¿‡ç®¡é“ä¼ é€’çš„æ•°æ®æ˜¯é¡ºåºçš„ï¼Œåœ¨ç®¡é“ä¸­æ— æ³•ä½¿ç”¨ <code>lseek()</code> æ¥éšæœºåœ°è®¿é—®æ•°æ®ã€‚</p></li><li><p><strong>ç®¡é“çš„å­˜å‚¨å®¹é‡æ˜¯æœ‰é™çš„</strong>ï¼Œä¸€èˆ¬ä¸º <code>64kbytes</code>ï¼Œå®¹é‡æ»¡ä¹‹åï¼Œå†™ç«¯è¢«é˜»å¡ã€‚</p><blockquote><p>è™½ç„¶ç®¡é“çš„å®¹é‡å¤§å°è¢«é™åˆ¶ä¸º<code>64kbytes</code>ï¼Œä½†å¦‚æœéœ€è¦ï¼Œè¿›ç¨‹ä¹Ÿå¯é€šè¿‡ä¸€å®šæ–¹æ³•<code>fcntl</code>æ¥ä¿®æ”¹ç®¡é“çš„å®¹é‡ã€‚</p></blockquote></li><li><p>è¯»ç®¡é“ï¼š</p><ol><li>ç®¡é“ä¸­æœ‰æ•°æ®ï¼Œ<code>read</code> è¿”å›å®é™…è¯»å–çš„å­—èŠ‚æ•°ï¼Œå¹¶å°†æ•°æ®å†™å…¥ç¼“å†²åŒº</li><li>ç®¡é“æ— æ•°æ®ï¼š<ul><li>æ— å†™ç«¯ï¼š<code>read</code> è¿”å› 0ï¼ˆç±»ä¼¼è¯»åˆ°æ–‡ä»¶æœ«å°¾ï¼‰</li><li>æœ‰å†™ç«¯ï¼š<code>read</code> é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰æ•°æ®å†™å…¥ç®¡é“</li></ul></li></ol></li><li><p>å†™ç®¡é“ï¼š</p><ol><li>æ— è¯»ç«¯ï¼šå¼‚å¸¸ç»ˆæ­¢ã€‚(<code>SIGPIPE</code> å¯¼è‡´)</li><li>æœ‰è¯»ç«¯ï¼š<ul><li>ç®¡é“å·²æ»¡ï¼Œ<code>write</code> <strong>é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°ç®¡é“æœ‰ç©ºé—´</strong></li><li>ç®¡é“æœªæ»¡ï¼Œ<code>write</code> è¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°</li></ul></li></ol></li></ul><blockquote><p>è™½ç„¶çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹éƒ½å¯ä»¥ä»ç®¡é“ä¸­è¯»å–å’Œå†™å…¥æ•°æ®ï¼Œä½†è¿™ç§åšæ³•å¹¶ä¸å¸¸è§ã€‚ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªè¿›ç¨‹å‘å•ä¸ªç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œä½†é€šå¸¸åªå­˜åœ¨ä¸€ä¸ªå†™è€…ã€‚<strong>åŒæ—¶åªæœ‰ä¸€ä¸ªè¯»ç«¯å’Œä¸€ä¸ªå†™ç«¯ï¼Œå…³é—­å…¶ä»–ä¸ç”¨çš„ç«¯å£</strong>ã€‚å¦åˆ™å¯èƒ½å‡ºç°ä»¥ä¸‹æƒ…å†µï¼š</p><ul><li>å ç”¨æ–‡ä»¶æè¿°ç¬¦ï¼›</li><li>å¤šä¸ªè¿›ç¨‹åŒæ—¶è¯»ï¼Œç«äº‰å¸¦æ¥ä¸ç¡®å®šæ€§ï¼›</li><li>å…¶ä»–è¿›ç¨‹éƒ½å…³é—­åï¼Œå¦‚æœå†™å…¥è¿›ç¨‹æ²¡æœ‰å…³é—­ç®¡é“çš„è¯»å–ç«¯ï¼Œå®ƒä»ç„¶èƒ½å¤Ÿå†™å…¥ï¼›</li><li>å¦‚æœå¤šä¸ªè¿›ç¨‹å†™å…¥åŒä¸€ä¸ªç®¡é“ï¼Œé‚£ä¹ˆå¦‚æœå®ƒä»¬åœ¨ä¸€ä¸ªæ—¶åˆ»å†™å…¥çš„æ•°æ®é‡ä¸è¶…è¿‡ <code>PIPE_BUF</code> (Linux ä¸‹ä¸º4096ï¼Œ<code>getconf PIPE_BUF /</code>)å­—èŠ‚ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç¡®ä¿å†™å…¥çš„æ•°æ®ä¸ä¼šå‘ç”Ÿç›¸äº’æ··åˆçš„æƒ…å†µï¼ˆå³ä¸€æ¬¡åŸå­å†™å…¥çš„æœ€å¤§é•¿åº¦ä¸º4096 bytesï¼‰ã€‚å½“å†™å…¥ç®¡é“çš„æ•°æ®å—çš„å¤§å°è¶…è¿‡äº† <code>PIPE_BUF</code> å­—èŠ‚ï¼Œé‚£ä¹ˆå†…æ ¸å¯èƒ½ä¼šå°†æ•°æ®åˆ†å‰²æˆå‡ ä¸ªè¾ƒå°çš„ç‰‡æ®µæ¥ä¼ è¾“ï¼Œå°±å®¹æ˜“å‡ºç°æ•°æ®äº¤å‰ï¼Œå¯¼è‡´æ•°æ®æ··ä¹±ã€‚</li></ul></blockquote><h2 id="fifo"><a href="#fifo" class="headerlink" title="fifo"></a>fifo</h2><blockquote><p>æ ‡è¯†ï¼šè·¯å¾„+æ–‡ä»¶å</p></blockquote><p><code>FIFO</code>ä¸ç®¡é“<code>Pipe</code>ç±»ä¼¼ï¼Œä½†<strong>FIFO ä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šåˆ›å»ºä¸€ä¸ªç®¡é“ç±»å‹(p)çš„æ–‡ä»¶</strong>ï¼Œå…¶ä»–è¿›ç¨‹å¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶è·å–è¯¥ç®¡é“ï¼Œ<code>FIFO</code>ä¹Ÿå› æ­¤å¯ä»¥ç”¨äºæ— è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹é—´é€šä¿¡ã€‚<strong>æ³¨ï¼šåˆ›å»º<code>FIFO</code>çš„è¿›ç¨‹ä¸ä¸€å®šä¼šä½¿ç”¨è¯¥ç®¡é“</strong>ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>mkfifo</code>å‘½ä»¤æ‰‹åŠ¨åˆ›å»ºç®¡é“æ–‡ä»¶ä¾›å…¶ä»–è¿›ç¨‹ä½¿ç”¨è¯¥æ–‡ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mkfifo</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">mode_t</span> mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *pathname = <span class="string">&quot;/tmp/myfifo&quot;</span>;</span><br><span class="line"><span class="type">int</span> res = mkfifo(pathname, <span class="number">0664</span>);</span><br></pre></td></tr></table></figure><ul><li><code>pathname</code>ï¼šç®¡é“æ–‡ä»¶çš„è·¯å¾„ + æ–‡ä»¶å</li><li><code>mode</code>ï¼šç®¡é“æ–‡ä»¶çš„æƒé™ï¼Œç±»ä¼¼<code>0644</code></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å› <code>0</code></li><li>å¤±è´¥ç¿»è¯‘ <code>-1</code> ï¼Œå¹¶è®¾ç½® <code>errno</code></li></ul></li></ul><h3 id="FIFOçš„è¯»å†™è¡Œä¸º"><a href="#FIFOçš„è¯»å†™è¡Œä¸º" class="headerlink" title="FIFOçš„è¯»å†™è¡Œä¸º"></a>FIFOçš„è¯»å†™è¡Œä¸º</h3><p>FIFOä¹Ÿæ˜¯ä¸€ç§ç®¡é“ï¼Œæ‰€ä»¥ä¸Šé¢<strong>ç®¡é“çš„è¯»å†™è¡Œä¸ºä¹ŸåŸºæœ¬é€‚ç”¨äºFIFO</strong>ï¼</p><p>æ‰“å¼€<code>FIFO</code>æ–‡ä»¶å’Œæ™®é€šæ–‡ä»¶çš„åŒºåˆ«æœ‰2ç‚¹ï¼š</p><ol><li><p>ç¬¬ä¸€<strong>ä¸èƒ½ä»¥<code>O_RDWR</code>æ¨¡å¼æ‰“å¼€</strong><code>FIFO</code>æ–‡ä»¶è¿›è¡Œè¯»å†™æ“ä½œã€‚è¿™æ ·åšçš„è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ã€‚åªèƒ½ä¸€ä¸ªè¿›ç¨‹ä»¥<strong>åªè¯»æ–¹å¼<code>O_RDONLY</code>æ‰“å¼€</strong>ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹ä»¥<strong>åªå†™æ–¹å¼<code>O_WRONLY</code>æ‰“å¼€</strong>è¯¥æ–‡ä»¶ã€‚ä¸ç®¡é“ä¸€æ ·ï¼Œå½“æ‰€æœ‰å¼•ç”¨ <code>FIFO</code> çš„æè¿°ç¬¦éƒ½è¢«å…³é—­ä¹‹åï¼Œæ‰€æœ‰æœªè¢«è¯»å–çš„æ•°æ®ä¼šè¢«ä¸¢å¼ƒã€‚</p></li><li><p>ç¬¬äºŒæ˜¯å¯¹æ ‡å¿—ä½çš„<code>O_NONBLOCK</code>é€‰é¡¹çš„ç”¨æ³•ï¼Œä½¿ç”¨è¿™ä¸ªé€‰é¡¹ä¸ä»…æ”¹å˜<code>open</code>è°ƒç”¨çš„å¤„ç†æ–¹å¼ï¼Œè¿˜ä¼šæ”¹å˜å¯¹è¿™æ¬¡<code>open</code>è°ƒç”¨è¿”å›çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œçš„è¯»å†™è¯·æ±‚çš„å¤„ç†æ–¹å¼ã€‚<code>O_RDONLY</code>ã€<code>O_WRONLY</code>å’Œ<code>O_NONBLOCK</code>æ ‡å¿—å…±æœ‰å››ç§åˆæ³•çš„ç»„åˆæ–¹å¼ï¼š</p><ul><li><code>flags=O_RDONLY</code>ï¼š<code>open</code>å°†ä¼š<strong>è°ƒç”¨é˜»å¡</strong>ï¼Œç›´åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ä»¥<code>O_WRONLY</code>æ‰“å¼€åŒä¸€ä¸ª<code>FIFO</code>ã€‚</li><li><code>flags=O_WRONLY</code>ï¼š<code>open</code>å°†ä¼š<strong>è°ƒç”¨é˜»å¡</strong>ï¼Œç›´åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ä»¥<code>O_RDONLY</code>æ‰“å¼€åŒä¸€ä¸ª<code>FIFO</code>ã€‚</li><li><code>flags=O_RDONLY|O_NONBLOCK</code>ï¼š<strong>ç«‹å³è¿”å›</strong>ï¼Œè‹¥æ­¤æ—¶æ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥<code>O_WRONLY</code>æ‰“å¼€ï¼Œ<code>open</code>ä¼šæˆåŠŸè¿”å›ï¼Œæ­¤æ—¶<code>FIFO</code><strong>è¢«è¯»æ‰“å¼€</strong>ï¼Œä¸ä¼šè¿”å›é”™è¯¯ã€‚</li><li><code>flags=O_WRONLY|O_NONBLOCK</code>ï¼š<strong>ç«‹å³è¿”å›</strong>ï¼Œè‹¥æ­¤æ—¶æ²¡æœ‰å…¶ä»–è¿›ç¨‹ä»¥<code>O_RDONLY</code>æ‰“å¼€ï¼Œ<code>open</code>ä¼šå¤±è´¥è¿”å›ï¼Œæ­¤æ—¶<code>FIFO</code><strong>æ²¡æœ‰è¢«æ‰“å¼€</strong>ï¼Œè¿”å›-1ã€‚</li></ul></li></ol><p><strong>å½“<code>FIFO</code>çš„å…¶ä¸­ä¸€ç«¯å…³é—­åï¼Œå¦ä¸€ç«¯ä¹Ÿä¼šç«‹åˆ»å…³é—­</strong>ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„ä¾‹å­æµ‹è¯•ï¼š</p><h3 id="example-1"><a href="#example-1" class="headerlink" title="example"></a>example</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// write fifo</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *pathname = <span class="string">&quot;/tmp/myfifo&quot;</span>;</span><br><span class="line">    <span class="type">int</span> fd = open(pathname, O_WRONLY);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>] = <span class="string">&quot;hello, fifo!\n&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        write(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// read fifo</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *pathname = <span class="string">&quot;/tmp/myfifo&quot;</span>;</span><br><span class="line">    <span class="type">int</span> fd = open(pathname, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buf[<span class="number">100</span>] = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">int</span> bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        bytes = read(fd, buf, <span class="number">100</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;read from fifo: %s\n&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FIFO</code>æ–‡ä»¶ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œè¾“å…¥è¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é¦–å…ˆç”¨catå‘½ä»¤è¯»å–åˆšæ‰åˆ›å»ºçš„FIFOæ–‡ä»¶ï¼š</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªæ—¶å€™ï¼Œcatå‘½ä»¤å°†ä¸€ç›´æŒ‚èµ·ï¼Œç›´åˆ°ç»ˆç«¯æˆ–è€…æœ‰æ•°æ®å‘é€åˆ°FIFOä¸­ã€‚</span></span><br><span class="line"><span class="built_in">cat</span> &lt; /tmp/myfifo</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç„¶åå°è¯•å‘FIFOä¸­å†™æ•°æ®ï¼ˆåœ¨å¦å¤–ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ï¼‰</span></span><br><span class="line"><span class="comment"># è¿™ä¸ªæ—¶å€™catå°†ä¼šè¾“å‡ºå†…å®¹ã€‚</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;FIFO test&quot;</span> &gt; /tmp/myfifo</span><br></pre></td></tr></table></figure><h2 id="UNIX-Domain-Socket"><a href="#UNIX-Domain-Socket" class="headerlink" title="UNIX Domain Socket"></a>UNIX Domain Socket</h2><blockquote><p>æ ‡è¯†ï¼šè·¯å¾„+æ–‡ä»¶å</p></blockquote><p>åˆç§°<strong>æœ¬åœ°å¥—æ¥å­—</strong><code>AF_LOCAL</code> ã€<code>UNIX Domain Socket(AF_UNIX)</code>ï¼Œæ˜¯ä¸€ç§ä¸“é—¨ç”¨äº<strong>åŒä¸€ä¸»æœºä¸Šè¿›ç¨‹é—´</strong>ç›¸äº’é€šä¿¡çš„<code>Socket</code>ï¼ŒåŒæ ·å¯ä½¿ç”¨æµ<code>Socket</code>å’Œæ•°æ®æŠ¥<code>Socket</code>ã€‚ä½¿ç”¨<code>UNIX Domain</code>å‘é€çš„æŠ¥æ–‡ä¸ä¼šç»è¿‡åè®®æ ˆï¼Œæ•ˆç‡æ›´é«˜ã€‚</p><p><code>AF_UNIX</code> ä¸ <code>AF_LOCAL</code> çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Œ<code>AF_UNIX</code> æ˜¯å¥—æ¥å­—æ—çš„å®˜æ–¹åç§°ï¼Œè€Œ <code>AF_LOCAL</code> æ˜¯ä¸€ä¸ªå†å²åŸå› ä½¿ç”¨çš„åŒä¹‰è¯ã€‚ä¸¤ä¸ªå¸¸é‡éƒ½åœ¨ <code>&lt;sys/socket.h&gt;</code> å¤´æ–‡ä»¶ä¸­å®šä¹‰ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å¯ä»¥äº’æ¢ä½¿ç”¨ã€‚</p><h3 id="sockaddr-un"><a href="#sockaddr-un" class="headerlink" title="sockaddr_un"></a>sockaddr_un</h3><p>åœ¨ <code>UNIX domain</code> ä¸­ï¼Œ<code>socket</code> åœ°å€ä»¥<strong>è·¯å¾„å</strong>æ¥è¡¨ç¤ºï¼Œè€Œä¸æ˜¯ä¼ ç»Ÿçš„<code>IP+PORT</code>ã€‚<strong>ä¼šåœ¨æŒ‡å®šçš„è·¯å¾„ä¸Šåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œä»¥ä¾¿å…¶ä»–è¿›ç¨‹å»ºç«‹è¿æ¥</strong>ã€‚</p><p>ä¸ºå°†ä¸€ä¸ª <code>UNIX domain socket</code> ç»‘å®šåˆ°ä¸€ä¸ªåœ°å€ä¸Šï¼Œéœ€è¦åˆå§‹åŒ–ä¸€ä¸ª <code>sockaddr_un</code> ç»“æ„ï¼Œç„¶åå°†æŒ‡å‘è¿™ä¸ªç»“æ„çš„ä¸€ä¸ªï¼ˆè½¬æ¢ï¼‰æŒ‡é’ˆä½œä¸º <code>addr</code> å‚æ•°ä¼ å…¥ <code>bind()</code>å¹¶å°† <code>addrlen</code> æŒ‡å®šä¸ºè¿™ä¸ªç»“æ„çš„å¤§å°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> &#123;</span></span><br><span class="line">    <span class="type">sa_family_t</span> sun_family;   <span class="comment">/* Always AF_UNIX */</span></span><br><span class="line">    <span class="type">char</span> sun_path[<span class="number">108</span>];       <span class="comment">/* socket å¯¹åº”çš„è·¯å¾„åå­—ï¼ˆæœ€å¥½å°äº92å­—èŠ‚ï¼‰ */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *path = <span class="string">&quot;/tmp/test.sock&quot;</span>;</span><br><span class="line"><span class="type">int</span> sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);    <span class="comment">// æŒ‡å®šdomain ä¸º AF_UNIX</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_un)); <span class="comment">// æ¸…é›¶</span></span><br><span class="line">addr.sun_family = AF_UNIX;</span><br><span class="line"><span class="built_in">strncpy</span>(addr.sun_path, path, <span class="keyword">sizeof</span>(addr.sun_path)<span class="number">-1</span>);  <span class="comment">// æœ€å¥½ä½¿ç”¨ strncpy</span></span><br><span class="line"></span><br><span class="line">bind(sfd, (<span class="keyword">struct</span> sockaddr *)&amp;addr, sizoef(addr));  <span class="comment">// ä¼šåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­åˆ›å»ºä¸€ä¸ªæ¡ç›®</span></span><br><span class="line"></span><br><span class="line">listen(sfd, <span class="number">128</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> client_fd = accept(sfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>); <span class="comment">// æ³¨æ„è¿™é‡Œä¼ å…¥å‚æ•°ä¸ºNULL</span></span><br></pre></td></tr></table></figure><p>åœ¨è°ƒç”¨<code>bind()</code>æ—¶ï¼Œä¼šä¾æ®<code>sun_path</code>åˆ›å»º<code>socket</code>ç±»å‹çš„æ–‡ä»¶ï¼Œè¯¥ç›®å½•éœ€è¦å¯è®¿é—®å¯å†™ã€‚æ­¤å¤–è¿˜éœ€æ³¨æ„ï¼š</p><ul><li>æ— æ³•å°†ä¸€ä¸ª <code>socket</code> ç»‘å®šåˆ°ä¸€ä¸ªæ—¢æœ‰è·¯å¾„åä¸Šï¼ˆ<code>bind()</code>ä¼šå¤±è´¥å¹¶è¿”å› <code>EADDRINUSE</code> é”™è¯¯ï¼‰ã€‚</li><li>é€šå¸¸ä¼šå°†ä¸€ä¸ª <code>socket</code> ç»‘å®šåˆ°ä¸€ä¸ª<strong>ç»å¯¹è·¯å¾„å</strong>ä¸Šã€‚</li><li>ä¸€ä¸ª <code>socket</code> åªèƒ½ç»‘å®šåˆ°ä¸€ä¸ªè·¯å¾„åä¸Šï¼Œç›¸åº”åœ°ï¼Œä¸€ä¸ªè·¯å¾„ååªèƒ½è¢«ä¸€ä¸ª <code>socket</code> ç»‘å®šã€‚</li><li>æ— æ³•ä½¿ç”¨ <code>open()</code> æ‰“å¼€ä¸€ä¸ª <code>socket</code>ã€‚</li><li>å½“ä¸å†éœ€è¦ä¸€ä¸ª <code>socket</code> æ—¶å¯ä»¥ä½¿ç”¨ <code>unlink()</code>ï¼ˆæˆ– <code>remove()</code>ï¼‰<strong>åˆ é™¤å…¶è·¯å¾„åæ¡ç›®</strong>ï¼ˆé€šå¸¸ä¹Ÿåº”è¯¥è¿™æ ·åšï¼‰ã€‚</li></ul><h3 id="example-2"><a href="#example-2" class="headerlink" title="example"></a>example</h3><p><strong>æœåŠ¡ç«¯</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> bytes, res, sfd, cfd;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = <span class="string">&quot;/tmp/test.sock&quot;</span>;</span><br><span class="line"></span><br><span class="line">    sfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);  <span class="comment">// stream</span></span><br><span class="line">    <span class="keyword">if</span> (sfd == <span class="number">-1</span>) perror(<span class="string">&quot;socket() è°ƒç”¨å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span>    <span class="comment">// è®¾ç½®åœ°å€ï¼ˆæ–‡ä»¶è·¯å¾„æ ‡è¯†ï¼‰</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_un));</span><br><span class="line">    addr.sun_family = AF_UNIX;</span><br><span class="line">    <span class="built_in">strncpy</span>(addr.sun_path, path, <span class="keyword">sizeof</span>(addr.sun_path)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    res = bind(sfd, (<span class="keyword">struct</span> sockaddr *)&amp;addr, <span class="keyword">sizeof</span>(addr));  <span class="comment">// ç»‘å®šåœ°å€ï¼ˆåˆ›å»ºæ–‡ä»¶ï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) perror(<span class="string">&quot;bind() è°ƒç”¨å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    res = listen(sfd, <span class="number">128</span>);     <span class="comment">// è®¾ç½®ç›‘å¬ä¸Šé™</span></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) perror(<span class="string">&quot;listen() è°ƒç”¨å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    cfd = accept(sfd, <span class="literal">NULL</span>, <span class="literal">NULL</span>);  <span class="comment">// ç­‰å¾…è¿æ¥ï¼Œè¿™é‡Œåªæ¼”ç¤ºäº†ä¸€ä¸ªè¿æ¥çš„æƒ…å†µ</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">1024</span>);</span><br><span class="line">        bytes = read(cfd, buf, <span class="number">1024</span>);</span><br><span class="line">        <span class="keyword">if</span> (bytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;recv msg: %s\n&quot;</span>, buf);</span><br><span class="line">            buf[<span class="number">0</span>] = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">            write(cfd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res = unlink(path);     <span class="comment">// ç”¨å®Œåï¼Œå°±åˆ æ‰ç»‘å®šçš„æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) perror(<span class="string">&quot;unlink() è°ƒç”¨å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å®¢æˆ·ç«¯</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/un.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> res, bytes, cfd;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = <span class="string">&quot;/tmp/test.sock&quot;</span>;</span><br><span class="line"></span><br><span class="line">    cfd = socket(AF_UNIX, SOCK_STREAM, <span class="number">0</span>);  <span class="comment">// stream</span></span><br><span class="line">    <span class="keyword">if</span> (cfd == <span class="number">-1</span>) perror(<span class="string">&quot;socket() è°ƒç”¨å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">addr</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;addr, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_un));</span><br><span class="line">    addr.sun_family = AF_UNIX;</span><br><span class="line">    <span class="built_in">strncpy</span>(addr.sun_path, path, <span class="keyword">sizeof</span>(addr.sun_path)<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    res = connect(cfd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr));</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">-1</span>) perror(<span class="string">&quot;connect() è°ƒç”¨å¤±è´¥&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">        write(cfd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">        read(cfd, buf, <span class="number">1024</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;client recv msg: %s\n&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="System-V-IPC"><a href="#System-V-IPC" class="headerlink" title="System V IPC"></a>System V IPC</h2><blockquote><p>æ ‡è¯†ï¼šIPC keyï¼ˆä¸€ä¸ªæ•´æ•°ï¼‰+ å…¶ä»–å‚æ•° æ‰èƒ½å”¯ä¸€æ ‡è¯†ä¸€ä¸ªIPCå¯¹è±¡ã€‚key å¯ä»¥ç”± ftok å¾—åˆ°ã€‚</p></blockquote><p><code>System V IPC</code> åŒ…å«ä¸‰ç§æ–¹å¼ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ã€ä¿¡å·é‡ã€‚ä¸€èˆ¬é€šä¿¡æµç¨‹ä¸ºï¼š</p><ol><li>åŸºäº<code>IPC key</code>åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ã€å…±äº«å†…å­˜ã€ä¿¡å·é‡ï¼‰ã€‚<code>IPC key</code>ç±»ä¼¼äºæ–‡ä»¶è·¯å¾„ï¼Œå¯ç”¨äºæ ‡è¯†å¯¹è±¡ã€‚</li><li>å…¶ä»–è¿›ç¨‹åŸºäº<code>IPC key</code>æ‰“å¼€è¯¥å¯¹è±¡ã€‚<code>1,2</code>æ­¥åˆå¹¶åœ¨äº†<code>get</code>ç³»ç»Ÿè°ƒç”¨ä¸­ã€‚</li><li>å¤šä¸ªè¿›ç¨‹æ“ä½œè¯¥å¯¹è±¡å®ç°è¿›ç¨‹é€šä¿¡ã€‚</li><li>ä»ç³»ç»Ÿä¸­åˆ é™¤è¯¥å¯¹è±¡ã€‚ï¼ˆå³ä½¿æ²¡æœ‰è¿›ç¨‹ä½¿ç”¨ï¼Œè¯¥å¯¹è±¡ä¹Ÿä¸ä¼šè‡ªåŠ¨åˆ é™¤ï¼‰</li></ol><table><thead><tr><th>æ¥å£</th><th>æ¶ˆæ¯é˜Ÿåˆ—</th><th>å…±äº«å†…å­˜</th><th>ä¿¡å·é‡</th></tr></thead><tbody><tr><td>å¤´æ–‡ä»¶</td><td><code>&lt;sys/msg.h&gt;</code></td><td><code>&lt;sys/shm.h&gt;</code></td><td><code>&lt;sys/sem.h&gt;</code></td></tr><tr><td>æ•°æ®ç»“æ„</td><td><code>msqid_ds</code></td><td><code>shmid_ds</code></td><td><code>semid_ds</code></td></tr><tr><td>åˆ›å»º&#x2F;æ‰“å¼€</td><td><code>msgget()</code></td><td><code>shmget()+shmat()</code></td><td><code>semget()</code></td></tr><tr><td>æ§åˆ¶</td><td><code>msgctl()</code></td><td><code>semctl()</code></td><td><code>shmctl()</code></td></tr><tr><td>æ‰§è¡ŒIPC</td><td><code>msgsnd()</code> å†™å…¥<br /><code>msgrcv()</code> æ¥å—</td><td>è®¿é—®å…±äº«åŒºåŸŸä¸­çš„å†…å­˜</td><td><code>semop()</code></td></tr></tbody></table><h3 id="get-è°ƒç”¨"><a href="#get-è°ƒç”¨" class="headerlink" title="get è°ƒç”¨"></a>get è°ƒç”¨</h3><p>æ¯ç§ <code>System V IPC</code> æœºåˆ¶éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„ <code>get</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå®ƒ<strong>ä¸æ–‡ä»¶ä¸Šçš„ <code>open()</code>ç³»ç»Ÿè°ƒç”¨ç±»ä¼¼</strong>ã€‚ç»™å®šä¸€ä¸ªæ•´æ•° <code>key</code>ï¼ˆç±»ä¼¼äºæ–‡ä»¶åï¼‰ï¼Œ<code>get</code> è°ƒç”¨å®Œæˆä¸‹åˆ—æŸä¸ªæ“ä½œï¼š</p><ul><li>ä½¿ç”¨ç»™å®šçš„ key <strong>åˆ›å»º</strong>ä¸€ä¸ªæ–° IPC å¯¹è±¡å¹¶<strong>è¿”å›ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦</strong>æ¥æ ‡è¯†è¯¥å¯¹è±¡ã€‚</li><li>è¿”å›ä¸€ä¸ªæ‹¥æœ‰ç»™å®šçš„ key çš„æ—¢æœ‰ IPC å¯¹è±¡çš„æ ‡è¯†ç¬¦ï¼ˆå°±åƒæ–‡ä»¶æè¿°ç¬¦ï¼‰ã€‚</li></ul><p>åç»­çš„æ¶ˆæ¯æ“ä½œæ”¶å‘ä½¿ç”¨çš„æ˜¯<strong>æ ‡è¯†ç¬¦</strong>ï¼Œ<code>key</code>ä¹Ÿåªæ˜¯ä¸ºäº†è·å–è¯¥<strong>æ ‡è¯†ç¬¦</strong>ã€‚å…¶ä»–è¿›ç¨‹è‹¥æƒ³ä½¿ç”¨è¯¥ IPC å¯¹è±¡ï¼Œ<strong>è¦ä¹ˆçŸ¥é“keyï¼ˆé€šè¿‡getå–è·å–æ ‡è¯†ç¬¦ï¼‰</strong>ï¼Œ<strong>è¦ä¹ˆçŸ¥é“è¯¥æ ‡è¯†ç¬¦</strong>ï¼Œç›´æ¥ä½¿ç”¨ã€‚</p><p>IPC <strong>æ ‡è¯†ç¬¦åˆ™æ˜¯å¯¹è±¡æœ¬èº«çš„ä¸€ä¸ªå±æ€§å¹¶ä¸”å¯¹ç³»ç»Ÿå…¨å±€å¯è§</strong>ã€‚ä¹Ÿå°±æ˜¯ä¸åŒçš„è¿›ç¨‹å¯ä»¥é€šè¿‡å¯¹åº”çš„ key è·å¾—åŒä¸€ä¸ªå¯¹è±¡ï¼Œä¸”è·å¾—çš„æ ‡è¯†ç¬¦å¤§å°å§‹ç»ˆç›¸ç­‰ï¼ˆè¿™ç‚¹ä¸æ–‡ä»¶æè¿°ç¬¦ä¸åŒï¼‰ã€‚</p><blockquote><p>è¿™é‡Œå®¹æ˜“è¯¯è§£ä¸ºåªè¦ key ç›¸åŒçš„ï¼Œå°±èƒ½å”¯ä¸€æ ‡è¯†ä¸€ä¸ªå¯¹è±¡ï¼Œå®é™…ä¸Šé™¤äº† key ï¼Œè¿˜éœ€è¦ get è°ƒç”¨ä¸­çš„å…¶ä»–å‚æ•°ä¹Ÿä¸€è‡´æ‰èƒ½å”¯ä¸€æ ‡è¯†ä¸€ä¸ªIPCå¯¹è±¡ï¼Œå¦‚æœä½¿ç”¨ç›¸åŒçš„ keyï¼Œä½†å…¶ä»–å‚æ•°ä¸åŒï¼Œå¾—åˆ°çš„ä¹Ÿæ˜¯ä¸åŒçš„æ ‡è¯†ç¬¦ã€‚</p></blockquote><h3 id="IPC-Key"><a href="#IPC-Key" class="headerlink" title="IPC Key"></a>IPC Key</h3><p>æ¶ˆæ¯é˜Ÿåˆ—ã€ä¿¡å·é‡ã€å…±äº«å†…å­˜åˆ†åˆ«æœ‰ä¸€ä¸ªæ•°æ®ç»“æ„ç®¡ç†å…¶ keyï¼Œæˆ–è€…è¯´ shmget(100) å’Œ msgget(100) è¿”å›çš„æ˜¯ä¸åŒçš„å¯¹è±¡ã€‚</p><p>å¯¹äºæ¯ç§ IPC æœºåˆ¶ï¼ˆå…±äº«å†…å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æˆ–ä¿¡å·é‡ï¼‰ï¼Œå†…æ ¸éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªå…³è”çš„ ipc_ids ç»“æ„ï¼Œå®ƒè®°å½•ç€è¯¥ IPC æœºåˆ¶çš„æ‰€æœ‰å®ä¾‹çš„å„ç§å…¨å±€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸€ä¸ªå¤§å°ä¼šåŠ¨æ€å˜åŒ–çš„æŒ‡é’ˆæ•°ç»„ entriesï¼Œæ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æŒ‡å‘ä¸€ä¸ªå¯¹è±¡å®ä¾‹çš„å…³è”æ•°æ®ç»“æ„ï¼ˆåœ¨ä¿¡å·é‡ä¸­æ˜¯ semid_ds ç»“æ„ï¼‰ã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/image-20221217105737164.png" alt="image-20221217105737164"></p><p>åœ¨æ‰§è¡Œä¸€ä¸ª IPC get è°ƒç”¨æ—¶ï¼ŒLinux æ‰€é‡‡ç”¨çš„ç®—æ³•è¿‘ä¼¼å¦‚ä¸‹ï¼š</p><ol><li>åœ¨å…³è”æ•°æ®ç»“æ„åˆ—è¡¨ï¼ˆentries æ•°ç»„ä¸­çš„å…ƒç´ æŒ‡å‘çš„ç»“æ„ï¼‰ä¸­æœç´¢ key å­—æ®µä¸ get è°ƒç”¨ä¸­æŒ‡å®šçš„å‚æ•°åŒ¹é…çš„ç»“æ„ã€‚<ol><li>æ²¡æœ‰æ‰¾åˆ°ï¼Œä¸”æ²¡æœ‰æŒ‡å®š IPC_CREATï¼Œè¿”å› ENOENT é”™è¯¯</li><li>æ‰¾åˆ°äº†ï¼Œä½†æŒ‡å®šäº† IPC_CREAT | IPC_EXCL ï¼Œè¿”å› EEXIST é”™è¯¯</li><li>å¦åˆ™åœ¨æ‰¾åˆ°ä¸€ä¸ªåŒ¹é…çš„ç»“æ„çš„æƒ…å†µä¸‹è·³è¿‡ä¸‹é¢çš„æ­¥éª¤ã€‚</li></ol></li><li>æ²¡æœ‰æ‰¾åˆ°ä¸”æŒ‡å®šäº† IPC_CREAT ï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„ IPC å¯¹è±¡å¹¶å¯¹å…¶åˆå§‹åŒ–ï¼Œåœ¨è¿™ä¸ªæ“ä½œä¸­è¿˜ä¼šæ›´æ–° ipc_ids ç»“æ„ä¸­çš„å„ä¸ªå­—æ®µï¼Œå¹¶ä¸”å¯èƒ½è¿˜ä¼šé‡æ–°è®¾å®š entries æ•°ç»„çš„å¤§å°ã€‚</li><li>ä½¿ç”¨å…¬å¼è®¡ç®— IPC å¯¹è±¡çš„æ ‡è¯†ç¬¦ã€‚</li></ol><h3 id="ftok"><a href="#ftok" class="headerlink" title="ftok"></a>ftok</h3><p>å¦‚æœå•çº¯ç”¨æ•°å­— key æ¥æ ‡è¯†ï¼ˆå½“ç„¶è¿˜æœ‰å‚æ•°ï¼‰ï¼Œæ•°å­—ä¸èƒ½åƒå­—ç¬¦ä¸²é‚£æ ·å…·å¤‡ä¸€å®šå«ä¹‰ï¼Œä¸é‚£ä¹ˆæ–¹ä¾¿ï¼Œè€Œä¸”å®¹æ˜“é‡å¤ã€‚æ‰€ä»¥ä¹Ÿæä¾›äº†ä¸€ä¸ªå‡½æ•° ftok ä»ä¸€ä¸ªæ–‡ä»¶ + æ•°å­— æ¥ç”Ÿæˆ keyã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">key_t</span> <span class="title function_">ftok</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> proj_id)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>pathname</code>ï¼šä¸€ä¸ªå®é™…å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ã€‚</li><li><code>proj_id</code>ï¼šä¸€ä¸ªæ•°å­—ï¼Œç›®çš„ä»…ä»…æ˜¯å…è®¸ä»åŒä¸€ä¸ªæ–‡ä»¶ä¸­ç”Ÿæˆå¤šä¸ª key ã€‚</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼Œåœ¨ Linux ä¸Šï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ª 32 ä½çš„å€¼ã€‚</li><li>å¤±è´¥è¿”å› -1ã€‚</li></ul></li></ul><p>åœ¨ Linux ä¸Šï¼Œè¿”å›å€¼æ˜¯å– proj å‚æ•°çš„æœ€ä½ 8 ä¸ªæœ‰æ•ˆä½ã€åŒ…å«è¯¥æ–‡ä»¶æ‰€å±çš„æ–‡ä»¶ç³»ç»Ÿçš„è®¾å¤‡çš„è®¾å¤‡å·ï¼ˆå³æ¬¡è¦è®¾å¤‡å·ï¼‰çš„æœ€ä½ 8 ä¸ªæœ‰æ•ˆä½ä»¥åŠ pathname æ‰€å¼•ç”¨çš„æ–‡ä»¶çš„ i-node å·ï¼ˆ<strong>å¹¶ä¸æ˜¯åŸºäºpathnameè¿™ä¸ªå­—ç¬¦ä¸²æ¥è®¡ç®—</strong>ï¼‰çš„æœ€ä½ 16 ä¸ªæœ‰æ•ˆä½ç»„åˆè€Œæˆã€‚</p><h3 id="å¯¹è±¡åˆ é™¤"><a href="#å¯¹è±¡åˆ é™¤" class="headerlink" title="å¯¹è±¡åˆ é™¤"></a>å¯¹è±¡åˆ é™¤</h3><p>System V IPC å¯¹è±¡å…·å¤‡å†…æ ¸æŒä¹…æ€§ã€‚ä¸€æ—¦è¢«åˆ›å»ºä¹‹åï¼Œä¸€ä¸ªå¯¹è±¡å°±ä¸€ç›´å­˜åœ¨ç›´åˆ°å®ƒè¢«æ˜¾å¼åœ°åˆ é™¤æˆ–ç³»ç»Ÿè¢«å…³é—­ã€‚æ¯ç§ IPC éƒ½æœ‰ç›¸å…³çš„æ§åˆ¶æ“ä½œï¼Œå…¶ä¸­ IPC_RMID æ§åˆ¶æ“ä½œå¯ä»¥å®ç°åˆ é™¤ IPC å¯¹è±¡ï¼Œ<strong>å¯¹äºæ¶ˆæ¯é˜Ÿåˆ—å’Œä¿¡å·é‡æ¥è®²ï¼ŒIPC å¯¹è±¡çš„åˆ é™¤æ˜¯ç«‹å³ç”Ÿæ•ˆçš„ï¼Œå¯¹è±¡ä¸­åŒ…å«çš„æ‰€æœ‰ä¿¡æ¯éƒ½ä¼šè¢«é”€æ¯ï¼Œä¸ç®¡æ˜¯å¦æœ‰å…¶ä»–è¿›ç¨‹ä»ç„¶åœ¨ä½¿ç”¨è¯¥å¯¹è±¡</strong>ï¼ˆè¿™å¸¦æ¥äº†ä¸€å®šçš„ç¼ºé™·ï¼Œæœ‰æ—¶å€™å¹¶ä¸å®¹æ˜“ç¡®å®šå“ªä¸ªè¿›ç¨‹æ˜¯æœ€åä¸€ä¸ªé€€å‡ºçš„ï¼‰ã€‚å…±äº«å†…å­˜å¯¹è±¡çš„åˆ é™¤çš„æ“ä½œæ˜¯ä¸åŒçš„ã€‚åœ¨ shmctl(id,IPC_RMID, NULL)è°ƒç”¨ä¹‹åï¼Œåªæœ‰å½“æ‰€æœ‰ä½¿ç”¨è¯¥å†…å­˜æ®µçš„è¿›ç¨‹ä¸è¯¥å†…å­˜æ®µåˆ†ç¦»ä¹‹åï¼ˆä½¿ç”¨ shmdt()ï¼‰æ‰ä¼šåˆ é™¤è¯¥å…±äº«å†…å­˜æ®µã€‚</p><h3 id="ipcs-ipcrm"><a href="#ipcs-ipcrm" class="headerlink" title="ipcs, ipcrm"></a>ipcs, ipcrm</h3><p>ipcs å’Œ ipcrm å‘½ä»¤æ˜¯ System V IPC é¢†åŸŸä¸­ç±»ä¼¼äº ls å’Œ rm æ–‡ä»¶å‘½ä»¤çš„å‘½ä»¤ã€‚</p><p>ä½¿ç”¨ ipcs èƒ½å¤Ÿè·å–ç³»ç»Ÿä¸Š IPC å¯¹è±¡çš„ä¿¡æ¯ï¼š</p><blockquote><p>&#x2F;proc&#x2F;sysvipc ç›®å½•ä¸­çš„æ–‡ä»¶ä¹Ÿä¼šåˆ—å‡ºæ‰€æœ‰ IPC å¯¹è±¡ï¼</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">------ Message Queues --------              é˜Ÿåˆ—æ•°æ®å­—èŠ‚æ•° æ¶ˆæ¯æ•°é‡</span><br><span class="line">key        æ ‡è¯†ç¬¦      æ‰€æœ‰è€…      æƒé™        å¯¹è±¡ç‰¹æœ‰ä¿¡æ¯</span><br><span class="line">key        msqid      owner      perms      used-bytes   messages</span><br><span class="line"></span><br><span class="line">------ Shared Memory Segments --------      åŒºåŸŸå¤§å°    ä½¿ç”¨è¿›ç¨‹æ•°   çŠ¶æ€æ ‡è®°</span><br><span class="line">key        shmid      owner      perms      bytes      nattch     status</span><br><span class="line"><span class="number">0x510715a7</span> <span class="number">7</span>          yogurt     <span class="number">600</span>        <span class="number">152</span>        <span class="number">1</span></span><br><span class="line"><span class="number">0x00000000</span> <span class="number">12</span>         yogurt     <span class="number">600</span>        <span class="number">1048576</span>    <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">16</span>         yogurt     <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">20</span>         yogurt     <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">21</span>         yogurt     <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">24</span>         yogurt     <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">27</span>         yogurt     <span class="number">600</span>        <span class="number">524288</span>     <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">30</span>         yogurt     <span class="number">600</span>        <span class="number">1048576</span>    <span class="number">2</span>          dest</span><br><span class="line"><span class="number">0x00000000</span> <span class="number">33</span>         yogurt     <span class="number">600</span>        <span class="number">134217728</span>  <span class="number">2</span>          dest</span><br><span class="line"></span><br><span class="line">------ Semaphore Arrays --------            ä¿¡å·é›†å¤§å°</span><br><span class="line">key        semid      owner      perms      nsems</span><br><span class="line"><span class="number">0x510715a6</span> <span class="number">1</span>          yogurt     <span class="number">600</span>        <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ ipcrm åˆ é™¤å¯¹è±¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- Delete a shared memory segment by ID:</span><br><span class="line">  ipcrm --shmem-id &#123;&#123;shmem_id&#125;&#125;</span><br><span class="line"></span><br><span class="line">- Delete a shared memory segment by key:</span><br><span class="line">  ipcrm --shmem-key &#123;&#123;shmem_key&#125;&#125;</span><br><span class="line"></span><br><span class="line">- Delete an IPC queue by ID:</span><br><span class="line">  ipcrm --queue-id &#123;&#123;ipc_queue_id&#125;&#125;</span><br><span class="line"></span><br><span class="line">- Delete an IPC queue by key:</span><br><span class="line">  ipcrm --queue-key &#123;&#123;ipc_queue_key&#125;&#125;</span><br><span class="line"></span><br><span class="line">- Delete a semaphore by ID:</span><br><span class="line">  ipcrm --semaphore-id &#123;&#123;semaphore_id&#125;&#125;</span><br><span class="line"></span><br><span class="line">- Delete a semaphore by key:</span><br><span class="line">  ipcrm --semaphore-key &#123;&#123;semaphore_key&#125;&#125;</span><br><span class="line"></span><br><span class="line">- Delete all IPC resources:</span><br><span class="line">  ipcrm --all</span><br></pre></td></tr></table></figure><h3 id="é™åˆ¶"><a href="#é™åˆ¶" class="headerlink" title="é™åˆ¶"></a>é™åˆ¶</h3><p>ç”±äº System V IPC å¯¹è±¡ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå› æ­¤å†…æ ¸å¯¹å„ç§ IPC å¯¹è±¡è¿›è¡Œäº†å„å¼å„æ ·çš„é™åˆ¶ä»¥é˜²æ­¢èµ„æºè¢«è€—å°½ã€‚</p><p>åœ¨ Linux ä¸Šï¼Œipcs â€“l å‘½ä»¤å¯ä»¥ç”¨æ¥åˆ—å‡ºå„ç§ IPC æœºåˆ¶ä¸Šçš„é™åˆ¶ã€‚</p><table><thead><tr><th></th><th>é™åˆ¶</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td></td><td></td><td>éƒ¨åˆ†é™åˆ¶å˜é‡ä½äº &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F; ï¼Œå˜é‡åä¸ºæ–‡ä»¶å</td></tr><tr><td>æ¶ˆæ¯é˜Ÿåˆ—</td><td>MSGMNI</td><td>ç³»ç»Ÿçº§ï¼Œç³»ç»Ÿä¸­æ‰€èƒ½åˆ›å»ºçš„æ¶ˆæ¯é˜Ÿåˆ—çš„æ•°é‡ï¼Œ32000</td></tr><tr><td></td><td>MSGMAX</td><td>ç³»ç»Ÿçº§ï¼Œå•æ¡æ¶ˆæ¯ä¸­æœ€å¤šå¯å†™å…¥çš„å­—èŠ‚æ•°ï¼ˆmtextï¼‰ï¼Œ8192</td></tr><tr><td></td><td>MSGMNB</td><td>ç³»ç»Ÿçº§ï¼Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­ä¸€æ¬¡æœ€å¤šä¿å­˜çš„å­—èŠ‚æ•°ï¼ˆmtextï¼‰ï¼Œ16384</td></tr><tr><td></td><td>MSGTQL</td><td>ç³»ç»Ÿçº§ï¼Œç³»ç»Ÿä¸­æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—æ‰€èƒ½å­˜æ”¾çš„æ¶ˆæ¯æ€»æ•°</td></tr><tr><td></td><td>MSGPOOL</td><td>ç³»ç»Ÿçº§ï¼Œç”¨æ¥å­˜æ”¾ç³»ç»Ÿä¸­æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ•°æ®çš„ç¼“å†²æ± çš„å¤§å°</td></tr><tr><td>ä¿¡å·é‡</td><td>SEMMNI</td><td>ç³»ç»Ÿçº§ï¼Œé™åˆ¶äº†æ‰€èƒ½åˆ›å»ºçš„ä¿¡å·é‡æ ‡è¯†ç¬¦çš„æ•°é‡ï¼Œ32000</td></tr><tr><td></td><td>SEMMSL</td><td>ä¸€ä¸ªä¿¡å·é‡é›†ä¸­èƒ½åˆ†é…çš„ä¿¡å·é‡çš„æœ€å¤§æ•°é‡ï¼Œ32000</td></tr><tr><td></td><td>SEMMNS</td><td>ç³»ç»Ÿçº§ï¼Œæ‰€æœ‰ä¿¡å·é‡é›†ä¸­çš„ä¿¡å·é‡æ•°é‡ï¼Œ1024000000</td></tr><tr><td></td><td>SEMOPM</td><td>æ¯ä¸ª semop()è°ƒç”¨èƒ½å¤Ÿæ‰§è¡Œçš„æ“ä½œçš„æœ€å¤§æ•°é‡ï¼Œ500</td></tr><tr><td></td><td>SEMVMX</td><td>ä¸€ä¸ªä¿¡å·é‡èƒ½å–çš„æœ€å¤§å€¼</td></tr></tbody></table><h2 id="Sys-æ¶ˆæ¯é˜Ÿåˆ—"><a href="#Sys-æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="Sys æ¶ˆæ¯é˜Ÿåˆ—"></a>Sys æ¶ˆæ¯é˜Ÿåˆ—</h2><p>System V æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ˜¯ä»¥<strong>å—</strong>çš„å½¢å¼å­˜å‚¨çš„ï¼Œè¿™äº›å—ç”±<strong>æ¶ˆæ¯ç±»å‹</strong>å’Œ<strong>æ•°æ®</strong>ä¸¤éƒ¨åˆ†ç»„æˆã€‚æ¶ˆæ¯ç±»å‹æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œå¯ä»¥ç”¨æ¥åŒºåˆ†ä¸åŒç±»å‹çš„æ¶ˆæ¯ï¼Œè€Œæ•°æ®åˆ™æ˜¯ä¸€æ®µäºŒè¿›åˆ¶æ•°æ®ï¼Œå¯ä»¥ç”¨æ¥å­˜å‚¨æ¶ˆæ¯çš„å…·ä½“å†…å®¹ã€‚ï¼ˆ<strong>æ¯ä¸ªå—çš„å¤§å°å¯ä»¥æ˜¯ä¸ç›¸åŒçš„</strong>ï¼ï¼‰</p><p>æ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«æ˜¯ä»¥<strong>é“¾è¡¨</strong>çš„å½¢å¼ç»„ç»‡çš„ï¼Œæ‰€æœ‰çš„æ¶ˆæ¯éƒ½æŒ‰ç…§æ¶ˆæ¯ç±»å‹å’Œå‘é€æ—¶é—´çš„é¡ºåºä¾æ¬¡æ’åˆ—ã€‚è¿›ç¨‹å¯ä»¥é€šè¿‡æŒ‡å®šæ¶ˆæ¯ç±»å‹æ¥å‘é€æˆ–æ¥æ”¶ç‰¹å®šç±»å‹çš„æ¶ˆæ¯ã€‚</p><p><strong>æ¶ˆæ¯é˜Ÿåˆ—æœ¬èº«å°±å…·æœ‰åŒæ­¥åŠŸèƒ½</strong>ï¼Œå¯ä»¥ä¿è¯åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½å¤Ÿè®¿é—®é˜Ÿåˆ—ã€‚</p><h3 id="msgget"><a href="#msgget" class="headerlink" title="msgget"></a>msgget</h3><p>åˆ›å»ºä¸€ä¸ªæ–°æ¶ˆæ¯é˜Ÿåˆ—æˆ–å–å¾—ä¸€ä¸ªæ—¢æœ‰é˜Ÿåˆ—çš„æ ‡è¯†ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">msgget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">int</span> msgflg)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>key</code>ï¼šä¸Šé¢çš„ IPC keyã€‚</li><li><code>msgflg</code>ï¼šæŒ‡å®šæ–½åŠ äºæ–°æ¶ˆæ¯é˜Ÿåˆ—ä¹‹ä¸Šçš„æƒé™æˆ–æ£€æŸ¥ä¸€ä¸ªæ—¢æœ‰é˜Ÿåˆ—çš„æƒé™çš„ä½æ©ç ï¼Œä»¥åŠ IPC_CREAT | IPC_EXCLã€‚</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å›æ ‡è¯†ç¬¦ã€‚</li><li>å¤±è´¥è¿”å› -1ã€‚</li></ul></li></ul><h3 id="msgsnd"><a href="#msgsnd" class="headerlink" title="msgsnd"></a>msgsnd</h3><p>æ¶ˆæ¯é˜Ÿåˆ—çš„ IO å‡½æ•°ã€‚msgsnd msgrcv è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨æ¥æ”¶çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦ï¼ˆmsqidï¼‰ã€‚ç¬¬äºŒä¸ªå‚æ•° msgp æ˜¯ä¸€ä¸ª<strong>ç”±ç¨‹åºå‘˜å®šä¹‰çš„</strong>ç»“æ„çš„æŒ‡é’ˆï¼Œè¯¥ç»“æ„ç”¨äºå­˜æ”¾è¢«å‘é€æˆ–æ¥æ”¶çš„æ¶ˆæ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¸‹é¢è¿™ä¸ªç»“æ„éœ€è¦ä½ è‡ªå·±å®šä¹‰ï¼mtextä¹Ÿå¯ä»¥è®¾ç½®ä¸ºå®šé•¿ */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;       <span class="comment">/* message type, must be &gt; 0 */</span></span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">1</span>];    <span class="comment">/* message data */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªéƒ¨åˆ†åŒ…å«äº†æ¶ˆæ¯ç±»å‹ï¼Œå®ƒç”¨ä¸€ä¸ªç±»å‹ä¸º long çš„æ•´æ•°æ¥è¡¨ç¤ºï¼Œè€Œæ¶ˆæ¯çš„å‰©ä½™éƒ¨åˆ†åˆ™æ˜¯ç”±ç¨‹åºå‘˜å®šä¹‰çš„ä¸€ä¸ªç»“æ„ï¼Œå…¶é•¿åº¦å’Œå†…å®¹å¯ä»¥æ˜¯ä»»æ„çš„ï¼Œè€Œæ— éœ€æ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ã€‚å› æ­¤ mgsp å‚æ•°çš„ç±»å‹ä¸º void *ï¼Œè¿™æ ·å°±å…è®¸ä¼ å…¥ä»»æ„ç»“æ„çš„æŒ‡é’ˆäº†ã€‚mtext å­—æ®µé•¿åº¦å¯ä»¥ä¸ºé›¶ï¼Œå½“å¯¹äºæ¥æ”¶è¿›ç¨‹æ¥è®²æ‰€éœ€ä¼ é€’çš„ä¿¡æ¯ä»…é€šè¿‡æ¶ˆæ¯ç±»å‹å°±èƒ½è¡¨ç¤ºæˆ–åªéœ€è¦çŸ¥é“ä¸€æ¡æ¶ˆæ¯æœ¬èº«æ˜¯å¦å­˜åœ¨æ—¶ï¼Œè¿™ç§åšæ³•æœ‰æ—¶å€™å°±å˜å¾—éå¸¸æœ‰ç”¨äº†ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">msgsnd</span><span class="params">(<span class="type">int</span> msqid, <span class="type">const</span> <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">int</span> msgflg)</span>;</span><br></pre></td></tr></table></figure><p>å°† msgp æŒ‡å‘çš„æ¶ˆæ¯å†…å®¹å¤åˆ¶è¿›å†…æ ¸æ¶ˆæ¯é˜Ÿåˆ—é“¾è¡¨ä¸­ï¼Œå­˜åœ¨å†…å­˜æ‹·è´ã€‚</p><ul><li>msgp ï¼šå¾…å‘é€çš„æ¶ˆæ¯ msgbuf åœ°å€ï¼›å…¶ä¸­ mtype å¿…é¡»æŒ‡å®šä¸º &gt;0 çš„æ•°ã€‚</li><li>msgsz ï¼šæŒ‡å®šäº† msgbuf.mtext å­—æ®µä¸­åŒ…å«çš„å­—èŠ‚æ•°ï¼›ä¸æ˜¯ msgbuf çš„æ€»é•¿åº¦ï¼›</li><li>msgflg ï¼šä¸€ç»„æ ‡è®°çš„ä½æ©ç ï¼Œç”¨äºæ§åˆ¶ msgsnd()çš„æ“ä½œï¼Œç›®å‰å®šä¹‰äº†ï¼š<ul><li>IPC_NOWAITï¼Œæ‰§è¡Œéé˜»å¡å‘é€ï¼›é€šå¸¸å½“æ¶ˆæ¯é˜Ÿåˆ—æ»¡æ—¶ï¼Œmsgsnd()ä¼šé˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å­˜æ”¾è¿™æ¡æ¶ˆæ¯ã€‚ä½†å¦‚æœæŒ‡å®šäº†è¿™ä¸ªæ ‡è®°ï¼Œé‚£ä¹ˆ msgsnd()å°±ä¼šç«‹å³è¿”å› EAGAIN é”™è¯¯ã€‚</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å› 0ï¼›ï¼ˆæ³¨æ„ä¸æ˜¯è¿”å›å‘é€å­—èŠ‚æ•°ï¼‰</li><li>å¤±è´¥è¿”å› -1ï¼›é˜»å¡å‘é€æ—¶ï¼Œè¢«ä¿¡å·å¤„ç†å™¨ä¸­æ–­è®¾ç½® EINTR é”™è¯¯ã€‚</li></ul></li></ul><h3 id="msgrcv"><a href="#msgrcv" class="headerlink" title="msgrcv"></a>msgrcv</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">msgrcv</span><span class="params">(<span class="type">int</span> msqid, <span class="type">void</span> *msgp, <span class="type">size_t</span> msgsz, <span class="type">long</span> msgtyp,</span></span><br><span class="line"><span class="params">               <span class="type">int</span> msgflg)</span>;</span><br></pre></td></tr></table></figure><p>ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºå¹¶åˆ é™¤ä¸€æ¡æ¶ˆæ¯ï¼Œå°†å…¶å†…å®¹å¤åˆ¶åˆ° msgp æŒ‡å‘çš„ç¼“å†²åŒºä¸­ã€‚</p><ul><li>msgsz ï¼šé¢„åˆ†é…çš„ç¼“å†²åŒº msgbuf ä¸­ mtext å­—æ®µçš„å¤§å°ï¼›å¦‚æœé˜Ÿåˆ—ä¸­å¾…åˆ é™¤çš„æ¶ˆæ¯ä½“çš„å¤§å°è¶…è¿‡äº†msgsz å­—èŠ‚ï¼Œé‚£ä¹ˆå°±ä¸ä¼šä»é˜Ÿåˆ—ä¸­åˆ é™¤æ¶ˆæ¯ï¼Œå¹¶ä¸” msgrcv() ä¼šè¿”å›é”™è¯¯ E2BIGã€‚</li><li>msgtyp ï¼šæŒ‡å®šæ¥æ”¶çš„æ¶ˆæ¯ç±»å‹ï¼›<ul><li>å¦‚æœ &gt;0ï¼Œåˆ™è¿”å›å¹¶åˆ é™¤æŒ‡å®šæ¶ˆæ¯ç±»å‹çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ã€‚</li><li>å¦‚æœ &#x3D;0ï¼Œåˆ™åˆ é™¤é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯å¹¶å°†å…¶è¿”å›ç»™è°ƒç”¨è¿›ç¨‹ã€‚</li><li>å¦‚æœ &lt;0ï¼Œåˆ™å°†ç­‰å¾…æ¶ˆæ¯å½“æˆä¼˜å…ˆé˜Ÿåˆ—æ¥å¤„ç†ï¼é˜Ÿåˆ—ä¸­ mtype æœ€å°å¹¶ä¸”å…¶å€¼å°äºæˆ–ç­‰äº msgtyp çš„ç»å¯¹å€¼çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ä¼šè¢«åˆ é™¤å¹¶è¿”å›ç»™è°ƒç”¨è¿›ç¨‹ã€‚</li><li>é€šè¿‡æŒ‡å®šä¸åŒçš„ msgtyp å€¼ï¼Œå¤šä¸ªè¿›ç¨‹èƒ½å¤Ÿä»åŒä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯è€Œä¸ä¼šå‡ºç°ç«äº‰è¯»å–åŒä¸€æ¡æ¶ˆæ¯çš„æƒ…å†µã€‚æ¯”è¾ƒæœ‰ç”¨çš„ä¸€é¡¹æŠ€æœ¯æ˜¯è®©å„ä¸ªè¿›ç¨‹é€‰å–ä¸è‡ªå·±çš„è¿›ç¨‹ ID åŒ¹é…çš„æ¶ˆæ¯ã€‚</li></ul></li><li>msgflg ï¼šä½æ©ç ï¼›<ul><li>IPC_NOWAIT æ‰§è¡Œä¸€ä¸ªéé˜»å¡æ¥æ”¶ï¼›</li><li>MSG_EXCEPTåªæœ‰å½“ msgtyp å¤§äº 0 æ—¶è¿™ä¸ªæ ‡è®°æ‰ä¼šèµ·ä½œç”¨ï¼Œå®ƒä¼šå¼ºåˆ¶å¯¹å¸¸è§„æ“ä½œè¿›è¡Œè¡¥è¶³ï¼Œå³å°†é˜Ÿåˆ—ä¸­ç¬¬ä¸€æ¡ mtype ä¸ç­‰äº msgtyp çš„æ¶ˆæ¯åˆ é™¤å¹¶å°†å…¶è¿”å›ç»™è°ƒç”¨è€…ã€‚</li><li>MSG_NOERRORåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æ¶ˆæ¯çš„ mtext å­—æ®µçš„å¤§å°è¶…è¿‡äº†å¯ç”¨ç©ºé—´æ—¶ï¼ˆç”± maxmsgsz å‚æ•°å®šä¹‰ï¼‰ï¼Œmsgrcv()è°ƒç”¨ä¼šå¤±è´¥ã€‚å¦‚æœæŒ‡å®šäº† MSG_NOERROR æ ‡è®°ï¼Œé‚£ä¹ˆ msgrcv()å°†ä¼šä»é˜Ÿåˆ—ä¸­åˆ é™¤æ¶ˆæ¯å¹¶å°†å…¶ mtext å­—æ®µçš„å¤§å°æˆªçŸ­ä¸ºmaxmsgsz å­—èŠ‚ï¼Œç„¶åå°†æ¶ˆæ¯è¿”å›ç»™è°ƒç”¨è€…ã€‚è¢«æˆªå»çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å›æ¥æ”¶åˆ°çš„æ¶ˆæ¯ä¸­ mtext å­—æ®µçš„å¤§å°ï¼›</li><li>é”™è¯¯è¿”å› -1ï¼›</li></ul></li></ul><h3 id="msgctl"><a href="#msgctl" class="headerlink" title="msgctl"></a>msgctl</h3><p>åœ¨æ ‡è¯†ç¬¦ä¸º msqid çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸Šæ‰§è¡Œæ§åˆ¶æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">msgctl</span><span class="params">(<span class="type">int</span> msqid, <span class="type">int</span> cmd, <span class="keyword">struct</span> msqid_ds *buf)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ— */</span></span><br><span class="line"><span class="type">int</span> err = msgctl(msqid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (err == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>cmd ï¼šæŒ‡å®šäº†åœ¨é˜Ÿåˆ—ä¸Šæ‰§è¡Œçš„æ“ä½œï¼š<ul><li>IPC_RMID ç«‹å³åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡åŠå…¶å…³è”çš„ msqid_ds æ•°æ®ç»“æ„ã€‚<strong>é˜Ÿåˆ—ä¸­æ‰€æœ‰å‰©ä½™çš„æ¶ˆæ¯éƒ½ä¼šä¸¢å¤±</strong>ï¼</li><li>IPC_STAT å°†ä¸è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å…³è”çš„ msqid_ds æ•°æ®ç»“æ„çš„å‰¯æœ¬æ”¾åˆ° buf æŒ‡å‘çš„ç¼“å†²åŒºä¸­ã€‚</li><li>IPC_SET ä½¿ç”¨ buf æŒ‡å‘çš„ç¼“å†²åŒºæä¾›çš„å€¼æ›´æ–°ä¸è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å…³è”çš„ msqid_ds æ•°æ®ç»“æ„ä¸­è¢«é€‰ä¸­çš„å­—æ®µã€‚</li></ul></li><li>buf ï¼šéƒ¨åˆ†æ§åˆ¶æ“ä½œä¼šç”¨åˆ°ï¼Œæ²¡æœ‰ç”¨åˆ°çš„æ“ä½œä¼ å…¥ NULL å³å¯ã€‚</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸæ‰§è¡Œçš„è¿”å›å€¼ä¸å¯¹åº”çš„æ“ä½œæœ‰å…³ï¼ŒIPC_STAT, IPC_SET, IPC_RMID è¿”å› 0ã€‚</li><li>å¤±è´¥è¿”å› -1 ã€‚</li></ul></li></ul><h3 id="example-3"><a href="#example-3" class="headerlink" title="example"></a>example</h3><p>å‘é€æ®µï¼šåœ¨å‘é€è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡ ipcs æŸ¥çœ‹æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">100</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">100</span>, err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">buf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">key_t</span> key = ftok(<span class="string">&quot;./ipc_sysv_msg_snd.c&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* åˆ›å»º System V æ¶ˆæ¯é˜Ÿåˆ— */</span></span><br><span class="line">    <span class="type">int</span> msgid = msgget(key, <span class="number">0664</span> | IPC_CREAT | IPC_EXCL);</span><br><span class="line">    <span class="keyword">if</span> (msgid == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget error: &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å‘é€æ¶ˆæ¯ */</span></span><br><span class="line">    buf.mtype = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i--) &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(buf.mtext, <span class="string">&quot;%d&quot;</span>, i);</span><br><span class="line">        err = msgsnd(msgid, &amp;buf, <span class="number">100</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (err == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;msgsnd failed!&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    getchar();</span><br><span class="line">    <span class="comment">/* åˆ é™¤æ¶ˆæ¯é˜Ÿåˆ— */</span></span><br><span class="line">    err = msgctl(msgid, IPC_RMID, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (err == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgctl RMID failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥æ”¶ç«¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/msg.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> mtype;</span><br><span class="line">    <span class="type">char</span> mtext[<span class="number">100</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">100</span>, err;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msgbuf</span> <span class="title">buf</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="type">key_t</span> key = ftok(<span class="string">&quot;./ipc_sysv_msg_snd.c&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ‰“å¼€ System V æ¶ˆæ¯é˜Ÿåˆ— */</span></span><br><span class="line">    <span class="type">int</span> msgid = msgget(key, <span class="number">0664</span>);</span><br><span class="line">    <span class="keyword">if</span> (msgid == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msgget error: &quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ¥æ”¶æ¶ˆæ¯ */</span></span><br><span class="line">    buf.mtype = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i--) &#123;</span><br><span class="line">        err = msgrcv(msgid, &amp;buf, <span class="number">100</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (err == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;msgsnd failed!&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;msg.type: %ld, data: %s\n&quot;</span>, buf.mtype, buf.mtext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Sys-ä¿¡å·é‡"><a href="#Sys-ä¿¡å·é‡" class="headerlink" title="Sys ä¿¡å·é‡"></a>Sys ä¿¡å·é‡</h2><blockquote><p>System V ä¿¡å·é‡æ˜¯ä¸€ç§æŒä¹…æ€§çš„æ•°æ®ç±»å‹ï¼Œæ„å‘³ç€å®ƒä»¬åœ¨ç³»ç»Ÿé‡å¯ä¹‹åä»ç„¶å­˜åœ¨ã€‚ä½†æ˜¯ï¼ŒSystem V ä¿¡å·é‡ä¸ä¼šè¢«ä¿å­˜åˆ°ç£ç›˜ä¸Šï¼Œå› æ­¤åœ¨ç³»ç»Ÿé‡å¯ä¹‹åï¼Œæ‰€æœ‰çš„ä¿¡å·é‡éƒ½å°†è¢«åˆå§‹åŒ–ä¸º 0ã€‚</p></blockquote><p>åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è¦è®¿é—®åŒä¸€ä¸ªå˜é‡ï¼Œä¸ºäº†é¿å…å¤šä¸ªçº¿ç¨‹åŒæ—¶å†™å¯¼è‡´æ•°æ®å¼‚å¸¸ï¼Œä¼šé‡‡ç”¨äº’æ–¥é”ã€è¯»å†™é”ã€ä¿¡å·é‡ç­‰åŒæ­¥æœºåˆ¶ï¼Œåœ¨è¿›ç¨‹é€šä¿¡æ—¶ï¼Œä¹Ÿä¼šå‡ºç°ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶è®¿é—®æŸæ®µå†…å­˜çš„æƒ…å†µï¼ŒåŒæ ·éœ€è¦ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œè€Œä¸”å…¶å®ç°åº”è¯¥ç”±å†…æ ¸å®Œæˆï¼Œè¿™æ ·æ‰èƒ½è®©å¤šä¸ªè¿›ç¨‹éƒ½èƒ½è®¿é—®åˆ°ã€‚</p><p>åœ¨ä¸Šé¢ä»‹ç»çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸éœ€è¦ä¸“é—¨å»åŒæ­¥ï¼Œå®ƒæœ¬èº«å°±å…·æœ‰åŒæ­¥åŠŸèƒ½ã€‚ä¸è¿‡ä¸‹é¢çš„å…±äº«å†…å­˜ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éƒ½å¾—é…åˆä¿¡å·é‡ä½¿ç”¨ï¼</p><p>ä¸€ä¸ªä¿¡å·é‡æ˜¯ä¸€ä¸ªç”±å†…æ ¸ç»´æŠ¤çš„æ•´æ•°ï¼Œ<strong>å…¶å€¼è¢«é™åˆ¶ä¸ºå¤§äºæˆ–ç­‰äº 0</strong>ã€‚åœ¨ä¸€ä¸ªä¿¡å·é‡ä¸Šå¯ä»¥æ‰§è¡Œå„ç§æ“ä½œï¼ˆå³ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼ŒåŒ…æ‹¬ï¼š</p><ul><li>å°†ä¿¡å·é‡è®¾ç½®æˆä¸€ä¸ªç»å¯¹å€¼ï¼›</li><li>åœ¨ä¿¡å·é‡å½“å‰å€¼çš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€ä¸ªæ•°é‡ï¼›</li><li>åœ¨ä¿¡å·é‡å½“å‰å€¼çš„åŸºç¡€ä¸Šå‡å»ä¸€ä¸ªæ•°é‡ï¼›ï¼ˆè¯•å›¾ä½¿ä¿¡å·é‡é™ä½åˆ° 0 ä¹‹ä¸‹æ—¶<strong>é˜»å¡</strong>ï¼‰</li><li>ç­‰å¾…ä¿¡å·é‡çš„å€¼ç­‰äº 0ã€‚ï¼ˆä¿¡å·é‡çš„å½“å‰å€¼ä¸ä¸º 0 æ—¶<strong>é˜»å¡</strong>ï¼‰</li></ul><blockquote><p>è¯­ä¹‰ä¸Šæ¥è®²ï¼Œå¢åŠ ä¿¡å·é‡å€¼å¯¹åº”äºä½¿ä¸€ç§èµ„æºå˜å¾—å¯ç”¨ä»¥ä¾¿å…¶ä»–è¿›ç¨‹å¯ä»¥ä½¿ç”¨å®ƒï¼Œè€Œå‡å°ä¿¡å·é‡å€¼åˆ™å¯¹åº”äºé¢„ç•™ï¼ˆäº’æ–¥åœ°ï¼‰è¿›ç¨‹éœ€ä½¿ç”¨çš„èµ„æºã€‚åœ¨å‡å°ä¸€ä¸ªä¿¡å·é‡å€¼æ—¶ï¼Œå¦‚æœä¿¡å·é‡çš„å€¼å¤ªä½â€”â€”å³å…¶ä»–ä¸€äº›è¿›ç¨‹å·²ç»é¢„ç•™äº†è¿™ä¸ªèµ„æºâ€”â€”é‚£ä¹ˆæ“ä½œå°±ä¼šè¢«é˜»å¡ã€‚</p></blockquote><p>ä½¿ç”¨ System V ä¿¡å·é‡çš„å¸¸è§„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºä¿¡å·é‡ï¼šä½¿ç”¨ semget() å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„<strong>ä¿¡å·é‡é›†</strong>ï¼Œæˆ–è€…æ‰“å¼€ä¸€ä¸ªç°æœ‰çš„ä¿¡å·é‡é›†ã€‚</li><li>åˆå§‹åŒ–ä¿¡å·é‡ï¼šä½¿ç”¨ semctl() å‡½æ•°åˆå§‹åŒ–ä¿¡å·é‡çš„å€¼ã€‚</li><li>è·å–ä¿¡å·é‡ï¼šä½¿ç”¨ semop() å‡½æ•°è·å–ä¿¡å·é‡ã€‚è¿™ä¼šä½¿ä¿¡å·é‡çš„å€¼å‡å°‘ 1ã€‚</li><li>é‡Šæ”¾ä¿¡å·é‡ï¼šä½¿ç”¨ semop() å‡½æ•°é‡Šæ”¾ä¿¡å·é‡ã€‚è¿™ä¼šä½¿ä¿¡å·é‡çš„å€¼å¢åŠ  1ã€‚</li><li>åˆ é™¤ä¿¡å·é‡ï¼šä½¿ç”¨ semctl() å‡½æ•° IPC_RMID åˆ é™¤ä¿¡å·é‡é›†ã€‚</li></ol><blockquote><p>ä¸Šé¢æåˆ°çš„ä¿¡å·é‡é›†æ˜¯ä»€ä¹ˆæ„æ€ï¼Œä¸€ä¸ªä¿¡å·é‡ä¸åº”è¯¥å°±ä¸€ä¸ªæ•´æ•°å€¼å—ï¼Ÿ</p><p>(chatgpt) ç­”ï¼šåœ¨ System V ä¿¡å·é‡ä¸­ï¼Œä¸€ä¸ªä¿¡å·é‡é›†æ˜¯ä¸€ç»„ä¿¡å·é‡çš„é›†åˆã€‚æ¯ä¸ªä¿¡å·é‡é›†éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œç§°ä¸ºä¿¡å·é‡é›†æ ‡è¯†ç¬¦ã€‚æ¯ä¸ªä¿¡å·é‡é›†ä¸­å¯ä»¥åŒ…å«å¤šä¸ªä¿¡å·é‡ã€‚æ¯ä¸ªä¿¡å·é‡éƒ½æœ‰ä¸€ä¸ªæ•´æ•°å€¼ï¼Œå¯ä»¥ç”¨æ¥æ§åˆ¶è¿›ç¨‹çš„è®¿é—®ã€‚ä½¿ç”¨ä¿¡å·é‡é›†çš„å¥½å¤„åœ¨äºï¼Œä½ å¯ä»¥é€šè¿‡ä¸€ä¸ªä¿¡å·é‡é›†ç®¡ç†å¤šä¸ªä¿¡å·é‡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸€ä¸ªåœ°ç®¡ç†ã€‚è¿™æ ·ï¼Œä½ å°±å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå‡½æ•°è°ƒç”¨æ¥ç®¡ç†å¤šä¸ªä¿¡å·é‡ï¼Œè€Œä¸æ˜¯å¤šä¸ªå‡½æ•°è°ƒç”¨ã€‚</p></blockquote><h3 id="semget"><a href="#semget" class="headerlink" title="semget"></a>semget</h3><p>åˆ›å»ºä¸€ä¸ªæ–°ä¿¡å·é‡é›†æˆ–è·å–ä¸€ä¸ªæ—¢æœ‰é›†åˆçš„æ ‡è¯†ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">semget</span><span class="params">(<span class="type">key_t</span> key, <span class="type">int</span> nsems, <span class="type">int</span> semflg)</span>;</span><br></pre></td></tr></table></figure><ul><li>key ï¼šå‰é¢çš„ IPC keyï¼›</li><li>nsems ï¼šæŒ‡å®šé›†åˆä¸­ä¿¡å·é‡çš„æ•°é‡ï¼Œå¹¶ä¸”å…¶å€¼å¿…é¡»å¤§äº 0ã€‚å¦‚æœæ˜¯è·å–æ—¢æœ‰é›†åˆçš„æ ‡è¯†ç¬¦ï¼Œnsems å¿…é¡»å°äºç­‰äºé›†åˆçš„å¤§å°ã€‚</li><li>semflg ï¼šä½æ©ç ï¼ŒæŒ‡å®šæƒé™ + IPC_CREAT | IPC_EXCL</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å›æ ‡è¯†ç¬¦ï¼›</li><li>å¤±è´¥è¿”å› -1ï¼›</li></ul></li></ul><h3 id="semctl"><a href="#semctl" class="headerlink" title="semctl"></a>semctl</h3><p>åœ¨ä¸€ä¸ªä¿¡å·é‡é›†æˆ–é›†åˆä¸­çš„å•ä¸ªä¿¡å·é‡ä¸Šæ‰§è¡Œå„ç§æ§åˆ¶æ“ä½œã€‚åˆå§‹åŒ–ä¿¡å·é‡ã€åˆ é™¤ä¿¡å·é‡é›†ç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">semctl</span><span class="params">(<span class="type">int</span> semid, <span class="type">int</span> semnum, <span class="type">int</span> cmd, ... <span class="comment">/* union semun arg */</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">semun</span> &#123;</span></span><br><span class="line">    <span class="type">int</span>              val;    <span class="comment">/* Value for SETVAL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">semid_ds</span> *<span class="title">buf</span>;</span>    <span class="comment">/* Buffer for IPC_STAT, IPC_SET */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>  *<span class="built_in">array</span>;  <span class="comment">/* Array for GETALL, SETALL */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seminfo</span>  *__<span class="title">buf</span>;</span>  <span class="comment">/* Buffer for IPC_INFO</span></span><br><span class="line"><span class="comment">                                           (Linux-specific) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>semid ï¼šä¿¡å·é‡é›†çš„æ ‡è¯†ç¬¦ï¼›</li><li>semnum ï¼šæ ‡è¯†è¦æ“ä½œçš„é›†åˆä¸­å…·ä½“çš„ä¿¡å·é‡ï¼Œä¸éœ€è¦è¯¥å˜é‡çš„æ“ä½œä¼šå¿½ç•¥å®ƒï¼Œå¯ä»¥è®¾ç½®ä¸º0ã€‚</li><li>cmd ï¼šæŒ‡å®šäº†éœ€æ‰§è¡Œçš„æ“ä½œï¼ŒæŸäº›æ“ä½œä¼šç”¨åˆ°ç¬¬å››ä¸ªå‚æ•° <code>union semun</code>ï¼š<ul><li><strong>IPC_RMID</strong> ç«‹å³<strong>åˆ é™¤ä¿¡å·é‡é›†</strong>åŠå…¶å…³è”çš„ semid_ds æ•°æ®ç»“æ„ã€‚æ— éœ€ arg å‚æ•°ã€‚</li><li>GETVAL è¿”å›ç”± semid æŒ‡å®šçš„ä¿¡å·é‡é›†ä¸­ç¬¬ semnum ä¸ªä¿¡å·é‡çš„å€¼ã€‚</li><li><strong>SETVAL</strong> å°†ç”± semid æŒ‡å®šçš„ä¿¡å·é‡é›†ä¸­ç¬¬ semnum ä¸ªä¿¡å·é‡çš„å€¼<strong>åˆå§‹åŒ–</strong>ä¸º arg.valã€‚</li><li>GETALL è·å–ç”± semid æŒ‡å‘çš„ä¿¡å·é‡é›†ä¸­æ‰€æœ‰ä¿¡å·é‡çš„å€¼å¹¶å°†å®ƒä»¬æ”¾åœ¨ arg.array æŒ‡å‘çš„æ•°ç»„ä¸­ã€‚<br>  ç¨‹åºå‘˜å¿…é¡»è¦ç¡®ä¿è¯¥æ•°ç»„å…·å¤‡è¶³å¤Ÿçš„ç©ºé—´ã€‚</li><li><strong>SETALL</strong> ä½¿ç”¨ arg.array æŒ‡å‘çš„æ•°ç»„ä¸­çš„å€¼<strong>åˆå§‹åŒ–</strong> semid æŒ‡å‘çš„é›†åˆä¸­çš„æ‰€æœ‰ä¿¡å·é‡ã€‚</li></ul></li></ul><h3 id="semop"><a href="#semop" class="headerlink" title="semop"></a>semop</h3><p>åœ¨ semid æ ‡è¯†çš„ä¿¡å·é‡é›†ä¸­çš„ä¿¡å·é‡ä¸Šæ‰§è¡Œä¸€ä¸ªæˆ–<strong>å¤šä¸ª</strong>æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">semop</span><span class="params">(<span class="type">int</span> semid, <span class="keyword">struct</span> sembuf *sops, <span class="type">size_t</span> nsops)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">semtimedop</span><span class="params">(<span class="type">int</span> semid, <span class="keyword">struct</span> sembuf *sops, <span class="type">size_t</span> nsops,</span></span><br><span class="line"><span class="params">               <span class="type">const</span> <span class="keyword">struct</span> timespec *timeout)</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sembuf</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> sem_num;  <span class="comment">/* semaphore number */</span></span><br><span class="line">    <span class="type">short</span>          sem_op;   <span class="comment">/* semaphore operation */</span></span><br><span class="line">    <span class="type">short</span>          sem_flg;  <span class="comment">/* operation flags */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>sops ï¼šæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆï¼Œæ•°ç»„ä¸­åŒ…å«äº†éœ€è¦æ‰§è¡Œçš„æ“ä½œã€‚<ul><li>sem_num ï¼šæŒ‡å®šæ“ä½œçš„ä¿¡å·é‡ï¼›</li><li>sem_op ï¼šæŒ‡å®šéœ€è¦æ‰§è¡Œçš„æ“ä½œï¼š<ul><li>å¦‚æœ sem_op å¤§äº 0ï¼Œé‚£ä¹ˆå°±å°† sem_op çš„å€¼åŠ åˆ°ä¿¡å·é‡å€¼ä¸Šï¼Œå…¶ç»“æœæ˜¯å…¶ä»–ç­‰å¾…å‡å°ä¿¡å·é‡å€¼çš„è¿›ç¨‹å¯èƒ½ä¼šè¢«å”¤é†’å¹¶æ‰§è¡Œå®ƒä»¬çš„æ“ä½œã€‚</li><li>å¦‚æœ sem_op ç­‰äº 0ï¼Œé‚£ä¹ˆå°±å¯¹ä¿¡å·é‡å€¼è¿›è¡Œæ£€æŸ¥ä»¥ç¡®å®šå®ƒå½“å‰æ˜¯å¦ç­‰äº 0ã€‚å¦‚æœç­‰äº 0ï¼Œé‚£ä¹ˆæ“ä½œå°†ç«‹å³ç»“æŸï¼Œå¦åˆ™ semop()å°±ä¼šé˜»å¡ç›´åˆ°ä¿¡å·é‡å€¼å˜æˆ 0 ä¸ºæ­¢ã€‚</li><li>å¦‚æœ sem_op å°äº 0ï¼Œé‚£ä¹ˆå°±å°†ä¿¡å·é‡å€¼å‡å» sem_opã€‚å¦‚æœä¿¡å·é‡çš„å½“å‰å€¼å¤§äºæˆ–ç­‰äº sem_op çš„ç»å¯¹å€¼ï¼Œé‚£ä¹ˆæ“ä½œä¼šç«‹å³ç»“æŸã€‚å¦åˆ™ semop()ä¼šé˜»å¡ç›´åˆ°ä¿¡å·é‡å€¼å¢é•¿åˆ°åœ¨æ‰§è¡Œæ“ä½œä¹‹åä¸ä¼šå¯¼è‡´å‡ºç°è´Ÿå€¼çš„æƒ…å†µä¸ºæ­¢ã€‚</li></ul></li></ul></li><li>nsops ï¼šæ•°ç»„çš„å¤§å°ï¼Œæ•°ç»„è‡³å°‘éœ€è¦ä¸€ä¸ªå…ƒç´ ï¼æ“ä½œå°†ä¼š<strong>æŒ‰ç…§åœ¨æ•°ç»„ä¸­çš„é¡ºåºä»¥åŸå­çš„æ–¹å¼è¢«æ‰§è¡Œ</strong>ã€‚</li></ul><h2 id="Sys-å…±äº«å†…å­˜"><a href="#Sys-å…±äº«å†…å­˜" class="headerlink" title="Sys å…±äº«å†…å­˜"></a>Sys å…±äº«å†…å­˜</h2><p>todo</p><h2 id="mmap-å†…å­˜æ˜ å°„"><a href="#mmap-å†…å­˜æ˜ å°„" class="headerlink" title="mmap å†…å­˜æ˜ å°„"></a>mmap å†…å­˜æ˜ å°„</h2><p><code>mmap</code>æ˜ å°„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯æ–‡ä»¶æ˜ å°„ï¼ŒäºŒæ˜¯åŒ¿åæ˜ å°„ã€‚æ˜ å°„å±æ€§ä¹Ÿæœ‰ä¸¤ç§ï¼šç§æœ‰<code>MAP_PRIVATE</code> å’Œå…±äº«<code>MAP_SHARED</code>ã€‚å…¶å››ç§ç»„åˆå¦‚ä¸‹ï¼š</p><ul><li><strong>ç§æœ‰æ–‡ä»¶</strong>ï¼šåˆ†é…ä¸€æ®µå†…å­˜ï¼Œå…¶å†…å®¹ç”¨æ–‡ä»¶çš„å†…å®¹åˆå§‹åŒ–ï¼Œæ–‡ä»¶çš„ä½œç”¨ä¹Ÿåªåœ¨äºåˆå§‹åŒ–ï¼Œåç»­åœ¨å†…å­˜ä¸Šçš„ä¿®æ”¹ä¹Ÿä¸ä¼šå†åŒæ­¥åˆ°æ–‡ä»¶ä¸Šã€‚å¤šä¸ªè¿›ç¨‹æ˜ å°„åŒä¸€ä¸ªæ–‡ä»¶åŒä¸€åŒºåŸŸæ—¶ï¼Œä¸€å¼€å§‹ä¼šå…±äº«åŒä¸€ä¸ªç‰©ç†å†…å­˜åˆ†é¡µï¼Œé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶æŠ€æœ¯</strong>ä¿è¯å„ä¸ªè¿›ç¨‹ä¸å…±äº«ã€‚</li><li><strong>ç§æœ‰åŒ¿å</strong>ï¼šåˆ†é…ä¸€æ®µå†…å­˜ï¼Œä¼šç”¨0å¡«å……å†…å­˜ã€‚æ¯æ¬¡è°ƒç”¨éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ˜ å°„ï¼Œä¸ä¼šå…±äº«åŒä¸€ä¸ªç‰©ç†é¡µã€‚é€šè¿‡<code>fork()</code>åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œä¹Ÿä¼šé‡‡ç”¨<strong>å†™æ—¶å¤åˆ¶æŠ€æœ¯</strong>ä¿è¯ä¸å…±äº«ã€‚</li><li><strong>å…±äº«æ–‡ä»¶</strong>ï¼šåˆ†é…ä¸€æ®µå†…å­˜ï¼Œå…¶å†…å®¹ç”¨æ–‡ä»¶çš„å†…å®¹åˆå§‹åŒ–ï¼Œå¯¹å†…å­˜çš„ä¿®æ”¹å†…æ ¸ä¹Ÿä¼šé€‰æ‹©åˆé€‚çš„æ—¶æœºåŒæ­¥åˆ°æ–‡ä»¶ä¸Šã€‚å¤šä¸ªè¿›ç¨‹æ˜ å°„åŒä¸€ä¸ªæ–‡ä»¶åŒä¸€åŒºåŸŸæ—¶ï¼Œå…±äº«åŒä¸€ä¸ªç‰©ç†å†…å­˜åˆ†é¡µï¼Œä¹Ÿå°±æ˜¯<strong>å…±äº«å†…å­˜æœºåˆ¶</strong>ã€‚</li><li><strong>å…±äº«åŒ¿å</strong>ï¼šåˆ†é…ä¸€æ®µå†…å­˜ï¼Œä¼šç”¨0å¡«å……å†…å­˜ã€‚å½“é€šè¿‡<code>fork()</code>åˆ›å»ºå­è¿›ç¨‹æ—¶ï¼Œçˆ¶å­è¿›ç¨‹å…±äº«åŒæ ·çš„ç‰©ç†åˆ†é¡µï¼Œè€Œä¸ä¼šé‡‡ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯ã€‚ä¹Ÿå°±å®ç°äº†æœ‰è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹é—´çš„å…±äº«å†…å­˜ï¼ˆç±»ä¼¼ä¸<code>pipe</code>ï¼Œåªèƒ½ç”¨äºæœ‰è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹ï¼‰ã€‚</li></ul><p>ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œ <code>exec()</code> æ—¶æ˜ å°„ä¼šä¸¢å¤±ï¼Œä½†é€šè¿‡ <code>fork()</code> åˆ›å»ºçš„å­è¿›ç¨‹ä¼šç»§æ‰¿æ˜ å°„ï¼Œæ˜ å°„ç±»å‹ï¼ˆ<code>MAP_PRIVATE</code> æˆ– <code>MAP_SHARED</code>ï¼‰ä¹Ÿä¼šè¢«ç»§æ‰¿</p><h3 id="mmap-å‡½æ•°"><a href="#mmap-å‡½æ•°" class="headerlink" title="mmap å‡½æ•°"></a>mmap å‡½æ•°</h3><p><code>mmap()</code>ç³»ç»Ÿè°ƒç”¨åœ¨è°ƒç”¨è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­åˆ›å»ºä¸€ä¸ªæ–°æ˜ å°„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>addr</code>ï¼šæŒ‡å®šæ˜ å°„è¢«æ”¾ç½®çš„è™šæ‹Ÿåœ°å€ï¼ˆä»…ä½œå†…æ ¸å‚è€ƒï¼Œè¿˜æ¶‰åŠåˆ†é¡µå¯¹é½ï¼‰ï¼Œä¸€èˆ¬ä¸º<code>NULL</code>ï¼Œç”±å†…æ ¸è‡ªåŠ¨é€‰å®š</li><li><code>length</code>ï¼šæŒ‡å®šæ˜ å°„çš„å­—èŠ‚æ•°ã€‚å®é™…æ˜ å°„å¤§å°ä¼šå‘ä¸Šæå‡ä¸ºåˆ†é¡µå¤§å°çš„å€æ•°</li><li><code>prot</code>ï¼šä½æ©ç ï¼ŒæŒ‡å®šæ–½åŠ äºæ˜ å°„ä¹‹ä¸Šçš„ä¿æŠ¤ä¿¡æ¯ï¼Œè¦ä¹ˆæ˜¯<code>PROT_NONE</code>ï¼Œè¦ä¹ˆæ˜¯å…¶ä»–ä¸‰ä¸ªæ ‡è®°çš„ç»„åˆ<ul><li><code>PROT_NONE</code> åŒºåŸŸæ— æ³•è®¿é—®</li><li><code>PROT_READ</code> åŒºåŸŸå†…å®¹å¯è¯»å–</li><li><code>PROT_WRITE</code> åŒºåŸŸå†…å®¹å¯ä¿®æ”¹</li><li><code>PROT_EXEC</code> åŒºåŸŸå†…å®¹å¯æ‰§è¡Œ</li></ul></li><li><code>flag</code>ï¼šæ§åˆ¶æ˜ å°„æ“ä½œå„ä¸ªæ–¹é¢çš„é€‰é¡¹çš„ä½æ©ç ï¼Œè¿™ä¸ªæ©ç å¿…é¡»åªåŒ…å«ä¸‹åˆ—å€¼ä¸­ä¸€ä¸ªï¼š<ul><li><code>MAP_PRIVATE</code> åˆ›å»ºä¸€ä¸ªç§æœ‰æ˜ å°„</li><li><code>MAP_SHARED</code> åˆ›å»ºä¸€ä¸ªå…±äº«æ˜ å°„</li></ul></li><li>å‰©ä½™çš„å‚æ•° <code>fd</code> å’Œ <code>offset</code> æ˜¯ç”¨äºæ–‡ä»¶æ˜ å°„çš„ï¼ˆåŒ¿åæ˜ å°„å°†å¿½ç•¥å®ƒä»¬ï¼‰</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼šæ˜ å°„çš„èµ·å§‹åœ°å€</li><li>å¤±è´¥ï¼šè¿”å›<code>MAP_FAILED</code></li></ul></li></ul><p>ä¸€ä¸ªæ–‡ä»¶æ˜ å°„çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure><h3 id="munmap-å‡½æ•°"><a href="#munmap-å‡½æ•°" class="headerlink" title="munmap å‡½æ•°"></a>munmap å‡½æ•°</h3><p>ä¸<code>mmap()</code>ç›¸åï¼Œä»è¿›ç¨‹è™šæ‹Ÿåœ°å€ä¸­åˆ é™¤ä¸€ä¸ªæ˜ å°„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>addr</code>ï¼šéœ€è¦è§£é™¤æ˜ å°„çš„åœ°å€èŒƒå›´çš„èµ·å§‹åœ°å€ã€‚é€šå¸¸ä¼ <code>mmap</code>çš„è¿”å›å€¼ã€‚</li><li><code>length</code>ï¼šéœ€è¦è§£é™¤æ˜ å°„çš„åœ°å€èŒƒå›´çš„å¤§å°ï¼Œä¸€èˆ¬ä¸<code>mmap</code>ä¸­çš„å¤§å°ä¸€è‡´ï¼Œä¹Ÿä¼šè‡ªåŠ¨é¡µå¯¹é½ã€‚</li><li>è¿”å›å€¼ï¼š</li></ul><h2 id="POSIX-IPC"><a href="#POSIX-IPC" class="headerlink" title="POSIX IPC"></a>POSIX IPC</h2><ul><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šç±»ä¼¼ä¸æ•°æ®åŒ…ï¼Œæ¯ä¸ªæ¶ˆæ¯ç‹¬ç«‹ã€‚ä¸System V æ ‡å‡†ä¸­çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸åŒï¼ŒPOSIXä¸åŒºåˆ†æ¶ˆæ¯ç±»å‹ï¼Œä½†æ¯ä¸ªæ¶ˆæ¯æœ‰ä¸€ä¸ªä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§é«˜çš„æ¶ˆæ¯å…ˆè¢«å¤„ç†ã€‚</li><li>ä¿¡å·é‡ï¼šä¹Ÿæ˜¯ç”±å†…æ ¸ç»´æŠ¤çš„æ•´æ•°ï¼Œå…¶å€¼æ°¸è¿œéƒ½ä¸ä¼šå°äº0ã€‚</li><li>å…±äº«å†…å­˜</li></ul><h3 id="æ ‡è¯†-1"><a href="#æ ‡è¯†-1" class="headerlink" title="æ ‡è¯†"></a>æ ‡è¯†</h3><p>åœ¨ SUSv3 ä¸­è§„å®šçš„å”¯ä¸€ä¸€ç§ç”¨æ¥æ ‡è¯† POSIX IPC å¯¹è±¡çš„å¯ç§»æ¤çš„æ–¹å¼æ˜¯ä½¿ç”¨<strong>ä»¥æ–œçº¿æ‰“å¤´åé¢è·Ÿç€ä¸€ä¸ªæˆ–å¤šä¸ªéæ–œçº¿å­—ç¬¦çš„åå­—</strong>ï¼Œå¦‚ &#x2F;myobjectï¼Œæ³¨æ„<strong>ä¸èƒ½</strong>æ˜¯ <code>/tmp/myobject</code>ï¼</p><p>å¯¹è±¡åç§°çœ‹èµ·æ¥åƒåœ¨æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶åï¼Œåœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œä¹Ÿç¡®å®ä¼šåˆ›å»ºè¯¥æ–‡ä»¶ï¼Œè€Œéç‰¹æƒç”¨æˆ·åˆæ— æ³•åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ï¼Œæ‰€ä»¥è¦ä¿è¯ç¨‹åºçš„å¯ç§»æ¤æ€§éœ€è¦æ³¨æ„å¯¹è±¡åçš„é€‰æ‹©ã€‚</p><p>åœ¨ Linux ä¸Šï¼ŒPOSIX å…±äº«å†…å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—å¯¹è±¡çš„åå­—çš„æœ€å¤§é•¿åº¦ä¸º NAME_MAXï¼ˆ255ï¼‰ä¸ªå­—ç¬¦ï¼Œè€Œä¿¡å·é‡çš„åå­—çš„æœ€å¤§é•¿åº¦è¦å°‘ 4 ä¸ªå­—ç¬¦ï¼Œè¿™æ˜¯å› ä¸ºå®ç°ä¼šåœ¨ä¿¡å·é‡åå­—å‰é¢åŠ ä¸Šå­—ç¬¦ä¸² sem.</p><table><thead><tr><th>æ¥å£</th><th>æ¶ˆæ¯é˜Ÿåˆ—</th><th>ä¿¡å·é‡</th><th>å…±äº«å†…å­˜</th></tr></thead><tbody><tr><td>å¤´æ–‡ä»¶</td><td>&lt;mqueue.h&gt;</td><td></td><td></td></tr><tr><td>å¯¹è±¡å¥æŸ„</td><td>mqd_t</td><td></td><td></td></tr><tr><td>åˆ›å»º&#x2F;æ‰“å¼€</td><td>mq_open()</td><td></td><td></td></tr><tr><td>å…³é—­</td><td>mq_close()</td><td></td><td></td></tr><tr><td>æ–­å¼€é“¾æ¥</td><td>mq_unlink()</td><td></td><td></td></tr><tr><td>æ‰§è¡Œ IPC</td><td>mq_send()<br />mq_receive()</td><td></td><td></td></tr><tr><td>å…¶ä»–æ“ä½œ</td><td>mq_setattr()<br />mq_getattr()<br />mq_notify()</td><td></td><td></td></tr></tbody></table><h3 id="æ¶ˆæ¯é˜Ÿåˆ—"><a href="#æ¶ˆæ¯é˜Ÿåˆ—" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—"></a>æ¶ˆæ¯é˜Ÿåˆ—</h3><p>åœ¨ Linux ä¸Šï¼ŒPOSIX æ¶ˆæ¯é˜Ÿåˆ—è¢«å®ç°æˆäº†è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸­çš„ i-nodeï¼Œå¹¶ä¸”æ¶ˆæ¯é˜Ÿåˆ—æè¿°ç¬¦ä¹Ÿæ˜¯æ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/image-20221216152710119.png" alt="image-20221216152710119"></p><p>éªŒè¯æ–‡ä»¶æè¿°ç¬¦ä¸æ¶ˆæ¯é˜Ÿåˆ—æè¿°ç¬¦çš„å…³ç³»ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span> <span class="comment">/* For O_* constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span> <span class="comment">/* For mode constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ipc_object = <span class="string">&quot;/msgqueue&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> <span class="title">attr</span>;</span></span><br><span class="line">    attr.mq_maxmsg = <span class="number">100</span>;</span><br><span class="line">    attr.mq_msgsize = <span class="number">1500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> fd1, fd2;</span><br><span class="line">    fd1 = open(<span class="string">&quot;./test1&quot;</span>, O_CREAT|O_WRONLY, <span class="number">0664</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;éšä¾¿æ‰“å¼€äº†ä¸ªæ–‡ä»¶ï¼Œå…¶fd = %d\n&quot;</span>, fd1);</span><br><span class="line"></span><br><span class="line">    <span class="type">mqd_t</span> obj = mq_open(ipc_object, O_CREAT|O_EXCL|O_RDWR, <span class="number">0664</span>, &amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (obj &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msg_queue open failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;åˆ›å»ºå¹¶æ‰“å¼€äº†æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…¶msg_queue id: %d\n&quot;</span>, obj);</span><br><span class="line"></span><br><span class="line">    fd2 = open(<span class="string">&quot;./test2&quot;</span>, O_CREAT|O_WRONLY, <span class="number">0664</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;éšä¾¿æ‰“å¼€äº†ä¸ªæ–‡ä»¶ï¼Œå…¶fd = %d\n&quot;</span>, fd2);</span><br><span class="line"></span><br><span class="line">    close(fd1);</span><br><span class="line">    close(fd2);</span><br><span class="line">    unlink(<span class="string">&quot;./test1&quot;</span>);</span><br><span class="line">    unlink(<span class="string">&quot;./test2&quot;</span>);</span><br><span class="line">    mq_close(obj);</span><br><span class="line">    mq_unlink(ipc_object);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// gcc test.c -o test &amp;&amp; ./test</span></span><br></pre></td></tr></table></figure><h4 id="é˜Ÿåˆ—ç‰¹æ€§"><a href="#é˜Ÿåˆ—ç‰¹æ€§" class="headerlink" title="é˜Ÿåˆ—ç‰¹æ€§"></a>é˜Ÿåˆ—ç‰¹æ€§</h4><p>ä¹Ÿå¯ä»¥è¯´æ˜¯é˜Ÿåˆ—å‚æ•°ï¼Œå…ˆè‡ªå·±æ€è€ƒä¸€ä¸‹ï¼Œå®ç°ä¸€ä¸ªé˜Ÿåˆ—éœ€è¦æŒ‡å®šå“ªäº›å‚æ•°å‘¢ï¼Ÿé˜Ÿåˆ—çš„å¤§å°ï¼ˆå¯ä»¥å®¹çº³çš„æ¶ˆæ¯æ•°é‡ï¼‰ã€æ¯ä¸ªæ¶ˆæ¯çš„é•¿åº¦ã€å½“å‰é˜Ÿåˆ—ä¸­æœ‰å¤šå°‘æ¶ˆæ¯ã€‚</p><p>mq_open()ã€mq_getattr()ä»¥åŠ mq_setattr()å‡½æ•°éƒ½ä¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œå®ƒæ˜¯ä¸€ä¸ªæŒ‡å‘ mq_attr ç»“æ„çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> &#123;</span></span><br><span class="line">    <span class="type">long</span> mq_flags;       <span class="comment">/* Flags (ignored for mq_open()) */</span></span><br><span class="line">    <span class="type">long</span> mq_maxmsg;      <span class="comment">/* Max. # of messages on queue */</span></span><br><span class="line">    <span class="type">long</span> mq_msgsize;     <span class="comment">/* Max. message size (bytes) */</span></span><br><span class="line">    <span class="type">long</span> mq_curmsgs;     <span class="comment">/* # of messages currently in queue</span></span><br><span class="line"><span class="comment">                                       (ignored for mq_open()) */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æŸ¥çœ‹é»˜è®¤å‚æ•°ï¼š</span></span><br><span class="line"><span class="comment">    mq_flags: 0, O_NONBLOCK: 2048</span></span><br><span class="line"><span class="comment">    mq_maxmsg: 10</span></span><br><span class="line"><span class="comment">    mq_msgsize: 8192</span></span><br><span class="line"><span class="comment">    mq_curmsgs: 1</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">get_default_attr</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *ipc_key = <span class="string">&quot;/default_attr&quot;</span>;</span><br><span class="line">    <span class="type">mqd_t</span> obj = mq_open(ipc_object, O_CREAT|O_EXCL|O_RDWR, <span class="number">0666</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msg_queue open failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> <span class="title">attr</span>;</span></span><br><span class="line">    <span class="type">int</span> err = mq_getattr(obj, &amp;attr);</span><br><span class="line">    <span class="keyword">if</span> (err == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;getattr error!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mq_flags: %lld, O_NONBLOCK: %lld\n&quot;</span>, attr.mq_flags, O_NONBLOCK);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mq_maxmsg: %lld\n&quot;</span>, attr.mq_maxmsg);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mq_msgsize: %lld\n&quot;</span>, attr.mq_msgsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;mq_curmsgs: %lld\n&quot;</span>, attr.mq_curmsgs);</span><br><span class="line"></span><br><span class="line">    mq_close(obj);</span><br><span class="line">    mq_unlink(ipc_key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="mq-open"><a href="#mq-open" class="headerlink" title="mq_open"></a>mq_open</h4><p>åˆ›å»ºä¸€ä¸ªæ–°çš„æ¶ˆæ¯é˜Ÿåˆ—æˆ–è€…æ‰“å¼€ç°æœ‰çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span>           <span class="comment">/* For O_* constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>        <span class="comment">/* For mode constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">mqd_t</span> <span class="title function_">mq_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> oflag)</span>;</span><br><span class="line"><span class="type">mqd_t</span> <span class="title function_">mq_open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, <span class="type">int</span> oflag, <span class="type">mode_t</span> mode,</span></span><br><span class="line"><span class="params">              <span class="keyword">struct</span> mq_attr *attr)</span>;</span><br></pre></td></tr></table></figure><ul><li><p><code>name</code>ï¼š<code>IPC key</code>ï¼Œå¯¹è±¡æ ‡è¯†ï¼›</p></li><li><p><code>oflag</code>ï¼šå’Œ<code>open</code>ä¸­çš„<code>flag</code>ç±»ä¼¼ï¼Œæ§åˆ¶æ‰“å¼€å‚æ•°ï¼Œè¯»å†™ã€åˆ›å»ºã€éé˜»å¡ç­‰ã€‚</p><ul><li>O_CREAT | O_EXCL</li><li>O_RDONLY | O_WRONLY | O_RDWR</li><li>O_NONBLOCK</li></ul></li><li><p>å¦‚æœ<code>oflag</code>ä¸­æŒ‡å®šçš„<code>O_CREAT</code>ï¼Œå°±è¿˜éœ€è¦<code>mode</code>å’Œ<code>attr</code>ï¼Œåˆ†åˆ«æ§åˆ¶æ–‡ä»¶æƒé™ï¼Œå’Œæ¶ˆæ¯é˜Ÿåˆ—çš„ç‰¹æ€§ã€‚</p><ul><li><code>mode</code>ï¼šæ–‡ä»¶æƒé™ï¼Œ<code>0664</code>ï¼Œç±»ä¼¼ä¸<code>chmod</code>ä¿®æ”¹æƒé™æ—¶ç”¨çš„å€¼ã€‚</li><li><code>attr</code>ï¼šæŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„å‚æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨<code>NULL</code>ä½¿ç”¨é»˜è®¤å€¼ã€‚</li><li>æŒ‡å®šé˜Ÿåˆ—å‚æ•°æ—¶ï¼Œæœ€å¥½ä½¿ç”¨<code>O_EXCL</code>ï¼Œå¦åˆ™ç”±äºé˜Ÿåˆ—å·²ç»å­˜åœ¨ï¼Œå…¶å‚æ•°è‹¥ä¸æŒ‡å®šçš„å‚æ•°ä¸ä¸€è‡´ï¼Œå¯èƒ½ä¼šå¯¼è‡´åç»­çš„<code>mq_receive</code>å‡ºé”™ã€‚</li></ul></li><li><p>è¿”å›å€¼ï¼š</p><ul><li>è°ƒç”¨æˆåŠŸï¼Œè¿”å›ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æè¿°ç¬¦ï¼ˆ<code>&gt;0</code>ï¼‰ï¼Œåç»­ç”¨å®ƒæ¥å¼•ç”¨è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li><li>è°ƒç”¨å¤±è´¥ï¼Œè¿”å› <code>-1</code>ã€‚</li></ul></li></ul><h4 id="mq-close"><a href="#mq-close" class="headerlink" title="mq_close"></a>mq_close</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mq_close</span><span class="params">(<span class="type">mqd_t</span> mqdes)</span>;</span><br></pre></td></tr></table></figure><p>å…³é—­ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè¿›ç¨‹åº”è¯¥ä¸»åŠ¨å…³é—­ä¸ä½¿ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œé¿å…æ¶ˆæ¯é˜Ÿåˆ—æè¿°ç¬¦è€—å°½ã€‚æ³¨æ„ï¼Œå…³é—­å¹¶ä¸ä¼šåˆ é™¤è¯¥æ¶ˆæ¯é˜Ÿåˆ—ã€‚åˆ é™¤éœ€è¦ä½¿ç”¨<code>mq_unlink</code>ã€‚</p><h4 id="mq-unlink"><a href="#mq-unlink" class="headerlink" title="mq_unlink"></a>mq_unlink</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mq_unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure><p>åˆ é™¤æŒ‡å®š<code>name</code>æ ‡è¯†çš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶å°†é˜Ÿåˆ—æ ‡è®°ä¸ºåœ¨æ‰€æœ‰è¿›ç¨‹ä½¿ç”¨å®Œåé”€æ¯ã€‚</p><h4 id="mq-send"><a href="#mq-send" class="headerlink" title="mq_send"></a>mq_send</h4><p>å°†ä½äº msg_ptr æŒ‡å‘çš„ç¼“å†²åŒºä¸­çš„æ¶ˆæ¯æ·»åŠ åˆ°æè¿°ç¬¦ mqdes æ‰€å¼•ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œè¿˜éœ€è¦æŒ‡å®šæ¶ˆæ¯çš„é•¿åº¦ã€æ¶ˆæ¯çš„ä¼˜å…ˆçº§ï¼Œå¦å¤–æ³¨æ„è¯¥è¿‡ç¨‹å­˜åœ¨å†…å­˜æ‹·è´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mq_send</span><span class="params">(<span class="type">mqd_t</span> mqdes, <span class="type">const</span> <span class="type">char</span> *msg_ptr,</span></span><br><span class="line"><span class="params">            <span class="type">size_t</span> msg_len, <span class="type">unsigned</span> <span class="type">int</span> msg_prio)</span>;</span><br></pre></td></tr></table></figure><ul><li>msg_ptrï¼šæŒ‡å‘å¾…å‘é€æ¶ˆæ¯åœ°å€ï¼›</li><li>msg_lenï¼šå¾…å‘é€æ¶ˆæ¯é•¿åº¦ï¼›</li><li>msg_prioï¼šå¾…å‘é€æ¶ˆæ¯ä¼˜å…ˆçº§ï¼›</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸè¿”å› <code>0</code>ï¼›</li><li>å¤±è´¥è¿”å› <code>-1</code>ï¼›</li></ul></li></ul><p>æ¯æ¡æ¶ˆæ¯éƒ½æ‹¥æœ‰ä¸€ä¸ªç”¨éè´Ÿæ•´æ•°è¡¨ç¤ºçš„ä¼˜å…ˆçº§ï¼Œ0è¡¨ç¤ºæœ€ä½ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§çš„ä¸Šé™åœ¨ä¸åŒç³»ç»Ÿä¸Šä¹Ÿæœ‰å·®å¼‚ï¼ŒSUSv3 è¦æ±‚è¿™ä¸ªä¸Šé™è‡³å°‘æ˜¯ 32ï¼Œè¿™å¯ä»¥é€šè¿‡å®šä¹‰å¸¸é‡ MQ_PRIO_MAXæŒ‡å®šï¼Œåœ¨Linuxä¸Šï¼Œä¸º32768ã€‚</p><blockquote><p><code>getconf -a | grep MQ_PRIO_MAX</code></p></blockquote><p>å½“ä¸€æ¡æ¶ˆæ¯è¢«æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­æ—¶ï¼Œå®ƒä¼šè¢«æ”¾ç½®åœ¨é˜Ÿåˆ—ä¸­å…·æœ‰ç›¸åŒçš„ä¼˜å…ˆçº§çš„æ‰€æœ‰æ¶ˆæ¯ä¹‹åã€‚å¦‚æœæ— éœ€ä½¿ç”¨ï¼Œå°†å…¶æŒ‡å®šä¸º0ã€‚</p><p>å¦‚æœé˜Ÿåˆ—æ»¡äº†ï¼Œ<code>mq_send</code>ä¼šè¢«é˜»å¡ï¼Œé™¤é<code>mq_open</code>æ—¶è®¾ç½®éé˜»å¡ã€‚</p><h4 id="mq-receive"><a href="#mq-receive" class="headerlink" title="mq_receive"></a>mq_receive</h4><p>ä» mqdes å¼•ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­åˆ é™¤ä¸€æ¡ä¼˜å…ˆçº§æœ€é«˜ã€å­˜åœ¨æ—¶é—´æœ€é•¿çš„æ¶ˆæ¯å¹¶å°†åˆ é™¤çš„æ¶ˆæ¯æ”¾ç½®åœ¨ msg_ptr æŒ‡å‘çš„ç¼“å†²åŒºï¼Œè¯¥è¿‡ç¨‹åŒæ ·å­˜åœ¨å†…å­˜æ‹·è´ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mq_receive</span><span class="params">(<span class="type">mqd_t</span> mqdes, <span class="type">char</span> *msg_ptr,</span></span><br><span class="line"><span class="params">                   <span class="type">size_t</span> msg_len, <span class="type">unsigned</span> <span class="type">int</span> *msg_prio)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>msg_ptr</code>ï¼šé¢„åˆ†é…çš„å†…å­˜é¦–åœ°å€ã€‚</li><li><code>msg_len</code>ï¼šè°ƒç”¨è€…ä½¿ç”¨ msg_len å‚æ•°æ¥æŒ‡å®š msg_ptr æŒ‡å‘çš„ç¼“å†²åŒºä¸­çš„å¯ç”¨å­—èŠ‚æ•°ï¼Œä¸ç®¡æ¶ˆæ¯çš„å®é™…å¤§å°æ˜¯ä»€ä¹ˆï¼Œmsg_lenï¼ˆå³ msg_ptr æŒ‡å‘çš„ç¼“å†²åŒºçš„å¤§å°ï¼‰å¿…é¡»è¦å¤§äºæˆ–ç­‰äºé˜Ÿåˆ—çš„ mq_msgsize ç‰¹æ€§ã€‚</li><li><code>msg_prio</code>ï¼šä¼ å‡ºå‚æ•°ï¼Œæ¥æ”¶åˆ°çš„æ¶ˆæ¯çš„ä¼˜å…ˆçº§ä¼šè¢«å¤åˆ¶åˆ° msg_prio æŒ‡å‘çš„ä½ç½®å¤„ã€‚</li><li>è¿”å›å€¼ï¼š<ul><li>æ­£å¸¸æƒ…å†µè¿”å›æ¥æ”¶çš„æ¶ˆæ¯çš„å¤§å°ï¼</li><li>å¤±è´¥è¿”å› <code>-1</code>ã€‚</li></ul></li></ul><p>å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸ºç©ºï¼Œmq_receive ä¼šé˜»å¡ç›´åˆ°å­˜åœ¨å¯ç”¨çš„æ¶ˆæ¯ã€‚</p><h4 id="æ”¶å‘è¶…æ—¶"><a href="#æ”¶å‘è¶…æ—¶" class="headerlink" title="æ”¶å‘è¶…æ—¶"></a>æ”¶å‘è¶…æ—¶</h4><p>ä¸ä¸Šé¢çš„æ”¶å‘å‡½æ•°ç›¸åŒï¼Œåªæ˜¯å‚æ•°å¤šäº†ä¸ªè¶…æ—¶æ—¶é—´<code>abs_timeout</code>ï¼Œä¸ºè°ƒç”¨é˜»å¡çš„æ—¶é—´æŒ‡å®šä¸€ä¸ªä¸Šé™ã€‚abs_timeout å‚æ•°æ˜¯ä¸€ä¸ª timespec ç»“æ„ï¼Œå®ƒå°†è¶…æ—¶æ—¶é—´æè¿°ä¸ºè‡ªæ–°çºªå…ƒåˆ°ç°åœ¨çš„ä¸€ä¸ª<strong>ç»å¯¹å€¼</strong>ï¼Œå…¶å•ä½ä¸ºç§’æ•°å’Œçº³ç§’æ•°ã€‚å¦‚æœè¦æŒ‡å®šç›¸å¯¹å€¼ï¼Œå¯ç”¨é€šè¿‡è·å–å½“å‰æ—¶é—´ï¼Œå°†å½“å‰æ—¶é—´+ç›¸å¯¹å€¼èµ‹å€¼ç»™<code>abs_timeout</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">mq_timedsend</span><span class="params">(<span class="type">mqd_t</span> mqdes, <span class="type">const</span> <span class="type">char</span> *msg_ptr,</span></span><br><span class="line"><span class="params">                 <span class="type">size_t</span> msg_len, <span class="type">unsigned</span> <span class="type">int</span> msg_prio,</span></span><br><span class="line"><span class="params">                 <span class="type">const</span> <span class="keyword">struct</span> timespec *abs_timeout)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">mq_timedreceive</span><span class="params">(<span class="type">mqd_t</span> mqdes, <span class="type">char</span> *msg_ptr,</span></span><br><span class="line"><span class="params">                        <span class="type">size_t</span> msg_len, <span class="type">unsigned</span> <span class="type">int</span> *msg_prio,</span></span><br><span class="line"><span class="params">                        <span class="type">const</span> <span class="keyword">struct</span> timespec *abs_timeout)</span>;</span><br></pre></td></tr></table></figure><p>å› è¶…æ—¶è€Œæ— æ³•å®Œæˆæ“ä½œï¼Œé‚£ä¹ˆè°ƒç”¨å°±ä¼šå¤±è´¥å¹¶è¿”å› ETIMEDOUT é”™è¯¯ã€‚</p><h4 id="example-4"><a href="#example-4" class="headerlink" title="example"></a>example</h4><p><strong>send</strong>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span> <span class="comment">/* For O_* constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span> <span class="comment">/* For mode constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const char* ipc_object = &quot;/home/yogurt/mymsg&quot;;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ipc_object = <span class="string">&quot;/tmpmyobsdfject2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* send æ¯ç§’å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­å†™å…¥è®¡æ•°å€¼ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mq_attr</span> <span class="title">attr</span>;</span></span><br><span class="line">    attr.mq_maxmsg = <span class="number">100</span>;</span><br><span class="line">    attr.mq_msgsize = <span class="number">1500</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ€»æ˜¯æŠ¥æƒé™ä¸è¶³ */</span></span><br><span class="line">    <span class="type">mqd_t</span> obj = mq_open(ipc_object, O_CREAT|O_RDWR, <span class="number">0666</span>, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (obj &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msg_queue open failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;msg_queue id: %d\n&quot;</span>, obj);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> msg[<span class="number">1500</span>];</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(msg, <span class="string">&quot;%d&quot;</span>, i++);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        mq_send(obj, msg, <span class="built_in">strlen</span>(msg), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mq_close(obj);</span><br><span class="line">    mq_unlink(ipc_object);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>receive</strong>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span> <span class="comment">/* For O_* constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mqueue.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span> <span class="comment">/* For mode constants */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const char* ipc_object = &quot;/home/yogurt/mymsg&quot;;</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ipc_object = <span class="string">&quot;/tmpmyobsdfject2&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* send æ¯ç§’å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­å†™å…¥è®¡æ•°å€¼ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">mqd_t</span> obj = mq_open(ipc_object, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;msg_queue open failed!&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;msg_queue id: %u\n&quot;</span>, obj);</span><br><span class="line">    <span class="type">char</span> msg[<span class="number">10000</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> prio;</span><br><span class="line">    <span class="type">int</span> bytes;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        bytes = mq_receive(obj, msg, <span class="number">10000</span>, &amp;prio);</span><br><span class="line">        <span class="keyword">if</span> (bytes == <span class="number">-1</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;receive error! &quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;msg: %s, prio: %u\n&quot;</span>, msg, prio);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mq_close(obj);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶"><a href="#æ–‡ä»¶" class="headerlink" title="æ–‡ä»¶"></a>æ–‡ä»¶</h2><p>ä¸ <code>fifo</code> è¡Œä¸ºç±»ä¼¼ï¼Œä¸¤ä¸ªè¿›ç¨‹åˆ†åˆ«ä»¥åªè¯»å’Œåªå†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ã€‚ç†è®ºä¸Šå¯è¡Œï¼Œä½†ä¸æ¨èã€‚æ•ˆç‡ä½ä¸‹ï¼Œè€Œä¸”å…±äº«åç§»é‡å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚</p><p>åªæœ‰é€šè¿‡ <code>write</code> å†™å…¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­çš„å†…å®¹æ‰å¯è¯»å–ã€‚</p><h2 id="mmap-å†…å­˜æ˜ å°„-1"><a href="#mmap-å†…å­˜æ˜ å°„-1" class="headerlink" title="mmap å†…å­˜æ˜ å°„"></a>mmap å†…å­˜æ˜ å°„</h2><p>å†…å­˜æ˜ å°„ä¹Ÿç§°<strong>å…±äº«å†…å­˜</strong>ï¼Œæ˜ å°„çš„æ–¹å¼åˆ†ä¸º<strong>æ–‡ä»¶æ˜ å°„</strong>å’Œ<strong>åŒ¿åæ˜ å°„</strong>ã€‚</p><p>å­˜å‚¨æ˜ å°„ I&#x2F;O(Memory-mapped I&#x2F;O) ä½¿ä¸€ä¸ªç£ç›˜æ–‡ä»¶ä¸å­˜å‚¨ç©ºé—´ä¸­çš„ä¸€ä¸ªç¼“å†²åŒºç›¸æ˜ å°„ã€‚äºæ˜¯ä»ç¼“å†²åŒºä¸­å–æ•°æ®ï¼Œå°±ç›¸å½“äºè¯»æ–‡ä»¶ä¸­çš„ç›¸åº”å­—èŠ‚ã€‚ä¸æ­¤ç±»ä¼¼ï¼Œå°†æ•°æ®å­˜å…¥ç¼“å†²åŒºï¼Œåˆ™ç›¸åº”çš„å­—èŠ‚å°±è‡ªåŠ¨å†™å…¥æ–‡ä»¶ã€‚è¿™æ ·ï¼Œå°±å¯åœ¨ä¸ä½¿ç”¨ <code>read</code> å’Œ <code>write</code> å‡½æ•°çš„æƒ…å†µä¸‹ï¼Œä½¿åœ°å€æŒ‡é’ˆå®Œæˆ I&#x2F;O æ“ä½œã€‚</p><p>ä½¿ç”¨è¿™ç§æ–¹æ³•ï¼Œé¦–å…ˆåº”è¯¥é€šçŸ¥å†…æ ¸ï¼Œå°†ä¸€ä¸ªæŒ‡å®šæ–‡ä»¶æ˜ å°„åˆ°å­˜å‚¨åŒºåŸŸä¸­ã€‚è¿™ä¸ªæ˜ å°„å·¥ä½œå¯ä»¥é€šè¿‡ <code>mmap</code> å‡½æ•°æ¥å®ç°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length, <span class="type">int</span> prot, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> fd, <span class="type">off_t</span> offset)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>addr</code>ï¼šæ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œé€šå¸¸ä¼  NULLï¼Œè®©ç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„åœ°å€</li><li><code>length</code>ï¼šå…±äº«å†…å­˜æ˜ å°„åŒºçš„å¤§å°ï¼ˆè¦ &lt;&#x3D; æ–‡ä»¶çš„å®é™…å¤§å°ï¼‰</li><li><code>prot</code>ï¼šå…±äº«å†…å­˜æ˜ å°„åŒºçš„è¯»å†™å±æ€§ã€‚<code>PROT_READ</code>ã€<code>PROT_WRITE</code>ã€<code>PROT_READ|PROT_WRITE</code></li><li><code>flags</code>ï¼šæ ‡æ³¨å…±äº«å†…å­˜çš„å…±äº«å±æ€§ã€‚<code>MAP_SHARED</code>ã€<code>MAP_PRIVATE</code>ï¼ˆä¿®æ”¹ä¸ä¼šååº”åˆ°ç£ç›˜ä¸Šï¼Œå¾ˆå°‘ç”¨ï¼‰</li><li><code>fd</code>ï¼šç”¨äºåˆ›å»ºå…±äº«å†…å­˜æ˜ å°„åŒºçš„é‚£ä¸ªæ–‡ä»¶çš„ æ–‡ä»¶æè¿°ç¬¦ã€‚</li><li><code>offset</code>ï¼šåç§»ä½ç½®ï¼Œéœ€æ˜¯ 4k çš„æ•´æ•°å€ã€‚é»˜è®¤ 0ï¼Œè¡¨ç¤ºæ˜ å°„æ–‡ä»¶å…¨éƒ¨ã€‚</li><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼šæ˜ å°„åŒºçš„é¦–åœ°å€ã€‚</li><li>å¤±è´¥ï¼š<code>MAP_FAILED (void*(-1))</code>ï¼Œ errno</li></ul></li></ul><h3 id="munmap-å‡½æ•°-1"><a href="#munmap-å‡½æ•°-1" class="headerlink" title="munmap å‡½æ•°"></a>munmap å‡½æ•°</h3><p>é‡Šæ”¾æ˜ å°„åŒºã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">munmap</span><span class="params">(<span class="type">void</span> *addr, <span class="type">size_t</span> length)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>addr</code>ï¼šæ˜ å°„åŒºçš„é¦–åœ°å€</li><li><code>length</code>ï¼šæ˜ å°„åŒºçš„å¤§å°</li><li>è¿”å›å€¼ï¼š<ul><li><code>0</code>ï¼šæˆåŠŸ</li><li><code>-1</code>ï¼šå¤±è´¥ï¼Œerrno</li></ul></li></ul><h3 id="mmap-æ³¨æ„äº‹é¡¹"><a href="#mmap-æ³¨æ„äº‹é¡¹" class="headerlink" title="mmap æ³¨æ„äº‹é¡¹"></a>mmap æ³¨æ„äº‹é¡¹</h3><ol><li>ç”¨äºåˆ›å»ºæ˜ å°„åŒºçš„æ–‡ä»¶å¤§å°ä¸º 0ï¼Œå®é™…æŒ‡å®šé 0 å¤§å°åˆ›å»ºæ˜ å°„åŒºï¼Œå‡º â€œæ€»çº¿é”™è¯¯â€ã€‚</li><li>ç”¨äºåˆ›å»ºæ˜ å°„åŒºçš„æ–‡ä»¶å¤§å°ä¸º 0ï¼Œå®é™…åˆ¶å®š 0 å¤§å°åˆ›å»ºæ˜ å°„åŒºï¼Œ å‡º â€œæ— æ•ˆå‚æ•°â€ã€‚</li><li>ç”¨äºåˆ›å»ºæ˜ å°„åŒºçš„æ–‡ä»¶è¯»å†™å±æ€§ä¸ºï¼Œåªè¯»ã€‚æ˜ å°„åŒºå±æ€§ä¸º è¯»ã€å†™ã€‚ å‡º â€œæ— æ•ˆå‚æ•°â€ã€‚</li><li>åˆ›å»ºæ˜ å°„åŒºï¼Œéœ€è¦ read æƒé™ã€‚å½“è®¿é—®æƒé™æŒ‡å®šä¸º â€œå…±äº«â€MAP_SHARED æ—¶ï¼Œ mmap çš„è¯»å†™æƒé™ï¼Œåº”è¯¥ &lt;&#x3D;æ–‡ä»¶çš„ open æƒé™ã€‚ åªå†™ä¸è¡Œã€‚</li><li>æ–‡ä»¶æè¿°ç¬¦ fdï¼Œåœ¨ mmap åˆ›å»ºæ˜ å°„åŒºå®Œæˆå³å¯å…³é—­ã€‚åç»­è®¿é—®æ–‡ä»¶ï¼Œç”¨ åœ°å€è®¿é—®ã€‚</li><li>offset å¿…é¡»æ˜¯ 4096 çš„æ•´æ•°å€ã€‚ï¼ˆMMU æ˜ å°„çš„æœ€å°å•ä½ 4k ï¼‰</li><li>å¯¹ç”³è¯·çš„æ˜ å°„åŒºå†…å­˜ï¼Œä¸èƒ½è¶Šç•Œè®¿é—®ã€‚</li><li>munmap ç”¨äºé‡Šæ”¾çš„ åœ°å€ï¼Œå¿…é¡»æ˜¯ mmap ç”³è¯·è¿”å›çš„åœ°å€ã€‚</li><li>æ˜ å°„åŒºè®¿é—®æƒé™ä¸º â€œç§æœ‰â€MAP_PRIVATE, å¯¹å†…å­˜æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹ï¼Œåªåœ¨å†…å­˜æœ‰æ•ˆï¼Œä¸ä¼šååº”åˆ°ç‰©ç†ç£ç›˜ä¸Šã€‚</li><li>æ˜ å°„åŒºè®¿é—®æƒé™ä¸º â€œç§æœ‰â€MA_PRIVATE, åªéœ€è¦ open æ–‡ä»¶æ—¶ï¼Œæœ‰è¯»æƒé™ï¼Œç”¨äºåˆ›å»ºæ˜ å°„åŒºå³å¯ã€‚</li></ol><hr><ol><li>åˆ›å»ºæ˜ å°„åŒºçš„è¿‡ç¨‹ä¸­ï¼Œéšå«ç€ä¸€æ¬¡å¯¹æ˜ å°„æ–‡ä»¶çš„è¯»æ“ä½œ</li><li>å½“ MAP_SHARED æ—¶ï¼Œè¦æ±‚ï¼šæ˜ å°„åŒºçš„æƒé™åº”è¯¥&lt;&#x3D;æ–‡ä»¶æ‰“å¼€çš„æƒé™ï¼ˆå‡ºäºå¯¹æ˜ å°„åŒºçš„ä¿æŠ¤ï¼‰ã€‚è€ŒMAP_PRIVATE åˆ™æ— æ‰€è°“ï¼Œå› ä¸º mmap ä¸­çš„æƒé™æ˜¯å¯¹å†…å­˜çš„é™åˆ¶</li><li>æ˜ å°„åŒºçš„é‡Šæ”¾ä¸æ–‡ä»¶å…³é—­æ— å…³ã€‚åªè¦æ˜ å°„å»ºç«‹æˆåŠŸï¼Œæ–‡ä»¶å¯ä»¥ç«‹å³å…³é—­</li><li>ç‰¹åˆ«æ³¨æ„ï¼Œå½“æ˜ å°„æ–‡ä»¶å¤§å°ä¸º 0 æ—¶ï¼Œä¸èƒ½åˆ›å»ºæ˜ å°„åŒºã€‚æ‰€ä»¥ï¼šç”¨äºæ˜ å°„çš„æ–‡ä»¶å¿…é¡»è¦æœ‰å®é™…å¤§å°ï¼ï¼<br>mmap ä½¿ç”¨æ—¶å¸¸å¸¸ä¼šå‡ºç°æ€»çº¿é”™è¯¯ï¼Œé€šå¸¸æ˜¯ç”±äºå…±äº«æ–‡ä»¶å­˜å‚¨ç©ºé—´å¤§å°å¼•èµ·çš„ã€‚å¦‚ï¼Œ400 å­—èŠ‚å¤§å°çš„æ–‡ä»¶ï¼Œåœ¨ç®€å†æ˜ å°„åŒºæ—¶ï¼Œoffset4096 å­—èŠ‚ï¼Œåˆ™ä¼šæŠ¥å‡ºæ€»çº¿é”™è¯¯</li><li>munmap ä¼ å…¥çš„åœ°å€ä¸€å®šæ˜¯ mmap è¿”å›çš„åœ°å€ã€‚åšå†³æœç»æŒ‡é’ˆ++æ“ä½œ</li><li>æ–‡ä»¶åç§»é‡å¿…é¡»ä¸º 4K çš„æ•´æ•°å€</li><li>mmap åˆ›å»ºæ˜ å°„åŒºå‡ºé”™æ¦‚ç‡éå¸¸é«˜ï¼Œä¸€å®šè¦æ£€æŸ¥è¿”å›å€¼ï¼Œç¡®ä¿æ˜ å°„åŒºå»ºç«‹æˆåŠŸå†è¿›è¡Œåç»­æ“ä½œ</li></ol><h3 id="example-5"><a href="#example-5" class="headerlink" title="example"></a>example</h3><p>æœ‰è¡€ç¼˜å…³ç³»çš„ä¸¤ä¸ªè¿›ç¨‹é—´é€šä¿¡çš„ä¾‹å­ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> fd = open(<span class="string">&quot;mm&quot;</span>, O_RDWR);</span><br><span class="line">    ftruncate(fd, <span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> *p = mmap(<span class="literal">NULL</span>, <span class="number">100</span>, PROT_READ|PROT_WRITE, MAP_SHARED, fd, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (p == MAP_FAILED) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;mmap error\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    close(fd);  <span class="comment">// æ˜ å°„åŒºå»ºç«‹å®Œæ¯•,å³å¯å…³é—­æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">char</span> str[<span class="number">100</span>] = <span class="string">&quot;asdfghjkl\0&quot;</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(p, str, <span class="built_in">strlen</span>(str)); <span class="comment">// å°†å†…å®¹å†™å…¥æŒ‡é’ˆåœ°å€ï¼è€Œä¸æ˜¯è®©æŒ‡é’ˆæŒ‡å‘å†…å®¹ï¼</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;child: %s \n&quot;</span>, p);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;parent: %s \n&quot;</span>, p);</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        munmap(p, <span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— è¡€ç¼˜å…³ç³»çš„è¿›ç¨‹é—´é€šä¿¡æ—¶ï¼Œåªéœ€è¦åˆ†åˆ«åšä¸¤æ¬¡ mmap å³å¯ã€‚</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><blockquote><ul><li><a href="https://xiaolincoding.com/os/4_process/process_commu.html">è¿›ç¨‹é€šä¿¡å¸¸ç”¨æ–¹å¼</a></li><li><a href="https://blog.csdn.net/xiajun07061225/article/details/8471777">è¿›ç¨‹é—´é€šä¿¡-å‘½åç®¡é“FIFO</a></li><li><a href="https://blog.51cto.com/momo462/1825852">linuxä¸‹ï¼Œpipeçš„å®¹é‡çš„è®¨è®ºä¸æŸ¥çœ‹</a></li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> è¿›ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-è¿›ç¨‹</title>
      <link href="/2022/04/25/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B/"/>
      <url>/2022/04/25/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B/</url>
      
        <content type="html"><![CDATA[<blockquote><p>ä¸‹é¢çš„å†…å®¹å¦‚æœæƒ³è¦æ·±å…¥ã€å…¨é¢åœ°äº†è§£ï¼Œè¿˜æ˜¯å»ºè®®çœ‹ä¹¦ã€‚ä¹¦ä¸Šè§£é‡Šå¾—æ›´å…¨é¢ï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰æ›´å¤šä¾‹å­æ–¹ä¾¿ç†è§£ï¼Œæ­¤åšå®¢åªæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘è‡ªå·±ç†è§£ä»¥åŠåç»­å›é¡¾ã€‚</p></blockquote><h2 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h2><p><strong>è¿›ç¨‹ç®¡ç†</strong>ã€å†…å­˜ç®¡ç†å’Œæ–‡ä»¶ç®¡ç†æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯è¿›ç¨‹å‘¢ï¼Ÿé¡¾åæ€ä¹‰ï¼Œ<strong>è¿›ç¨‹å°±æ˜¯è¿›å±•ä¸­çš„ç¨‹åºï¼Œæˆ–è€…è¯´è¿›ç¨‹æ˜¯æ‰§è¡Œä¸­çš„ç¨‹åº</strong>ã€‚é‚£ä¹ˆä»€ä¹ˆæ˜¯ç¨‹åºï¼Ÿç¨‹åºå°±æ˜¯ä¸€æ®µæœºå™¨æŒ‡ä»¤ï¼Œå®ƒè§„å®šäº†è®¡ç®—æœºè¦åšå“ªäº›äº‹ã€‚</p><blockquote><p>è®¡ç®—æœºç¨‹åºçš„è¿è¡Œå®é™…ä¸Šæ˜¯ä¸€ä»¶ååˆ†å¤æ‚çš„äº‹æƒ…ï¼Œç‰µæ‰¯åˆ°æ–¹æ–¹é¢é¢ã€‚</p><p>é¦–å…ˆï¼Œå½“ç„¶å¾—è¿›è¡Œç¼–ç¨‹ï¼Œè€Œç¼–ç¨‹éœ€è¦è®¡ç®—æœºç¨‹åºè®¾è®¡è¯­è¨€ä½œä¸ºåŸºç¡€ã€‚å¯¹äºç»å¤§å¤šæ•°ç¼–å†™ç¨‹åºçš„äººæ¥è¯´ï¼Œä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ç§°ä¸º<strong>é«˜çº§ç¨‹åºè®¾è®¡è¯­è¨€</strong>ï¼Œå¦‚Cã€C++ã€Javaç­‰ã€‚ä½†ç”±äºè®¡ç®—æœºå¹¶ä¸è®¤è¯†é«˜çº§è¯­è¨€ç¼–å†™çš„ç¨‹åºï¼Œç¼–å¥½çš„ç¨‹åºéœ€è¦è¿›è¡Œç¼–è¯‘å˜æˆè®¡ç®—æœºèƒ½å¤Ÿè¯†åˆ«çš„æœºå™¨è¯­è¨€ç¨‹åºï¼Œè€Œè¿™<strong>éœ€è¦ç¼–è¯‘å™¨å’Œæ±‡ç¼–å™¨çš„å¸®åŠ©</strong>ã€‚å…¶æ¬¡ï¼Œæœºå™¨è¯­è¨€ç¨‹åºéœ€è¦<strong>åŠ è½½åˆ°å†…å­˜ï¼Œå½¢æˆä¸€ä¸ªè¿åŠ¨ä¸­çš„ç¨‹åºï¼Œå³è¿›ç¨‹</strong>ï¼Œè€Œè¿™éœ€è¦æ“ä½œç³»ç»Ÿçš„å¸®åŠ©ã€‚<strong>è¿›ç¨‹éœ€è¦åœ¨è®¡ç®—æœºèŠ¯ç‰‡CPUä¸Šæ‰§è¡Œæ‰ç®—æ˜¯çœŸæ­£åœ¨æ‰§è¡Œ</strong>ï¼Œè€Œå°†è¿›ç¨‹è°ƒåº¦åˆ°CPUä¸Šè¿è¡Œä¹Ÿç”±æ“ä½œç³»ç»Ÿå®Œæˆã€‚æœ€åï¼Œåœ¨CPUä¸Šæ‰§è¡Œçš„æœºå™¨è¯­è¨€æŒ‡ä»¤éœ€è¦å˜æˆèƒ½å¤Ÿåœ¨ä¸€ä¸ªä¸ªæ—¶é’Ÿè„‰å†²é‡Œæ‰§è¡Œçš„åŸºæœ¬æ“ä½œï¼Œè¿™<strong>éœ€è¦æŒ‡ä»¤é›†ç»“æ„å’Œè®¡ç®—æœºç¡¬ä»¶çš„æ”¯æŒ</strong>ï¼Œè€Œæ•´ä¸ªç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹è¿˜éœ€è¦æ“ä½œç³»ç»Ÿæä¾›çš„æœåŠ¡å’Œç¨‹åºè¯­è¨€æä¾›çš„æ‰§è¡Œç¯å¢ƒï¼ˆruntime environmentï¼‰ã€‚è¿™æ ·ï¼Œä¸€ä¸ªä»ç¨‹åºåˆ°å¾®æŒ‡ä»¤æ‰§è¡Œçš„è¿‡ç¨‹å°±å®Œæˆäº†ã€‚</p></blockquote><p>ç®€å•è€Œè¨€ï¼Œä¸€ä¸ªè¿›ç¨‹çš„è¿è¡Œè¿‡ç¨‹ä¸ºï¼š<strong>ç¨‹åº</strong>ï¼ˆå³ç¡¬ç›˜ä¸Šçš„ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼‰ã€<strong>è¿è¡Œç¨‹åº</strong>ï¼ˆå°†ç¨‹åºä¸­å­˜å‚¨çš„æœºå™¨è¯­è¨€åŠ è½½åˆ°å†…å­˜ï¼Œå½¢æˆè¿›ç¨‹ï¼Œè®¡ç®—æœºä¸Šçš„å¤šä¸ªè¿›ç¨‹å®é™…ä¸Šå…±äº«äº†ç‰©ç†å†…å­˜ï¼Œå®¹æ˜“é€ æˆæ··ä¹±ï¼Œå› æ­¤ä½¿ç”¨äº†<strong>è™šæ‹Ÿå†…å­˜</strong>å¯¹è¿›ç¨‹çš„å†…å­˜åœ°å€ç©ºé—´è¿›è¡Œéš”ç¦»ï¼‰ã€<strong>åœ¨CPUä¸Šæ‰§è¡Œ</strong>ï¼ˆå¯¹å•æ ¸çš„CPUè€Œè¨€ï¼Œä»»æ„æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€æ¡æŒ‡ä»¤ï¼Œå› æ­¤CPUä¸Šä»»æ„æ—¶åˆ»åªèƒ½æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹ã€‚å¤šä¸ªè¿›ç¨‹é€šè¿‡â€œæ—¶åˆ†å¤ç”¨â€çš„æ–¹å¼å…±äº«CPUï¼Œä¹Ÿå°±æ˜¯<strong>è¿›ç¨‹è°ƒåº¦</strong>ï¼‰ã€‚</p><blockquote><p>å‘æ˜è¿›ç¨‹çš„æ ¹æœ¬åŠ¨æœºæ˜¯ä»€ä¹ˆï¼Ÿ</p><p>ç­”ï¼šæ˜¯ä¸ºäº†åœ¨è®¡ç®—æœºä¸ŠåŒæ—¶è¿è¡Œå¤šä¸ªç¨‹åºï¼Œæé«˜CPUçš„åˆ©ç”¨ç‡ã€‚</p></blockquote><h3 id="ç¨‹åº"><a href="#ç¨‹åº" class="headerlink" title="ç¨‹åº"></a>ç¨‹åº</h3><p>ç¨‹åºæ˜¯åŒ…å«äº†ä¸€ç³»åˆ—ä¿¡æ¯çš„æ–‡ä»¶ï¼Œè¿™äº›ä¿¡æ¯æè¿°äº†å¦‚ä½•åœ¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼Œæ‰€åŒ…æ‹¬çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>äºŒè¿›åˆ¶æ ¼å¼æ ‡è¯†ï¼šæ¯ä¸ªç¨‹åºæ–‡ä»¶éƒ½åŒ…å«ç”¨äºæè¿°å¯æ‰§è¡Œæ–‡ä»¶æ ¼å¼çš„å…ƒä¿¡æ¯ï¼Œç°åœ¨ï¼Œå¤§å¤šæ•° UNIX å®ç°ï¼ˆåŒ…æ‹¬ Linuxï¼‰é‡‡ç”¨å¯æ‰§è¡Œè¿æ¥æ ¼å¼ï¼ˆELFï¼‰ã€‚</li><li>æœºå™¨è¯­è¨€æŒ‡ä»¤ï¼šå¯¹ç¨‹åºç®—æ³•è¿›è¡Œç¼–ç ã€‚</li><li><strong>ç¨‹åºå…¥å£åœ°å€</strong>ï¼šæ ‡è¯†ç¨‹åºå¼€å§‹æ‰§è¡Œæ—¶çš„èµ·å§‹æŒ‡ä»¤ä½ç½®ã€‚</li><li>æ•°æ®ï¼šç¨‹åºæ–‡ä»¶åŒ…å«çš„<strong>å˜é‡åˆå§‹å€¼</strong>å’Œç¨‹åºä½¿ç”¨çš„<strong>å­—é¢å¸¸é‡</strong><code>literal constant</code>å€¼ï¼Œæ¯”å¦‚å­—ç¬¦ä¸²ã€‚</li><li><strong>ç¬¦å·è¡¨</strong>åŠé‡å®šä½è¡¨ï¼šæè¿°ç¨‹åºä¸­å‡½æ•°å’Œå˜é‡çš„ä½ç½®åŠåç§°ã€‚è¿™äº›è¡¨æ ¼æœ‰å¤šç§ç”¨é€”ï¼Œå…¶ä¸­åŒ…æ‹¬<strong>è°ƒè¯•å’Œè¿è¡Œæ—¶çš„ç¬¦å·è§£æ</strong>ï¼ˆåŠ¨æ€é“¾æ¥ï¼‰ã€‚</li><li><strong>å…±äº«åº“å’ŒåŠ¨æ€é“¾æ¥ä¿¡æ¯</strong>ï¼šç¨‹åºæ–‡ä»¶æ‰€åŒ…å«çš„ä¸€äº›å­—æ®µï¼Œåˆ—å‡ºäº†ç¨‹åºè¿è¡Œæ—¶éœ€è¦ä½¿ç”¨çš„å…±äº«åº“ï¼Œä»¥åŠåŠ è½½å…±äº«åº“çš„åŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„åã€‚</li><li>å…¶ä»–ä¿¡æ¯ï¼šç¨‹åºæ–‡ä»¶è¿˜åŒ…å«è®¸å¤šå…¶ä»–ä¿¡æ¯ï¼Œç”¨ä»¥æè¿°å¦‚ä½•åˆ›å»ºè¿›ç¨‹ã€‚</li></ul><p>å¯ä»¥ç”¨ä¸€ä¸ªç¨‹åºæ¥åˆ›å»ºè®¸å¤šè¿›ç¨‹ï¼Œæˆ–è€…åè¿‡æ¥è¯´ï¼Œè®¸å¤šè¿›ç¨‹è¿è¡Œçš„å¯ä»¥æ˜¯åŒä¸€ç¨‹åºã€‚</p><h3 id="è™šæ‹Ÿå†…å­˜"><a href="#è™šæ‹Ÿå†…å­˜" class="headerlink" title="è™šæ‹Ÿå†…å­˜"></a>è™šæ‹Ÿå†…å­˜</h3><p>åœ¨æ²¡æœ‰è™šæ‹Ÿå†…å­˜çš„æƒ…å†µä¸‹ï¼Œå„ä¸ªç¨‹åºï¼ˆè¿›ç¨‹ï¼‰éƒ½ç›´æ¥å¯¹ç‰©ç†å†…å­˜åœ°å€è¿›è¡Œæ“ä½œï¼Œè¿™æ ·å¯èƒ½ä¼šå‡ºç°å¤šä¸ªè¿›ç¨‹ä¿®æ”¹åŒä¸€ä¸ªå†…å­˜åœ°å€çš„æƒ…å†µï¼Œå¯¼è‡´æ•°æ®æ··ä¹±ï¼Œç¨‹åºå´©æºƒã€‚è€Œè§£å†³è¿™ä¸ªé—®é¢˜çš„åŠæ³•å°±æ˜¯è®©è¿›ç¨‹ä½¿ç”¨è™šæ‹Ÿå†…å­˜åœ°å€ï¼Œç„¶åå†é€šè¿‡<strong>é¡µè¡¨</strong>å°†è™šæ‹Ÿå†…å­˜è½¬æ¢ä¸ºç‰©ç†å†…å­˜åœ°å€ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†æ¨¡å—å°±ä¿è¯äº†ä¸¤ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åœ°å€ä¸ä¼šæ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†å†…å­˜åœ°å€ä¸Šã€‚</p><p>å…³äºè™šæ‹Ÿå†…å­˜çš„å…·ä½“ä¿¡æ¯å¯ä»¥çœ‹ï¼š<a href="https://xiaolincoding.com/os/3_memory/vmem.html#%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98">è™šæ‹Ÿå†…å­˜</a>ã€‚</p><p><strong>é¡µå¼å­˜å‚¨ç®¡ç†</strong>æ˜¯ä¸€ç§å¸¸è§è€Œé«˜æ•ˆçš„æ–¹å¼ï¼Œæ“ä½œç³»ç»Ÿå°†å†…å­˜ç©ºé—´åˆ†ä¸ºè‹¥å¹²ä¸ªå›ºå®šå¤§å°çš„é¡µï¼Œå¹¶ç»´æŠ¤è™šæ‹Ÿé¡µåœ°å€å’Œç‰©ç†é¡µåœ°å€çš„æ˜ å°„å…³ç³»ï¼ˆå³é¡µè¡¨ï¼‰ã€‚é¡µå¤§å°æ¶‰åŠé¡µåˆ†é…çš„ç²’åº¦å’Œé¡µè¡¨æ‰€å ç©ºé—´ï¼Œç›®å‰çš„æ“ä½œç³»ç»Ÿå¸¸ç”¨<code>4KB</code>çš„é¡µã€‚æ­¤æ—¶ï¼Œ<strong>è™šæ‹Ÿå†…å­˜åœ°å€å¯è¡¨ç¤ºä¸ºè™šæ‹Ÿé¡µåœ°å€å’Œé¡µå†…åç§»ä¸¤éƒ¨åˆ†</strong>ï¼Œåœ¨è¿›è¡Œåœ°å€è½¬æ¢æ—¶<strong>é€šè¿‡æŸ¥è¡¨çš„æ–¹å¼</strong>å°†è™šæ‹Ÿé¡µåœ°å€æ›¿æ¢ä¸ºç‰©ç†é¡µåœ°å€å°±å¯å¾—åˆ°å¯¹åº”çš„ç‰©ç†å†…å­˜åœ°å€ã€‚</p><p>ä»»ä¸€æ—¶åˆ»ï¼Œæ¯ä¸ªç¨‹åºä»…æœ‰éƒ¨åˆ†é¡µéœ€è¦é©»ç•™åœ¨ç‰©ç†å†…å­˜é¡µå¸§ä¸­ã€‚è¿™äº›é¡µæ„æˆäº†æ‰€è°“é©»ç•™é›†ã€‚ç¨‹åºæœªä½¿ç”¨çš„æ‹·è´ä¿å­˜åœ¨äº¤æ¢åŒºå†…â€”â€”è¿™æ˜¯ç£ç›˜ç©ºé—´ä¸­çš„ä¿ç•™åŒºåŸŸï¼Œä½œä¸ºè®¡ç®—æœº RAM çš„è¡¥å……ï¼Œä»…åœ¨éœ€è¦æ—¶æ‰ä¼šè½½å…¥ç‰©ç†å†…å­˜ã€‚è‹¥è¿›ç¨‹æ¬²è®¿é—®çš„é¡µé¢ç›®å‰å¹¶æœªé©»ç•™åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œå°†ä¼šå‘ç”Ÿé¡µé¢é”™è¯¯ï¼Œå†…æ ¸å³åˆ»æŒ‚èµ·è¯¥è¿›ç¨‹çš„æ‰§è¡Œï¼ŒåŒæ—¶ä»ç£ç›˜ä¸­å°†è¯¥é¡µé¢è½½å…¥å†…å­˜ã€‚</p><blockquote><p>å¤§å¤šæ•°ç¨‹åºéƒ½å±•ç°äº†ä¸¤ç§ç±»å‹çš„å±€éƒ¨æ€§ã€‚</p><ul><li><strong>ç©ºé—´å±€éƒ¨æ€§</strong>ï¼šæ˜¯æŒ‡ç¨‹åºå€¾å‘äºè®¿é—®åœ¨æœ€è¿‘è®¿é—®è¿‡çš„å†…å­˜åœ°å€é™„è¿‘çš„å†…å­˜ï¼ˆç”±äºæŒ‡ä»¤æ˜¯é¡ºåºæ‰§è¡Œçš„ï¼Œä¸”æœ‰æ—¶ä¼šæŒ‰é¡ºåºå¤„ç†æ•°æ®ç»“æ„ï¼‰ã€‚</li><li><strong>æ—¶é—´å±€éƒ¨æ€§</strong>ï¼šæ˜¯æŒ‡ç¨‹åºå€¾å‘äºåœ¨ä¸ä¹…çš„å°†æ¥å†æ¬¡è®¿é—®æœ€è¿‘åˆšè®¿é—®è¿‡çš„å†…å­˜åœ°å€ï¼ˆç”±äºå¾ªç¯ï¼‰ã€‚</li></ul></blockquote><p>åœ¨ 32 ä½ç³»ç»Ÿä¸­ï¼Œé‡‡ç”¨<code>4KB</code>é¡µæ—¶ï¼Œå•ä¸ªå®Œæ•´é¡µè¡¨éœ€è¦<code>1M</code>é¡¹ï¼Œå¯¹æ¯ä¸ªè¿›ç¨‹ç»´æŠ¤é¡µè¡¨éœ€è¦ç›¸å½“å¯è§‚çš„ç©ºé—´ä»£ä»·ï¼Œè€Œ<code>CPU Cache</code>ä¸€èˆ¬åªæœ‰æ•°å<code>M</code>ï¼Œå› æ­¤é¡µè¡¨åªèƒ½æ”¾åœ¨å†…å­˜ä¸­ã€‚è‹¥æ¯æ¬¡è¿›è¡Œåœ°å€è½¬æ¢æ—¶éƒ½éœ€è¦å…ˆæŸ¥è¯¢å†…å­˜ï¼Œåˆ™ä¼šå¯¹æ€§èƒ½äº§ç”Ÿæ˜æ˜¾çš„å½±å“ï¼ˆå†…å­˜çš„è®¿é—®é€Ÿåº¦è¿œä½äº<code>Cache</code>ï¼‰ã€‚ä¸ºäº†æé«˜é¡µè¡¨è®¿é—®çš„é€Ÿåº¦ï¼Œç°ä»£å¤„ç†å™¨ä¸­é€šå¸¸åŒ…å«ä¸€ä¸ª<strong>è½¬æ¢åæ´ç¼“å†²å™¨</strong>ï¼ˆTranslation Lookaside Bufferï¼Œç®€ç§° <code>TLB</code>ï¼‰æ¥<strong>å®ç°å¿«é€Ÿçš„è™šå®åœ°å€è½¬æ¢</strong>ã€‚<code>TLB</code>ä¹Ÿç§°<strong>é¡µè¡¨ç¼“å­˜æˆ–å¿«è¡¨</strong>ï¼Œå€Ÿç”±<strong>å±€éƒ¨æ€§åŸç†</strong>ï¼Œå­˜å‚¨å½“å‰å¤„ç†å™¨ä¸­æœ€ç»å¸¸è®¿é—®é¡µçš„é¡µè¡¨ã€‚ä¸€èˆ¬ <code>TLB</code> è®¿é—®ä¸ <code>Cache</code> è®¿é—®åŒæ—¶è¿›è¡Œï¼Œè€Œ <code>TLB</code> ä¹Ÿå¯ä»¥è¢«è§†ä¸ºé¡µè¡¨çš„ <code>Cache</code> ã€‚</p><blockquote><p>å³ä½¿æ˜¯ä»å†…å­˜ä¸­æŸ¥æ‰¾é¡µè¡¨ï¼Œç¬¬ä¸€æ¬¡æ‰¾åˆ°åä¸å°±ä¼šå°†éƒ¨åˆ†é¡µè¡¨ä¿¡æ¯è¯»å…¥<code>Cache</code>äº†å—ï¼Ÿåç»­çš„è®¿é—®åº”è¯¥ä¹Ÿå¾ˆå¿«ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¸“é—¨çš„<code>TLB</code>æ¨¡å—ï¼Ÿ</p><p>çŒœæµ‹ï¼š<code>Cache</code> ä¸­è¿˜å­˜å‚¨äº†è®¸å¤šè¿›ç¨‹çš„ç¨‹åºæŒ‡ä»¤ã€æ•°æ®ç­‰ä¿¡æ¯ï¼Œå› æ­¤ <code>Cache</code> ä¼šé¢‘ç¹åœ°åˆ·æ–°æ•°æ®ã€‚è€Œé¡µè¡¨ä¿¡æ¯ä¼šéå¸¸é«˜é¢‘åœ°è¿›è¡Œè®¿é—®ï¼Œå¦‚æœåªç”¨ <code>Cache</code> ç¼“å­˜é¡µè¡¨ï¼Œä¼šå¯¼è‡´å¤§é‡çš„<code>Cache miss</code>ï¼Œä»è€Œå¸¦æ¥å¾ˆå¤§çš„æ€§èƒ½æŸè€—ã€‚è€Œ <code>TLB</code> åªå­˜å‚¨é¡µè¡¨ä¿¡æ¯ï¼Œç›¸å¯¹æ¥è¯´åˆ·æ–°é¢‘ç‡æ²¡æœ‰ <code>Cache</code> é‚£ä¹ˆé«˜ï¼Œä¹Ÿå°±æ˜¯å‘½ä¸­ç‡æ›´é«˜ï¼Œå› æ­¤ç›¸å¯¹æ¥è¯´æ›´å¥½ã€æ›´å¿«ã€‚</p><hr><p>å‡è®¾å˜é‡ a åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€ä¸º 0x1000ï¼Œç°åœ¨éœ€è¦å¯¹å®ƒ +1ï¼ŒCPUçš„æµç¨‹æ˜¯åœ¨TLBä¸­æŸ¥è¯¢0x1000å¯¹åº”çš„ç‰©ç†å†…å­˜åœ°å€ï¼Œæ‰¾åˆ°äº†0x20000ï¼Œå†æŸ¥æ‰¾L1 cache æ˜¯å¦æœ‰è¿™ä¸ªåœ°å€çš„æ•°æ®ï¼Œå¦‚æœæœ‰å°±ç›´æ¥ä¿®æ”¹ï¼Œç„¶åå†™å›ç‰©ç†å†…å­˜ï¼Ÿ</p><p>chatgpt: æ˜¯çš„ï¼Œåœ¨è¿›ç¨‹è®¿é—®è™šæ‹Ÿå†…å­˜æ—¶ï¼ŒCPU çš„æµç¨‹é€šå¸¸æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>CPU ä¼šå…ˆåœ¨ TLB ä¸­æŸ¥æ‰¾è™šæ‹Ÿåœ°å€ 0x1000 å¯¹åº”çš„ç‰©ç†åœ°å€ã€‚å¦‚æœ TLB ä¸­æœ‰è¿™ä¸ªåœ°å€çš„ä¿¡æ¯ï¼Œå°±ä¼šç›´æ¥ä½¿ç”¨ TLB ä¸­çš„ä¿¡æ¯ã€‚</li><li>å¦‚æœ TLB ä¸­æ²¡æœ‰è¿™ä¸ªåœ°å€çš„ä¿¡æ¯ï¼Œå°±ä¼šä»å†…å­˜ä¸­è¯»å–é¡µè¡¨ä¿¡æ¯ï¼Œå¹¶å°†è¯»å–çš„ä¿¡æ¯å­˜å‚¨åˆ° TLB ä¸­ï¼Œä¾›ä»¥åä½¿ç”¨ã€‚</li><li>ç„¶å CPU ä¼šæ£€æŸ¥ L1 cache æ˜¯å¦æœ‰ç‰©ç†åœ°å€ 0x20000 çš„æ•°æ®ã€‚å¦‚æœæœ‰ï¼Œå°±ç›´æ¥ä½¿ç”¨ L1 cache ä¸­çš„æ•°æ®ã€‚</li><li>å¦‚æœ L1 cache ä¸­æ²¡æœ‰è¿™ä¸ªåœ°å€çš„æ•°æ®ï¼Œå°±ä¼šç»§ç»­æ£€æŸ¥ L2 cache å’Œ L3 cache æ˜¯å¦æœ‰è¿™ä¸ªåœ°å€çš„æ•°æ®ã€‚å¦‚æœæœ‰ï¼Œå°±ç›´æ¥ä½¿ç”¨ç¼“å­˜ä¸­çš„æ•°æ®ã€‚</li><li>å¦‚æœ L2 å’Œ L3 cache ä¸­ä¹Ÿæ²¡æœ‰è¿™ä¸ªåœ°å€çš„æ•°æ®ï¼Œå°±ä¼šä»ç‰©ç†å†…å­˜ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å°†è¯»å–çš„æ•°æ®å­˜å‚¨åˆ° L1 cache ä¸­ï¼Œä¾›ä»¥åä½¿ç”¨ã€‚</li><li>æœ€åï¼ŒCPU ä¼šå°†ä¿®æ”¹åçš„æ•°æ®å†™å›ç‰©ç†å†…å­˜ã€‚</li></ol><p>æ€»ä¹‹ï¼Œåœ¨è¿›ç¨‹è®¿é—®è™šæ‹Ÿå†…å­˜æ—¶ï¼ŒCPU ä¼šä¼˜å…ˆæŸ¥è¯¢ TLBï¼Œå¦‚æœ TLB ä¸­ä¸å­˜åœ¨ï¼Œå†æŸ¥è¯¢ cacheã€‚å¦‚æœ cache ä¸­ä¹Ÿä¸å­˜åœ¨ï¼Œæœ€åæ‰ä¼šåˆ°å†…å­˜ä¸­è¯»å–é¡µè¡¨ä¿¡æ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå°†é¡µè¡¨ä¿¡æ¯åŠ è½½åˆ° cache ä¸­ã€‚</p><hr><p>è™šæ‹Ÿå†…å­˜å¸¦æ¥äº†å“ªäº›ä¼˜ç‚¹ï¼Ÿ</p><p>ç­”ï¼šè™šæ‹Ÿå†…å­˜ç®¡ç†ä½¿è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸ç‰©ç†å†…å­˜åœ°å€ç©ºé—´éš”ç¦»å¼€æ¥ï¼Œä¼˜ç‚¹æœ‰ï¼š</p><ul><li>è¿›ç¨‹ä¸è¿›ç¨‹ã€è¿›ç¨‹ä¸å†…æ ¸<strong>ç›¸äº’éš”ç¦»</strong>ï¼Œæ‰€ä»¥ä¸€ä¸ªè¿›ç¨‹ä¸èƒ½è¯»å–æˆ–ä¿®æ”¹å¦ä¸€è¿›ç¨‹æˆ–å†…æ ¸çš„å†…å­˜ã€‚</li><li>é€‚å½“æƒ…å†µä¸‹ï¼Œä¸¤ä¸ªæˆ–è€…æ›´å¤šè¿›ç¨‹<strong>èƒ½å¤Ÿå…±äº«å†…å­˜</strong>ã€‚è¿™æ˜¯ç”±äºå†…æ ¸å¯ä»¥ä½¿ä¸åŒè¿›ç¨‹çš„é¡µè¡¨æ¡ç›®æŒ‡å‘ç›¸åŒçš„ RAM é¡µã€‚</li><li><strong>ä¾¿äºå®ç°å†…å­˜ä¿æŠ¤æœºåˆ¶</strong>ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥å¯¹é¡µè¡¨æ¡ç›®è¿›è¡Œæ ‡è®°ï¼Œä»¥è¡¨ç¤ºç›¸å…³é¡µé¢å†…å®¹æ˜¯å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œäº¦æˆ–æ˜¯è¿™äº›ä¿æŠ¤æªæ–½çš„ç»„åˆã€‚å¤šä¸ªè¿›ç¨‹å…±äº« RAM é¡µé¢æ—¶ï¼Œå…è®¸æ¯ä¸ªè¿›ç¨‹å¯¹å†…å­˜é‡‡å–ä¸åŒçš„ä¿æŠ¤æªæ–½ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä»¥åªè¯»æ–¹å¼è®¿é—®æŸé¡µé¢ï¼Œè€Œå¦ä¸€è¿›ç¨‹åˆ™ä»¥è¯»å†™æ–¹å¼è®¿é—®åŒä¸€é¡µé¢ã€‚</li><li>ç¨‹åºå‘˜å’Œç¼–è¯‘å™¨ã€é“¾æ¥å™¨ä¹‹ç±»çš„å·¥å…·æ— éœ€å…³æ³¨ç¨‹åºåœ¨ RAM ä¸­çš„ç‰©ç†å¸ƒå±€ã€‚</li><li>å› ä¸ºéœ€è¦é©»ç•™åœ¨å†…å­˜ä¸­çš„ä»…æ˜¯ç¨‹åºçš„ä¸€éƒ¨åˆ†ï¼Œæ‰€ä»¥<strong>ç¨‹åºçš„åŠ è½½å’Œè¿è¡Œéƒ½å¾ˆå¿«</strong>ã€‚è€Œä¸”ï¼Œä¸€ä¸ªè¿›ç¨‹æ‰€å ç”¨çš„å†…å­˜ï¼ˆå³è™šæ‹Ÿå†…å­˜å¤§å°ï¼‰<strong>èƒ½å¤Ÿè¶…å‡º RAM å®¹é‡</strong>ã€‚</li><li>ç”±äºæ¯ä¸ªè¿›ç¨‹ä½¿ç”¨çš„ RAM å‡å°‘äº†ï¼ŒRAM ä¸­åŒæ—¶å¯ä»¥<strong>å®¹çº³çš„è¿›ç¨‹æ•°é‡å°±å¢å¤š</strong>äº†ã€‚è¿›è€Œ<strong>æé«˜äº†CPUçš„åˆ©ç”¨ç‡</strong>ã€‚</li></ul></blockquote><h3 id="å†…å­˜å¸ƒå±€"><a href="#å†…å­˜å¸ƒå±€" class="headerlink" title="å†…å­˜å¸ƒå±€"></a>å†…å­˜å¸ƒå±€</h3><p>æ¯ä¸ªè¿›ç¨‹æ‰€åˆ†é…çš„<strong>è™šæ‹Ÿå†…å­˜</strong>ç”±å¾ˆå¤šéƒ¨åˆ†ç»„æˆï¼Œé€šå¸¸ç§°ä¹‹ä¸ºâ€œæ®µï¼ˆsegmentï¼‰â€ã€‚</p><blockquote><p><code>size</code>å‘½ä»¤å¯æ˜¾ç¤ºäºŒè¿›åˆ¶å¯æ‰§è¡Œæ–‡ä»¶çš„æ–‡æœ¬æ®µã€åˆå§‹åŒ–æ•°æ®æ®µã€éåˆå§‹åŒ–æ•°æ®æ®µ(<code>bss</code>)çš„æ®µå¤§å°ã€‚</p></blockquote><ul><li><p><strong>æ–‡æœ¬æ®µ</strong>ï¼šåŒ…å«äº†è¿›ç¨‹è¿è¡Œçš„ç¨‹åºæœºå™¨è¯­è¨€æŒ‡ä»¤ã€‚</p></li><li><p><strong>åˆå§‹åŒ–æ•°æ®æ®µ</strong>ï¼šåŒ…å«æ˜¾å¼åˆå§‹åŒ–çš„<strong>å…¨å±€å˜é‡å’Œé™æ€å˜é‡</strong>ã€‚å½“ç¨‹åºåŠ è½½åˆ°å†…å­˜æ—¶ï¼Œä»å¯æ‰§è¡Œæ–‡ä»¶ä¸­è¯»å–è¿™äº›å˜é‡çš„å€¼ã€‚</p></li><li><p><strong>æœªåˆå§‹åŒ–æ•°æ®æ®µ<code>BSS</code><strong>ï¼šåŒ…å«äº†</strong>æœªè¿›è¡Œæ˜¾å¼åˆå§‹åŒ–</strong>çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚ç¨‹åºå¯åŠ¨ä¹‹å‰ï¼Œç³»ç»Ÿå°†æœ¬æ®µå†…æ‰€æœ‰å†…å­˜åˆå§‹åŒ–ä¸º0ã€‚</p><blockquote><ol><li>BSS æ®µçš„å†…å­˜ä¼šè¢«åˆå§‹åŒ–ä¸º0ï¼Œä¹Ÿå°±æ„å‘³ç€æœªè¿›è¡Œæ˜¾å¼åˆå§‹åŒ–çš„<strong>å…¨å±€å˜é‡å’Œé™æ€å˜é‡</strong>çš„åˆå§‹å€¼ä¸º0ã€‚ä½†éœ€è¦æ³¨æ„ï¼Œæœªè¿›è¡Œæ˜¾å¼åˆå§‹åŒ–çš„<strong>å±€éƒ¨å˜é‡</strong>ï¼Œå¹¶ä¸åœ¨ BSS æ®µä¸­ï¼Œä¹Ÿä¸ä¼šè¢«åˆå§‹åŒ–ä¸º0ï¼</li><li>å°†ç»è¿‡åˆå§‹åŒ–çš„ä¸æœªç»åˆå§‹åŒ–å…¨å±€å˜é‡å’Œé™æ€å˜é‡åˆ†å¼€å­˜æ”¾ï¼Œå…¶ä¸»è¦åŸå› åœ¨äºç¨‹åºåœ¨ç£ç›˜ä¸Šå­˜å‚¨æ—¶ï¼Œæ²¡æœ‰å¿…è¦ä¸ºæœªç»åˆå§‹åŒ–çš„å˜é‡åˆ†é…å­˜å‚¨ç©ºé—´ã€‚ç›¸åï¼Œå¯æ‰§è¡Œæ–‡ä»¶åªéœ€è®°å½•æœªåˆå§‹åŒ–æ•°æ®æ®µçš„ä½ç½®åŠæ‰€éœ€å¤§å°ï¼Œç›´åˆ°è¿è¡Œæ—¶å†ç”±ç¨‹åºåŠ è½½å™¨æ¥åˆ†é…è¿™ä¸€ç©ºé—´ã€‚</li></ol></blockquote></li><li><p>æ ˆ<code>stack</code>ï¼šæ˜¯ä¸€ä¸ª<strong>åŠ¨æ€å¢é•¿å’Œæ”¶ç¼©</strong>çš„æ®µï¼Œç”±æ ˆå¸§ï¼ˆ<code>stack frames</code>ï¼‰ç»„æˆã€‚ç³»ç»Ÿä¼š<strong>ä¸ºæ¯ä¸ªå½“å‰è°ƒç”¨çš„å‡½æ•°åˆ†é…ä¸€ä¸ªæ ˆå¸§</strong>ã€‚æ ˆå¸§ä¸­å­˜å‚¨äº†å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼ˆæ‰€è°“è‡ªåŠ¨å˜é‡ï¼‰ã€å®å‚å’Œè¿”å›å€¼ã€‚æ­¤å¤–ï¼Œ<strong>ä¹Ÿå¯ä½¿ç”¨<code>alloca()</code>åœ¨æ ˆä¸ŠåŠ¨æ€åˆ†é…ç©ºé—´</strong>ã€‚</p></li><li><p>å †<code>heap</code>ï¼šæ˜¯å¯åœ¨è¿è¡Œæ—¶ï¼ˆä¸ºå˜é‡ï¼‰åŠ¨æ€<code>malloc()</code>è¿›è¡Œå†…å­˜åˆ†é…çš„ä¸€å—åŒºåŸŸã€‚å †é¡¶ç«¯ç§°ä½œ <code>program break</code>ã€‚</p></li></ul><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B/image-20220526222503936.png" alt="image-20220526222503936"></p><h3 id="å†…æ ¸æ€ä¸ç”¨æˆ·æ€"><a href="#å†…æ ¸æ€ä¸ç”¨æˆ·æ€" class="headerlink" title="å†…æ ¸æ€ä¸ç”¨æˆ·æ€"></a>å†…æ ¸æ€ä¸ç”¨æˆ·æ€</h3><p>å°±åƒä¸–ç•Œä¸Šçš„äººå¹¶ä¸å¹³ç­‰ä¸€æ ·ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„ç¨‹åºéƒ½æ˜¯å¹³ç­‰çš„ã€‚ä¸–ç•Œä¸Šæœ‰çš„äººå æœ‰èµ„æºå¤šï¼Œæœ‰çš„äººå æœ‰èµ„æºå°‘ï¼Œæœ‰çš„äººæ¥äº†ï¼Œåˆ«äººå¾—è®©å‡ºèµ„æºï¼Œæœ‰çš„äººåˆ™ä¸“é—¨ä¸ºåˆ«äººè®©å‡ºèµ„æºã€‚ç¨‹åºä¹Ÿæ˜¯è¿™æ ·çš„ï¼Œæœ‰çš„ç¨‹åºå¯ä»¥è®¿é—®è®¡ç®—æœºçš„ä»»ä½•èµ„æºï¼Œæœ‰çš„ç¨‹åºåˆ™åªèƒ½è®¿é—®å°‘é‡å—é™èµ„æºã€‚æ“ä½œç³»ç»Ÿä½œä¸ºè®¡ç®—æœºçš„ç®¡ç†è€…ï¼Œè‡ªç„¶ä¸èƒ½å’Œè¢«ç®¡ç†è€…äº«å—ä¸€æ ·çš„å¾…é‡ã€‚å®ƒåº”è¯¥äº«æœ‰æ›´å¤šçš„æ–¹ä¾¿æˆ–æƒé™ã€‚<strong>ä¸ºäº†åŒºåˆ†ä¸åŒçš„ç¨‹åºçš„ä¸åŒæƒé™</strong>ï¼Œäººä»¬å‘æ˜äº†å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„æ¦‚å¿µã€‚</p><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯å†…æ ¸æ€ï¼Œä»€ä¹ˆåˆæ˜¯ç”¨æˆ·æ€å‘¢ï¼Ÿåªè¦æƒ³ä¸€æƒ³ç°å®ç”Ÿæ´»ä¸­å¤„äºç¤¾ä¼šæ ¸å¿ƒçš„äººä¸å¤„äºç¤¾ä¼šè¾¹ç¼˜çš„äººæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå°±èƒ½æ˜ç™½å¤„äºæ ¸å¿ƒçš„äººæ‹¥æœ‰çš„èµ„æºå¤šï¼å› æ­¤ï¼Œ<strong>å†…æ ¸æ€å°±æ˜¯æ‹¥æœ‰èµ„æºå¤šçš„çŠ¶æ€ï¼Œæˆ–è€…è¯´è®¿é—®èµ„æºå¤šçš„çŠ¶æ€ï¼Œç§°ä¸ºç‰¹æƒæ€</strong>ã€‚ç›¸å¯¹æ¥è¯´ï¼Œ<strong>ç”¨æˆ·æ€å°±æ˜¯éç‰¹æƒæ€ï¼Œåœ¨æ­¤ç§çŠ¶æ€ä¸‹è®¿é—®çš„èµ„æºå°†å—åˆ°é™åˆ¶</strong>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¦è®¿é—®æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ•°æ®ç»“æ„ï¼Œå¦‚è¿›ç¨‹è¡¨ï¼Œåˆ™éœ€è¦åœ¨ç‰¹æƒæ€ä¸‹æ‰èƒ½åŠåˆ°ã€‚å¦‚æœè¦è®¿é—®ç”¨æˆ·ç¨‹åºé‡Œçš„æ•°æ®ï¼Œåˆ™åœ¨ç”¨æˆ·æ€å°±å¯ä»¥äº†ã€‚</p><p>è¿è¡Œåœ¨å†…æ ¸æ€çš„ç¨‹åºå¯ä»¥è®¿é—®çš„èµ„æºå¤šï¼Œä½†<strong>å¯é æ€§ã€å®‰å…¨æ€§è¦æ±‚é«˜ï¼Œç»´æŠ¤ç®¡ç†éƒ½è¾ƒå¤æ‚</strong>ï¼›</p><blockquote><p>é‚£ä¹ˆè®¡ç®—æœºæ˜¯å¦‚ä½•çŸ¥é“ç°åœ¨æ­£åœ¨è¿è½¬çš„ç¨‹åºæ˜¯å†…æ ¸æ€ç¨‹åºå‘¢ï¼Ÿæˆ–è€…è¯´å†…æ ¸æ€çš„æœ¬è´¨æ˜¯ï¼Ÿ</p><p>è€Œæ­£ç¡®åšå‡ºå†…æ ¸æ€æˆ–ç”¨æˆ·æ€çš„åˆ¤æ–­å¯¹ç³»ç»Ÿçš„æ­£ç¡®è¿è¡Œè‡³å…³é‡è¦ã€‚æ˜¾ç„¶åšå‡ºè¿™ç§åˆ¤æ–­éœ€è¦æŸç§æ ‡å¿—ã€‚<strong>è¿™ä¸ªæ ‡å¿—å°±æ˜¯å¤„ç†å™¨çš„ä¸€ä¸ªçŠ¶æ€ä½</strong>ã€‚è¿™ä¸ªçŠ¶æ€ä½æ˜¯CPUçŠ¶æ€å­—é‡Œé¢çš„ä¸€ä¸ªå­—ä½ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‰€è°“çš„ç”¨æˆ·æ€ã€å†…æ ¸æ€å®é™…ä¸Šæ˜¯å¤„ç†å™¨çš„ä¸€ç§çŠ¶æ€ï¼Œè€Œä¸æ˜¯ç¨‹åºçš„çŠ¶æ€</strong>ã€‚æˆ‘ä»¬é€šè¿‡è®¾ç½®è¯¥çŠ¶æ€å­—ï¼Œå¯ä»¥å°†CPUè®¾ç½®ä¸ºå†…æ ¸æ€ã€ç”¨æˆ·æ€æˆ–è€…å…¶ä»–çš„å­æ€ï¼ˆæœ‰çš„CPUæœ‰æ›´å¤šç§å­æ€ï¼‰ã€‚<strong>ä¸€ä¸ªç¨‹åºè¿è¡Œæ—¶ï¼ŒCPUæ˜¯ä»€ä¹ˆæ€ï¼Œè¿™ä¸ªç¨‹åºå°±è¿è¡Œåœ¨ä»€ä¹ˆæ€ã€‚</strong></p><hr><p>å‰é¢è¯´è¿‡ï¼Œå†…æ ¸æ€æ˜¯ç‰¹æƒæ€ï¼Œè€Œç”¨æˆ·æ€æ˜¯æ™®é€šæ€ã€‚ç‰¹æƒæ€ä¸‹è¿è¡Œçš„ç¨‹åºå¯ä»¥è®¿é—®ä»»ä½•èµ„æºï¼Œè€Œç”¨æˆ·æ€ä¸‹çš„è®¿é—®åˆ™å—åˆ°é™åˆ¶ã€‚é‚£ä¹ˆè¿™ç§é™åˆ¶æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p><p>æ˜¾ç„¶ï¼Œè¦é™åˆ¶ä¸€ä¸ªç¨‹åºå¯¹èµ„æºçš„è®¿é—®ï¼Œéœ€è¦å¯¹ç¨‹åºæ‰§è¡Œçš„æ¯ä¸€æ¡æŒ‡ä»¤è¿›è¡Œæ£€æŸ¥æ‰èƒ½å®Œæˆã€‚è€Œè¿™ç§æ£€æŸ¥å°±æ˜¯åœ°å€ç¿»è¯‘ã€‚ç¨‹åºå‘å‡ºçš„æ¯ä¸€æ¡æŒ‡ä»¤éƒ½è¦ç»è¿‡è¿™ä¸ªåœ°å€ç¿»è¯‘è¿‡ç¨‹ã€‚è€Œ<strong>é€šè¿‡å¯¹ç¿»è¯‘çš„æ§åˆ¶ï¼Œå°±å¯ä»¥é™åˆ¶ç¨‹åºå¯¹èµ„æºçš„è®¿é—®</strong>ã€‚ï¼ˆåœ°å€ç¿»è¯‘å°±æ˜¯å°†è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜åœ°å€ç¿»è¯‘ä¸ºç‰©ç†å†…å­˜åœ°å€ï¼Œé¡µè¡¨æŸ¥è¯¢çš„è¿‡ç¨‹ã€‚ï¼‰</p><p>ä¸ºäº†èµ‹äºˆå†…æ ¸æ€ç¨‹åºè®¿é—®æ‰€æœ‰èµ„æºçš„æƒé™ï¼Œ<strong>å½“ç³»ç»Ÿå¤„äºå†…æ ¸æ€æ—¶ï¼Œå†…æ ¸ç¨‹åºå¯ä»¥ç»•è¿‡å†…å­˜åœ°å€ç¿»è¯‘è€Œç›´æ¥æ‰§è¡Œç‰¹æƒæŒ‡ä»¤</strong>ï¼Œå¦‚åœæœºæŒ‡ä»¤ã€‚è¿™ç§ç»•è¿‡ç¿»è¯‘çš„åšæ³•çªç ´äº†ç³»ç»Ÿå¯¹èµ„æºçš„æ§åˆ¶ã€‚</p></blockquote><p>åœ¨ Linux æ“ä½œç³»ç»Ÿä¸­ï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´çš„å†…éƒ¨åˆè¢«åˆ†ä¸º<strong>å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</strong>ä¸¤éƒ¨åˆ†ï¼Œä¸åŒä½æ•°çš„ç³»ç»Ÿï¼Œåœ°å€ç©ºé—´çš„èŒƒå›´ä¹Ÿä¸åŒã€‚æ¯”å¦‚æœ€å¸¸è§çš„ 32 ä½å’Œ 64 ä½ç³»ç»Ÿï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B/3a6cb4e3f27241d3b09b4766bb0b1124.png" alt="3a6cb4e3f27241d3b09b4766bb0b1124"></p><blockquote><p>ä¸ºä»€ä¹ˆå†…å­˜åœ°å€ç©ºé—´è¢«åˆ†ä¸ºå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼Ÿå†…æ ¸ç©ºé—´ä¸ºä»€ä¹ˆæ˜¯å…±äº«çš„ï¼Ÿ</p><p>todoâ€¦.</p></blockquote><h3 id="è¿›ç¨‹çŠ¶æ€"><a href="#è¿›ç¨‹çŠ¶æ€" class="headerlink" title="è¿›ç¨‹çŠ¶æ€"></a>è¿›ç¨‹çŠ¶æ€</h3><p>è¿›ç¨‹çš„ä¸‰ç§å…¸å‹çŠ¶æ€ï¼š</p><ol><li>å°±ç»ªæ€ï¼šå·²ç»å…·å¤‡è¿è¡Œæ¡ä»¶ï¼Œä½äºè¿›ç¨‹çš„å°±ç»ªé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…è¿›ç¨‹è°ƒåº¦è¢«åˆ†é…CPUèµ„æºã€‚</li><li>è¿è¡Œæ€ï¼šå½“å‰å æ®CPUèµ„æºçš„è¿›ç¨‹çš„çŠ¶æ€ã€‚</li><li>é˜»å¡æ€ï¼šå¤„äºè¿è¡Œæ€çš„è¿›ç¨‹å› å‘å‡ºæŸç§èµ„æºè¯·æ±‚ï¼Œæ“ä½œç³»ç»Ÿå°†å…¶CPUèµ„æºå‰¥å¤ºï¼Œç­‰å¾…è¯·æ±‚çš„äº‹ä»¶æ»¡è¶³ï¼Œå†å˜æˆå°±ç»ªæ€ï¼ŒåŠ å…¥å°±ç»ªé˜Ÿåˆ—ã€‚</li></ol><p>è¿™é‡Œé˜è¿°çš„è¿›ç¨‹çš„3ç§å…¸å‹çŠ¶æ€å¹¶ä¸æ˜¯å”¯ä¸€çš„åˆ†ç±»æ–¹å¼ï¼Œäº‹å®ä¸Šï¼Œè®¸å¤šå•†ä¸šæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹çŠ¶æ€ä¸æ­¢ä¸‰ä¸ªã€‚</p><ul><li>åˆ›å»ºæ€ï¼šè¿›ç¨‹æ­£åœ¨è¢«åˆ›å»ºï¼Œæ“ä½œç³»ç»Ÿéœ€è¦ä¸ºå…¶åˆ†é…èµ„æºã€åˆå§‹åŒ–PCBã€‚</li><li>ç»ˆæ­¢æ€ï¼šè¿›ç¨‹æ­£åœ¨ä»ç³»ç»Ÿä¸­æ’¤é”€ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿä¼šå›æ”¶è¿›ç¨‹æ‹¥æœ‰çš„èµ„æºã€æ’¤é”€PCBã€‚</li></ul><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E8%BF%9B%E7%A8%8B/10-%E8%BF%9B%E7%A8%8B%E4%B8%83%E4%B8%AD%E7%8A%B6%E6%80%81.jpg" alt="ä¸ƒç§çŠ¶æ€å˜è¿"></p><blockquote><p><strong>é‚£ä¹ˆè¿›ç¨‹æŒ‚èµ·æœ‰å“ªäº›åŸå› å‘¢</strong>ï¼Ÿ</p><ol><li>é¦–å…ˆæ˜¯ä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œè¿‡ç¨‹ä¸­<strong>æ‰§è¡Œäº†æŸç§é˜»å¡æ“ä½œ</strong>ï¼Œå¦‚è¯»å†™ç£ç›˜ã€‚ç”±äºé˜»å¡æ“ä½œéœ€è¦ç­‰å¾…ç»“æœåæ‰èƒ½ç»§ç»­æ‰§è¡Œï¼Œå› æ­¤æ“ä½œç³»ç»Ÿå°†æŠŠè¿™ä¸ªè¿›ç¨‹æŒ‚èµ·ï¼Œè®©å…¶ä»–è¿›ç¨‹è¿è½¬ã€‚</li><li>å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ä¸€ä¸ª<strong>è¿›ç¨‹æ‰§è¡Œçš„æ—¶é—´å¤ªé•¿äº†</strong>ï¼Œä¸ºäº†å…¬å¹³ï¼Œæ“ä½œç³»ç»Ÿå°†å…¶æŒ‚èµ·ï¼Œè®©å…¶ä»–è¿›ç¨‹ä¹Ÿæœ‰æœºä¼šæ‰§è¡Œã€‚</li></ol></blockquote><h2 id="è¿›ç¨‹å¸¸ç”¨-API"><a href="#è¿›ç¨‹å¸¸ç”¨-API" class="headerlink" title="è¿›ç¨‹å¸¸ç”¨ API"></a>è¿›ç¨‹å¸¸ç”¨ API</h2><p>ä»å†…æ ¸è§’åº¦çœ‹ï¼Œè¿›ç¨‹ç”±ç”¨æˆ·å†…å­˜ç©ºé—´ï¼ˆuser-space memoryï¼‰å’Œä¸€ç³»åˆ—å†…æ ¸æ•°æ®ç»“æ„ç»„æˆï¼Œå…¶ä¸­ç”¨æˆ·å†…å­˜ç©ºé—´åŒ…å«äº†ç¨‹åºä»£ç åŠä»£ç æ‰€ä½¿ç”¨çš„å˜é‡ï¼Œè€Œå†…æ ¸æ•°æ®ç»“æ„åˆ™ç”¨äºç»´æŠ¤è¿›ç¨‹çŠ¶æ€ä¿¡æ¯ã€‚è®°å½•åœ¨å†…æ ¸æ•°æ®ç»“æ„ä¸­çš„ä¿¡æ¯åŒ…æ‹¬è®¸å¤šä¸è¿›ç¨‹ç›¸å…³çš„æ ‡è¯†å·ï¼ˆIDsï¼‰ã€è™šæ‹Ÿå†…å­˜è¡¨ã€æ‰“å¼€æ–‡ä»¶çš„æè¿°ç¬¦è¡¨ã€ä¿¡å·ä¼ é€’åŠå¤„ç†çš„æœ‰å…³ä¿¡æ¯ã€è¿›ç¨‹èµ„æºä½¿ç”¨åŠé™åˆ¶ã€å½“å‰å·¥ä½œç›®å½•å’Œå¤§é‡çš„å…¶ä»–ä¿¡æ¯ã€‚</p><p>å¯¹è¿›ç¨‹çš„ç›¸å…³æ“ä½œå®é™…ä¸Šå°±æ˜¯æ“ä½œå†…æ ¸ä¸­è®°å½•è¿›ç¨‹ç›¸å…³ä¿¡æ¯çš„ç»“æ„ä½“ã€‚</p><h3 id="è¿›ç¨‹æ§åˆ¶å—"><a href="#è¿›ç¨‹æ§åˆ¶å—" class="headerlink" title="è¿›ç¨‹æ§åˆ¶å—"></a>è¿›ç¨‹æ§åˆ¶å—</h3><p>æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹æ˜¯<strong>èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½</strong>ï¼Œæ“ä½œç³»ç»Ÿå¯¹è¿›ç¨‹çš„ç®¡ç†é€šè¿‡<strong>è¿›ç¨‹è¡¨</strong>æ¥å®ç°ï¼Œè¿›ç¨‹è¡¨é‡Œå­˜æ”¾çš„æ˜¯å…³äºç³»ç»Ÿä¸Šæ‰€æœ‰è¿›ç¨‹çš„ä¸€åˆ‡ä¿¡æ¯ã€‚å®é™…ä¸Šï¼Œè¿›ç¨‹è¡¨å°±æ˜¯ä¸€ä¸ª<code>PCB</code>é“¾è¡¨ï¼Œ<strong>æ¯ä¸ªè¿›ç¨‹çš„ä¸€åˆ‡ä¿¡æ¯éƒ½è®°å½•åœ¨ä¸€ä¸ªè¿›ç¨‹æ§åˆ¶å—</strong><code>PCB</code>ä¸­ï¼ŒåŒ…æ‹¬è¿›ç¨‹çš„çŠ¶æ€ï¼Œè¿›ç¨‹çš„èµ„æºï¼Œè¿›ç¨‹çš„è¾“å…¥è¾“å‡ºç­‰ã€‚åœ¨ <code>linux</code> ä¸­ï¼Œ<code>PCB</code> çš„å®ç°æ˜¯ <code>task_struct</code> ç»“æ„ä½“ã€‚</p><p>å…·ä½“ä¿¡æ¯çœ‹æºç ï¼š<a href="https://elixir.bootlin.com/linux/v2.6.39/source/include/linux/sched.h#L1193">linux v2.6.39 task_struct</a>ï¼Œä¸‹é¢æ˜¯çœç•¥äº†å¤§éƒ¨åˆ†æˆå‘˜åçš„ç»“æ„ä½“ï¼Œ<a href="https://blog.csdn.net/qq_44836294/article/details/108637404">ç»“æ„ä½“è¯´æ˜</a>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* è¿›ç¨‹çŠ¶æ€ç›¸å…³ */</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> state;    <span class="comment">/* -1 unrunnable, 0 runnable, &gt;0 stopped */</span></span><br><span class="line">    <span class="type">void</span> *<span class="built_in">stack</span>;            <span class="comment">/* æŒ‡å‘å†…æ ¸æ ˆ */</span></span><br><span class="line">    <span class="type">int</span> exit_code;          <span class="comment">/* è¿›ç¨‹é€€å‡ºç  */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¿›ç¨‹äº²ç¼˜å…³ç³» */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tasks</span>;</span> <span class="comment">/* ç”¨äºåŠ å…¥è¿›ç¨‹è¡¨ */</span></span><br><span class="line">    <span class="type">pid_t</span> pid;  <span class="comment">/* è¿›ç¨‹å· */</span></span><br><span class="line">    <span class="type">pid_t</span> tgid; <span class="comment">/* çº¿ç¨‹ç»„ID */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">real_parent</span>;</span>    <span class="comment">/* æŒ‡å‘åˆ›å»ºå…¶çš„çˆ¶è¿›ç¨‹ï¼Œå¦‚æœå…¶çˆ¶è¿›ç¨‹ä¸å­˜åœ¨ï¼Œåˆ™æŒ‡å‘initè¿›ç¨‹ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">parent</span>;</span>         <span class="comment">/* æŒ‡å‘å½“å‰çš„çˆ¶è¿›ç¨‹ï¼Œé€šå¸¸ä¸real_parentä¸€è‡´ï¼Œæ¥æ”¶SIGCHLDä¿¡å· */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">children</span>;</span>          <span class="comment">/* å­è¿›ç¨‹é“¾è¡¨ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">sibling</span>;</span>           <span class="comment">/* å…„å¼Ÿè¿›ç¨‹é“¾è¡¨ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">group_leader</span>;</span>   <span class="comment">/* threadgroup leader */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pid_link</span> <span class="title">pids</span>[<span class="title">PIDTYPE_MAX</span>];</span>  <span class="comment">/* PID/PID hash table linkage. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¿›ç¨‹ä¸‹çš„çº¿ç¨‹ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">thread_group</span>;</span>  <span class="comment">/* çº¿ç¨‹é“¾è¡¨ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯ */</span></span><br><span class="line">    <span class="type">int</span> link_count, total_link_count;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> *<span class="title">fs</span>;</span>       <span class="comment">/* ç›®å½•ä¿¡æ¯ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span> <span class="comment">/* è¿›ç¨‹æ‰€æœ‰æ‰“å¼€çš„æ–‡ä»¶éƒ½ä¼šåœ¨è¿™é‡Œé¢çš„ä¸€ä¸ªæŒ‡é’ˆæ•°ç»„é‡Œï¼Œæ–‡ä»¶æè¿°ç¬¦å°±æ˜¯è¯¥æ•°ç»„çš„ä¸‹æ ‡ */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¿¡å·ç›¸å…³ä¿¡æ¯ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">signal_struct</span> *<span class="title">signal</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sighand_struct</span> *<span class="title">sighand</span>;</span></span><br><span class="line">    <span class="type">sigset_t</span> blocked, real_blocked;</span><br><span class="line">    <span class="type">sigset_t</span> saved_sigmask; <span class="comment">/* restored if set_restore_sigmask() was used */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigpending</span> <span class="title">pending</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¿›ç¨‹è°ƒåº¦ç›¸å…³ï¼Œä¼˜å…ˆçº§ */</span></span><br><span class="line">    <span class="type">int</span> prio, static_prio, normal_prio;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> rt_priority;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> <span class="title">se</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> <span class="title">rt</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> policy;            <span class="comment">/* è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥ SCHED_FIFO, SCHED_RR, SCHED_OTHER, etc */</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">/* and more */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>è¿›ç¨‹æ§åˆ¶å—çš„ä¸»è¦å†…å®¹æœ‰ï¼š</p><ul><li>èº«ä»½æ ‡è¯†ï¼ˆè¿›ç¨‹å·ï¼‰ï¼Œè¿›ç¨‹æ ‘ï¼ˆçˆ¶å­è¿›ç¨‹å…³ç³»ï¼‰ï¼›</li><li>è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼šå°±ç»ªã€è¿è¡Œã€é˜»å¡ç­‰ï¼›</li><li>è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥ï¼Œä¼˜å…ˆçº§ç­‰ï¼›</li><li>è¿›ç¨‹ä¸­å­˜åœ¨çš„çº¿ç¨‹ä¿¡æ¯ï¼›</li><li>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ï¼›</li><li>ä¿¡å·å¤„ç†ç›¸å…³ä¿¡æ¯ï¼›</li><li>è¿›ç¨‹çš„èµ„æºï¼šå†…å­˜ã€CPUã€IOã€ç£ç›˜ç­‰ï¼›</li><li>ç­‰ç­‰ã€‚</li></ul><h3 id="fork"><a href="#fork" class="headerlink" title="fork"></a>fork</h3><p>åŸºäºå½“å‰è¿›ç¨‹åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹ã€‚åœ¨æ“ä½œç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹æ˜¯èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œæ‰€ä»¥å­è¿›ç¨‹ä¹Ÿä¼šé‡æ–°åˆ†é…è¿›ç¨‹æ§åˆ¶å—<code>PCB</code>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œçˆ¶å­è¿›ç¨‹é—´å¾ˆå¤šä¸œè¥¿éƒ½æ˜¯ç‹¬äº«çš„ï¼›ä¸è¿‡å­è¿›ç¨‹æ˜¯å½“å‰è¿›ç¨‹çš„ä¸€ä¸ªâ€œåˆ†èº«â€ï¼Œæˆ–è€…è¯´<strong>å¤åˆ¶</strong>å“ï¼Œå› æ­¤å­è¿›ç¨‹çš„<code>PCB</code>ä¸çˆ¶è¿›ç¨‹çš„<code>PCB</code>æœ‰å¾ˆå¤š<strong>ç›¸åŒä¹‹å¤„</strong>ï¼Œæ¯”å¦‚ï¼šç¯å¢ƒå˜é‡ã€å…¨å±€å˜é‡ã€å®¿ä¸»ç›®å½•ä½ç½®ã€è¿›ç¨‹å·¥ä½œç›®å½•ä½ç½®ã€æ–‡ä»¶åˆ—è¡¨ã€ä¿¡å·å¤„ç†æ–¹å¼ã€æ–‡æœ¬æ®µã€å †ã€æ ˆã€‚</p><p>ä¸è¿‡çˆ¶å­è¿›ç¨‹ä»ç„¶å­˜åœ¨è¿›ç¨‹é—´çš„å†…å­˜éš”ç¦»ï¼Œå› æ­¤è¿™é‡Œè¯´çš„ç›¸åŒä»…ä»…æ˜¯å€¼ç›¸åŒï¼Œè€Œä¸”ä»…ä»…æ˜¯åˆšåˆ›å»ºè¿™ä¸€æ—¶åˆ»ï¼Œå› ä¸ºåç»­å­è¿›ç¨‹å¯ä»¥ä¿®æ”¹è¿™äº›ä¿¡æ¯ã€‚<strong>æˆ–è€…è¯´çˆ¶å­è¿›ç¨‹æ²¡æœ‰å†…å®¹æ˜¯â€œå…±äº«çš„â€</strong>æ›´æ°å½“ã€‚</p><p>å¯¹äºä¸€äº›è¿›ç¨‹èº«ä»½ä¿¡æ¯ç›¸å…³çš„å†…å®¹ï¼Œæ˜¾ç„¶<strong>çˆ¶å­è¿›ç¨‹æ˜¯ä¸åŒçš„</strong>ï¼ŒåŒ…æ‹¬ï¼šè¿›ç¨‹å·ã€çˆ¶è¿›ç¨‹å·ã€è¿›ç¨‹åˆ›å»ºæ—¶é—´ç­‰ã€‚</p><p>ä¸å¤Ÿç”±äºè¿›ç¨‹æ§åˆ¶å—<code>PCB</code>ç›¸å½“å¤§ï¼Œå¦‚æœåœ¨<code>fork</code>è¿‡ç¨‹ä¸­ï¼Œå®Œå…¨è¿›è¡Œå†…å­˜æ‹·è´ä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´ï¼Œå› æ­¤æŸäº›å†…å®¹é‡‡ç”¨äº†<strong>è¯»æ—¶å…±äº«ã€å†™æ—¶å¤åˆ¶</strong>çš„ç­–ç•¥ï¼Œå¦‚å…¨å±€å˜é‡ã€‚è€ŒæŸäº›å†…å®¹åˆ™ç›´æ¥é‡‡ç”¨<strong>å…±äº«</strong>çš„æ–¹å¼ï¼šæ–‡ä»¶æè¿°ç¬¦ã€<code>mmap</code>æ˜ å°„åŒºç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">fork</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example 1</span></span><br><span class="line"><span class="type">pid_t</span> pid = fork();</span><br><span class="line"><span class="keyword">if</span> (pid == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// child process</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// parent process</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example 2: å¾ªç¯åˆ›å»ºå­è¿›ç¨‹</span></span><br><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123; <span class="comment">// child process</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (i == <span class="number">5</span>)</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is parent process\n&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this is %dth child process\n&quot;</span>, i);</span><br></pre></td></tr></table></figure><ul><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼Œçˆ¶è¿›ç¨‹ä¸­è¿”å›å­è¿›ç¨‹çš„ <code>PID</code>ï¼Œå­è¿›ç¨‹è¿”å› <code>0</code>ã€‚</li><li>å¤±è´¥ï¼Œè¿”å› <code>-1</code>ï¼Œå¹¶è®¾ç½® <code>errno</code> ã€‚</li></ul></li></ul><blockquote><p><a href="https://elixir.bootlin.com/linux/v2.6.39/source/arch/x86/kernel/process.c#L235">ç³»ç»Ÿè°ƒç”¨ fork çš„æºç </a></p></blockquote><h3 id="getpid-x2F-getppid"><a href="#getpid-x2F-getppid" class="headerlink" title="getpid&#x2F;getppid"></a>getpid&#x2F;getppid</h3><blockquote><p><code>PID</code>æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œç”¨äºæ ‡è¯†ä¸€ä¸ªè¿›ç¨‹ï¼Œå°±åƒå­¦ç”Ÿçš„å­¦å·ä¸€æ ·ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œä¿å­˜åœ¨è¿›ç¨‹æ§åˆ¶å—çš„ <code>pid</code> å­—æ®µä¸­ã€‚ä¸€èˆ¬çš„ï¼Œåœ¨ç³»ç»Ÿè¿è¡ŒæœŸé—´ï¼Œ<code>PID</code> éƒ½æ˜¯è¢«é¡ºåºç¼–å·ï¼Œæ¯”å¦‚è¿›ç¨‹Açš„<code>PID</code>ä¸º<code>10</code>ï¼Œé‚£ä¸‹ä¸ªåˆ›å»ºçš„è¿›ç¨‹çš„<code>PID</code>åˆ™ä¸º<code>11</code>ã€‚ä¸è¿‡<code>PID</code>çš„å€¼æœ‰ä¸€ä¸ªä¸Šé™ï¼Œå½“å†…æ ¸ä½¿ç”¨çš„PIDè¾¾åˆ°è¿™ä¸ªä¸Šé™åå°±ä¼šå¾ªç¯å¼€å§‹æ‰¾å·²é—²ç½®çš„å°<code>PID</code>å·ã€‚</p></blockquote><p>è·å–å½“å‰è¿›ç¨‹çš„ <code>PID</code> å’Œçˆ¶è¿›ç¨‹çš„ <code>PID</code>ã€‚ä½¿ç”¨<code>pstree</code>å‘½ä»¤å¯æŸ¥çœ‹åˆ°è¿™ä¸€â€œå®¶æ—æ ‘â€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpid</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getppid</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><ul><li>è¿”å›å€¼ï¼š<ul><li>æˆåŠŸï¼Œè¿”å› <code>PID</code>ã€‚</li><li>å¤±è´¥ï¼Œè¿™äº›å‡½æ•°æ€»æ˜¯æˆåŠŸçš„ï¼</li></ul></li></ul><p><a href="https://elixir.bootlin.com/linux/v2.6.39/source/kernel/timer.c#L1356">getpid çš„æºç </a>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* kernel/timer.c:1353 */</span></span><br><span class="line">SYSCALL_DEFINE0(getpid)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> task_tgid_vnr(current);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* include/linux/sched.h:1600 */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">pid_t</span> <span class="title function_">task_tgid_vnr</span><span class="params">(<span class="keyword">struct</span> task_struct *tsk)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> pid_vnr(task_tgid(tsk));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>getpid()</code>å‡½æ•°è¿”å›çš„å€¼å…¶å®æ˜¯å½“å‰è¿›ç¨‹çš„<code>tgid</code>è€Œä¸æ˜¯<code>pid</code>çš„å€¼ï¼Œè€Œç”±äºçº¿ç¨‹ç»„ä¸­é¢†å¤´çº¿ç¨‹<code>tgid</code>å’Œ<code>pid</code>ç›¸åŒï¼Œå› è€Œ<code>getpid()</code>å¯¹è¿™ç±»è¿›ç¨‹æ‰€èµ·åˆ°çš„ä½œç”¨å’Œä¸€èˆ¬è¿›ç¨‹æ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><h3 id="wait-x2F-waitpid"><a href="#wait-x2F-waitpid" class="headerlink" title="wait&#x2F;waitpid"></a>wait&#x2F;waitpid</h3><p><strong>å›æ”¶å­è¿›ç¨‹</strong>ï¼</p><blockquote><p>ä¸ºä»€ä¹ˆè¦å›æ”¶è¿›ç¨‹ï¼Ÿ</p><p>æ­£å¦‚å‰é¢æ‰€è¿°ï¼Œæ¯ä¸ªè¿›ç¨‹è¢«åˆ†é…äº†ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ä½“â€”â€”è¿›ç¨‹æ§åˆ¶å—ï¼Œè¯¥ç»“æ„ä½“ä¼šå ç”¨ä¸å°‘çš„å†…å­˜ç©ºé—´ï¼Œå¦‚æœä¸å›æ”¶ï¼ˆé‡Šæ”¾è¯¥ç»“æ„ä½“ï¼‰ï¼Œé‚£è¿™äº›å†…å­˜å°±è¢«ç™½ç™½æµªè´¹äº†ã€‚æ­¤å¤–ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹å·ï¼Œå¦‚æœä¸å›æ”¶è¿›ç¨‹ï¼Œé‚£å®ƒæ‰€å ç”¨çš„è¿›ç¨‹å·å°±ä¸èƒ½è¢«å†æ¬¡åˆ©ç”¨ã€‚é•¿æ—¶é—´è¿è¡Œåï¼Œå¿…ç„¶ä¼šæœ‰æ–°è¿›ç¨‹ç”±äºæ— æ³•åˆ†é…åˆ°è¿›ç¨‹å·ï¼Œè€Œåˆ›å»ºå¤±è´¥ã€‚<br>å¦‚æœä¸å›æ”¶å­è¿›ç¨‹ï¼Œè¿™ç§å·²ç»ç»“æŸä½†æ²¡æœ‰è¢«å›æ”¶çš„å­è¿›ç¨‹ç§°ä¸º<strong>åƒµå°¸è¿›ç¨‹</strong>ã€‚</p><hr><p>é‚£æ“ä½œç³»ç»Ÿä¸ºä»€ä¹ˆä¸è‡ªåŠ¨å›æ”¶è¿›ç¨‹å‘¢ï¼Ÿ</p><p>æœ‰äº›æ—¶å€™ï¼Œçˆ¶è¿›ç¨‹å¸Œæœ›çŸ¥é“å­è¿›ç¨‹æ˜¯å¦‚ä½•ç»“æŸçš„ï¼ˆç”±äºå¼‚å¸¸é”™è¯¯ï¼Ÿè¿˜æ˜¯æ­£å¸¸é€€å‡ºï¼‰ï¼Œè€Œè¿›ç¨‹çš„é€€å‡ºçŠ¶æ€å°±è®°å½•åœ¨è¿›ç¨‹æ§åˆ¶å—çš„<code>exit_code</code>ä¸­ï¼Œçˆ¶è¿›ç¨‹é€šè¿‡å­è¿›ç¨‹çš„è¿›ç¨‹å·å°±å¯ä»¥è®¿é—®åˆ°å­è¿›ç¨‹çš„<code>PCB</code>ï¼Œè¿›è€Œè·çŸ¥å…¶ç»“æŸçš„åŸå› ã€‚</p></blockquote><ul><li><code>wait</code>ï¼š<strong>é˜»å¡ç­‰å¾…</strong>ä»»æ„ä¸€ä¸ªå­è¿›ç¨‹ç»“æŸï¼Œå¹¶å›æ”¶ã€‚å‚æ•°ä¸ºä¼ å‡ºå˜é‡ï¼Œå†™å…¥è¢«å›æ”¶çš„å­è¿›ç¨‹çš„ç»“æŸç ã€‚å¯è®¾ç½®ä¸º<code>NULL</code>ï¼Œè¡¨ç¤ºä¸æ¥æ”¶ã€‚</li><li><code>waitpid</code>ï¼šå›æ”¶æŒ‡å®š<code>pid</code>çš„å­è¿›ç¨‹ï¼Œå¯ä»¥è®¾ç½®æ˜¯å¦é˜»å¡ã€‚</li></ul><p>è¿™ä¸¤ç§ç³»ç»Ÿè°ƒç”¨æ¯æ¬¡åªèƒ½å›æ”¶ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¦‚æœçˆ¶è¿›ç¨‹éœ€è¦å›æ”¶å¤šä¸ªå­è¿›ç¨‹ï¼Œå¯ä»¥å¤šæ¬¡è°ƒç”¨ <code>wait</code> å‡½æ•°ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼šè¿›ç¨‹å›æ”¶åªèƒ½ç”±çˆ¶è¿›ç¨‹è°ƒç”¨è¯¥å‡½æ•°ï¼Œå…„å¼Ÿè¿›ç¨‹ä¹‹é—´æ— æ³•äº’ç›¸å›æ”¶ï¼Œå­è¿›ç¨‹ä¹Ÿæ— æ³•è¢«çˆ¶è¿›ç¨‹çš„çˆ¶è¿›ç¨‹å›æ”¶</strong>ï¼</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">wait</span><span class="params">(<span class="type">int</span> *wstatus)</span>;</span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">waitpid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">int</span> *wstatus, <span class="type">int</span> options)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* waitpid å›æ”¶å¤šä¸ªå­è¿›ç¨‹ */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (fork() == <span class="number">0</span>) &#123; <span class="comment">// child process</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">pid_t</span> wpid;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">5</span>) &#123; <span class="comment">/* çˆ¶è¿›ç¨‹æ‰§è¡Œ */</span></span><br><span class="line">        <span class="comment">// å½“å‰è¿›ç¨‹ä¸å­˜åœ¨å­è¿›ç¨‹æ—¶ä¼šè¿”å› -1</span></span><br><span class="line">        <span class="keyword">while</span>((wpid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, WNOHANG)) != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wpid &gt; <span class="number">0</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;wait child %d\n&quot;</span>, wpid);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                sleep(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;this is parent process\n&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">/* å­è¿›ç¨‹æ‰§è¡Œ */</span></span><br><span class="line">        sleep(i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;this is %dth child process\n&quot;</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>wstatus</code> ç”¨æ¥æ¥æ”¶å­è¿›ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ã€‚å¯è®¾ç½®ä¸ºNULLï¼Œè¡¨ç¤ºä¸æ¥æ”¶ã€‚</li><li><code>pid</code> å‚æ•°ï¼š<ul><li>å¦‚æœ <code>pid = 0</code>ï¼Œåˆ™ç­‰å¾…ä»»æ„åŒç»„çš„å­è¿›ç¨‹ç»ˆæ­¢ï¼›</li><li>å¦‚æœ <code>pid = -1</code>ï¼Œåˆ™ç­‰å¾…ä»»æ„å­è¿›ç¨‹ç»ˆæ­¢ï¼›</li><li>å¦‚æœ <code>pid &gt; 0</code>ï¼Œåˆ™ç­‰å¾…æŒ‡å®šçš„å­è¿›ç¨‹ç»ˆæ­¢ï¼›</li><li>å¦‚æœ <code>pid &lt; -1</code>ï¼Œåˆ™ç­‰å¾…ä»»æ„è¿›ç¨‹ç»„ id ä¸º abs(pid) çš„å­è¿›ç¨‹ç»ˆæ­¢ã€‚</li></ul></li><li><code>options</code> å‚æ•°ï¼š<ul><li><code>0</code>ï¼šé˜»å¡ç­‰å¾…ï¼›</li><li><code>WNOHANG</code>ï¼šå¦‚æœæ²¡æœ‰å­è¿›ç¨‹ç»ˆæ­¢ï¼Œåˆ™ç«‹å³è¿”å›ï¼Œä¸é˜»å¡çˆ¶è¿›ç¨‹ã€‚</li></ul></li><li>è¿”å›å€¼ï¼š<ul><li><code>&gt;0</code>ï¼ŒæˆåŠŸï¼Œè¿”å›å­è¿›ç¨‹çš„ <code>pid</code>ï¼›</li><li><code>0</code>ï¼Œè°ƒç”¨æ—¶æŒ‡å®šäº† <code>WNOHANG</code>ï¼Œå¹¶ä¸”æ²¡æœ‰å­è¿›ç¨‹ç»ˆæ­¢ï¼›</li><li><code>-1</code>ï¼Œå¤±è´¥ï¼Œå¹¶è®¾ç½® <code>errno</code>ã€‚<strong>å½“å‰è¿›ç¨‹ä¸å­˜åœ¨å­è¿›ç¨‹</strong>æˆ–<strong>å›æ”¶çš„è¿›ç¨‹Pä¸æ˜¯å½“å‰è¿›ç¨‹çš„å­è¿›ç¨‹</strong>æ—¶ä¼šè¿”å› <code>-1</code>ã€‚</li></ul></li></ul><blockquote><p><strong>å­¤å„¿è¿›ç¨‹</strong>ï¼šçˆ¶è¿›ç¨‹å…ˆäºå­è¿›ç»ˆæ­¢ï¼Œå­è¿›ç¨‹æ²¦ä¸ºâ€œå­¤å„¿è¿›ç¨‹â€ï¼Œä¼šè¢« <code>init</code> è¿›ç¨‹é¢†å…»ã€‚</p><p><strong>åƒµå°¸è¿›ç¨‹</strong>ï¼šå­è¿›ç¨‹ç»ˆæ­¢ï¼Œçˆ¶è¿›ç¨‹å°šæœªå¯¹å­è¿›ç¨‹è¿›è¡Œå›æ”¶ï¼Œåœ¨æ­¤æœŸé—´ï¼Œå­è¿›ç¨‹ä¸ºâ€œåƒµå°¸è¿›ç¨‹â€ã€‚ <code>kill</code><strong>å¯¹å…¶æ— æ•ˆ</strong>ã€‚<strong>æ¯ä¸ªè¿›ç¨‹ç»“æŸåéƒ½å¿…ç„¶ä¼šç»å†åƒµå°¸æ€</strong>ï¼Œæ—¶é—´é•¿çŸ­çš„å·®åˆ«è€Œå·²ã€‚å›æ”¶åƒµå°¸è¿›ç¨‹ï¼Œå¾— <code>kill</code> å®ƒçš„çˆ¶è¿›ç¨‹ï¼Œè®©å­¤å„¿é™¢å»å›æ”¶å®ƒã€‚</p><p><strong>æ€æ­»çˆ¶è¿›ç¨‹å¹¶ä¸ä¼šå¯¼è‡´å­è¿›ç¨‹æ­»äº¡</strong>ï¼Œåªæ˜¯å­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹ä¼šå˜ä¸º <code>init</code>ã€‚</p></blockquote><h3 id="exec-å‡½æ•°æ—"><a href="#exec-å‡½æ•°æ—" class="headerlink" title="exec å‡½æ•°æ—"></a>exec å‡½æ•°æ—</h3><p><code>fork</code> åˆ›å»ºå­è¿›ç¨‹åæ‰§è¡Œçš„æ˜¯å’Œçˆ¶è¿›ç¨‹ç›¸åŒçš„ç¨‹åºï¼Œä½†æœ‰å¯èƒ½æ‰§è¡Œä¸åŒçš„ä»£ç åˆ†æ”¯ï¼Œä¸è¿‡è¿™ç§æƒ…å†µå¹¶ä¸å¤šè§ï¼Œå› ä¸ºç”¨çº¿ç¨‹å¯ä»¥æ›´å¥½æ›´å¿«åœ°è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚å­è¿›ç¨‹å¾€å¾€è¦è°ƒç”¨ä¸€ç§ <code>exec</code> å‡½æ•°ä»¥æ‰§è¡Œå¦ä¸€ä¸ªç¨‹åºã€‚</p><p>å½“è¿›ç¨‹è°ƒç”¨ä¸€ç§ <code>exec</code> å‡½æ•°æ—¶ï¼Œè¯¥è¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´<strong>ä»£ç å’Œæ•°æ®å®Œå…¨è¢«æ–°ç¨‹åºæ›¿æ¢</strong>ï¼Œä»æ–°ç¨‹åºçš„å¯åŠ¨ä¾‹ç¨‹å¼€å§‹æ‰§è¡Œã€‚<strong>è°ƒç”¨ <code>exec</code> å¹¶ä¸åˆ›å»ºæ–°è¿›ç¨‹ï¼Œæ‰€ä»¥è°ƒç”¨ <code>exec</code> å‰åè¯¥è¿›ç¨‹çš„ <code>id</code> å¹¶æœªæ”¹å˜</strong>ã€‚</p><p><code>exec</code> å‡½æ•°ä¸€æ—¦è°ƒç”¨æˆåŠŸï¼Œå³æ‰§è¡Œæ–°çš„ç¨‹åºï¼Œ<strong>ä¸è¿”å›</strong>ã€‚åªæœ‰å¤±è´¥æ‰è¿”å›ï¼Œé”™è¯¯å€¼<code>-1</code>ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬ç›´æ¥åœ¨ <code>exec</code> å‡½æ•°è°ƒç”¨åç›´æ¥è°ƒç”¨ <code>perror()</code>ï¼Œå’Œ <code>exit()</code>ï¼Œæ— éœ€ <code>if</code> åˆ¤æ–­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">execl</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">                <span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execlp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">                <span class="comment">/* (char  *) NULL */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execle</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">const</span> <span class="type">char</span> *arg, ...</span></span><br><span class="line"><span class="params">                <span class="comment">/*, (char *) NULL, char *const envp[] */</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvp</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[])</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">execvpe</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">char</span> *<span class="type">const</span> argv[],</span></span><br><span class="line"><span class="params">                <span class="type">char</span> *<span class="type">const</span> envp[])</span>;</span><br></pre></td></tr></table></figure><ul><li><code>l</code> å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ã€‚</li><li><code>v</code> ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æ•°ç»„ã€‚</li><li><code>p</code> è¡¨ç¤ºè¦å€ŸåŠ©ç¯å¢ƒå˜é‡<code>PATH</code>æ¥åŠ è½½å¯æ‰§è¡Œæ–‡ä»¶ã€‚</li><li><code>e</code> ä½¿ç”¨ç¯å¢ƒå˜é‡æ•°ç»„ï¼Œä¸ç”¨è¿›ç¨‹åŸæœ‰çš„ç¯å¢ƒå˜é‡ï¼Œè®¾ç½®æ–°åŠ è½½ç¨‹åºè¿è¡Œçš„ç¯å¢ƒå˜é‡ã€‚</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">execl(<span class="string">&quot;/usr/bin/ls&quot;</span>, <span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, <span class="literal">NULL</span>); <span class="comment">// æŒ‡å®šç»å¯¹è·¯å¾„ï¼Œå‚æ•°åˆ—è¡¨ä»¥ NULL ç»“å°¾ã€‚</span></span><br><span class="line">execlp(<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, <span class="literal">NULL</span>); <span class="comment">// æŒ‡å®šç¨‹åºåï¼Œå‚æ•°åˆ—è¡¨ä»¥ NULL ç»“å°¾ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *argv[] = &#123;<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;-l&quot;</span>, <span class="string">&quot;/tmp&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">execv(<span class="string">&quot;/usr/bin/ls&quot;</span>, argv); <span class="comment">// æŒ‡å®šç»å¯¹è·¯å¾„ï¼Œå‚æ•°åˆ—è¡¨ä»¥ NULL ç»“å°¾ã€‚</span></span><br><span class="line">execvp(<span class="string">&quot;ls&quot;</span>, argv); <span class="comment">// æŒ‡å®šç¨‹åºåï¼Œå‚æ•°åˆ—è¡¨ä»¥ NULL ç»“å°¾ã€‚</span></span><br></pre></td></tr></table></figure><p>è¿™äº›å‡½æ•°éƒ½æ˜¯åº“å‡½æ•°ï¼Œéƒ½æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>execve</code>å®ç°çš„ã€‚</p><h3 id="vfork"><a href="#vfork" class="headerlink" title="vfork"></a>vfork</h3><p>åœ¨æ—©æœŸçš„ BSD å®ç°ä¸­ï¼Œ<code>fork()</code>ä¼šå¯¹çˆ¶è¿›ç¨‹çš„æ•°æ®æ®µã€å †å’Œæ ˆæ–½è¡Œä¸¥æ ¼çš„å¤åˆ¶ã€‚å¦‚å‰æ‰€è¿°ï¼Œè¿™æ˜¯ä¸€ç§æµªè´¹ï¼Œå°¤å…¶æ˜¯åœ¨è°ƒç”¨ <code>fork()</code>åç«‹å³æ‰§è¡Œ <code>exec()</code>çš„æƒ…å†µä¸‹ã€‚å‡ºäºè¿™ä¸€åŸå› ï¼ŒBSD çš„åæœŸç‰ˆæœ¬å¼•å…¥äº† <code>vfork()</code>ç³»ç»Ÿè°ƒç”¨ï¼Œå°½ç®¡å…¶è¿ä½œå«ä¹‰ç¨å¾®æœ‰äº›ä¸åŒï¼ˆå®åˆ™æœ‰äº›æ€ªå¼‚ï¼‰ï¼Œä½†æ•ˆç‡è¦è¿œé«˜äº BSD <code>fork()</code>ã€‚ç°ä»£ UNIX é‡‡ç”¨å†™æ—¶å¤åˆ¶æŠ€æœ¯æ¥å®ç° <code>fork()</code>ï¼Œå…¶æ•ˆç‡è¾ƒä¹‹äºæ—©æœŸçš„ <code>fork()</code>å®ç°è¦é«˜å‡ºè®¸å¤šï¼Œè¿›è€Œå°†å¯¹ <code>vfork()</code>çš„éœ€æ±‚å‰”é™¤æ®†å°½ã€‚è™½ç„¶å¦‚æ­¤ï¼ŒLinuxï¼ˆå¦‚åŒè®¸å¤šå…¶ä»–çš„ UNIX å®ç°ä¸€æ ·ï¼‰è¿˜æ˜¯æä¾›äº†å…·æœ‰ BSD è¯­ä¹‰çš„ <code>vfork()</code>ç³»ç»Ÿè°ƒç”¨ï¼Œä»¥æœŸä¸ºç¨‹åºæä¾›å°½å¯èƒ½å¿«çš„ <code>fork</code> åŠŸèƒ½ã€‚ä¸è¿‡ï¼Œé‰´äº <code>vfork()</code>çš„æ€ªå¼‚è¯­ä¹‰å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›éš¾ä»¥å¯Ÿè§‰çš„ç¨‹åºç¼ºé™·ï¼ˆbugï¼‰ï¼Œé™¤éèƒ½ç»™æ€§èƒ½å¸¦æ¥é‡å¤§æå‡ï¼ˆè¿™ç§æƒ…å†µå‘ç”Ÿçš„æ¦‚ç‡æå°ï¼‰ï¼Œå¦åˆ™<strong>åº”å½“å°½é‡é¿å…ä½¿ç”¨è¿™ä¸€è°ƒç”¨</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">vfork</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äº <code>fork()</code>ï¼Œ<code>vfork()</code>å¯ä»¥ä¸ºè°ƒç”¨è¿›ç¨‹åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹ã€‚ç„¶è€Œï¼Œ<code>vfork()</code>æ˜¯ä¸ºå­è¿›ç¨‹ç«‹å³æ‰§è¡Œ <code>exec()</code>çš„ç¨‹åºè€Œä¸“é—¨è®¾è®¡çš„ã€‚</p><p><code>vfork()</code>å› ä¸ºå¦‚ä¸‹ä¸¤ä¸ªç‰¹æ€§è€Œæ›´å…·æ•ˆç‡ï¼Œè¿™ä¹Ÿæ˜¯å…¶ä¸ <code>fork()</code>çš„åŒºåˆ«æ‰€åœ¨ã€‚</p><ul><li>æ— éœ€ä¸ºå­è¿›ç¨‹å¤åˆ¶è™šæ‹Ÿå†…å­˜é¡µæˆ–é¡µè¡¨ã€‚ç›¸åï¼Œ<strong>å­è¿›ç¨‹å…±äº«çˆ¶è¿›ç¨‹çš„å†…å­˜</strong>ï¼Œç›´è‡³å…¶æˆåŠŸæ‰§è¡Œäº† <code>exec()</code>æˆ–æ˜¯è°ƒç”¨<code>_exit()</code>é€€å‡ºã€‚</li><li>åœ¨å­è¿›ç¨‹è°ƒç”¨ <code>exec()</code>æˆ–<code>_exit()</code>ä¹‹å‰ï¼Œ<strong>å°†æš‚åœæ‰§è¡Œçˆ¶è¿›ç¨‹ã€‚</strong></li></ul><h2 id="è¿›ç¨‹ç»„ä¸ä¼šè¯"><a href="#è¿›ç¨‹ç»„ä¸ä¼šè¯" class="headerlink" title="è¿›ç¨‹ç»„ä¸ä¼šè¯"></a>è¿›ç¨‹ç»„ä¸ä¼šè¯</h2><p>è¿›ç¨‹ç»„å’Œä¼šè¯åœ¨è¿›ç¨‹ä¹‹é—´å½¢æˆäº†ä¸€ç§ä¸¤çº§å±‚æ¬¡å…³ç³»ï¼š<strong>è¿›ç¨‹ç»„æ˜¯ä¸€ç»„ç›¸å…³è¿›ç¨‹çš„é›†åˆï¼Œä¼šè¯æ˜¯ä¸€ç»„ç›¸å…³è¿›ç¨‹ç»„çš„é›†åˆ</strong>ã€‚</p><h3 id="è¿›ç¨‹ç»„"><a href="#è¿›ç¨‹ç»„" class="headerlink" title="è¿›ç¨‹ç»„"></a>è¿›ç¨‹ç»„</h3><p><strong>è¿›ç¨‹ç»„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªå…±äº«åŒä¸€è¿›ç¨‹ç»„æ ‡è¯†ç¬¦ï¼ˆ<code>PGID</code>ï¼‰çš„è¿›ç¨‹ç»„æˆ</strong>ã€‚è¿›ç¨‹ç»„ ID æ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå…¶ç±»å‹ä¸è¿›ç¨‹ ID ä¸€æ ·ï¼ˆpid_tï¼‰ã€‚ä¸€ä¸ªè¿›ç¨‹ç»„æ‹¥æœ‰ä¸€ä¸ªè¿›ç¨‹ç»„é¦–è¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹æ˜¯åˆ›å»ºè¯¥ç»„çš„è¿›ç¨‹ï¼Œå…¶è¿›ç¨‹ ID ä¸ºè¯¥è¿›ç¨‹ç»„çš„ IDï¼Œ<strong>æ–°è¿›ç¨‹ä¼šç»§æ‰¿å…¶çˆ¶è¿›ç¨‹æ‰€å±çš„è¿›ç¨‹ç»„ ID</strong>ã€‚</p><p><strong>è¿›ç¨‹ç»„</strong>æ‹¥æœ‰ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œå…¶å¼€å§‹æ—¶é—´ä¸ºé¦–è¿›ç¨‹åˆ›å»ºç»„çš„æ—¶åˆ»ï¼Œç»“æŸæ—¶é—´ä¸ºæœ€åä¸€ä¸ªæˆå‘˜è¿›ç¨‹é€€å‡ºç»„çš„æ—¶åˆ»ã€‚ä¸€ä¸ªè¿›ç¨‹å¯èƒ½ä¼šå› ä¸ºç»ˆæ­¢è€Œé€€å‡ºè¿›ç¨‹ç»„ï¼Œä¹Ÿå¯èƒ½ä¼šå› ä¸ºåŠ å…¥äº†å¦å¤–ä¸€ä¸ªè¿›ç¨‹ç»„è€Œé€€å‡ºè¿›ç¨‹ç»„ã€‚è¿›ç¨‹ç»„é¦–è¿›ç¨‹æ— éœ€æ˜¯æœ€åä¸€ä¸ªç¦»å¼€è¿›ç¨‹ç»„çš„æˆå‘˜ï¼ˆ<strong>å½“ä¸€ä¸ªè¿›ç¨‹ç»„çš„ç»„é•¿æ­»äº¡æ—¶ï¼Œåªè¦æœ‰å…¶ä»–è¿›ç¨‹å­˜åœ¨ï¼Œåˆ™è¯¥è¿›ç¨‹ç»„å­˜åœ¨ã€‚å¹¶ä¸”ç»„IDä»æ˜¯å·²æ•…çš„ç»„é•¿è¿›ç¨‹ID</strong>ï¼‰ã€‚<strong>ä¼šè¯ä¹Ÿç±»ä¼¼</strong>ã€‚</p><blockquote><p>è¿›ç¨‹ç»„æœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ</p><p>ä¸€ç§ç”¨å¤„ä¸ºï¼šå¯ä»¥é€šè¿‡ç»„ ID åŒæ—¶å‘è¯¥è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹å‘é€ä¿¡å·ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -9 -&#123;&#123;group_id&#125;&#125; <span class="comment"># ç»„IDå‰é¢è¦åŠ è´Ÿå·`-`ï¼Œå°±å¯ä»¥ç»™è¯¥è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰è¿›ç¨‹å‘é€ä¿¡å·</span></span><br></pre></td></tr></table></figure></blockquote><h4 id="getpgrp-x2F-getpgid"><a href="#getpgrp-x2F-getpgid" class="headerlink" title="getpgrp&#x2F;getpgid"></a>getpgrp&#x2F;getpgid</h4><p>è·å–ä¸€ä¸ªè¿›ç¨‹çš„è¿›ç¨‹ç»„IDã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpgid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;   <span class="comment">/* å¾ˆå°‘ä¼šæ£€ç´¢è°ƒç”¨è€…ä»¥å¤–çš„è¿›ç¨‹çš„ PGID */</span></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getpgrp</span><span class="params">(<span class="type">void</span>)</span>;        <span class="comment">/* POSIX.1 version é¦–é€‰æ–¹æ³• */</span></span><br></pre></td></tr></table></figure><p><code>getpgrp</code>å°±æ˜¯è¿”å›å½“å‰è°ƒç”¨è¿›ç¨‹æ‰€å±çš„è¿›ç¨‹ç»„IDï¼Œ<strong>é¦–é€‰æ–¹æ³•</strong>ã€‚</p><p><code>getpgid</code>å¯ä»¥è¿”å›æŒ‡å®šè¿›ç¨‹æ‰€å±çš„è¿›ç¨‹ç»„IDï¼Œå¦‚æœ<code>pid</code>ä¸º<code>0</code>ï¼Œå°±æ˜¯è¿”å›å½“å‰è°ƒç”¨è¿›ç¨‹æ‰€å±çš„è¿›ç¨‹ç»„IDã€‚</p><h4 id="setpgrp-x2F-setpgid"><a href="#setpgrp-x2F-setpgid" class="headerlink" title="setpgrp&#x2F;setpgid"></a>setpgrp&#x2F;setpgid</h4><p><code>setpgid()</code>ç³»ç»Ÿè°ƒç”¨å°†è¿›ç¨‹ ID ä¸º <code>pid</code> çš„è¿›ç¨‹çš„è¿›ç¨‹ç»„ ID ä¿®æ”¹ä¸º <code>pgid</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">setpgid</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">pid_t</span> pgid)</span>;  <span class="comment">/* é¦–é€‰æ–¹æ³• */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">setpgrp</span><span class="params">(<span class="type">void</span>)</span>;                   <span class="comment">/* System V version, ç›¸å½“äº setpgid(0, 0) */</span></span><br></pre></td></tr></table></figure><p>å¦‚æœ <code>pid</code> å’Œ <code>pgid</code> å‚æ•°æŒ‡å®šäº†åŒä¸€ä¸ªè¿›ç¨‹ï¼ˆ<code>pgid</code>ä¸º<code>0</code>æˆ–<code>pgid == pid</code>ï¼‰ï¼Œå°±ä¼š<strong>åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹ç»„</strong>ï¼Œå¹¶ä¸”æŒ‡å®šçš„è¿›ç¨‹ä¼šæˆä¸ºè¿™ä¸ªæ–°ç»„çš„é¦–è¿›ç¨‹ã€‚</p><p>å¦‚æœä¸¤ä¸ªå‚æ•°çš„å€¼ä¸åŒï¼Œåˆ™ä¼šå°†æŒ‡å®šè¿›ç¨‹ä»ä¸€ä¸ªè¿›ç¨‹ç»„ä¸­ç§»åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ç»„ä¸­ã€‚</p><p>åœ¨è°ƒç”¨<code>setpgid()</code>æ—¶å­˜åœ¨ä»¥ä¸‹é™åˆ¶ï¼š</p><ul><li><code>pid</code> å‚æ•°å¯ä»¥ä»…æŒ‡å®šè°ƒç”¨è¿›ç¨‹æˆ–å…¶ä¸­ä¸€ä¸ªå­è¿›ç¨‹ï¼›</li><li>åœ¨ç»„ä¹‹é—´ç§»åŠ¨è¿›ç¨‹æ—¶ï¼Œè°ƒç”¨è¿›ç¨‹ã€ç”± <code>pid</code> æŒ‡å®šçš„è¿›ç¨‹ä»¥åŠç›®æ ‡è¿›ç¨‹ç»„å¿…é¡»è¦å±äºåŒä¸€ä¸ªä¼šè¯ï¼›</li><li><code>pid</code> å‚æ•°æ‰€æŒ‡å®šçš„è¿›ç¨‹ä¸èƒ½æ˜¯ä¼šè¯é¦–è¿›ç¨‹ï¼›</li><li>ä¸€ä¸ªè¿›ç¨‹åœ¨å…¶å­è¿›ç¨‹å·²ç»æ‰§è¡Œ <code>exec()</code> åå°±æ— æ³•ä¿®æ”¹è¯¥å­è¿›ç¨‹çš„è¿›ç¨‹ç»„ ID äº†ã€‚</li></ul><h3 id="ä¼šè¯"><a href="#ä¼šè¯" class="headerlink" title="ä¼šè¯"></a>ä¼šè¯</h3><p><strong>ä¼šè¯æ˜¯ä¸€ç»„è¿›ç¨‹ç»„çš„é›†åˆ</strong>ã€‚è¿›ç¨‹çš„ä¼šè¯æˆå‘˜å…³ç³»æ˜¯ç”±å…¶ä¼šè¯æ ‡è¯†ç¬¦ï¼ˆ<code>SID</code>ï¼‰ç¡®å®šçš„ï¼Œä¼šè¯æ ‡è¯†ç¬¦ä¸è¿›ç¨‹ç»„ ID ä¸€æ ·ï¼Œæ˜¯ä¸€ä¸ªç±»å‹ä¸º <code>pid_t</code> çš„æ•°å­—ã€‚ä¼šè¯é¦–è¿›ç¨‹æ˜¯åˆ›å»ºè¯¥æ–°ä¼šè¯çš„è¿›ç¨‹ï¼Œå…¶è¿›ç¨‹ ID ä¼šæˆä¸ºä¼šè¯ IDã€‚<strong>æ–°è¿›ç¨‹ä¼šç»§æ‰¿å…¶çˆ¶è¿›ç¨‹çš„ä¼šè¯ ID</strong>ã€‚</p><p><strong>ä¸€ä¸ªä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹å…±äº«å•ä¸ªæ§åˆ¶ç»ˆç«¯</strong>ã€‚æ§åˆ¶ç»ˆç«¯ä¼šåœ¨ä¼šè¯é¦–è¿›ç¨‹é¦–æ¬¡æ‰“å¼€ä¸€ä¸ªç»ˆç«¯è®¾å¤‡æ—¶è¢«å»ºç«‹ã€‚ä¸€ä¸ªç»ˆç«¯æœ€å¤šå¯èƒ½ä¼šæˆä¸ºä¸€ä¸ªä¼šè¯çš„æ§åˆ¶ç»ˆç«¯ã€‚</p><blockquote><p><strong>å‰å°å’Œåå°è¿›ç¨‹ç»„</strong></p><p>åœ¨ç»ˆç«¯ä¸­è¿è¡Œç¨‹åºæ—¶ï¼ˆå¦‚<code>ls</code>ï¼‰ï¼Œè¯¥ç¨‹åºäº§ç”Ÿçš„è¾“å‡ºä¼šæ˜¾ç¤ºåœ¨ç»ˆç«¯ä¸Šï¼Œå¦‚æœéœ€è¦ï¼Œä¹Ÿä¼šä»ç»ˆç«¯è¯»å…¥ç”¨æˆ·é”®ç›˜è¾“å…¥çš„ä¿¡æ¯ã€‚<br>æœ‰æ—¶å¸Œæœ›å°†ä¸€ä¸ªç¨‹åºAå¯åŠ¨åï¼Œåœ¨å½“å‰ç»ˆç«¯ä¸‹ç»§ç»­è¿è¡Œç¨‹åºBï¼Œè¿™æ—¶ä¸€èˆ¬ä¼šé€šè¿‡<code>A &amp;</code>è®©ç¨‹åºåå°è¿è¡Œï¼Œæ­¤æ—¶å°±è¿˜å¯ä»¥ç»§ç»­è¿è¡ŒBã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå‰å°å’Œåå°çš„åŒºåˆ«åœ¨äºæ˜¯å¦èƒ½ä¸­ç»ˆç«¯è¯»å…¥ç”¨æˆ·è¾“å…¥ï¼Œæˆ–è€…è¯´è¿è¡Œæ—¶æ˜¯å¦ä½¿ç”¨äº†<code>&amp;</code>ã€‚éœ€è¦æ³¨æ„ï¼Œåå°è¿›ç¨‹ç»„çš„è¾“å‡ºä»ç„¶å¯ä»¥è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œæ¯”å¦‚<code>sleep 2 &amp;&amp; ls &amp;</code>.</p></blockquote><p>åœ¨ä»»ä¸€æ—¶åˆ»ï¼Œä¼šè¯ä¸­çš„å…¶ä¸­ä¸€ä¸ªè¿›ç¨‹ç»„ä¼šæˆä¸ºç»ˆç«¯çš„<strong>å‰å°è¿›ç¨‹ç»„</strong>ï¼Œå…¶ä»–è¿›ç¨‹ç»„ä¼šæˆä¸º<strong>åå°è¿›ç¨‹ç»„</strong>ã€‚<strong>åªæœ‰å‰å°è¿›ç¨‹ç»„ä¸­çš„è¿›ç¨‹æ‰èƒ½ä»æ§åˆ¶ç»ˆç«¯ä¸­è¯»å–è¾“å…¥</strong>ã€‚å½“ç”¨æˆ·åœ¨æ§åˆ¶ç»ˆç«¯ä¸­è¾“å…¥å…¶ä¸­ä¸€ä¸ªä¿¡å·ç”Ÿæˆç»ˆç«¯å­—ç¬¦ä¹‹åï¼Œè¯¥ä¿¡å·ä¼šè¢«å‘é€åˆ°å‰å°è¿›ç¨‹ç»„ä¸­çš„<strong>æ‰€æœ‰æˆå‘˜</strong>ã€‚</p><blockquote><p>é‚£ä¹ˆä¼šè¯æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p><p>åŒæ ·ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¼šè¯<code>SID</code>ç»™ä¼šè¯ä¸­çš„æ‰€æœ‰è¿›ç¨‹å‘é€ä¿¡å·ï¼ï¼ˆå½“ç„¶ï¼Œä¼šè¯çš„ä¸»è¦ç”¨é€”ä¸æ˜¯è¿™ä¸ªâ€¦ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨ä¸€ä¸ªç»ˆç«¯ä¸­å¯åŠ¨å¤šä¸ªè¿›ç¨‹</span></span><br><span class="line">$ <span class="built_in">cat</span> | <span class="built_in">cat</span> | <span class="built_in">cat</span> | <span class="built_in">cat</span>  <span class="comment"># å¯åŠ¨å¤šä¸ªè¿›ç¨‹</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­è¿è¡Œ</span></span><br><span class="line">$ ps aj</span><br><span class="line">   PPID     PID    PGID     SID TTY        TPGID STAT   UID   TIME COMMAND</span><br><span class="line">   5115   54152   54152   54152 pts/3      62248 Ss    1000   0:00 /bin/bash</span><br><span class="line">  54152   62248   62248   54152 pts/3      62248 S+    1000   0:00 <span class="built_in">cat</span></span><br><span class="line">  54152   62249   62248   54152 pts/3      62248 S+    1000   0:00 <span class="built_in">cat</span></span><br><span class="line">  54152   62250   62248   54152 pts/3      62248 S+    1000   0:00 <span class="built_in">cat</span></span><br><span class="line">  54152   62251   62248   54152 pts/3      62248 S+    1000   0:00 <span class="built_in">cat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»ˆç«¯ä¸­è¿è¡Œçš„ç¨‹åºå…¶ä¼šè¯ SID ä¸è¯¥ç»ˆç«¯çš„è¿›ç¨‹IDç›¸åŒï¼Œå› æ­¤ä¸‹é¢çš„å‘½ä»¤ä¼šå°†ç»ˆç«¯ä¹Ÿå…³é—­ï¼</span></span><br><span class="line">$ <span class="built_in">kill</span> -9 -54152</span><br></pre></td></tr></table></figure></blockquote><h4 id="getsid"><a href="#getsid" class="headerlink" title="getsid"></a>getsid</h4><p>è·å–æŒ‡å®šè¿›ç¨‹æ‰€å±çš„ä¼šè¯ <code>SID</code> ã€‚<code>pid</code>ä¸º0è¡¨ç¤ºè·å–å½“å‰è°ƒç”¨è¿›ç¨‹çš„ä¼šè¯ <code>SID</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">getsid</span><span class="params">(<span class="type">pid_t</span> pid)</span>;</span><br></pre></td></tr></table></figure><ul><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›è°ƒç”¨è¿›ç¨‹çš„ä¼šè¯ IDï¼Œå¤±è´¥è¿”å›<code>-1</code>ï¼Œè®¾ç½® <code>errno</code>ã€‚</li></ul><h4 id="setsid"><a href="#setsid" class="headerlink" title="setsid"></a>setsid</h4><p>åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ï¼Œå¹¶ä»¥è‡ªå·±çš„ <code>PID</code> è®¾ç½®ä¸ºè¿›ç¨‹ç»„ <code>PGID</code>ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æ–°ä¼šè¯çš„ <code>SID</code> ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">pid_t</span> <span class="title function_">setsid</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure><ul><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›è°ƒç”¨è¿›ç¨‹çš„ä¼šè¯ <code>SID</code>ï¼Œå¤±è´¥è¿”å› <code>-1</code>ï¼Œè®¾ç½® <code>errno</code> ã€‚</li></ul><p><code>setsid()</code>ç³»ç»Ÿè°ƒç”¨ä¼šæŒ‰ç…§ä¸‹åˆ—æ­¥éª¤åˆ›å»ºä¸€ä¸ªæ–°ä¼šè¯ï¼š</p><ul><li>è°ƒç”¨è¿›ç¨‹æˆä¸ºæ–°ä¼šè¯çš„é¦–è¿›ç¨‹å’Œè¯¥ä¼šè¯ä¸­æ–°è¿›ç¨‹ç»„çš„é¦–è¿›ç¨‹ã€‚è°ƒç”¨è¿›ç¨‹çš„è¿›ç¨‹ç»„ <code>PGID</code> å’Œä¼šè¯ <code>SID</code> ä¼šè¢«è®¾ç½®æˆè¯¥è¿›ç¨‹çš„è¿›ç¨‹ IDã€‚</li><li><strong>è°ƒç”¨è¿›ç¨‹æ²¡æœ‰æ§åˆ¶ç»ˆç«¯</strong>ã€‚æ‰€æœ‰ä¹‹å‰åˆ°æ§åˆ¶ç»ˆç«¯çš„è¿æ¥éƒ½ä¼šè¢«æ–­å¼€ã€‚</li></ul><p>åœ¨è°ƒç”¨<code>setsid()</code>æ—¶å­˜åœ¨ä¸€ä¸ªé™åˆ¶ï¼š<strong>è°ƒç”¨è¿›ç¨‹ä¸èƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ç»„çš„é¦–è¿›ç¨‹</strong>ã€‚é¿å…è¿™ä¸ªé”™è¯¯å‘ç”Ÿçš„æœ€ç®€å•çš„æ–¹å¼æ˜¯æ‰§è¡Œä¸€ä¸ª <code>fork()</code>å¹¶è®©çˆ¶è¿›ç¨‹ç»ˆæ­¢ä»¥åŠè®©å­è¿›ç¨‹è°ƒç”¨ <code>setsid()</code>ã€‚è¿›ç¨‹ç»„ä¸­ï¼Œç»„é•¿æ­»äº¡åï¼Œä¸ä¼šå†è‡ªåŠ¨äº§ç”Ÿæ–°ç»„é•¿ã€‚</p><blockquote><p>ä¸ºä»€ä¹ˆä¸èƒ½æ˜¯è¿›ç¨‹ç»„çš„é¦–è¿›ç¨‹ï¼Ÿ</p><p>å› ä¸ºå¦‚æœæ²¡æœ‰è¿™ä¸ªçº¦æŸçš„è¯ï¼Œè¿›ç¨‹ç»„ç»„é•¿å°±èƒ½å¤Ÿå°†å…¶è‡ªèº«è¿ç§»è‡³å¦ä¸€ä¸ªï¼ˆæ–°çš„ï¼‰ä¼šè¯ä¸­äº†ï¼Œè€Œè¯¥è¿›ç¨‹ç»„çš„å…¶ä»–æˆå‘˜åˆ™ä»ç„¶ä½äºåŸæ¥çš„ä¼šè¯ä¸­ã€‚è¿™ä¼šç ´åä¼šè¯å’Œè¿›ç¨‹ç»„ä¹‹é—´ä¸¥æ ¼çš„ä¸¤çº§å±‚æ¬¡ï¼Œå› ä¸ºä¸€ä¸ªè¿›ç¨‹ç»„çš„æ‰€æœ‰æˆå‘˜å¿…é¡»å±äºåŒä¸€ä¸ªä¼šè¯ã€‚</p></blockquote><h3 id="ç»ˆç«¯"><a href="#ç»ˆç«¯" class="headerlink" title="ç»ˆç«¯"></a>ç»ˆç«¯</h3><p>åœ¨UNIXç³»ç»Ÿä¸­ï¼Œç”¨æˆ·é€šè¿‡ç»ˆç«¯ç™»å½•ç³»ç»Ÿåå¾—åˆ°ä¸€ä¸ªShellè¿›ç¨‹ï¼Œè¿™ä¸ªç»ˆç«¯æˆä¸ºShellè¿›ç¨‹çš„æ§åˆ¶ç»ˆç«¯ (Controlling Terminal)ã€‚</p><p>æ§åˆ¶ç»ˆç«¯æ˜¯ä¿å­˜åœ¨<code>PCB</code>ä¸­çš„ä¿¡æ¯ï¼Œè€Œæˆ‘ä»¬çŸ¥é“<code>fork</code>ä¼šå¤åˆ¶<code>PCB</code>ä¸­çš„ä¿¡æ¯ï¼Œå› æ­¤ç”±Shellè¿›ç¨‹å¯åŠ¨çš„å…¶å®ƒè¿›ç¨‹çš„æ§åˆ¶ç»ˆç«¯ä¹Ÿæ˜¯è¿™ä¸ªç»ˆç«¯ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ˆæ²¡æœ‰é‡å®šå‘ï¼‰ï¼Œæ¯ä¸ªè¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ã€æ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯è¾“å‡ºéƒ½æŒ‡å‘æ§åˆ¶ç»ˆç«¯ï¼Œè¿›ç¨‹ä»æ ‡å‡†è¾“å…¥è¯»ä¹Ÿå°±æ˜¯è¯»ç”¨æˆ·çš„é”®ç›˜è¾“å…¥ï¼Œè¿›ç¨‹å¾€æ ‡å‡†è¾“å‡ºæˆ–æ ‡å‡†é”™è¯¯è¾“å‡ºå†™ä¹Ÿå°±æ˜¯è¾“å‡ºåˆ°æ˜¾ç¤ºå™¨ä¸Šã€‚</p><p>æ¯ä¸ªè¿›ç¨‹éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„è®¾å¤‡æ–‡ä»¶<code>/dev/tty</code>è®¿é—®å®ƒçš„æ§åˆ¶ç»ˆç«¯ã€‚<code>ttyname</code>å‡½æ•°å¯ä»¥ç”±æ–‡ä»¶æè¿°ç¬¦æŸ¥å‡ºå¯¹åº”çš„æ–‡ä»¶åï¼Œè¯¥æ–‡ä»¶æè¿°ç¬¦å¿…é¡»æŒ‡å‘ä¸€ä¸ªç»ˆç«¯è®¾å¤‡è€Œä¸èƒ½æ˜¯ä»»æ„æ–‡ä»¶ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;stdin  tty: %s\n&quot;</span>, ttyname(STDIN_FILENO));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;stdout tty: %s\n&quot;</span>, ttyname(STDOUT_FILENO));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;stderr tty: %s\n&quot;</span>, ttyname(STDERR_FILENO));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// stdin  tty: /dev/pts/2</span></span><br><span class="line"><span class="comment">// stdout tty: /dev/pts/2</span></span><br><span class="line"><span class="comment">// stderr tty: /dev/pts/2</span></span><br></pre></td></tr></table></figure><h3 id="å®ˆæŠ¤è¿›ç¨‹"><a href="#å®ˆæŠ¤è¿›ç¨‹" class="headerlink" title="å®ˆæŠ¤è¿›ç¨‹"></a>å®ˆæŠ¤è¿›ç¨‹</h3><p>å®ˆæŠ¤è¿›ç¨‹<code>daemon</code>æŒ‡çš„æ˜¯å…·æœ‰ç‰¹æ®Šç”¨é€”çš„è¿›ç¨‹ï¼Œé€šå¸¸é‡‡ç”¨ä»¥<code>d</code>ç»“å°¾çš„å‘½åæ–¹å¼ï¼Œç³»ç»Ÿåˆ›å»ºå’Œå¤„ç†æ­¤ç±»è¿›ç¨‹çš„æ–¹å¼ä¸å…¶ä»–è¿›ç¨‹ç›¸åŒã€‚</p><p>ä½†ä»¥ä¸‹ç‰¹å¾æ˜¯å…¶æ‰€ç‹¬æœ‰çš„ï¼š</p><ul><li>é•¿ç”Ÿä¸è€ï¼Œå®ˆæŠ¤è¿›ç¨‹é€šå¸¸åœ¨ç³»ç»Ÿå¼•å¯¼æ—¶å¯åŠ¨ï¼Œç›´è‡³ç³»ç»Ÿå…³é—­å‰ï¼Œä¼šä¸€ç›´â€œå¥åœ¨â€ï¼Œ<strong>ä¸å—ç”¨æˆ·ç™»å½•æ³¨é”€å½±å“</strong>ã€‚</li><li>å®ˆæŠ¤è¿›ç¨‹åœ¨åå°è¿è¡Œï¼Œä¸”æ— æ§åˆ¶ç»ˆç«¯ä¾›å…¶è¯»å–æˆ–å†™å…¥æ•°æ®ã€‚å‘¨æœŸæ€§çš„ç­‰å¾…æŸä¸ªäº‹ä»¶å‘ç”Ÿæˆ–å‘¨æœŸæ€§æ‰§è¡ŒæŸä¸€åŠ¨ä½œã€‚</li></ul><blockquote><p>å¾ˆå¤šæ ‡å‡†çš„ <code>daemon</code> ä¼šä½œä¸ºç‰¹æƒè¿›ç¨‹è¿è¡Œï¼Œå³æœ‰æ•ˆç”¨æˆ· ID ä¸º 0ã€‚</p></blockquote><p><strong>åˆ›å»ºå®ˆæŠ¤è¿›ç¨‹çš„æ­¥éª¤</strong>ï¼š</p><ol><li>æ‰§è¡Œä¸€ä¸ª <code>fork()</code>ï¼Œä¹‹åçˆ¶è¿›ç¨‹é€€å‡ºï¼Œ<strong>å­è¿›ç¨‹</strong>ç»§ç»­æ‰§è¡Œï¼ˆå­è¿›ç¨‹è¢«ç¡®ä¿ä¸ä¼šæˆä¸ºä¸€ä¸ªè¿›ç¨‹ç»„é¦–è¿›ç¨‹ï¼‰ã€‚</li><li>å­è¿›ç¨‹è°ƒç”¨ <code>setsid()</code> å¼€å¯ä¸€ä¸ª<strong>æ–°ä¼šè¯</strong>å¹¶é‡Šæ”¾å®ƒä¸æ§åˆ¶ç»ˆç«¯ä¹‹é—´çš„æ‰€æœ‰å…³è”å…³ç³»ã€‚</li><li>æ¸…é™¤è¿›ç¨‹çš„ <code>umask</code> ä»¥ç¡®ä¿å½“ <code>daemon</code> åˆ›å»ºæ–‡ä»¶å’Œç›®å½•æ—¶æ‹¥æœ‰æ‰€éœ€çš„<strong>æƒé™</strong><code>022 -- 755</code>ã€‚</li><li>ä¿®æ”¹è¿›ç¨‹çš„<strong>å½“å‰å·¥ä½œç›®å½•</strong>ï¼Œé€šå¸¸ä¼šæ”¹ä¸ºæ ¹ç›®å½•<code>/</code>ï¼Œé˜²æ­¢å·¥ä½œç›®å½•è¢«å¸è½½ï¼Œå¯¼è‡´è¿›ç¨‹æ­»äº¡ã€‚</li><li>å…³é—­ <code>daemon</code> ä»å…¶çˆ¶è¿›ç¨‹ç»§æ‰¿è€Œæ¥çš„æ‰€æœ‰æ‰“å¼€ç€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œä¸»è¦æ˜¯é’ˆå¯¹ <code>0, 1, 2</code>ï¼Œä¸€èˆ¬æ˜¯é‡å®šå‘åˆ° <code>/dev/null</code>ï¼Œé˜²æ­¢äº†åé¢ä½¿ç”¨æè¿°ç¬¦ 1 æˆ– 2 æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶çš„æƒ…å†µï¼Œå› ä¸ºåº“å‡½æ•°ä¼šå°†è¿™äº›æè¿°ç¬¦å½“åšæ ‡å‡†è¾“å‡ºå’Œæ ‡å‡†é”™è¯¯æ¥å†™å…¥æ•°æ®ã€‚</li><li>å®ˆæŠ¤è¿›ç¨‹<strong>ä¸šåŠ¡é€»è¾‘</strong><code>while()</code>ã€‚</li></ol><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">become_daemon</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> maxfd, fd;</span><br><span class="line">    <span class="keyword">switch</span> (fork()) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">-1</span>: <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>: <span class="keyword">break</span>;      <span class="comment">/* 1. å­è¿›ç¨‹ç»§ç»­ï¼Œä¹Ÿå°±æ˜¯å®ˆæŠ¤è¿›ç¨‹ */</span></span><br><span class="line">        <span class="keyword">default</span>: <span class="built_in">exit</span>(EXIT_SUCESS); <span class="comment">/* çˆ¶è¿›ç¨‹é€€å‡º */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setsid() == <span class="number">-1</span>)     <span class="comment">/* 2. åˆ›å»ºæ–°ä¼šè¯ */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (umask(<span class="number">0022</span>) == <span class="number">-1</span>)  <span class="comment">/* 3. é‡è®¾æ–‡ä»¶æƒé™æ©ç  */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chdir(<span class="string">&quot;/&quot;</span>) == <span class="number">-1</span>)   <span class="comment">/* 4. ä¿®æ”¹è¿›ç¨‹çš„å½“å‰å·¥ä½œç›®å½• */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    close(STDIN_FILENO);    <span class="comment">/* 5. é€šå¸¸æ ¹æ®éœ€è¦ï¼Œå…³é—­/é‡å®šå‘ æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/null&quot;</span>, O_RDWR); <span class="comment">/* fd --&gt; 0 */</span></span><br><span class="line">    <span class="keyword">if</span> (fd == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    dup2(fd, STDOUT_FILENO); <span class="comment">/* é‡å®šå‘ stdout å’Œ stderr */</span></span><br><span class="line">    dup2(fd, STDERR_FILENO);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿›ç¨‹ä¼˜å…ˆçº§"><a href="#è¿›ç¨‹ä¼˜å…ˆçº§" class="headerlink" title="è¿›ç¨‹ä¼˜å…ˆçº§"></a>è¿›ç¨‹ä¼˜å…ˆçº§</h2><p>æ“ä½œç³»ç»Ÿä¸Šæ€»æ˜¯ä¼šæœ‰å¾ˆå¤šè¿è¡Œä¸­çš„è¿›ç¨‹ï¼Œè€ŒCPUå´å¾ˆæœ‰é™ï¼Œé‚£ä¹ˆå“ªä¸ªè¿›ç¨‹èƒ½è·å¾—CPUçš„ä½¿ç”¨æƒå‘¢ï¼ŸLinux ä¸å¤§å¤šæ•°å…¶ä»– UNIX å®ç°ä¸€æ ·ï¼Œè°ƒåº¦è¿›ç¨‹ä½¿ç”¨ CPU çš„<strong>é»˜è®¤æ¨¡å‹æ˜¯å¾ªç¯æ—¶é—´å…±äº«</strong>ã€‚åœ¨è¿™ç§æ¨¡å‹ä¸­ï¼Œæ¯ä¸ªè¿›ç¨‹è½®æµä½¿ç”¨ CPU ä¸€æ®µæ—¶é—´ï¼Œè¿™æ®µæ—¶é—´è¢«ç§°ä¸º<strong>æ—¶é—´ç‰‡æˆ–é‡å­</strong>ã€‚</p><p>ä½†è¿›ç¨‹å¹¶ä¸æ˜¯å®Œå…¨å¹³ç­‰çš„ï¼ŒæŸäº›é‡è¦è¿›ç¨‹åº”è¯¥è¢«åˆ†é…æ›´å¤šçš„CPUä½¿ç”¨æƒã€‚é‚£ä¹ˆæ€ä¹ˆæè¿°è¿›ç¨‹çš„é‡è¦æ€§å‘¢ï¼Ÿè¿›ç¨‹ç‰¹æ€§ <code>nice</code> å€¼å…è®¸è¿›ç¨‹é—´æ¥åœ°å½±å“å†…æ ¸çš„è°ƒåº¦ç®—æ³•ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æ‹¥æœ‰ä¸€ä¸ª <code>nice</code> å€¼ï¼Œå…¶å–å€¼èŒƒå›´ä¸ºï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰<code>âˆ’20ï½19</code>ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï¼Œé»˜è®¤å€¼ä¸º 0ã€‚éç‰¹æƒè¿›ç¨‹åªèƒ½é™ä½è‡ªå·±çš„ä¼˜å…ˆçº§ï¼ˆä¸è¿‡è¿™ä¸ªè¯´æ³•å·²ç»ä¸æ­£ç¡®äº†ï¼‰ï¼Œå³èµ‹ä¸€ä¸ªå¤§äºé»˜è®¤å€¼ 0 çš„ <code>nice</code> å€¼ã€‚è¿™æ ·åšä¹‹åå®ƒä»¬å°±å¯¹å…¶ä»–è¿›ç¨‹â€œå‹å¥½ï¼ˆniceï¼‰â€äº†ï¼Œè¿™ä¸ªç‰¹æ€§çš„åç§°ä¹Ÿç”±æ­¤è€Œæ¥ã€‚</p><p>è¿›ç¨‹çš„è°ƒåº¦ä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§ <code>nice</code> å€¼çš„å±‚æ¬¡è¿›è¡Œçš„ï¼Œç›¸åï¼Œ<code>nice</code> å€¼æ˜¯ä¸€ä¸ªæƒé‡å› ç´ ï¼Œå®ƒå¯¼è‡´å†…æ ¸è°ƒåº¦å™¨å€¾å‘äºè°ƒåº¦æ‹¥æœ‰é«˜ä¼˜å…ˆçº§çš„è¿›ç¨‹ã€‚ç»™ä¸€ä¸ªè¿›ç¨‹èµ‹ä¸€ä¸ªä½ä¼˜å…ˆçº§ï¼ˆå³é«˜ <code>nice</code> å€¼ï¼‰å¹¶ä¸ä¼šå¯¼è‡´å®ƒå®Œå…¨æ— æ³•ç”¨åˆ° CPUï¼Œä½†ä¼šå¯¼è‡´å®ƒä½¿ç”¨ CPU çš„æ—¶é—´å˜å°‘ã€‚</p><p>è¿›ç¨‹æ§åˆ¶å—<code>PCB</code>ä¸­å°±è®°å½•äº†è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥å’Œä¼˜å…ˆçº§ç­‰å€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* è¿›ç¨‹è°ƒåº¦ç›¸å…³ï¼Œä¼˜å…ˆçº§ */</span></span><br><span class="line">    <span class="type">int</span> prio, static_prio, normal_prio;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> rt_priority;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">sched_class</span> *<span class="title">sched_class</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_entity</span> <span class="title">se</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sched_rt_entity</span> <span class="title">rt</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> policy;            <span class="comment">/* è¿›ç¨‹çš„è°ƒåº¦ç­–ç•¥ SCHED_FIFO, SCHED_RR, SCHED_OTHER, etc */</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getpriority-x2F-set"><a href="#getpriority-x2F-set" class="headerlink" title="getpriority&#x2F;set"></a>getpriority&#x2F;set</h3><p><code>getpriority()</code>å’Œ <code>setpriority()</code>ç³»ç»Ÿè°ƒç”¨å…è®¸ä¸€ä¸ªè¿›ç¨‹è·å–å’Œä¿®æ”¹è‡ªèº«æˆ–å…¶ä»–<strong>è¿›ç¨‹çš„ <code>nice</code> å€¼</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getpriority</span><span class="params">(<span class="type">int</span> which, <span class="type">id_t</span> who)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setpriority</span><span class="params">(<span class="type">int</span> which, <span class="type">id_t</span> who, <span class="type">int</span> prio)</span>;</span><br></pre></td></tr></table></figure><p><code>which</code><strong>ç”¨äºç¡®å®š<code>who</code>å¦‚ä½•è¢«è§£é‡Š</strong>ï¼š</p><ul><li><code>PRIO_PROCESS</code>ï¼šæ“ä½œè¿›ç¨‹ <code>PID</code> ä¸º who çš„è¿›ç¨‹ã€‚å¦‚æœ who ä¸º 0ï¼Œé‚£ä¹ˆä½¿ç”¨è°ƒç”¨è€…çš„è¿›ç¨‹ IDã€‚</li><li><code>PRIO_PGRP</code>ï¼šæ“ä½œè¿›ç¨‹ç»„ <code>PGID</code> ä¸º who çš„è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰æˆå‘˜ã€‚å¦‚æœ who ä¸º 0ï¼Œé‚£ä¹ˆä½¿ç”¨è°ƒç”¨è€…çš„è¿›ç¨‹ç»„ã€‚</li><li><code>PRIO_USER</code>ï¼šæ“ä½œæ‰€æœ‰çœŸå®ç”¨æˆ· <code>USRID</code> ä¸º who çš„è¿›ç¨‹ã€‚å¦‚æœ who ä¸º 0ï¼Œé‚£ä¹ˆä½¿ç”¨è°ƒç”¨è€…çš„çœŸå®ç”¨æˆ· IDã€‚</li></ul><p>è°ƒç”¨<code>getpriority</code>æ—¶ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿›ç¨‹ç¬¦åˆæŒ‡å®šçš„æ ‡å‡†ï¼Œé‚£ä¹ˆå°†ä¼šè¿”å›<strong>ä¼˜å…ˆçº§æœ€é«˜</strong>çš„è¿›ç¨‹çš„ <code>nice</code> å€¼ï¼ˆå³æœ€å°çš„æ•°å€¼ï¼‰ã€‚</p><blockquote><p>ç”±äº<code>getpriority</code>å¯èƒ½ä¼šåœ¨æˆåŠŸæ—¶è¿”å›<code>âˆ’1</code>ï¼Œå› æ­¤åœ¨è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹å‰å¿…é¡»è¦å°† <code>errno</code> è®¾ç½®ä¸º 0ï¼Œæ¥ç€åœ¨è°ƒç”¨ä¹‹åé¢å¤–æ£€æŸ¥<code>errno</code>ç¡®è®¤æ˜¯å¦å‘ç”Ÿäº†é”™è¯¯ã€‚</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> nice;</span><br><span class="line">    errno = <span class="number">0</span>;</span><br><span class="line">    nice = getpriority(PRIO_PROCESS, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (nice == <span class="number">-1</span> &amp;&amp; errno != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* è¯´æ˜è°ƒç”¨æ—¶å‘ç”Ÿäº†é”™è¯¯ */</span></span><br><span class="line">        perror(<span class="string">&quot;getpriority failed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;current nice: %d\n&quot;</span>, nice);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>setpriority</code>æ—¶ï¼Œè¯•å›¾å°† <code>nice</code> å€¼è®¾ç½®ä¸ºä¸€ä¸ªè¶…å‡ºå…è®¸èŒƒå›´çš„å€¼ï¼ˆ<code>-20ï½+19</code>ï¼‰æ—¶ä¼šç›´æ¥å°† <code>nice</code> å€¼è®¾ç½®ä¸ºè¾¹ç•Œå€¼ï¼ˆè¿˜å­˜åœ¨å…¶ä»–é™åˆ¶ï¼‰ã€‚</p><blockquote><p>éœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œç³»ç»Ÿè°ƒç”¨åªèƒ½é€šè¿‡<code>syscall</code>ç›´æ¥å‘èµ·ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„<code>getpriority</code>ç­‰å…¶å®æ˜¯<code>c</code>åº“å‡½æ•°å¯¹ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå°è£…åçš„å‡½æ•°ï¼Œåº“å‡½æ•°çš„è¿”å›ç»“æœå¹¶ä¸ä¸€å®šæ˜¯ç³»ç»Ÿè°ƒç”¨çš„ç›´æ¥è¿”å›å€¼ï¼ˆè™½ç„¶è¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œä¸è¿‡<code>getpriority</code>å°±æ˜¯ä¸€ä¸ªç‰¹ä¾‹ï¼‰ã€‚</p><p><code>getpriority()</code>ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹ä¸ä¼šè¿”å›å®é™…çš„ nice å€¼ï¼Œç›¸åï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªèŒƒå›´åœ¨ 1ï¼ˆä½ä¼˜å…ˆçº§ï¼‰ï½40ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰ä¹‹é—´çš„æ•°å­—ï¼Œè¿™ä¸ªæ•°å­—æ˜¯é€šè¿‡å…¬å¼ <code>unice=20-knice</code> è®¡ç®—å¾—æ¥çš„ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†é¿å…è®©ç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹è¿”å›ä¸€ä¸ªè´Ÿå€¼ï¼Œå› ä¸ºè´Ÿå€¼ä¸€èˆ¬éƒ½è¡¨ç¤ºé”™è¯¯ã€‚åº”ç”¨ç¨‹åºæ˜¯ä¸æ¸…æ¥šç³»ç»Ÿè°ƒç”¨æœåŠ¡ä¾‹ç¨‹å¯¹è¿”å›å€¼æ‰€åšçš„å¤„ç†çš„ï¼Œå› ä¸º C åº“å‡½æ•° <code>getpriority()</code>åšäº†ç›¸åçš„è®¡ç®—æ“ä½œï¼Œå®ƒå°† <code>20-unice</code> å€¼è¿”å›ç»™äº†è°ƒç”¨ç¨‹åºã€‚</p></blockquote><p>ä¸‹é¢ç®€å•çœ‹ä¸€ä¸‹è¿™ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨çš„å®ç°ï¼š<a href="https://elixir.bootlin.com/linux/v2.6.39/source/kernel/sys.c#L236">linux-2.6.39 getpriority</a>ï¼Œ<a href="https://elixir.bootlin.com/glibc/glibc-2.36/source/sysdeps/unix/sysv/linux/getpriority.c#L35">glibc åº“å‡½æ•° getpriority</a></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> TASK_NICE(p)        PRIO_TO_NICE((p)-&gt;static_prio)</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">task_nice</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> task_struct *p)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> TASK_NICE(p);</span><br><span class="line">&#125;</span><br><span class="line">SYSCALL_DEFINE2(getpriority, <span class="type">int</span>, which, <span class="type">int</span>, who)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">switch</span> (which) &#123;</span><br><span class="line">        <span class="keyword">case</span> PRIO_PROCESS:</span><br><span class="line">            <span class="keyword">if</span> (who)</span><br><span class="line">                p = find_task_by_vpid(who);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = current;</span><br><span class="line">            <span class="keyword">if</span> (p) &#123;</span><br><span class="line">                niceval = <span class="number">20</span> - task_nice(p); <span class="comment">/* å°†è¿”å›å€¼è®¾ç½®ä¸ºæ­£æ•° */</span></span><br><span class="line">                <span class="keyword">if</span> (niceval &gt; retval)</span><br><span class="line">                    retval = niceval;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE3(setpriority, <span class="type">int</span>, which, <span class="type">int</span>, who, <span class="type">int</span>, niceval)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (niceval &lt; <span class="number">-20</span>) <span class="comment">/* ä¸Šä¸‹ç•Œåˆ¤æ–­ */</span></span><br><span class="line">        niceval = <span class="number">-20</span>;</span><br><span class="line">    <span class="keyword">if</span> (niceval &gt; <span class="number">19</span>)</span><br><span class="line">        niceval = <span class="number">19</span>;</span><br><span class="line">    <span class="keyword">switch</span> (which) &#123;</span><br><span class="line">        <span class="keyword">case</span> PRIO_PROCESS:</span><br><span class="line">            <span class="keyword">if</span> (who)</span><br><span class="line">                p = find_task_by_vpid(who);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = current;</span><br><span class="line">            <span class="keyword">if</span> (p)</span><br><span class="line">                error = set_one_prio(p, niceval, error);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* åº“å‡½æ•° getpriority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PZERO 20</span></span><br><span class="line"><span class="type">int</span> __getpriority (<span class="keyword">enum</span> __priority_which which, <span class="type">id_t</span> who)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> res;</span><br><span class="line"></span><br><span class="line">    res = INLINE_SYSCALL (getpriority, <span class="number">2</span>, (<span class="type">int</span>) which, who);</span><br><span class="line">    <span class="keyword">if</span> (res &gt;= <span class="number">0</span>)</span><br><span class="line">        res = PZERO - res; <span class="comment">/* å†æ¬¡è½¬æ¢ */</span></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>nice</code>å‘½ä»¤å¯ä»¥ä»¥æŒ‡å®šçš„<code>nice</code>å€¼è¿è¡Œç¨‹åºã€‚å¦‚<code>nice -3 ./test</code>ï¼ŒæŒ‡å®šniceå€¼ä¸º3ï¼Œå¦‚æœæƒ³æŒ‡å®šä¸ºè´Ÿæ•°éœ€è¦å†åŠ ä¸€ä¸ªè´Ÿå·<code>nice --3 ./test</code>ï¼ˆéœ€è¦ç‰¹æƒï¼‰ã€‚</p><p><code>top</code> ä¸­æ˜¾ç¤ºçš„ <code>NI</code> ä¸€æ å°±æ˜¯è¿›ç¨‹çš„ <code>nice</code> å€¼ï¼<code>ps -l</code> ä¹Ÿå¯ä»¥æŸ¥çœ‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ top</span><br><span class="line">   PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">275133 yogurt    20   0 8589112   4.5g   4.3g S  45.8  14.3 109:53.85 VirtualBoxVM</span><br><span class="line">  3894 yogurt    20   0 7470576 331140 125048 S   4.3   1.0  13:52.23 gnome-shell</span><br><span class="line">     3 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_gp</span><br><span class="line">     4 root       0 -20       0      0      0 I   0.0   0.0   0:00.00 rcu_par_gp</span><br></pre></td></tr></table></figure><p>ä»ç‰ˆæœ¬å·ä¸º <code>2.6.12</code> çš„å†…æ ¸å¼€å§‹ï¼ŒLinux æä¾›äº† <code>RLIMIT_NICE</code> èµ„æºé™åˆ¶ï¼Œå³å…è®¸éç‰¹æƒè¿›ç¨‹æå‡ <code>nice</code> å€¼ã€‚éç‰¹æƒè¿›ç¨‹èƒ½å¤Ÿå°†è‡ªå·±çš„ <code>nice</code> å€¼æœ€é«˜æé«˜åˆ°å…¬å¼ <code>20âˆ’rlim_cur</code> æŒ‡å®šçš„å€¼ï¼Œå…¶ä¸­ <code>rlim_cur</code> æ˜¯å½“å‰çš„ <code>RLIMIT_NICE</code> è½¯èµ„æºé™åˆ¶ã€‚å¦‚å‡è®¾ä¸€ä¸ªè¿›ç¨‹çš„ <code>RLIMIT_NICE</code> è½¯é™åˆ¶æ˜¯ 25ï¼Œé‚£ä¹ˆå…¶ <code>nice</code>å€¼å¯ä»¥è¢«æé«˜åˆ°âˆ’5ã€‚æ ¹æ®è¿™ä¸ªå…¬å¼ä»¥åŠ <code>nice</code> å€¼çš„å–å€¼èŒƒå›´ä¸ºï¼ˆä½ï¼‰<code>+19ï½âˆ’20</code>ï¼ˆé«˜ï¼‰çš„äº‹å®å¯ä»¥å¾—å‡º <code>RLIMIT_NICE</code> çš„æœ‰æ•ˆèŒƒå›´ä¸ºï¼ˆä½ï¼‰<code>1ï½40</code>ï¼ˆé«˜ï¼‰çš„ç»“è®ºã€‚å¦‚ä½•ä¿®æ”¹è¯¥å€¼å°±æ¶‰åŠåˆ°ä¸‹é¢çš„è¿›ç¨‹èµ„æºäº†ã€‚</p><h2 id="è¿›ç¨‹èµ„æº"><a href="#è¿›ç¨‹èµ„æº" class="headerlink" title="è¿›ç¨‹èµ„æº"></a>è¿›ç¨‹èµ„æº</h2><p>æ¯ä¸ªè¿›ç¨‹éƒ½ç”¨ä¸€ç»„èµ„æºé™å€¼ï¼Œå®ƒä»¬å¯ä»¥ç”¨æ¥é™åˆ¶è¿›ç¨‹èƒ½å¤Ÿæ¶ˆè€—çš„å„ç§ç³»ç»Ÿèµ„æºã€‚å¦‚åœ¨æ‰§è¡Œä»»æ„ä¸€ä¸ªç¨‹åºä¹‹å‰å¦‚æœä¸æƒ³è®©å®ƒæ¶ˆè€—å¤ªå¤šèµ„æºï¼Œåˆ™å¯ä»¥è®¾ç½®è¯¥è¿›ç¨‹çš„èµ„æºé™åˆ¶ã€‚</p><h3 id="getrlimit-x2F-set"><a href="#getrlimit-x2F-set" class="headerlink" title="getrlimit&#x2F;set"></a>getrlimit&#x2F;set</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">getrlimit</span><span class="params">(<span class="type">int</span> resource, <span class="keyword">struct</span> rlimit *rlim)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">setrlimit</span><span class="params">(<span class="type">int</span> resource, <span class="type">const</span> <span class="keyword">struct</span> rlimit *rlim)</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> &#123;</span></span><br><span class="line">    <span class="type">rlim_t</span> rlim_cur;  <span class="comment">/* Soft limit */</span></span><br><span class="line">    <span class="type">rlim_t</span> rlim_max;  <span class="comment">/* Hard limit (ceiling for rlim_cur) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>resource</code> æŒ‡å®šèµ„æºï¼Œè¿™é‡Œæœ‰å¾ˆå¤šé€‰é¡¹ï¼ŒæŸ¥çœ‹<code>man page</code>ç­‰èµ„æ–™å³å¯ï¼Œä¸‹é¢åªåˆ—å‡ é¡¹å†…å®¹ï¼š</p><table><thead><tr><th>resource å–å€¼</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td><code>RLIMIT_NICE</code></td><td>èƒ½å¤Ÿä¸ºè¿›ç¨‹è®¾ç½®çš„æœ€å¤§ <code>nice</code> å€¼</td></tr><tr><td><code>RLIMIT_RTPRIO</code></td><td>èƒ½å¤Ÿä¸ºè¿›ç¨‹è®¾ç½®çš„æœ€é«˜å®æ—¶ä¼˜å…ˆçº§</td></tr><tr><td><code>RLIMIT_STACK</code></td><td>è¿›ç¨‹æ ˆçš„æœ€å¤§å­—èŠ‚æ•°</td></tr></tbody></table><p><strong>è½¯é™åˆ¶</strong>è§„å®šäº†è¿›ç¨‹èƒ½å¤Ÿæ¶ˆè€—çš„èµ„æºæ•°é‡ã€‚ä¸€ä¸ªè¿›ç¨‹å¯ä»¥å°†è½¯é™åˆ¶è°ƒæ•´ä¸ºä» 0 åˆ°ç¡¬é™åˆ¶ä¹‹é—´çš„å€¼ã€‚å¯¹äºå¤§å¤šæ•°èµ„æºæ¥è®²ï¼Œ<strong>ç¡¬é™åˆ¶çš„å”¯ä¸€ä½œç”¨æ˜¯ä¸ºè½¯é™åˆ¶è®¾å®šäº†ä¸Šé™</strong>ã€‚ç‰¹æƒï¼ˆ<code>CAP_SYS_RESOURCE</code>ï¼‰è¿›ç¨‹èƒ½å¤Ÿå¢å¤§å’Œç¼©å°ç¡¬é™åˆ¶ï¼ˆåªè¦å…¶å€¼ä»ç„¶å¤§äºè½¯é™åˆ¶ï¼‰ï¼Œä½†éç‰¹æƒè¿›ç¨‹åˆ™åªèƒ½ç¼©å°ç¡¬é™åˆ¶ï¼ˆè¿™ä¸ªè¡Œä¸ºæ˜¯ä¸å¯é€†çš„ï¼‰ã€‚å–å€¼ä¸º <code>RLIM_INFINITY</code> è¡¨ç¤ºæ²¡æœ‰é™åˆ¶ã€‚<code>prlimit</code>å¯ä»¥æ‰“å°å‡ºå½“å‰çš„èµ„æºé™åˆ¶æƒ…å†µã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ prlimit</span><br><span class="line">RESOURCE   DESCRIPTION                              SOFT       HARD UNITS</span><br><span class="line">AS         address space limit                 unlimited  unlimited bytes</span><br><span class="line">CORE       max core file size                          <span class="number">0</span>  unlimited bytes</span><br><span class="line">CPU        CPU time                            unlimited  unlimited seconds</span><br><span class="line">DATA       max data size                       unlimited  unlimited bytes</span><br><span class="line">FSIZE      max file size                       unlimited  unlimited bytes</span><br><span class="line">LOCKS      max number of file locks held       unlimited  unlimited locks</span><br><span class="line">MEMLOCK    max locked-in-memory address space <span class="number">4173918208</span> <span class="number">4173918208</span> bytes</span><br><span class="line">MSGQUEUE   max bytes in POSIX mqueues             <span class="number">819200</span>     <span class="number">819200</span> bytes</span><br><span class="line">NICE       max nice prio allowed to raise              <span class="number">0</span>          <span class="number">0</span></span><br><span class="line">NOFILE     max number of open files                 <span class="number">1024</span>    <span class="number">1048576</span> files</span><br><span class="line">NPROC      max number of processes                <span class="number">127101</span>     <span class="number">127101</span> processes</span><br><span class="line">RSS        max resident <span class="built_in">set</span> size               unlimited  unlimited bytes</span><br><span class="line">RTPRIO     max real-time priority                      <span class="number">0</span>          <span class="number">0</span></span><br><span class="line">RTTIME     timeout <span class="keyword">for</span> real-time tasks         unlimited  unlimited microsecs</span><br><span class="line">SIGPENDING max number of pending signals          <span class="number">127101</span>     <span class="number">127101</span> signals</span><br><span class="line">STACK      max <span class="built_in">stack</span> size                        <span class="number">8388608</span>  unlimited bytes</span><br></pre></td></tr></table></figure><h2 id="å®æ—¶è¿›ç¨‹è°ƒåº¦"><a href="#å®æ—¶è¿›ç¨‹è°ƒåº¦" class="headerlink" title="å®æ—¶è¿›ç¨‹è°ƒåº¦"></a>å®æ—¶è¿›ç¨‹è°ƒåº¦</h2><p>åœ¨ä¸€ä¸ªç³»ç»Ÿä¸Šä¸€èˆ¬ä¼šåŒæ—¶è¿è¡Œäº¤äº’å¼è¿›ç¨‹å’Œåå°è¿›ç¨‹ï¼Œæ ‡å‡†çš„å†…æ ¸è°ƒåº¦ç®—æ³•ä¸€èˆ¬èƒ½å¤Ÿä¸ºè¿™äº›è¿›ç¨‹æä¾›è¶³å¤Ÿçš„æ€§èƒ½å’Œå“åº”åº¦ã€‚ä½†å®æ—¶åº”ç”¨å¯¹è°ƒåº¦å™¨æœ‰æ›´åŠ ä¸¥æ ¼çš„è¦æ±‚ï¼š</p><ul><li>å®æ—¶åº”ç”¨å¿…é¡»è¦ä¸ºå¤–éƒ¨è¾“å…¥æä¾›æ‹…ä¿æœ€å¤§å“åº”æ—¶é—´ã€‚ä¸ºäº†æ»¡è¶³è¿™ç§è¦æ±‚ï¼Œå†…æ ¸å¿…é¡»è¦æä¾›å·¥å…·è®©é«˜ä¼˜å…ˆçº§è¿›ç¨‹èƒ½å¿«é€Ÿåœ°å–å¾— CPU çš„æ§åˆ¶æƒï¼Œ<strong>æŠ¢å å½“å‰è¿è¡Œçš„æ‰€æœ‰è¿›ç¨‹</strong>ã€‚</li><li>é«˜ä¼˜å…ˆçº§è¿›ç¨‹åº”è¯¥èƒ½å¤Ÿä¿æŒäº’æ–¥åœ°è®¿é—® CPU <strong>ç›´è‡³å®ƒå®Œæˆ</strong>æˆ–è‡ªåŠ¨é‡Šæ”¾ CPUã€‚</li><li>å®æ—¶åº”ç”¨åº”è¯¥èƒ½å¤Ÿç²¾ç¡®åœ°æ§åˆ¶å…¶ç»„ä»¶è¿›ç¨‹çš„è°ƒåº¦é¡ºåºã€‚</li></ul><p>SUSv3 è§„å®šçš„å®æ—¶è¿›ç¨‹è°ƒåº¦ API æä¾›äº†ä¸¤ä¸ªå®æ—¶è°ƒåº¦ç­–ç•¥ï¼š<code>SCHED_RR</code> å’Œ <code>SCHED_FIFO</code>ã€‚ä½¿ç”¨è¿™ä¸¤ç§ç­–ç•¥ä¸­ä»»æ„ä¸€ç§ç­–ç•¥è¿›è¡Œè°ƒåº¦çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§è¦é«˜äºé»˜è®¤çš„æ ‡å‡†å¾ªç¯æ—¶é—´åˆ†äº«<code>SCHED_OTHER</code>ç­–ç•¥æ¥è°ƒåº¦çš„è¿›ç¨‹ã€‚</p><p>æ¯ä¸ªå®æ—¶ç­–ç•¥å…è®¸ä¸€ä¸ªä¼˜å…ˆçº§èŒƒå›´ã€‚åœ¨æ¯ä¸ªè°ƒåº¦ç­–ç•¥ä¸­ï¼Œæ‹¥æœ‰é«˜ä¼˜å…ˆçº§çš„å¯è¿è¡Œè¿›ç¨‹åœ¨å°è¯•è®¿é—® CPU æ—¶æ€»æ˜¯ä¼˜å…ˆäºä¼˜å…ˆçº§è¾ƒä½çš„è¿›ç¨‹ã€‚Linux æä¾›äº† 99 ä¸ªå®æ—¶ä¼˜å…ˆçº§ï¼Œ<strong>å…¶æ•°å€¼ä» 1ï¼ˆæœ€ä½ï¼‰ï½99ï¼ˆæœ€é«˜ï¼‰</strong>ï¼Œå¹¶ä¸”è¿™ä¸ªå–å€¼èŒƒå›´åŒæ—¶é€‚ç”¨äºä¸¤ä¸ªå®æ—¶è°ƒåº¦ç­–ç•¥ã€‚</p><blockquote><p>å¯¹äºå¤šå¤„ç†å™¨ Linux ç³»ç»Ÿï¼ˆåŒ…æ‹¬è¶…çº¿ç¨‹ç³»ç»Ÿï¼‰æ¥è®²ï¼Œé«˜ä¼˜å…ˆçº§çš„å¯è¿è¡Œè¿›ç¨‹æ€»æ˜¯ä¼˜å…ˆäºä¼˜å…ˆçº§è¾ƒä½çš„è¿›ç¨‹çš„è§„åˆ™å¹¶ä¸é€‚ç”¨ã€‚åœ¨å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå„ä¸ª CPU æ‹¥æœ‰ç‹¬ç«‹çš„è¿è¡Œé˜Ÿåˆ—ï¼ˆè¿™ç§æ–¹å¼æ¯”ä½¿ç”¨ä¸€ä¸ªç³»ç»Ÿå±‚é¢çš„è¿è¡Œé˜Ÿåˆ—çš„æ€§èƒ½è¦å¥½ï¼‰ï¼Œå¹¶ä¸”æ¯ä¸ª CPU çš„è¿è¡Œé˜Ÿåˆ—ä¸­çš„è¿›ç¨‹çš„ä¼˜å…ˆçº§éƒ½å±€é™äºè¯¥é˜Ÿåˆ—ã€‚å¦‚å‡è®¾ä¸€ä¸ªåŒå¤„ç†å™¨ç³»ç»Ÿä¸­è¿è¡Œç€ä¸‰ä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹ A çš„å®æ—¶ä¼˜å…ˆçº§ä¸º 20ï¼Œå¹¶ä¸”å®ƒä½äº CPU 0 çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè€Œè¯¥ CPU å½“å‰æ­£åœ¨è¿è¡Œä¼˜å…ˆçº§ä¸º 30 çš„è¿›ç¨‹ Bï¼Œå³ä½¿ CPU 1 æ­£åœ¨è¿è¡Œä¼˜å…ˆçº§ä¸º 10 çš„è¿›ç¨‹ Cï¼Œè¿›ç¨‹ A è¿˜æ˜¯éœ€è¦ç­‰å¾… CPU 0ã€‚</p></blockquote><h3 id="CPU-äº²å’Œæ€§"><a href="#CPU-äº²å’Œæ€§" class="headerlink" title="CPU äº²å’Œæ€§"></a>CPU äº²å’Œæ€§</h3><p>è®¾ç½®è¿›ç¨‹çš„CPUäº²å’Œæ€§ç”¨äºé™åˆ¶è¿›ç¨‹åœ¨æŒ‡å®šçš„CPUä¸Šè¿è¡Œï¼Œå†…æ ¸å°è¯•äº†ç»™è¿›ç¨‹ä¿è¯<strong>è½¯ CPU äº²å’ŒåŠ›</strong> â€” <strong>åœ¨æ¡ä»¶å…è®¸çš„æƒ…å†µä¸‹</strong>è¿›ç¨‹é‡æ–°è¢«è°ƒåº¦åˆ°åŸæ¥çš„CPU ä¸Šè¿è¡Œã€‚ä½†è¿™å¹¶ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œæ¡ä»¶ä¸å…è®¸ä»ç„¶ä¼šå°†è¿›ç¨‹è°ƒåº¦åˆ°å…¶ä»–CPUä¸Šè¿è¡Œã€‚æœ‰æ—¶å€™éœ€è¦ä¸ºè¿›ç¨‹è®¾ç½®<strong>ç¡¬ CPU äº²å’ŒåŠ›</strong>ï¼Œè¿™æ ·å°±èƒ½æ˜¾å¼åœ°å°†å…¶é™åˆ¶åœ¨å¯ç”¨ CPU ä¸­çš„ä¸€ä¸ªæˆ–ä¸€ç»„ CPU ä¸Šè¿è¡Œï¼ŒåŸå› å¦‚ä¸‹ï¼š</p><ul><li>å¯ä»¥é¿å…ç”±ä½¿é«˜é€Ÿç¼“å†²å™¨ä¸­çš„æ•°æ®å¤±æ•ˆæ‰€å¸¦æ¥çš„æ€§èƒ½å½±å“ã€‚</li><li>å¦‚æœå¤šä¸ªçº¿ç¨‹ï¼ˆæˆ–è¿›ç¨‹ï¼‰è®¿é—®åŒæ ·çš„æ•°æ®ï¼Œé‚£ä¹ˆå½“å°†å®ƒä»¬é™åˆ¶åœ¨åŒæ ·çš„ CPU ä¸Šçš„è¯å¯èƒ½ä¼šå¸¦æ¥æ€§èƒ½æå‡ï¼Œå› ä¸ºå®ƒä»¬æ— éœ€ç«äº‰æ•°æ®å¹¶ä¸”ä¹Ÿä¸å­˜åœ¨ç”±æ­¤è€Œäº§ç”Ÿçš„é«˜é€Ÿç¼“å†²å™¨æœªå‘½ä¸­ã€‚</li><li>å¯¹äºæ—¶é—´å…³é”®çš„åº”ç”¨ç¨‹åºæ¥è®²ï¼Œå¯èƒ½éœ€è¦ä¸ºæ­¤åº”ç”¨ç¨‹åºé¢„ç•™ä¸€ä¸ªæˆ–æ›´å¤š CPUï¼Œè€Œå°†ç³»ç»Ÿä¸­å¤§å¤šæ•°è¿›ç¨‹é™åˆ¶åœ¨å…¶ä»– CPU ä¸Šã€‚</li></ul><blockquote><p>ä½¿ç”¨ isolcpus å†…æ ¸å¯åŠ¨å‚æ•°èƒ½å¤Ÿå°†ä¸€ä¸ªæˆ–æ›´å¤š CPU åˆ†ç¦»å‡ºå¸¸è§„çš„å†…æ ¸è°ƒåº¦ç®—æ³•ã€‚å°†ä¸€ä¸ªè¿›ç¨‹ç§»åˆ°æˆ–ç§»å‡ºè¢«åˆ†ç¦»å‡ºæ¥çš„ CPU çš„å”¯ä¸€æ–¹å¼æ˜¯ä½¿ç”¨æœ¬èŠ‚ä»‹ç»çš„ CPU äº²å’ŒåŠ›ç³»ç»Ÿè°ƒç”¨ã€‚isolcpuså¯åŠ¨å‚æ•°æ˜¯å®ç°ä¸Šé¢åˆ—å‡ºçš„æœ€åä¸€ç§åœºæ™¯çš„é¦–é€‰æ–¹å¼ï¼Œå…·ä½“å¯å‚è€ƒå†…æ ¸æºæ–‡ä»¶ Documentation&#x2F;kernel-parameters.txtã€‚</p></blockquote><h4 id="sched-setaffinity-x2F-get"><a href="#sched-setaffinity-x2F-get" class="headerlink" title="sched_setaffinity&#x2F;get"></a>sched_setaffinity&#x2F;get</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sched_setaffinity</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">size_t</span> cpusetsize,</span></span><br><span class="line"><span class="params">                        <span class="type">const</span> <span class="type">cpu_set_t</span> *mask)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sched_getaffinity</span><span class="params">(<span class="type">pid_t</span> pid, <span class="type">size_t</span> cpusetsize,</span></span><br><span class="line"><span class="params">                        <span class="type">cpu_set_t</span> *mask)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>pid</code>ï¼šè¦è®¾ç½®çš„è¿›ç¨‹å·ï¼Œä¹Ÿå¯ç®€å•çš„ç”¨<code>0</code>æ¥è¡¨ç¤ºè°ƒç”¨è¿›ç¨‹ï¼Œä¹Ÿå¯ç”¨<code>gettid()</code>ä¼ å…¥çº¿ç¨‹å·</li><li><code>cpusetsize</code>ï¼šåº”è¯¥æŒ‡å®š <code>mask</code> å‚æ•°çš„å­—èŠ‚æ•°ï¼Œé€šå¸¸è®¾å®šä¸º<code>sizeof(cpu_set_t)</code></li><li><code>mask</code>ï¼šæ ¸çš„æ©ç ã€‚</li><li>è¿”å›å€¼ï¼šæˆåŠŸè¿”å›0ï¼Œå¤±è´¥è¿”å›<code>-1</code>ï¼Œå¹¶è®¾ç½®<code>errno</code><ul><li>å¦‚æœ<code>mask</code>ä¸­æŒ‡å®šçš„ CPU ä¸ç³»ç»Ÿä¸­çš„æ‰€æœ‰ CPU éƒ½ä¸åŒ¹é…ï¼Œè¿”å›<code>EINVAL</code>é”™è¯¯</li></ul></li></ul><p><code>taskset -p PID</code> å¯æŸ¥çœ‹å½“å‰è¿›ç¨‹çš„<code>mask</code>ï¼Œå¯é€šè¿‡ <code>taskset -pc $pid</code> æ¥è·å–æŸçº¿ç¨‹ä¸CPUæ ¸å¿ƒçš„äº²å’Œæ€§ã€‚</p><p>è™½ç„¶ <code>cpu_set_t</code> æ•°æ®ç±»å‹å®ç°ä¸ºä¸€ä¸ªä½æ©ç ï¼Œä½†åº”è¯¥å°†å…¶çœ‹æˆæ˜¯ä¸€ä¸ªä¸é€æ˜çš„ç»“æ„ã€‚</p><p>æ‰€æœ‰å¯¹è¿™ä¸ªç»“æ„çš„æ“ä½œéƒ½åº”è¯¥ä½¿ç”¨å®æ¥å®Œæˆï¼Œä¸‹é¢æ˜¯éƒ¨åˆ†å¸¸ç”¨çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* man CPU_SET */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">CPU_ZERO</span><span class="params">(<span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;          <span class="comment">/* å°† set åˆå§‹åŒ–ä¸ºç©º */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CPU_SET</span><span class="params">(<span class="type">int</span> cpu, <span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;  <span class="comment">/* å°† CPU cpu æ·»åŠ åˆ° set ä¸­ */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">CPU_CLR</span><span class="params">(<span class="type">int</span> cpu, <span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;  <span class="comment">/* ä» set ä¸­åˆ é™¤ CPU cpu */</span></span><br><span class="line"><span class="type">int</span>  <span class="title function_">CPU_ISSET</span><span class="params">(<span class="type">int</span> cpu, <span class="type">cpu_set_t</span> *<span class="built_in">set</span>)</span>;<span class="comment">/* åœ¨ CPU cpu æ˜¯ set çš„ä¸€ä¸ªæˆå‘˜æ—¶è¿”å› true */</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸Šé¢å®å‚æ•°<code>cpu</code>ç¼–å·æ˜¯ä»0å¼€å§‹ã€‚</p><h2 id="ç¯å¢ƒåˆ—è¡¨"><a href="#ç¯å¢ƒåˆ—è¡¨" class="headerlink" title="ç¯å¢ƒåˆ—è¡¨"></a>ç¯å¢ƒåˆ—è¡¨</h2><p>æ¯ä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸å…¶ç›¸å…³çš„ç§°ä¹‹ä¸ºç¯å¢ƒåˆ—è¡¨ï¼ˆenvironment listï¼‰çš„å­—ç¬¦ä¸²æ•°ç»„ï¼Œæˆ–ç®€ç§°ä¸ºç¯å¢ƒï¼ˆenvironmentï¼‰ã€‚å…¶ä¸­æ¯ä¸ªå­—ç¬¦ä¸²éƒ½ä»¥åç§°&#x3D;å€¼ï¼ˆname&#x3D;valueï¼‰å½¢å¼å®šä¹‰ã€‚å› æ­¤ï¼Œç¯å¢ƒæ˜¯â€œåç§°-å€¼â€çš„æˆå¯¹é›†åˆï¼Œå¯å­˜å‚¨ä»»ä½•ä¿¡æ¯ã€‚å¸¸å°†åˆ—è¡¨ä¸­çš„åç§°ç§°ä¸ºç¯å¢ƒå˜é‡ã€‚</p><p><strong>æ–°è¿›ç¨‹åœ¨åˆ›å»ºä¹‹æ—¶ï¼Œä¼šç»§æ‰¿å…¶çˆ¶è¿›ç¨‹çš„ç¯å¢ƒå‰¯æœ¬ï¼</strong>å¯é€šè¿‡å‘½ä»¤<code>printenv</code>æŸ¥çœ‹å½“å‰shellç¯å¢ƒå˜é‡ã€‚</p><p>åœ¨ C è¯­è¨€ç¨‹åºä¸­ï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€å˜é‡ <code>char **environ</code> è®¿é—®ç¯å¢ƒåˆ—è¡¨ã€‚ï¼ˆC è¿è¡Œæ—¶å¯åŠ¨ä»£ç å®šä¹‰äº†è¯¥å˜é‡å¹¶ä»¥ç¯å¢ƒåˆ—è¡¨ä½ç½®ä¸ºå…¶èµ‹å€¼ã€‚ï¼‰<code>environ</code> ä¸ <code>argv</code> å‚æ•°ç±»ä¼¼ï¼ŒæŒ‡å‘ä¸€ä¸ªä»¥ <code>NULL</code> ç»“å°¾çš„æŒ‡é’ˆåˆ—è¡¨ï¼Œæ¯ä¸ªæŒ‡é’ˆåˆæŒ‡å‘ä¸€ä¸ªä»¥ç©ºå­—èŠ‚ç»ˆæ­¢çš„å­—ç¬¦ä¸²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">char</span> **environ;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">char</span> **ep;</span><br><span class="line">    <span class="keyword">for</span> (ep = environ; *ep; ep++) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, *ep);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="getenv"><a href="#getenv" class="headerlink" title="getenv"></a>getenv</h3><p><code>getenv()</code>å‡½æ•°èƒ½å¤Ÿä»è¿›ç¨‹ç¯å¢ƒä¸­æ£€ç´¢å•ä¸ªå€¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> *<span class="title function_">getenv</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name)</span>;</span><br></pre></td></tr></table></figure><ul><li>nameï¼šæŒ‡å‘è¦æ£€ç´¢çš„ç¯å¢ƒå˜é‡åç§°çš„å­—ç¬¦ä¸²ã€‚</li><li>è¿”å›å€¼ï¼šå¦‚æœæ‰¾åˆ°è¯¥ç¯å¢ƒå˜é‡ï¼Œåˆ™è¿”å›è¯¥ç¯å¢ƒå˜é‡çš„å€¼ï¼Œå¦åˆ™è¿”å› NULLã€‚</li></ul><h3 id="putenv"><a href="#putenv" class="headerlink" title="putenv"></a>putenv</h3><p>æœ‰æ—¶ï¼Œå¯¹è¿›ç¨‹æ¥è¯´ï¼Œä¿®æ”¹å…¶ç¯å¢ƒå¾ˆæœ‰ç”¨å¤„ã€‚åŸå› ä¹‹ä¸€æ˜¯è¿™ä¸€ä¿®æ”¹å¯¹è¯¥è¿›ç¨‹åç»­åˆ›å»ºçš„æ‰€æœ‰å­è¿›ç¨‹å‡å¯è§ã€‚å¦ä¸€ä¸ªå¯èƒ½çš„åŸå› åœ¨äºè®¾å®šæŸä¸€å˜é‡ï¼Œä»¥æ±‚å¯¹äºå°†è¦è½½å…¥è¿›ç¨‹å†…å­˜çš„æ–°ç¨‹åºï¼ˆâ€œexecedâ€ï¼‰å¯è§ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šè®²ï¼Œç¯å¢ƒä¸ä»…æ˜¯ä¸€ç§è¿›ç¨‹é—´é€šä¿¡çš„å½¢å¼ï¼Œè¿˜æ˜¯ç¨‹åºé—´é€šä¿¡çš„æ–¹æ³•ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">putenv</span><span class="params">(<span class="type">char</span> *<span class="built_in">string</span>)</span>;</span><br></pre></td></tr></table></figure><ul><li>stringï¼šå‚æ•° string æ˜¯ä¸€æŒ‡é’ˆï¼ŒæŒ‡å‘ name&#x3D;value å½¢å¼çš„å­—ç¬¦ä¸²ã€‚</li><li>è¿”å›å€¼ï¼šå¦‚æœæˆåŠŸï¼Œåˆ™è¿”å› 0ï¼Œå¦åˆ™è¿”å› é0å€¼ï¼Œå¹¶è®¾ç½® errnoã€‚</li></ul><p>è°ƒç”¨ <code>putenv()</code> å‡½æ•°åï¼Œè¯¥å­—ç¬¦ä¸²å°±æˆä¸ºç¯å¢ƒçš„ä¸€éƒ¨åˆ†ï¼Œæ¢è¨€ä¹‹ï¼Œ<code>putenv</code> å‡½æ•°å°†è®¾å®š <code>environ</code> å˜é‡ä¸­æŸä¸€å…ƒç´ çš„æŒ‡å‘ä¸ <code>string</code> å‚æ•°çš„æŒ‡å‘ä½ç½®ç›¸åŒï¼Œè€Œé <code>string</code> å‚æ•°æ‰€æŒ‡å‘å­—ç¬¦ä¸²çš„å¤åˆ¶å‰¯æœ¬ã€‚</p><h2 id="proc-æ–‡ä»¶ç³»ç»Ÿ"><a href="#proc-æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="proc æ–‡ä»¶ç³»ç»Ÿ"></a>proc æ–‡ä»¶ç³»ç»Ÿ</h2><p>å¯¹äºç³»ç»Ÿä¸­æ¯ä¸ªè¿›ç¨‹ï¼Œå†…æ ¸éƒ½æä¾›äº†ç›¸åº”çš„ç›®å½•ï¼Œå‘½åä¸º<code>/proc/PID</code>ï¼Œå…¶ä¸­ <code>PID</code> æ˜¯è¿›ç¨‹çš„IDã€‚åœ¨æ­¤ç›®å½•ä¸­çš„å„ç§æ–‡ä»¶å’Œå­ç›®å½•åŒ…å«äº†è¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ã€‚</p><p><strong>å¯é€šè¿‡<code>man 5 proc</code>æŸ¥çœ‹å…·ä½“ä»‹ç»</strong>ï¼æè¿°çš„æ‰€æœ‰æ–‡ä»¶çš„ä½œç”¨ä»¥åŠå…¶å†…å®¹çš„å«ä¹‰ã€‚</p><table><thead><tr><th>æ–‡ä»¶</th><th>æè¿°</th></tr></thead><tbody><tr><td>cmdline</td><td>ä»¥\0 åˆ†éš”çš„å‘½ä»¤è¡Œå‚æ•°</td></tr><tr><td>cwd</td><td>æŒ‡å‘å½“å‰å·¥ä½œç›®å½•çš„ç¬¦å·é“¾æ¥</td></tr><tr><td>Environ</td><td>NAME&#x3D;value é”®å€¼å¯¹ç¯å¢ƒåˆ—è¡¨ï¼Œä»¥\0 åˆ†éš”</td></tr><tr><td>exe</td><td>æŒ‡å‘æ­£åœ¨æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·é“¾æ¥</td></tr><tr><td>fd</td><td>æ–‡ä»¶ç›®å½•ï¼ŒåŒ…å«äº†æŒ‡å‘ç”±è¿›ç¨‹æ‰“å¼€æ–‡ä»¶çš„ç¬¦å·é“¾æ¥</td></tr><tr><td>maps</td><td><strong>å†…å­˜æ˜ å°„</strong></td></tr><tr><td>mem</td><td>è¿›ç¨‹è™šæ‹Ÿå†…å­˜ï¼ˆåœ¨ I&#x2F;O æ“ä½œä¹‹å‰å¿…é¡»è°ƒç”¨ <code>lseek()</code>ç§»è‡³æœ‰æ•ˆåç§»é‡ï¼‰</td></tr><tr><td>mounts</td><td>è¿›ç¨‹çš„å®‰è£…ç‚¹</td></tr><tr><td>root</td><td>æŒ‡å‘æ ¹ç›®å½•çš„ç¬¦å·é“¾æ¥</td></tr><tr><td>status</td><td>å„ç§ä¿¡æ¯ï¼ˆæ¯”å¦‚ï¼Œè¿›ç¨‹ IDã€å‡­è¯ã€å†…å­˜ä½¿ç”¨é‡ã€ä¿¡å·ï¼‰</td></tr><tr><td>task</td><td>ä¸ºè¿›ç¨‹ä¸­çš„<strong>æ¯ä¸ªçº¿ç¨‹å‡åŒ…å«ä¸€ä¸ªå­ç›®å½•</strong>ï¼ˆå§‹è‡ª Linux 2.6ï¼‰</td></tr></tbody></table><h3 id="maps"><a href="#maps" class="headerlink" title="maps"></a>maps</h3><table><thead><tr><th>åç§°</th><th>æè¿°</th></tr></thead><tbody><tr><td><code>address</code></td><td>éƒ¨åˆ†æ˜¾ç¤ºçš„æ˜¯è¯¥æ®µæ˜ å°„çš„è™šæ‹Ÿåœ°å€ã€‚</td></tr><tr><td><code>perms</code></td><td>å†…å­˜å—æƒé™ &#96;READ</td></tr><tr><td><code>offset</code></td><td>è¯¥æ®µæ˜ å°„åœ¨æ–‡ä»¶&#x2F;å…¶å®ƒè®¾å¤‡ä¸Šçš„åç§»é‡</td></tr><tr><td><code>dev</code></td><td>è®¾å¤‡å·</td></tr><tr><td><code>inode</code></td><td>æ–‡ä»¶æˆ–è€…è®¾å¤‡çš„<code>inode</code>èŠ‚ç‚¹ï¼Œ0è¡¨ç¤ºæ²¡æœ‰<code>inode</code>ä¸è¯¥æ®µå†…å­˜å…³è”</td></tr><tr><td><code>pathname</code></td><td>è·¯å¾„åæ˜¯ä¸è¯¥æ®µå†…å­˜å…³è”çš„æ–‡ä»¶è·¯å¾„ï¼Œè‹¥ä¸ºç©ºï¼Œå¯èƒ½æ˜¯é€šè¿‡<code>mmap</code>åˆ›å»ºçš„åŒ¿åæ˜ å°„</td></tr><tr><td><code>[stack]</code></td><td>è¿›ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰çš„æ ˆç©ºé—´</td></tr><tr><td><code>[stack:&lt;tid&gt;]</code></td><td>å¯¹åº”çº¿ç¨‹<code>tid</code>çš„æ ˆç©ºé—´</td></tr><tr><td><code>[heap]</code></td><td>è¿›ç¨‹çš„å †ç©ºé—´</td></tr><tr><td><code>[vdso]</code></td><td>virtual dynamic shared objectï¼Œ<code>man 7 vdso</code>æŸ¥çœ‹ä»‹ç»</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ldd debug</span><br><span class="line">linux-vdso.so.1 (0x00007ffc60be6000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f4b7c418000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f4b7c662000)</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cat</span> /proc/19898/maps</span><br><span class="line"><span class="comment"># The format of the file is:</span></span><br><span class="line"><span class="comment"># address                 perms offset  dev    inode        pathname</span></span><br><span class="line">562bc9b9e000-562bc9b9f000 r--p 00000000 103:07 3422919      /tmp/debug</span><br><span class="line">562bc9b9f000-562bc9ba0000 r-xp 00001000 103:07 3422919      /tmp/debug</span><br><span class="line">562bc9ba0000-562bc9ba1000 r--p 00002000 103:07 3422919      /tmp/debug</span><br><span class="line">562bc9ba1000-562bc9ba2000 r--p 00002000 103:07 3422919      /tmp/debug</span><br><span class="line">562bc9ba2000-562bc9ba3000 rw-p 00003000 103:07 3422919      /tmp/debug</span><br><span class="line">562bc9cb2000-562bc9cd3000 rw-p 00000000 00:00  0             [heap]</span><br><span class="line">7f94721de000-7f94721e1000 rw-p 00000000 00:00  0</span><br><span class="line">7f94721e1000-7f9472209000 r--p 00000000 103:07 12847599     /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7f9472209000-7f947239e000 r-xp 00028000 103:07 12847599     /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7f947239e000-7f94723f6000 r--p 001bd000 103:07 12847599     /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7f94723f6000-7f94723fa000 r--p 00214000 103:07 12847599     /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7f94723fa000-7f94723fc000 rw-p 00218000 103:07 12847599     /usr/lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7f94723fc000-7f9472409000 rw-p 00000000 00:00  0</span><br><span class="line">7f9472424000-7f9472426000 rw-p 00000000 00:00  0</span><br><span class="line">7f9472426000-7f9472428000 r--p 00000000 103:07 12847231     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7f9472428000-7f9472452000 r-xp 00002000 103:07 12847231     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7f9472452000-7f947245d000 r--p 0002c000 103:07 12847231     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line"><span class="comment"># è‡ªå·±æ·»åŠ çš„æ–‡ä»¶æ˜ å°„</span></span><br><span class="line">7f947245d000-7f947245e000 rw-p 00000000 103:07 12066390     /tmp/mmap_file1.c</span><br><span class="line"></span><br><span class="line">7f947245e000-7f9472460000 r--p 00037000 103:07 12847231     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line">7f9472460000-7f9472462000 rw-p 00039000 103:07 12847231     /usr/lib/x86_64-linux-gnu/ld-linux-x86-64.so.2</span><br><span class="line"></span><br><span class="line">7fff5f37d000-7fff5f39e000 rw-p 00000000 00:00  0             [stack]</span><br><span class="line">7fff5f3df000-7fff5f3e3000 r--p 00000000 00:00  0             [vvar]</span><br><span class="line">7fff5f3e3000-7fff5f3e5000 r-xp 00000000 00:00  0             [vdso]</span><br><span class="line"></span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp 00000000 00:00 0     [vsyscall]</span><br></pre></td></tr></table></figure><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>ã€ŠLinux&#x2F;Unixç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</li><li>ã€Šæ“ä½œç³»ç»Ÿä¹‹å“²å­¦åŸç† ç¬¬äºŒç‰ˆã€‹</li><li>ã€Šè®¡ç®—æœºä½“ç³»ç»“æ„åŸºç¡€ã€‹</li><li><a href="https://www.cnblogs.com/yungyu16/p/13024626.html">PCB è¿›ç¨‹æ§åˆ¶å—</a></li><li><a href="https://elixir.bootlin.com/linux/v5.4.190/source/include/linux/sched.h#L624">PCB(task_struct)æºç </a></li><li><a href="https://github.com/szza/LearningNote/blob/master/4.%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/3_%E8%BF%9B%E7%A8%8B.md">æ“ä½œç³»ç»Ÿâ€“è¿›ç¨‹</a></li><li><a href="https://www.bilibili.com/video/BV1KE411q7ee?p=77">ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜çš„æ˜ å°„å…³ç³»</a></li><li><a href="https://xiaolincoding.com/os/3_memory/vmem.html#linux-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86">å°æ—codingâ€“ä¸ºä»€ä¹ˆè¦æœ‰è™šæ‹Ÿå†…å­˜ï¼Ÿ</a></li><li><a href="https://xiaolincoding.com/os/4_process/process_base.html">å°æ—codingâ€“è¿›ç¨‹ç®¡ç†</a></li><li><a href="https://www.cnblogs.com/tolimit/p/4530370.html">linuxæºç åˆ†æ - è¿›ç¨‹</a></li><li><a href="https://zhuanlan.zhihu.com/p/266720121">ææ‡‚è¿›ç¨‹ç»„ã€ä¼šè¯ã€æ§åˆ¶ç»ˆç«¯å…³ç³»ï¼Œæ‰èƒ½æ˜ç™½å®ˆæŠ¤è¿›ç¨‹å¦‚ä½•åˆ›å»º</a></li><li><a href="https://blog.csdn.net/qq_31828515/article/details/73849568">è¿›ç¨‹é—´çš„å…³ç³»ä»¥åŠç»ˆç«¯çš„æ¦‚å¿µ</a></li><li>ã€ŠLinuxç³»ç»Ÿç¼–ç¨‹â€”â€”6.4è™šæ‹Ÿå†…å­˜ç®¡ç†ã€‹</li><li><a href="https://blog.csdn.net/sunao2002002/article/details/84132505">&#x2F;proc&#x2F;pid&#x2F;mapsæ–‡ä»¶æ ¼å¼</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> è¿›ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-æ–‡ä»¶</title>
      <link href="/2022/04/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E6%96%87%E4%BB%B6/"/>
      <url>/2022/04/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E6%96%87%E4%BB%B6/</url>
      
        <content type="html"><![CDATA[<p>åº”ç”¨ç¨‹åºçš„ç³»ç»Ÿè°ƒç”¨è¿‡ç¨‹ï¼šåº”ç”¨ç¨‹åº-&gt;åº“å‡½æ•°-&gt;ç³»ç»Ÿè°ƒç”¨-&gt;é©±åŠ¨-&gt;ç¡¬ä»¶ï¼ˆç£ç›˜ã€ç½‘å¡ç­‰ï¼‰</p><h2 id="å†…æ ¸æ€å’Œç”¨æˆ·æ€"><a href="#å†…æ ¸æ€å’Œç”¨æˆ·æ€" class="headerlink" title="å†…æ ¸æ€å’Œç”¨æˆ·æ€"></a>å†…æ ¸æ€å’Œç”¨æˆ·æ€</h2><p>ç°ä»£å¤„ç†å™¨æ¶æ„ä¸€èˆ¬å…è®¸ CPU è‡³å°‘åœ¨ä¸¤ç§ä¸åŒçŠ¶æ€ä¸‹è¿è¡Œï¼Œå³ï¼šç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ï¼ˆæœ‰æ—¶ä¹Ÿç§°ä¹‹ä¸ºç›‘ç®¡æ€ supervisor modeï¼‰ã€‚æ‰§è¡Œç¡¬ä»¶æŒ‡ä»¤å¯ä½¿ CPU åœ¨ä¸¤ç§çŠ¶æ€é—´æ¥å›åˆ‡æ¢ã€‚ä¸ä¹‹å¯¹åº”ï¼Œ<strong>å¯å°†è™šæ‹Ÿå†…å­˜åŒºåŸŸåˆ’åˆ†ï¼ˆæ ‡è®°ï¼‰ä¸ºç”¨æˆ·ç©ºé—´éƒ¨åˆ†æˆ–å†…æ ¸ç©ºé—´éƒ¨åˆ†</strong>ã€‚<strong>åœ¨ç”¨æˆ·æ€ä¸‹è¿è¡Œæ—¶ï¼ŒCPU åªèƒ½è®¿é—®è¢«æ ‡è®°ä¸ºç”¨æˆ·ç©ºé—´çš„å†…å­˜</strong>ï¼Œè¯•å›¾è®¿é—®å±äºå†…æ ¸ç©ºé—´çš„å†…å­˜ä¼šå¼•å‘ç¡¬ä»¶å¼‚å¸¸ã€‚<strong>å½“è¿è¡Œäºæ ¸å¿ƒæ€æ—¶ï¼ŒCPU æ—¢èƒ½è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜ï¼Œä¹Ÿèƒ½è®¿é—®å†…æ ¸ç©ºé—´å†…å­˜</strong>ã€‚</p><p>ä»…å½“å¤„ç†å™¨åœ¨æ ¸å¿ƒæ€è¿è¡Œæ—¶ï¼Œæ‰èƒ½æ‰§è¡ŒæŸäº›ç‰¹å®šæ“ä½œã€‚è¿™æ ·çš„ä¾‹å­åŒ…æ‹¬ï¼šæ‰§è¡Œå®•æœºï¼ˆhaltï¼‰æŒ‡ä»¤å»å…³é—­ç³»ç»Ÿï¼Œè®¿é—®å†…å­˜ç®¡ç†ç¡¬ä»¶ï¼Œä»¥åŠè®¾å¤‡ I&#x2F;O æ“ä½œçš„åˆå§‹åŒ–ç­‰ã€‚å®ç°è€…ä»¬åˆ©ç”¨è¿™ä¸€ç¡¬ä»¶è®¾è®¡ï¼Œå°†æ“ä½œç³»ç»Ÿç½®äºå†…æ ¸ç©ºé—´ã€‚è¿™ç¡®ä¿äº†ç”¨æˆ·è¿›ç¨‹æ—¢ä¸èƒ½è®¿é—®å†…æ ¸æŒ‡ä»¤å’Œæ•°æ®ç»“æ„ï¼Œä¹Ÿæ— æ³•æ‰§è¡Œä¸åˆ©äºç³»ç»Ÿè¿è¡Œçš„æ“ä½œã€‚</p><h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h2><p>ç³»ç»Ÿè°ƒç”¨æ˜¯å—æ§çš„å†…æ ¸å…¥å£ï¼Œå€ŸåŠ©äºè¿™ä¸€æœºåˆ¶ï¼Œè¿›ç¨‹å¯ä»¥è¯·æ±‚å†…æ ¸ä»¥è‡ªå·±çš„åä¹‰å»æ‰§è¡ŒæŸäº›åŠ¨ä½œã€‚ä»¥åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰çš„å½¢å¼ï¼Œå†…æ ¸æä¾›æœ‰ä¸€ç³»åˆ—æœåŠ¡ä¾›ç¨‹åºè®¿é—®ã€‚è¿™åŒ…æ‹¬åˆ›å»ºæ–°è¿›ç¨‹ã€æ‰§è¡Œ I&#x2F;Oï¼Œä»¥åŠä¸ºè¿›ç¨‹é—´é€šä¿¡åˆ›å»ºç®¡é“ç­‰ã€‚</p><ul><li>ç³»ç»Ÿè°ƒç”¨å°†å¤„ç†å™¨ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ï¼Œä»¥ä¾¿ CPU è®¿é—®å—åˆ°ä¿æŠ¤çš„å†…æ ¸å†…å­˜ã€‚</li><li>ç³»ç»Ÿè°ƒç”¨çš„ç»„æˆæ˜¯å›ºå®šçš„ï¼Œæ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½ç”±ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—æ¥æ ‡è¯†ã€‚ï¼ˆç¨‹åºé€šè¿‡åç§°æ¥æ ‡è¯†ç³»ç»Ÿè°ƒç”¨ï¼Œå¯¹è¿™ä¸€ç¼–å·æ–¹æ¡ˆå¾€å¾€ä¸€æ— æ‰€çŸ¥ã€‚ï¼‰</li><li>æ¯ä¸ªç³»ç»Ÿè°ƒç”¨å¯è¾…ä¹‹ä»¥ä¸€å¥—å‚æ•°ï¼Œå¯¹ç”¨æˆ·ç©ºé—´ï¼ˆäº¦å³è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼‰ä¸å†…æ ¸ç©ºé—´ä¹‹é—´ï¼ˆç›¸äº’ï¼‰ä¼ é€’çš„ä¿¡æ¯åŠ ä»¥è§„èŒƒã€‚</li></ul><p>åœ¨æ¢ç©¶ç³»ç»Ÿè°ƒç”¨æ—¶ä¼šåå¤æ¶‰åŠåŸå­æ“ä½œçš„æ¦‚å¿µã€‚<strong>æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨éƒ½æ˜¯ä»¥åŸå­æ“ä½œæ–¹å¼æ‰§è¡Œçš„</strong>ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆè¯´ï¼Œæ˜¯æŒ‡å†…æ ¸ä¿è¯äº†æŸç³»ç»Ÿè°ƒç”¨ä¸­çš„æ‰€æœ‰æ­¥éª¤ä¼šä½œä¸ºç‹¬ç«‹æ“ä½œè€Œä¸€æ¬¡æ€§åŠ ä»¥æ‰§è¡Œï¼Œå…¶é—´ä¸ä¼šä¸ºå…¶ä»–è¿›ç¨‹æˆ–çº¿ç¨‹æ‰€ä¸­æ–­ã€‚</p><h2 id="æ–‡ä»¶ç±»å‹"><a href="#æ–‡ä»¶ç±»å‹" class="headerlink" title="æ–‡ä»¶ç±»å‹"></a>æ–‡ä»¶ç±»å‹</h2><table><thead><tr><th>æ–‡ä»¶ç±»å‹æ ‡è¯†</th><th>æ–‡ä»¶ç±»å‹</th></tr></thead><tbody><tr><td>-</td><td>æ™®é€šæ–‡ä»¶</td></tr><tr><td>d</td><td>ç›®å½•</td></tr><tr><td>l</td><td>ç¬¦å·é“¾æ¥</td></tr><tr><td>sï¼ˆä¼ªæ–‡ä»¶ï¼‰</td><td>å¥—æ¥å­—</td></tr><tr><td>bï¼ˆä¼ªæ–‡ä»¶ï¼‰</td><td>å—è®¾å¤‡</td></tr><tr><td>cï¼ˆä¼ªæ–‡ä»¶ï¼‰</td><td>å­—ç¬¦è®¾å¤‡</td></tr><tr><td>pï¼ˆä¼ªæ–‡ä»¶ï¼‰</td><td>ç®¡é“</td></tr></tbody></table><p>ä¼ªæ–‡ä»¶ä¸å ç”¨ç£ç›˜ç©ºé—´ã€‚</p><h3 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a>æ–‡ä»¶æè¿°ç¬¦</h3><p>æ¯ä¸€ä¸ªè¿›ç¨‹å¯¹åº”ä¸€ä¸ªPCBè¿›ç¨‹æ§åˆ¶å—ï¼ˆä¸€ä¸ªè®°å½•è¿›ç¨‹ä¿¡æ¯çš„ç»“æ„ä½“ï¼‰ï¼ŒPCBä¸­åŒ…å«äº†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ•°ç»„0&#x2F;1&#x2F;2â€¦1023ï¼Œæ¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”è¯¥è¿›ç¨‹æ‰“å¼€çš„ä¸€ä¸ªæ–‡ä»¶ã€‚</p><p><em>å°†æ–‡ä»¶æè¿°ç¬¦æ•°ç»„ç†è§£ä¸ºæŒ‡é’ˆæ•°ç»„ï¼Œæ–‡ä»¶æè¿°ç¬¦ fd å°±æ˜¯æŒ‡é’ˆæ•°ç»„çš„ä¸‹æ ‡ï¼é€šè¿‡å®ƒå¾—åˆ°æŒ‡å‘å¯¹åº”æ–‡ä»¶çš„æŒ‡é’ˆã€‚</em></p><p>å…¶ä¸­ï¼Œ0,1,2æ˜¯é¢„å®šä¹‰äº†çš„ï¼Œ0æ˜¯æ ‡å‡†è¾“å…¥ï¼Œ1æ˜¯æ ‡å‡†è¾“å‡ºï¼Œ2æ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºã€‚</p><p>è¿›ç¨‹é‡Œé¢ç”¨æˆ·æ‰“å¼€çš„æ–‡ä»¶çš„æ–‡ä»¶æè¿°ç¬¦ä»3å¼€å§‹ç¼–å·ã€‚</p><p><strong>ä¸¤ä¸ªä¸åŒçš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè‹¥æŒ‡å‘åŒä¸€æ‰“å¼€æ–‡ä»¶å¥æŸ„ï¼Œå°†å…±äº«åŒä¸€æ–‡ä»¶åç§»é‡</strong>ã€‚å› æ­¤ï¼Œå¦‚æœé€šè¿‡å…¶ä¸­ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥ä¿®æ”¹æ–‡ä»¶åç§»é‡ï¼ˆç”±è°ƒç”¨ <code>read()</code>ã€<code>write()</code>æˆ– <code>lseek()</code>æ‰€è‡´ï¼‰ï¼Œé‚£ä¹ˆä»å¦ä¸€æ–‡ä»¶æè¿°ç¬¦ä¸­ä¹Ÿä¼šè§‚å¯Ÿåˆ°è¿™ä¸€å˜åŒ–ã€‚<strong>æ— è®ºè¿™ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦åˆ†å±äºä¸åŒè¿›ç¨‹ï¼Œè¿˜æ˜¯åŒå±äºä¸€ä¸ªè¿›ç¨‹</strong>ï¼Œæƒ…å†µéƒ½æ˜¯å¦‚æ­¤ã€‚</p><h3 id="dentry-å’Œ-inode"><a href="#dentry-å’Œ-inode" class="headerlink" title="dentry å’Œ inode"></a>dentry å’Œ inode</h3><p>ä¸€ä¸ªæ–‡ä»¶ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œdentry(ç›®å½•é¡¹)å’Œ inodeï¼Œinode æœ¬è´¨æ˜¯ç»“æ„ä½“ï¼Œå­˜å‚¨æ–‡ä»¶çš„å±æ€§ä¿¡æ¯ï¼Œå¦‚ï¼šæƒé™ã€ç±»å‹ã€å¤§å°ã€æ—¶é—´ã€ç”¨æˆ·ã€ç›˜å¿«ä½ç½®ç­‰ã€‚ä¹Ÿå«åšæ–‡ä»¶å±æ€§ç®¡ç†ç»“æ„ï¼Œå¤§å¤šæ•°çš„ inode éƒ½å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œå°‘é‡å¸¸ç”¨ã€è¿‘æœŸä½¿ç”¨çš„ inode ä¼šè¢«ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚</p><p>æ‰€è°“çš„åˆ é™¤æ–‡ä»¶ï¼Œå°±æ˜¯åˆ é™¤ inodeï¼Œä½†æ˜¯æ•°æ®å…¶å®è¿˜æ˜¯åœ¨ç¡¬ç›˜ä¸Šï¼Œä»¥åä¼šè¦†ç›–æ‰ã€‚</p><h3 id="ç¡¬é“¾æ¥ä¸è½¯é“¾æ¥"><a href="#ç¡¬é“¾æ¥ä¸è½¯é“¾æ¥" class="headerlink" title="ç¡¬é“¾æ¥ä¸è½¯é“¾æ¥"></a>ç¡¬é“¾æ¥ä¸è½¯é“¾æ¥</h3><p>é€šè¿‡ç¡¬é“¾æ¥æ–°å»ºçš„æ–‡ä»¶ä¸æ—§æ–‡ä»¶å¯¹åº”åŒä¸€ä¸ª inodeï¼Œåªæ˜¯æ–°å»ºäº† dentryã€‚</p><ul><li>å…·æœ‰ç›¸åŒ inode èŠ‚ç‚¹å·çš„å¤šä¸ªæ–‡ä»¶äº’ä¸ºç¡¬é“¾æ¥æ–‡ä»¶ï¼›</li><li>åªæœ‰åˆ é™¤äº†æºæ–‡ä»¶å’Œæ‰€æœ‰å¯¹åº”çš„ç¡¬é“¾æ¥æ–‡ä»¶ï¼Œæ–‡ä»¶å®ä½“æ‰ä¼šè¢«åˆ é™¤ï¼›</li><li>ç¡¬é“¾æ¥æ–‡ä»¶æ˜¯æ–‡ä»¶çš„å¦ä¸€ä¸ªå…¥å£ï¼›</li></ul><p>è½¯é“¾æ¥åˆ™ç±»å‹äºwindowsä¸Šçš„å¿«æ·æ–¹å¼ï¼Œåˆ é™¤è½¯é“¾æ¥æ–‡ä»¶å®Œå…¨ä¸å½±å“åŸæ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ln</span> oldfile.txt newfile.txt <span class="comment"># åˆ›å»ºç¡¬é“¾æ¥</span></span><br><span class="line"><span class="built_in">ln</span> -s /etc/oldfile.txt newfile.txt <span class="comment"># è½¯é“¾æ¥æ–‡ä»¶åˆ›å»ºæ—¶æœ€å¥½ç”¨ç»å¯¹è·¯å¾„ï¼Œæˆ–è€…æ–‡ä»¶ç§»åŠ¨ä½ç½®åä¼šå¤±æ•ˆ</span></span><br></pre></td></tr></table></figure><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E6%96%87%E4%BB%B6/linux-soft-hard-link-diff.png" alt="img"></p><p>å†·çŸ¥è¯†ï¼š<code>.</code>ã€<code>..</code>ç›®å½•ä¹Ÿæ˜¯é€šè¿‡ç¡¬é“¾æ¥åˆ›å»ºçš„ã€‚<strong>ä½†ä¸æ”¯æŒç”¨æˆ·ä¸ºç›®å½•æ·»åŠ ç¡¬è¿æ¥ï¼</strong></p><p>ä¸èƒ½ä¸ºç›®å½•åˆ›å»ºç¡¬é“¾æ¥ï¼Œä»è€Œé¿å…å‡ºç°ä»¤è¯¸å¤šç³»ç»Ÿç¨‹åºé™·äºæ··ä¹±çš„é“¾æ¥ç¯è·¯ã€‚ä½¿ç”¨ç»‘å®šæŒ‚è½½ï¼ˆbind mountï¼‰å¯ä»¥è·å¾—ä¸ä¸ºç›®å½•åˆ›å»ºç¡¬é“¾æ¥ç›¸ä¼¼çš„æ•ˆæœã€‚</p><h2 id="open-å‡½æ•°"><a href="#open-å‡½æ•°" class="headerlink" title="open å‡½æ•°"></a>open å‡½æ•°</h2><p>æ‰“å¼€æ–‡ä»¶å¹¶è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œå…¶è¿”å›å€¼ä¸ºè¿›ç¨‹æœªç”¨æ–‡ä»¶æè¿°ç¬¦ä¸­æ•°å€¼æœ€å°è€…ï¼</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">open</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="type">int</span> flags, <span class="type">mode_t</span> mode)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/etc/passwd&quot;</span>, O_RDWR|O_CREAT|O_EXCL, <span class="number">0664</span>);</span><br></pre></td></tr></table></figure><ul><li><code>pathname</code>ï¼šæ–‡ä»¶è·¯å¾„</li><li><code>flags</code>ï¼šæŒ‡å®šæ–‡ä»¶çš„æ‰“å¼€æ–¹å¼ï¼Œ<code>O_RDONLY, O_WRONLY, or O_RDWR</code><ul><li><code>O_RDONLY</code>ï¼šåªè¯»</li><li><code>O_WRONLY</code>ï¼šåªå†™</li><li><code>O_RDWR</code>ï¼šè¯»å†™ã€‚æ³¨æ„ <code>O_RDWR</code> å¹¶ä¸ç­‰åŒäº <code>O_RDONLY | O_WRONLY</code>ï¼Œåè€…ï¼ˆæˆ–ç»„åˆï¼‰å±äºé€»è¾‘é”™è¯¯ã€‚<br>æ—©æœŸçš„ UNIX å®ç°ä¸­ä½¿ç”¨æ•°å­— 0ã€1ã€2 è¡¨ç¤ºä¸Šè¿°ä¸‰ä¸ªæ‰“å¼€æ–¹å¼ï¼Œä¸ºäº†ä¸æ—©æœŸç³»ç»Ÿå…¼å®¹ï¼Œé‡‡ç”¨äº†åŒæ ·çš„æ–¹å¼ï¼</li><li><code>O_APPEND</code>ï¼šè‹¥æ–‡ä»¶æœ‰å†…å®¹ï¼Œåœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ </li><li><code>O_TRUNC</code>ï¼šè‹¥æ–‡ä»¶å­˜åœ¨åˆ™æ¸…ç©º</li><li><code>O_CREAT</code>ï¼šè‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»º</li><li><code>O_EXCL</code>ï¼šè‹¥æ–‡ä»¶å­˜åœ¨åˆ™æŠ¥é”™ï¼Œé…åˆ <code>O_CREAT</code> ä½¿ç”¨</li></ul></li><li><code>mode</code>ï¼šflags æŒ‡å®šäº† <code>O_CREAT</code> æ—¶æ‰å¯ä½¿ç”¨ï¼ŒæŒ‡å®šæ–‡ä»¶æƒé™ <code>mode=0664</code>(å…«è¿›åˆ¶æ•°)ï¼Œæ–‡ä»¶æƒé™ <code>= mode &amp; ~umask</code>ã€‚</li><li>è¿”å›å€¼ï¼šæ–‡ä»¶æè¿°ç¬¦ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errnoï¼Œå…¶è¿”å›å€¼ä¸ºè¿›ç¨‹æœªç”¨æ–‡ä»¶æè¿°ç¬¦ä¸­æ•°å€¼æœ€å°è€…ï¼</li></ul><h3 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h3><p>umaskå€¼ç”¨äºè®¾ç½®ç”¨æˆ·åœ¨åˆ›å»ºæ–‡ä»¶æ—¶çš„é»˜è®¤æƒé™ï¼Œå½“æˆ‘ä»¬åœ¨ç³»ç»Ÿä¸­åˆ›å»ºç›®å½•æˆ–æ–‡ä»¶æ—¶ï¼Œç›®å½•æˆ–æ–‡ä»¶æ‰€å…·æœ‰çš„<strong>é»˜è®¤æƒé™å°±æ˜¯ç”±umaskå€¼å†³å®šçš„</strong>ã€‚</p><p>å¯¹äºrootç”¨æˆ·ï¼Œç³»ç»Ÿé»˜è®¤çš„umaskå€¼æ˜¯0022ï¼›å¯¹äºæ™®é€šç”¨æˆ·ï¼Œç³»ç»Ÿé»˜è®¤çš„umaskå€¼æ˜¯0002ã€‚æ‰§è¡Œumaskå‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰ç”¨æˆ·çš„umaskå€¼ã€‚</p><p>umaskå€¼ä¸€å…±æœ‰4ç»„æ•°å­—ï¼Œå…¶ä¸­ç¬¬1ç»„æ•°å­—ç”¨äºå®šä¹‰ç‰¹æ®Šæƒé™ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¸äºˆè€ƒè™‘ï¼Œä¸ä¸€èˆ¬æƒé™æœ‰å…³çš„æ˜¯å3ç»„æ•°å­—ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹äºç›®å½•ï¼Œç”¨æˆ·æ‰€èƒ½æ‹¥æœ‰çš„æœ€å¤§æƒé™æ˜¯777ï¼›å¯¹äºæ–‡ä»¶ï¼Œç”¨æˆ·æ‰€èƒ½æ‹¥æœ‰çš„æœ€å¤§æƒé™æ˜¯ç›®å½•çš„æœ€å¤§æƒé™å»æ‰æ‰§è¡Œæƒé™ï¼Œå³666ã€‚å› ä¸ºxæ‰§è¡Œæƒé™å¯¹äºç›®å½•æ˜¯å¿…é¡»çš„ï¼Œæ²¡æœ‰æ‰§è¡Œæƒé™å°±æ— æ³•è¿›å…¥ç›®å½•ï¼Œè€Œå¯¹äºæ–‡ä»¶åˆ™ä¸å¿…é»˜è®¤èµ‹äºˆxæ‰§è¡Œæƒé™ã€‚</p><p>å¯¹äºrootç”¨æˆ·ï¼Œä»–çš„umaskå€¼æ˜¯022ã€‚å½“rootç”¨æˆ·åˆ›å»ºç›®å½•æ—¶ï¼Œé»˜è®¤çš„æƒé™å°±æ˜¯ç”¨æœ€å¤§æƒé™777å»æ‰ç›¸åº”ä½ç½®çš„umaskå€¼æƒé™ï¼Œå³å¯¹äºæ‰€æœ‰è€…ä¸å¿…å»æ‰ä»»ä½•æƒé™ï¼Œå¯¹äºæ‰€å±ç»„è¦å»æ‰wæƒé™ï¼Œå¯¹äºå…¶ä»–ç”¨æˆ·ä¹Ÿè¦å»æ‰wæƒé™ï¼Œæ‰€ä»¥ç›®å½•çš„é»˜è®¤æƒé™å°±æ˜¯755ï¼›å½“rootç”¨æˆ·åˆ›å»ºæ–‡ä»¶æ—¶ï¼Œé»˜è®¤çš„æƒé™åˆ™æ˜¯ç”¨æœ€å¤§æƒé™666å»æ‰ç›¸åº”ä½ç½®çš„umaskå€¼ï¼Œå³æ–‡ä»¶çš„é»˜è®¤æƒé™æ˜¯644ã€‚</p><h2 id="é”™è¯¯å¤„ç†"><a href="#é”™è¯¯å¤„ç†" class="headerlink" title="é”™è¯¯å¤„ç†"></a>é”™è¯¯å¤„ç†</h2><p>ç³»ç»Ÿè°ƒç”¨çš„å‡½æ•°å‡ºé”™æ—¶ï¼Œé€šå¸¸ä¼šè®¾ç½®å˜é‡<code>errno</code>ï¼Œå¯ä»¥é€šè¿‡åº“å‡½æ•° <code>strerror(errno)</code>å’Œ<code>perror(char *msg)</code>æ¥æŸ¥çœ‹æŠ¥é”™æ•°å­—çš„å«ä¹‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">perror</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> *<span class="title function_">strerror</span><span class="params">(<span class="type">int</span> errnum)</span>;</span><br><span class="line"></span><br><span class="line">fd = open(pathnameï¼Œflagsï¼Œmode);</span><br><span class="line"><span class="keyword">if</span> (fd == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;error: %s \n&quot;, strerror(errno));</span></span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FATLURE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•° <code>perror()</code>ä¼šæ‰“å°å‡ºå…¶ msg å‚æ•°æ‰€æŒ‡å‘çš„å­—ç¬¦ä¸²ï¼Œç´§è·Ÿä¸€æ¡ä¸å½“å‰ errno å€¼ç›¸å¯¹åº”çš„æ¶ˆæ¯ã€‚</p><p>å‡½æ•° <code>strerror()</code>ä¼šé’ˆå¯¹å…¶ errno å‚æ•°ä¸­æ‰€ç»™å®šçš„é”™è¯¯å·ï¼Œè¿”å›ç›¸åº”çš„é”™è¯¯å­—ç¬¦ä¸²ã€‚</p><h2 id="close-å‡½æ•°"><a href="#close-å‡½æ•°" class="headerlink" title="close å‡½æ•°"></a>close å‡½æ•°</h2><p><code>close()</code>ç³»ç»Ÿè°ƒç”¨å…³é—­ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¹¶å°†å…¶é‡Šæ”¾å›è°ƒç”¨è¿›ç¨‹ï¼Œä¾›è¯¥è¿›ç¨‹ç»§ç»­ä½¿ç”¨ã€‚å½“ä¸€è¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œå°†è‡ªåŠ¨å…³é—­å…¶å·²æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">close</span><span class="params">(<span class="type">int</span> fd)</span>;</span><br></pre></td></tr></table></figure><h2 id="read-å‡½æ•°"><a href="#read-å‡½æ•°" class="headerlink" title="read å‡½æ•°"></a>read å‡½æ•°</h2><p>ä»æ–‡ä»¶è¯»å–æ•°æ®ï¼Œè¿”å›è¯»å–çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">100</span>];</span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/etc/file&quot;</span>, O_RDONLY);</span><br><span class="line"><span class="type">ssize_t</span> n = read(fd, buf, <span class="number">100</span>);</span><br></pre></td></tr></table></figure><ul><li><code>fd</code>ï¼šæ–‡ä»¶æè¿°ç¬¦</li><li><code>buf</code>ï¼šç”¨æ¥å­˜æ”¾è¾“å…¥æ•°æ®çš„å†…å­˜ç¼“å†²åŒºåœ°å€ã€‚ç¼“å†²åŒºè‡³å°‘åº”æœ‰ count ä¸ªå­—èŠ‚ã€‚</li><li><code>count</code>ï¼šæŒ‡å®šæœ€å¤šèƒ½è¯»å–çš„å­—èŠ‚æ•°ï¼Œsize_t æ•°æ®ç±»å‹å±äºæ— ç¬¦å·æ•´æ•°ç±»å‹ã€‚</li><li>è¿”å›å€¼ï¼šssize_t æ•°æ®ç±»å‹å±äºæœ‰ç¬¦å·çš„æ•´æ•°ç±»å‹<ul><li><code>&gt;0</code>ï¼Œè¯»å–çš„å­—èŠ‚æ•°ï¼›</li><li><code>=0</code>ï¼Œè¯»åˆ°æ–‡ä»¶æœ«å°¾ï¼ˆEOFï¼‰ï¼›</li><li><code>-1</code>ï¼Œè¯»å–å¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><h2 id="write-å‡½æ•°"><a href="#write-å‡½æ•°" class="headerlink" title="write å‡½æ•°"></a>write å‡½æ•°</h2><p>å‘æ–‡ä»¶å†™å…¥æ•°æ®ï¼Œè¿”å›å®é™…å†™å…¥çš„å­—èŠ‚æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">char</span> buf[<span class="number">100</span>] = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/etc/file&quot;</span>, O_RDWR);</span><br><span class="line"><span class="type">ssize_t</span> n = write(fd, buf, <span class="built_in">strlen</span>(buf));</span><br></pre></td></tr></table></figure><ul><li>fdï¼šæ–‡ä»¶æè¿°ç¬¦</li><li>bufï¼šè¦å†™å…¥çš„æ•°æ®çš„å†…å­˜åœ°å€</li><li>countï¼šæ¬²ä» buffer å†™å…¥æ–‡ä»¶çš„æ•°æ®å­—èŠ‚æ•°</li><li>è¿”å›å€¼ï¼š<ul><li><code>&gt;0</code>ï¼Œå†™å…¥çš„å­—èŠ‚æ•°ï¼›</li><li>-1ï¼Œå†™å…¥å¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><h3 id="ç¼“å†²åŒº"><a href="#ç¼“å†²åŒº" class="headerlink" title="ç¼“å†²åŒº"></a>ç¼“å†²åŒº</h3><p>æ¯è°ƒç”¨ä¸€æ¬¡<code>write()</code>ï¼Œå°±ä¼šè¿›è¡Œä¸€æ¬¡å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢ï¼Œå¦‚æœé¢‘ç¹è°ƒç”¨ä¸”æ¯æ¬¡å†™å…¥çš„æ•°é‡ä¸å¤§ï¼Œå¯ä»¥ä½¿ç”¨ç¼“å†²åŒºï¼Œæé«˜æ€§èƒ½ã€‚</p><p>åº“å‡½æ•°ä¸­çš„<code>fputc()</code>å’Œ<code>fputs()</code>å‡½æ•°ï¼Œå°±ä½¿ç”¨äº†ç¼“å†²åŒºï¼ˆé»˜è®¤å¤§å°4096byteï¼‰ï¼Œä»¥æé«˜æ€§èƒ½ã€‚</p><p><strong>æ‰€ä»¥ç³»ç»Ÿå‡½æ•°å¹¶ä¸æ˜¯ä¸€å®šæ¯”åº“å‡½æ•°ç‰›é€¼ï¼Œèƒ½ä½¿ç”¨åº“å‡½æ•°çš„åœ°æ–¹å°±ä½¿ç”¨åº“å‡½æ•°ã€‚</strong></p><p>æ³¨æ„ï¼Œå°†æ—¥å¿—å†™å…¥åˆ°æ–‡ä»¶æ—¶ï¼Œå¯¹ç¼“å†²åŒºçš„å¤„ç†ä¸è¾“å‡ºåˆ°ç»ˆç«¯ä¸ä¸€æ ·ã€‚<strong>å½“è¾“å‡ºåˆ°æ–‡ä»¶æ—¶ï¼Œåªæœ‰å½“ç¼“å†²åŒºæ»¡çš„æ—¶å€™ï¼Œæ‰å›çœŸæ­£è¾“å‡ºç¼“å†²åŒºçš„å†…å®¹ï¼Œå¹¶æ¸…ç©ºç¼“å†²åŒº</strong>ã€‚å½“è¾“å‡ºåˆ°å±å¹•æ—¶ï¼Œ<em>é™¤äº†ç¼“å†²åŒºæ»¡å¤–ï¼Œé‡åˆ°â€™\nâ€™ä¼šè‡ªåŠ¨æ¸…ç©ºç¼“å†²åŒºï¼Œå¦å¤–è¯»å…¥å†…å®¹ä¹Ÿä¼šæ¸…ç©ºç¼“å†²åŒº</em>ã€‚å½“å†™å…¥åˆ°æ–‡ä»¶æ—¶ï¼Œå¾€å¾€éœ€è¦æ˜¾ç¤ºè°ƒç”¨ <code>fflush()</code>;</p><h2 id="lseek-å‡½æ•°"><a href="#lseek-å‡½æ•°" class="headerlink" title="lseek å‡½æ•°"></a>lseek å‡½æ•°</h2><p>å¯¹äºæ¯ä¸ªæ‰“å¼€çš„æ–‡ä»¶ï¼Œç³»ç»Ÿå†…æ ¸ä¼šè®°å½•å…¶æ–‡ä»¶åç§»é‡ï¼Œæœ‰æ—¶ä¹Ÿå°†æ–‡ä»¶åç§»é‡ç§°ä¸ºè¯»å†™åç§»é‡æˆ–æŒ‡é’ˆã€‚æ–‡ä»¶åç§»é‡æ˜¯æŒ‡æ‰§è¡Œä¸‹ä¸€ä¸ª <code>read()</code>æˆ– <code>write()</code>æ“ä½œçš„æ–‡ä»¶èµ·å§‹ä½ç½®ï¼Œä¼šä»¥ç›¸å¯¹äºæ–‡ä»¶å¤´éƒ¨èµ·å§‹ç‚¹çš„æ–‡ä»¶å½“å‰ä½ç½®æ¥è¡¨ç¤ºã€‚æ–‡ä»¶ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åç§»é‡ä¸º 0ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">off_t</span> <span class="title function_">lseek</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> offset, <span class="type">int</span> whence)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">char</span> msg[<span class="number">100</span>] = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/etc/file&quot;</span>, O_RDWR);</span><br><span class="line"><span class="type">ssize_t</span> n = write(fd, msg, <span class="built_in">strlen</span>(msg));</span><br><span class="line">lseek(fd, <span class="number">100</span>, SEEK_END); <span class="comment">// æ‹“å±•æ–‡ä»¶å¤§å° 100 byte</span></span><br><span class="line">write(fd, <span class="string">&quot;\0&quot;</span>, <span class="number">1</span>); <span class="comment">// å†™å…¥ä¸€ä¸ªç©ºå­—ç¬¦ï¼Œä¸è¿›è¡Œæ“ä½œå°±æ— æ³•æ‹“å±•æ–‡ä»¶å¤§å°</span></span><br><span class="line">lseek(fd, <span class="number">0</span>, SEEK_SET); <span class="comment">// è®¾ç½®æ–‡ä»¶æŒ‡é’ˆåˆ°æ–‡ä»¶å¼€å¤´</span></span><br><span class="line">read(fd, msg, n);</span><br></pre></td></tr></table></figure><ul><li><code>fd</code>ï¼šæ–‡ä»¶æè¿°ç¬¦</li><li><code>offset</code>ï¼šåç§»é‡ï¼Œå°†è¯»å†™æŒ‡é’ˆä» whence æŒ‡å®šä½ç½®å‘ååç§» offset ä¸ªå•ä½</li><li><code>whence</code>ï¼šèµ·å§‹åç§»ä½ç½®ï¼Œå¯ä»¥æ˜¯ <code>SEEK_SET</code>ï¼ˆæ–‡ä»¶å¼€å¤´ï¼‰ï¼Œ<code>SEEK_CUR</code>ï¼ˆå½“å‰ä½ç½®ï¼‰ï¼Œ<code>SEEK_END</code>ï¼ˆæ–‡ä»¶æœ«å°¾ï¼‰</li><li>è¿”å›å€¼ï¼šæ–‡ä»¶æŒ‡é’ˆçš„æ–°ä½ç½®ï¼Œè‹¥å¤±è´¥åˆ™è¿”å›-1å¹¶è®¾ç½®errno</li></ul><p>è·å–æ–‡ä»¶åç§»é‡çš„å½“å‰ä½ç½®ï¼š<code>curr = lseek(fdï¼Œ0ï¼ŒSEEK_CUR);</code></p><p>åº”ç”¨åœºæ™¯ï¼š</p><ol><li>ä½¿ç”¨ <code>lseek</code> è·å–æ–‡ä»¶å¤§å°</li><li>ä½¿ç”¨ <code>lseek</code> æ‹“å±•æ–‡ä»¶å¤§å°ï¼Œä½†è¦æƒ³ä½¿æ–‡ä»¶å¤§å°çœŸæ­£æ‹“å±•ï¼Œå¿…é¡»è¿›è¡Œå†™æ“ä½œã€‚ä¹Ÿå¯ä½¿ç”¨ <code>truncate</code> å‡½æ•°ï¼Œç›´æ¥æ‹“å±•æ–‡ä»¶</li></ol><h2 id="truncate-x2F-ftruncate-å‡½æ•°"><a href="#truncate-x2F-ftruncate-å‡½æ•°" class="headerlink" title="truncate&#x2F;ftruncate å‡½æ•°"></a>truncate&#x2F;ftruncate å‡½æ•°</h2><p>è®¾ç½®æ–‡ä»¶ä¸ºæŒ‡å®šå¤§å°ï¼Œè‹¥æ–‡ä»¶å¤§å°å¤§äºæŒ‡å®šå€¼æ—¶ï¼Œä¼šæˆªæ–­åˆ°æŒ‡å®šå¤§å°ã€‚å°äºæ—¶ï¼Œä¼šåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ç©ºå­—ç¬¦ã€‚</p><p>æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–æ–‡ä»¶æ²¡æœ‰å†™æƒé™ï¼Œè¿”å› -1ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">truncate</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="type">off_t</span> length)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">ftruncate</span><span class="params">(<span class="type">int</span> fd, <span class="type">off_t</span> length)</span>;</span><br></pre></td></tr></table></figure><ul><li><code>path</code>ï¼šæ–‡ä»¶è·¯å¾„</li><li><code>length</code>ï¼šæŒ‡å®šæ–‡ä»¶å¤§å°ï¼Œè‹¥æ–‡ä»¶å½“å‰é•¿åº¦å¤§äºå‚æ•° lengthï¼Œè°ƒç”¨å°†ä¸¢å¼ƒè¶…å‡ºéƒ¨åˆ†ï¼Œè‹¥å°äºå‚æ•° lengthï¼Œè°ƒç”¨å°†åœ¨æ–‡ä»¶å°¾éƒ¨æ·»åŠ ä¸€ç³»åˆ—ç©ºå­—èŠ‚æˆ–æ˜¯ä¸€ä¸ªæ–‡ä»¶ç©ºæ´ã€‚</li><li>è¿”å›å€¼ï¼š<ul><li>0ï¼ŒæˆåŠŸï¼›</li><li>-1ï¼Œå¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li><li><code>fd</code>ï¼šè¦ä¿®æ”¹çš„æ–‡ä»¶æè¿°ç¬¦ã€‚è¯¥ç³»ç»Ÿè°ƒç”¨ä¸ä¼šä¿®æ”¹æ–‡ä»¶åç§»é‡ï¼</li></ul><p>ç¼–è¯‘æ—¶ä½¿ç”¨<code>-std=c99</code>ä¼šæŠ¥è­¦å‘Šï¼Œå¯ä»¥ä½¿ç”¨<code>-std=gnu99</code>æ¥å…¼å®¹ã€‚</p><h2 id="fcntl-å‡½æ•°"><a href="#fcntl-å‡½æ•°" class="headerlink" title="fcntl å‡½æ•°"></a>fcntl å‡½æ•°</h2><p><code>fcntl()</code>ç³»ç»Ÿè°ƒç”¨å¯¹ä¸€ä¸ªæ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œä¸€ç³»åˆ—æ§åˆ¶æ“ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fcntl</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> cmd, ... <span class="comment">/* arg */</span> )</span>;</span><br></pre></td></tr></table></figure><ul><li><code>cmd</code> å‚æ•°æ‰€æ”¯æŒçš„æ“ä½œèŒƒå›´å¾ˆå¹¿ã€‚</li><li>ç¬¬ä¸‰ä¸ªå‚æ•°ä»¥çœç•¥å·æ¥è¡¨ç¤ºï¼Œè¿™æ„å‘³ç€å¯ä»¥å°†å…¶è®¾ç½®ä¸ºä¸åŒçš„ç±»å‹ï¼Œæˆ–è€…åŠ ä»¥çœç•¥ã€‚å†…æ ¸ä¼šä¾æ® cmd å‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰çš„å€¼æ¥ç¡®å®šè¯¥å‚æ•°çš„æ•°æ®ç±»å‹ã€‚</li></ul><h2 id="pread-x2F-pwrite-å‡½æ•°"><a href="#pread-x2F-pwrite-å‡½æ•°" class="headerlink" title="pread&#x2F;pwrite å‡½æ•°"></a>pread&#x2F;pwrite å‡½æ•°</h2><p>ç³»ç»Ÿè°ƒç”¨ <code>pread()</code> å’Œ <code>pwrite()</code> å®Œæˆä¸ <code>read()</code> å’Œ <code>write()</code> ç›¸ç±»ä¼¼çš„å·¥ä½œï¼Œ<strong>åªæ˜¯å‰ä¸¤è€…ä¼šåœ¨ <code>offset</code> å‚æ•°æ‰€æŒ‡å®šçš„ä½ç½®</strong>è¿›è¡Œæ–‡ä»¶ I&#x2F;O æ“ä½œï¼Œè€Œéå§‹äºæ–‡ä»¶çš„å½“å‰åç§»é‡å¤„ï¼Œä¸”<strong>å®ƒä»¬ä¸ä¼šæ”¹å˜æ–‡ä»¶çš„å½“å‰åç§»é‡</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pread</span><span class="params">(<span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> count, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"><span class="type">ssize_t</span> <span class="title function_">pwrite</span><span class="params">(<span class="type">int</span> fd, <span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> count, <span class="type">off_t</span> offset)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pread(O)è°ƒç”¨ç­‰åŒäºå°†å¦‚ä¸‹è°ƒç”¨çº³å…¥åŒä¸€åŸå­æ“ä½œ:</span></span><br><span class="line"><span class="type">off_t</span> orig;</span><br><span class="line"></span><br><span class="line">orig = lseek(fdï¼Œ<span class="number">0</span>ï¼ŒSEEK_CUR);   /# Save CUITITent offset *#/</span><br><span class="line">lseek(fdï¼Œoffsetï¼ŒSEEK_SET);</span><br><span class="line">s = read(fdï¼Œbufï¼Œlen);</span><br><span class="line">lseek(fdï¼Œorigï¼ŒSEEK_SET);       /# Restore original file offset *#/</span><br></pre></td></tr></table></figure><ul><li><code>offset</code>: åœ¨æŒ‡å®šçš„ä½ç½®è¿›è¡Œæ–‡ä»¶ I&#x2F;O æ“ä½œ</li></ul><p>è¯¥å‡½æ•°åœ¨å¤šçº¿ç¨‹ä¸‹æœ‰ç”¨æ­¦ä¹‹åœ°ï¼Œå½“è°ƒç”¨ <code>pread()</code> æˆ– <code>pwrite()</code> æ—¶ï¼Œå¤šä¸ªçº¿ç¨‹å¯åŒæ—¶å¯¹åŒä¸€æ–‡ä»¶æè¿°ç¬¦æ‰§è¡Œ I&#x2F;O æ“ä½œï¼Œä¸”ä¸ä¼šå› å…¶ä»–çº¿ç¨‹ä¿®æ”¹æ–‡ä»¶åç§»é‡è€Œå—åˆ°å½±å“ã€‚</p><h2 id="stat-å‡½æ•°"><a href="#stat-å‡½æ•°" class="headerlink" title="stat å‡½æ•°"></a>stat å‡½æ•°</h2><p>è·å–æ–‡ä»¶å±æ€§ï¼Œä» inode ç»“æ„ä½“ä¸­è·å–ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">stat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="keyword">struct</span> stat *statbuf)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">fstat</span><span class="params">(<span class="type">int</span> fd, <span class="keyword">struct</span> stat *statbuf)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">lstat</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname, <span class="keyword">struct</span> stat *statbuf)</span>;</span><br></pre></td></tr></table></figure><ul><li>pathnameï¼šæ–‡ä»¶è·¯å¾„</li><li>statbufï¼šå­˜å‚¨æ–‡ä»¶å±æ€§çš„ç»“æ„ä½“ï¼Œinode ç»“æ„ä½“ä¸­çš„å±æ€§ä¿¡æ¯éƒ½ä¼šè¢«å­˜å‚¨åˆ° statbuf ä¸­</li><li>è¿”å›å€¼ï¼š<ul><li>0ï¼ŒæˆåŠŸï¼›</li><li>-1ï¼Œå¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><p><code>fstat</code>ä¸<code>stat</code>ç­‰ä»·ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸ºæ–‡ä»¶æè¿°ç¬¦ã€‚</p><p><code>lstat</code>ä¸<code>stat</code>ç­‰ä»·ï¼Œåªæ˜¯ä¼ å…¥çš„æ–‡ä»¶ç±»å‹ä¸º<strong>ç¬¦å·é“¾æ¥</strong>æ—¶ï¼Œè¿”å›çš„æ–‡ä»¶ä¿¡æ¯æ˜¯ç¬¦å·é“¾æ¥æœ¬èº«çš„ä¿¡æ¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> &#123;</span></span><br><span class="line">    <span class="type">dev_t</span>     st_dev;         <span class="comment">/* ID of device containing file */</span></span><br><span class="line">    <span class="type">ino_t</span>     st_ino;         <span class="comment">/* Inode number */</span></span><br><span class="line">    <span class="type">mode_t</span>    st_mode;        <span class="comment">/* File type and mode */</span></span><br><span class="line">    <span class="type">nlink_t</span>   st_nlink;       <span class="comment">/* Number of hard links */</span></span><br><span class="line">    <span class="type">uid_t</span>     st_uid;         <span class="comment">/* User ID of owner */</span></span><br><span class="line">    <span class="type">gid_t</span>     st_gid;         <span class="comment">/* Group ID of owner */</span></span><br><span class="line">    <span class="type">dev_t</span>     st_rdev;        <span class="comment">/* Device ID (if special file) */</span></span><br><span class="line">    <span class="type">off_t</span>     st_size;        <span class="comment">/* Total size, in bytes */</span></span><br><span class="line">    <span class="type">blksize_t</span> st_blksize;     <span class="comment">/* Block size for filesystem I/O */</span></span><br><span class="line">    <span class="type">blkcnt_t</span>  st_blocks;      <span class="comment">/* Number of 512B blocks allocated */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_atim</span>;</span>  <span class="comment">/* Time of last access */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_mtim</span>;</span>  <span class="comment">/* Time of last modification */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">st_ctim</span>;</span>  <span class="comment">/* Time of last status change */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ–‡ä»¶ç±»å‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (sb.st_mode &amp; S_IFMT) &#123;</span><br><span class="line">    <span class="keyword">case</span> S_IFBLK:  <span class="built_in">printf</span>(<span class="string">&quot;block device\n&quot;</span>);            <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> S_IFCHR:  <span class="built_in">printf</span>(<span class="string">&quot;character device\n&quot;</span>);        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> S_IFDIR:  <span class="built_in">printf</span>(<span class="string">&quot;directory\n&quot;</span>);               <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> S_IFIFO:  <span class="built_in">printf</span>(<span class="string">&quot;FIFO/pipe\n&quot;</span>);               <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> S_IFLNK:  <span class="built_in">printf</span>(<span class="string">&quot;symlink\n&quot;</span>);                 <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> S_IFREG:  <span class="built_in">printf</span>(<span class="string">&quot;regular file\n&quot;</span>);            <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> S_IFSOCK: <span class="built_in">printf</span>(<span class="string">&quot;socket\n&quot;</span>);                  <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:       <span class="built_in">printf</span>(<span class="string">&quot;unknown?\n&quot;</span>);                <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">if</span> (S_ISDIR(sb.st_mode)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;directory\n&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISREG(sb.st_mode)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;regular file\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="link-å‡½æ•°"><a href="#link-å‡½æ•°" class="headerlink" title="link å‡½æ•°"></a>link å‡½æ•°</h2><p>ç¡¬é“¾æ¥æ•°å°±æ˜¯ dentry æ•°ç›®ï¼Œlink å°±æ˜¯ç”¨æ¥åˆ›å»ºç¡¬é“¾æ¥çš„ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">link</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *oldpath, <span class="type">const</span> <span class="type">char</span> *newpath)</span>;</span><br></pre></td></tr></table></figure><ul><li>oldpathï¼šæ—§æ–‡ä»¶è·¯å¾„</li><li>newpathï¼šæ–°æ–‡ä»¶è·¯å¾„</li><li>è¿”å›å€¼ï¼š<ul><li>0ï¼ŒæˆåŠŸï¼›</li><li>-1ï¼Œå¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><h2 id="unlink-å‡½æ•°"><a href="#unlink-å‡½æ•°" class="headerlink" title="unlink å‡½æ•°"></a>unlink å‡½æ•°</h2><p>åˆ é™¤ä¸€ä¸ªæ–‡ä»¶çš„ç›®å½•é¡¹ dentryï¼Œä½¿ç¡¬é“¾æ¥æ•°-1ã€‚</p><p>æ¸…é™¤æ–‡ä»¶æ—¶ï¼Œå¦‚æœæ–‡ä»¶çš„ç¡¬é“¾æ¥æ•°åˆ° 0 äº†ï¼Œæ²¡æœ‰ dentry å¯¹åº”ï¼Œä½†è¯¥æ–‡ä»¶ä»ä¸ä¼šé©¬ä¸Šè¢«é‡Šæ”¾ï¼Œè¦ç­‰åˆ°æ‰€æœ‰æ‰“å¼€æ–‡ä»¶çš„è¿›ç¨‹å…³é—­è¯¥æ–‡ä»¶ï¼Œç³»ç»Ÿæ‰ä¼šæŒ‘æ—¶é—´å°†è¯¥æ–‡ä»¶é‡Šæ”¾æ‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">unlink</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *pathname)</span>;</span><br></pre></td></tr></table></figure><ul><li>pathnameï¼šæ–‡ä»¶è·¯å¾„</li><li>è¿”å›å€¼ï¼š<ul><li><code>0</code>ï¼ŒæˆåŠŸï¼›</li><li><code>-1</code>ï¼Œå¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><h2 id="dup-å‡½æ•°"><a href="#dup-å‡½æ•°" class="headerlink" title="dup å‡½æ•°"></a>dup å‡½æ•°</h2><p>å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦åˆ°æœªä½¿ç”¨çš„æœ€å°ç¼–å·çš„æè¿°ç¬¦ä¸­ã€‚</p><p>å¤åˆ¶åï¼Œæ–°æ—§æè¿°ç¬¦éƒ½å¯ä½¿ç”¨ï¼Œå¹¶ä¸”å…±äº«æ–‡ä»¶æŒ‡é’ˆåç§»å’Œæ–‡ä»¶çŠ¶æ€æ ‡å¿—ç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup</span><span class="params">(<span class="type">int</span> oldfd)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;./test.txt&quot;</span>, O_RDWR|O_CREAT);</span><br><span class="line"><span class="type">int</span> newfd = dup(fd);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;fd: %d, newfd: %d\n&quot;</span>, fd, newfd); <span class="comment">// fd: 3, newfd: 4</span></span><br></pre></td></tr></table></figure><ul><li><code>oldfd</code>ï¼šæ—§æ–‡ä»¶æè¿°ç¬¦</li><li>è¿”å›å€¼ï¼š<ul><li>æ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼›</li><li>-1ï¼Œå¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><h2 id="dup2-å‡½æ•°"><a href="#dup2-å‡½æ•°" class="headerlink" title="dup2 å‡½æ•°"></a>dup2 å‡½æ•°</h2><p>ä¸dupå‡½æ•°ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒæ˜¯å°†æ–‡ä»¶æè¿°ç¬¦å¤åˆ¶åˆ°æŒ‡å®šç¼–å·çš„æ–‡ä»¶æè¿°ç¬¦ã€‚å¤åˆ¶å‰å®ƒä¼šè‡ªåŠ¨è°ƒç”¨ <code>close(newfd)</code>ã€‚</p><p>åŒæ ·çš„ï¼Œå¤åˆ¶åæ–°æ—§æè¿°ç¬¦éƒ½å¯ä½¿ç”¨ï¼Œå¹¶ä¸”å…±äº«æ–‡ä»¶æŒ‡é’ˆåç§»å’Œæ–‡ä»¶çŠ¶æ€æ ‡å¿—ç­‰ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">dup2</span><span class="params">(<span class="type">int</span> oldfd, <span class="type">int</span> newfd)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// example</span></span><br><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;./test.txt&quot;</span>, O_RDWR|O_CREAT);</span><br><span class="line"><span class="type">int</span> newfd = dup2(fd, STDOUT_FILENO); <span class="comment">// å°†æ ‡å‡†è¾“å‡ºç­‰é‡å®šå‘åˆ°æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><ul><li>oldfdï¼šæ—§æ–‡ä»¶æè¿°ç¬¦</li><li>newfdï¼šæ–°æ–‡ä»¶æè¿°ç¬¦</li><li>è¿”å›å€¼ï¼š<ul><li>æ–°çš„æ–‡ä»¶æè¿°ç¬¦ï¼›</li><li>-1ï¼Œå¤±è´¥ï¼Œé”™è¯¯ç å­˜å‚¨åœ¨errnoä¸­ï¼›</li></ul></li></ul><p>è®© newfd æŒ‡å‘ oldfdï¼Œä¹Ÿå°±æ˜¯è¯´æ— è®ºå†™newfdè¿˜æ˜¯oldfdï¼Œéƒ½ä¼šå†™åˆ°oldfdã€‚</p><h2 id="ioctl-å‡½æ•°"><a href="#ioctl-å‡½æ•°" class="headerlink" title="ioctl å‡½æ•°"></a>ioctl å‡½æ•°</h2><p>å¯ç”¨äºå‘å†…æ ¸ä¼ é€’ä»»æ„ç±»å‹çš„æ•°æ®ã€‚ä¹Ÿæ˜¯ä¸€ç§å†…æ ¸æ€å’Œç”¨æˆ·æ€é€šä¿¡çš„æ–¹å¼ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">ioctl</span><span class="params">(<span class="type">int</span> fd, <span class="type">unsigned</span> <span class="type">long</span> request, ...)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å†…æ ¸ä¸­çš„å¯¹åº”å‡½æ•°åŸå‹ä¸º</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">module_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br></pre></td></tr></table></figure><ul><li><code>fd</code>ï¼šä¸è®¾å¤‡é©±åŠ¨é€šä¿¡æ—¶ï¼Œè¯¥<code>fd</code>é€šå¸¸è¡¨ç¤º<code>/dev/</code>ç›®å½•ä¸‹çš„æŸä¸ªæ–‡ä»¶</li><li><code>request</code>&#x2F;<code>cmd</code>ï¼šè¡¨ç¤ºæ“ä½œç±»å‹ï¼Œä¹Ÿç”¨äºåˆ¤æ–­å¦‚ä½•å¤„ç†åç»­å‚æ•°</li><li><code>arg</code>ï¼šåœ¨å†…æ ¸ä¸­ <code>unsigned long</code> å’Œ <code>void *</code> æ˜¯ç­‰ä»·çš„ï¼Œæ‰€ä»¥è¿™é‡Œæ—¢å¯ä»¥è¡¨ç¤ºç”¨æˆ·æ€ä¼ å…¥çš„æŒ‡é’ˆå˜é‡ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºæ™®é€šçš„æ•´å½¢å˜é‡</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">attrs</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">&#125; attrs;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="title function_">scull_ioctl</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> err = <span class="number">0</span>, tmp;</span><br><span class="line">attrs kdata;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_INT:</span><br><span class="line">            tmp = arg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IOCTL_POINTER:</span><br><span class="line">            copy_from_user(&amp;kdata, (attrs *)arg, <span class="keyword">sizeof</span>(attrs));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¾‹å­ä¸­çš„ <code>IOCTL_INT</code> <code>IOCTL_POINTER</code> ç”±å„ä¸ªæ¨¡å—è‡ªè¡Œè®¾è®¡ã€‚</p><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><ul><li><a href="https://blog.51cto.com/u_3078781/3287065"><strong>Linuxç³»ç»Ÿè°ƒç”¨åˆ—è¡¨</strong></a></li><li>ã€ŠLINUX ç³»ç»Ÿç¼–ç¨‹æ‰‹å†Œã€‹</li></ul>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> æ–‡ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxç³»ç»Ÿç¼–ç¨‹-é™æ€åº“åŠ¨æ€åº“</title>
      <link href="/2022/04/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E9%9D%99%E6%80%81%E5%BA%93%E5%8A%A8%E6%80%81%E5%BA%93/"/>
      <url>/2022/04/24/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E9%9D%99%E6%80%81%E5%BA%93%E5%8A%A8%E6%80%81%E5%BA%93/</url>
      
        <content type="html"><![CDATA[<p>é™æ€åº“æ–‡ä»¶åæ ¼å¼ä¸ºï¼š<code>lib&#123;name&#125;.a</code>ï¼Œåªæœ‰ {name} éƒ¨åˆ†å¯è‡ªå®šä¹‰ã€‚</p><p>åŠ¨æ€åº“æ–‡ä»¶åæ ¼å¼ä¸ºï¼š<code>lib&#123;name&#125;.so</code>ï¼Œåªæœ‰ {name} éƒ¨åˆ†å¯è‡ªå®šä¹‰ã€‚</p><p>é™æ€åº“å’ŒåŠ¨æ€åº“çš„åŒºåˆ«ï¼š</p><ul><li>é™æ€åº“ä¼šè¢«é“¾æ¥åˆ°ç¨‹åºä¸­ï¼Œè€ŒåŠ¨æ€åº“åˆ™åªè®°å½•äº†åº“çš„åç§°ï¼Œç¨‹åºè¿è¡Œæ—¶æ‰å»å¯¹åº”çš„è·¯å¾„ä¸­åŠ è½½åº“ã€‚</li><li>é™æ€åº“åŠ è½½é€Ÿåº¦å¿«ï¼Œä½†è¾ƒæ¶ˆè€—å†…å­˜ï¼ŒåŠ¨æ€åº“åˆ™ç›¸åã€‚</li></ul><h2 id="gcc-ç¼–è¯‘æµç¨‹"><a href="#gcc-ç¼–è¯‘æµç¨‹" class="headerlink" title="gcc ç¼–è¯‘æµç¨‹"></a>gcc ç¼–è¯‘æµç¨‹</h2><p><img src="/../images/Linux%E7%B3%BB%E7%BB%9F%E7%BC%96%E7%A8%8B-%E9%9D%99%E6%80%81%E5%BA%93%E5%8A%A8%E6%80%81%E5%BA%93/image-20220331155734904.png" alt="image-20220331155734904"></p><ul><li><code>-I</code> æŒ‡å®šå¤´æ–‡ä»¶æ‰€åœ¨ç›®å½•ä½ç½®</li><li><code>-c</code> åªåšé¢„å¤„ç†ï¼Œç¼–è¯‘ï¼Œæ±‡ç¼–ã€‚å¾—åˆ°äºŒè¿›åˆ¶æ–‡ä»¶</li><li><code>-g</code> ç¼–è¯‘æ—¶æ·»åŠ è°ƒè¯•æ–‡ä»¶ï¼Œç”¨äº gdb è°ƒè¯•</li><li><code>-Wall</code> æ˜¾ç¤ºæ‰€æœ‰è­¦å‘Šä¿¡æ¯</li><li><code>-D</code> å‘ç¨‹åºä¸­â€œåŠ¨æ€â€æ³¨å†Œå®å®šä¹‰</li><li><code>-l</code> æŒ‡å®šåŠ¨æ€åº“åº“å</li><li><code>-L</code> æŒ‡å®šåŠ¨æ€åº“è·¯å¾„</li><li><code>-O0</code> å…³é—­ä¼˜åŒ– (é»˜è®¤)</li><li><code>-O1/-O</code> è®©å¯æ‰§â¾â½‚ä»¶æ›´â¼©ï¼Œé€Ÿåº¦æ›´å¿«</li><li><code>-O2</code> é‡‡â½¤â¼ä¹æ‰€æœ‰çš„ä¼˜åŒ–â¼¿æ®µ</li></ul><h2 id="é™æ€åº“"><a href="#é™æ€åº“" class="headerlink" title="é™æ€åº“"></a>é™æ€åº“</h2><p>é™æ€åº“åœ¨ç”Ÿæˆæ—¶åº”æä¾›ä¸€ä¸ªå¤´æ–‡ä»¶ï¼ˆåŒ…å«å‡½æ•°å£°æ˜ï¼‰ï¼Œä»¥ä¾¿å…¶ä»–äººçŸ¥æ™“åº“æä¾›çš„æ–¹æ³•ï¼Œæ–¹ä¾¿ä½¿ç”¨åº“ã€‚</p><ol><li><p>å†™å¥½æºä»£ç  <code>mymath.c,  mymath.h</code></p> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// mymath.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mymath.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _MYMATH_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _MYMATH_H_</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">sub</span><span class="params">(<span class="type">int</span>, <span class="type">int</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// main.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;mymath.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">10</span>, b = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;add: %d, sub: %d\n&quot;</span>, add(a, b), sub(a, b));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å°† <code>.c</code> ç”Ÿæˆ <code>.o</code> æ–‡ä»¶ <code>gcc -c mymath.c -o mymath.o</code></p></li><li><p>ä½¿ç”¨ <code>ar</code> å·¥å…·åˆ¶ä½œé™æ€åº“ <code>ar rcs libmymath.a mymath.o</code></p></li></ol><p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>æœ‰äº†ç”Ÿæˆçš„é™æ€åº“<code>lib&#123;name&#125;.a</code>ï¼Œå°±å¯ä»¥ä½¿ç”¨è¯¥æ–‡ä»¶ï¼Œè€Œä¸éœ€è¦æºæ–‡ä»¶<code>.c</code>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c ./lib/libmymath.a -I ./include -o static</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ include</span><br><span class="line">â”‚Â Â  â””â”€â”€ mymath.h</span><br><span class="line">â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â””â”€â”€ libmymath.a</span><br><span class="line">â”œâ”€â”€ main.c</span><br><span class="line">â”œâ”€â”€ mymath.c    <span class="comment"># å·²ç»å¯ä»¥åˆ é™¤äº†</span></span><br><span class="line">â””â”€â”€ static      <span class="comment"># ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>è™½ç„¶é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œè®©<code>mymath</code>è¿™ä¸ªåº“é™æ€é“¾æ¥åˆ°äº†ç›®æ ‡æ–‡ä»¶ä¸­ï¼Œä½†ç”¨<code>ldd static</code>å¯ä»¥çœ‹åˆ°è¿˜æ˜¯æœ‰ä¸€äº›æ ‡å‡†åº“æ˜¯åŠ¨æ€é“¾æ¥çš„ã€‚**<code>gcc -static</code> é€‰é¡¹å¯ä½¿æ‰€æœ‰åº“éƒ½é€šè¿‡é™æ€é“¾æ¥ã€‚**</p><p>å•ç‹¬åƒé“¾æ¥ <code>.o</code> æ–‡ä»¶é‚£æ ·åˆ—å‡ºé™æ€åº“çš„å…·ä½“è·¯å¾„ï¼Œå°±åªæ˜¯å°†è¯¥é™æ€åº“ä½¿ç”¨é™æ€é“¾æ¥ï¼Œå…¶ä½™åº“ä»ç„¶é»˜è®¤ä½¿ç”¨åŠ¨æ€é“¾æ¥ã€‚å¦‚æœè¦æƒ³å…¨éƒ¨åº“éƒ½ä½¿ç”¨åŠ¨æ€é“¾æ¥ï¼Œå°±åŠ ä¸Šé“¾æ¥å‚æ•° <code>-static</code>ï¼Œå®ƒæŒ‡ç¤ºç¼–è¯‘å™¨å¯¹æ‰€æœ‰åº“é‡‡ç”¨é™æ€é“¾æ¥ï¼ŒæŸ¥æ‰¾è·¯å¾„ä¸åŠ¨æ€åº“ä¸€æ ·ï¼Œä½¿ç”¨ <code>-L</code> æŒ‡å®šåº“çš„æŸ¥æ‰¾è·¯å¾„ã€‚</p><p>è¦ç‚¹ï¼š</p><ul><li>é€šè¿‡ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„æŒ‡å®šé™æ€åº“æ–‡ä»¶çš„ä½ç½®</li><li>é€šè¿‡ <code>-I</code> æŒ‡å®šé™æ€åº“çš„å¤´æ–‡ä»¶æ‰€åœ¨ç›®å½•ä½ç½®</li></ul><h2 id="åŠ¨æ€åº“"><a href="#åŠ¨æ€åº“" class="headerlink" title="åŠ¨æ€åº“"></a>åŠ¨æ€åº“</h2><ol><li>å°† <code>.c</code> ç”Ÿæˆ <code>.o</code> æ–‡ä»¶ï¼Œï¼ˆç”Ÿæˆä¸ä½ç½®æ— å…³çš„ä»£ç  <code>-fPIC</code>ï¼‰ <code>gcc -c mymath.c -o mymath.o -fPIC</code></li><li>ä½¿ç”¨ <code>gcc -shared</code> åˆ¶ä½œåŠ¨æ€åº“ <code>gcc -shared -o libmymath.so mymath.o</code></li><li>ç¼–è¯‘å¯æ‰§è¡Œæ–‡ä»¶æ—¶ï¼ŒæŒ‡å®šæ‰€ä½¿ç”¨çš„åŠ¨æ€åº“ï¼Œ<code>-l</code> æŒ‡å®šåº“åï¼ˆå»æ‰libå‰ç¼€ä¸.soåç¼€ï¼‰ï¼Œ<code>-L</code>æŒ‡å®šåº“è·¯å¾„</li></ol><p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>ä¸‹é¢å°±å¯ä»¥æŒ‡å®šåŠ¨æ€åº“åç§°å’Œè·¯å¾„ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶äº†ï¼Œä½†è¿è¡Œä¼šå‡ºé”™ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -l mymath -L ./lib/ -I ./include/ -o dynamic</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ dynamic    <span class="comment"># ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line">â”œâ”€â”€ include</span><br><span class="line">â”‚Â Â  â””â”€â”€ mymath.h</span><br><span class="line">â”œâ”€â”€ lib</span><br><span class="line">â”‚Â Â  â””â”€â”€ libmymath.so</span><br><span class="line">â”œâ”€â”€ main.c</span><br><span class="line">â””â”€â”€ mymath.c</span><br><span class="line"></span><br><span class="line">$ ./dynamic</span><br><span class="line">./dynamic: error <span class="keyword">while</span> loading shared libraries: libmymath.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure><p><strong>åŸå› ï¼š</strong>ç¼–è¯‘å’Œè¿è¡Œæ—¶çš„é“¾æ¥å™¨ä¸åŒï¼</p><ul><li>é“¾æ¥å™¨ï¼šå·¥ä½œäºé“¾æ¥é˜¶æ®µï¼Œç”¨<code>-l -L</code>æŒ‡å®šåŠ¨æ€åº“è·¯å¾„</li><li>åŠ¨æ€é“¾æ¥å™¨ï¼šå·¥ä½œäºç¨‹åºè¿è¡Œé˜¶æ®µï¼Œå·¥ä½œæ—¶éœ€è¦æä¾›åŠ¨æ€åº“æ‰€åœ¨ç›®å½•ä½ç½®ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ï¼š<code>export LD_LIBRARY_PATH=/path</code></li></ul><p><strong>è§£å†³åŠæ³•ï¼š</strong>è®¾ç½® <code>LD_LIBRARY_PATH</code> æŒ‡å®šåŠ¨æ€åº“çš„ç›®å½•ï¼ˆå»ºè®®ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰ï¼Œç¯å¢ƒå˜é‡æ˜¯è¿›ç¨‹çš„æ¦‚å¿µï¼Œè¦è®©åŠ¨æ€åº“åœ°å€ä¸€ç›´ç”Ÿæ•ˆï¼š</p><ol><li>é€šè¿‡ç¯å¢ƒå˜é‡ <code>export LD_LIBRARY_PATH=/path</code>ï¼Œé€€å‡ºè¯¥ç»ˆç«¯åå¤±æ•ˆ</li><li>åœ¨<code>.bashrc</code>ä¸­æ·»åŠ ç¯å¢ƒå˜é‡ï¼Œæ¯æ¬¡æ‰“å¼€ç»ˆç«¯è‡ªåŠ¨åŠ è½½ç¯å¢ƒå˜é‡</li><li>å°†åº“æ–‡ä»¶å¤åˆ¶åˆ° <code>/lib</code> ç›®å½•ä¸‹ï¼Œæ ‡å‡†<code>c</code>åº“æ‰€åœ¨ç›®å½•</li><li>åœ¨<code>/etc/ld.so.conf</code>ä¸­æ·»åŠ  <code>include /path/lib.so</code>ï¼Œä½¿ç”¨ <code>ldconfig -v</code> ä½¿ä¿®æ”¹ç”Ÿæ•ˆ</li></ol><p>ä¸€ä¸ªç¨‹åºè¿è¡Œæ—¶ï¼Œå…¶ä¾èµ–çš„åŠ¨æ€åº“çš„åŠ è½½è¿‡ç¨‹åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼š<strong>åŠ è½½æ—¶åŠ¨æ€é“¾æ¥</strong>å’Œ<strong>è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥</strong>ã€‚<br>åŠ è½½æ—¶åŠ¨æ€é“¾æ¥æ˜¯æŒ‡ç¨‹åºåœ¨å¯åŠ¨æ—¶ï¼Œç”±åŠ¨æ€é“¾æ¥å™¨æ ¹æ®ç¨‹åºçš„ä¾èµ–ä¿¡æ¯ï¼Œå°†æ‰€éœ€çš„åŠ¨æ€åº“æ–‡ä»¶åŠ è½½åˆ°å†…å­˜ï¼Œå¹¶è¿›è¡Œé‡å®šä½å’Œåˆå§‹åŒ–ã€‚<br>è¿è¡Œæ—¶åŠ¨æ€é“¾æ¥æ˜¯æŒ‡ç¨‹åºåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨ç‰¹å®šçš„å‡½æ•°ï¼ˆå¦‚dlopenå’Œdlsymï¼‰ï¼Œæ¥æ‰“å¼€ã€å…³é—­å’Œä½¿ç”¨æŒ‡å®šçš„åŠ¨æ€åº“æ–‡ä»¶ã€‚</p><p><strong>åˆ›å»ºåŠ¨æ€åº“çš„æ—¶å€™ï¼Œæ€ä¹ˆå°†åŠ¨æ€åº“ä¾èµ–å“ªäº›åº“çš„ä¿¡æ¯æ‰“åŒ…è¿›å»ï¼Ÿè‡ªåŠ¨å®Œæˆå—ï¼Ÿ</strong></p><blockquote><p>åˆ›å»ºåŠ¨æ€åº“æ—¶ï¼Œå¯ä»¥åœ¨ç¼–è¯‘å’Œé“¾æ¥é˜¶æ®µæŒ‡å®šè¯¥åº“ä¾èµ–çš„å…¶ä»–åº“ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡é“¾æ¥å™¨é€‰é¡¹å®Œæˆçš„ï¼Œä¾‹å¦‚ä½¿ç”¨ GCC çš„ <code>-l</code> é€‰é¡¹æ¥é“¾æ¥åº“ã€‚ä¾èµ–ä¿¡æ¯ä¼šè¢«é“¾æ¥å™¨è‡ªåŠ¨åµŒå…¥åˆ°ç”Ÿæˆçš„åŠ¨æ€åº“ä¸­ï¼Œè¿™æ ·åœ¨åŠ è½½åŠ¨æ€åº“æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ï¼ˆå¦‚ <code>ld.so</code> åœ¨ Linux ä¸Šï¼‰å¯ä»¥æ‰¾åˆ°å¹¶åŠ è½½æ‰€æœ‰å¿…éœ€çš„ä¾èµ–åº“ã€‚</p><p>ä¾‹å¦‚ï¼Œå¦‚æœä½ æ­£åœ¨åˆ›å»ºä¸€ä¸ªåŠ¨æ€åº“ï¼Œå®ƒä¾èµ–äº <code>libm</code> ï¼ˆæ•°å­¦åº“ï¼‰å’Œ <code>libpthread</code> ï¼ˆçº¿ç¨‹åº“ï¼‰ï¼Œä½ å¯ä»¥åœ¨é“¾æ¥æ—¶ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o libyourlib.so yourlib.o -lm -lpthread</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>-shared</code> é€‰é¡¹å‘Šè¯‰ç¼–è¯‘å™¨ä½ æ­£åœ¨åˆ›å»ºä¸€ä¸ªåŠ¨æ€åº“ï¼Œ<code>-o libyourlib.so</code> æŒ‡å®šè¾“å‡ºæ–‡ä»¶åï¼Œ<code>yourlib.o</code> æ˜¯ä½ çš„åº“çš„ç¼–è¯‘åçš„å¯¹è±¡æ–‡ä»¶ï¼Œè€Œ <code>-lm</code> å’Œ <code>-lpthread</code> å‘Šè¯‰é“¾æ¥å™¨ä½ çš„åº“ä¾èµ–äºæ•°å­¦åº“å’Œçº¿ç¨‹åº“ã€‚</p><p>è¿™äº›ä¾èµ–å…³ç³»ä¼šè¢«è®°å½•åœ¨ç”Ÿæˆçš„ <code>libyourlib.so</code> æ–‡ä»¶ä¸­ã€‚å½“ä½ çš„åº“è¢«åŠ è½½æ—¶ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¼šæŸ¥çœ‹è¿™äº›ä¾èµ–ä¿¡æ¯å¹¶åŠ è½½ç›¸åº”çš„åº“ã€‚</p><p>å¦‚æœä½ æƒ³çœ‹åˆ°ä½ çš„åŠ¨æ€åº“ä¾èµ–äº†å“ªäº›å…¶ä»–åº“ï¼Œä½ å¯ä»¥åœ¨ Linux ä¸Šä½¿ç”¨ <code>ldd</code> å‘½ä»¤ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd libyourlib.so</span><br></pre></td></tr></table></figure><p>è¿™å°†åˆ—å‡ºæ‰€æœ‰éœ€è¦çš„å…±äº«åº“åŠå…¶è·¯å¾„ã€‚æœ‰æ—¶ï¼Œä½ å¯èƒ½éœ€è¦åœ¨éæ ‡å‡†è·¯å¾„ä¸­æŸ¥æ‰¾ä¾èµ–åº“ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>-L</code> é€‰é¡¹æ¥æ·»åŠ é¢å¤–çš„åº“æœç´¢è·¯å¾„ï¼Œå¹¶ç”¨ <code>-Wl,-rpath</code> é€‰é¡¹æ¥è®¾ç½®è¿è¡Œæ—¶åº“æœç´¢è·¯å¾„ï¼Œè¿™æ ·åŠ¨æ€é“¾æ¥å™¨å°±å¯ä»¥åœ¨è¿è¡Œæ—¶æ‰¾åˆ°è¿™äº›åº“ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -o libyourlib.so yourlib.o -L/path/to/libs -lm -lpthread -Wl,-rpath,/path/to/libs</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œï¼Œ<code>-L/path/to/libs</code> å‘Šè¯‰é“¾æ¥å™¨åœ¨ <code>/path/to/libs</code> ç›®å½•ä¸‹æŸ¥æ‰¾åº“æ–‡ä»¶ï¼Œè€Œ <code>-Wl,-rpath,/path/to/libs</code> é€‰é¡¹å°† <code>/path/to/libs</code> æ·»åŠ åˆ°è¿è¡Œæ—¶åº“æœç´¢è·¯å¾„ä¸­ã€‚è¿™ç¡®ä¿äº†åœ¨è¿è¡Œæ—¶ï¼Œå³ä½¿åº“ä¸åœ¨æ ‡å‡†çš„åº“è·¯å¾„ä¸­ï¼ŒåŠ¨æ€é“¾æ¥å™¨ä¹Ÿèƒ½æ‰¾åˆ°å®ƒä»¬ã€‚</p></blockquote><p><strong>å¦‚æœæ²¡æœ‰ç”¨ -l æ¥æŒ‡å®šï¼Œæ˜¯ä¸æ˜¯ ldd å°±çœ‹ä¸äº†ä¾èµ–å…³ç³»ï¼Ÿ</strong></p><blockquote><p>å¦‚æœåœ¨ç¼–è¯‘åŠ¨æ€åº“æ—¶æ²¡æœ‰ä½¿ç”¨ <code>-l</code> é€‰é¡¹æ¥é“¾æ¥å…¶ä»–åº“ï¼Œé‚£ä¹ˆè¿™äº›åº“ä¸ä¼šæˆä¸ºåŠ¨æ€åº“çš„ä¾èµ–ï¼Œå› æ­¤ <code>ldd</code> å‘½ä»¤ä¸ä¼šæ˜¾ç¤ºè¿™äº›åº“ä½œä¸ºä¾èµ–å…³ç³»ã€‚<code>-l</code> é€‰é¡¹ç”¨äºé“¾æ¥æ—¶æœŸæŒ‡å®šé“¾æ¥å™¨éœ€è¦é“¾æ¥çš„åº“ã€‚</p><p>ä½†æ˜¯ï¼Œå¦‚æœä½ çš„ä»£ç è°ƒç”¨äº†å…¶ä»–åº“çš„å‡½æ•°ï¼Œè€Œæ²¡æœ‰åœ¨é“¾æ¥æ—¶æŒ‡å®šè¿™äº›åº“ï¼Œé‚£ä¹ˆç¼–è¯‘è¿‡ç¨‹ä¼šå› ä¸ºæœªè§£æçš„ç¬¦å·è€Œå¤±è´¥ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ èƒ½æˆåŠŸç¼–è¯‘ä¸€ä¸ªåŠ¨æ€åº“è€Œæ²¡æœ‰ä½¿ç”¨ <code>-l</code> é€‰é¡¹ï¼Œé‚£ä¹ˆè¿™ä¸ªåº“è¦ä¹ˆä¸ä¾èµ–äºä»»ä½•å…¶ä»–åº“ä¸­çš„ç¬¦å·ï¼Œè¦ä¹ˆä»…ä¾èµ–äºé‚£äº›å·²ç»è¢«å…¶ä»–æ–¹å¼ï¼ˆå¦‚é€šè¿‡å…¶ä»–é“¾æ¥å™¨æ ‡å¿—ï¼‰é“¾æ¥çš„åº“ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä½ çš„åº“ä½¿ç”¨äº† C æ ‡å‡†åº“ï¼ˆlibcï¼‰ä¸­çš„å‡½æ•°ï¼Œä½ é€šå¸¸ä¸éœ€è¦æ˜¾å¼åœ°é“¾æ¥ libcï¼Œå› ä¸ºå®ƒæ˜¯ç¼–è¯‘å™¨é»˜è®¤ä¼šé“¾æ¥çš„åº“ã€‚ä½†æ˜¯ï¼Œå¯¹äºéæ ‡å‡†åº“ï¼Œå¦‚æœä½ çš„ä»£ç ä¸­ä½¿ç”¨äº†å®ƒä»¬ï¼Œä½ éœ€è¦åœ¨é“¾æ¥æ—¶æŒ‡å®šå®ƒä»¬ï¼Œå¦åˆ™ä¼šå‡ºç°é“¾æ¥é”™è¯¯ã€‚</p><p>ä½¿ç”¨ <code>ldd</code> æŸ¥çœ‹åŠ¨æ€åº“çš„ä¾èµ–å…³ç³»æ—¶ï¼Œåªæœ‰é‚£äº›åœ¨é“¾æ¥æ—¶æœŸè¢«æ˜¾å¼æŒ‡å®šçš„åº“æ‰ä¼šè¢«åˆ—å‡ºã€‚å¦‚æœåº“æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€åŠ è½½çš„ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨ <code>dlopen</code>ï¼‰ï¼Œé‚£ä¹ˆè¿™äº›åº“ä¸ä¼šå‡ºç°åœ¨ <code>ldd</code> çš„è¾“å‡ºä¸­ï¼Œå› ä¸ºå®ƒä»¬ä¸æ˜¯ç¼–è¯‘æ—¶é“¾æ¥çš„ä¾èµ–é¡¹ã€‚</p></blockquote><p><strong>c ç¼–è¯‘çš„æ—¶å€™ï¼Œè·ŸæŒ‡å®šåº“çš„é¡ºåº è¿˜æœ‰å…³ç³»å—ï¼Ÿ</strong></p><blockquote><p>æ˜¯çš„ï¼ŒæŒ‡å®šåº“çš„é¡ºåºåœ¨ç¼–è¯‘æ—¶æ˜¯æœ‰å…³ç³»çš„ã€‚åœ¨é“¾æ¥é˜¶æ®µï¼Œç¼–è¯‘å™¨ä¼šæŒ‰ç…§æŒ‡å®šçš„åº“çš„é¡ºåºæ¥æŸ¥æ‰¾ç¬¦å·ã€‚å¦‚æœæŸä¸ªç¬¦å·åœ¨å‰é¢çš„åº“ä¸­æ‰¾åˆ°äº†ï¼Œåˆ™ä¸ä¼šå»åé¢çš„åº“ä¸­å†æŸ¥æ‰¾ï¼Œå³ä½¿åé¢çš„åº“ä¸­æœ‰åŒåçš„ç¬¦å·ä¹Ÿä¸ä¼šè¢«ä½¿ç”¨ã€‚</p><p>å› æ­¤ï¼Œé€šå¸¸æƒ…å†µä¸‹ï¼Œåº”è¯¥å°†ä¾èµ–çš„åº“æ”¾åœ¨è¢«ä¾èµ–çš„åº“ä¹‹åã€‚ä¾‹å¦‚ï¼Œå¦‚æœåº“ A ä¾èµ–äºåº“ Bï¼Œé‚£ä¹ˆç¼–è¯‘æ—¶åº”è¯¥å°†åº“ B æ”¾åœ¨åº“ A ä¹‹åï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿åœ¨é“¾æ¥æ—¶å…ˆæ‰¾åˆ°åº“ B ä¸­çš„ç¬¦å·ï¼Œç„¶åå†æ‰¾åˆ°åº“ A ä¸­çš„ç¬¦å·ï¼Œä»¥ç¡®ä¿ç¬¦å·çš„æ­£ç¡®è§£æå’Œé“¾æ¥ã€‚</p><p>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªåº“ libA.a å’Œ libB.aï¼Œå…¶ä¸­ libA.a ä¾èµ–äº libB.aï¼Œå¦‚æœç¼–è¯‘å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bashCopy code</span><br><span class="line">gcc -o program program.c -lA -lB</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šå…ˆæœç´¢ libA.aï¼Œå¦‚æœåœ¨ libA.a ä¸­æ‰¾ä¸åˆ°ç¬¦å·ï¼Œåˆ™ä¼šç»§ç»­æœç´¢ libB.aï¼Œä»¥ç¡®ä¿èƒ½å¤Ÿè§£æåˆ°ç¨‹åºä¸­æ‰€éœ€çš„æ‰€æœ‰ç¬¦å·ã€‚</p></blockquote><p><strong>ä¼šå­˜åœ¨å› ä¸ºé¡ºåºä¸å¯¹ï¼Œå¯¼è‡´ç¼–è¯‘å¤±è´¥çš„æƒ…å†µå—ï¼Ÿ</strong></p><blockquote><p>æ˜¯çš„ï¼Œå› ä¸ºåº“çš„é¡ºåºä¸å¯¹å¯èƒ½å¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚è¿™é€šå¸¸å‘ç”Ÿåœ¨ä¾èµ–å…³ç³»æ¯”è¾ƒå¤æ‚çš„æƒ…å†µä¸‹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾æœ‰ä¸‰ä¸ªåº“ï¼šlibA.aã€libB.a å’Œ libC.aï¼Œå®ƒä»¬ä¹‹é—´çš„ä¾èµ–å…³ç³»ä¸º libA.a ä¾èµ–äº libB.aï¼ŒlibB.a ä¾èµ–äº libC.aã€‚å¦‚æœç¼–è¯‘å‘½ä»¤çš„åº“çš„é¡ºåºä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bashCopy code</span><br><span class="line">gcc -o program program.c -lA -lC -lB</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šå…ˆæœç´¢ libA.aï¼Œç„¶ååœ¨ libA.a ä¸­æ‰¾åˆ°å¯¹ libB.a çš„ä¾èµ–ï¼Œæ¥ç€ä¼šæœç´¢ libC.aã€‚ä½†æ˜¯ç”±äº libC.a åœ¨ libB.a ä¹‹åï¼Œæ‰€ä»¥åœ¨æœç´¢ libC.a æ—¶ï¼ŒlibB.a çš„ç¬¦å·è¿˜æ²¡æœ‰è¢«è§£æï¼Œç¼–è¯‘å™¨æ‰¾ä¸åˆ° libB.a ä¸­çš„ç¬¦å·ï¼Œå› æ­¤ç¼–è¯‘ä¼šå¤±è´¥ã€‚</p><p>ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œåº”è¯¥æŒ‰ç…§ä¾èµ–å…³ç³»çš„é¡ºåºæ­£ç¡®æŒ‡å®šåº“çš„é¡ºåºï¼Œå³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bashCopy code</span><br><span class="line">gcc -o program program.c -lA -lB -lC</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œç¼–è¯‘å™¨ä¼šå…ˆæœç´¢ libA.aï¼Œç„¶ååœ¨ libA.a ä¸­æ‰¾åˆ°å¯¹ libB.a çš„ä¾èµ–ï¼Œæ¥ç€æœç´¢ libB.aï¼Œåœ¨ libB.a ä¸­æ‰¾åˆ°å¯¹ libC.a çš„ä¾èµ–ï¼Œæœ€ç»ˆæœç´¢ libC.aï¼Œç¡®ä¿èƒ½å¤Ÿæ­£ç¡®è§£æå’Œé“¾æ¥æ‰€æœ‰çš„ç¬¦å·ï¼Œé¿å…äº†ç¼–è¯‘å¤±è´¥çš„æƒ…å†µã€‚</p></blockquote><h2 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h2><p><strong>å‘½å</strong>ï¼šå¿…é¡»ä¸º <code>Makefile / makefile</code></p><p><strong>ç¼©è¿›</strong>ï¼šå¿…é¡»ç”¨<code>Tab</code>ï¼Œä¸èƒ½ç”¨ç©ºæ ¼</p><p><strong>å˜é‡</strong>ï¼šä¸<code>bash</code>ç±»ä¼¼ï¼Œä½†ç”¨ <code>$()</code> è€Œä¸æ˜¯ <code>$&#123;&#125;</code>ï¼ŒMakefileä¸­çš„å˜é‡çš„ä½œç”¨ç›¸å½“äºcè¯­è¨€é‡Œé¢çš„å®ï¼Œä½¿ç”¨<code>$(x)</code>å°±ç›¸å½“äºå®å±•å¼€ï¼</p><p><strong>ä¸€ä¸ªè§„åˆ™</strong>ï¼šç›®æ ‡çš„æ—¶é—´å¿…é¡»æ™šäºä¾èµ–æ¡ä»¶çš„æ—¶é—´ï¼Œå¦åˆ™ï¼Œæ›´æ–°ç›®æ ‡</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ç›®æ ‡ï¼šä¾èµ–</span><br><span class="line">ï¼ˆTabï¼‰å‘½ä»¤</span><br></pre></td></tr></table></figure><p><strong>ä¸¤ä¸ªå‡½æ•°</strong>ï¼šåŒ¹é…å‡½æ•°å’Œæ›¿æ¢å‡½æ•°</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åŒ¹é…å½“å‰å·¥ä½œç›®å½•ä¸‹çš„æ‰€æœ‰.c æ–‡ä»¶ã€‚å°†æ–‡ä»¶åç»„æˆåˆ—è¡¨ï¼Œèµ‹å€¼ç»™å˜é‡ src</span></span><br><span class="line"><span class="comment"># src = add.c sub.c div1.c</span></span><br><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> *.c)</span></span><br><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> ./*.c)</span> <span class="comment"># å’Œä¸Šé¢ç­‰ä»·</span></span><br><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> ./<span class="built_in">dir</span>/*.c)</span>  <span class="comment"># åŒ¹é…å­ç›®å½• src=./dir/add.c ./dir/sub.c</span></span><br></pre></td></tr></table></figure><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†å‚æ•° 3 ä¸­ï¼ŒåŒ…å«å‚æ•° 1 çš„éƒ¨åˆ†ï¼Œæ›¿æ¢ä¸ºå‚æ•° 2</span></span><br><span class="line"><span class="comment"># obj = add.o sub.o div1.o</span></span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> %.c, %.o, <span class="variable">$(src)</span>)</span></span><br></pre></td></tr></table></figure><p><strong>ä¸‰ä¸ªè‡ªåŠ¨å˜é‡</strong>ï¼š</p><ul><li><code>$@</code>ï¼šè¡¨ç¤ºè§„åˆ™ä¸­çš„ç›®æ ‡</li><li><code>$&lt;</code>ï¼šè¡¨ç¤ºè§„åˆ™ä¸­çš„ç¬¬ä¸€ä¸ªä¾èµ–æ¡ä»¶</li><li><code>$^</code>ï¼šè¡¨ç¤ºè§„åˆ™ä¸­æ‰€æœ‰çš„ä¾èµ–æ¡ä»¶</li></ul><p><strong>æ¨¡å¼è§„åˆ™</strong>ï¼šè‡ªåŠ¨åŒ¹é…å½“å‰ç›®å½•ä¸‹çš„æ–‡ä»¶</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç›®æ ‡ï¼šä¾èµ–</span></span><br><span class="line"><span class="comment">#ï¼ˆTabï¼‰å‘½ä»¤</span></span><br><span class="line"><span class="section">%.o:%.c</span></span><br><span class="line">    gcc -c <span class="variable">$&lt;</span> -o %@</span><br><span class="line"><span class="comment"># ç­‰ä»·äºä¸ºæ¯ä¸€ä¸ª .c æ–‡ä»¶å†™</span></span><br><span class="line"><span class="comment"># a.o:a.c</span></span><br><span class="line"><span class="comment">#   gcc -c a.c -o a.o</span></span><br></pre></td></tr></table></figure><p><strong>é™æ€æ¨¡å¼è§„åˆ™</strong>ï¼šä»¥æŒ‡å®šå˜é‡ä¸­å€¼ä¸ºç›®æ ‡ï¼Œè€Œä¸æ˜¯åœ¨å½“å‰æ–‡ä»¶å¤¹ä¸­æœç´¢</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å˜é‡ï¼šç›®æ ‡ï¼šä¾èµ–</span></span><br><span class="line"><span class="comment">#ï¼ˆTabï¼‰å‘½ä»¤</span></span><br><span class="line"><span class="variable">$(obj)</span>:%.o:%.c</span><br><span class="line">    gcc -c <span class="variable">$&lt;</span> -o %@</span><br></pre></td></tr></table></figure><p><strong>clean</strong>ï¼šæ¸…ç†æ–‡ä»¶</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">clean: (æ²¡æœ‰ä¾èµ–)</span></span><br><span class="line">    -rm -rf <span class="variable">$(obj)</span></span><br><span class="line"><span class="comment"># â€œ-â€ï¼šä½œç”¨æ˜¯ï¼Œåˆ é™¤ä¸å­˜åœ¨æ–‡ä»¶æ—¶ï¼Œä¸æŠ¥é”™ã€‚é¡ºåºæ‰§è¡Œç»“æŸã€‚</span></span><br></pre></td></tr></table></figure><p><strong>ç›®æ ‡</strong>ï¼šç¬¬ä¸€ä¸ªç›®æ ‡ä¸ºæ€»ç›®æ ‡ï¼Œè¯¥ç›®æ ‡è‹¥ä¸éœ€è¦æ›´æ–°ï¼Œå°±ä¸ä¼šæ£€æŸ¥å…¶ä»–ç›®æ ‡</p><p><strong>ä¼ªç›®æ ‡ï¼š</strong>å½“å‰ç›®å½•è‹¥å­˜åœ¨æ–‡ä»¶<code>ALL</code>ï¼Œ<code>clean</code>æ—¶ï¼Œä¼šå¯¼è‡´<code>make</code>æ‰§è¡Œå¼‚å¸¸ï¼Œä½¿ç”¨ä¼ªç›®æ ‡å¯é¿å…</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: clean ALL</span></span><br></pre></td></tr></table></figure><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">src = <span class="variable">$(<span class="built_in">wildcard</span> ./src/*.c)</span></span><br><span class="line">obj = <span class="variable">$(<span class="built_in">patsubst</span> ./src/*.c ./src/*.o <span class="variable">$(src)</span>)</span></span><br><span class="line"></span><br><span class="line">inc_path = ./<span class="keyword">include</span></span><br><span class="line">args = -Wall -std=c99</span><br><span class="line"></span><br><span class="line"><span class="section">ALL: main</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$(obj)</span>:./src/%.o:./src/%.c</span><br><span class="line">    gcc -c <span class="variable">$&lt;</span> -o <span class="variable">$@</span> <span class="variable">$(args)</span> -I <span class="variable">$(inc_path)</span></span><br><span class="line"></span><br><span class="line"><span class="section">main:<span class="variable">$(obj)</span></span></span><br><span class="line">    gcc <span class="variable">$^</span> -o <span class="variable">$@</span> <span class="variable">$(args)</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">    -rm -rf <span class="variable">$(obj)</span> main</span><br></pre></td></tr></table></figure><h2 id="ç›¸å…³å·¥å…·"><a href="#ç›¸å…³å·¥å…·" class="headerlink" title="ç›¸å…³å·¥å…·"></a>ç›¸å…³å·¥å…·</h2><h3 id="objdump-æŸ¥çœ‹æ±‡ç¼–"><a href="#objdump-æŸ¥çœ‹æ±‡ç¼–" class="headerlink" title="objdump æŸ¥çœ‹æ±‡ç¼–"></a>objdump æŸ¥çœ‹æ±‡ç¼–</h3><p>æŸ¥çœ‹å¯æ‰§è¡Œæ–‡ä»¶æ±‡ç¼–ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -dS dynamic</span><br></pre></td></tr></table></figure><h3 id="ldd-ä¾èµ–åŠ¨æ€åº“"><a href="#ldd-ä¾èµ–åŠ¨æ€åº“" class="headerlink" title="ldd ä¾èµ–åŠ¨æ€åº“"></a>ldd ä¾èµ–åŠ¨æ€åº“</h3><p>æŸ¥çœ‹ç¨‹åºä¾èµ–åŠ¨æ€åº“çš„è·¯å¾„ï¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ldd static</span><br><span class="line">    linux-vdso.so.1 (0x00007ffd507e9000)</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fba762d7000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007fba764ee000)</span><br><span class="line">ldd dynamic</span><br><span class="line">    linux-vdso.so.1 (0x00007ffee615b000)</span><br><span class="line">    libmymath.so =&gt; ./lib/libmymath.so (0x00007f482012c000)</span><br><span class="line">    libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f481ff1c000)</span><br><span class="line">    /lib64/ld-linux-x86-64.so.2 (0x00007f4820138000)</span><br></pre></td></tr></table></figure><h3 id="strace-ç³»ç»Ÿè°ƒç”¨"><a href="#strace-ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="strace ç³»ç»Ÿè°ƒç”¨"></a>strace ç³»ç»Ÿè°ƒç”¨</h3><p>è·Ÿè¸ªç¨‹åºæ‰§è¡Œæ—¶çš„ç³»ç»Ÿè°ƒç”¨ï¼</p><p><code>=</code> åæ˜¯è¯¥ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼ï¼</p><p>ç¬¬ä¸€è¡Œæ˜¯<code>execve</code>ï¼Œåœ¨å½“å‰shellçš„è¿›ç¨‹ä¸­ï¼Œå¼€äº†ä¸€ä¸ªå­è¿›ç¨‹ï¼Œå¹¶é€šè¿‡<code>execve</code>æ‰§è¡Œäº†å¦ä¸€ä¸ªç¨‹åºã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">strace ./static</span><br><span class="line"><span class="comment">#############################################################################</span></span><br><span class="line">execve(<span class="string">&quot;./static&quot;</span>, [<span class="string">&quot;./static&quot;</span>], 0x7ffcdd67dc70 /* 73 vars */) = 0</span><br><span class="line">brk(NULL)                               = 0x56030df70000</span><br><span class="line">arch_prctl(0x3001 /* ARCH_??? */, 0x7fff63567720) = -1 EINVAL (Invalid argument)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=121662, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 121662, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f8755dc8000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">openat(AT_FDCWD, <span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">&quot;\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360A\2\0\0\0\0\0&quot;</span>..., 832) = 832</span><br><span class="line">pread64(3, <span class="string">&quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;</span>..., 784, 64) = 784</span><br><span class="line">pread64(3, <span class="string">&quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;</span>, 32, 848) = 32</span><br><span class="line">pread64(3, <span class="string">&quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\237\333t\347\262\27\320l\223\27*\202C\370T\177&quot;</span>..., 68, 880) = 68</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2029560, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7f8755dc6000</span><br><span class="line">pread64(3, <span class="string">&quot;\6\0\0\0\4\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0@\0\0\0\0\0\0\0&quot;</span>..., 784, 64) = 784</span><br><span class="line">pread64(3, <span class="string">&quot;\4\0\0\0\20\0\0\0\5\0\0\0GNU\0\2\0\0\300\4\0\0\0\3\0\0\0\0\0\0\0&quot;</span>, 32, 848) = 32</span><br><span class="line">pread64(3, <span class="string">&quot;\4\0\0\0\24\0\0\0\3\0\0\0GNU\0\237\333t\347\262\27\320l\223\27*\202C\370T\177&quot;</span>..., 68, 880) = 68</span><br><span class="line">mmap(NULL, 2037344, PROT_READ, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7f8755bd4000</span><br><span class="line">mmap(0x7f8755bf6000, 1540096, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x22000) = 0x7f8755bf6000</span><br><span class="line">mmap(0x7f8755d6e000, 319488, PROT_READ, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x19a000) = 0x7f8755d6e000</span><br><span class="line">mmap(0x7f8755dbc000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1e7000) = 0x7f8755dbc000</span><br><span class="line">mmap(0x7f8755dc2000, 13920, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7f8755dc2000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7f8755dc7540) = 0</span><br><span class="line">mprotect(0x7f8755dbc000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x56030bfe1000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7f8755e13000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7f8755dc8000, 121662)          = 0</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(0x88, 0), ...&#125;) = 0</span><br><span class="line">brk(NULL)                               = 0x56030df70000</span><br><span class="line">brk(0x56030df91000)                     = 0x56030df91000</span><br><span class="line">write(1, <span class="string">&quot;add: 15, sub: 5\n&quot;</span>, 16add: 15, sub: 5</span><br><span class="line">)       = 16    <span class="comment"># å†™åˆ°æ ‡å‡†è¾“å‡ºï¼Œå­—ç¬¦ä¸²é•¿åº¦ä¸º16</span></span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure><h3 id="Valgrind-å†…å­˜æ³„éœ²"><a href="#Valgrind-å†…å­˜æ³„éœ²" class="headerlink" title="Valgrind å†…å­˜æ³„éœ²"></a>Valgrind å†…å­˜æ³„éœ²</h3><p>Valgrind æ˜¯è¿è¡Œåœ¨Linuxä¸Šä¸€å¥—åŸºäºä»¿çœŸæŠ€æœ¯çš„ç¨‹åºè°ƒè¯•å’Œåˆ†æå·¥å…·ï¼Œæ˜¯å…¬è®¤çš„æœ€æ¥è¿‘Purifyçš„äº§å“ï¼Œå®ƒåŒ…å«ä¸€ä¸ªå†…æ ¸â€”â€”ä¸€ä¸ªè½¯ä»¶åˆæˆçš„CPUï¼Œå’Œä¸€ç³»åˆ—çš„å°å·¥å…·ï¼Œæ¯ä¸ªå·¥å…·éƒ½å¯ä»¥å®Œæˆä¸€é¡¹ä»»åŠ¡â€”â€”è°ƒè¯•ï¼Œåˆ†æï¼Œæˆ–æµ‹è¯•ç­‰ã€‚Valgrindå¯ä»¥<strong>æ£€æµ‹å†…å­˜æ³„æ¼å’Œå†…å­˜è¶Šç•Œ</strong>ï¼Œè¿˜å¯ä»¥åˆ†æcacheçš„ä½¿ç”¨ç­‰ï¼Œçµæ´»è½»å·§è€Œåˆå¼ºå¤§ã€‚</p><ol><li><code>memcheck</code>ï¼šæ£€æŸ¥ç¨‹åºä¸­çš„å†…å­˜é—®é¢˜ï¼Œå¦‚æ³„æ¼ã€è¶Šç•Œã€éæ³•æŒ‡é’ˆç­‰ã€‚</li><li><code>callgrind</code>ï¼šæ£€æµ‹ç¨‹åºä»£ç è¦†ç›–ï¼Œä»¥åŠåˆ†æç¨‹åºæ€§èƒ½ã€‚</li><li><code>cachegrind</code>ï¼šåˆ†æCPUçš„cacheå‘½ä¸­ç‡ã€ä¸¢å¤±ç‡ï¼Œç”¨äºè¿›è¡Œä»£ç ä¼˜åŒ–ã€‚</li><li><code>helgrind</code>ï¼šç”¨äºæ£€æŸ¥å¤šçº¿ç¨‹ç¨‹åºçš„ç«æ€æ¡ä»¶ã€‚</li><li><code>massif</code>ï¼šå †æ ˆåˆ†æå™¨ï¼ŒæŒ‡ç¤ºç¨‹åºä¸­ä½¿ç”¨äº†å¤šå°‘å †å†…å­˜ç­‰ä¿¡æ¯ã€‚</li><li><code>lackey</code>ï¼š</li><li><code>nulgrind</code>ï¼š</li></ol><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><blockquote><p><a href="https://www.bilibili.com/video/BV1KE411q7ee">bilibilié»‘é©¬ç¨‹åºå‘˜-Linuxç³»ç»Ÿç¼–ç¨‹</a><br>å‚è€ƒç¬”è®°ï¼š<a href="https://github.com/ABottomCoder/Linux-system-programming">https://github.com/ABottomCoder/Linux-system-programming</a><br><a href="https://www.cnblogs.com/wangkangluo1/archive/2011/07/20/2111248.html">Valgrindä½¿ç”¨è¯´æ˜</a></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Makefile </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>STLå®¹å™¨</title>
      <link href="/2022/04/23/ProgramBasic_STL/"/>
      <url>/2022/04/23/ProgramBasic_STL/</url>
      
        <content type="html"><![CDATA[<p>çº¿ç¨‹å®‰å…¨ï¼š</p><ul><li>è¿™é‡Œåˆ—å‡ºçš„<code>C++</code> æ ‡å‡†åº“ä¸­çš„å®¹å™¨éƒ½ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼å¤šä¸ªçº¿ç¨‹è¯»æ—¶ä¸éœ€è¦åŠ é”ï¼Œä½†æœ‰ä¸€ä¸ªçº¿ç¨‹å†™æ—¶ï¼Œæ‰€æœ‰è¯»å†™çº¿ç¨‹éƒ½éœ€è¦åŠ é”ï¼</li></ul><p>æ•ˆç‡è¯´æ˜ï¼š</p><ul><li><code>emplace_back()</code> æ˜¯c11æ–°åŠ çš„ï¼ŒåŠŸèƒ½ä¸ <code>push_back()</code> ä¸€æ ·ï¼Œä½†æ•ˆç‡æ›´é«˜ï¼Œæ¨èä¼˜å…ˆä½¿ç”¨</li></ul><h2 id="åºåˆ—å¼å®¹å™¨"><a href="#åºåˆ—å¼å®¹å™¨" class="headerlink" title="åºåˆ—å¼å®¹å™¨"></a>åºåˆ—å¼å®¹å™¨</h2><blockquote><p><a href="https://hackingcpp.com/cpp/std/sequence_containers.html">åºåˆ—å¼å®¹å™¨ hackingcpp</a></p></blockquote><h3 id="Array"><a href="#Array" class="headerlink" title="Array"></a>Array</h3><p><img src="/../images/ProgramBasic_STL/array_thumb.svg" alt="standard library sequence container &#39;array"></p><p><strong>å›ºå®šå¤§å°çš„æ•°ç»„</strong>ï¼Œå¿…é¡»åœ¨å»ºç«‹æ—¶å°±æŒ‡æ˜å…¶å¤§å°ã€‚</p><ul><li><code>.front()</code>ï¼šè¿”å›ç¬¬ä¸€å…ƒç´ çš„<strong>å¼•ç”¨</strong>ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™äº›æ“ä½œå‡½æ•°æ›´æ”¹å…ƒç´ å†…å®¹</li><li><code>.back()</code>ï¼šè¿”å›æœ€æœ«å…ƒç´ çš„<strong>å¼•ç”¨</strong>ï¼Œ<code>c.back() = 10</code></li></ul><h3 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h3><p><img src="/../images/ProgramBasic_STL/vector_thumb.svg" alt="standard library sequence container &#39;vector"></p><p><code>Vector</code> æ˜¯ä¸€ä¸ª <code>dynamic array</code>ã€‚</p><p>å¤§å°å¯å˜ï¼Œä½†å†…å­˜é‡æ–°åˆ†é…å¾ˆè€—æ—¶é—´ã€‚</p><p><strong>åœ¨<code>Vector</code>å°¾éƒ¨é™„åŠ å…ƒç´ æˆ–ç§»é™¤å…ƒç´ éƒ½å¾ˆå¿«é€Ÿ</strong>ï¼Œä½†æ˜¯åœ¨<code>Vector</code>çš„ä¸­æ®µæˆ–èµ·å§‹æ®µå®‰æ’å…ƒç´ å°±æ¯”è¾ƒè´¹æ—¶</p><ul><li><code>.front()</code>ï¼šè¿”å›ç¬¬ä¸€å…ƒç´ çš„<strong>å¼•ç”¨</strong> (ä¸æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¬¬ä¸€å…ƒç´ )</li><li><code>.back()</code>ï¼šè¿”å›æœ€æœ«å…ƒç´ çš„<strong>å¼•ç”¨</strong> (ä¸æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ€æœ«å…ƒç´ )ï¼Œ<code>c.back() = 10</code></li><li><code>.push_back(elem)</code>ï¼šå°¾éƒ¨é™„åŠ å…ƒç´ </li><li><code>.pop_back()</code>ï¼šç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ </li><li><code>.insert(pos, elem)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ä¸€ä¸ª elem æ‹·è´ï¼Œå¹¶è¿”å›æ–°å…ƒç´ çš„ä½ç½®</li><li><code>.insert(pos, n, elem)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ n ä¸ª elem æ‹·è´ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªæ–°å…ƒç´ çš„ä½ç½®</li><li><code>.emplace(pos, args...)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ ï¼Œå¹¶è¿”å›æ–°å…ƒç´ çš„ä½ç½®</li><li><code>.emplace_back(args...)</code>ï¼šé™„åŠ ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ äºæœªå°¾ï¼Œä¸è¿”å›ä»»ä½•ä¸œè¥¿</li><li><code>.resize(num)</code>ï¼šå°†å…ƒç´ æ•°é‡æ”¹ä¸º num (å¦‚æœ <code>size()</code> å˜å¤§ï¼Œå¤šå‡ºæ¥çš„æ–°å…ƒç´ éƒ½éœ€ä»¥ default æ„é€ å‡½æ•°å®Œæˆåˆå§‹åŒ–)</li><li><code>.resize(num, elem)</code>ï¼šå°†å…ƒç´ æ•°é‡æ”¹ä¸º num (å¦‚æœ <code>size()</code> å˜å¤§ï¼Œå¤šå‡ºæ¥çš„æ–°å…ƒç´ éƒ½æ˜¯ elem çš„æ‹·è´)</li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li></ul><h3 id="Deque"><a href="#Deque" class="headerlink" title="Deque"></a>Deque</h3><p><img src="/../images/ProgramBasic_STL/deque_thumb.svg" alt="standard library sequence container &#39;deque"></p><p>â€œdouble-ended queueâ€çš„ç¼©å†™ã€‚å®ƒæ˜¯ä¸€ä¸ªdynamic arrayï¼Œå¯ä»¥å‘ä¸¤ç«¯å‘å±•ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œ<strong>å¹¶ä¸æ˜¯ä¸€æ®µè¿ç»­çš„å†…å­˜</strong>ã€‚</p><p>å› æ­¤<strong>ä¸è®ºåœ¨å°¾éƒ¨æˆ–å¤´éƒ¨å®‰æ’å…ƒç´ éƒ½ååˆ†è¿…é€Ÿ</strong>ã€‚åœ¨<strong>ä¸­é—´éƒ¨åˆ†å®‰æ’å…ƒç´ åˆ™æ¯”è¾ƒè´¹æ—¶</strong>ï¼Œå› ä¸ºå¿…é¡»ç§»åŠ¨å…¶ä»–å…ƒç´ ã€‚</p><p>è®¿é—®å…ƒç´ æ—¶dequeå†…éƒ¨ç»“æ„ä¼šå¤šä¸€ä¸ªé—´æ¥è¿‡ç¨‹ï¼Œæ‰€ä»¥å…ƒç´ çš„è®¿é—®å’Œè¿­ä»£åš£çš„åŠ¨ä½œä¼šç¨ç¨æ…¢ä¸€äº›ã€‚</p><p>ç‰¹åˆ«æ³¨æ„ï¼Œé™¤å¤´å°¾ä¸¤ç«¯å¤–ï¼Œåœ¨ä»»ä½•åœ°ç‚¹å®‰æ’æˆ–åˆ é™¤å…ƒç´ éƒ½å°†å¯¼è‡´æŒ‡å‘dequeå…ƒç´ çš„ä»»ä½•pointerã€referenceå’Œiteratorå¤±æ•ˆã€‚</p><p>dequeçš„å†…å­˜é‡åˆ†é…ä¼˜äºvectorï¼Œdequeä¸å¿…åœ¨å†…å­˜é‡æ–°åˆ†é…æ—¶å¤åˆ¶æ‰€æœ‰å…ƒç´ ã€‚</p><ul><li><code>.front()</code>ï¼šè¿”å›ç¬¬ä¸€å…ƒç´ çš„<strong>å¼•ç”¨</strong> (ä¸æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç¬¬ä¸€å…ƒç´ )</li><li><code>.back()</code>ï¼šè¿”å›æœ€æœ«å…ƒç´ çš„<strong>å¼•ç”¨</strong> (ä¸æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ€æœ«å…ƒç´ )ï¼Œ<code>c.back() = 10</code></li><li><code>.push_back(elem)</code>ï¼šå°¾éƒ¨é™„åŠ å…ƒç´ </li><li><code>.pop_back()</code>ï¼šç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ </li><li><strong><code>.push_front(elem)</code>ï¼šå¤´éƒ¨é™„åŠ å…ƒç´ </strong></li><li><strong><code>.pop_front()</code>ï¼šç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´ </strong></li><li><code>.insert(pos, elem)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ä¸€ä¸ª elem æ‹·è´ï¼Œå¹¶è¿”å›æ–°å…ƒç´ çš„ä½ç½®</li><li><code>.insert(pos, n, elem)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ n ä¸ª elem æ‹·è´ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªæ–°å…ƒç´ çš„ä½ç½®</li><li><code>.emplace(pos, args...)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ ï¼Œå¹¶è¿”å›æ–°å…ƒç´ çš„ä½ç½®</li><li><code>.emplace_back(args...)</code>ï¼šé™„åŠ ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ äºæœªå°¾ï¼Œä¸è¿”å›ä»»ä½•ä¸œè¥¿</li><li><strong><code>.emplace_front(args...)</code>ï¼šé™„åŠ ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ äºèµ·ç‚¹ï¼Œä¸è¿”å›ä»»ä½•ä¸œè¥¿</strong></li><li><code>.resize(num)</code>ï¼šå°†å…ƒç´ æ•°é‡æ”¹ä¸º num (å¦‚æœ size() å˜å¤§ï¼Œå¤šå‡ºæ¥çš„æ–°å…ƒç´ éƒ½éœ€ä»¥ default æ„é€ å‡½æ•°å®Œæˆåˆå§‹åŒ–)</li><li><code>.resize(num, elem)</code>ï¼šå°†å…ƒç´ æ•°é‡æ”¹ä¸º num (å¦‚æœ size() å˜å¤§ï¼Œå¤šå‡ºæ¥çš„æ–°å…ƒç´ éƒ½æ˜¯ elem çš„æ‹·è´)</li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li></ul><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><p><img src="/../images/ProgramBasic_STL/list_thumb.svg" alt="standard library sequence container &#39;list"></p><p>åŒå‘é“¾è¡¨ï¼Œ<strong>åœ¨ä»»ä½•ä½ç½®ä¸Šæ‰§è¡Œå®‰æ’æˆ–åˆ é™¤åŠ¨ä½œéƒ½éå¸¸è¿…é€Ÿ</strong>ã€‚</p><ul><li><code>.front()</code>ï¼šè¿”å›ç¬¬ä¸€å…ƒç´ çš„<strong>å¼•ç”¨</strong></li><li><code>.back()</code>ï¼šè¿”å›æœ€æœ«å…ƒç´ çš„<strong>å¼•ç”¨</strong>ï¼Œ<code>c.back() = 10</code></li><li><code>.push_back(elem)</code>ï¼šå°¾éƒ¨é™„åŠ å…ƒç´ </li><li><code>.pop_back()</code>ï¼šç§»é™¤æœ€åä¸€ä¸ªå…ƒç´ </li><li><code>.push_front(elem)</code>ï¼šå¤´éƒ¨é™„åŠ å…ƒç´ </li><li><code>.pop_front()</code>ï¼šç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´ </li><li><code>.insert(pos, elem)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ä¸€ä¸ª elem æ‹·è´ï¼Œå¹¶è¿”å›æ–°å…ƒç´ çš„ä½ç½®</li><li><code>.insert(pos, n, elem)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ n ä¸ª elem æ‹·è´ï¼Œå¹¶è¿”å›ç¬¬ä¸€ä¸ªæ–°å…ƒç´ çš„ä½ç½®</li><li><code>.emplace(pos, args...)</code>ï¼šåœ¨iterator ä½ç½® pos ä¹‹å‰æ–¹æ’å…¥ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ ï¼Œå¹¶è¿”å›æ–°å…ƒç´ çš„ä½ç½®</li><li><code>.emplace_back(args...)</code>ï¼šé™„åŠ ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ äºæœªå°¾ï¼Œä¸è¿”å›ä»»ä½•ä¸œè¥¿</li><li><code>.emplace_front(args...)</code>ï¼šé™„åŠ ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ äºèµ·ç‚¹ï¼Œä¸è¿”å›ä»»ä½•ä¸œè¥¿</li><li><code>.resize(num)</code>ï¼šå°†å…ƒç´ æ•°é‡æ”¹ä¸º num (å¦‚æœ <code>size()</code> å˜å¤§ï¼Œå¤šå‡ºæ¥çš„æ–°å…ƒç´ éƒ½éœ€ä»¥ default æ„é€ å‡½æ•°å®Œæˆåˆå§‹åŒ–)</li><li><code>.resize(num, elem)</code>ï¼šå°†å…ƒç´ æ•°é‡æ”¹ä¸º num (å¦‚æœ <code>size()</code> å˜å¤§ï¼Œå¤šå‡ºæ¥çš„æ–°å…ƒç´ éƒ½æ˜¯ elem çš„æ‹·è´)</li><li><code>.remove(val)</code>ï¼šç§»é™¤æ‰€æœ‰å€¼ä¸º val çš„å…ƒç´ </li><li><code>.remove_if(op)</code>ï¼šç§»é™¤æ‰€æœ‰é€ æˆ <code>op(elem)</code> è¿”å› true çš„å…ƒç´ </li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li><li><code>.merge(other, comp)</code>ï¼šå°†ä¸¤ä¸ªæœ‰åº List åˆå¹¶æˆä¸€ä¸ª</li><li><code>.unique()</code>ï¼šç§»é™¤æ‰€æœ‰é‡å¤çš„å…ƒç´ ï¼Œé‡å¤å…ƒç´ ä¿ç•™ç¬¬ä¸€ä¸ª</li><li><code>.sort()</code>ï¼šå¯¹ List æŒ‰ç…§å‡åºæ’åº</li></ul><h3 id="Forward-List"><a href="#Forward-List" class="headerlink" title="Forward_List"></a>Forward_List</h3><p><img src="/../images/ProgramBasic_STL/forward_list_thumb.svg" alt="standard library sequence container &#39;forward_list"></p><p>forward liståŸåˆ™ä¸Šå°±æ˜¯ä¸€ä¸ªå—é™çš„listï¼Œä¸æ”¯æŒä»»ä½•â€œåé€€ç§»åŠ¨â€æˆ–â€œæ•ˆç‡ä½ä¸‹â€çš„æ“ä½œã€‚</p><p>åŸºäºè¿™ä¸ªåŸå› ï¼Œå®ƒä¸æä¾›æˆå‘˜å‡½æ•°å¦‚<code>push_back()</code> ç”šè‡³<code>size()</code>ã€‚</p><ul><li><code>.front()</code>ï¼šè¿”å›ç¬¬ä¸€å…ƒç´ çš„<strong>å¼•ç”¨</strong></li><li><code>.push_front(elem)</code>ï¼šå¤´éƒ¨é™„åŠ å…ƒç´ </li><li><code>.pop_front()</code>ï¼šç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´ </li><li><code>.insert_after(pos, args)</code>ï¼šåœ¨æŒ‡å®šçš„ pos åæ’å…¥ args</li><li><code>.emplace_after(pos, args)</code>ï¼šåœ¨æŒ‡å®šçš„ pos åæ’å…¥ args</li><li><code>.emplace_front(args...)</code>ï¼šé™„åŠ ä¸€ä¸ªä»¥ args ä¸ºåˆå€¼çš„å…ƒç´ äºèµ·ç‚¹</li><li><code>.remove(val)</code>ï¼šç§»é™¤æ‰€æœ‰å€¼ä¸º val çš„å…ƒç´ </li><li><code>.remove_if(op)</code>ï¼šç§»é™¤æ‰€æœ‰é€ æˆ <code>op(elem)</code> è¿”å› true çš„å…ƒç´ </li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li><li><code>.merge(other, comp)</code>ï¼šå°†ä¸¤ä¸ªæœ‰åº List åˆå¹¶æˆä¸€ä¸ª</li><li><code>.unique()</code>ï¼šç§»é™¤æ‰€æœ‰é‡å¤çš„å…ƒç´ ï¼Œé‡å¤å…ƒç´ ä¿ç•™ç¬¬ä¸€ä¸ª</li><li><code>.sort()</code>ï¼šæŒ‰ç…§å‡åºæ’åº</li></ul><h2 id="å…³è”å¼å®¹å™¨"><a href="#å…³è”å¼å®¹å™¨" class="headerlink" title="å…³è”å¼å®¹å™¨"></a>å…³è”å¼å®¹å™¨</h2><blockquote><p><a href="https://hackingcpp.com/cpp/std/associative_containers.html">å…³è”å¼å®¹å™¨ hackingcpp</a></p></blockquote><p>å…³è”å¼å®¹å™¨ä¾æ®ç‰¹å®šçš„æ’åºå‡†åˆ™ï¼Œè‡ªåŠ¨ä¸ºå…¶å…ƒç´ æ’åºã€‚</p><p>è‡ªåŠ¨æ’åºé€ æˆçš„ä¸€ä¸ªé‡è¦é™åˆ¶: ä½ ä¸èƒ½ç›´æ¥æ”¹å˜å…ƒç´ å€¼ï¼Œå› ä¸ºä¼šæ‰“ä¹±åŸæœ¬æ­£ç¡®çš„é¡ºåºã€‚</p><p><strong>è¦æ”¹å˜å…ƒç´ å€¼ï¼Œå¿…é¡»å…ˆåˆ é™¤æ—§å…ƒç´ ï¼Œå†æ’å…¥æ–°å…ƒç´ ã€‚</strong></p><p>é€šå¸¸å…³è”å¼å®¹å™¨ç”±<strong>çº¢é»‘æ ‘</strong>å®ç°ï¼Œå…¶å€¼æœ‰åºï¼Œä¸”æ’å…¥ã€æŸ¥æ‰¾ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸º<code>O(log n)</code>ã€‚</p><h3 id="setã€multiset"><a href="#setã€multiset" class="headerlink" title="setã€multiset"></a>setã€multiset</h3><p><img src="/../images/ProgramBasic_STL/set_thumb.svg" alt="internal structure of std::set"></p><p><strong>ç”±äº set ä¸å…è®¸é‡å¤å€¼ï¼Œset çš„ insert&#x2F;emplace è¿”å›å€¼ä¸º <code>pair&lt;iterator, bool&gt;</code>ï¼Œå…¶ä¸­ bool æ˜¯æŒ‡æ˜¯å¦æ’å…¥æˆåŠŸã€‚</strong></p><ul><li><code>.count(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ä¸ªæ•°</li><li><code>.find(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„è¿­ä»£å™¨ï¼Œæ‰¾ä¸åˆ°è¿”å› <code>end()</code></li><li><code>.contains(val)</code>ï¼šåˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼ˆc++20ï¼‰</li><li><code>.lower_bound(val)</code>ï¼šè¿”å›valçš„ç¬¬ä¸€ä¸ªå¯å®‰æ’ä½ç½®ï¼Œç¬¬ä¸€ä¸ª &gt;&#x3D; val çš„ä½ç½®</li><li><code>.upper_bound(val)</code>ï¼šè¿”å›valçš„ç¬¬ä¸€ä¸ªå¯å®‰æ’ä½ç½®ï¼Œç¬¬ä¸€ä¸ª &gt; val çš„ä½ç½®</li><li><code>.equal_range(val)</code>ï¼šè¿”å›valå¯å®‰æ’çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®</li><li><code>.insert(val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.insert(pos, val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆposæ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.emplace(args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.emplace_hint(pos, args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆpos æ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.merge(other)</code>ï¼šå°†ä¸¤ä¸ª set åˆå¹¶æˆä¸€ä¸ª</li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li></ul><h3 id="mapã€multimap"><a href="#mapã€multimap" class="headerlink" title="mapã€multimap"></a>mapã€multimap</h3><p><img src="/../images/ProgramBasic_STL/map_thumb.svg" alt="internal structure of std::map"></p><ul><li><code>.count(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ä¸ªæ•°</li><li><code>.find(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„è¿­ä»£å™¨ï¼Œæ‰¾ä¸åˆ°è¿”å› <code>end()</code></li><li><code>.contains(val)</code>ï¼šåˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼ˆc++20ï¼‰</li><li><code>.lower_bound(val)</code>ï¼šè¿”å›valçš„ç¬¬ä¸€ä¸ªå¯å®‰æ’ä½ç½®ï¼Œç¬¬ä¸€ä¸ª <code>&gt;= val</code> çš„ä½ç½®</li><li><code>.upper_bound(val)</code>ï¼šè¿”å›valçš„ç¬¬ä¸€ä¸ªå¯å®‰æ’ä½ç½®ï¼Œç¬¬ä¸€ä¸ª <code>&gt; val</code> çš„ä½ç½®</li><li><code>.equal_range(val)</code>ï¼šè¿”å›valå¯å®‰æ’çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªä½ç½®</li><li><code>.insert(val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.insert(pos, val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆposæ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.emplace(args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.emplace_hint(pos, args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆpos æ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.merge(other)</code>ï¼šå°†ä¸¤ä¸ª map åˆå¹¶æˆä¸€ä¸ª</li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li></ul><h2 id="æ— åºå®¹å™¨"><a href="#æ— åºå®¹å™¨" class="headerlink" title="æ— åºå®¹å™¨"></a>æ— åºå®¹å™¨</h2><p>é€šè¿‡ hash å®ç°æŸ¥æ‰¾</p><h3 id="unorder-setã€unorder-multiset"><a href="#unorder-setã€unorder-multiset" class="headerlink" title="unorder_setã€unorder_multiset"></a>unorder_setã€unorder_multiset</h3><p><img src="/../images/ProgramBasic_STL/unordered_set_thumb.svg" alt="internal structure of std::unordered_set"></p><ul><li><code>.count(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ä¸ªæ•°</li><li><code>.find(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„è¿­ä»£å™¨ï¼Œæ‰¾ä¸åˆ°è¿”å› <code>end()</code></li><li><code>.contains(val)</code>ï¼šåˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼ˆc++20ï¼‰</li><li><code>.insert(val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.insert(pos, val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆposæ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.emplace(args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.emplace_hint(pos, args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆpos æ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.merge(other)</code>ï¼šå°†ä¸¤ä¸ª set åˆå¹¶æˆä¸€ä¸ª</li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li></ul><h3 id="unorder-mapã€unorder-multimap"><a href="#unorder-mapã€unorder-multimap" class="headerlink" title="unorder_mapã€unorder_multimap"></a>unorder_mapã€unorder_multimap</h3><p><img src="/../images/ProgramBasic_STL/unordered_map_thumb.svg" alt="internal structure of std::unordered_map"></p><ul><li><code>.count(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ä¸ªæ•°</li><li><code>.find(val)</code>ï¼šè¿”å›å€¼ä¸ºvalçš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„è¿­ä»£å™¨ï¼Œæ‰¾ä¸åˆ°è¿”å› <code>end()</code></li><li><code>.contains(val)</code>ï¼šåˆ¤æ–­æ˜¯å¦åŒ…å«æŸä¸ªå…ƒç´ ï¼ˆc++20ï¼‰</li><li><code>.insert(val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.insert(pos, val)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆposæ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.emplace(args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨</li><li><code>.emplace_hint(pos, args...)</code>ï¼šæ’å…¥å…ƒç´ ï¼Œè¿”å›æ’å…¥çš„å…ƒç´ çš„è¿­ä»£å™¨ï¼ˆpos æ˜¯æç¤ºæ’å…¥èµ·ç‚¹ï¼‰</li><li><code>.merge(other)</code>ï¼šå°†ä¸¤ä¸ª set åˆå¹¶æˆä¸€ä¸ª</li><li><code>.clear()</code>ï¼šç§»é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°†å®¹å™¨æ¸…ç©º</li></ul><h2 id="ç‰¹æ®Šå®¹å™¨"><a href="#ç‰¹æ®Šå®¹å™¨" class="headerlink" title="ç‰¹æ®Šå®¹å™¨"></a>ç‰¹æ®Šå®¹å™¨</h2><h3 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h3><blockquote><p>åº•å±‚ä¸€èˆ¬ç”¨ <code>deque</code> å®ç°</p><p><code>stack</code> å’Œ <code>queue</code> å…¶å®æ˜¯é€‚é…å™¨ï¼Œè€Œä¸å«å®¹å™¨ï¼Œå› ä¸ºæ˜¯å¯¹å®¹å™¨çš„å†å°è£…</p></blockquote><ul><li><code>.push()</code>ï¼š å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥ stack ä¸­</li><li><code>.emplace()</code>ï¼š å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥ stack ä¸­ï¼Œæ•ˆç‡æ¯” push æ›´é«˜</li><li><code>.top()</code>ï¼š è¿”å› stack å†…çš„ä¸‹ä¸€ä¸ªå…ƒç´ </li><li><code>.pop()</code>ï¼š ä» stack å†…ç§»é™¤ä¸€ä¸ªå…ƒç´ </li></ul><h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><blockquote><p>åº•å±‚ä¸€èˆ¬ç”¨ <code>deque</code> å®ç°</p></blockquote><ul><li><code>.front()</code>ï¼šè¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ çš„<strong>å¼•ç”¨</strong>ï¼Œè¯¥å…ƒç´ å°†æœ€å…ˆå‡ºé˜Ÿ</li><li><code>.back()</code>ï¼šè¿”å›æœ€æœ«å…ƒç´ çš„<strong>å¼•ç”¨</strong>ï¼Œ<code>c.back() = 10</code></li><li><code>.push()</code>ï¼š å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥ queue ä¸­</li><li><code>.emplace()</code>ï¼š å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥ queue ä¸­ï¼Œæ•ˆç‡æ¯” push æ›´é«˜</li><li><code>.pop()</code>ï¼š ä» queue å†…ç§»é™¤ä¸€ä¸ªå…ƒç´ </li></ul><h3 id="Priority-queue"><a href="#Priority-queue" class="headerlink" title="Priority_queue"></a>Priority_queue</h3><blockquote><p>åº•å±‚æ•°æ®ç»“æ„ä¸€èˆ¬ä¸º <code>vector</code> ä¸ºåº•å±‚å®¹å™¨ï¼Œå † <code>heap</code> ä¸ºå¤„ç†è§„åˆ™æ¥ç®¡ç†åº•å±‚å®¹å™¨å®ç°ã€‚</p><ul><li>å·¦å­èŠ‚ç‚¹ <code>pos = now * 2 + 1</code></li><li>å³å­èŠ‚ç‚¹ <code>pos = now * 2 + 2</code></li><li>çˆ¶èŠ‚ç‚¹ <code>pos = (now - 1) / 2</code></li></ul></blockquote><p>å’Œqueueç±»ä¼¼ï¼Œä½†å…¶å…ƒç´ æœ‰ä¼˜å…ˆçº§ï¼Œdequeueæ—¶å¹¶éå–æœ€å…ˆæ”¾å…¥çš„å…ƒç´ ï¼Œè€Œæ˜¯ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ ï¼</p><p>å¦‚æœåŒæ—¶å­˜åœ¨è‹¥å¹²ä¸ªä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ ï¼Œæˆ‘ä»¬æ— æ³•ç¡®çŸ¥ç©¶ç«Ÿå“ªä¸€ä¸ªä¼šå…¥é€‰ã€‚</p><ul><li><code>.push()</code>ï¼š å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥priority queueä¸­</li><li><code>.emplace()</code>ï¼š å°†ä¸€ä¸ªå…ƒç´ æ”¾å…¥priority queueä¸­ï¼Œæ•ˆç‡æ¯” push æ›´é«˜</li><li><code>.top()</code>ï¼š è¿”å›priority queueå†…çš„ä¸‹ä¸€ä¸ªå…ƒç´ </li><li><code>.pop()</code>ï¼š ä»priority queueå†…ç§»é™¤ä¸€ä¸ªå…ƒç´ </li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> priority;</span><br><span class="line">    <span class="type">int</span> value;</span><br><span class="line">    Node(<span class="type">int</span> p, <span class="type">int</span> v) : priority(p), value(v) &#123;&#125;</span><br><span class="line">    <span class="type">bool</span> operator&lt;(<span class="type">const</span> Node&amp; other) <span class="type">const</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> priority &lt; other.priority;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cmp</span> &#123;</span></span><br><span class="line">    <span class="type">bool</span> <span class="title function_">operator</span><span class="params">()</span><span class="params">(<span class="type">const</span> Node &amp;a, <span class="type">const</span> Node &amp;b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> a-&gt;val &gt; b-&gt;val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// priority_queue&lt;int, vector&lt;int&gt;, less&lt;int&gt;&gt; pq; // method 1, æ­£å¸¸ç±»å‹</span></span><br><span class="line">    <span class="comment">// method 2, è‡ªå®šä¹‰ç±»å‹ï¼Œä¸èƒ½ä½¿ç”¨ lambda æˆ–è€…å‡½æ•°ï¼Œå¿…é¡»æ˜¯ç±»å‹é‡Œé¢é‡è½½è¿ç®—ç¬¦</span></span><br><span class="line">    <span class="comment">// priority_queue&lt;Node, vector&lt;Node&gt;, cmp&gt; pq;</span></span><br><span class="line">    <span class="built_in">priority_queue</span>&lt;Node&gt; pq;    <span class="comment">// method 3, é‡è½½äº† operator&lt;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">        pq.push(Node(i, i));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!pq.empty()) &#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; pq.top().value &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">        pq.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Bitset"><a href="#Bitset" class="headerlink" title="Bitset"></a>Bitset</h3><p>Bitseté€ å‡ºäº†ä¸€ä¸ªå†…å«bitæˆ–Booleanå€¼ä¸Šä¸”<strong>å¤§å°å›ºå®šçš„array</strong>ã€‚</p><ul><li><code>bitset&lt;size&gt;(value)</code>ï¼šä»¥ value åˆå§‹åŒ–å¤§å°ä¸ºsize çš„ bitset</li><li><code>bitset&lt;numeric_limits&lt;unsigned long&gt;::digits&gt;(value)</code></li><li><code>.any()</code>ï¼šæ£€æŸ¥æ˜¯å¦æœ‰ bit è¢«è®¾ç½®ä¸º1</li><li><code>.all()</code>ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰ bit éƒ½ä¸º1</li><li><code>.none()</code>ï¼šæ£€æŸ¥æ˜¯å¦æ‰€æœ‰ bit éƒ½ä¸º0</li><li><code>.set(pos)</code>ï¼šè®¾ç½® pos ä½ç½®çš„ bit ä¸º1</li><li><code>.reset()</code>ï¼šè®¾ç½®æ‰€æœ‰ bit ä¸º0</li><li><code>.reset(pos)</code>ï¼šè®¾ç½® pos ä½ç½®çš„ bit ä¸º0</li><li><code>.flip()</code>ï¼šç¿»è½¬æ‰€æœ‰ bit</li><li><code>.flip(pos)</code>ï¼šç¿»è½¬ pos ä½ç½®çš„ bit</li><li><code>.to_string()</code>ï¼šè¾“å‡ºä¸º01å­—ç¬¦ä¸²</li><li><code>.to_ullong()</code>ï¼šè¾“å‡ºä¸º unsigned long long ç±»å‹</li></ul><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><blockquote><ul><li><a href="https://hackingcpp.com/">hackingcpp</a>ï¼šæä¾›äº†<code>cpp</code>æ ‡å‡†åº“ä¸­çš„å®¹å™¨ã€ç®—æ³•ç”šè‡³åŒ…æ‹¬å†…å­˜ç®¡ç†ã€è°ƒè¯•æ–¹æ³•ç­‰ï¼Œå€¼å¾—ä¸€çœ‹ï¼Œæ­¤æ–‡æ¡£ä¸­çš„å›¾ç‰‡å°±æ¥æºäºè¯¥ç½‘ç«™ã€‚</li><li><a href="https://hackingcpp.com/cpp/std/algorithms.html">æ ‡å‡†åº“ç®—æ³•å¯è§†åŒ–</a></li><li><a href="https://hackingcpp.com/cpp/tools/gdb_intro.html">gdbè°ƒè¯•</a></li><li><a href="http://www.cplusplus.com/reference/clibrary/">C++ Reference æŸ¥æ‰¾åº“å‡½æ•°æ–‡æ¡£</a></li><li><a href="https://gx.jd.com/gx/gx_bookDetail.action?bookId=30656283">äº¬ä¸œå›¾ä¹¦ï¼šC++æ ‡å‡†åº“</a></li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> C++ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> C++ </tag>
            
            <tag> STL </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„æ‘˜è¦</title>
      <link href="/2022/04/23/DS_%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%91%98%E8%A6%81/"/>
      <url>/2022/04/23/DS_%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E6%91%98%E8%A6%81/</url>
      
        <content type="html"><![CDATA[<p>åªæœ‰é‡ç‚¹ã€ç®€æ´çš„ä»‹ç»ï¼Œæ–¹ä¾¿æŸ¥é˜…ï¼</p><blockquote><p><a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">æ•°æ®ç»“æ„å¯è§†åŒ–ç½‘ç«™</a>ï¼šéƒ¨åˆ†ç»“æ„å¦‚æ ‘ï¼Œç‚¹å‡»åéœ€è¦æ‰‹åŠ¨æ·»åŠ èŠ‚ç‚¹ï¼Œä¸”èƒ½çœ‹åˆ°å…¶å˜åŒ–çš„è¿‡ç¨‹ã€‚<br>å¦ä¸€ä¸ªå¯è§†åŒ–æ•°æ®ç»“æ„å’Œç®—æ³•çš„ç½‘ç«™ï¼š<a href="https://visualgo.net/zh">visualgo.net&#x2F;zh</a></p></blockquote><h2 id="æ ‘"><a href="#æ ‘" class="headerlink" title="æ ‘"></a>æ ‘</h2><ul><li>æ ‘æ˜¯ç”±æ ¹èŠ‚ç‚¹å’Œ<strong>è‹¥å¹²é¢—å­æ ‘</strong>æ„æˆã€‚</li><li>æ¯ä¸ªèŠ‚ç‚¹éƒ½åªæœ‰æœ‰é™ä¸ªå­èŠ‚ç‚¹æˆ–æ— å­èŠ‚ç‚¹ã€‚</li><li>æ²¡æœ‰çˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹ç§°ä¸º<strong>æ ¹èŠ‚ç‚¹</strong>ã€‚æ²¡æœ‰å­èŠ‚ç‚¹çš„èŠ‚ç‚¹ç§°ä¸º<strong>å¶å­èŠ‚ç‚¹</strong>ã€‚</li><li><strong>æ ‘çš„æ·±åº¦&#x2F;é«˜åº¦ï¼š</strong>æ ¹èŠ‚ç‚¹åˆ°æœ€è¿œå¶å­èŠ‚ç‚¹çš„æœ€é•¿è·¯å¾„ä¸Šçš„<strong>èŠ‚ç‚¹æ•°</strong>ã€‚</li></ul><h2 id="äºŒå‰æ ‘"><a href="#äºŒå‰æ ‘" class="headerlink" title="äºŒå‰æ ‘"></a>äºŒå‰æ ‘</h2><ul><li>æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šåªæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹çš„æ ‘ã€‚</li></ul><h2 id="æ»¡äºŒå‰æ ‘"><a href="#æ»¡äºŒå‰æ ‘" class="headerlink" title="æ»¡äºŒå‰æ ‘"></a>æ»¡äºŒå‰æ ‘</h2><ul><li>æ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä»…åŒ…å« 0 æˆ– 2 ä¸ªå­èŠ‚ç‚¹ã€‚</li></ul><h2 id="å®Œå…¨äºŒå‰æ ‘"><a href="#å®Œå…¨äºŒå‰æ ‘" class="headerlink" title="å®Œå…¨äºŒå‰æ ‘"></a>å®Œå…¨äºŒå‰æ ‘</h2><ul><li><strong>é™¤æœ€åä¸€å±‚å¤–</strong>ï¼Œæ¯ä¸€å±‚ä¸Šçš„ç»“ç‚¹æ•°å‡è¾¾åˆ°æœ€å¤§å€¼ï¼›åœ¨æœ€åä¸€å±‚ä¸Šåªç¼ºå°‘å³è¾¹çš„è‹¥å¹²ç»“ç‚¹ã€‚</li><li><strong>é‡è¦æ€§è´¨ï¼š</strong><ol><li>åœ¨äºŒå‰æ ‘ä¸Šçš„ç¬¬<code>i</code>å±‚ä¸Šè‡³å¤šæœ‰ $2^{i-1}, i&gt;&#x3D;1$ä¸ªèŠ‚ç‚¹ã€‚</li><li>æ·±åº¦ä¸º<code>k</code>çš„äºŒå‰æ ‘è‡³å¤šæœ‰ $2^k-1, k &gt;&#x3D; 1$ä¸ªèŠ‚ç‚¹ã€‚</li><li>å…·æœ‰<code>n</code>ä¸ªèŠ‚ç‚¹çš„å®Œå…¨äºŒå‰æ ‘çš„æ·±åº¦ä¸º <code>floor&#123; log2(n) &#125; + 1</code> ã€‚</li></ol></li><li>å¯¹ä¸€é¢—å…·æœ‰<code>n</code>ä¸ªèŠ‚ç‚¹çš„å®Œå…¨äºŒå‰æ ‘ä¸­çš„èŠ‚ç‚¹<strong>ä»<code>0</code>å¼€å§‹æŒ‰å±‚åºç¼–å·</strong>ï¼Œå¯¹ä»»æ„èŠ‚ç‚¹<code>i</code>ï¼š<ul><li>å…¶çˆ¶èŠ‚ç‚¹ç¼–å·ä¸ºï¼š<code>floor&#123; (i-1)/2 &#125;</code></li><li>è‹¥<code>2i &lt; n-1</code>ï¼Œåˆ™å…¶å·¦å­©å­ç¼–å·ä¸ºï¼š<code>2i + 1</code></li></ul></li><li>å¯¹ä¸€é¢—å…·æœ‰<code>n</code>ä¸ªèŠ‚ç‚¹çš„å®Œå…¨äºŒå‰æ ‘ä¸­çš„èŠ‚ç‚¹<strong>ä»<code>1</code>å¼€å§‹æŒ‰å±‚åºç¼–å·</strong>ï¼Œå¯¹ä»»æ„èŠ‚ç‚¹<code>i</code>ï¼š<ul><li><strong>å…¶çˆ¶èŠ‚ç‚¹ç¼–å·ä¸ºï¼š<code>floor&#123; i/2 &#125;</code></strong></li><li><strong>è‹¥<code>2i &lt; n</code>ï¼Œåˆ™å…¶å·¦å­©å­ç¼–å·ä¸ºï¼š<code>2i</code></strong></li><li>ä¸ºä¾¿äºè®¡ç®—ï¼Œæ¨èä»1å¼€å§‹ï¼ˆæ•°ç»„çš„ç¬¬0ä½ä¸ç”¨ï¼‰ã€‚</li></ul></li></ul><h2 id="å®Œç¾äºŒå‰æ ‘"><a href="#å®Œç¾äºŒå‰æ ‘" class="headerlink" title="å®Œç¾äºŒå‰æ ‘"></a>å®Œç¾äºŒå‰æ ‘</h2><ul><li>äºŒå‰æ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ï¼ˆé™¤å¶å­èŠ‚ç‚¹å¤–ï¼‰éƒ½æ‹¥æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œå¹¶ä¸”å…·æœ‰<strong>ç›¸åŒçš„é«˜åº¦</strong>ã€‚</li></ul><h2 id="äºŒå‰æœç´¢æ ‘"><a href="#äºŒå‰æœç´¢æ ‘" class="headerlink" title="äºŒå‰æœç´¢æ ‘"></a>äºŒå‰æœç´¢æ ‘</h2><ul><li>äºŒå‰æœç´¢æ ‘åˆç§°äºŒå‰æ’åºæ ‘ã€äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œç®€ç»Ÿç§°BSTã€‚</li><li>ä¸€ç§ç‰¹æ®Šçš„äºŒå‰æ ‘ï¼Œå…¶ä»»ä½•èŠ‚ç‚¹ä¸­çš„å€¼éƒ½ä¼š<strong>å¤§äºç­‰äºå…¶å·¦å­èŠ‚ç‚¹</strong>å¹¶ä¸”<strong>å°äºç­‰äºå…¶å³å­èŠ‚ç‚¹</strong>ã€‚</li></ul><h2 id="äºŒå‰å¹³è¡¡æ ‘"><a href="#äºŒå‰å¹³è¡¡æ ‘" class="headerlink" title="äºŒå‰å¹³è¡¡æ ‘"></a>äºŒå‰å¹³è¡¡æ ‘</h2><ul><li>å®ƒå¯ä»¥æ˜¯ä¸€é¢—ç©ºæ ‘ï¼Œæˆ–è€…å…·æœ‰ä»¥ä¸‹æ€§è´¨çš„äºŒå‰æ’åºæ ‘ï¼šå®ƒçš„<strong>å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦ä¹‹å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1</strong>ä¸”å®ƒçš„å·¦å­æ ‘å’Œå³å­æ ‘éƒ½æ˜¯ä¸€é¢—å¹³è¡¡äºŒå‰æ ‘ã€‚</li><li>å¹³è¡¡äºŒå‰æ ‘æŸ¥è¯¢ã€æ’å…¥ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <code>O(logN)</code>ã€‚</li></ul><p>ä½†æ˜¯å¹³è¡¡äºŒå‰æ ‘ä¹Ÿä¸æ˜¯å®Œç¾çš„ï¼ŒAVLæ ‘æœ€å¤§çš„ç¼ºç‚¹å°±æ˜¯åˆ é™¤èŠ‚ç‚¹æ—¶æœ‰å¯èƒ½å› ä¸ºå¤±è¡¡ï¼Œå¯¼è‡´éœ€è¦ä»åˆ é™¤èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹å¼€å§‹ï¼Œä¸æ–­çš„å›æº¯åˆ°æ ¹èŠ‚ç‚¹ï¼Œå¦‚æœè¿™æ£µAVLæ ‘å¾ˆé«˜çš„è¯ï¼Œé‚£ä¸­é—´å°±è¦åˆ¤æ–­å¾ˆå¤šä¸ªèŠ‚ç‚¹ï¼Œæ•ˆç‡å°±æ˜¾ç„¶å˜çš„ä½ä¸‹ï¼</p><h2 id="çº¢é»‘æ ‘"><a href="#çº¢é»‘æ ‘" class="headerlink" title="çº¢é»‘æ ‘"></a>çº¢é»‘æ ‘</h2><p>çº¢é»‘æ ‘æ˜¯ä¸€ç§å«æœ‰çº¢é»‘ç»“ç‚¹å¹¶<strong>èƒ½è‡ªå¹³è¡¡çš„</strong>äºŒå‰æŸ¥æ‰¾æ ‘ï¼Œä¹Ÿæ˜¯ä¸€ç§<strong>å¼±</strong>äºŒå‰å¹³è¡¡æ ‘ï¼Œ<strong>å¼±</strong>æ˜¯æŒ‡çº¢é»‘æ ‘ä¸æ˜¯ä¸¥æ ¼å¹³è¡¡çš„ã€‚äºŒå‰å¹³è¡¡æ ‘çš„å·¦å­æ ‘å’Œå³å­æ ‘çš„é«˜åº¦ä¹‹å·®çš„ç»å¯¹å€¼ä¸è¶…è¿‡1ï¼Œä½†<strong>çº¢é»‘æ ‘åœ¨æŸäº›æ—¶åˆ»å¯èƒ½ä¼šè¶…è¿‡1</strong>ï¼Œåªè¦ç¬¦åˆçº¢é»‘æ ‘çš„äº”ä¸ªæ¡ä»¶å³å¯ã€‚</p><ul><li>æ€§è´¨1ï¼šæ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯é»‘è‰²ï¼Œè¦ä¹ˆæ˜¯çº¢è‰²ã€‚</li><li>æ€§è´¨2ï¼šæ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚</li><li>æ€§è´¨3ï¼šæ¯ä¸ªå¶å­èŠ‚ç‚¹ï¼ˆNILï¼‰æ˜¯é»‘è‰²ã€‚</li><li>æ€§è´¨4ï¼šæ¯ä¸ªçº¢è‰²ç»“ç‚¹çš„ä¸¤ä¸ªå­ç»“ç‚¹ä¸€å®šéƒ½æ˜¯é»‘è‰²ã€‚</li><li>æ€§è´¨5ï¼šä»»æ„ä¸€ç»“ç‚¹åˆ°æ¯ä¸ªå¶å­ç»“ç‚¹çš„è·¯å¾„éƒ½åŒ…å«æ•°é‡ç›¸åŒçš„é»‘ç»“ç‚¹ã€‚<ul><li>æ€§è´¨5.1ï¼šå¦‚æœä¸€ä¸ªç»“ç‚¹å­˜åœ¨é»‘å­ç»“ç‚¹ï¼Œé‚£ä¹ˆè¯¥ç»“ç‚¹è‚¯å®šæœ‰ä¸¤ä¸ªå­ç»“ç‚¹ã€‚</li></ul></li></ul><p>çº¢é»‘æ ‘å’ŒäºŒå‰å¹³è¡¡æ ‘çš„åŒºåˆ«ï¼š</p><ol><li>çº¢é»‘æ ‘æ”¾å¼ƒäº†è¿½æ±‚å®Œå…¨å¹³è¡¡ï¼Œè¿½æ±‚å¤§è‡´å¹³è¡¡ï¼Œåœ¨ä¸å¹³è¡¡äºŒå‰æ ‘çš„æ—¶é—´å¤æ‚åº¦ç›¸å·®ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ¯æ¬¡æ’å…¥æœ€å¤šåªéœ€è¦ä¸‰æ¬¡æ—‹è½¬å°±èƒ½è¾¾åˆ°å¹³è¡¡ï¼Œå®ç°èµ·æ¥ä¹Ÿæ›´ä¸ºç®€å•ã€‚</li><li>å¹³è¡¡äºŒå‰æ ‘è¿½æ±‚ç»å¯¹å¹³è¡¡ï¼Œæ¡ä»¶æ¯”è¾ƒè‹›åˆ»ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œæ¯æ¬¡æ’å…¥æ–°èŠ‚ç‚¹ä¹‹åéœ€è¦æ—‹è½¬çš„æ¬¡æ•°ä¸èƒ½é¢„çŸ¥ã€‚</li></ol><h2 id="å­—å…¸æ ‘ï¼ˆTrieæ ‘ï¼Œå‰ç¼€æ ‘ï¼‰"><a href="#å­—å…¸æ ‘ï¼ˆTrieæ ‘ï¼Œå‰ç¼€æ ‘ï¼‰" class="headerlink" title="å­—å…¸æ ‘ï¼ˆTrieæ ‘ï¼Œå‰ç¼€æ ‘ï¼‰"></a>å­—å…¸æ ‘ï¼ˆTrieæ ‘ï¼Œå‰ç¼€æ ‘ï¼‰</h2><ul><li>ä»æ ¹èŠ‚ç‚¹åˆ°æŸä¸€ä¸ªèŠ‚ç‚¹ï¼Œè·¯è¿‡çš„<strong>å­—ç¬¦</strong>è¿èµ·æ¥å°±æ˜¯è¯¥èŠ‚ç‚¹å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚</li><li>åˆ©ç”¨å­—ç¬¦ä¸²çš„å…¬å…±å‰ç¼€æ¥å‡å°‘æŸ¥è¯¢æ—¶é—´ï¼Œæœ€å¤§é™åº¦åœ°å‡å°‘æ— è°“çš„å­—ç¬¦ä¸²æ¯”è¾ƒï¼ŒæŸ¥è¯¢æ•ˆç‡æ¯”å“ˆå¸Œæ ‘é«˜ã€‚</li><li>å¸¸ç”¨äºæœç´¢æç¤ºã€‚å¦‚å½“è¾“å…¥éƒ¨åˆ†å†…å®¹ï¼Œå¯ä»¥è‡ªåŠ¨æœç´¢å‡ºå¯èƒ½çš„é€‰æ‹©ã€‚</li></ul><h2 id="æ ˆ"><a href="#æ ˆ" class="headerlink" title="æ ˆ"></a>æ ˆ</h2><ul><li>åè¿›å…ˆå‡º</li></ul><h2 id="å•è°ƒæ ˆ"><a href="#å•è°ƒæ ˆ" class="headerlink" title="å•è°ƒæ ˆ"></a>å•è°ƒæ ˆ</h2><ul><li>è¦æ±‚æ˜¯æ¯æ¬¡å…¥æ ˆçš„å…ƒç´ å¿…é¡»è¦æœ‰åºï¼ˆ<strong>å¦‚æœæ–°å…ƒç´ å…¥æ ˆä¸ç¬¦åˆè¦æ±‚ï¼Œåˆ™å°†ä¹‹å‰çš„å…ƒç´ å‡ºæ ˆï¼Œç›´åˆ°ç¬¦åˆè¦æ±‚å†å…¥æ ˆ</strong>ï¼‰ï¼Œä½¿ä¹‹å½¢æˆ<strong>å•è°ƒé€’å¢&#x2F;å•è°ƒé€’å‡</strong>çš„ä¸€ä¸ªæ ˆã€‚</li><li>å•è°ƒé€’å¢æ ˆï¼šåªæœ‰æ¯”æ ˆé¡¶å°çš„æ‰èƒ½å…¥æ ˆï¼Œå¦åˆ™å°±æŠŠæ ˆé¡¶å‡ºæ ˆåï¼Œå†å…¥æ ˆã€‚å‡ºæ ˆæ—¶å¯èƒ½ä¼šæœ‰ä¸€äº›è®¡ç®—ã€‚<strong>é€‚ç”¨äºæ±‚è§£ç¬¬ä¸€ä¸ªå¤§äºè¯¥ä½ç½®å…ƒç´ çš„æ•°</strong>ã€‚</li><li>å•è°ƒé€’å‡æ ˆï¼šä¸å•è°ƒé€’å¢æ ˆç›¸åã€‚é€‚ç”¨äºæ±‚è§£ç¬¬ä¸€ä¸ªå°äºè¯¥ä½ç½®å…ƒç´ çš„æ•°ã€‚</li><li><strong>å“¨å…µæŠ€å·§ï¼š</strong>ä¾‹å¦‚åœ¨ {1, 3, 4, 5, 2, 9, 6} æœ«å°¾æ·»åŠ ä¸€ä¸ª -1 ä½œä¸ºå“¨å…µï¼Œå˜æˆäº† {1, 3, 4, 5, 2, 9, 6, -1} ï¼Œè¿™ç§æŠ€å·§å¯ä»¥ç®€åŒ–ä»£ç é€»è¾‘ã€‚</li></ul><h2 id="é˜Ÿåˆ—"><a href="#é˜Ÿåˆ—" class="headerlink" title="é˜Ÿåˆ—"></a>é˜Ÿåˆ—</h2><ul><li>å…ˆè¿›å…ˆå‡º</li></ul><h2 id="ä¼˜å…ˆé˜Ÿåˆ—"><a href="#ä¼˜å…ˆé˜Ÿåˆ—" class="headerlink" title="ä¼˜å…ˆé˜Ÿåˆ—"></a>ä¼˜å…ˆé˜Ÿåˆ—</h2><ul><li>ä¼˜å…ˆé˜Ÿåˆ—ä¸€èˆ¬ä½¿ç”¨<strong>äºŒå‰å †</strong>å®ç°ã€‚</li></ul><h2 id="å †"><a href="#å †" class="headerlink" title="å †"></a>å †</h2><ul><li><p>å †æ€»æ˜¯ä¸€æ£µ<strong>å®Œå…¨äºŒå‰æ ‘</strong>ï¼Œ<strong>ç”¨æ•°ç»„å­˜å‚¨</strong>ï¼Œæ ¹æ®å®Œå…¨äºŒå‰æ ‘çš„æ€§è´¨å¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ‰¾åˆ°æŸä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹æˆ–çˆ¶èŠ‚ç‚¹çš„ä¸‹æ ‡ã€‚</p></li><li><p>å †ä¸­æŸä¸ªç»“ç‚¹çš„å€¼æ€»æ˜¯<strong>ä¸å¤§äº</strong>æˆ–<strong>ä¸å°äº</strong>å…¶çˆ¶ç»“ç‚¹çš„å€¼ã€‚</p></li><li><p><strong>å †æ’åº</strong>ã€‚</p></li></ul><h2 id="å¤§é¡¶å †ï¼ˆå¤§æ ¹å †ï¼‰"><a href="#å¤§é¡¶å †ï¼ˆå¤§æ ¹å †ï¼‰" class="headerlink" title="å¤§é¡¶å †ï¼ˆå¤§æ ¹å †ï¼‰"></a>å¤§é¡¶å †ï¼ˆå¤§æ ¹å †ï¼‰</h2><ul><li>å †ä¸­æŸä¸ªç»“ç‚¹çš„å€¼æ€»æ˜¯<strong>ä¸å¤§äº</strong>å…¶çˆ¶ç»“ç‚¹çš„å€¼ï¼›<strong>æ ¹èŠ‚ç‚¹çš„å€¼æœ€å¤§ï¼</strong></li></ul><h2 id="å°é¡¶å †ï¼ˆå°æ ¹å †ï¼‰"><a href="#å°é¡¶å †ï¼ˆå°æ ¹å †ï¼‰" class="headerlink" title="å°é¡¶å †ï¼ˆå°æ ¹å †ï¼‰"></a>å°é¡¶å †ï¼ˆå°æ ¹å †ï¼‰</h2><ul><li>å †ä¸­æŸä¸ªç»“ç‚¹çš„å€¼æ€»æ˜¯<strong>ä¸å°äº</strong>å…¶çˆ¶ç»“ç‚¹çš„å€¼ï¼›<strong>æ ¹èŠ‚ç‚¹çš„å€¼æœ€å°ï¼</strong></li></ul><h2 id="ç›¸å…³èµ„æ–™"><a href="#ç›¸å…³èµ„æ–™" class="headerlink" title="ç›¸å…³èµ„æ–™"></a>ç›¸å…³èµ„æ–™</h2><blockquote><ul><li><a href="https://www.cs.usfca.edu/~galles/visualization/Algorithms.html">æ•°æ®ç»“æ„å¯è§†åŒ–ç½‘ç«™</a></li><li><a href="https://visualgo.net/en">æ•°æ®ç»“æ„ä¸ç®—æ³•å¯è§†åŒ–</a></li><li><a href="https://www.cnblogs.com/yichunguo/p/12040456.html">äºŒå‰å¹³è¡¡æ ‘</a></li><li><a href="https://www.jianshu.com/p/e136ec79235c">çº¢é»‘æ ‘</a></li></ul></blockquote>]]></content>
      
      
      <categories>
          
          <category> Algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Algorithm </tag>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Tensorflow-hub</title>
      <link href="/2021/12/27/Tensorflow-hub/"/>
      <url>/2021/12/27/Tensorflow-hub/</url>
      
        <content type="html"><![CDATA[<h2 id="Tensorflow-hubä»‹ç»"><a href="#Tensorflow-hubä»‹ç»" class="headerlink" title="Tensorflow-hubä»‹ç»"></a><code>Tensorflow-hub</code>ä»‹ç»</h2><p><img src="/../images/Tensorflow-hub/006xUmvuly1gpoths386wj311y0iln04.jpg" alt="scrnli_4_19_2021_9-54-50 AM.png"></p><p><a href="https://tfhub.dev/">tfhub.dev</a>åŒ…å«ä¸€ç³»åˆ—æ¨¡å‹ï¼Œæ ¹æ®å¤„ç†å¯¹è±¡<code>Problem domain</code>åˆ†æˆäº†å››ç±»ï¼š<code>Image, Text, Video, Audio</code></p><h2 id="æ¨¡å‹æ ¼å¼"><a href="#æ¨¡å‹æ ¼å¼" class="headerlink" title="æ¨¡å‹æ ¼å¼"></a>æ¨¡å‹æ ¼å¼</h2><p>æ¨¡å‹æ ¼å¼åˆå¯åˆ†ä¸º<code>TF.js, TFLite, Coral</code></p><ul><li><code>TF.js</code> æ˜¯ç”¨äºæµè§ˆå™¨çš„æ¨¡å‹ã€‚<a href="https://blog.csdn.net/xiangzhihong8/article/details/82597644">ref</a></li><li><code>TFLite</code> ä½¿ç”¨çš„æ€è·¯ä¸»è¦æ˜¯ä»é¢„è®­ç»ƒçš„æ¨¡å‹è½¬æ¢ä¸ºtfliteæ¨¡å‹æ–‡ä»¶ï¼Œæ‹¿åˆ°ç§»åŠ¨ç«¯éƒ¨ç½²ã€‚<a href="https://blog.csdn.net/yuanlulu/article/details/84063503">ref</a><br><img src="/../images/Tensorflow-hub/006xUmvuly1gpou0gwc06j30lw0cu3zc-168171479005116.jpg" alt="undefined"></li><li><code>Coral</code> æ˜¯googleå‘å¸ƒåœ¨ä¸€æ¬¾å¼€å‘æ¿ï¼Œç±»ä¼¼æ ‘è“æ´¾ï¼Œä¸“é—¨ç”¨äºè·‘ç¥ç»ç½‘ç»œæ¨¡å‹ã€‚<a href="https://www.sohu.com/a/299688498_223764">ref</a><br><img src="/../images/Tensorflow-hub/006xUmvuly1gpoud2vi74j30pn0dmjtx.jpg" alt="scrnli_4_19_2021_10-24-56 AM.png"></li></ul><p>ä¸Šè¿°ä¸‰ç±»æ¨¡å‹éƒ½æ˜¯æ¯”è¾ƒç‰¹æ®Šçš„æ ¼å¼ï¼ˆåœ¨ç”µè„‘ä¸Šæˆ–æœåŠ¡å™¨ä¸Šè¿è¡Œä¸ä½¿ç”¨ä¸Šè¿°3ç§æ ¼å¼ï¼ï¼‰ï¼Œæ¨¡å‹åˆ—è¡¨ä¸­çš„å³ä¸Šè§’æœ‰æ ‡å‡ºæ ¼å¼ã€‚è€Œå®é™…ä¸Šè¿˜æœ‰å…¶ä»–æ ¼å¼çš„æ¨¡å‹ï¼ˆ<code>TF2.0 Saved Model, Hub module</code>ç­‰ï¼‰ï¼Œåªæœ‰è¿›å…¥æ¨¡å‹é¡µé¢åæ‰èƒ½çœ‹è§ã€‚<br><img src="/../images/Tensorflow-hub/006xUmvuly1gpouy58k3ij30wn08zmyf.jpg" alt="scrnli_4_19_2021_10-44-35 AM.png"><br><img src="/../images/Tensorflow-hub/006xUmvuly1gpouzhx6htj30wr0a875w-168171483639024.jpg" alt="scrnli_4_19_2021_10-46-27 AM.png"></p><p><strong><code>Tensorflow Serving</code> ä½¿ç”¨çš„æ˜¯<code>TF2.0 Saved Model</code>æ ¼å¼çš„æ¨¡å‹ï¼</strong></p><hr><hr><p><img src="/../images/Tensorflow-hub/006xUmvuly1gpounyjsgdj30ph0dfq4q.jpg" alt="scrnli_4_19_2021_10-35-24 AM.png"><br><code>Collection</code>æ˜¯å¤„ç†ä¸€ç±»é—®é¢˜çš„ä¸€ç³»åˆ—æ¨¡å‹çš„é›†åˆï¼Œè€Œä¸”åœ¨<code>Collection</code>ä¸­ä¼šå±•ç¤ºæ¨¡å‹çš„æ€§èƒ½ï¼ˆæ¨ç†æ—¶é—´ç­‰ï¼ï¼‰åœ¨é€‰æ‹©æ¨¡å‹æ—¶éå¸¸æ–¹ä¾¿<br><img src="/../images/Tensorflow-hub/006xUmvuly1gpoupu3wqhj311y0ilad3.jpg" alt="scrnli_4_19_2021_10-36-43 AM.png"></p><hr><h2 id="æ¨¡å‹ä½¿ç”¨"><a href="#æ¨¡å‹ä½¿ç”¨" class="headerlink" title="æ¨¡å‹ä½¿ç”¨"></a>æ¨¡å‹ä½¿ç”¨</h2><p>è¿›å…¥æ¨¡å‹ä»‹ç»é¡µé¢åï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/../images/Tensorflow-hub/006xUmvuly1gpouzhx6htj30wr0a875w.jpg" alt="scrnli_4_19_2021_10-46-27 AM.png"></p><ul><li><code>COPY URL</code> å¤åˆ¶æ¨¡å‹é“¾æ¥ï¼Œåœ¨åŠ è½½æ¨¡å‹æ—¶ï¼Œå¯ç›´æ¥ä½¿ç”¨<code>hub.load(&quot;model url&quot;)</code>çš„æ–¹å¼æ¥åŠ è½½ï¼Œå®ƒä¼šå…ˆè‡ªåŠ¨ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°ï¼Œå†åŠ è½½æ¨¡å‹ã€‚ä½†ç”±äºç½‘ç»œç¯å¢ƒé™åˆ¶ï¼Œä¸å¤ªå¥½ç”¨ï¼Œä¸€èˆ¬ç”¨ä¸‹é¢çš„æ–¹æ³•ã€‚</li><li><code>download</code> ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°ï¼ŒåŠ è½½æ¨¡å‹æ—¶ï¼Œå¯ç›´æ¥ä½¿ç”¨<code>hub.load(&quot;/home/xxx/modlepath&quot;)</code>ï¼ŒæŒ‡å®šæœ¬åœ°æ¨¡å‹çš„è·¯å¾„ã€‚</li><li><strong><code>open colab notebook</code> åœ¨colabä¸­ä½¿ç”¨æ­¤æ¨¡å‹ï¼Œå¹¶ä¸”æä¾›äº†æ¨¡å‹çš„ä½¿ç”¨æ–¹æ³•ï¼Œéå¸¸æ–¹ä¾¿ï¼ï¼ï¼ï¼</strong></li></ul><h2 id="image-object-Detective"><a href="#image-object-Detective" class="headerlink" title="image object Detective"></a>image object Detective</h2><p>ä¸‹é¢æ¼”ç¤ºå¦‚ä½•æœ¬åœ°åŠ è½½ç›®æ ‡æ£€æµ‹çš„æ¨¡å‹ä»¥åŠç”¨<code>Tensorflow Serving</code>éƒ¨ç½²æ¨¡å‹ï¼</p><ol><li><p>ä¸‹è½½æ¨¡å‹æ–‡ä»¶<br> <a href="https://tfhub.dev/tensorflow/collections/object_detection/1">æ¨¡å‹é›†åˆ</a>ï¼Œéšä¾¿é€‰æ‹©ä¸€ä¸ªæ¨¡å‹ï¼Œ<code>output</code>ä¸€æ ä¸­æœ‰<code>Boxes, Boxes/Keypoints</code>è¡¨ç¤ºç”¨æ–¹æ¡†æˆ–æ–¹æ¡†+å…³é”®ç‚¹è¡¨ç¤ºç‰©ä½“ã€‚[é€‰æ‹©ä¸€ä¸ªæ¨¡å‹]åï¼Œå°†æ¨¡å‹æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ã€‚<em>å†ç‚¹å‡»<code>open colab notebook</code>ï¼ŒæŸ¥çœ‹å¦‚ä½•ä½¿ç”¨</em></p></li><li><p>å®‰è£…å¯è§†åŒ–å·¥å…·<br> ç”±äºæ¨¡å‹çš„è¾“å‡ºæ˜¯ç‰©ä½“åœ¨å›¾ç‰‡ä¸­çš„åæ ‡ï¼ˆæ–¹æ¡†çš„ç‚¹çš„ä½ç½®ï¼‰ï¼Œåªæ˜¯æ•°å­—è€Œä¸æ˜¯å›¾ç‰‡ï¼Œä¸åˆ©äºè§‚å¯Ÿï¼Œæ‰€ä»¥éœ€è¦å°†æ–¹æ¡†ç”»åœ¨åŸå›¾ä¸­ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…ç›¸åº”çš„åŒ…æ¥å®Œæˆã€‚</p>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Clone the tensorflow models repository</span></span><br><span class="line">git <span class="built_in">clone</span> --depth 1 https://github.com/tensorflow/models</span><br><span class="line">sudo apt install -y protobuf-compiler</span><br><span class="line"><span class="built_in">cd</span> models/research/</span><br><span class="line">protoc object_detection/protos/*.proto --python_out=.</span><br><span class="line"><span class="built_in">cp</span> object_detection/packages/tf2/setup.py .</span><br><span class="line">python -m pip install .</span><br></pre></td></tr></table></figure></li><li><p>æœ¬åœ°åŠ è½½æ¨¡å‹å¹¶æµ‹è¯•ï¼Œæ³¨æ„ä¿®æ”¹ä¸‹é¢çš„è·¯å¾„å˜é‡</p>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> six <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line"><span class="keyword">from</span> six.moves.urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_hub <span class="keyword">as</span> hub</span><br><span class="line"></span><br><span class="line"><span class="comment"># visualization</span></span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> label_map_util</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> visualization_utils <span class="keyword">as</span> viz_utils</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> ops <span class="keyword">as</span> utils_ops</span><br><span class="line"></span><br><span class="line">COCO17_HUMAN_POSE_KEYPOINTS = [(<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">5</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">6</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="number">7</span>),</span><br><span class="line">    (<span class="number">7</span>, <span class="number">9</span>),</span><br><span class="line">    (<span class="number">6</span>, <span class="number">8</span>),</span><br><span class="line">    (<span class="number">8</span>, <span class="number">10</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="number">11</span>),</span><br><span class="line">    (<span class="number">6</span>, <span class="number">12</span>),</span><br><span class="line">    (<span class="number">11</span>, <span class="number">12</span>),</span><br><span class="line">    (<span class="number">11</span>, <span class="number">13</span>),</span><br><span class="line">    (<span class="number">13</span>, <span class="number">15</span>),</span><br><span class="line">    (<span class="number">12</span>, <span class="number">14</span>),</span><br><span class="line">    (<span class="number">14</span>, <span class="number">16</span>)]</span><br><span class="line"></span><br><span class="line">MODEL_PATH = <span class="string">&quot;***/TensorflowServer/Model/centernet_resnet50v2_512x512_1/1&quot;</span></span><br><span class="line">PATH_TO_LABELS = <span class="string">&#x27;***/models/research/object_detection/data/mscoco_label_map.pbtxt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_image_into_numpy_array</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Load an image from file into a numpy array.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Puts image into numpy array to feed into tensorflow graph.</span></span><br><span class="line"><span class="string">    Note that by convention we put it into a numpy array with shape</span></span><br><span class="line"><span class="string">    (height, width, channels), where channels=3 for RGB.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        path: the file path to the image</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">        uint8 numpy array with shape (img_height, img_width, 3)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span>(path.startswith(<span class="string">&#x27;http&#x27;</span>)):</span><br><span class="line">        response = urlopen(path)</span><br><span class="line">        image_data = response.read()</span><br><span class="line">        image_data = BytesIO(image_data)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(image_data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        image_data = tf.io.gfile.GFile(path, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">        image = Image.<span class="built_in">open</span>(BytesIO(image_data))</span><br><span class="line"></span><br><span class="line">    (im_width, im_height) = image.size</span><br><span class="line">    <span class="keyword">return</span> np.array(image.getdata()).reshape((<span class="number">1</span>, im_height, im_width, <span class="number">3</span>)).astype(np.uint8)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualization</span>(<span class="params">result, image_np</span>):</span><br><span class="line">    category_index = label_map_util.create_category_index_from_labelmap(PATH_TO_LABELS, use_display_name=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    label_id_offset = <span class="number">0</span></span><br><span class="line">    image_np_with_detections = image_np.copy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use keypoints if available in detections</span></span><br><span class="line">    keypoints, keypoint_scores = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;detection_keypoints&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">        keypoints = result[<span class="string">&#x27;detection_keypoints&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        keypoint_scores = result[<span class="string">&#x27;detection_keypoint_scores&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    viz_utils.visualize_boxes_and_labels_on_image_array(</span><br><span class="line">        image_np_with_detections[<span class="number">0</span>],</span><br><span class="line">        result[<span class="string">&#x27;detection_boxes&#x27;</span>][<span class="number">0</span>],</span><br><span class="line">        (result[<span class="string">&#x27;detection_classes&#x27;</span>][<span class="number">0</span>] + label_id_offset).astype(<span class="built_in">int</span>),</span><br><span class="line">        result[<span class="string">&#x27;detection_scores&#x27;</span>][<span class="number">0</span>],</span><br><span class="line">        category_index,</span><br><span class="line">        use_normalized_coordinates=<span class="literal">True</span>,</span><br><span class="line">        max_boxes_to_draw=<span class="number">200</span>,</span><br><span class="line">        min_score_thresh=<span class="number">.30</span>,</span><br><span class="line">        agnostic_mode=<span class="literal">False</span>,</span><br><span class="line">        keypoints=keypoints,</span><br><span class="line">        keypoint_scores=keypoint_scores,</span><br><span class="line">        keypoint_edges=COCO17_HUMAN_POSE_KEYPOINTS)</span><br><span class="line"></span><br><span class="line">    plt.imsave(<span class="string">&quot;output.png&quot;</span>, image_np_with_detections[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    imagePath = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get input picture</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    image_np = load_image_into_numpy_array(imagePath)</span><br><span class="line">    plt.imsave(<span class="string">&quot;input.png&quot;</span>, image_np[<span class="number">0</span>])</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;load image: %s ms&#x27;</span> % ((end - start)*<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># load model</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    detector = hub.load(MODEL_PATH)</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;load model: %s ms&#x27;</span> % ((end - start)*<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># running inference</span></span><br><span class="line">    start = time.time()</span><br><span class="line">    results = detector(image_np)</span><br><span class="line">    result = &#123;key:value.numpy() <span class="keyword">for</span> key,value <span class="keyword">in</span> results.items()&#125;</span><br><span class="line">    end = time.time()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;inference time: %s ms&#x27;</span> % ((end - start)*<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># show result in picture</span></span><br><span class="line">    visualization(result, image_np)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨<code>TensorFlow Serving</code>éƒ¨ç½²</p></li></ol><p>  éƒ¨ç½²æ–¹å¼å’Œä¹‹å‰çš„æ¨¡å‹ä¸€æ ·ï¼Œç”¨<code>model.config</code>æ¯”è¾ƒæ–¹ä¾¿ï¼Œè¿è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š<br>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -t -d --<span class="built_in">rm</span> -p 8501:8501 -p 8111:8500 --name tfserver --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,<span class="built_in">source</span>=MODELPATH/Model,target=/models tensorflow/serving --model_config_file=/models/model.config</span><br></pre></td></tr></table></figure></p><p>  æµ‹è¯•ï¼Œä½¿ç”¨<code>python</code>å‘é€<code>REST</code>è¯·æ±‚ï¼š<br>  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> matplotlib</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> six <span class="keyword">import</span> BytesIO</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image, ImageDraw, ImageFont</span><br><span class="line"><span class="keyword">from</span> six.moves.urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line"><span class="keyword">import</span> tensorflow_hub <span class="keyword">as</span> hub</span><br><span class="line"></span><br><span class="line"><span class="comment"># visualization</span></span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> label_map_util</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> visualization_utils <span class="keyword">as</span> viz_utils</span><br><span class="line"><span class="keyword">from</span> object_detection.utils <span class="keyword">import</span> ops <span class="keyword">as</span> utils_ops</span><br><span class="line"></span><br><span class="line">COCO17_HUMAN_POSE_KEYPOINTS = [(<span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">2</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="number">3</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="number">4</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">5</span>),</span><br><span class="line">    (<span class="number">0</span>, <span class="number">6</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="number">7</span>),</span><br><span class="line">    (<span class="number">7</span>, <span class="number">9</span>),</span><br><span class="line">    (<span class="number">6</span>, <span class="number">8</span>),</span><br><span class="line">    (<span class="number">8</span>, <span class="number">10</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="number">6</span>),</span><br><span class="line">    (<span class="number">5</span>, <span class="number">11</span>),</span><br><span class="line">    (<span class="number">6</span>, <span class="number">12</span>),</span><br><span class="line">    (<span class="number">11</span>, <span class="number">12</span>),</span><br><span class="line">    (<span class="number">11</span>, <span class="number">13</span>),</span><br><span class="line">    (<span class="number">13</span>, <span class="number">15</span>),</span><br><span class="line">    (<span class="number">12</span>, <span class="number">14</span>),</span><br><span class="line">    (<span class="number">14</span>, <span class="number">16</span>)]</span><br><span class="line"></span><br><span class="line">PATH_TO_LABELS = <span class="string">&#x27;/home/yogurt/Desktop/EdgeX_Tutorial/TensorflowServer/tensorflow-models/research/object_detection/data/mscoco_label_map.pbtxt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_image_into_numpy_array</span>(<span class="params">path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Load an image from file into a numpy array.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Puts image into numpy array to feed into tensorflow graph.</span></span><br><span class="line"><span class="string">    Note that by convention we put it into a numpy array with shape</span></span><br><span class="line"><span class="string">    (height, width, channels), where channels=3 for RGB.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        path: the file path to the image</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Returns:</span></span><br><span class="line"><span class="string">        uint8 numpy array with shape (img_height, img_width, 3)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    image = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span>(path.startswith(<span class="string">&#x27;http&#x27;</span>)):</span><br><span class="line">        response = urlopen(path)</span><br><span class="line">        image_data = response.read()</span><br><span class="line">        image_data = BytesIO(image_data)</span><br><span class="line">        image = Image.<span class="built_in">open</span>(image_data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        image_data = tf.io.gfile.GFile(path, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">        image = Image.<span class="built_in">open</span>(BytesIO(image_data))</span><br><span class="line"></span><br><span class="line">    (im_width, im_height) = image.size</span><br><span class="line">    <span class="keyword">return</span> np.array(image.getdata()).reshape((<span class="number">1</span>, im_height, im_width, <span class="number">3</span>)).astype(np.uint8)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">visualization</span>(<span class="params">result, image_np</span>):</span><br><span class="line">    category_index = label_map_util.create_category_index_from_labelmap(PATH_TO_LABELS, use_display_name=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    label_id_offset = <span class="number">0</span></span><br><span class="line">    image_np_with_detections = image_np.copy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use keypoints if available in detections</span></span><br><span class="line">    keypoints, keypoint_scores = <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;detection_keypoints&#x27;</span> <span class="keyword">in</span> result:</span><br><span class="line">        keypoints = result[<span class="string">&#x27;detection_keypoints&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        keypoint_scores = result[<span class="string">&#x27;detection_keypoint_scores&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    viz_utils.visualize_boxes_and_labels_on_image_array(</span><br><span class="line">        image_np_with_detections[<span class="number">0</span>],</span><br><span class="line">        result[<span class="string">&#x27;detection_boxes&#x27;</span>][<span class="number">0</span>],</span><br><span class="line">        (result[<span class="string">&#x27;detection_classes&#x27;</span>][<span class="number">0</span>] + label_id_offset).astype(<span class="built_in">int</span>),</span><br><span class="line">        result[<span class="string">&#x27;detection_scores&#x27;</span>][<span class="number">0</span>],</span><br><span class="line">        category_index,</span><br><span class="line">        use_normalized_coordinates=<span class="literal">True</span>,</span><br><span class="line">        max_boxes_to_draw=<span class="number">200</span>,</span><br><span class="line">        min_score_thresh=<span class="number">.30</span>,</span><br><span class="line">        agnostic_mode=<span class="literal">False</span>,</span><br><span class="line">        keypoints=keypoints,</span><br><span class="line">        keypoint_scores=keypoint_scores,</span><br><span class="line">        keypoint_edges=COCO17_HUMAN_POSE_KEYPOINTS)</span><br><span class="line"></span><br><span class="line">    plt.imsave(<span class="string">&quot;output.png&quot;</span>, image_np_with_detections[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        imagePath = <span class="built_in">input</span>(<span class="string">&quot;please input image url/path:&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># get input picture</span></span><br><span class="line">        start = time.time()</span><br><span class="line">        image_np = load_image_into_numpy_array(imagePath)</span><br><span class="line">        plt.imsave(<span class="string">&quot;input.png&quot;</span>, image_np[<span class="number">0</span>])</span><br><span class="line">        end = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;load image: %sæ¯«ç§’&#x27;</span> % ((end - start)*<span class="number">1000</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># request body</span></span><br><span class="line">        data = json.dumps(&#123;<span class="string">&quot;signature_name&quot;</span>: <span class="string">&quot;serving_default&quot;</span>, <span class="string">&quot;instances&quot;</span>: image_np.tolist()&#125;)</span><br><span class="line">        headers = &#123;<span class="string">&quot;content-type&quot;</span>: <span class="string">&quot;application/json&quot;</span>&#125;</span><br><span class="line">        start = time.time()</span><br><span class="line">        json_response = requests.post(<span class="string">&#x27;http://localhost:8501/v1/models/detect2:predict&#x27;</span>, data=data, headers=headers)</span><br><span class="line">        end = time.time()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;inference time: %s ms&#x27;</span> % ((end - start)*<span class="number">1000</span>))</span><br><span class="line">        <span class="comment"># print(json_response.text)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># decode result</span></span><br><span class="line">        results = json.loads(json_response.text)[<span class="string">&#x27;predictions&#x27;</span>][<span class="number">0</span>]</span><br><span class="line">        result = &#123;key:np.array([value], dtype=np.float32) <span class="keyword">for</span> key,value <span class="keyword">in</span> results.items()&#125;</span><br><span class="line"></span><br><span class="line">        visualization(result, image_np)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure></p>]]></content>
      
      
      <categories>
          
          <category> Tensorflow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tensorflow </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
