<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Embedded Programming with the GNU Toolchain | (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”» </title><meta name="author" content="(à¸‡'Ì€-'Ì)à¸‡"><meta name="copyright" content="(à¸‡'Ì€-'Ì)à¸‡"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Origin online url: https:&amp;#x2F;&amp;#x2F;www.bravegnu.org&amp;#x2F;gnu-eprog&amp;#x2F; github repo: https:&amp;#x2F;&amp;#x2F;github.com&amp;#x2F;bravegnu&amp;#x2F;gnu-eprog&amp;#x2F;blob&amp;#x2F;master&amp;#x2F;gnu-eprog.asciidoc  1. Introduc"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yo-gurts.github.io/2024/10/17/GNUToolchain/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":600},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Embedded Programming with the GNU Toolchain',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-20 21:43:17'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="google-site-verification" content="MP347_Nl-SqfnOi3FZSI69WSb8J_rk_jEsa3jL4ODCI" /><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2024/09/17/3NdhvxIcPRVpufD.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">10</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”» "><span class="site-name">(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”» </span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> æœç´¢</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> é¦–é¡µ</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> å½’æ¡£</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> æ ‡ç­¾</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> åˆ†ç±»</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> å‹é“¾</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Embedded Programming with the GNU Toolchain</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2024-10-17T14:00:06.000Z" title="å‘è¡¨äº 2024-10-17 22:00:06">2024-10-17</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2024-10-20T13:43:17.000Z" title="æ›´æ–°äº 2024-10-20 21:43:17">2024-10-20</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Assembler/">Assembler</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">å­—æ•°æ€»è®¡:</span><span class="word-count">11.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>47åˆ†é’Ÿ</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Embedded Programming with the GNU Toolchain"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»é‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">è¯„è®ºæ•°:</span><a href="/2024/10/17/GNUToolchain/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><blockquote>
<p>Origin online url: <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/">https://www.bravegnu.org/gnu-eprog/</a></p>
<p>github repo: <a target="_blank" rel="noopener" href="https://github.com/bravegnu/gnu-eprog/blob/master/gnu-eprog.asciidoc">https://github.com/bravegnu/gnu-eprog/blob/master/gnu-eprog.asciidoc</a></p>
</blockquote>
<h2 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h2><p>GNUå·¥å…·é“¾è¶Šæ¥è¶Šå¤šåœ°è¢«ç”¨äºæ·±åº¦åµŒå…¥å¼è½¯ä»¶å¼€å‘ã€‚è¿™ç§ç±»å‹çš„è½¯ä»¶å¼€å‘ä¹Ÿè¢«ç§°ä¸ºç‹¬ç«‹Cç¼–ç¨‹å’Œè£¸æœºCç¼–ç¨‹ã€‚ç‹¬ç«‹Cç¼–ç¨‹å¸¦æ¥äº†æ–°çš„é—®é¢˜ï¼Œå¤„ç†è¿™äº›é—®é¢˜éœ€è¦å¯¹GNUå·¥å…·é“¾æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚GNUå·¥å…·é“¾çš„æ‰‹å†Œæä¾›äº†å…³äºå·¥å…·é“¾çš„æå¥½ä¿¡æ¯ï¼Œä½†ä»å·¥å…·é“¾çš„è§’åº¦ï¼Œè€Œä¸æ˜¯é—®é¢˜çš„è§’åº¦ã€‚å¥½å§ï¼Œæ— è®ºå¦‚ä½•ï¼Œæ‰‹å†Œåº”è¯¥æ˜¯è¿™æ ·å†™çš„ã€‚ç»“æœæ˜¯å¸¸è§é—®é¢˜çš„ç­”æ¡ˆåˆ†æ•£åœ¨å„å¤„ï¼ŒGNUå·¥å…·é“¾çš„æ–°ç”¨æˆ·æ„Ÿåˆ°å›°æƒ‘ã€‚</p>
<p>æœ¬æ•™ç¨‹è¯•å›¾é€šè¿‡ä»é—®é¢˜çš„è§’åº¦è§£é‡Šå·¥å…·æ¥å¼¥åˆå·®è·ã€‚å¸Œæœ›è¿™èƒ½è®©æ›´å¤šäººèƒ½å¤Ÿä½¿ç”¨ GNU å·¥å…·é“¾è¿›è¡ŒåµŒå…¥å¼é¡¹ç›®å¼€å‘ã€‚</p>
<p>åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œä½¿ç”¨Qemuæ¨¡æ‹ŸåŸºäºARMçš„åµŒå…¥å¼ç³»ç»Ÿã€‚æœ‰äº†è¿™ä¸ªï¼Œæ‚¨å¯ä»¥åœ¨èˆ’é€‚çš„æ¡Œé¢ä¸Šå­¦ä¹ GNUå·¥å…·é“¾ï¼Œè€Œæ— éœ€æŠ•èµ„ç¡¬ä»¶ã€‚æœ¬æ•™ç¨‹æœ¬èº«ä¸æ•™æˆARMæŒ‡ä»¤é›†ã€‚å®ƒåº”è¯¥ä¸å…¶ä»–ä¹¦ç±å’Œåœ¨çº¿æ•™ç¨‹ä¸€èµ·ä½¿ç”¨ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>ARM Assembler - <a target="_blank" rel="noopener" href="http://www.heyrick.co.uk/assembler/">http://www.heyrick.co.uk/assembler/</a></li>
<li>ARMæ±‡ç¼–ç¨‹åº-<a target="_blank" rel="noopener" href="http://www.heyrick.co.uk/assembler/">http://www.heyrick.co.uk/assembler/</a></li>
<li>ARM Assembly Language Programming - <a target="_blank" rel="noopener" href="http://www.arm.com/miscPDFs/9658.pdf">http://www.arm.com/miscPDFs/9658.pdf</a></li>
<li>ARMæ±‡ç¼–è¯­è¨€ç¼–ç¨‹-<a target="_blank" rel="noopener" href="http://www.arm.com/miscPDFs/9658.pdf">http://www.arm.com/miscPDFs/9658.pdf</a></li>
</ul>
<p>ä½†ä¸ºäº†æ–¹ä¾¿è¯»è€…ï¼Œé™„å½•ä¸­åˆ—å‡ºäº†å¸¸ç”¨çš„ARMæŒ‡ä»¤ã€‚é¡ºåºçœ‹æ–‡ä¸­ä»£ç æ—¶ï¼Œæœ‰ arm æŒ‡ä»¤ä¸æ¸…æ¥šå¯ä»¥è·³è½¬åˆ°é™„å½•æŸ¥çœ‹ã€‚</p>
<hr>
<h2 id="2-Setting-up-the-ARM-Lab"><a href="#2-Setting-up-the-ARM-Lab" class="headerlink" title="2. Setting up the ARM Lab"></a>2. Setting up the ARM Lab</h2><p>æœ¬èŠ‚ä»‹ç»å¦‚ä½•åœ¨ä½ çš„ç”µè„‘ä¸Šä½¿ç”¨ Qemu å’Œ GNU å·¥å…·é“¾è®¾ç½®ä¸€ä¸ªç®€å•çš„ ARM å¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚Qemu æ˜¯ä¸€æ¬¾å¯ä»¥æ¨¡æ‹Ÿå¤šç§æœºå™¨ï¼ˆåŒ…æ‹¬åŸºäº ARM çš„æœºå™¨ï¼‰çš„æœºå™¨æ¨¡æ‹Ÿå™¨ã€‚ä½ å¯ä»¥ç¼–å†™ ARM æ±‡ç¼–ç¨‹åºï¼Œä½¿ç”¨ GNU å·¥å…·é“¾è¿›è¡Œç¼–è¯‘ï¼Œå¹¶åœ¨ Qemu ä¸­æ‰§è¡Œå’Œæµ‹è¯•è¿™äº›ç¨‹åºã€‚</p>
<h3 id="2-1-Qemu-ARM"><a href="#2-1-Qemu-ARM" class="headerlink" title="2.1. Qemu ARM"></a>2.1. Qemu ARM</h3><p>Qemu å°†ç”¨äºæ¨¡æ‹Ÿæ¥è‡ª Gumstix çš„åŸºäº PXA255 çš„ <em>connex</em> å¼€å‘æ¿ã€‚è¦è¿è¡Œæœ¬æ•™ç¨‹ï¼Œä½ éœ€è¦è‡³å°‘ 0.9.1 ç‰ˆæœ¬çš„ Qemuã€‚</p>
<p>PXA255 å¤„ç†å™¨å…·æœ‰ç¬¦åˆ ARMv5TE æŒ‡ä»¤é›†çš„ ARM æ ¸å¿ƒã€‚PXA255 è¿˜åŒ…å«å¤šä¸ªç‰‡ä¸Šå¤–è®¾ã€‚åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œå°†ä»‹ç»å…¶ä¸­çš„ä¸€äº›å¤–è®¾ã€‚.</p>
<h3 id="2-2-Installing-Qemu-in-Debian"><a href="#2-2-Installing-Qemu-in-Debian" class="headerlink" title="2.2. Installing Qemu in Debian"></a>2.2. Installing Qemu in Debian</h3><p>This tutorial requires qemu version 0.9.1 or above. The qemu package available in Debian Squeeze&#x2F;Wheezy, meets this requirement. Install <code>qemu</code> using <code>apt-get</code>.</p>
<blockquote>
<p>Ubuntu 22.04 ä¸Šæµ‹è¯•ï¼Œåç»­ä½¿ç”¨çš„ï¼Œåº”è¯¥é€šè¿‡ <code>apt install qemu-system-arm</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt install qemu-system-arm</span><br></pre></td></tr></table></figure>

<h3 id="2-3-Installing-GNU-Toolchain-for-ARM"><a href="#2-3-Installing-GNU-Toolchain-for-ARM" class="headerlink" title="2.3. Installing GNU Toolchain for ARM"></a>2.3. Installing GNU Toolchain for ARM</h3><ol>
<li><p>Folks at CodeSourcery (part of Mentor Graphics) have been kind enough to make GNU toolchains available for various architectures. Download the GNU toolchain for ARM, available from from <a target="_blank" rel="noopener" href="http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/">http://www.mentor.com/embedded-software/sourcery-tools/sourcery-codebench/editions/lite-edition/</a></p>
<blockquote>
<p>â›” ä¸Šè¯‰é“¾æ¥æ—©å·²å¤±æ•ˆï¼Œå®˜æ–¹å·¥å…·é“¾ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloads%E3%80%82">https://developer.arm.com/downloads/-/arm-gnu-toolchain-downloadsã€‚</a></p>
<p>ä¸è¿‡ä¸Šé¢é“¾æ¥ä¸‹è½½çš„å·¥å…·é“¾ä¹Ÿæœ‰é—®é¢˜ï¼Œéƒ¨åˆ†å·¥å…·é“¾æ¥å¼‚å¸¸ã€‚æ”¹ç”¨ <a target="_blank" rel="noopener" href="https://github.com/sophgo/host-tools">https://github.com/sophgo/host-tools</a> ä¸‹çš„å·¥å…·é“¾ã€‚</p>
</blockquote>
</li>
<li><p>Extract the tar archive, to <code>~/toolchains</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> ~/toolchains</span><br><span class="line">$ <span class="built_in">cd</span> ~/toolchains</span><br><span class="line">$ tar -jxf ~/downloads/arm-2008q1-126-arm-linux-gnueabihf-i686-pc-linux-gnu.tar.bz2</span><br></pre></td></tr></table></figure>
</li>
<li><p>Add the toolchain to your <code>PATH</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> PATH=/home/yogurt/Documents/sophgo/host-tools/gcc/gcc-linaro-6.3.1-2017.05-x86_64_arm-linux-gnueabihf/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>You might want to add the previous line to your <code>.bashrc</code>.</p>
</li>
</ol>
<hr>
<h2 id="3-Hello-ARM"><a href="#3-Hello-ARM" class="headerlink" title="3. Hello ARM"></a>3. Hello ARM</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œä½ å°†å­¦ä¹ å¦‚ä½•æ±‡ç¼–ä¸€ä¸ªç®€å•çš„ ARM ç¨‹åºï¼Œå¹¶åœ¨ç”± Qemu æ¨¡æ‹Ÿçš„è£¸æœº connex å¼€å‘æ¿ä¸Šè¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æ±‡ç¼–ç¨‹åºçš„æºæ–‡ä»¶ç”±ä¸€ç³»åˆ—è¯­å¥ç»„æˆï¼Œæ¯è¡Œä¸€æ¡è¯­å¥ã€‚æ¯æ¡è¯­å¥çš„æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label:    instruction         @ comment</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢ä¸‰ä¸ªéƒ¨åˆ†éƒ½æ˜¯å¯é€‰çš„ã€‚</p>
<ul>
<li><p>ğŸ“Œ <code>label</code>: æ ‡ç­¾æ˜¯ä¸€ä¸ªæ–¹ä¾¿çš„æ–¹å¼ï¼Œ<strong>ç”¨äºæŒ‡ä»£å†…å­˜ä¸­æŒ‡ä»¤çš„ä½ç½®</strong>ã€‚æ ‡ç­¾å¯ä»¥åœ¨ä»»ä½•åœ°å€å¯ä»¥å‡ºç°çš„åœ°æ–¹ä½¿ç”¨ï¼Œä¾‹å¦‚ä½œä¸ºåˆ†æ”¯æŒ‡ä»¤çš„æ“ä½œæ•°ã€‚æ ‡ç­¾åç§°åº”ç”±å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ï¼ˆ<code>_</code>ï¼‰å’Œç¾å…ƒç¬¦å·ï¼ˆ<code>$</code>ï¼‰ç»„æˆã€‚</p>
<blockquote>
<p>The label is a convenient way to refer to the location of the instruction in memory. The label can be used where ever an address can appear, for example as an operand of the branch instruction. The label name should consist of alphabets, digits, <code>_</code> and <code>$</code>.</p>
</blockquote>
</li>
<li><p>ğŸ“ <code>comment</code>: æ³¨é‡Šä»¥ <code>@</code> å¼€å§‹ï¼Œ<code>@</code> åå‡ºç°çš„å­—ç¬¦å°†è¢«å¿½ç•¥ã€‚</p>
</li>
<li><p>ğŸ“œ <code>instruction</code>: å¯ä»¥æ˜¯ ARM æŒ‡ä»¤æˆ–æ±‡ç¼–æŒ‡ä»¤ã€‚æ±‡ç¼–æŒ‡ä»¤æ˜¯ç»™æ±‡ç¼–å™¨çš„å‘½ä»¤ï¼ŒğŸ’¡ğŸ’¡ <strong>æ±‡ç¼–æŒ‡ä»¤æ€»æ˜¯ä»¥ <code>.</code>ï¼ˆå¥ç‚¹ï¼‰å¼€å¤´</strong>ã€‚</p>
<blockquote>
<p>The <code>instruction</code> could be an ARM instruction or an assembler directive. Assembler directives are commands to the assembler. Assembler directives always start with a <code>.</code> (period).</p>
</blockquote>
</li>
</ul>
<blockquote>
<p>ğŸ’¡ğŸ’¡ æ³¨æ„åç»­åŒºåˆ†æ±‡ç¼–æŒ‡ä»¤ä¸ ARM æŒ‡ä»¤ï¼ï¼ï¼</p>
</blockquote>
<p>ä»¥ä¸‹æ˜¯ä¸€ä¸ªéå¸¸ç®€å•çš„ ARM æ±‡ç¼–ç¨‹åºï¼Œç”¨äºå°†ä¸¤ä¸ªæ•°å­—ç›¸åŠ ï¼š</p>
<p><strong>Listing 1. Adding Two Numbers</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">start:                       @ Label, not really required</span><br><span class="line">        mov   r0, #5         @ Load register r0 with the value 5</span><br><span class="line">        mov   r1, #4         @ Load register r1 with the value 4</span><br><span class="line">        add   r2, r1, r0     @ Add r0 and r1 and store in r2</span><br><span class="line"></span><br><span class="line">stop:   b stop               @ Infinite loop to stop execution</span><br></pre></td></tr></table></figure>

<p><code>.text</code> æ˜¯ä¸€ä¸ª<strong>æ±‡ç¼–æŒ‡ä»¤</strong>ï¼Œè¡¨ç¤ºæ¥ä¸‹æ¥çš„æŒ‡ä»¤åº”è¢«æ±‡ç¼–åˆ°ä»£ç æ®µï¼Œè€Œä¸æ˜¯ <code>.data</code> æ®µã€‚å…³äºæ®µçš„å†…å®¹å°†åœ¨åé¢çš„æ•™ç¨‹ä¸­è¯¦ç»†ä»‹ç»ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The `.text` is an assembler directive, which says that the following instructions</span><br><span class="line">have to be assembled into the code section, rather than the `.data` section.</span><br><span class="line">Sections will be covered in detail, later in the tutorial.</span><br></pre></td></tr></table></figure>

<h3 id="3-1-Building-the-Binary"><a href="#3-1-Building-the-Binary" class="headerlink" title="3.1. Building the Binary"></a>3.1. Building the Binary</h3><p>å°†ä¸‹é¢çš„ç¨‹åºä¿å­˜åˆ°ä¸€ä¸ªåä¸º <code>add.s</code> çš„æ–‡ä»¶ä¸­ã€‚è¦æ±‡ç¼–è¯¥æ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ GNU å·¥å…·é“¾çš„æ±‡ç¼–å™¨ <code>as</code>ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o add.o add.s</span><br></pre></td></tr></table></figure>

<p><code>-o</code>é€‰é¡¹æŒ‡å®šè¾“å‡º æ–‡ä»¶åã€‚</p>
<blockquote>
<p>äº¤å‰å·¥å…·é“¾æ€»æ˜¯ä»¥ç›®æ ‡æ¶æ„çš„å‰ç¼€å‘½åï¼Œä»¥é¿å…ä¸ä¸»æœºå·¥å…·é“¾çš„åç§°å†²çªã€‚ä¸ºäº†å¯è¯»æ€§ï¼Œæ–‡æœ¬ä¸­å°†ä¸å¸¦å‰ç¼€åœ°æåŠè¿™äº›å·¥å…·ã€‚</p>
</blockquote>
<p>è¦ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ GNU å·¥å…·é“¾ä¸­çš„é“¾æ¥å™¨ <code>ld</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºçš„å‘½ä»¤ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x0 -o add.elf add.o</span><br><span class="line">arm-linux-gnueabihf-ld: warning: cannot find entry symbol _start; defaulting to 0000000000000000</span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒåŒæ ·åœ°ï¼Œ<code>-o</code> é€‰é¡¹ç”¨äºæŒ‡å®šè¾“å‡ºæ–‡ä»¶åã€‚<code>-Ttext=0x0</code> æŒ‡å®šäº†æ ‡ç­¾ <code>text</code> åº”è¢«åˆ†é…çš„åœ°å€ï¼Œä½¿å¾—æŒ‡ä»¤ä»åœ°å€ <code>0x0</code> å¼€å§‹ã€‚è¦æŸ¥çœ‹å„ä¸ªæ ‡ç­¾çš„åœ°å€åˆ†é…ï¼Œå¯ä»¥ä½¿ç”¨ <code>nm</code> å‘½ä»¤ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Here again, the `-o` option specifies the output filename.</span></span><br><span class="line"><span class="comment"># The `-Ttext=0x0`, specifies that addresses should be assigned to the labels,</span></span><br><span class="line"><span class="comment"># such that the instructions were starting from address `0x0`.</span></span><br><span class="line"><span class="comment"># To view the address assignment for various labels, the `nm` command can be used as shown below.</span></span><br><span class="line"></span><br><span class="line">$ arm-linux-gnueabihf-nm add.elf</span><br><span class="line">00010010 T __bss_end__</span><br><span class="line">00010010 T _bss_end__</span><br><span class="line">00010010 T __bss_start</span><br><span class="line">00010010 T __bss_start__</span><br><span class="line">00010010 T _edata</span><br><span class="line">00010010 T __end__</span><br><span class="line">00010010 T _end</span><br><span class="line">00000000 t start</span><br><span class="line">0000000c t stop</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„æ ‡ç­¾ <code>start</code> å’Œ <code>stop</code> çš„åœ°å€åˆ†é…ã€‚<code>start</code> çš„åœ°å€è¢«åˆ†é…ä¸º <code>0x0</code>ï¼Œå› ä¸ºå®ƒæ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤çš„æ ‡ç­¾ã€‚<code>stop</code> æ ‡ç­¾åœ¨ 3 æ¡æŒ‡ä»¤ä¹‹åã€‚æ¯æ¡æŒ‡ä»¤å ç”¨ 4 å­—èŠ‚ï¼Œå› æ­¤ <code>stop</code> è¢«åˆ†é…çš„åœ°å€æ˜¯ 12ï¼ˆ<code>0xC</code>ï¼‰ã€‚</p>
<p>ä½¿ç”¨ä¸åŒçš„åŸºåœ°å€è¿›è¡Œé“¾æ¥å°†å¯¼è‡´æ ‡ç­¾è¢«åˆ†é…åˆ°ä¸åŒçš„åœ°å€é›†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Note the address assignment for the labels `start` and `stop`. The address assigned</span></span><br><span class="line"><span class="comment"># for `start` is `0x0`. Since it is the label of the first instruction.</span></span><br><span class="line"><span class="comment"># The label `stop` is after 3 instructions. Each instructions is 4 bytes.</span></span><br><span class="line"><span class="comment"># Hence `stop` is assigned an address `12` (`0xC`).</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Linking with a different base address for the instructions will result in</span></span><br><span class="line"><span class="comment"># a different set of addresses being assigned to the labels.</span></span><br><span class="line"></span><br><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x20000000 -o add.elf add.o</span><br><span class="line">$ arm-linux-gnueabihf-nm add.elf</span><br><span class="line">... clip ...</span><br><span class="line">20000000 t start</span><br><span class="line">2000000c t stop</span><br></pre></td></tr></table></figure>
<p><code>ld</code> åˆ›å»ºçš„è¾“å‡ºæ–‡ä»¶æ ¼å¼ç§°ä¸º <code>ELF</code>ã€‚æœ‰å¤šç§æ–‡ä»¶æ ¼å¼å¯ç”¨äºå­˜å‚¨å¯æ‰§è¡Œä»£ç ã€‚ELF æ ¼å¼åœ¨æœ‰æ“ä½œç³»ç»Ÿæ—¶è¿è¡Œè‰¯å¥½ï¼Œä½†ç”±äºæˆ‘ä»¬å°†è¦åœ¨è£¸æœºä¸Šè¿è¡Œç¨‹åºï¼Œå› æ­¤éœ€è¦å°†å…¶è½¬æ¢ä¸ºä¸€ç§æ›´ç®€å•çš„æ–‡ä»¶æ ¼å¼ï¼Œç§°ä¸º <code>binary</code> æ ¼å¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The output file created by `ld` is in a format called `ELF`. Various file formats are available</span><br><span class="line"> for storing executable code. The ELF format works fine when you have an OS around,</span><br><span class="line"> but since we are going to run the program on bare metal,</span><br><span class="line"> we will have to convert it to a simpler file format called the `binary` format.</span><br></pre></td></tr></table></figure>

<p><code>binary</code> æ ¼å¼çš„æ–‡ä»¶åŒ…å«ä»ç‰¹å®šå†…å­˜åœ°å€å¼€å§‹çš„è¿ç»­å­—èŠ‚ã€‚è¯¥æ–‡ä»¶ä¸­ä¸å­˜å‚¨ä»»ä½•å…¶ä»–é™„åŠ ä¿¡æ¯ã€‚<strong>è¿™å¯¹äº Flash çƒ§å½•å·¥å…·æ¥è¯´éå¸¸æ–¹ä¾¿</strong>ï¼Œå› ä¸ºç¼–ç¨‹æ—¶åªéœ€å°†æ–‡ä»¶ä¸­çš„æ¯ä¸ªå­—èŠ‚å¤åˆ¶åˆ°ä»æŒ‡å®šåŸºåœ°å€å¼€å§‹çš„è¿ç»­åœ°å€ä¸­å³å¯ã€‚</p>
<blockquote>
<p>æœ‰ç‚¹åƒçƒ§å½•å›ºä»¶æ—¶ï¼Œæå‰å°†å›ºä»¶æ‰“åŒ…ä¸ºçš„æ•´åŒ…å·¥å…·ã€‚</p>
</blockquote>
<p>GNU å·¥å…·é“¾ä¸­çš„ <code>objcopy</code> å‘½ä»¤å¯ç”¨äºåœ¨ä¸åŒçš„ç›®æ ‡æ–‡ä»¶æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚ä»¥ä¸‹æ˜¯è¯¥å‘½ä»¤çš„ä¸€ç§å¸¸è§ç”¨æ³•ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A file in `binary` format contains consecutive bytes from a specific memory address.</span></span><br><span class="line"><span class="comment"># No other additional information is stored in the file. This is convenient for Flash programming tools,</span></span><br><span class="line"><span class="comment"># since all that has to be done when programming is to copy each byte in the file,</span></span><br><span class="line"><span class="comment"># to consecutive address starting from a specified base address in memory.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The GNU toolchainâ€™s `objcopy` command can be used to convert between different object file formats.</span></span><br><span class="line"><span class="comment"># A common usage of the command is given below.</span></span><br><span class="line"></span><br><span class="line">objcopy -O &lt;output-format&gt; &lt;in-file&gt; &lt;out-file&gt;</span><br></pre></td></tr></table></figure>

<p>å°†<code>add.elf</code>è½¬æ¢ä¸º <code>binary</code> æ ¼å¼ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-objcopy -O binary add.elf add.bin</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥æ–‡ä»¶çš„å¤§å°ã€‚è¯¥æ–‡ä»¶æ­£å¥½æ˜¯16ä¸ªå­—èŠ‚ã€‚å› ä¸ºæœ‰4æ¡æŒ‡ä»¤ï¼Œæ¯æ¡æŒ‡ä»¤å ç”¨4ä¸ªå­—èŠ‚ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ls</span> -al add.bin</span><br><span class="line">-rw-r--r-- 1 vijaykumar vijaykumar 16 2008-10-03 23:56 add.bin</span><br></pre></td></tr></table></figure>

<h3 id="3-2-Executing-in-Qemu"><a href="#3-2-Executing-in-Qemu" class="headerlink" title="3.2. Executing in Qemu"></a>3.2. Executing in Qemu</h3><p>å½“ ARM å¤„ç†å™¨å¤ä½æ—¶ï¼Œå®ƒä»åœ°å€ <code>0x0</code> å¼€å§‹æ‰§è¡Œã€‚åœ¨ connex å¼€å‘æ¿ä¸Šï¼Œ16MB çš„ Flash å­˜å‚¨å™¨ä½äºåœ°å€ <code>0x0</code>ã€‚Flash å¼€å§‹å¤„çš„æŒ‡ä»¤å°†è¢«æ‰§è¡Œã€‚</p>
<p>å½“ <code>qemu</code> æ¨¡æ‹Ÿ connex å¼€å‘æ¿æ—¶ï¼Œå¿…é¡»æŒ‡å®šä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å°†è¢«è§†ä¸º Flash å­˜å‚¨å™¨ã€‚Flash æ–‡ä»¶æ ¼å¼éå¸¸ç®€å•ã€‚è¦ä» Flash ä¸­çš„åœ°å€ X è·å–å­—èŠ‚ï¼Œ<code>qemu</code> ä»æ–‡ä»¶çš„åç§»é‡ X è¯»å–å­—èŠ‚ã€‚å®é™…ä¸Šï¼Œè¿™ä¸äºŒè¿›åˆ¶æ–‡ä»¶æ ¼å¼æ˜¯ç›¸åŒçš„ã€‚</p>
<p>ä¸ºäº†åœ¨æ¨¡æ‹Ÿçš„ Gumstix connex å¼€å‘æ¿ä¸Šæµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬é¦–å…ˆåˆ›å»ºä¸€ä¸ª 16MB çš„æ–‡ä»¶æ¥è¡¨ç¤º Flashã€‚æˆ‘ä»¬ä½¿ç”¨ <code>dd</code> å‘½ä»¤ä» <code>/dev/zero</code> å¤åˆ¶ 16MB çš„é›¶å­—èŠ‚åˆ°æ–‡ä»¶ <code>flash.bin</code>ã€‚æ•°æ®ä»¥ 4K å—çš„å½¢å¼å¤åˆ¶ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=flash.bin bs=4096 count=4096</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°† <code>add.bin</code> æ–‡ä»¶å¤åˆ¶åˆ° Flash çš„å¼€å¤´ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">dd</span> <span class="keyword">if</span>=add.bin of=flash.bin bs=4096 conv=notrunc</span><br></pre></td></tr></table></figure>

<p>è¿™ç›¸å½“äºå°†<code>bin</code>æ–‡ä»¶çƒ§å½•åˆ°é—ªå­˜ä¸Šã€‚</p>
<p>åœ¨å¤ä½åï¼Œå¤„ç†å™¨å°†ä»åœ°å€ <code>0x0</code> å¼€å§‹æ‰§è¡Œï¼Œç¨‹åºä¸­çš„æŒ‡ä»¤å°†è¢«æ‰§è¡Œã€‚è°ƒç”¨ <code>qemu</code> çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br></pre></td></tr></table></figure>

<p><code>-M connex</code> é€‰é¡¹æŒ‡å®šè¦æ¨¡æ‹Ÿçš„æœºå™¨ä¸º <code>connex</code>ã€‚<code>-pflash</code> é€‰é¡¹æŒ‡å®š <code>flash.bin</code> æ–‡ä»¶è¡¨ç¤º Flash å­˜å‚¨å™¨ã€‚<code>-nographic</code> è¡¨ç¤ºä¸éœ€è¦å›¾å½¢æ˜¾ç¤ºçš„æ¨¡æ‹Ÿã€‚<code>-serial /dev/null</code> æŒ‡å®š connex å¼€å‘æ¿çš„ä¸²å£è¿æ¥åˆ° <code>/dev/null</code>ï¼Œä»¥ä¾¿ä¸¢å¼ƒä¸²å£æ•°æ®ã€‚</p>
<p>ç³»ç»Ÿæ‰§è¡ŒæŒ‡ä»¤åï¼Œä¼šåœ¨ <code>stop: b stop</code> æŒ‡ä»¤å¤„æ— é™å¾ªç¯ã€‚è¦æŸ¥çœ‹å¯„å­˜å™¨çš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ <code>qemu</code> çš„ç›‘è§†å™¨æ¥å£ã€‚ç›‘è§†å™¨æ¥å£æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œç•Œé¢ï¼Œé€šè¿‡å®ƒå¯ä»¥æ§åˆ¶æ¨¡æ‹Ÿçš„ç³»ç»Ÿå¹¶æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ã€‚å½“ <code>qemu</code> ä»¥ä¸Šè¿°å‘½ä»¤å¯åŠ¨æ—¶ï¼Œç›‘è§†å™¨æ¥å£å°†é€šè¿‡ <code>qemu</code> çš„æ ‡å‡†è¾“å…¥&#x2F;è¾“å‡ºæä¾›ã€‚</p>
<p>è¦æŸ¥çœ‹å¯„å­˜å™¨çš„å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨<code>info registers</code>ç›‘è§†å™¨å‘½ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br><span class="line">WARNING: Image format was not specified <span class="keyword">for</span> <span class="string">&#x27;flash.bin&#x27;</span> and probing guessed raw.</span><br><span class="line">         Automatically detecting the format is dangerous <span class="keyword">for</span> raw images, write operations on block 0 will be restricted.</span><br><span class="line">         Specify the <span class="string">&#x27;raw&#x27;</span> format explicitly to remove the restrictions.</span><br><span class="line">QEMU 6.2.0 monitor - <span class="built_in">type</span> <span class="string">&#x27;help&#x27;</span> <span class="keyword">for</span> more information</span><br><span class="line">(qemu) info registers</span><br><span class="line">R00=00000005 R01=00000004 R02=00000009 R03=00000000</span><br><span class="line">R04=00000000 R05=00000000 R06=00000000 R07=00000000</span><br><span class="line">R08=00000000 R09=00000000 R10=00000000 R11=00000000</span><br><span class="line">R12=00000000 R13=00000000 R14=00000000 R15=0000000c</span><br><span class="line">PSR=400001d3 -Z-- A svc32</span><br><span class="line">FPSCR: 00000000</span><br><span class="line">(qemu)</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„å¯„å­˜å™¨ <code>R02</code> çš„å€¼ã€‚è¯¥å¯„å­˜å™¨åŒ…å«åŠ æ³•çš„ç»“æœï¼Œåº”è¯¥ä¸é¢„æœŸå€¼ 9 ç›¸ç¬¦ã€‚</p>
<h3 id="3-3-More-Monitor-Commands"><a href="#3-3-More-Monitor-Commands" class="headerlink" title="3.3. More Monitor Commands"></a>3.3. More Monitor Commands</h3><p>ä¸€äº›æœ‰ç”¨çš„<code>qemu</code>ç›‘æ§å‘½ä»¤ åˆ—åœ¨ä¸‹è¡¨ä¸­ã€‚</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Purpose</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
<tr>
<td><code>help</code></td>
<td>List available commands</td>
</tr>
<tr>
<td><code>quit</code></td>
<td>Quits the emulator</td>
</tr>
<tr>
<td><code>xp /fmt addr</code></td>
<td>Dump ç‰©ç†å†…å­˜ä¸­ <code>addr</code> å¤„çš„å†…å®¹</td>
</tr>
<tr>
<td><code>system_reset</code></td>
<td>Reset the system.</td>
</tr>
</tbody></table>
<p><code>xp</code> å‘½ä»¤éœ€è¦æ›´å¤šçš„è§£é‡Šã€‚<code>/fmt</code> ä½œä¸ºå‚æ•°æŒ‡å®šå†…å­˜å†…å®¹çš„æ˜¾ç¤ºæ–¹å¼ã€‚<code>fmt</code> çš„è¯­æ³•ä¸º <code>&lt;count&gt;&lt;format&gt;&lt;size&gt;</code>ã€‚</p>
<ul>
<li><p><code>count</code>: è¡¨ç¤ºè¦æ˜¾ç¤ºçš„ <code>item</code> æ•°é‡ï¼Œä¾‹å¦‚è¦æ˜¾ç¤º 4 ä¸ªå­—èŠ‚å¯ä»¥å†™ä¸º <code>4</code></p>
</li>
<li><p><code>format</code>: æŒ‡å®šæ˜¾ç¤ºæ ¼å¼ã€‚<code>x</code> ä»£è¡¨åå…­è¿›åˆ¶ï¼Œ<code>d</code>ä»£è¡¨æœ‰ç¬¦å·åè¿›åˆ¶ï¼Œ <code>u</code>ä»£è¡¨æ— ç¬¦å·åè¿›åˆ¶ï¼Œ<code>o</code>ä»£è¡¨å…«è¿›åˆ¶ï¼Œ<code>c</code>ä»£è¡¨ charå’Œ<code>i</code>ç”¨äºasmæŒ‡ä»¤ã€‚</p>
</li>
<li><p><code>size</code>: è¡¨ç¤ºæ¯ä¸ª <code>item</code> çš„å¤§å°ï¼Œ<code>b</code>è¡¨ç¤º8ä½ï¼Œ<code>h</code>è¡¨ç¤º 16ä½ï¼Œ<code>w</code>ä»£è¡¨32ä½ <code>g</code>ä¸º64ä½ã€‚</p>
</li>
</ul>
<p>è¿™ä¸ª <code>xp</code> å‘½ä»¤ä½¿ç”¨ <code>i</code> æ ¼å¼å¯ä»¥ç”¨äºåæ±‡ç¼–å†…å­˜ä¸­å­˜åœ¨çš„æŒ‡ä»¤ã€‚å¦‚è¦åæ±‡ç¼–ä½äº <code>0x0</code> çš„æŒ‡ä»¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ <code>xp</code> å‘½ä»¤ï¼Œ<code>fmt</code> æŒ‡å®šä¸º <code>4iw</code>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(qemu) xp /4iw 0x0</span><br><span class="line">0x00000000:  mov        r0, <span class="comment">#5  ; 0x5</span></span><br><span class="line">0x00000004:  mov        r1, <span class="comment">#4  ; 0x4</span></span><br><span class="line">0x00000008:  add        r2, r1, r0</span><br><span class="line">0x0000000c:  b  0xc</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™ä¸ªå‘½ä»¤ä¸­ï¼š</p>
<ul>
<li><code>4</code> æŒ‡å®šè¦æ˜¾ç¤º 4 ä¸ª <code>item</code>ã€‚</li>
<li><code>i</code> æŒ‡å®šè¿™äº›é¡¹ç›®å°†ä»¥æŒ‡ä»¤å½¢å¼æ‰“å°ï¼ˆæ˜¯çš„ï¼Œè¿™ä¸ªå‘½ä»¤å†…ç½®äº†åæ±‡ç¼–åŠŸèƒ½ï¼ï¼‰ã€‚</li>
<li><code>w</code> æŒ‡å®šæ¯ä¸ªé¡¹ç›®çš„å¤§å°ä¸º 32 ä½ã€‚</li>
</ul>
<p>è¯¥å‘½ä»¤çš„è¾“å‡ºå°†æ˜¾ç¤ºä»åœ°å€ <code>0x0</code> å¼€å§‹çš„ 4 æ¡æŒ‡ä»¤çš„åæ±‡ç¼–ç»“æœã€‚</p>
<hr>
<h2 id="4-More-Assembler-Directives"><a href="#4-More-Assembler-Directives" class="headerlink" title="4. More Assembler Directives"></a>4. More Assembler Directives</h2><p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°ä¸€äº›å¸¸ç”¨çš„<strong>æ±‡ç¼–æŒ‡ä»¤</strong>ï¼Œå¹¶ä½¿ç”¨ä¸¤ä¸ªç¤ºä¾‹ç¨‹åºè¿›è¡Œè¯´æ˜ã€‚</p>
<blockquote>
<p>ğŸ’¡ğŸ’¡ <strong>æ±‡ç¼–æŒ‡ä»¤æ€»æ˜¯ä»¥ <code>.</code> å¼€å¤´</strong>ã€‚</p>
</blockquote>
<ol>
<li>ä¸€ä¸ªè®¡ç®—æ•°ç»„æ€»å’Œçš„ç¨‹åº</li>
<li>ä¸€ä¸ªè®¡ç®—å­—ç¬¦ä¸²é•¿åº¦çš„ç¨‹åº</li>
</ol>
<h3 id="4-1-Sum-an-Array"><a href="#4-1-Sum-an-Array" class="headerlink" title="4.1. Sum an Array"></a>4.1. Sum an Array</h3><p>ä»¥ä¸‹ä»£ç å¯¹ä¸€ä¸ªå­—èŠ‚æ•°ç»„è¿›è¡Œæ±‚å’Œï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ <code>r3</code> ä¸­ã€‚</p>
<p><strong>Listing 2. Sum an Array</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">entry:  b start                 @ Skip over the data</span><br><span class="line">arr:    .byte 10, 20, 25        @ Read-only array of bytes</span><br><span class="line">eoa:                            @ Address of end of array + 1</span><br><span class="line"></span><br><span class="line">        .align</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =eoa          @ r0 = &amp;eoa</span><br><span class="line">        ldr   r1, =arr          @ r1 = &amp;arr</span><br><span class="line">        mov   r3, #0            @ r3 = 0</span><br><span class="line">loop:   ldrb  r2, [r1], #1      @ r2 = *r1++</span><br><span class="line">        add   r3, r2, r3        @ r3 += r2</span><br><span class="line">        cmp   r1, r0            @ if (r1 != r2)</span><br><span class="line">        bne   loop              @    goto loop</span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure>

<p>è¯¥ä»£ç å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„<strong>æ±‡ç¼–æŒ‡ä»¤</strong>â€”â€”<code>.byte</code> å’Œ <code>.align</code>ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™äº›æ±‡ç¼–æŒ‡ä»¤çš„æè¿°ã€‚</p>
<h4 id="4-1-1-byte-Directive"><a href="#4-1-1-byte-Directive" class="headerlink" title="4.1.1. .byte Directive"></a>4.1.1. <code>.byte</code> Directive</h4><p><code>.byte</code> çš„å­—èŠ‚å¤§å°å‚æ•°<strong>åœ¨å†…å­˜ä¸­è¢«ç»„è£…æˆè¿ç»­çš„å­—èŠ‚</strong>ã€‚è¿˜æœ‰ç±»ä¼¼çš„æŒ‡ä»¤ <code>.2byte</code> å’Œ <code>.4byte</code> åˆ†åˆ«ç”¨äºå­˜å‚¨ 16 ä½å€¼å’Œ 32 ä½å€¼ã€‚ä¸€èˆ¬çš„è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The byte sized arguments of `.byte` are assembled into consecutive bytes in memory.</span><br><span class="line">There are similar directives `.2byte` and `.4byte` for storing 16 bit values and 32 bit values, respectively.</span><br><span class="line">The general syntax is given below.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.byte   exp1, exp2, ...</span><br><span class="line">.2byte  exp1, exp2, ...</span><br><span class="line">.4byte  exp1, exp2, ...</span><br></pre></td></tr></table></figure>

<p>å‚æ•°å¯ä»¥æ˜¯ç®€å•çš„æ•´æ•°å­—é¢é‡ï¼Œå¯ä»¥ç”¨äºŒè¿›åˆ¶ï¼ˆä»¥ <code>0b</code> æˆ– <code>0B</code> ä¸ºå‰ç¼€ï¼‰ã€å…«è¿›åˆ¶ï¼ˆä»¥ <code>0</code> ä¸ºå‰ç¼€ï¼‰ã€åè¿›åˆ¶æˆ–åå…­è¿›åˆ¶ï¼ˆä»¥ <code>0x</code> æˆ– <code>0X</code> ä¸ºå‰ç¼€ï¼‰è¡¨ç¤ºã€‚æ•´æ•°ä¹Ÿå¯ä»¥ç”¨å­—ç¬¦å¸¸é‡è¡¨ç¤ºï¼ˆå­—ç¬¦ç”¨å•å¼•å·æ‹¬èµ·æ¥ï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹å°†ä½¿ç”¨å­—ç¬¦çš„ ASCII å€¼ã€‚</p>
<p>å‚æ•°è¿˜å¯ä»¥æ˜¯<strong>ç”±å­—é¢é‡å’Œå…¶ä»–ç¬¦å·æ„æˆçš„ C è¡¨è¾¾å¼</strong>ã€‚ä¸‹é¢ç»™å‡ºäº†ç¤ºä¾‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">The arguments could be simple integer literal, represented as binary (prefixed by `0b` or `0B`),</span><br><span class="line">octal (prefixed by `0`), decimal or hexadecimal (prefixed by `0x` or `0X`).</span><br><span class="line">The integers could also be represented as character constants (character surrounded by single quotes),</span><br><span class="line">in which case the ASCII value of the character will be used.</span><br><span class="line"></span><br><span class="line">The arguments could also be C expressions constructed out of literals and other symbols. Examples are shown below.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pattern:  .byte 0b01010101, 0b00110011, 0b00001111</span><br><span class="line">npattern: .byte npattern - pattern</span><br><span class="line">halpha:   .byte &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, &#x27;D&#x27;, &#x27;E&#x27;, &#x27;F&#x27;</span><br><span class="line">dummy:    .4byte 0xDEADBEEF</span><br><span class="line">nalpha:   .byte &#x27;Z&#x27; - &#x27;A&#x27; + 1</span><br></pre></td></tr></table></figure>

<h4 id="4-1-2-align-Directive"><a href="#4-1-2-align-Directive" class="headerlink" title="4.1.2. .align Directive"></a>4.1.2. <code>.align</code> Directive</h4><p>ARM è¦æ±‚<strong>æŒ‡ä»¤</strong>å¿…é¡»ä½äº 32 ä½å¯¹é½çš„å†…å­˜ä½ç½®ã€‚æŒ‡ä»¤ä¸­çš„ 4 ä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åœ°å€åº”è¯¥æ˜¯ 4 çš„å€æ•°ã€‚ä¸ºäº†æ»¡è¶³è¿™ä¸€è¦æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ <code>.align</code> æŒ‡ä»¤æ’å…¥å¡«å……å­—èŠ‚ï¼Œç›´åˆ°ä¸‹ä¸€ä¸ªå­—èŠ‚åœ°å€ä¸º 4 çš„å€æ•°ã€‚è¿™ä»…åœ¨ä»£ç ä¸­æ’å…¥æ•°æ®å­—èŠ‚æˆ–åŠå­—æ—¶éœ€è¦ã€‚</p>
<blockquote>
<p>ğŸ’¡ğŸ’¡æ³¨æ„æ˜¯ arm æŒ‡ä»¤ï¼Œä¸æ˜¯æ•°æ®ï¼ˆæˆ–è€…è¯´æ ‡ç­¾ï¼‰ï¼Œä¹Ÿä¸æ˜¯ <strong>æ±‡ç¼–æŒ‡ä»¤</strong>ï¼ˆä¸ç„¶ .align æœ¬èº«å°±å¾—å…ˆå¯¹é½æ‰èƒ½ä½¿ç”¨äº†ï¼‰ã€‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ARM requires that the instructions be present in 32-bit aligned memory locations.</span><br><span class="line">The address of the first byte, of the 4 bytes in an instruction, should be a multiple of 4.</span><br><span class="line">To adhere to this, the `.align` directive can be used to insert padding bytes</span><br><span class="line">till the next byte address will be a multiple of 4.</span><br><span class="line">This is required only when data bytes or half words are inserted within code.</span><br></pre></td></tr></table></figure>

<h3 id="4-2-String-Length"><a href="#4-2-String-Length" class="headerlink" title="4.2. String Length"></a>4.2. String Length</h3><p>ä»¥ä¸‹ä»£ç è®¡ç®—å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå¹¶å°†é•¿åº¦å­˜å‚¨åœ¨å¯„å­˜å™¨ <code>r1</code> ä¸­ã€‚</p>
<p><strong>Listing 3. String Length</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">        b start</span><br><span class="line"></span><br><span class="line">str:    .asciz &quot;Hello World&quot;</span><br><span class="line"></span><br><span class="line">        .equ   nul, 0</span><br><span class="line"></span><br><span class="line">        .align</span><br><span class="line">start:  ldr   r0, =str          @ r0 = &amp;str</span><br><span class="line">        mov   r1, #0</span><br><span class="line"></span><br><span class="line">loop:   ldrb  r2, [r0], #1      @ r2 = *(r0++)</span><br><span class="line">        add   r1, r1, #1        @ r1 += 1</span><br><span class="line">        cmp   r2, #nul          @ if (r2 != nul)</span><br><span class="line">        bne   loop              @    goto loop</span><br><span class="line"></span><br><span class="line">        sub   r1, r1, #1        @ r1 -= 1</span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure>

<p>è¯¥ä»£ç å¼•å…¥äº†ä¸¤ä¸ªæ–°çš„æ±‡ç¼–æŒ‡ä»¤â€”â€”<code>.asciz</code> å’Œ <code>.equ</code>ã€‚ä»¥ä¸‹æ˜¯å¯¹è¿™äº›æ±‡ç¼–æŒ‡ä»¤çš„æè¿°ã€‚</p>
<h4 id="4-2-1-asciz-Directive"><a href="#4-2-1-asciz-Directive" class="headerlink" title="4.2.1. .asciz Directive"></a>4.2.1. <code>.asciz</code> Directive</h4><p><code>.asciz</code> æŒ‡ä»¤æ¥å—å­—ç¬¦ä¸²å­—é¢é‡ä½œä¸ºå‚æ•°ã€‚<strong>å­—ç¬¦ä¸²å­—é¢é‡æ˜¯ç”¨åŒå¼•å·æ‹¬èµ·æ¥çš„å­—ç¬¦åºåˆ—</strong>ã€‚è¿™äº›å­—ç¬¦ä¸²å­—é¢é‡è¢«ç»„è£…åˆ°è¿ç»­çš„å†…å­˜ä½ç½®ã€‚æ±‡ç¼–ç¨‹åºä¼šè‡ªåŠ¨åœ¨æ¯ä¸ªå­—ç¬¦ä¸²åæ’å…¥ä¸€ä¸ª <code>nul</code> å­—ç¬¦ï¼ˆ<code>\0</code> å­—ç¬¦ï¼‰ã€‚</p>
<p><code>.ascii</code> æŒ‡ä»¤ä¸ <code>.asciz</code> ç›¸åŒï¼Œä½†<strong>æ±‡ç¼–ç¨‹åºä¸ä¼šåœ¨æ¯ä¸ªå­—ç¬¦ä¸²åæ’å…¥ <code>nul</code> å­—ç¬¦</strong>ã€‚</p>
<blockquote>
<p>â›”â›”â›” æ³¨æ„äºŒè€…åŒºåˆ«ã€‚</p>
</blockquote>
<h4 id="4-2-2-equ-Directive"><a href="#4-2-2-equ-Directive" class="headerlink" title="4.2.2. .equ Directive"></a>4.2.2. <code>.equ</code> Directive</h4><p>æ±‡ç¼–ç¨‹åºç»´æŠ¤ä¸€ä¸ªç§°ä¸ºç¬¦å·è¡¨çš„ç»“æ„ã€‚ç¬¦å·è¡¨å°†æ ‡ç­¾åç§°æ˜ å°„åˆ°åœ°å€ã€‚<strong>æ¯å½“æ±‡ç¼–ç¨‹åºé‡åˆ°æ ‡ç­¾å®šä¹‰æ—¶ï¼Œå®ƒä¼šåœ¨ç¬¦å·è¡¨ä¸­åˆ›å»ºä¸€ä¸ªæ¡ç›®</strong>ã€‚æ¯å½“æ±‡ç¼–ç¨‹åºé‡åˆ°æ ‡ç­¾å¼•ç”¨æ—¶ï¼Œå®ƒä¼šç”¨ç¬¦å·è¡¨ä¸­å¯¹åº”çš„åœ°å€æ›¿æ¢è¯¥æ ‡ç­¾ã€‚</p>
<p>ğŸ’¡ğŸ’¡<strong>ä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤ <code>.equ</code>ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å‘ç¬¦å·è¡¨ä¸­æ’å…¥æ¡ç›®ï¼Œå°†åç§°æ˜ å°„åˆ°ä¸ä¸€å®šæ˜¯åœ°å€çš„å€¼</strong>ã€‚æ¯å½“æ±‡ç¼–ç¨‹åºé‡åˆ°è¿™äº›åç§°æ—¶ï¼Œå®ƒä¼šç”¨ç›¸åº”çš„å€¼æ›¿æ¢å®ƒä»¬ã€‚è¿™äº›åç§°å’Œæ ‡ç­¾åç§°ç»Ÿç§°ä¸º<strong>ç¬¦å·åç§°</strong>ã€‚</p>
<p>è¯¥æŒ‡ä»¤çš„ä¸€èˆ¬è¯­æ³•å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">The assembler maintains something called a symbol table. The symbol table maps label names to addresses.</span><br><span class="line">Whenever the assembler encounters a label definition, the assembler makes an entry in the symbol table.</span><br><span class="line">And whenever the assembler encounters a label reference, it replaces the label by the corresponding</span><br><span class="line">address from the symbol table.</span><br><span class="line"></span><br><span class="line">Using the assembler directive `.equ`, it is also possible to manually insert entries in the symbol table,</span><br><span class="line">to map names to values, which are not necessarily addresses. Whenever the assembler encounters these names,</span><br><span class="line">it replaces them by their corresponding values. These names and label names are together called symbol names.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.equ name, expression</span><br></pre></td></tr></table></figure>

<ul>
<li><code>name</code> æ˜¯ä¸€ä¸ªç¬¦å·åç§°ï¼Œå…¶é™åˆ¶ä¸æ ‡ç­¾åç§°ç›¸åŒã€‚</li>
<li><code>expression</code> å¯ä»¥æ˜¯ç®€å•çš„å­—é¢é‡ï¼Œä¹Ÿå¯ä»¥æ˜¯å¦‚ <code>.byte</code> æŒ‡ä»¤ä¸­æ‰€è§£é‡Šçš„è¡¨è¾¾å¼ã€‚</li>
</ul>
<blockquote>
<p>ä¸ <code>.byte</code> æŒ‡ä»¤ä¸åŒï¼Œ<code>.equ</code> æŒ‡ä»¤æœ¬èº«å¹¶ä¸åˆ†é…ä»»ä½•å†…å­˜ã€‚å®ƒä»¬åªæ˜¯åˆ›å»ºç¬¦å·è¡¨ä¸­çš„æ¡ç›®ã€‚</p>
</blockquote>
<hr>
<h2 id="5-Using-RAM"><a href="#5-Using-RAM" class="headerlink" title="5. Using RAM"></a>5. Using RAM</h2><p>Flash å­˜å‚¨å™¨ä¸­å­˜å‚¨çš„å‰é¢çš„ç¤ºä¾‹ç¨‹åºæ˜¯ä¸€ç§ EEPROMã€‚å®ƒæ˜¯ä¸€ç§æœ‰ç”¨çš„äºŒçº§å­˜å‚¨ï¼Œç±»ä¼¼äºç¡¬ç›˜ï¼Œä½†åœ¨ Flash ä¸­å­˜å‚¨å˜é‡å¹¶ä¸æ–¹ä¾¿ã€‚å˜é‡åº”å­˜å‚¨åœ¨ RAM ä¸­ï¼Œä»¥ä¾¿å¯ä»¥è½»æ¾ä¿®æ”¹ã€‚</p>
<p>Connex æ¿å…·æœ‰ 64 MB çš„ RAMï¼Œä»åœ°å€ <code>0xA0000000</code> å¼€å§‹ï¼Œå¯ä»¥åœ¨å…¶ä¸­å­˜å‚¨å˜é‡ã€‚Connex æ¿çš„å†…å­˜æ˜ å°„å¯ä»¥å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><strong>Figure 1. Memory Map</strong></p>
<p><img src="/../images/GNUToolchain/flash-ram-mm.png" alt="Memory Map"></p>
<p>éœ€è¦è¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œä»¥å°†å˜é‡æ”¾ç½®åœ¨è¯¥åœ°å€ã€‚è¦ç†è§£éœ€è¦åšä»€ä¹ˆï¼Œå°±å¿…é¡»äº†è§£æ±‡ç¼–å™¨å’Œé“¾æ¥å™¨çš„è§’è‰²ã€‚</p>
<blockquote>
<p>ä¸ªäººç†è§£ï¼šæ±‡ç¼–å™¨å°†å•ä¸ªæ–‡ä»¶è§£é‡Šä¸ºæœºå™¨æŒ‡ä»¤ã€‚é“¾æ¥å™¨å°†è¿™äº›æœºå™¨æŒ‡ä»¤ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
</blockquote>
<hr>
<h2 id="6-Linker"><a href="#6-Linker" class="headerlink" title="6. Linker"></a>6. Linker</h2><p>åœ¨ç¼–å†™å¤šæ–‡ä»¶ç¨‹åºæ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶ä¼šå•ç‹¬æ±‡ç¼–æˆç›®æ ‡æ–‡ä»¶ã€‚é“¾æ¥å™¨å°†è¿™äº›ç›®æ ‡æ–‡ä»¶ç»„åˆåœ¨ä¸€èµ·ï¼Œå½¢æˆæœ€ç»ˆçš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<p><strong>Figure 2. Role of the Linker</strong></p>
<p><img src="/../images/GNUToolchain/linker.png" alt="Role of the Linker"></p>
<p>åœ¨åˆå¹¶ç›®æ ‡æ–‡ä»¶æ—¶ï¼Œ<strong>é“¾æ¥å™¨</strong>æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
<ol>
<li>Symbol Resolution ç¬¦å·è§£æ</li>
<li>Relocation é‡å®šä½</li>
</ol>
<p>åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†è¯¦ç»†ä»‹ç»è¿™äº›æ“ä½œã€‚</p>
<h3 id="6-1-Symbol-Resolution"><a href="#6-1-Symbol-Resolution" class="headerlink" title="6.1. Symbol Resolution"></a>6.1. Symbol Resolution</h3><p>åœ¨å•æ–‡ä»¶ç¨‹åºä¸­ï¼Œåœ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶æ—¶ï¼Œæ±‡ç¼–å™¨å°†æ‰€æœ‰æ ‡ç­¾çš„å¼•ç”¨æ›¿æ¢ä¸ºç›¸åº”çš„åœ°å€ã€‚ä½†åœ¨å¤šæ–‡ä»¶ç¨‹åºä¸­ï¼Œå¦‚æœå­˜åœ¨å¯¹å…¶ä»–æ–‡ä»¶ä¸­å®šä¹‰çš„æ ‡ç­¾çš„å¼•ç”¨ï¼Œæ±‡ç¼–å™¨å°†è¿™äº›å¼•ç”¨æ ‡è®°ä¸ºâ€œ<strong>æœªè§£å†³</strong>â€ã€‚å½“è¿™äº›ç›®æ ‡æ–‡ä»¶è¢«ä¼ é€’ç»™é“¾æ¥å™¨æ—¶ï¼Œé“¾æ¥å™¨ä»å…¶ä»–ç›®æ ‡æ–‡ä»¶ä¸­ç¡®å®šè¿™äº›å¼•ç”¨çš„å€¼ï¼Œå¹¶ä½¿ç”¨æ­£ç¡®çš„å€¼ä¿®è¡¥ä»£ç ã€‚</p>
<blockquote>
<p>æƒ³æƒ³åŠ¨æ€åº“çš„ä¾‹å­ï¼Œæ¿ç«¯è¿è¡Œç¨‹åºæ—¶æ‰å»ä½¿ç”¨é“¾æ¥å™¨è¿›è¡Œé“¾æ¥ï¼Œè€Œæ±‡ç¼–å™¨ä»…åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ã€‚é“¾æ¥å™¨ä¹Ÿå¯ä»¥åœ¨ç¼–è¯‘æ—¶ä½¿ç”¨ï¼Œé™æ€é“¾æ¥ <code>-static</code>ã€‚</p>
<p>ä¸è¿‡ç¼–è¯‘å’Œè¿è¡Œæ—¶çš„é“¾æ¥å™¨ä¸åŒï¼š</p>
<ul>
<li>é“¾æ¥å™¨ï¼šå·¥ä½œäºé“¾æ¥é˜¶æ®µï¼Œç”¨<code>-l -L</code>æŒ‡å®šåŠ¨æ€åº“è·¯å¾„ã€‚</li>
<li>åŠ¨æ€é“¾æ¥å™¨ï¼šå·¥ä½œäºç¨‹åºè¿è¡Œé˜¶æ®µï¼Œå·¥ä½œæ—¶éœ€è¦æä¾›åŠ¨æ€åº“æ‰€åœ¨ç›®å½•ä½ç½®ï¼Œé€šè¿‡ç¯å¢ƒå˜é‡ï¼š<code>export LD_LIBRARY_PATH=/path</code>ã€‚</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In a single file program, while producing the object file, all references to labels are replaced by</span><br><span class="line">their corresponding addresses by the assembler. But in a multi-file program, if there are any references</span><br><span class="line">to labels defined in another file, the assembler marks these references as &quot;unresolved&quot;.</span><br><span class="line">When these object files are passed to the linker, the linker determines the values for</span><br><span class="line">these references from the other object files, and patches the code with the correct values.</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ¼”ç¤ºé“¾æ¥å™¨æ‰§è¡Œçš„<strong>ç¬¦å·è§£æ</strong>ï¼Œæ•°ç»„æ±‚å’Œç¤ºä¾‹è¢«åˆ†ä¸ºä¸¤ä¸ªæ–‡ä»¶ã€‚è¿™ä¸¤ä¸ªæ–‡ä»¶å°†è¢«æ±‡ç¼–ï¼Œå¹¶æ£€æŸ¥å®ƒä»¬çš„ç¬¦å·è¡¨ï¼Œä»¥æ˜¾ç¤ºæœªè§£å†³å¼•ç”¨çš„å­˜åœ¨ã€‚</p>
<p>æ–‡ä»¶ <code>sum-sub.s</code> åŒ…å« <code>sum</code> å­ç¨‹åºï¼Œè€Œæ–‡ä»¶ <code>main.s</code> ä½¿ç”¨æ‰€éœ€çš„å‚æ•°è°ƒç”¨è¯¥å­ç¨‹åºã€‚æ–‡ä»¶çš„æºä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><strong>Listing 4. <code>main.s</code> - Subroutine Invocation</strong> å­ç¨‹åºè°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">        .text</span><br><span class="line">        b start                 @ Skip over the data</span><br><span class="line">arr:    .byte 10, 20, 25        @ Read-only array of bytes</span><br><span class="line">eoa:                            @ Address of end of array + 1</span><br><span class="line"></span><br><span class="line">        .align</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =arr          @ r0 = &amp;arr</span><br><span class="line">        ldr   r1, =eoa          @ r1 = &amp;eoa</span><br><span class="line">        bl    sum               @ Invoke the sum subroutine</span><br><span class="line"></span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure>

<p>**Listing 5. <code>sum-sub.s</code> - Subroutine Definition **å­ç¨‹åºå®šä¹‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">        @ Args</span><br><span class="line">        @ r0: Start address of array</span><br><span class="line">        @ r1: End address of array</span><br><span class="line">        @</span><br><span class="line">        @ Result</span><br><span class="line">        @ r3: Sum of Array</span><br><span class="line"></span><br><span class="line">        .global sum</span><br><span class="line"></span><br><span class="line">sum:    mov   r3, #0            @ r3 = 0</span><br><span class="line">loop:   ldrb  r2, [r0], #1      @ r2 = *r0++    ; Get array element</span><br><span class="line">        add   r3, r2, r3        @ r3 += r2      ; Calculate sum</span><br><span class="line">        cmp   r0, r1            @ if (r0 != r1) ; Check if hit end-of-array</span><br><span class="line">        bne   loop              @    goto loop  ; Loop</span><br><span class="line">        mov   pc, lr            @ pc = lr       ; Return when done</span><br></pre></td></tr></table></figure>

<p>å…³äº <code>.global</code> æŒ‡ä»¤éœ€è¦è¯´æ˜ä¸€ä¸‹ã€‚åœ¨ C è¯­è¨€ä¸­ï¼Œæ‰€æœ‰åœ¨å‡½æ•°å¤–éƒ¨å£°æ˜çš„å˜é‡å¯¹å…¶ä»–æ–‡ä»¶å¯è§ï¼Œç›´åˆ°æ˜ç¡®å£°æ˜ä¸º <code>static</code>ã€‚<br><strong>ä½†</strong>åœ¨æ±‡ç¼–è¯­è¨€ä¸­ï¼Œæ‰€æœ‰æ ‡ç­¾éƒ½æ˜¯ <code>static</code>ï¼ˆå³æœ¬åœ°æ–‡ä»¶çš„ï¼‰ï¼Œç›´åˆ°æ˜ç¡®å£°æ˜å®ƒä»¬åº”è¯¥å¯¹å…¶ä»–æ–‡ä»¶å¯è§ï¼Œä½¿ç”¨ <code>.global</code> æŒ‡ä»¤ã€‚</p>
<p>è¿™äº›æ–‡ä»¶è¢«æ±‡ç¼–ï¼Œå¹¶ä½¿ç”¨ <code>nm</code> å‘½ä»¤æŸ¥çœ‹ç¬¦å·è¡¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o main.o main.s</span><br><span class="line">$ arm-linux-gnueabihf-as -o sum-sub.o sum-sub.s</span><br><span class="line">$ arm-linux-gnueabihf-nm main.o</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa <span class="comment"># æ³¨æ„çœ‹è¿™é‡Œå¹¶æ²¡æœ‰å¯¹é½ï¼Œå›é¡¾ä¸Šé¢ `.align` æŒ‡ä»¤</span></span><br><span class="line">00000008 t start</span><br><span class="line">00000018 t stop</span><br><span class="line">         U <span class="built_in">sum</span></span><br><span class="line">$ arm-linux-gnueabihf-nm sum-sub.o</span><br><span class="line">00000004 t loop</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br></pre></td></tr></table></figure>

<p>å…³æ³¨ç¬¬äºŒåˆ—ä¸­çš„å­—æ¯ï¼Œå®ƒæŒ‡å®šäº†ç¬¦å·ç±»å‹ã€‚<code>t</code> è¡¨ç¤ºç¬¦å·åœ¨æ–‡æœ¬æ®µä¸­å®šä¹‰ã€‚<code>u</code> è¡¨ç¤ºç¬¦å·æœªå®šä¹‰ã€‚**:fire: å¤§å†™å­—æ¯è¡¨ç¤ºç¬¦å·æ˜¯** <code>.global</code>ã€‚</p>
<p>æ˜¾ç„¶ï¼Œç¬¦å· <code>sum</code> åœ¨ <code>sum-sub.o</code> ä¸­å®šä¹‰ï¼Œåœ¨ <code>main.o</code> ä¸­å°šæœªè§£æã€‚å½“é“¾æ¥å™¨è¢«è°ƒç”¨æ—¶ï¼Œç¬¦å·å¼•ç”¨å°†è¢«è§£æï¼Œå¹¶ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚</p>
<h3 id="6-2-Relocation"><a href="#6-2-Relocation" class="headerlink" title="6.2. Relocation"></a>6.2. Relocation</h3><p><strong>é‡å®šä½æ˜¯æŒ‡æ›´æ”¹å·²ç»åˆ†é…ç»™æ ‡ç­¾çš„åœ°å€çš„è¿‡ç¨‹</strong>ã€‚è¿™è¿˜æ¶‰åŠä¿®è¡¥æ‰€æœ‰æ ‡ç­¾å¼•ç”¨ï¼Œä»¥åæ˜ æ–°åˆ†é…çš„åœ°å€ã€‚é‡å®šä½ä¸»è¦å‡ºäºä»¥ä¸‹ä¸¤ä¸ªåŸå› è¿›è¡Œï¼š</p>
<ol>
<li>Section Merging æ®µåˆå¹¶</li>
<li>Section Placement æ®µæ”¾ç½®</li>
</ol>
<p>è¦ç†è§£é‡å®šä½çš„è¿‡ç¨‹ï¼Œå¿…é¡»å…ˆäº†è§£<strong>èŠ‚</strong><code>sections</code>çš„æ¦‚å¿µã€‚</p>
<blockquote>
<p>æœ‰æ—¶å€™å®¹æ˜“å°† <code>section</code> è¯¯è®¤ä¸ºæ®µã€‚</p>
</blockquote>
<p>ä»£ç å’Œæ•°æ®åœ¨è¿è¡Œæ—¶æœ‰ä¸åŒçš„è¦æ±‚ã€‚ä¾‹å¦‚ï¼Œä»£ç å¯ä»¥æ”¾ç½®åœ¨åªè¯»å†…å­˜ä¸­ï¼Œè€Œæ•°æ®å¯èƒ½éœ€è¦è¯»å†™å†…å­˜ã€‚<strong>æŠŠä»£ç å’Œæ•°æ®åˆ†å¼€æ”¾ç½®ï¼Œå°†ä¼šæ›´æ–¹ä¾¿</strong>ã€‚ä¸ºæ­¤ï¼Œç¨‹åºè¢«åˆ†ä¸ºä¸åŒçš„èŠ‚ <code>section</code>ã€‚å¤§å¤šæ•°ç¨‹åºè‡³å°‘æœ‰ä¸¤ä¸ª <code>section</code>ï¼Œ<code>.text</code> ç”¨äºä»£ç ï¼Œ<code>.data</code> ç”¨äºæ•°æ®ã€‚æ±‡ç¼–æŒ‡ä»¤ <code>.text</code> å’Œ <code>.data</code> ç”¨äºåœ¨è¿™ä¸¤ä¸ª <code>section</code> ä¹‹é—´åˆ‡æ¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Code and data have different run time requirements. For example code can be placed in</span><br><span class="line">read-only memory, and data might require read-write memory. It would be convenient,</span><br><span class="line">if code and data is **not** interleaved. For this purpose, programs are divided into sections.</span><br><span class="line">Most programs have at least two sections, `.text` for code and `.data` for data.</span><br><span class="line">Assembler directives `.text` and `.data`, are used to switch back and forth between the two sections.</span><br></pre></td></tr></table></figure>

<p>æƒ³è±¡æ¯ä¸ª <code>section</code> éƒ½æ˜¯ä¸€ä¸ªæ¡¶ã€‚å½“æ±‡ç¼–å™¨é‡åˆ° <code>section</code> æŒ‡ä»¤æ—¶ï¼Œå®ƒä¼šå°† <code>section</code> æŒ‡ä»¤åé¢çš„ä»£ç &#x2F;æ•°æ®æ”¾å…¥æ‰€é€‰çš„æ¡¶ä¸­ã€‚å› æ­¤ï¼Œå±äºç‰¹å®š <code>section</code> çš„ä»£ç &#x2F;æ•°æ®ä¼šå‡ºç°åœ¨è¿ç»­çš„ä½ç½®ã€‚ä»¥ä¸‹å›¾æ˜¾ç¤ºäº†æ±‡ç¼–å™¨å¦‚ä½•å°†æ•°æ®é‡æ–°æ’åˆ—åˆ°æ®µä¸­ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">It helps to imagine each section as a bucket. When the assembler hits a section directive,</span><br><span class="line">it puts the code/data following the directive in the selected bucket.</span><br><span class="line">Thus the code/data that belong to particular section appear in contiguous locations.</span><br><span class="line">The following figures show how the assembler re-arranges data into sections.</span><br></pre></td></tr></table></figure>

<p><strong>Figure 3. Sections</strong></p>
<p><img src="/../images/GNUToolchain/sections.png" alt="Sections"></p>
<p>ç°åœ¨æˆ‘ä»¬ç†è§£äº† <code>section</code> çš„æ¦‚å¿µï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹é‡å®šä½çš„ä¸»è¦åŸå› ã€‚</p>
<h4 id="6-2-1-Section-Merging"><a href="#6-2-1-Section-Merging" class="headerlink" title="6.2.1. Section Merging"></a>6.2.1. Section Merging</h4><p>åœ¨å¤„ç†å¤šæ–‡ä»¶ç¨‹åºæ—¶ï¼Œæ¯ä¸ªæ–‡ä»¶ä¸­å¯èƒ½ä¼šå‡ºç°åŒåçš„èŠ‚ï¼ˆä¾‹å¦‚ <code>.text</code>ï¼‰ã€‚é“¾æ¥å™¨è´Ÿè´£å°†è¾“å…¥æ–‡ä»¶ä¸­çš„èŠ‚åˆå¹¶åˆ°è¾“å‡ºæ–‡ä»¶çš„èŠ‚ä¸­ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒåçš„èŠ‚ä¼šè¿ç»­æ”¾ç½®ï¼Œå¹¶ä¸”æ ‡ç­¾å¼•ç”¨ä¼šè¢«ä¿®è¡¥ä»¥åæ˜ æ–°åœ°å€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">When dealing with multi-file programs, the sections with the same name (example `.text`)</span><br><span class="line">might appear, in each file. The linker is responsible for merging sections from</span><br><span class="line">the input files, into sections of the output file. By default, the sections,</span><br><span class="line">with the same name, from each file is placed contiguously and the label references</span><br><span class="line">are patched to reflect the new address.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œçœ‹åˆ°æ®µåˆå¹¶çš„æ•ˆæœã€‚å¯ä»¥ä½¿ç”¨å¤šæ–‡ä»¶çš„<a href="#6.1.-Symbol-Resolution">æ•°ç»„æ±‚å’Œç¨‹åº</a>æ¥è¯´æ˜æ®µåˆå¹¶çš„è¿‡ç¨‹ã€‚ç›®æ ‡æ–‡ä»¶ <code>main.o</code> å’Œ <code>sum-sub.o</code> çš„ç¬¦å·è¡¨ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶ <code>sum.elf</code> çš„ç¬¦å·è¡¨å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">The effects of section merging can be seen by looking at the symbol table of the object</span><br><span class="line">files and the corresponding executable file. The multi-file sum of array program can be</span><br><span class="line">used to illustrate section merging. The symbol table of the object files `main.o` and</span><br><span class="line">`sum-sub.o` and the symbol table of the executable file `sum.elf` is shown below.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm main.o</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000018 t stop</span><br><span class="line">         U <span class="built_in">sum</span></span><br><span class="line">$ arm-linux-gnueabihf-nm sum-sub.o</span><br><span class="line">00000004 t loop â¶</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x0 -o sum.elf main.o sum-sub.o</span><br><span class="line">$ arm-linux-gnueabihf-nm sum.elf</span><br><span class="line">...</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000018 t stop</span><br><span class="line">00000028 t loop â¶</span><br><span class="line">00000024 T <span class="built_in">sum</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>sum-sub.o</code> ä¸­ï¼Œ<code>loop</code> ç¬¦å·çš„åœ°å€ä¸º <code>0x4</code>ï¼Œè€Œåœ¨ <code>sum.elf</code> ä¸­åˆ™ä¸º <code>0x28</code>ï¼Œå› ä¸º <code>sum-sub.o</code> çš„ <code>.text</code> èŠ‚è¢«æ”¾ç½®åœ¨ <code>main.o</code> çš„ <code>.text</code> èŠ‚ä¹‹åã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">yogurt@s:GNUToolchain$ arm-linux-gnueabihf-ld main.o sum-sub.o -o main -Ttext=0x0</span><br><span class="line">$ arm-linux-gnueabihf-nm main.o sum-sub.o main</span><br><span class="line"></span><br><span class="line">main.o:</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000014 t stop</span><br><span class="line">         U <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line">sum-sub.o:</span><br><span class="line">00000004 t loop</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000014 t stop</span><br><span class="line">00000020 T <span class="built_in">sum</span></span><br><span class="line">00000024 t loop <span class="comment"># 0x24</span></span><br><span class="line">00010038 T __bss_end__</span><br><span class="line">00010038 T _bss_end__</span><br><span class="line">00010038 T __bss_start</span><br><span class="line">00010038 T __bss_start__</span><br><span class="line">00010038 T _edata</span><br><span class="line">00010038 T __end__</span><br><span class="line">00010038 T _end</span><br><span class="line"></span><br><span class="line"><span class="comment">############## å¯¹æ¯”é“¾æ¥é¡ºåºçš„å·®å¼‚</span></span><br><span class="line">yogurt@s:GNUToolchain$ arm-linux-gnueabihf-ld sum-sub.o main.o  -o main -Ttext=0x0</span><br><span class="line">arm-linux-gnueabihf-ld: warning: cannot find entry symbol _start; defaulting to 0000000000000000</span><br><span class="line">yogurt@s:GNUToolchain$ arm-linux-gnueabihf-nm main.o sum-sub.o main</span><br><span class="line"></span><br><span class="line">main.o:</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000014 t stop</span><br><span class="line">         U <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line">sum-sub.o:</span><br><span class="line">00000004 t loop</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br><span class="line"></span><br><span class="line">main:</span><br><span class="line">00000000 T <span class="built_in">sum</span></span><br><span class="line">00000004 t loop</span><br><span class="line">0000001c t arr</span><br><span class="line">0000001f t eoa</span><br><span class="line">00000020 t start</span><br><span class="line">0000002c t stop <span class="comment"># 0x2c</span></span><br><span class="line">00010038 T __bss_end__</span><br><span class="line">00010038 T _bss_end__</span><br><span class="line">00010038 T __bss_start</span><br><span class="line">00010038 T __bss_start__</span><br><span class="line">00010038 T _edata</span><br><span class="line">00010038 T __end__</span><br><span class="line">00010038 T _end</span><br></pre></td></tr></table></figure>

<h4 id="6-2-2-Section-Placement"><a href="#6-2-2-Section-Placement" class="headerlink" title="6.2.2. Section Placement"></a>6.2.2. Section Placement</h4><p>å½“ç¨‹åºè¢«æ±‡ç¼–æ—¶ï¼Œæ¯ä¸ªæ®µè¢«å‡å®šä»åœ°å€ 0 å¼€å§‹ã€‚å› æ­¤ï¼Œæ ‡ç­¾ç›¸å¯¹äºæ®µçš„èµ·å§‹ä½ç½®åˆ†é…å€¼ã€‚å½“æœ€ç»ˆå¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºæ—¶ï¼Œè¯¥æ®µè¢«æ”¾ç½®åœ¨æŸä¸ªåœ°å€ Xã€‚æ‰€æœ‰åœ¨è¯¥æ®µå†…å®šä¹‰çš„æ ‡ç­¾çš„å¼•ç”¨éƒ½å°†å¢åŠ  Xï¼Œä»¥ä½¿å®ƒä»¬æŒ‡å‘æ–°ä½ç½®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">When a program is assembled, each section is assumed to start from address 0.</span><br><span class="line">And thus labels are assigned values relative to start of the section. When the</span><br><span class="line">final executable is created, the section is placed at some address X.</span><br><span class="line">And all references to the labels defined within the section, are incremented by X,</span><br><span class="line">so that they point to the new location.</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªæ®µåœ¨å†…å­˜ä¸­ç‰¹å®šä½ç½®çš„æ”¾ç½®ä»¥åŠå¯¹æ®µä¸­æ ‡ç­¾çš„æ‰€æœ‰å¼•ç”¨çš„ä¿®è¡¥ï¼Œç”±é“¾æ¥å™¨å®Œæˆã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The placement of each section at a particular location in memory and the patching</span><br><span class="line">of all references to the labels in the section, is done by the linker.</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡æŸ¥çœ‹ç›®æ ‡æ–‡ä»¶çš„ç¬¦å·è¡¨ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶çš„ç¬¦å·è¡¨ï¼Œçœ‹åˆ°æ®µæ”¾ç½®çš„æ•ˆæœã€‚å¯ä»¥ä½¿ç”¨å•æ–‡ä»¶çš„<a href="#4.1.-Sum-an-Array">æ•°ç»„æ±‚å’Œç¨‹åº</a>æ¥è¯´æ˜æ®µæ”¾ç½®çš„è¿‡ç¨‹ã€‚ä¸ºäº†æ›´æ¸…æ¥šèµ·è§ï¼Œæˆ‘ä»¬å°†æŠŠ <code>.text</code> æ®µæ”¾ç½®åœ¨åœ°å€ <code>0x100</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The effects of section placement can be seen by looking at the symbol table of the object file and the corresponding executable file. The single file sum of array program can be used to illustrate section placement. To make things clearer, we will place the `.text` section at address `0x100`.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o sum.o sum.s</span><br><span class="line">$ arm-linux-gnueabihf-nm -n sum.o</span><br><span class="line">00000000 t entry â¶</span><br><span class="line">00000004 t arr</span><br><span class="line">00000007 t eoa</span><br><span class="line">00000008 t start</span><br><span class="line">00000014 t loop</span><br><span class="line">00000024 t stop</span><br><span class="line">$ arm-linux-gnueabihf-ld -Ttext=0x100 -o sum.elf sum.o â·</span><br><span class="line">$ arm-linux-gnueabihf-nm -n sum.elf</span><br><span class="line">00000100 t entry â¸</span><br><span class="line">00000104 t arr</span><br><span class="line">00000107 t eoa</span><br><span class="line">00000108 t start</span><br><span class="line">00000114 t loop</span><br><span class="line">00000124 t stop</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>â¶<code>section</code> èŠ‚å†…æ ‡ç­¾çš„åœ°å€ä» 0 å¼€å§‹åˆ†é…ã€‚</p>
<p>â·å½“å¯æ‰§è¡Œæ–‡ä»¶åˆ›å»ºæ—¶ï¼Œé“¾æ¥å™¨è¢«æŒ‡ç¤ºå°†æ–‡æœ¬æ®µæ”¾ç½®åœ¨åœ°å€ <code>0x100</code>ã€‚</p>
<p>â¸<code>.text</code> æ®µä¸­çš„æ ‡ç­¾çš„åœ°å€è¢«é‡æ–°åˆ†é…ï¼Œèµ·å§‹åœ°å€ä¸º <code>0x100</code>ï¼Œæ‰€æœ‰æ ‡ç­¾å¼•ç”¨å°†è¢«ä¿®è¡¥ä»¥åæ˜ æ­¤æ›´æ”¹ã€‚</p>
<p>æ®µåˆå¹¶å’Œæ”¾ç½®çš„è¿‡ç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><strong>Figure 4. Section Merging and Placement</strong></p>
<p><img src="/../images/GNUToolchain/relocation.png" alt="Section Merging and Placement"></p>
<hr>
<h2 id="7-Linker-Script-File"><a href="#7-Linker-Script-File" class="headerlink" title="7. Linker Script File"></a>7. Linker Script File</h2><p>å¦‚ä¸Šä¸€èŠ‚æ‰€è¿°ï¼ŒèŠ‚åˆå¹¶å’Œæ”¾ç½®æ˜¯ç”±é“¾æ¥å™¨å®Œæˆçš„ã€‚ç¨‹åºå‘˜å¯ä»¥é€šè¿‡é“¾æ¥å™¨è„šæœ¬æ–‡ä»¶æ§åˆ¶éƒ¨åˆ†çš„åˆå¹¶æ–¹å¼ï¼Œä»¥åŠå®ƒä»¬åœ¨å†…å­˜ä¸­çš„ä½ç½®ã€‚ä¸€ä¸ªéå¸¸ç®€å•çš„é“¾æ¥å™¨è„šæœ¬æ–‡ä»¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><strong>Listing 6. Basic linker script</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123; â¶</span><br><span class="line">        . = 0x00000000; â·</span><br><span class="line">        .text : &#123; â¸</span><br><span class="line">                abc.o (.text);</span><br><span class="line">                def.o (.text);</span><br><span class="line">        &#125; â¹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>è¯¥<code>SECTIONS</code>å‘½ä»¤æ˜¯æœ€é‡è¦çš„é“¾æ¥å™¨ å‘½ä»¤ï¼Œå®ƒæŒ‡å®šå¦‚ä½•åˆå¹¶éƒ¨åˆ†ä»¥åŠåˆå¹¶åˆ°ä»€ä¹ˆä½ç½® å®ƒä»¬è¦æ”¾ç½®çš„ä½ç½®ã€‚</p>
<blockquote>
<p>The <code>SECTIONS</code> command is the most important linker command, it specifies how the sections are to be merged and at what location they are to be placed.</p>
</blockquote>
</li>
<li><p>åœ¨åé¢çš„å—å†… <code>SECTIONS</code>å‘½ä»¤ä¸­ï¼Œ<code>.</code>ï¼ˆå¥ç‚¹ï¼‰è¡¨ç¤ºä½ç½®è®¡æ•°å™¨ ä½ç½®æ€»æ˜¯åˆå§‹åŒ–ä¸º<code>0x0</code>ã€‚ å¯ä»¥é€šè¿‡ä¸ºå…¶åˆ†é…ä¸€ä¸ªæ–°å€¼æ¥ä¿®æ”¹å®ƒã€‚è®¾ç½® å¼€å¤´<code>0x0</code>çš„å€¼æ˜¯å¤šä½™çš„ã€‚</p>
<blockquote>
<p>Within the block following the <code>SECTIONS</code> command, the <code>.</code> (period) represents the location counter. The location is always initialised to <code>0x0</code>. It can be modified by assigning a new value to it. Setting the value to <code>0x0</code> at the beginning is superfluous.</p>
</blockquote>
</li>
<li><p>è„šæœ¬çš„è¿™ä¸€éƒ¨åˆ†æŒ‡å®š è¾“å…¥ä¸­çš„<code>.text</code>éƒ¨åˆ† æ–‡ä»¶<code>abc.o</code>å’Œ<code>def.o</code>åº”è¯¥è½¬åˆ°è¾“å‡ºæ–‡ä»¶çš„<code>.text</code>éƒ¨åˆ†ã€‚</p>
<blockquote>
<p>This part of the script specifies that, the <code>.text</code> section from the input files <code>abc.o</code> and <code>def.o</code> should go to the <code>.text</code> section of the output file.</p>
</blockquote>
</li>
</ol>
<p>é“¾æ¥å™¨è„šæœ¬å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›ä¸€æ­¥ç®€åŒ–å’Œæ¦‚æ‹¬ ä½¿ç”¨é€šé…ç¬¦<code>*</code> è€Œä¸æ˜¯å•ç‹¬æŒ‡å®šæ–‡ä»¶åã€‚</p>
<p><strong>Listing 7. Wildcard in linker scripts</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123; * (.text); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç¨‹åºåŒæ—¶åŒ…å«<code>.text</code> å’Œ<code>.data</code>éƒ¨åˆ†ï¼Œ<code>.data</code>éƒ¨åˆ†åˆå¹¶å’Œä½ç½®å¯ä»¥æ˜¯ æŒ‡å®šå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><strong>Listing 8. Multiple sections in linker scripts</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">         . = 0x00000000;</span><br><span class="line">         .text : &#123; * (.text); &#125;</span><br><span class="line"></span><br><span class="line">         . = 0x00000400;</span><br><span class="line">         .data : &#123; * (.data); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œï¼Œ<code>.text</code>éƒ¨åˆ†ä½äº at<code>0x0</code>å’Œ<code>.data</code>ä½äº<code>0x400</code>ã€‚è¯·æ³¨æ„ï¼Œ<strong>å¦‚æœä½ç½®è®¡æ•°å™¨<code>.</code>æ²¡æœ‰æ‰‹åŠ¨åˆ†é…å€¼ï¼Œ<code>.text</code> å’Œ<code>.data</code>éƒ¨åˆ†å°†ä½äºç›¸é‚»çš„å†…å­˜ä½ç½®</strong>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Here, the `.text` section is located at `0x0` and `.data` is located at `0x400`.</span><br><span class="line">Note that, if the location counter is not assigned a different value,</span><br><span class="line">the `.text` and `.data` sections will be located at adjacent memory locations.</span><br></pre></td></tr></table></figure>

<h3 id="7-1-Linker-Script-Example"><a href="#7-1-Linker-Script-Example" class="headerlink" title="7.1. Linker Script Example"></a>7.1. Linker Script Example</h3><p>To demonstrate the use of linker scripts, we will use the linker script shown in <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/lds.html#linker1">Listing 8, â€œMultiple sections in linker scriptsâ€</a> to control the placement of a programâ€™s <code>.text</code> and <code>.data</code> section. We will use a slightly modified version of the sum of array program for this purpose. The code is shown below.</p>
<p>ä¸ºäº†æ¼”ç¤ºé“¾æ¥å™¨è„šæœ¬çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/lds.html#linker1"><strong>Listing 8. Multiple sections in linker scripts</strong></a>ä¸­çš„é“¾æ¥å™¨è„šæœ¬æ¥æ§åˆ¶çš„ç¨‹åº<code>.text</code>å’Œ<code>.data</code> éƒ¨åˆ†ã€‚æˆ‘ä»¬å°†ä½¿ç”¨<a href="#4.1.-Sum-an-Array">sum of array</a>çš„ç¨å¾®ä¿®æ”¹çš„ç‰ˆæœ¬ ç”¨äºæ­¤ç›®çš„çš„æ•°ç»„ç¨‹åºã€‚ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">        .data</span><br><span class="line">arr:    .byte 10, 20, 25        @ Read-only array of bytes</span><br><span class="line">eoa:                            @ Address of end of array + 1</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =eoa          @ r0 = &amp;eoa</span><br><span class="line">        ldr   r1, =arr          @ r1 = &amp;arr</span><br><span class="line">        mov   r3, #0            @ r3 = 0</span><br><span class="line">loop:   ldrb  r2, [r1], #1      @ r2 = *r1++</span><br><span class="line">        add   r3, r2, r3        @ r3 += r2</span><br><span class="line">        cmp   r1, r0            @ if (r1 != r2)</span><br><span class="line">        bne   loop              @    goto loop</span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå”¯ä¸€çš„å˜åŒ–æ˜¯æ•°ç»„ç°åœ¨ä½äº <code>.data</code> æ®µã€‚è¿˜è¦æ³¨æ„ï¼Œè·³è¿‡æ•°æ®çš„åˆ†æ”¯æŒ‡ä»¤ä¹Ÿä¸å†éœ€è¦äº†ï¼Œå› ä¸ºé“¾æ¥è„šæœ¬ä¼šé€‚å½“åœ°æ”¾ç½® <code>.text</code> æ®µå’Œ <code>.data</code> æ®µã€‚å› æ­¤ï¼Œè¯­å¥å¯ä»¥ä»¥ä»»ä½•æ–¹ä¾¿çš„æ–¹å¼æ”¾ç½®åœ¨ç¨‹åºä¸­ï¼Œé“¾æ¥è„šæœ¬å°†è´Ÿè´£å°†å„ä¸ªæ®µæ­£ç¡®æ”¾ç½®åœ¨å†…å­˜ä¸­ã€‚</p>
<blockquote>
<p>The only change here is that the array is now in the <code>.data</code> section. Also note that the nasty branch instruction to skip over the data is also not required, since the linker script will place the <code>.text</code> section and <code>.data</code> section appropriately. As a result, statements can be placed in the program, in any convenient way, and the linker script will take care of placing the sections correctly in memory.</p>
</blockquote>
<p>é“¾æ¥ç¨‹åºæ—¶ï¼Œé“¾æ¥å™¨è„šæœ¬ä½œä¸ºè¾“å…¥å‚æ•°ä¼ é€’ç»™é“¾æ¥å™¨ï¼Œå¦‚ä»¥ä¸‹å‘½ä»¤æ‰€ç¤ºã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-as -o sum-data.o sum-data.s</span><br><span class="line">$ arm-linux-gnueabihf-ld -T sum-data.lds -o sum-data.elf sum-data.o</span><br></pre></td></tr></table></figure>

<p>é€‰é¡¹ <code>-T sum-data.lds</code> æŒ‡å®šä½¿ç”¨ <code>sum-data.lds</code> ä½œä¸ºé“¾æ¥è„šæœ¬ã€‚Dump ç¬¦å·è¡¨å°†æœ‰åŠ©äºäº†è§£å„ä¸ªæ®µæ˜¯å¦‚ä½•æ”¾ç½®åœ¨å†…å­˜ä¸­çš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm -n sum-data.elf</span><br><span class="line">00000000 t start</span><br><span class="line">0000000c t loop</span><br><span class="line">0000001c t stop</span><br><span class="line">00000400 d arr</span><br><span class="line">00000403 d eoa</span><br></pre></td></tr></table></figure>

<p>ä»ç¬¦å·è¡¨ä¸­å¯ä»¥æ˜æ˜¾çœ‹å‡ºï¼Œ<code>.text</code> æ®µä»åœ°å€ <code>0x0</code> å¼€å§‹æ”¾ç½®ï¼Œ<code>.data</code> æ®µä»åœ°å€ <code>0x400</code> å¼€å§‹æ”¾ç½®ã€‚</p>
<h2 id="8-Data-in-RAM-Example"><a href="#8-Data-in-RAM-Example" class="headerlink" title="8. Data in RAM, Example"></a>8. Data in RAM, Example</h2><p>ç°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº†å¦‚ä½•ç¼–å†™é“¾æ¥è„šæœ¬ï¼Œæˆ‘ä»¬å°†å°è¯•ç¼–å†™ä¸€ä¸ªç¨‹åºï¼Œå¹¶å°† <code>.data</code> æ®µæ”¾ç½®åœ¨ RAM ä¸­ã€‚</p>
<p>åŠ æ³•ç¨‹åºç»è¿‡ä¿®æ”¹ï¼Œå°†ä» RAM ä¸­åŠ è½½ä¸¤ä¸ªå€¼ï¼Œå°†å®ƒä»¬ç›¸åŠ å¹¶å°†ç»“æœå­˜å‚¨å› RAMã€‚è¿™ä¸¤ä¸ªå€¼ä»¥åŠå­˜æ”¾ç»“æœçš„ç©ºé—´è¢«æ”¾ç½®åœ¨ <code>.data</code> æ®µä¸­ã€‚</p>
<p><strong>Listing 9. Add Data in RAM</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">        .data</span><br><span class="line">val1:   .4byte 10               @ First number</span><br><span class="line">val2:   .4byte 30               @ Second number</span><br><span class="line">result: .4byte 0                @ 4 byte space for result</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">        .align</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =val1         @ r0 = &amp;val1</span><br><span class="line">        ldr   r1, =val2         @ r1 = &amp;val2</span><br><span class="line"></span><br><span class="line">        ldr   r2, [r0]          @ r2 = *r0</span><br><span class="line">        ldr   r3, [r1]          @ r3 = *r1</span><br><span class="line"></span><br><span class="line">        add   r4, r2, r3        @ r4 = r2 + r3</span><br><span class="line"></span><br><span class="line">        ldr   r0, =result       @ r0 = &amp;result</span><br><span class="line">        str   r4, [r0]          @ *r0 = r4</span><br><span class="line"></span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure>

<p>å½“ç¨‹åºè¢«é“¾æ¥æ—¶ï¼Œä½¿ç”¨å¦‚ä¸‹æ‰€ç¤ºçš„é“¾æ¥è„šæœ¬ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123; * (.text); &#125;</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        .data : &#123; * (.data); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>.elf</code> æ–‡ä»¶çš„ç¬¦å·è¡¨å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm -n add-mem.elf</span><br><span class="line">00000000 t start</span><br><span class="line">0000001c t stop</span><br><span class="line">a0000000 d val1</span><br><span class="line">a0000001 d val2</span><br><span class="line">a0000002 d result</span><br></pre></td></tr></table></figure>

<p>é“¾æ¥è„šæœ¬ä¼¼ä¹å·²ç»è§£å†³äº†å°† <code>.data</code> æ®µæ”¾ç½®åœ¨ RAM ä¸­çš„é—®é¢˜ã€‚ä½†ç­‰ç­‰ï¼Œè§£å†³æ–¹æ¡ˆè¿˜æ²¡æœ‰å®Œå…¨å®Œæˆï¼</p>
<blockquote>
<p>é—®ï¼šä¸ºä»€ä¹ˆè¯´è¿™é‡Œæ˜¯å°† <code>.data</code> æ”¾ç½®åœ¨äº† RAMï¼Ÿ</p>
<p>ç­”ï¼šçœ‹ä¸Šé¢ <a href="#5.-Using-RAM">5. Using RAM</a> çš„ä»‹ç»ï¼Œè¿™é‡Œç”¨çš„ qemu æ¨¡æ‹Ÿçš„å¹³å° Connex æ¿ï¼Œå…·æœ‰ 64 MB çš„ RAMï¼Œä»åœ°å€ <code>0xA0000000</code> å¼€å§‹ã€‚</p>
</blockquote>
<h3 id="8-1-RAM-is-Volatile"><a href="#8-1-RAM-is-Volatile" class="headerlink" title="8.1. RAM is Volatile!"></a>8.1. RAM is Volatile!</h3><p>RAM æ˜¯æ˜“å¤±æ€§å­˜å‚¨å™¨ï¼Œå› æ­¤åœ¨ä¸Šç”µæ—¶æ— æ³•ç›´æ¥ä½¿æ•°æ®åœ¨ RAM ä¸­å¯ç”¨ã€‚</p>
<p>æ‰€æœ‰ä»£ç å’Œæ•°æ®åœ¨ä¸Šç”µå‰<strong>å¿…é¡»</strong>å­˜å‚¨åœ¨ Flash ä¸­ã€‚ä¸Šç”µåï¼Œå¯åŠ¨ä»£ç ä¼šå°†æ•°æ®ä» Flash å¤åˆ¶åˆ° RAMï¼Œç„¶åç»§ç»­æ‰§è¡Œç¨‹åºã€‚å› æ­¤ï¼Œç¨‹åºçš„ <code>.data</code> æ®µæœ‰ä¸¤ä¸ªåœ°å€ï¼Œä¸€ä¸ªæ˜¯ Flash ä¸­çš„<strong>åŠ è½½åœ°å€</strong>ï¼Œå¦ä¸€ä¸ªæ˜¯ RAM ä¸­çš„<strong>è¿è¡Œæ—¶åœ°å€</strong>ã€‚</p>
<blockquote>
<p>ğŸ’¡TIP</p>
<p>åœ¨ <code>ld</code> çš„æœ¯è¯­ä¸­ï¼ŒåŠ è½½åœ°å€ç§°ä¸º LMAï¼ˆ<strong>åŠ è½½å†…å­˜åœ°å€</strong>ï¼ŒLoad Memory Addressï¼‰ï¼Œ<strong>è¿è¡Œæ—¶åœ°å€</strong>ç§°ä¸º VMAï¼ˆè™šæ‹Ÿå†…å­˜åœ°å€ï¼ŒVirtual Memory Addressï¼‰ã€‚</p>
</blockquote>
<p>è¦ä½¿ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œéœ€è¦è¿›è¡Œä»¥ä¸‹ä¸¤é¡¹ä¿®æ”¹ï¼š</p>
<ol>
<li>å¿…é¡»ä¿®æ”¹é“¾æ¥è„šæœ¬ï¼Œä¸º <code>.data</code> æ®µæŒ‡å®šåŠ è½½åœ°å€å’Œè¿è¡Œæ—¶åœ°å€ã€‚</li>
<li>éœ€è¦ä¸€å°æ®µä»£ç å°† <code>.data</code> æ®µä» Flashï¼ˆåŠ è½½åœ°å€ï¼‰å¤åˆ¶åˆ° RAMï¼ˆè¿è¡Œæ—¶åœ°å€ï¼‰ã€‚</li>
</ol>
<h3 id="8-2-Specifying-Load-Address"><a href="#8-2-Specifying-Load-Address" class="headerlink" title="8.2. Specifying Load Address"></a>8.2. Specifying Load Address</h3><p>è¿è¡Œæ—¶åœ°å€åº”ç”¨äºç¡®å®šæ ‡ç­¾çš„åœ°å€ã€‚åœ¨ä¹‹å‰çš„é“¾æ¥è„šæœ¬ä¸­ï¼Œæˆ‘ä»¬ä¸º <code>.data</code> æ®µæŒ‡å®šäº†è¿è¡Œæ—¶åœ°å€ã€‚<strong>åŠ è½½åœ°å€æ²¡æœ‰æ˜ç¡®æŒ‡å®šï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸è¿è¡Œæ—¶åœ°å€ç›¸åŒ</strong>ã€‚åœ¨ä¹‹å‰çš„ç¤ºä¾‹ä¸­è¿™æ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºç¨‹åºæ˜¯ç›´æ¥ä» Flash ä¸­æ‰§è¡Œçš„ã€‚ä½†å¦‚æœåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦å°†æ•°æ®æ”¾å…¥ RAMï¼ŒåŠ è½½åœ°å€åº”å¯¹åº” Flashï¼Œè€Œè¿è¡Œæ—¶åœ°å€åº”å¯¹åº” RAMã€‚</p>
<p>å¯ä»¥ä½¿ç”¨ <code>AT</code> å…³é”®å­—æŒ‡å®šä¸åŒäºè¿è¡Œæ—¶åœ°å€çš„<strong>åŠ è½½åœ°å€</strong>ã€‚ä¿®æ”¹åçš„é“¾æ¥è„šæœ¬å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123; * (.text); &#125;</span><br><span class="line">        etext = .; â¶</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        .data : AT (etext) &#123; * (.data); &#125; â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li><p>å¯ä»¥é€šè¿‡åœ¨ <code>SECTIONS</code> å‘½ä»¤ä¸­åŠ¨æ€åˆ›å»ºç¬¦å·ï¼Œå¹¶ç»™å®ƒä»¬èµ‹å€¼ã€‚è¿™é‡Œï¼Œ<code>etext</code> è¢«èµ‹äºˆå½“å‰ä½ç½®è®¡æ•°å™¨çš„å€¼ï¼Œ<code>etext</code> åŒ…å«äº†ä»£ç æ®µç»“æŸååœ¨ Flash ä¸­çš„ä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®çš„åœ°å€ã€‚ç¨åå°†ä½¿ç”¨è¿™ä¸ªç¬¦å·æ¥æŒ‡å®š <code>.data</code> æ®µåœ¨ Flash ä¸­çš„æ”¾ç½®ä½ç½®ã€‚è¯·æ³¨æ„ï¼Œ<code>etext</code> æœ¬èº«ä¸ä¼šåˆ†é…ä»»ä½•å†…å­˜ï¼Œå®ƒåªæ˜¯ç¬¦å·è¡¨ä¸­çš„ä¸€ä¸ªæ¡ç›®ã€‚</p>
<blockquote>
<p><strong>AT æŒ‡å®šçš„æ˜¯åŠ è½½åœ°å€</strong>ã€‚è¿™é‡Œ <code>. = 0xA0000000;</code> åé¢ç´§è·Ÿ <code>.data</code> å°±è¡¨ç¤ºäº† <code>.data</code> çš„è¿è¡Œåœ°å€æ˜¯ <code>0xA0000000</code></p>
</blockquote>
</li>
<li><p><code>AT</code> å…³é”®å­—ç”¨äºæŒ‡å®š <code>.data</code> æ®µçš„<strong>åŠ è½½åœ°å€</strong>ã€‚å¯ä»¥å°†ä¸€ä¸ªåœ°å€æˆ–ç¬¦å·ï¼ˆå…¶å€¼ä¸ºæœ‰æ•ˆåœ°å€ï¼‰ä½œä¸º <code>AT</code> çš„å‚æ•°ä¼ é€’ã€‚è¿™é‡Œï¼Œ<code>.data</code> æ®µçš„åŠ è½½åœ°å€è¢«æŒ‡å®šä¸º Flash ä¸­æ‰€æœ‰ä»£ç ç»“æŸåçš„ä½ç½®ã€‚</p>
</li>
</ol>
<h3 id="8-3-Copying-data-to-RAM"><a href="#8-3-Copying-data-to-RAM" class="headerlink" title="8.3. Copying .data to RAM"></a>8.3. Copying <code>.data</code> to RAM</h3><p>è¦å°†æ•°æ®ä» Flash å¤åˆ¶åˆ° RAMï¼Œéœ€è¦ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
<ol>
<li>Flash ä¸­æ•°æ®çš„åœ°å€ (<code>flash_sdata</code>)</li>
<li>RAM ä¸­æ•°æ®çš„åœ°å€ (<code>ram_sdata</code>)</li>
<li><code>.data</code> æ®µçš„å¤§å° (<code>data_size</code>)</li>
</ol>
<p>æœ‰äº†è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ç‰‡æ®µå°†æ•°æ®ä» Flash å¤åˆ¶åˆ° RAMã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        ldr   r0, =flash_sdata</span><br><span class="line">        ldr   r1, =ram_sdata</span><br><span class="line">        ldr   r2, =data_size</span><br><span class="line"></span><br><span class="line">copy:</span><br><span class="line">        ldrb  r4, [r0], #1      @ r4 = *(r0++);</span><br><span class="line">        strb  r4, [r1], #1      @ *(r1++) = r4;</span><br><span class="line">        subs  r2, r2, #1        @ r2 -= 1; if r2 &gt; 0</span><br><span class="line">        bne   copy              @    goto copy;</span><br></pre></td></tr></table></figure>

<p>é“¾æ¥è„šæœ¬å¯ä»¥ç¨ä½œä¿®æ”¹ï¼Œä»¥æä¾›è¿™äº›ä¿¡æ¯ã€‚</p>
<p><strong>Listing 10. Linker Script with Section Copy Symbols</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123;</span><br><span class="line">              * (.text);</span><br><span class="line">        &#125;</span><br><span class="line">        flash_sdata = .; â¶</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        ram_sdata = .; â·</span><br><span class="line">        .data : AT (flash_sdata) &#123;</span><br><span class="line">              * (.data);</span><br><span class="line">        &#125;;</span><br><span class="line">        ram_edata = .; â¸</span><br><span class="line">        data_size = ram_edata - ram_sdata; â¹</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ°å€ä¿¡æ¯é€šè¿‡åœ¨é“¾æ¥è„šæœ¬ä¸­ï¼Œåˆ›å»ºç¬¦å·ï¼Œè¿™äº›ç¬¦å·ä¹Ÿä¼šè®°å½•åœ¨ç¬¦å·è¡¨ä¸­ï¼Œå› æ­¤ç¨‹åºå¯ä»¥æ‹¿åˆ°åœ°å€ä¿¡æ¯ã€‚</p>
<ol>
<li><code>.data</code> èŠ‚åœ¨ Flash ä¸­çš„èµ·å§‹ä½ç½®æ˜¯åœ¨æ‰€æœ‰ <code>.text</code> èŠ‚å†…å®¹ä¹‹åã€‚</li>
<li>è®°å½• RAM ä¸­ <code>data</code> çš„èµ·å§‹ä½ç½®ã€‚</li>
<li>è·å–æ•°æ®å¤§å°å¹¶ä¸æ˜¯ç›´æ¥çš„ã€‚æ•°æ®å¤§å°æ˜¯é€šè¿‡ RAM ä¸­æ•°æ®èµ·å§‹ä½ç½®å’Œæ•°æ®ç»“æŸä½ç½®ä¹‹é—´çš„å·®å€¼æ¥è®¡ç®—çš„ã€‚æ˜¯çš„ï¼Œ<strong>é“¾æ¥è„šæœ¬ä¸­å…è®¸ä½¿ç”¨ç®€å•çš„è¡¨è¾¾å¼</strong>ã€‚</li>
</ol>
<p>å°†æ•°æ®ä» Flash å¤åˆ¶åˆ° RAM çš„åŠ æ³•ç¨‹åºå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<p><strong>Listing 11. Add Data in RAM (with copy)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">        .data</span><br><span class="line">val1:   .4byte 10               @ First number</span><br><span class="line">val2:   .4byte 30               @ Second number</span><br><span class="line">result: .space 4                @ 1 byte space for result</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line"></span><br><span class="line">        ;; Copy data to RAM.</span><br><span class="line">start:</span><br><span class="line">        ldr   r0, =flash_sdata</span><br><span class="line">        ldr   r1, =ram_sdata</span><br><span class="line">        ldr   r2, =data_size</span><br><span class="line"></span><br><span class="line">copy:</span><br><span class="line">        ldrb  r4, [r0], #1      @ r4 = *(r0++);</span><br><span class="line">        strb  r4, [r1], #1      @ *(r1++) = r4;</span><br><span class="line">        subs  r2, r2, #1        @ r2 -= 1; if r2 &gt; 0</span><br><span class="line">        bne   copy              @    goto copy;</span><br><span class="line"></span><br><span class="line">        ;; Add and store result.</span><br><span class="line">        ldr   r0, =val1         @ r0 = &amp;val1</span><br><span class="line">        ldr   r1, =val2         @ r1 = &amp;val2</span><br><span class="line"></span><br><span class="line">        ldr   r2, [r0]          @ r2 = *r0</span><br><span class="line">        ldr   r3, [r1]          @ r3 = *r1</span><br><span class="line"></span><br><span class="line">        add   r4, r2, r3        @ r4 = r2 + r3</span><br><span class="line"></span><br><span class="line">        ldr   r0, =result       @ r0 = &amp;result</span><br><span class="line">        str   r4, [r0]          @ *r0 = r4</span><br><span class="line"></span><br><span class="line">stop:   b stop</span><br></pre></td></tr></table></figure>

<p>è¯¥ç¨‹åºä½¿ç”¨åœ¨ <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#linker2">Listing 10, â€œLinker Script with Section Copy Symbolsâ€</a> ä¸­åˆ—å‡ºçš„é“¾æ¥è„šæœ¬è¿›è¡Œäº†æ±‡ç¼–å’Œé“¾æ¥ã€‚ç¨‹åºåœ¨ Qemu ä¸­æ‰§è¡Œå’Œæµ‹è¯•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br><span class="line">(qemu) xp /4dw 0xA0000000</span><br><span class="line">a0000000:         10         30         40          0</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Note:</p>
<p>åœ¨å®é™…ç³»ç»Ÿä¸­ï¼Œä½¿ç”¨ SDRAM æ—¶ï¼Œå†…å­˜ä¸åº”ç«‹å³è®¿é—®ã€‚å¿…é¡»åœ¨æ‰§è¡Œå†…å­˜è®¿é—®ä¹‹å‰åˆå§‹åŒ–å†…å­˜æ§åˆ¶å™¨ã€‚æˆ‘ä»¬çš„ä»£ç ä¹‹æ‰€ä»¥èƒ½æ­£å¸¸å·¥ä½œï¼Œæ˜¯å› ä¸ºæ¨¡æ‹Ÿå†…å­˜ä¸éœ€è¦åˆå§‹åŒ–å†…å­˜æ§åˆ¶å™¨ã€‚</p>
</blockquote>
<h2 id="9-Exception-Handling"><a href="#9-Exception-Handling" class="headerlink" title="9. Exception Handling"></a>9. Exception Handling</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ç»™å‡ºçš„ç¤ºä¾‹å­˜åœ¨ä¸€ä¸ªä¸»è¦ç¼ºé™·ã€‚<strong>å†…å­˜æ˜ å°„ä¸­çš„å‰ 8 ä¸ªå­—<code>word</code>æ˜¯ä¸ºå¼‚å¸¸å‘é‡<code>exception vector</code>ä¿ç•™çš„</strong>ã€‚å½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œæ§åˆ¶æƒä¼šè½¬ç§»åˆ°è¿™ 8 ä¸ªä½ç½®ä¸­çš„ä¸€ä¸ªã€‚å¼‚å¸¸åŠå…¶å¼‚å¸¸å‘é‡åœ°å€å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p>
<p><strong>Table 1. Exception Vector Addresses</strong></p>
<table>
<thead>
<tr>
<th>Exception</th>
<th>Address</th>
</tr>
</thead>
<tbody><tr>
<td>Reset</td>
<td>0x00</td>
</tr>
<tr>
<td>Undefined Instruction</td>
<td>0x04</td>
</tr>
<tr>
<td>Software Interrupt (SWI)</td>
<td>0x08</td>
</tr>
<tr>
<td>Prefetch Abort</td>
<td>0x0C</td>
</tr>
<tr>
<td>Data Abort</td>
<td>0x10</td>
</tr>
<tr>
<td>Reserved, not used</td>
<td>0x14</td>
</tr>
<tr>
<td>IRQ</td>
<td>0x18</td>
</tr>
<tr>
<td>FIQ</td>
<td>0x1C</td>
</tr>
</tbody></table>
<p>è¿™äº›ä½ç½®åº”è¯¥åŒ…å«ä¸€ä¸ªåˆ†æ”¯ï¼Œç”¨äºè½¬ç§»æ§åˆ¶åˆ°é€‚å½“çš„å¼‚å¸¸å¤„ç†ç¨‹åºã€‚åœ¨æˆ‘ä»¬è¿„ä»Šä¸ºæ­¢çœ‹åˆ°çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰åœ¨å¼‚å¸¸å‘é‡åœ°å€æ’å…¥åˆ†æ”¯æŒ‡ä»¤ã€‚ç”±äºè¿™äº›å¼‚å¸¸å¹¶æœªå‘ç”Ÿï¼Œæˆ‘ä»¬æ²¡æœ‰é‡åˆ°é—®é¢˜ã€‚æ‰€æœ‰ä¸Šè¿°ç¨‹åºéƒ½å¯ä»¥é€šè¿‡å°†å®ƒä»¬ä¸ä»¥ä¸‹æ±‡ç¼–ä»£ç é“¾æ¥æ¥ä¿®å¤ã€‚</p>
<blockquote>
<p>å°±æ˜¯éœ€è¦åœ¨è¿™äº›ä½ç½®ï¼Œå¢åŠ è·³è½¬æŒ‡ä»¤ï¼Œè·³è½¬åˆ°å¯¹åº”çš„é”™è¯¯å¤„ç†ä»£ç ä½ç½®ã€‚</p>
<p>These locations are supposed to contain a branch that will transfer control the appropriate exception handler. In the examples we have seen so far, we havenâ€™t inserted branch instructions at the exception vector addresses. We got away without issues since these exceptions did not occur. All the above programs can be fixed, by linking them with the following assembly code.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        .section &quot;vectors&quot;</span><br><span class="line">reset:  b     start</span><br><span class="line">undef:  b     undef</span><br><span class="line">swi:    b     swi</span><br><span class="line">pabt:   b     pabt</span><br><span class="line">dabt:   b     dabt</span><br><span class="line">        nop</span><br><span class="line">irq:    b     irq</span><br><span class="line">fiq:    b     fiq</span><br></pre></td></tr></table></figure>

<p>åªæœ‰å¤ä½å¼‚å¸¸è¢«å‘é‡åˆ°ä¸åŒçš„åœ°å€ <code>start</code>ã€‚æ‰€æœ‰å…¶ä»–å¼‚å¸¸éƒ½è¢«å‘é‡åˆ°ç›¸åŒçš„åœ°å€ã€‚<strong>å› æ­¤ï¼Œå¦‚æœå‘ç”Ÿå¤ä½ä»¥å¤–çš„ä»»ä½•å¼‚å¸¸ï¼Œå¤„ç†å™¨å°†ä¼šåœ¨åŒä¸€ä½ç½®å¾ªç¯</strong>ã€‚ç„¶åï¼Œ<strong>å¯ä»¥é€šè¿‡è°ƒè¯•å™¨ï¼ˆåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­æ˜¯ç›‘è§†å™¨æ¥å£ï¼‰æŸ¥çœ‹ <code>pc</code> çš„å€¼æ¥è¯†åˆ«è¯¥å¼‚å¸¸</strong>ã€‚</p>
<p>ä¸ºäº†ç¡®ä¿è¿™äº›æŒ‡ä»¤è¢«æ”¾ç½®åœ¨å¼‚å¸¸å‘é‡åœ°å€ï¼Œé“¾æ¥å™¨è„šæœ¬åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123;</span><br><span class="line">                * (vectors); @ ä¸Šé¢å£°æ˜çš„ section</span><br><span class="line">                * (.text);</span><br><span class="line">                ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„åˆ° <code>vectors</code> éƒ¨åˆ†è¢«æ”¾ç½®åœ¨æ‰€æœ‰å…¶ä»–ä»£ç ä¹‹å‰ï¼Œç¡®ä¿ <code>vectors</code> ä½äºä» 0x0 å¼€å§‹çš„åœ°å€ã€‚</p>
<h2 id="10-C-Startup"><a href="#10-C-Startup" class="headerlink" title="10. C Startup"></a>10. C Startup</h2><p>åœ¨å¤„ç†å™¨å¤ä½åï¼Œæ— æ³•ç›´æ¥æ‰§è¡Œ C ä»£ç ï¼Œå› ä¸ºä¸æ±‡ç¼–è¯­è¨€ä¸åŒï¼ŒC ç¨‹åºéœ€è¦æ»¡è¶³ä¸€äº›åŸºæœ¬çš„å‰ææ¡ä»¶ã€‚æœ¬èŠ‚å°†æè¿°è¿™äº›å‰ææ¡ä»¶ä»¥åŠå¦‚ä½•æ»¡è¶³å®ƒä»¬ã€‚</p>
<p>æˆ‘ä»¬å°†ä»¥è®¡ç®—æ•°ç»„å’Œçš„ C ç¨‹åºä¸ºä¾‹ã€‚åœ¨æœ¬èŠ‚ç»“æŸæ—¶ï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿè¿›è¡Œå¿…è¦çš„è®¾ç½®ï¼Œå°†æ§åˆ¶æƒè½¬ç§»åˆ° C ä»£ç å¹¶æ‰§è¡Œå®ƒã€‚</p>
<p><strong>Listing 12. Sum of Array in C</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">static int arr[] = &#123; 1, 10, 4, 5, 6, 7 &#125;;</span><br><span class="line">static int sum;</span><br><span class="line">static const int n = sizeof(arr) / sizeof(arr[0]);</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">        int i;</span><br><span class="line"></span><br><span class="line">        for (i = 0; i &lt; n; i++)</span><br><span class="line">                sum += arr[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å°†æ§åˆ¶æƒè½¬ç§»åˆ° C ä»£ç ä¹‹å‰ï¼Œå¿…é¡»æ­£ç¡®è®¾ç½®ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li>æ ˆ</li>
<li>å…¨å±€å˜é‡<ol>
<li>å·²åˆå§‹åŒ–çš„</li>
<li>æœªåˆå§‹åŒ–çš„</li>
</ol>
</li>
<li>åªè¯»æ•°æ®</li>
</ol>
<h3 id="10-1-Stack"><a href="#10-1-Stack" class="headerlink" title="10.1. Stack"></a>10.1. Stack</h3><p>C ä½¿ç”¨æ ˆæ¥å­˜å‚¨å±€éƒ¨ï¼ˆè‡ªåŠ¨ï¼‰å˜é‡ã€ä¼ é€’å‡½æ•°å‚æ•°ã€å­˜å‚¨è¿”å›åœ°å€ç­‰ã€‚å› æ­¤ï¼Œåœ¨å°†æ§åˆ¶æƒè½¬ç§»åˆ° C ä»£ç ä¹‹å‰ï¼Œç¡®ä¿æ ˆæ­£ç¡®è®¾ç½®è‡³å…³é‡è¦ã€‚</p>
<p>åœ¨ ARM æ¶æ„ä¸­ï¼Œæ ˆéå¸¸çµæ´»ï¼Œå› ä¸ºå…¶å®ç°å®Œå…¨ä¾èµ–äºè½¯ä»¶ã€‚å¯¹äºä¸ç†Ÿæ‚‰ ARM æ¶æ„çš„äººï¼Œé™„å½• C ä¸­æä¾›äº†æ¦‚è¿° <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/arm-stacks.html"><em>ARM Stacks</em></a>ã€‚</p>
<p>ä¸ºäº†ç¡®ä¿ä¸åŒç¼–è¯‘å™¨ç”Ÿæˆçš„ä»£ç èƒ½å¤Ÿäº’æ“ä½œï¼ŒARM åˆ¶å®šäº† <a target="_blank" rel="noopener" href="http://infocenter.arm.com/help/topic/com.arm.doc.ihi0042a/IHI0042A_aapcs.pdf">ARM æ¶æ„è¿‡ç¨‹è°ƒç”¨æ ‡å‡† (AAPCS)</a>ã€‚è¦ä½¿ç”¨çš„æ ˆæŒ‡é’ˆå¯„å­˜å™¨ä»¥åŠæ ˆçš„å¢é•¿æ–¹å‘å‡ç”± AAPCS è§„å®šã€‚æ ¹æ® AAPCSï¼Œ<strong>å¯„å­˜å™¨ <code>r13</code></strong> åº”ç”¨ä½œæ ˆæŒ‡é’ˆã€‚åŒæ—¶ï¼Œæ ˆåº”ä¸º <strong>å…¨é€’å‡</strong>ï¼ˆfull-descendingï¼‰ã€‚</p>
<p>ä»¥ä¸‹å›¾ç¤ºå±•ç¤ºäº†å…¨å±€å˜é‡å’Œæ ˆçš„æ”¾ç½®æ–¹å¼ã€‚</p>
<p><strong>Figure 5. Stack Placement</strong></p>
<p><img src="/../images/GNUToolchain/stack.png" alt="stack.png"></p>
<p>å› æ­¤ï¼Œ<strong>åœ¨å¯åŠ¨ä»£ç ä¸­éœ€è¦åšçš„å°±æ˜¯å°† <code>r13</code> æŒ‡å‘æœ€é«˜çš„ RAM åœ°å€</strong>ï¼Œä»¥ä¾¿æ ˆå¯ä»¥å‘ä¸‹å¢é•¿ï¼ˆæœå‘è¾ƒä½çš„åœ°å€ï¼‰ã€‚å¯¹äº <code>connex</code> æ¿ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ ARM æŒ‡ä»¤æ¥å®ç°è¿™ä¸€ç‚¹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldr sp, =0xA4000000</span><br></pre></td></tr></table></figure>

<p>è¯·æ³¨æ„ï¼Œæ±‡ç¼–å™¨ä¸º <code>r13</code> å¯„å­˜å™¨æä¾›äº†ä¸€ä¸ªåˆ«å <code>sp</code>ã€‚ï¼ˆStack pointer ?ï¼‰</p>
<blockquote>
<p>Note</p>
<p>åœ°å€ <code>0xA4000000</code> æœ¬èº«å¹¶ä¸å¯¹åº”äº RAMã€‚RAM çš„ç»“æŸåœ°å€æ˜¯ <code>0xA3FFFFFF</code>ã€‚ä½†è¿™æ²¡å…³ç³»ï¼Œå› ä¸ºæ ˆæ˜¯ <strong>å…¨é€’å‡</strong>ï¼ˆfull-descendingï¼‰çš„ï¼Œåœ¨ç¬¬ä¸€æ¬¡å‹æ ˆæ—¶ï¼Œæ ˆæŒ‡é’ˆä¼šå…ˆè¢«é€’å‡ï¼Œç„¶åå­˜å‚¨å€¼ã€‚</p>
</blockquote>
<h3 id="10-2-Global-Variables"><a href="#10-2-Global-Variables" class="headerlink" title="10.2. Global Variables"></a>10.2. Global Variables</h3><p>å½“ C ä»£ç è¢«ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨å°†å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡æ”¾ç½®åœ¨ <code>.data</code> æ®µä¸­ã€‚å› æ­¤ï¼Œåƒæ±‡ç¼–ä¸€æ ·ï¼Œ<code>.data</code> æ®µå¿…é¡»ä» Flash å¤åˆ¶åˆ° RAMã€‚</p>
<p>C è¯­è¨€ä¿è¯<strong>æ‰€æœ‰æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡å°†è¢«åˆå§‹åŒ–ä¸ºé›¶</strong>ã€‚å½“ C ç¨‹åºè¢«ç¼–è¯‘æ—¶ï¼Œ<strong>æœªåˆå§‹åŒ–å˜é‡ä½¿ç”¨ä¸€ä¸ªç§°ä¸º <code>.bss</code> çš„å•ç‹¬æ®µ</strong>ã€‚ç”±äºè¿™äº›å˜é‡çš„åˆå§‹å€¼éƒ½æ˜¯é›¶ï¼Œå› æ­¤ä¸å¿…å°†å®ƒä»¬å­˜å‚¨åœ¨ Flash ä¸­ã€‚åœ¨å°†æ§åˆ¶æƒè½¬ç§»åˆ° C ä»£ç ä¹‹å‰ï¼Œå¿…é¡»å°†å¯¹åº”äºè¿™äº›å˜é‡çš„å†…å­˜ä½ç½®åˆå§‹åŒ–ä¸ºé›¶ã€‚</p>
<h3 id="10-3-Read-only-Data"><a href="#10-3-Read-only-Data" class="headerlink" title="10.3. Read-only Data"></a>10.3. Read-only Data</h3><p>GCC å°†æ ‡è®°ä¸º <code>const</code> çš„å…¨å±€å˜é‡æ”¾ç½®åœ¨ä¸€ä¸ªç§°ä¸º <code>.rodata</code> çš„å•ç‹¬æ®µä¸­ã€‚<code>.rodata</code> ä¹Ÿç”¨äºå­˜å‚¨å­—ç¬¦ä¸²å¸¸é‡ã€‚</p>
<p>ç”±äº <code>.rodata</code> æ®µçš„å†…å®¹ä¸ä¼šè¢«ä¿®æ”¹ï¼Œå› æ­¤å¯ä»¥å°†å…¶æ”¾ç½®åœ¨ Flash ä¸­ã€‚é“¾æ¥å™¨è„šæœ¬å¿…é¡»è¿›è¡Œä¿®æ”¹ä»¥é€‚åº”è¿™ä¸€ç‚¹ã€‚</p>
<h3 id="10-4-Startup-Code"><a href="#10-4-Startup-Code" class="headerlink" title="10.4. Startup Code"></a>10.4. Startup Code</h3><p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†å‰ææ¡ä»¶ï¼Œå¯ä»¥åˆ›å»ºé“¾æ¥å™¨è„šæœ¬å’Œå¯åŠ¨ä»£ç ã€‚é“¾æ¥å™¨è„šæœ¬ <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/data-in-ram.html#linker2">Listing 10, â€œLinker Script with Section Copy Symbolsâ€</a> è¢«ä¿®æ”¹ä»¥é€‚åº”ä»¥ä¸‹å†…å®¹ï¼š</p>
<ol>
<li><code>.bss</code> æ®µçš„æ”¾ç½®</li>
<li><code>vectors</code> æ®µçš„æ”¾ç½®</li>
<li><code>.rodata</code> æ®µçš„æ”¾ç½®</li>
</ol>
<p><code>.bss</code> è¢«æ”¾ç½®åœ¨ RAM ä¸­çš„ <code>.data</code> æ®µä¹‹åã€‚é“¾æ¥å™¨è„šæœ¬ä¸­è¿˜åˆ›å»ºäº†ç”¨äºå®šä½ <code>.bss</code> çš„å¼€å§‹å’Œç»“æŸç¬¦å·ã€‚<code>.rodata</code> è¢«æ”¾ç½®åœ¨ Flash ä¸­çš„ <code>.text</code> æ®µä¹‹åã€‚ä»¥ä¸‹å›¾ç¤ºæ˜¾ç¤ºäº†å„ä¸ªæ®µçš„æ”¾ç½®ä½ç½®ã€‚</p>
<p><strong>Figure 6. Section Placement</strong></p>
<p><img src="/../images/GNUToolchain/csections.png" alt="csections.png"></p>
<p><strong>Listing 13. Linker Script for C code</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS &#123;</span><br><span class="line">        . = 0x00000000;</span><br><span class="line">        .text : &#123;</span><br><span class="line">              * (vectors); # å¼‚å¸¸å‘é‡</span><br><span class="line">              * (.text);</span><br><span class="line">        &#125;</span><br><span class="line">        .rodata : &#123; # åªè¯»æ•°æ®</span><br><span class="line">              * (.rodata);</span><br><span class="line">        &#125;</span><br><span class="line">        flash_sdata = .; # è®°å½• .data çš„åŠ è½½åœ°å€ï¼ˆflashåç§»ï¼‰</span><br><span class="line"></span><br><span class="line">        . = 0xA0000000;</span><br><span class="line">        ram_sdata = .;</span><br><span class="line">        .data : AT (flash_sdata) &#123;</span><br><span class="line">              * (.data);</span><br><span class="line">        &#125;</span><br><span class="line">        ram_edata = .;</span><br><span class="line">        data_size = ram_edata - ram_sdata;</span><br><span class="line"></span><br><span class="line">        sbss = .; # data ä¹‹åï¼Œæ˜¯ .bss çš„èµ·å§‹åœ°å€ï¼Œ.bss æ²¡æœ‰æŒ‡å®šåŠ è½½åœ°å€ï¼Œå› ä¸ºå°±ä¸å­˜å‚¨åœ¨flashä¸­</span><br><span class="line">        .bss : &#123;</span><br><span class="line">             * (.bss);</span><br><span class="line">        &#125;</span><br><span class="line">        ebss = .;</span><br><span class="line">        bss_size = ebss - sbss;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The startup code has the following parts</p>
<ol>
<li>exception vectors</li>
<li>code to copy the <code>.data</code> from Flash to RAM</li>
<li>code to zero out the <code>.bss</code></li>
<li>code to setup the stack pointer</li>
<li>branch to main</li>
</ol>
<p><strong>Listing 14. C Startup Assembly</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">        .section &quot;vectors&quot;</span><br><span class="line">reset:  b     start</span><br><span class="line">undef:  b     undef</span><br><span class="line">swi:    b     swi</span><br><span class="line">pabt:   b     pabt</span><br><span class="line">dabt:   b     dabt</span><br><span class="line">        nop</span><br><span class="line">irq:    b     irq</span><br><span class="line">fiq:    b     fiq</span><br><span class="line"></span><br><span class="line">        .text</span><br><span class="line">start:</span><br><span class="line">        @@ Copy data to RAM.</span><br><span class="line">        ldr   r0, =flash_sdata</span><br><span class="line">        ldr   r1, =ram_sdata</span><br><span class="line">        ldr   r2, =data_size</span><br><span class="line"></span><br><span class="line">        @@ Handle data_size == 0 @ data å¤§å°ä¸º0ï¼Œå°±ä¸éœ€è¦ç»§ç»­åˆå§‹åŒ–ï¼Œç›´æ¥è·³è½¬åˆ°åé¢å¤„ç†</span><br><span class="line">        cmp   r2, #0</span><br><span class="line">        beq   init_bss      @ æ³¨æ„ beq, bne éƒ½æ˜¯è·³è½¬æŒ‡ä»¤ï¼Œä¸ºçœŸçš„æ¡ä»¶ä¸åŒ if == , if !=</span><br><span class="line">copy:</span><br><span class="line">        ldrb   r4, [r0], #1</span><br><span class="line">        strb   r4, [r1], #1</span><br><span class="line">        subs   r2, r2, #1</span><br><span class="line">        bne    copy</span><br><span class="line"></span><br><span class="line">init_bss:</span><br><span class="line">        @@ Initialize .bss</span><br><span class="line">        ldr   r0, =sbss</span><br><span class="line">        ldr   r1, =ebss</span><br><span class="line">        ldr   r2, =bss_size</span><br><span class="line"></span><br><span class="line">        @@ Handle bss_size == 0  @ bss å¤§å°ä¸º0ï¼Œå°±ä¸éœ€è¦ç»§ç»­åˆå§‹åŒ–ï¼Œç›´æ¥è·³è½¬åˆ°åé¢å¤„ç†</span><br><span class="line">        cmp   r2, #0</span><br><span class="line">        beq   init_stack</span><br><span class="line"></span><br><span class="line">        mov   r4, #0</span><br><span class="line">zero:</span><br><span class="line">        strb  r4, [r0], #1</span><br><span class="line">        subs  r2, r2, #1</span><br><span class="line">        bne   zero</span><br><span class="line"></span><br><span class="line">init_stack:</span><br><span class="line">        @@ Initialize the stack pointer</span><br><span class="line">        ldr   sp, =0xA4000000</span><br><span class="line"></span><br><span class="line">        bl    main</span><br><span class="line"></span><br><span class="line">stop:   b     stop</span><br></pre></td></tr></table></figure>

<p>è¦ç¼–è¯‘ä»£ç ï¼Œä¸å¿…å•ç‹¬è°ƒç”¨æ±‡ç¼–å™¨ã€ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ã€‚<code>gcc</code> è¶³å¤Ÿæ™ºèƒ½ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬å®Œæˆè¿™äº›å·¥ä½œã€‚</p>
<p>å¦‚ä¹‹å‰æ‰€æ‰¿è¯ºçš„ï¼Œæˆ‘ä»¬å°†ç¼–è¯‘å¹¶æ‰§è¡Œ <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-startup.html#csum">Listing 12, â€œSum of Array in Câ€</a> ä¸­æ˜¾ç¤ºçš„ C ä»£ç ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-gcc -nostdlib -o csum.elf -T csum.lds csum.c startup.s</span><br></pre></td></tr></table></figure>

<p><code>-nostdlib</code> é€‰é¡¹ç”¨äºæŒ‡å®šä¸é“¾æ¥æ ‡å‡† C åº“ã€‚å½“é“¾æ¥ C åº“æ—¶éœ€è¦é¢å¤–å°å¿ƒã€‚æœ‰å…³æ­¤å†…å®¹çš„è®¨è®ºï¼Œè¯·å‚è§ <a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-library.html">Section 11, â€œUsing the C Libraryâ€</a>ã€‚</p>
<p>ç¬¦å·è¡¨çš„ dump å°†æ›´æ¸…æ¥šåœ°å±•ç¤ºå„ä¸ªéƒ¨åˆ†åœ¨å†…å­˜ä¸­çš„æ”¾ç½®æƒ…å†µã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-nm -n csum.elf</span><br><span class="line">00000000 t reset        â¶</span><br><span class="line">00000004 A bss_size</span><br><span class="line">00000004 t undef</span><br><span class="line">00000008 t swi</span><br><span class="line">0000000c t pabt</span><br><span class="line">00000010 t dabt</span><br><span class="line">00000018 A data_size</span><br><span class="line">00000018 t irq</span><br><span class="line">0000001c t fiq</span><br><span class="line">00000020 T main</span><br><span class="line">00000090 t start        â·</span><br><span class="line">000000a0 t copy</span><br><span class="line">000000b0 t init_bss</span><br><span class="line">000000c4 t zero</span><br><span class="line">000000d0 t init_stack</span><br><span class="line">000000d8 t stop</span><br><span class="line">000000f4 r n            â¸</span><br><span class="line">000000f8 A flash_sdata</span><br><span class="line">a0000000 d arr          â¹</span><br><span class="line">a0000000 A ram_sdata</span><br><span class="line">a0000018 A ram_edata</span><br><span class="line">a0000018 A sbss</span><br><span class="line">a0000018 b sum          âº</span><br><span class="line">a000001c A ebss</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th><a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-1">â¶</a></th>
<th><code>reset</code> and the rest of the exception vectors are placed starting from <code>0x0</code>.</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-2">â·</a></td>
<td>The assembly code is placed right after the 8 exception vectors (<code>8 * 4 = 32 = 0x20</code>).</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-3">â¸</a></td>
<td>The read-only data <code>n</code>, is placed in Flash after the code.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-4">â¹</a></td>
<td>The initialized data <code>arr</code>, an array of 6 integers, is placed at the start of RAM <code>0xA0000000</code>.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://www.bravegnu.org/gnu-eprog/c-startup.html#CO6-5">âº</a></td>
<td>The uninitialized data <code>sum</code> is placed after the array of 6 integers. (<code>6 * 4 = 24 = 0x18</code>)</td>
</tr>
</tbody></table>
<p>è¦æ‰§è¡Œç¨‹åºï¼Œè¯·å°†ç¨‹åºè½¬æ¢ä¸º <code>.bin</code> æ ¼å¼ï¼Œåœ¨ Qemu ä¸­æ‰§è¡Œï¼Œç„¶åæŸ¥çœ‹ä½äº <code>0xA0000018</code> çš„ <code>sum</code> å˜é‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ arm-linux-gnueabihf-objcopy -O binary csum.elf csum.bin</span><br><span class="line">$ dd if=csum.bin of=flash.bin bs=4096 conv=notrunc</span><br><span class="line">$ qemu-system-arm -M connex -pflash flash.bin -nographic -serial /dev/null</span><br><span class="line">(qemu) xp /6dw 0xa0000000</span><br><span class="line">a0000000:          1         10          4          5</span><br><span class="line">a0000010:          6          7</span><br><span class="line">(qemu) xp /1dw 0xa0000018</span><br><span class="line">a0000018:         33</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://yo-gurts.github.io">(à¸‡'Ì€-'Ì)à¸‡</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://yo-gurts.github.io/2024/10/17/GNUToolchain/">https://yo-gurts.github.io/2024/10/17/GNUToolchain/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://yo-gurts.github.io" target="_blank">(â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”» </a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/arm/">arm</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹"><img class="cover" src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">ä¸Šä¸€ç¯‡</div><div class="prev_info">Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹</div></div></a></div></nav><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/09/17/3NdhvxIcPRVpufD.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">(à¸‡'Ì€-'Ì)à¸‡</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yo-gurts"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yo-gurts" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:yusong1117.u@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Introduction"><span class="toc-number">1.</span> <span class="toc-text">1. Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Setting-up-the-ARM-Lab"><span class="toc-number">2.</span> <span class="toc-text">2. Setting up the ARM Lab</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-Qemu-ARM"><span class="toc-number">2.1.</span> <span class="toc-text">2.1. Qemu ARM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-Installing-Qemu-in-Debian"><span class="toc-number">2.2.</span> <span class="toc-text">2.2. Installing Qemu in Debian</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-Installing-GNU-Toolchain-for-ARM"><span class="toc-number">2.3.</span> <span class="toc-text">2.3. Installing GNU Toolchain for ARM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Hello-ARM"><span class="toc-number">3.</span> <span class="toc-text">3. Hello ARM</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Building-the-Binary"><span class="toc-number">3.1.</span> <span class="toc-text">3.1. Building the Binary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Executing-in-Qemu"><span class="toc-number">3.2.</span> <span class="toc-text">3.2. Executing in Qemu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-More-Monitor-Commands"><span class="toc-number">3.3.</span> <span class="toc-text">3.3. More Monitor Commands</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-More-Assembler-Directives"><span class="toc-number">4.</span> <span class="toc-text">4. More Assembler Directives</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-Sum-an-Array"><span class="toc-number">4.1.</span> <span class="toc-text">4.1. Sum an Array</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-1-byte-Directive"><span class="toc-number">4.1.1.</span> <span class="toc-text">4.1.1. .byte Directive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-2-align-Directive"><span class="toc-number">4.1.2.</span> <span class="toc-text">4.1.2. .align Directive</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-String-Length"><span class="toc-number">4.2.</span> <span class="toc-text">4.2. String Length</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-1-asciz-Directive"><span class="toc-number">4.2.1.</span> <span class="toc-text">4.2.1. .asciz Directive</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-2-equ-Directive"><span class="toc-number">4.2.2.</span> <span class="toc-text">4.2.2. .equ Directive</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Using-RAM"><span class="toc-number">5.</span> <span class="toc-text">5. Using RAM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Linker"><span class="toc-number">6.</span> <span class="toc-text">6. Linker</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-Symbol-Resolution"><span class="toc-number">6.1.</span> <span class="toc-text">6.1. Symbol Resolution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-Relocation"><span class="toc-number">6.2.</span> <span class="toc-text">6.2. Relocation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-1-Section-Merging"><span class="toc-number">6.2.1.</span> <span class="toc-text">6.2.1. Section Merging</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2-2-Section-Placement"><span class="toc-number">6.2.2.</span> <span class="toc-text">6.2.2. Section Placement</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Linker-Script-File"><span class="toc-number">7.</span> <span class="toc-text">7. Linker Script File</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-Linker-Script-Example"><span class="toc-number">7.1.</span> <span class="toc-text">7.1. Linker Script Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Data-in-RAM-Example"><span class="toc-number">8.</span> <span class="toc-text">8. Data in RAM, Example</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-RAM-is-Volatile"><span class="toc-number">8.1.</span> <span class="toc-text">8.1. RAM is Volatile!</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-Specifying-Load-Address"><span class="toc-number">8.2.</span> <span class="toc-text">8.2. Specifying Load Address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-Copying-data-to-RAM"><span class="toc-number">8.3.</span> <span class="toc-text">8.3. Copying .data to RAM</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Exception-Handling"><span class="toc-number">9.</span> <span class="toc-text">9. Exception Handling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-C-Startup"><span class="toc-number">10.</span> <span class="toc-text">10. C Startup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#10-1-Stack"><span class="toc-number">10.1.</span> <span class="toc-text">10.1. Stack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-2-Global-Variables"><span class="toc-number">10.2.</span> <span class="toc-text">10.2. Global Variables</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-3-Read-only-Data"><span class="toc-number">10.3.</span> <span class="toc-text">10.3. Read-only Data</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10-4-Startup-Code"><span class="toc-number">10.4.</span> <span class="toc-text">10.4. Startup Code</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>æœ€æ–°æ–‡ç« </span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/17/GNUToolchain/" title="Embedded Programming with the GNU Toolchain"><img src="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Embedded Programming with the GNU Toolchain"/></a><div class="content"><a class="title" href="/2024/10/17/GNUToolchain/" title="Embedded Programming with the GNU Toolchain">Embedded Programming with the GNU Toolchain</a><time datetime="2024-10-17T14:00:06.000Z" title="å‘è¡¨äº 2024-10-17 22:00:06">2024-10-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹"><img src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹"/></a><div class="content"><a class="title" href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹">Cvitek-v4.2.0 ç¼–è¯‘æµç¨‹</a><time datetime="2024-10-09T14:25:10.000Z" title="å‘è¡¨äº 2024-10-09 22:25:10">2024-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK ç¼–è¯‘ç¯å¢ƒ"><img src="https://s2.loli.net/2022/11/17/UeWP8jCq6dJZSGD.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cvitek SDK ç¼–è¯‘ç¯å¢ƒ"/></a><div class="content"><a class="title" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK ç¼–è¯‘ç¯å¢ƒ">Cvitek SDK ç¼–è¯‘ç¯å¢ƒ</a><time datetime="2024-10-06T06:02:04.000Z" title="å‘è¡¨äº 2024-10-06 14:02:04">2024-10-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/24/Linux-sysfs/" title="Linux sysfs"><img src="https://s2.loli.net/2022/11/17/9ZBEesyr14aJhPM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux sysfs"/></a><div class="content"><a class="title" href="/2024/09/24/Linux-sysfs/" title="Linux sysfs">Linux sysfs</a><time datetime="2024-09-24T14:37:59.000Z" title="å‘è¡¨äº 2024-09-24 22:37:59">2024-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs"><img src="https://s2.loli.net/2022/11/17/9ZBEesyr14aJhPM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux USB functionfs"/></a><div class="content"><a class="title" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs">Linux USB functionfs</a><time datetime="2024-09-22T14:31:05.000Z" title="å‘è¡¨äº 2024-09-22 22:31:05">2024-09-22</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By (à¸‡'Ì€-'Ì)à¸‡</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æµ…è‰²å’Œæ·±è‰²æ¨¡å¼è½¬æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="ç›´è¾¾è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'b740056c42e9eadf273e',
      clientSecret: 'e5f185fa9a6e27927f7a2672469435c68a288c95',
      repo: 'Yo-gurts.github.io',
      owner: 'yo-gurts',
      admin: ['yo-gurts'],
      id: '265f6cd0e163445b62f7b54dfd12559f',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">æœç´¢</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åº“åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>