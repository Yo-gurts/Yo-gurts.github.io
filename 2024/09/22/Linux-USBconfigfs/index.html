<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Linux USB gadget_configfs | (╯°□°）╯︵ ┻━┻ </title><meta name="author" content="(ง'̀-'́)ง"><meta name="copyright" content="(ง'̀-'́)ง"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Linux USB gadget 通过 configfs 配置  先阅读 Linux configfs，再看此内容  usb 只有在作为从设备时，才会用到 configfs 去配置功能。 更新日期：2013年4月25日 概述USB Linux Gadget 是一种设备，它具有一个 UDC（USB 设"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yo-gurts.github.io/2024/09/22/Linux-USBconfigfs/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":600},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Linux USB gadget_configfs',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-09-22 21:44:34'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 6 || hour >= 18
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="google-site-verification" content="MP347_Nl-SqfnOi3FZSI69WSb8J_rk_jEsa3jL4ODCI" /><meta name="generator" content="Hexo 6.1.0"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://s2.loli.net/2024/09/17/3NdhvxIcPRVpufD.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="(╯°□°）╯︵ ┻━┻ "><span class="site-name">(╯°□°）╯︵ ┻━┻ </span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Linux USB gadget_configfs</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-22T13:44:30.000Z" title="发表于 2024-09-22 21:44:30">2024-09-22</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-09-22T13:44:34.000Z" title="更新于 2024-09-22 21:44:34">2024-09-22</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/USB/">USB</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">5.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>26分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Linux USB gadget_configfs"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/09/22/Linux-USBconfigfs/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="Linux-USB-gadget-通过-configfs-配置"><a href="#Linux-USB-gadget-通过-configfs-配置" class="headerlink" title="Linux USB gadget 通过 configfs 配置"></a>Linux USB gadget 通过 configfs 配置</h2><ul>
<li><input disabled="" type="checkbox"> 先阅读 <a href="Linux-configfs.md">Linux configfs</a>，再看此内容</li>
</ul>
<p>usb 只有在作为从设备时，才会用到 configfs 去配置功能。</p>
<p>更新日期：2013年4月25日</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>USB Linux Gadget 是一种设备，它具有一个 UDC（USB 设备控制器），并且可以连接到 USB 主机，通过添加功能扩展主机，如串行端口或大容量存储功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A USB Linux Gadget is a device which has a UDC (USB Device Controller)</span><br><span class="line">and can be connected to a USB Host to extend it with additional functions</span><br><span class="line">like a serial port or a mass storage capability.</span><br></pre></td></tr></table></figure>

<p>从主机的角度来看，<strong>一个 Gadget 是一组配置的集合</strong>，<strong>每个配置包含若干接口，而从 Gadget 的角度看，这些接口被称为功能（function），每个功能代表一个如串行连接或 SCSI 磁盘的设备</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">A gadget is seen by its host as a set of configurations, each of which</span><br><span class="line">contains a number of interfaces which, from the gadget&#x27;s perspective,</span><br><span class="line">are known as functions, each function representing e.g. a serial</span><br><span class="line">connection or a SCSI disk.</span><br></pre></td></tr></table></figure>

<p>Linux 提供了许多功能供 Gadget 使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Linux provides a number of functions for gadgets to use.</span><br></pre></td></tr></table></figure>

<p><strong>创建一个 Gadget 意味着决定将有哪些配置，以及每个配置将提供哪些功能</strong>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Creating a gadget means deciding what configurations there will be and which</span><br><span class="line">functions each configuration will provide.</span><br></pre></td></tr></table></figure>

<p>Configfs（请参见 <code>Documentation/filesystems/configfs.rst</code>）非常适合用于向内核传达上述决策。本文档讨论了如何实现这一目标。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Configfs (please see `Documentation/filesystems/configfs.rst`) lends itself</span><br><span class="line">nicely for the purpose of telling the kernel about the above mentioned decision.</span><br><span class="line">This document is about how to do it.</span><br></pre></td></tr></table></figure>

<p>它还描述了 Gadget 中的 configfs 集成设计。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">It also describes how configfs integration into gadget is designed.</span><br></pre></td></tr></table></figure>

<h2 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h2><p>为了使其工作，configfs 必须可用，因此 .config 中的 <code>CONFIGFS_FS</code> 必须为 ‘y’ 或 ‘m’。截至本文写作时，<code>USB_LIBCOMPOSITE</code> 选择了 <code>CONFIGFS_FS</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In order for this to work configfs must be available, so CONFIGFS_FS must be &#x27;y&#x27;</span><br><span class="line">or &#x27;m&#x27; in .config. As of this writing USB_LIBCOMPOSITE selects CONFIGFS_FS.</span><br></pre></td></tr></table></figure>

<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>（描述第一个通过 configfs 提供的功能的原始帖子可以在这里看到：<a target="_blank" rel="noopener" href="http://www.spinics.net/lists/linux-usb/msg76388.html%EF%BC%89">http://www.spinics.net/lists/linux-usb/msg76388.html）</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(The original post describing the first function made available through configfs</span><br><span class="line">can be seen here: http://www.spinics.net/lists/linux-usb/msg76388.html)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe libcomposite</span><br><span class="line">$ mount none <span class="variable">$CONFIGFS_HOME</span> -t configfs</span><br></pre></td></tr></table></figure>

<p>其中 CONFIGFS_HOME 是 configfs 的挂载点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where CONFIGFS_HOME is the mount point for configfs</span><br></pre></td></tr></table></figure>

<h3 id="1-创建-Gadgets"><a href="#1-创建-Gadgets" class="headerlink" title="1. 创建 Gadgets"></a>1. 创建 Gadgets</h3><p>为每个要创建的 Gadget 创建相应的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="variable">$CONFIGFS_HOME</span>/usb_gadget/&lt;gadget name&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">For each gadget to be created its corresponding directory must be created:</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="variable">$CONFIGFS_HOME</span>/usb_gadget/g1</span><br></pre></td></tr></table></figure>

<p>进入对应的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="variable">$CONFIGFS_HOME</span>/usb_gadget/g1</span><br></pre></td></tr></table></figure>

<p>每个 Gadget 需要指定其供应商 ID（VID）和产品 ID（PID）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;VID&gt; &gt; idVendor</span><br><span class="line">$ <span class="built_in">echo</span> &lt;PID&gt; &gt; idProduct</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Each gadget needs to have its vendor id &lt;VID&gt; and product id &lt;PID&gt; specified:</span><br></pre></td></tr></table></figure>

<p>一个 Gadget 还需要其序列号、制造商和产品字符串。为了存储它们，需要为每种语言创建一个字符串子目录，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">A gadget also needs its serial number, manufacturer and product strings. In order</span><br><span class="line">to have a place to store them, a strings subdirectory must be created for each language,</span><br><span class="line">e.g.:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> strings/0x409</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/brookebasile/USB-langids/blob/master/USB%20Lang%20IDs%20-%20Language%20Identifiers.csv">usb language IDS</a> or <a target="_blank" rel="noopener" href="http://www.baiheee.com/Documents/090518/090518112619/USB_LANGIDs.pdf">http://www.baiheee.com/Documents/090518/090518112619/USB_LANGIDs.pdf</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0x0404	Chinese (Taiwan)</span><br><span class="line">0x0804	Chinese (PRC)</span><br><span class="line">0x0c04	Chinese (Hong Kong SAR, PRC)</span><br><span class="line">0x1004	Chinese (Singapore)</span><br><span class="line">0x1404	Chinese (Macau SAR)</span><br><span class="line">0x0409	English (United States)</span><br><span class="line">0x0809	English (United Kingdom)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>然后可以指定字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Then the strings can be specified:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;serial number&gt; &gt; strings/0x409/serialnumber</span><br><span class="line">$ <span class="built_in">echo</span> &lt;manufacturer&gt; &gt; strings/0x409/manufacturer</span><br><span class="line">$ <span class="built_in">echo</span> &lt;product&gt; &gt; strings/0x409/product</span><br></pre></td></tr></table></figure>

<h3 id="2-创建配置"><a href="#2-创建配置" class="headerlink" title="2. 创建配置"></a>2. 创建配置</h3><p>每个 Gadget 将包含若干配置，需要创建相应的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> configs/&lt;name&gt;.&lt;number&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Each gadget will consist of a number of configurations, their corresponding directories must be created:</span><br></pre></td></tr></table></figure>

<p>其中 <code>&lt;name&gt;</code> 可以是文件系统中合法的任意字符串，<code>&lt;number&gt;</code> 是配置的编号，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> configs/c.1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where &lt;name&gt; can be any string which is legal in a filesystem and the &lt;number&gt; is the configuration&#x27;s number, e.g.:</span><br></pre></td></tr></table></figure>

<p>每个配置也需要其字符串，因此需要为每种语言创建一个子目录，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> configs/c.1/strings/0x409</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Each configuration also needs its strings, so a subdirectory must be created for</span><br><span class="line">each language, e.g.:</span><br></pre></td></tr></table></figure>

<p>然后可以指定配置字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;configuration&gt; &gt; configs/c.1/strings/0x409/configuration</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Then the configuration string can be specified:</span><br></pre></td></tr></table></figure>

<p>还可以为配置设置一些属性，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 120 &gt; configs/c.1/MaxPower</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Some attributes can also be set for a configuration, e.g.:</span><br></pre></td></tr></table></figure>

<h3 id="3-创建功能"><a href="#3-创建功能" class="headerlink" title="3. 创建功能"></a>3. 创建功能</h3><p>Gadget 将提供一些功能，为每个功能创建相应的目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="built_in">functions</span>/&lt;name&gt;.&lt;instance name&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The gadget will provide some functions, for each function its corresponding</span><br><span class="line">directory must be created:</span><br></pre></td></tr></table></figure>

<p><strong>其中 <code>&lt;name&gt;</code> 对应于允许的功能名称之一</strong>，实例名称是文件系统中允许的任意字符串，例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> <span class="built_in">functions</span>/ncm.usb0 <span class="comment"># usb_f_ncm.ko gets loaded with request_module()</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">where &lt;name&gt; corresponds to one of allowed function names and instance name is</span><br><span class="line">an arbitrary string allowed in a filesystem, e.g.:</span><br></pre></td></tr></table></figure>

<p>每个功能提供其特定的一组属性，具有只读或读写访问权限。在适用的情况下，需要适当写入它们。请参阅 <code>Documentation/ABI/*/configfs-usb-gadget*</code> 了解更多信息。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Each function provides its specific set of attributes, with either read-only or</span><br><span class="line">read-write access. Where applicable they need to be written to as appropriate.</span><br><span class="line">Please refer to Documentation/ABI/*/configfs-usb-gadget* for more information.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>💥💥💥💥💥💥 <a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing">Documentation&#x2F;ABI&#x2F;*&#x2F;configfs-usb-gadget</a> <strong>这里有对每个文件的详细介绍</strong>。</p>
</blockquote>
<h3 id="4-将功能与配置关联"><a href="#4-将功能与配置关联" class="headerlink" title="4. 将功能与配置关联"></a>4. 将功能与配置关联</h3><p>此时创建了若干 Gadget，每个 Gadget 都指定了若干配置，并且有若干可用功能。剩下的就是指定哪个功能在哪个配置中可用（同一功能可以在多个配置中使用）。这可以通过创建符号链接来实现：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ln</span> -s <span class="built_in">functions</span>/&lt;name&gt;.&lt;instance name&gt; configs/&lt;name&gt;.&lt;number&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">At this moment a number of gadgets is created, each of which has a number of configurations specified and a number of functions available. What remains is specifying which function is available in which configuration (the same function can be used in multiple configurations). This is achieved with creating symbolic links:</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">ln</span> -s <span class="built_in">functions</span>/ncm.usb0 configs/c.1</span><br></pre></td></tr></table></figure>

<h3 id="5-启用-Gadget"><a href="#5-启用-Gadget" class="headerlink" title="5. 启用 Gadget"></a>5. 启用 Gadget</h3><p>以上所有步骤的目的是将 Gadget 组成配置和功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">All the above steps serve the purpose of composing the gadget of configurations and functions.</span><br></pre></td></tr></table></figure>

<p>一个示例目录结构可能如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">An example directory structure might look like this:</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">./strings</span><br><span class="line">./strings/0x409</span><br><span class="line">./strings/0x409/serialnumber</span><br><span class="line">./strings/0x409/product</span><br><span class="line">./strings/0x409/manufacturer</span><br><span class="line">./configs</span><br><span class="line">./configs/c.1</span><br><span class="line">./configs/c.1/ncm.usb0 -&gt; ../../../../usb_gadget/g1/functions/ncm.usb0</span><br><span class="line">./configs/c.1/strings</span><br><span class="line">./configs/c.1/strings/0x409</span><br><span class="line">./configs/c.1/strings/0x409/configuration</span><br><span class="line">./configs/c.1/bmAttributes</span><br><span class="line">./configs/c.1/MaxPower</span><br><span class="line">./functions</span><br><span class="line">./functions/ncm.usb0</span><br><span class="line">./functions/ncm.usb0/ifname</span><br><span class="line">./functions/ncm.usb0/qmult</span><br><span class="line">./functions/ncm.usb0/host_addr</span><br><span class="line">./functions/ncm.usb0/dev_addr</span><br><span class="line">./UDC</span><br><span class="line">./bcdUSB</span><br><span class="line">./bcdDevice</span><br><span class="line">./idProduct</span><br><span class="line">./idVendor</span><br><span class="line">./bMaxPacketSize0</span><br><span class="line">./bDeviceProtocol</span><br><span class="line">./bDeviceSubClass</span><br><span class="line">./bDeviceClass</span><br></pre></td></tr></table></figure>

<p>这样的 Gadget 必须最终启用，以便 USB 主机可以枚举它。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Such a gadget must be finally enabled so that the USB host can enumerate it.</span><br></pre></td></tr></table></figure>

<p>为了启用 Gadget，必须将其绑定到 UDC（USB 设备控制器）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> &lt;udc name&gt; &gt; UDC</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In order to enable the gadget it must be bound to a UDC (USB Device Controller):</span><br></pre></td></tr></table></figure>

<p>其中 <code>&lt;udc name&gt;</code> 是在 <code>/sys/class/udc/*</code> 中找到的一个名称，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where &lt;udc name&gt; is one of those found in /sys/class/udc/* e.g.:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> s3c-hsotg &gt; UDC</span><br></pre></td></tr></table></figure>

<h3 id="6-禁用-Gadget"><a href="#6-禁用-Gadget" class="headerlink" title="6. 禁用 Gadget"></a>6. 禁用 Gadget</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;&quot;</span> &gt; UDC</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ echo &quot;&quot; &gt; UDC</span><br></pre></td></tr></table></figure>

<h3 id="7-清理"><a href="#7-清理" class="headerlink" title="7. 清理"></a>7. 清理</h3><p>从配置中删除功能：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove functions from configurations:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> configs/&lt;config name&gt;.&lt;number&gt;/&lt;<span class="keyword">function</span>&gt;</span><br></pre></td></tr></table></figure>

<p>其中 <code>&lt;config name&gt;.&lt;number&gt;</code> 指定配置，<code>&lt;function&gt;</code> 是要从配置中删除的功能的符号链接，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">where &lt;config name&gt;.&lt;number&gt; specify the configuration and &lt;function&gt; is a</span><br><span class="line">symlink to a function being removed from the configuration, e.g.:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> configs/c.1/ncm.usb0</span><br></pre></td></tr></table></figure>

<p>删除配置中的字符串目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove strings directories in configurations:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/&lt;config name&gt;.&lt;number&gt;/strings/&lt;lang&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/c.1/strings/0x409</span><br></pre></td></tr></table></figure>

<p>然后删除配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and remove the configurations:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/&lt;config name&gt;.&lt;number&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> configs/c.1</span><br></pre></td></tr></table></figure>

<p>删除功能（功能模块不会被卸载）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove functions (function modules are not unloaded, though):</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> <span class="built_in">functions</span>/&lt;name&gt;.&lt;instance name&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> <span class="built_in">functions</span>/ncm.usb0</span><br></pre></td></tr></table></figure>

<p>删除 Gadget 中的字符串目录：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove strings directories in the gadget:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> strings/&lt;lang&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> strings/0x409</span><br></pre></td></tr></table></figure>

<p>最后删除 Gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and finally remove the gadget:</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ..</span><br><span class="line">$ <span class="built_in">rmdir</span> &lt;gadget name&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rmdir</span> g1</span><br></pre></td></tr></table></figure>

<h2 id="实现设计"><a href="#实现设计" class="headerlink" title="实现设计"></a>实现设计</h2><blockquote>
<p><a href="Linux-configfs.md">linux configfs</a></p>
</blockquote>
<p>下面展示了 configfs 的工作原理。💥💥💥💥<strong>在 configfs 中，有项目<code>item</code>和组<code>group</code>，均表示为目录。项目和组的区别在于组可以包含其他组</strong>💥💥💥。下图仅显示了一个项目。项目和组都可以有属性，这些属性表示为文件。用户可以创建和删除目录，但不能删除文件，这些文件可以是只读或读写的，具体取决于它们表示的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Below the idea of how configfs works is presented. In configfs there are items and groups,</span><br><span class="line">both represented as directories. The difference between an item and a group is</span><br><span class="line">that a group can contain other groups. In the picture below only an item is shown.</span><br><span class="line">Both items and groups can have attributes, which are represented as files.</span><br><span class="line">The user can create and remove directories, but cannot remove files, which can</span><br><span class="line">be read-only or read-write, depending on what they represent.</span><br></pre></td></tr></table></figure>

<p>configfs 文件系统部分操作 config_items&#x2F;groups 和 configfs_attributes，它们是通用且对所有配置元素类型相同的。然而，它们嵌入在特定用途的更大结构中。下图中有一个 “cs” 包含一个 config_item，还有一个 “sa” 包含一个 configfs_attribute。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">The filesystem part of configfs operates on config_items/groups and</span><br><span class="line">configfs_attributes which are generic and of the same type for all configured elements.</span><br><span class="line">However, they are embedded in usage-specific larger structures. In the picture</span><br><span class="line">below there is a &quot;cs&quot; which contains a config_item and an &quot;sa&quot;</span><br><span class="line">which contains a configfs_attribute.</span><br></pre></td></tr></table></figure>

<p>文件系统视图如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The filesystem view would be like this:</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">./cs        (directory)</span><br><span class="line">   |</span><br><span class="line">   +--sa    (file)</span><br><span class="line">   |</span><br><span class="line">   .</span><br><span class="line">   .</span><br><span class="line">   .</span><br></pre></td></tr></table></figure>

<p>每当用户读取&#x2F;写入 “sa” 文件时，会调用一个函数，该函数接收一个 struct config_item 和一个 struct configfs_attribute。在该函数中，使用已知的 container_of 技术检索 “cs” 和 “sa”，并调用适当的 sa 的函数（show 或 store），并传递 “cs” 和一个字符缓冲区。”show” 用于显示文件内容（将数据从 cs 复制到缓冲区），而 “store” 用于修改文件内容（将数据从缓冲区复制到 cs），但具体做什么取决于这两个函数的实现者。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Whenever a user reads/writes the &quot;sa&quot; file, a function is called which accepts</span><br><span class="line">a struct config_item and a struct configfs_attribute. In the said function the</span><br><span class="line">&quot;cs&quot; and &quot;sa&quot; are retrieved using the well known container_of technique and an</span><br><span class="line">appropriate sa&#x27;s function (show or store) is called and passed the &quot;cs&quot; and a</span><br><span class="line">character buffer. The &quot;show&quot; is for displaying the file&#x27;s contents (copy data</span><br><span class="line">from the cs to the buffer), while the &quot;store&quot; is for modifying the file&#x27;s</span><br><span class="line">contents (copy data from the buffer to the cs), but it is up to the implementer</span><br><span class="line">of the two functions to decide what they actually do.</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">typedef struct configured_structure cs;</span><br><span class="line">typedef struct specific_attribute sa;</span><br><span class="line"></span><br><span class="line">                                       sa</span><br><span class="line">                       +----------------------------------+</span><br><span class="line">        cs             |  (*show)(cs *, buffer);          |</span><br><span class="line">+-----------------+    |  (*store)(cs *, buffer, length); |</span><br><span class="line">|                 |    |                                  |</span><br><span class="line">| +-------------+ |    |       +------------------+       |</span><br><span class="line">| | struct      |-|----|------&gt;|struct            |       |</span><br><span class="line">| | config_item | |    |       |configfs_attribute|       |</span><br><span class="line">| +-------------+ |    |       +------------------+       |</span><br><span class="line">|                 |    +----------------------------------+</span><br><span class="line">| data to be set  |                .</span><br><span class="line">|                 |                .</span><br><span class="line">+-----------------+                .</span><br></pre></td></tr></table></figure>

<p>文件名由配置项&#x2F;组设计者决定，而目录通常可以随意命名。一个组可以自动创建其默认子组。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The file names are decided by the config item/group designer, while the directories</span><br><span class="line"> in general can be named at will. A group can have a number of its default</span><br><span class="line"> sub-groups created automatically.</span><br></pre></td></tr></table></figure>

<p>有关 configfs 的更多信息，请参见 <code>Documentation/filesystems/configfs.rst</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">For more information on configfs please see `Documentation/filesystems/configfs.rst`.</span><br></pre></td></tr></table></figure>

<p>上述概念在 USB gadgets 中的应用如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The concepts described above translate to USB gadgets like this:</span><br></pre></td></tr></table></figure>

<ol>
<li>一个 Gadget 有其配置组，具有一些属性（如 idVendor、idProduct 等）和默认子组（configs、functions、strings）。写入这些属性会将信息存储在适当的位置。在 configs、functions 和 strings 子组中，用户可以创建它们的子组来表示给定语言的配置、功能和字符串组。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. A gadget has its config group, which has some attributes (idVendor, idProduct etc)</span><br><span class="line"> and default sub-groups (configs, functions, strings). Writing to the attributes</span><br><span class="line"> causes the information to be stored in appropriate locations. In the configs,</span><br><span class="line"> functions and strings sub-groups a user can create their sub-groups to represent</span><br><span class="line"> configurations, functions, and groups of strings in a given language.</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>用户创建配置和功能，在配置中创建指向功能的符号链接。当 Gadget 的 UDC 属性被写入时，这些信息将被使用，这意味着将 Gadget 绑定到 UDC。drivers&#x2F;usb&#x2F;gadget&#x2F;configfs.c 中的代码遍历所有配置，在每个配置中遍历所有功能并绑定它们。这样整个 Gadget 就被绑定了。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2. The user creates configurations and functions, in the configurations creates</span><br><span class="line">symbolic links to functions. This information is used when the gadget&#x27;s UDC</span><br><span class="line">attribute is written to, which means binding the gadget to the UDC. The code in</span><br><span class="line">drivers/usb/gadget/configfs.c iterates over all configurations, and in each</span><br><span class="line">configuration it iterates over all functions and binds them.</span><br><span class="line">This way the whole gadget is bound.</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>drivers&#x2F;usb&#x2F;gadget&#x2F;configfs.c 文件包含以下代码：</li>
</ol>
<ul>
<li>Gadget 的 config_group</li>
<li>Gadget 的默认组（configs、functions、strings）</li>
<li>将功能与配置关联（符号链接）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">3. The file drivers/usb/gadget/configfs.c contains code for</span><br><span class="line"></span><br><span class="line">- gadget&#x27;s config_group</span><br><span class="line">- gadget&#x27;s default groups (configs, functions, strings)</span><br><span class="line">- associating functions with configurations (symlinks)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>每个 USB 功能自然有其希望配置的视图，因此在 functions 实现文件 drivers&#x2F;usb&#x2F;gadget&#x2F;f_*.c 中定义了特定功能的 config_groups。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4. Each USB function naturally has its own view of what it wants configured,</span><br><span class="line">so config_groups for particular functions are defined in the functions</span><br><span class="line">implementation files drivers/usb/gadget/f_*.c.</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>功能代码的编写方式是使用 usb_get_function_instance()，该函数反过来调用 request_module。因此，只要 modprobe 工作，特定功能的模块就会自动加载。请注意，反之则不然：在 Gadget 被禁用和拆除后，模块仍然保持加载状态。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">5. Function&#x27;s code is written in such a way that it uses usb_get_function_instance(),</span><br><span class="line">which, in turn, calls request_module. So, provided that modprobe works,</span><br><span class="line">modules for particular functions are loaded automatically. Please note that</span><br><span class="line">the converse is not true: after a gadget is disabled and torn down,</span><br><span class="line">the modules remain loaded.</span><br></pre></td></tr></table></figure>

<h2 id="useful-links"><a href="#useful-links" class="headerlink" title="useful links"></a>useful links</h2><p>一些开源仓库基于上面介绍的 usb configfs，USB Gadget API 等，搞了些 cool things.</p>
<blockquote>
<p>copy from <a target="_blank" rel="noopener" href="https://www.reddit.com/r/linux/comments/1annx0u/a_comprehensive_list_of_all_configfs_functionfs/?rdt=34774">https://www.reddit.com/r/linux/comments/1annx0u/a_comprehensive_list_of_all_configfs_functionfs/?rdt=34774</a></p>
<p><strong>A comprehensive list of all ConfigFS, FunctionFS, USB Gadget API, etc. tools and libraries on Github(*)</strong></p>
<p>Ok, so I’m writing a comprehensive list for all libraries, tools, modules, and scripts for any linux distro or kernel that I can find on Github, so I can learn more about how to make use of it.</p>
<h3 id="What-is-this"><a href="#What-is-this" class="headerlink" title="What is this?"></a>What is this?</h3><p>For those who don’t know what any of the above APIs are, they are the underlying APIs that power things like the MTP protocol that is associated with your mobile electronics, such as smartphone and digital cameras. The Media Transfer Protocol (MTP) is the protocol that allows host devices to <em>pretend</em> to be peripheral storage devices to other hosts. This is what makes it possible for your cell phone or digital camera to show up as a storage device on your PC, even though they are technically small computers.</p>
<p>You can read more about these APIs from the kernel docs:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://docs.kernel.org/driver-api/usb/gadget.html?highlight=gadgetfs">USB Gadget API for Linux — The Linux Kernel documentation</a></li>
</ul>
<h3 id="Why-is-this-cool"><a href="#Why-is-this-cool" class="headerlink" title="Why is this cool?"></a>Why is this cool?</h3><p>The really cool thing about these kernel APIs is that they can work at the USB protocol layer. Which means <em>any</em> USB device can be emulated by a linux machine any way you want. You are not limited to just the MTP protocol.</p>
<p>The reason I am exploring these tools is that I want to see exactly what kind of things I can do with this API. Something that has interested me about this API since I came across it was whether or not it could support hosting a <em>bootable</em> mass storage device. This could allow me to do something like providing Ventoy (or Medicat) over the Gadget API. I was thinking that I could build some kind of stack with this that would allow me to install an operating system dynamically on the host using live ISO, then once the OS has been installed provision it via Ansible over RNDIS without ever having to reboot the device doing the install. Basically, it would provide a method for a fully unattended bare metal install that could fit in your pocket.</p>
<h3 id="What’s-this-about-kernels-plural"><a href="#What’s-this-about-kernels-plural" class="headerlink" title="What’s this about kernels (plural)?"></a>What’s this about kernels (plural)?</h3><p>Note that earlier, in the first paragraph, I said any linux distro as well as any <em>kernel.</em> Since implementations of this API typically require USB OTG or USB Dual Role hardware, the kernel that is likely to have the most stable tools&#x2F;libraries is going to be the Android kernel. This is something to keep in mind when discussing these APIs.</p>
<h3 id="TL-DR-The-list"><a href="#TL-DR-The-list" class="headerlink" title="(TL;DR) The list"></a>(TL;DR) The list</h3><p>(*) - Most of these libraries are on Github, but it is worth-while to at least point out the Android Code Search</p>
<ul>
<li>(*) <a target="_blank" rel="noopener" href="https://cs.android.com/">Android Code Search</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/linux-usb-gadgets">linux-usb-gadgets</a> organization<ul>
<li>✨✨✨ <a target="_blank" rel="noopener" href="https://github.com/linux-usb-gadgets/libusbgx">libusbgx</a><ul>
<li>Seemingly really well rounded C library for linux for encapsulating the ConfigFS API. It also includes some bash tools for automatically creating and monitoring USB Gadgets</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/linux-usb-gadgets/gt">gt (Gadget-tool)</a><ul>
<li>A command line tool for setting USB gadgets with ConfigFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/linux-usb-gadgets/ptp-gadget">ptp-gadget</a><ul>
<li>An implementation of the PTP protocol (the predecessor for MTP) for Linux</li>
</ul>
</li>
<li>(old org&#x2F;repo) <a target="_blank" rel="noopener" href="https://github.com/libusbg/libusbg">libusbg&#x2F;libusbg</a><ul>
<li>the original version of libusbg</li>
</ul>
</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/litui/gadgeteer">litui&#x2F;gadgeteer</a><ul>
<li>A JSON daemon for controlling ConfigFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/luka177/mmc-to-usb">luka177&#x2F;mmc-to-usb</a><ul>
<li>Allows you to control an emmc storage device from another PC, including allowing you to partition it.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tylerwhall/configfs-regulator">tylerwhall&#x2F;configfs-regulator</a><ul>
<li>A ConfigFS-based Voltage Regulator Driver</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/kopasiak/simple_usb_chat">kopasiak&#x2F;simple_usb_chat</a><ul>
<li>A simple chat program over FunctionFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/jghubert/FunctionFSTester">jghubert&#x2F;FunctionFSTester</a><ul>
<li>A repository for testing FunctionFS features on both the remote host and peripheral device. Have been ignoring most of these kinds of repos, but added this one, since it included tests to be run on the remote host.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/vladrobot/Raspberry-GadgetFS/tree/master">vladrobot&#x2F;Raspberry-GadgetFS</a><ul>
<li>A wrapper for GadgetFS tailored to the raspberry pi that provides HID spoofing as well as USB mass storage via Python</li>
</ul>
</li>
<li>PTP&#x2F;MTP protocol<ul>
<li>linux-usb-gadgets&#x2F;ptp-gadget (see above)</li>
<li>✨✨ <a target="_blank" rel="noopener" href="https://github.com/viveris/uMTP-Responder">viveris&#x2F;uMTP-Responder</a><ul>
<li>An implementation of a MTP responder for Linux. README has a decent list of Single Board Computers with OTG&#x2F;Dual Role USB ports</li>
</ul>
</li>
</ul>
</li>
<li><em>Controller Emulators&#x2F;Adapters</em><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Poohl/gadfetfs-Switch-Fightstick">Poohl&#x2F;gadfetfs-Switch-Fightstick</a><ul>
<li>Wii Remote Emulator&#x2F;Adapter for the Nintendo Switch</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/dogtopus/ffsds4">dogtopus&#x2F;ffsds4</a><ul>
<li>A PS4 Controller Emulator over FunctionFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Frederic98/GadgetDeck">Frederic98&#x2F;GadgetDeck</a><ul>
<li>A controller emulator using a steam deck as a gadget device over ConfigFS</li>
</ul>
</li>
</ul>
</li>
<li><em>Android USB Tools</em><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/tejado/android-usb-gadget">tejado&#x2F;android-usb-gadget</a><ul>
<li>Rooted Android tool used to spoof what your phone appears as to your computer. Really good tool for visually showing you what the ConfigFS&#x2F;FunctionFS is capable of.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/tejado/Authorizer">tejado&#x2F;Authorizer</a><ul>
<li>Secure Password Store that can autotype passwords over FunctionFS</li>
</ul>
</li>
</ul>
</li>
<li><em>Hacking, Sniffing, and Security:</em><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/threadexio/anducky">threadexio&#x2F;anducky</a><ul>
<li>An implementation of Hak5’s Rubber Ducky on Android</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ehabhussein/AutoGadgetFS">ehabhussein&#x2F;AutoGadgetFS</a><ul>
<li>Very comprehensive USB security, sniffing, and analyzing tool that can be used to perform USB man-in-the-middle attacks built on ConfigFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/greatscottgadgets/Facedancer">greatscottgadgets&#x2F;Facedancer</a><ul>
<li>Another USB man-in-the-middle-ware built on GadgetFS</li>
<li><a target="_blank" rel="noopener" href="https://github.com/usb-tools/USBProxy-legacy">usb-tools&#x2F;USBProxy-legacy</a> (The original)</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Iskuri/Usb-Over-TCP">Iskuri&#x2F;Usb-Over-TCP</a><ul>
<li>A USB over TCP implementation built on GadgetFS</li>
</ul>
</li>
</ul>
</li>
<li><em>Simple HID Spoofing Scripts:</em><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/linkjumper/configfs">linkjumper&#x2F;configfs</a><ul>
<li>A simple shell script for creating a HID device via ConfigFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/qlyoung/keyboard-gadget">qlyoung&#x2F;keyboard-gadget</a><ul>
<li>Another simple shell script for creating a HID device via ConfigFS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/karacanil/linux-mouse-gadget">karacanil&#x2F;linux-mouse-gadget</a><ul>
<li>A small mouse spoofer</li>
</ul>
</li>
</ul>
</li>
<li><em>Non-HID Spoofing Tools:</em><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/oandrew/ipod-gadget">oandrew&#x2F;ipod-gadget</a><ul>
<li>A tool to spoof your raspberry pi or beaglebone black as an iPod for streaming audio and use with iPod accessories.</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/du33169/usb-gadget-utils">du33169&#x2F;usb-gadget-utils</a><ul>
<li>A small, but comprehensive HID spoofing kit. Includes a toolkit for extracting and parsing HID data from real hardware for use with ConfigFS.</li>
</ul>
</li>
</ul>
</li>
<li><em>ConfigFS Device Tree Overlay Patches (not yet part of the linux kernel):</em><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ikwzm/dtbocfg">ikwzm&#x2F;dtbocfg</a><ul>
<li>A custom implementation of a “ConfigFS overlay interface.” This is not part of the Linux Kernel, but independently developed “patch”</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Xilinx/linux-xlnx">Xilinx&#x2F;linux-xlnx</a><ul>
<li>A similar solution, but as an actually patched kernel</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/digitalloggers/linux-custom-gpio-patches">digitalloggers&#x2F;linux-custom-gpio-patches</a><ul>
<li>A ConfigFS Device Tree Overlay patch specifically tailored to Raspberry Pi GPIO headers</li>
</ul>
</li>
</ul>
</li>
<li>✨✨ <em>Programming Libraries for ConfigFS&#x2F;FunctionFS:</em><ul>
<li>libusbg&#x2F;libusbgx (see above)<ul>
<li>ConfigFS for C</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/ueno/libusb-gadget">ueno&#x2F;libusb-gadget</a><ul>
<li>GadgetFS for C</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/xstevens/usbg.rs">xstevens&#x2F;usbg.rs</a><ul>
<li>ConfigFS for Rust</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/R030t1/linux-usb-functionfs-sys">R030t1&#x2F;linux-usb-functionfs-sys</a><ul>
<li>Crude FunctionFS for Rust</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/AlinaNova21/node-gadget">AlinaNova21&#x2F;node-gadget</a><ul>
<li>ConfigFS for Node.JS</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/mgalka/pygadget">mgalka&#x2F;pygadget</a><ul>
<li>ConfigFS for Python</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/vpelletier/python-functionfs">vpelletier&#x2F;python-functionfs</a><ul>
<li>FunctionFS for Python</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/google/go-configfs-tsm">google&#x2F;go-configfs-tsm</a><ul>
<li>ConfigFS (and other things) for Go - NOTE that this one is written by Google</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>This list is mostly all inclusive:</p>
<ul>
<li>It contains the majority of repositories with noteworthy ConfigFS&#x2F;FunctionFS features.</li>
<li>Most of the ignored repositories were ones that either:<ul>
<li>had little documentation&#x2F;were definitively unmaintained</li>
<li>were just some playground or test repos for learning&#x2F;future development</li>
</ul>
</li>
</ul>
</blockquote>
<h2 id="gadget-configfs-源码分析"><a href="#gadget-configfs-源码分析" class="headerlink" title="gadget configfs 源码分析"></a>gadget configfs 源码分析</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.10.186/source/drivers/usb/gadget/configfs.c">https://elixir.bootlin.com/linux/v5.10.186/source/drivers/usb/gadget/configfs.c</a><br><a href="Linux-configfs#%E7%A4%BA%E4%BE%8B">Linux-configfs#示例)</a></p>
</blockquote>
<h3 id="顶层-subsystem"><a href="#顶层-subsystem" class="headerlink" title="顶层 subsystem"></a>顶层 subsystem</h3><p>初始化的时候注册了一个名为 <code>usb_gadget</code> 的 subsystem。所以，insmod 该模块之后，会得到 <code>/configfs/usb_gadget</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_subsystem</span> <span class="title">gadget_subsys</span> =</span> &#123;</span><br><span class="line">	.su_group = &#123;</span><br><span class="line">		.cg_item = &#123;</span><br><span class="line">			.ci_namebuf = <span class="string">&quot;usb_gadget&quot;</span>,</span><br><span class="line">			.ci_type = &amp;gadgets_type,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">	.su_mutex = __MUTEX_INITIALIZER(gadget_subsys.su_mutex),</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">gadget_cfs_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> ret;</span><br><span class="line"></span><br><span class="line">	config_group_init(&amp;gadget_subsys.su_group);</span><br><span class="line"></span><br><span class="line">	ret = configfs_register_subsystem(&amp;gadget_subsys);</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line">module_init(gadget_cfs_init);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __exit <span class="title function_">gadget_cfs_exit</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	configfs_unregister_subsystem(&amp;gadget_subsys);</span><br><span class="line">&#125;</span><br><span class="line">module_exit(gadget_cfs_exit);</span><br></pre></td></tr></table></figure>

<p>该 <code>gadgets_type</code> 中没有 <code>.ct_attrs</code>，所以没有任何属性，即 <code>/configfs/usb_gadget</code> 目录为空。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">gadgets_type</span> =</span> &#123;</span><br><span class="line">	.ct_group_ops   = &amp;gadgets_ops,</span><br><span class="line">	.ct_owner       = THIS_MODULE,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>gadgets_ops</code> 指定了 <code>.make_group</code>，所以 <code>mkdir</code> 会创建子项。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">static struct configfs_group_operations gadgets_ops = &#123;</span><br><span class="line">	.make_group     = &amp;gadgets_make,</span><br><span class="line">	.drop_item      = &amp;gadgets_drop,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>比如 <code>mkdir cvitek</code> 会创建 <code>/configfs/usb_gadget/cvitek</code>，并同时为 cvitek 自动创建 <code>functions</code>, <code>configs</code>, <code>strings</code> 和 <code>os_desc</code> 4 个子项。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> config_group *<span class="title function_">gadgets_make</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> config_group *group,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="type">char</span> *name)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gadget_info</span> *<span class="title">gi</span>;</span></span><br><span class="line"></span><br><span class="line">	gi = kzalloc(<span class="keyword">sizeof</span>(*gi), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!gi)</span><br><span class="line">		<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 创建一个 `/configfs/usb_gadget/cvitek`</span></span><br><span class="line">	config_group_init_type_name(&amp;gi-&gt;group, name, &amp;gadget_root_type);</span><br><span class="line"></span><br><span class="line">	config_group_init_type_name(&amp;gi-&gt;functions_group, <span class="string">&quot;functions&quot;</span>,</span><br><span class="line">			&amp;functions_type);</span><br><span class="line">	configfs_add_default_group(&amp;gi-&gt;functions_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">	config_group_init_type_name(&amp;gi-&gt;configs_group, <span class="string">&quot;configs&quot;</span>,</span><br><span class="line">			&amp;config_desc_type);</span><br><span class="line">	configfs_add_default_group(&amp;gi-&gt;configs_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">	config_group_init_type_name(&amp;gi-&gt;strings_group, <span class="string">&quot;strings&quot;</span>,</span><br><span class="line">			&amp;gadget_strings_strings_type);</span><br><span class="line">	configfs_add_default_group(&amp;gi-&gt;strings_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">	config_group_init_type_name(&amp;gi-&gt;os_desc_group, <span class="string">&quot;os_desc&quot;</span>,</span><br><span class="line">			&amp;os_desc_type);</span><br><span class="line">	configfs_add_default_group(&amp;gi-&gt;os_desc_group, &amp;gi-&gt;group);</span><br><span class="line"></span><br><span class="line">	gi-&gt;composite.bind = configfs_do_nothing;</span><br><span class="line">	gi-&gt;composite.unbind = configfs_do_nothing;</span><br><span class="line">	gi-&gt;composite.suspend = <span class="literal">NULL</span>;</span><br><span class="line">	gi-&gt;composite.resume = <span class="literal">NULL</span>;</span><br><span class="line">	gi-&gt;composite.max_speed = USB_SPEED_SUPER;</span><br><span class="line"></span><br><span class="line">	spin_lock_init(&amp;gi-&gt;spinlock);</span><br><span class="line">	mutex_init(&amp;gi-&gt;lock);</span><br><span class="line">	INIT_LIST_HEAD(&amp;gi-&gt;string_list);</span><br><span class="line">	INIT_LIST_HEAD(&amp;gi-&gt;available_func);</span><br><span class="line"></span><br><span class="line">	composite_init_dev(&amp;gi-&gt;cdev);</span><br><span class="line">	gi-&gt;cdev.desc.bLength = USB_DT_DEVICE_SIZE;</span><br><span class="line">	gi-&gt;cdev.desc.bDescriptorType = USB_DT_DEVICE;</span><br><span class="line">	gi-&gt;cdev.desc.bcdDevice = cpu_to_le16(get_default_bcdDevice());</span><br><span class="line"></span><br><span class="line">	gi-&gt;composite.gadget_driver = configfs_driver_template;</span><br><span class="line"></span><br><span class="line">	gi-&gt;composite.gadget_driver.function = kstrdup(name, GFP_KERNEL);</span><br><span class="line">	gi-&gt;composite.name = gi-&gt;composite.gadget_driver.function;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!gi-&gt;composite.gadget_driver.function)</span><br><span class="line">		<span class="keyword">goto</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> &amp;gi-&gt;group;</span><br><span class="line">err:</span><br><span class="line">	kfree(gi);</span><br><span class="line">	<span class="keyword">return</span> ERR_PTR(-ENOMEM);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="gadget-root-type"><a href="#gadget-root-type" class="headerlink" title="gadget_root_type"></a>gadget_root_type</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">gadget_root_type</span> =</span> &#123;</span><br><span class="line">	.ct_item_ops	= &amp;gadget_root_item_ops,</span><br><span class="line">	.ct_attrs	= gadget_root_attrs,</span><br><span class="line">	.ct_owner	= THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_item_operations</span> <span class="title">gadget_root_item_ops</span> =</span> &#123;</span><br><span class="line">	.release                = gadget_info_attr_release,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>没有定义 <code>.make_item/.make_group</code>，所以无法在 <code>/configfs/usb_gadget/cvitek</code> 目录中通过 <code>mkdir</code> 创建子项。</p>
<p>它有 10 个可读写的属性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bDeviceClass);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bDeviceSubClass);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bDeviceProtocol);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bMaxPacketSize0);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, idVendor);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, idProduct);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bcdDevice);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, bcdUSB);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, UDC);</span><br><span class="line">CONFIGFS_ATTR(gadget_dev_desc_, max_speed);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_attribute</span> *<span class="title">gadget_root_attrs</span>[] =</span> &#123;</span><br><span class="line">	&amp;gadget_dev_desc_attr_bDeviceClass,</span><br><span class="line">	&amp;gadget_dev_desc_attr_bDeviceSubClass,</span><br><span class="line">	&amp;gadget_dev_desc_attr_bDeviceProtocol,</span><br><span class="line">	&amp;gadget_dev_desc_attr_bMaxPacketSize0,</span><br><span class="line">	&amp;gadget_dev_desc_attr_idVendor,</span><br><span class="line">	&amp;gadget_dev_desc_attr_idProduct,</span><br><span class="line">	&amp;gadget_dev_desc_attr_bcdDevice,</span><br><span class="line">	&amp;gadget_dev_desc_attr_bcdUSB,</span><br><span class="line">	&amp;gadget_dev_desc_attr_UDC,</span><br><span class="line">	&amp;gadget_dev_desc_attr_max_speed,</span><br><span class="line">	<span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="functions-type"><a href="#functions-type" class="headerlink" title="functions_type"></a>functions_type</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">config_item_type</span> <span class="title">functions_type</span> =</span> &#123;</span><br><span class="line">	.ct_group_ops   = &amp;functions_ops,</span><br><span class="line">	.ct_owner       = THIS_MODULE,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">configfs_group_operations</span> <span class="title">functions_ops</span> =</span> &#123;</span><br><span class="line">	.make_group     = &amp;function_make,</span><br><span class="line">	.drop_item      = &amp;function_drop,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>💥💥💥💥在 configfs 中，有项目item和组group，均表示为目录。项目和组的区别在于组可以包含其他组💥💥💥</p>
</blockquote>
<p>没有属性，所以一开始 <code>/configfs/usb_gadget/cvitek/functions</code> 目录为空。但定义了 <code>make_group</code>，所以可以创建组。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="Linux-configfs.md">Linux-configfs.md</a></li>
<li><a href="Linux-USBmtp.md">Linux-USBmtp.md</a></li>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing">https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing</a></li>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing/configfs-usb-gadget">https://elixir.bootlin.com/linux/v5.10.186/source/Documentation/ABI/testing/configfs-usb-gadget</a></li>
<li><a target="_blank" rel="noopener" href="http://www.spinics.net/lists/linux-usb/msg76388.html">http://www.spinics.net/lists/linux-usb/msg76388.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v6.1/usb/gadget-testing.html">https://www.kernel.org/doc/html/v6.1/usb/gadget-testing.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v6.1/usb/raw-gadget.html">https://www.kernel.org/doc/html/v6.1/usb/raw-gadget.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/html/v6.1/usb/functionfs.html">https://www.kernel.org/doc/html/v6.1/usb/functionfs.html</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/6a85234b/">usb gadget configfs 原理</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/a64c6a27/">usb gadget configfs 验证</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/440dc3d9/">usb gadget configfs 翻译</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/ffcaead/">Android usb gadget类型</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/588ebc22/">ACM&amp;ECM&amp;NCM&amp;EEM&amp;RNDIS&amp;RmNet介绍</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/488cc6d0/">Linux USB Test Mode</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/69b1c932/">USB2.0理论传输速度和实际传输速度</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/68203a0/">Linux驱动中配置支持特定USB HUB</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/892013c5/">配置USB Host和USB Device full-speed工作</a></li>
<li><a target="_blank" rel="noopener" href="https://wowothink.com/e0007988/">Linux测试U盘读写速度</a></li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://yo-gurts.github.io">(ง'̀-'́)ง</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://yo-gurts.github.io/2024/09/22/Linux-USBconfigfs/">https://yo-gurts.github.io/2024/09/22/Linux-USBconfigfs/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://yo-gurts.github.io" target="_blank">(╯°□°）╯︵ ┻━┻ </a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/USB/">USB</a><a class="post-meta__tags" href="/tags/configfs/">configfs</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/09/22/Linux-configfs/" title="Linux configfs"><img class="cover" src="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux configfs</div></div></a></div><div class="next-post pull-right"><a href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs"><img class="cover" src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Linux USB functionfs</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs"><img class="cover" src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-22</div><div class="title">Linux USB functionfs</div></div></a></div><div><a href="/2024/09/17/Linux-USBmtp/" title="Linux USB mtp"><img class="cover" src="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-17</div><div class="title">Linux USB mtp</div></div></a></div><div><a href="/2024/09/01/Linux-USB%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6/" title="Linux USB 驱动框架"><img class="cover" src="https://s2.loli.net/2022/11/17/BeiQmkw4Ya1gvPx.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-01</div><div class="title">Linux USB 驱动框架</div></div></a></div><div><a href="/2024/09/22/Linux-configfs/" title="Linux configfs"><img class="cover" src="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-22</div><div class="title">Linux configfs</div></div></a></div><div><a href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK 编译环境"><img class="cover" src="https://s2.loli.net/2022/11/17/9ZBEesyr14aJhPM.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-06</div><div class="title">Cvitek SDK 编译环境</div></div></a></div><div><a href="/2022/09/19/Cpp%E4%B8%89%E6%96%B9%E5%BA%93/" title="C++三方库"><img class="cover" src="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-19</div><div class="title">C++三方库</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/09/17/3NdhvxIcPRVpufD.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">(ง'̀-'́)ง</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">43</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">50</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">9</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yo-gurts"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/yo-gurts" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:yusong1117.u@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Linux-USB-gadget-%E9%80%9A%E8%BF%87-configfs-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text">Linux USB gadget 通过 configfs 配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-number">2.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A6%81%E6%B1%82"><span class="toc-number">3.</span> <span class="toc-text">要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%88%9B%E5%BB%BA-Gadgets"><span class="toc-number">4.1.</span> <span class="toc-text">1. 创建 Gadgets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E9%85%8D%E7%BD%AE"><span class="toc-number">4.2.</span> <span class="toc-text">2. 创建配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E5%8A%9F%E8%83%BD"><span class="toc-number">4.3.</span> <span class="toc-text">3. 创建功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B0%86%E5%8A%9F%E8%83%BD%E4%B8%8E%E9%85%8D%E7%BD%AE%E5%85%B3%E8%81%94"><span class="toc-number">4.4.</span> <span class="toc-text">4. 将功能与配置关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%90%AF%E7%94%A8-Gadget"><span class="toc-number">4.5.</span> <span class="toc-text">5. 启用 Gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%A6%81%E7%94%A8-Gadget"><span class="toc-number">4.6.</span> <span class="toc-text">6. 禁用 Gadget</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%B8%85%E7%90%86"><span class="toc-number">4.7.</span> <span class="toc-text">7. 清理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text">实现设计</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#useful-links"><span class="toc-number">6.</span> <span class="toc-text">useful links</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-this"><span class="toc-number">6.1.</span> <span class="toc-text">What is this?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Why-is-this-cool"><span class="toc-number">6.2.</span> <span class="toc-text">Why is this cool?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#What%E2%80%99s-this-about-kernels-plural"><span class="toc-number">6.3.</span> <span class="toc-text">What’s this about kernels (plural)?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TL-DR-The-list"><span class="toc-number">6.4.</span> <span class="toc-text">(TL;DR) The list</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gadget-configfs-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">7.</span> <span class="toc-text">gadget configfs 源码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B6%E5%B1%82-subsystem"><span class="toc-number">7.1.</span> <span class="toc-text">顶层 subsystem</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gadget-root-type"><span class="toc-number">7.2.</span> <span class="toc-text">gadget_root_type</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#functions-type"><span class="toc-number">7.3.</span> <span class="toc-text">functions_type</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">8.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 编译流程"><img src="https://s2.loli.net/2022/11/17/Zm4kDRxypb5ez3q.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cvitek-v4.2.0 编译流程"/></a><div class="content"><a class="title" href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 编译流程">Cvitek-v4.2.0 编译流程</a><time datetime="2024-10-09T14:25:10.000Z" title="发表于 2024-10-09 22:25:10">2024-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK 编译环境"><img src="https://s2.loli.net/2022/11/17/9ZBEesyr14aJhPM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cvitek SDK 编译环境"/></a><div class="content"><a class="title" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK 编译环境">Cvitek SDK 编译环境</a><time datetime="2024-10-06T06:02:04.000Z" title="发表于 2024-10-06 14:02:04">2024-10-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/24/Linux-sysfs/" title="Linux sysfs"><img src="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux sysfs"/></a><div class="content"><a class="title" href="/2024/09/24/Linux-sysfs/" title="Linux sysfs">Linux sysfs</a><time datetime="2024-09-24T14:37:59.000Z" title="发表于 2024-09-24 22:37:59">2024-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs"><img src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux USB functionfs"/></a><div class="content"><a class="title" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs">Linux USB functionfs</a><time datetime="2024-09-22T14:31:05.000Z" title="发表于 2024-09-22 22:31:05">2024-09-22</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/22/Linux-USBconfigfs/" title="Linux USB gadget_configfs"><img src="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux USB gadget_configfs"/></a><div class="content"><a class="title" href="/2024/09/22/Linux-USBconfigfs/" title="Linux USB gadget_configfs">Linux USB gadget_configfs</a><time datetime="2024-09-22T13:44:30.000Z" title="发表于 2024-09-22 21:44:30">2024-09-22</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By (ง'̀-'́)ง</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'b740056c42e9eadf273e',
      clientSecret: 'e5f185fa9a6e27927f7a2672469435c68a288c95',
      repo: 'Yo-gurts.github.io',
      owner: 'yo-gurts',
      admin: ['yo-gurts'],
      id: '02c77a21afb556542c87ffb9cc77aa8a',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.css')
      await getScript('https://cdn.jsdelivr.net/npm/gitalk@1.8.0/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script defer="defer" id="fluttering_ribbon" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>