<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Alios USB camera 常见需求处理 | (╯°□°）╯︵ ┻━┻ </title><meta name="author" content="(ง'̀-'́)ง"><meta name="copyright" content="(ง'̀-'́)ง"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="配置说明组件配置每个组件都有一个 .yaml 配置文件，主要关注： 12def_config: # 组件的可配置项  CONFIG_XXX: 1  def_config 下的配置都会以宏定义的形式来影响代码。就相当于在编译时多了 -DCONFIG_XXX&#x3D;1 这样。 Solution 配置Solution 也有一个 yaml 的配置文件，也包含 depends、def_config 等配置项，这里">
<meta property="og:type" content="article">
<meta property="og:title" content="Alios USB camera 常见需求处理">
<meta property="og:url" content="https://yo-gurts.github.io/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/index.html">
<meta property="og:site_name" content="(╯°□°）╯︵ ┻━┻ ">
<meta property="og:description" content="配置说明组件配置每个组件都有一个 .yaml 配置文件，主要关注： 12def_config: # 组件的可配置项  CONFIG_XXX: 1  def_config 下的配置都会以宏定义的形式来影响代码。就相当于在编译时多了 -DCONFIG_XXX&#x3D;1 这样。 Solution 配置Solution 也有一个 yaml 的配置文件，也包含 depends、def_config 等配置项，这里">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png">
<meta property="article:published_time" content="2024-06-04T03:19:42.000Z">
<meta property="article:modified_time" content="2024-06-04T03:19:42.000Z">
<meta property="article:author" content="(ง&#39;̀-&#39;́)ง">
<meta property="article:tag" content="Cvitek">
<meta property="article:tag" content="Alios">
<meta property="article:tag" content="USB">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="https://yo-gurts.github.io/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          const hour = new Date().getHours()
          const isNight = hour <= 6 || hour >= 18
          if (theme === undefined) isNight ? activateDarkMode() : activateLightMode()
          else theme === 'light' ? activateLightMode() : activateDarkMode()
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":600,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: true,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Alios USB camera 常见需求处理',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-06-04 11:19:42'
}</script><meta name="generator" content="Hexo 6.1.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load', preloader.endLoading)

  if (false) {
    btf.addGlobalFn('pjaxSend', preloader.initLoading, 'preloader_init')
    btf.addGlobalFn('pjaxComplete', preloader.endLoading, 'preloader_end')
  }
})()</script><div id="web_bg" style="background-image: url(https://s2.loli.net/2022/11/17/EzYwrT7nPiIH6qA.png);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="https://s2.loli.net/2024/09/17/3NdhvxIcPRVpufD.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent;"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">(╯°□°）╯︵ ┻━┻ </span></a><a class="nav-page-title" href="/"><span class="site-name">Alios USB camera 常见需求处理</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Alios USB camera 常见需求处理</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-04T03:19:42.000Z" title="发表于 2024-06-04 11:19:42">2024-06-04</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-06-04T03:19:42.000Z" title="更新于 2024-06-04 11:19:42">2024-06-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Cvitek/">Cvitek</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>16分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">评论数:</span><a href="/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/#post-comment"><span class="gitalk-comment-count"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="配置说明"><a href="#配置说明" class="headerlink" title="配置说明"></a>配置说明</h2><h3 id="组件配置"><a href="#组件配置" class="headerlink" title="组件配置"></a>组件配置</h3><p>每个组件都有一个 <code>.yaml</code> 配置文件，主要关注：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">def_config:</span> <span class="comment"># 组件的可配置项</span></span><br><span class="line">  <span class="attr">CONFIG_XXX:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><code>def_config</code> 下的配置都会以宏定义的形式来影响代码。就相当于在编译时多了 <code>-DCONFIG_XXX=1</code> 这样。</p>
<h3 id="Solution-配置"><a href="#Solution-配置" class="headerlink" title="Solution 配置"></a>Solution 配置</h3><p>Solution 也有一个 <code>yaml</code> 的配置文件，也包含 <code>depends</code>、<code>def_config</code> 等配置项，这里单独来讲主要是想强调 <code>def_config</code> 这个配置，Solution 下的配置文件中，可以修改任意组件的 <code>def_config</code> 。也就是说，每个组件下的配置文件中，<code>def_config</code> 下配置相当于是<em>默认配置</em>。如果 Solution 下的配置项与组件的下配置不一致，以 Solution 的为准。</p>
<p><strong>❗❗强调：Solution 下的配置会对所有组件生效，所以在定义配置的时候，注意配置名是否与其他组件重复了（可以重复，但要确认这是你期望的）。</strong></p>
<h2 id="用户常用改动"><a href="#用户常用改动" class="headerlink" title="用户常用改动"></a>用户常用改动</h2><ul>
<li><p><input checked="" disabled="" type="checkbox"> 
板卡内存大小</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_DRAM_CFG:</span> <span class="string">&quot;128m&quot;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
配置 UVC 数量。有的客户是单目，有的客户是双目。</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_USBD_UVC_NUM:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
修改 PID, VID。（设备描述符里面）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
修改设备名称（视频控制接口描述符里面。双目场景一般一个rgb摄像头 + 一个红外摄像头，需要分别设置名字以区分）。</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
修改序列号。（设备描述符里面）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
修改 PRODUCT ID（设备描述符里面）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
视频码率控制。（MJPEG&#x2F;H264 H265）</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_MJPEG_BITRATE:</span> <span class="number">20480</span>          <span class="comment"># UVC 推流时，设置视频编码器 MJPEG 的码率，单位 kbps</span></span><br><span class="line"><span class="attr">CONFIG_UVC_H264_H265_BITRATE:</span> <span class="number">4096</span>       <span class="comment"># UVC 推流时，设置视频编码器 H264/H265 的码率，单位 kbps</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><input disabled="" type="checkbox"> 
灯光亮度控制。（通过 PWM 调控）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
分辨率。（不同客户需要支持的分辨率不一样）</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
支持高分辨率（vpss 仅一个通道支持2880x1620)</p>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
<a href="#USBcamera%E9%80%9A%E7%94%A8%E5%8A%9F%E8%83%BD">USB camera 通用功能（亮度、色调、饱和度等调整）</a></p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_COMM_FUNC:</span> <span class="number">0</span>                  <span class="comment"># USB camera 使能亮度、色调、对比度等调整功能</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><input checked="" disabled="" type="checkbox"> 
<a href="#%E4%BF%9D%E6%8C%81%E8%BE%93%E5%87%BA%E9%95%BF%E5%AE%BD%E6%AF%94">设置裁剪以保证任意格式输出不会变形</a></p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_CROP_BEFORE_SCALE:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="板卡内存大小"><a href="#板卡内存大小" class="headerlink" title="板卡内存大小"></a>板卡内存大小</h3><p>1811c，1810c 等内存大小不一样，需要更具客户使用的具体芯片来调整。</p>
<p><strong>配置选项</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_DRAM_CFG:</span> <span class="string">&quot;128m&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>默认配置</strong>：<code>64m</code></p>
<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/package.xxx.yaml</code></p>
<h3 id="UVC-数量"><a href="#UVC-数量" class="headerlink" title="UVC 数量"></a>UVC 数量</h3><p><strong>配置选项</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_USBD_UVC_NUM:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>默认配置</strong>：<code>1</code></p>
<p><strong>组件配置位置（默认配置）</strong>：<code>components/cvi_platform/package.yaml</code></p>
<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/package.xxx.yaml</code></p>
<h3 id="PID-x2F-VID-修改"><a href="#PID-x2F-VID-修改" class="headerlink" title="PID&#x2F;VID 修改"></a>PID&#x2F;VID 修改</h3><p>暂未定义宏。直接修改对应文件。</p>
<p><strong>配置位置</strong>：<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> CVITEK_VENDOR_ID        0x3346    <span class="comment">/* cvitek vendor id */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVITEK_PRODUCT_ID       0x0001    <span class="comment">/* Webcam A/V gadget */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CVITEK_DEVICE_BCD       0x0001    <span class="comment">/* 0.01 */</span></span></span><br><span class="line"></span><br><span class="line"># 修改上述宏，在设备描述符中使用</span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_device_descriptor</span> <span class="title">comp_device_descriptor</span> =</span> &#123;</span><br><span class="line">    .bLength            = USB_DT_DEVICE_SIZE,</span><br><span class="line">    .bDescriptorType    = USB_DT_DEVICE,</span><br><span class="line">    .bcdUSB             = USB_2_0,</span><br><span class="line">    .bDeviceClass       = USB_CLASS_MISC,</span><br><span class="line">    .bDeviceSubClass    = <span class="number">0x02</span>,</span><br><span class="line">    .bDeviceProtocol    = <span class="number">0x01</span>,</span><br><span class="line">    .bMaxPacketSize0    = <span class="number">0x40</span>,</span><br><span class="line">    .idVendor           = cpu_to_le16(CVITEK_VENDOR_ID),   # VID</span><br><span class="line">    .idProduct          = cpu_to_le16(CVITEK_PRODUCT_ID),  # PID</span><br><span class="line">    .bcdDevice          = cpu_to_le16(CVITEK_DEVICE_BCD),</span><br><span class="line">    .iManufacturer      = USB_STRING_MFC_INDEX,</span><br><span class="line">    .iProduct           = USB_STRING_PRODUCT_INDEX,</span><br><span class="line">    .iSerialNumber      = USB_STRING_SERIAL_INDEX,</span><br><span class="line">    .bNumConfigurations = <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="修改序列号"><a href="#修改序列号" class="headerlink" title="修改序列号"></a>修改序列号</h3><p>序列号<code>iSerialNumber</code>是在设备描述中指定的（指定字符串描述符的ID）。要修改的话只需修改对应的字符串描述符。</p>
<p><strong>配置位置</strong>：<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static const struct usb_descriptor_header * const comp_string_descriptors[] = &#123;</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_manufacturer,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;dev_string_descriptor_product,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_serial, // 序列号字符串描述符</span><br><span class="line">    (struct usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uac_string_descriptor_audio,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uvc_string_descriptor_camera1_name,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uvc_string_descriptor_camera2_name,</span><br><span class="line">    (struct usb_descriptor_header *) &amp;uvc_string_descriptor_camera3_name,</span><br><span class="line">    NULL,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 修改 `comp_string_descriptor_serial` 即可。</span><br><span class="line">// 由于 USB 协议规定序列号是 unicode 编码，所以要用 `cpu_to_le16` 转换。</span><br><span class="line">// 并注意字符串的长度和声明的一致。</span><br><span class="line">DECLARE_UVC_STRING_DESCRIPTOR(10);</span><br><span class="line">static const struct UVC_STRING_DESCRIPTOR(10) comp_string_descriptor_serial = &#123;</span><br><span class="line">    .bLength            = UVC_STRING_DESCRIPTOR_SIZE(10),</span><br><span class="line">    .bDescriptorType    = USB_DESCRIPTOR_TYPE_STRING,</span><br><span class="line">    .wData              = &#123;</span><br><span class="line">        cpu_to_le16(&#x27;2&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;2&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;4&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;1&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;1&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;9&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">        cpu_to_le16(&#x27;0&#x27;),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="动态修改序列号✨"><a href="#动态修改序列号✨" class="headerlink" title="动态修改序列号✨"></a>动态修改序列号✨</h3><p>基本都会用到。</p>
<h3 id="修改-PRODUCT-ID"><a href="#修改-PRODUCT-ID" class="headerlink" title="修改 PRODUCT ID"></a>修改 PRODUCT ID</h3><p><code>product ID</code> 也是在设备描述中指定的<code>iProduct</code>（指定字符串描述符的ID）。要修改的话只需修改对应的字符串描述符。</p>
<p><strong>配置位置</strong>：<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title function_">UVC_STRING_DESCRIPTOR</span><span class="params">(<span class="number">10</span>)</span> dev_string_descriptor_product = &#123;</span><br><span class="line">    .bLength            = UVC_STRING_DESCRIPTOR_SIZE(<span class="number">10</span>),</span><br><span class="line">    .bDescriptorType    = USB_DESCRIPTOR_TYPE_STRING,</span><br><span class="line">    .wData              = &#123;</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;I&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;T&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;K&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;-&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;D&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="设备名称修改"><a href="#设备名称修改" class="headerlink" title="设备名称修改"></a>设备名称修改</h3><p>设备名称也是通过字符串描述符传递。视频控制接口描述符中的 <code>iInterface</code> 指定了名称对应的字符串描述符的下标。</p>
<p><strong>配置位置</strong>：<code>components/cvi_platform/protocol/usb_devices/usbd_composite/src/usbd_comp.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">usb_descriptor_header</span> * <span class="title">const</span> <span class="title">comp_string_descriptors</span>[] =</span> &#123;</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_manufacturer,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;dev_string_descriptor_product,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_serial,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;comp_string_descriptor_zero,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uac_string_descriptor_audio,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uvc_string_descriptor_camera1_name, <span class="comment">// 3个设备名称描述符</span></span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uvc_string_descriptor_camera2_name,</span><br><span class="line">    (<span class="keyword">struct</span> usb_descriptor_header *) &amp;uvc_string_descriptor_camera3_name,</span><br><span class="line">    <span class="literal">NULL</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* UVC Camera max name length is 32  */</span></span><br><span class="line">DECLARE_UVC_STRING_DESCRIPTOR(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="keyword">struct</span> <span class="title function_">UVC_STRING_DESCRIPTOR</span><span class="params">(<span class="number">32</span>)</span> uvc_string_descriptor_camera1_name = &#123;</span><br><span class="line">    .bLength            = UVC_STRING_DESCRIPTOR_SIZE(<span class="number">14</span>), <span class="comment">// name length is 14</span></span><br><span class="line">    .bDescriptorType    = USB_DESCRIPTOR_TYPE_STRING,</span><br><span class="line">    .wData              = &#123;</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;V&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;I&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;T&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;K&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27; &#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;C&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;M&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;E&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;R&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;A&#x27;</span>),</span><br><span class="line">        cpu_to_le16(<span class="string">&#x27;1&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>目前最大支持三个摄像头，所以这里预留了三个设备描述符。如需修改名称，修改对应的描述符即可。</p>
<p>❗❗<strong>注意</strong>：修改之后，Windows 需要在设备管理器中卸载设备，再插上设备才能看的修改后的名字。(Windows自身有缓存)</p>
<h3 id="视频码率控制"><a href="#视频码率控制" class="headerlink" title="视频码率控制"></a>视频码率控制</h3><p>目前 <code>H264/H265</code> 都是吃配置 <code>CONFIG_UVC_H264_H265_BITRATE</code>。</p>
<p><code>MJPEG</code> 格式的码率则是通过 <code>CONFIG_UVC_MJPEG_BITRATE</code> 配置。</p>
<p><strong>配置选项</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_MJPEG_BITRATE:</span> <span class="number">20480</span>          <span class="comment"># UVC 推流时，设置视频编码器 MJPEG 的码率，单位 kbps</span></span><br><span class="line"><span class="attr">CONFIG_UVC_H264_H265_BITRATE:</span> <span class="number">4096</span>       <span class="comment"># UVC 推流时，设置视频编码器 H264/H265 的码率，单位 kbps</span></span><br></pre></td></tr></table></figure>

<p><strong>组件配置位置（默认配置）</strong>：<code>components/cvi_platform/package.yaml</code></p>
<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/package.xxx.yaml</code></p>
<h3 id="视频格式设置"><a href="#视频格式设置" class="headerlink" title="视频格式设置"></a>视频格式设置</h3><p>目前支持 <code>YUY2</code>，<code>H264</code>，<code>H265</code>，<code>MJPEG</code> 4 种格式出流。其中 H264, H265 有一个 DISABLE 配置选项，因为这两种编解码方式需要一个固件，H264 的固件大小约为253k，h265 约为 147k，某些场景下flash 大小不够需要严格控制固件大小，就可以考虑disable h264&#x2F;h265。</p>
<p>不过目前release 版本中，codec 是以.a 静态库的形式提供的，默认是使能了的。所以该配置意义不大。</p>
<p><strong>配置选项</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_DISABLE_VENC_H264:</span> <span class="number">0</span>              <span class="comment"># 是否禁用 H264 编码</span></span><br><span class="line"><span class="attr">CONFIG_DISABLE_VENC_H265:</span> <span class="number">0</span>              <span class="comment"># 是否禁用 H265 编码</span></span><br></pre></td></tr></table></figure>

<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/package.xxx.yaml</code></p>
<h3 id="分辨率设置"><a href="#分辨率设置" class="headerlink" title="分辨率设置"></a>分辨率设置</h3><p>可为不同视频格式配置多种不同的分辨率，直接修改对于的描述数组。</p>
<p><strong>配置位置</strong>：<code>components/cvi_platform/protocol/usb_devices/usbd_class/usbd_uvc/src/usbd_uvc.c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">static struct uvc_frame_info_st yuy2_frame_info[] = &#123;</span><br><span class="line">    &#123;1, 800, 600, 15, 0&#125;,</span><br><span class="line">    &#123;2, 640, 360, 15, 0&#125;,</span><br><span class="line">    &#123;3, 400, 300, 15, 0&#125;,</span><br><span class="line">    &#123;5, 480, 320, 15, 0&#125;,</span><br><span class="line">    &#123;6, 480, 360, 15, 0&#125;,</span><br><span class="line">    &#123;7, 1280, 720, 15, 0&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct uvc_frame_info_st mjpeg_frame_info[] = &#123;</span><br><span class="line">	&#123;1, 240, 320, 30, 0&#125;,</span><br><span class="line">	&#123;2, 320, 240, 30, 0&#125;,</span><br><span class="line">	&#123;3, 480, 320, 30, 0&#125;,</span><br><span class="line">	&#123;4, 640, 480, 30, 0&#125;,</span><br><span class="line">	&#123;5, 656, 468, 30, 0&#125;,</span><br><span class="line">	&#123;6, 720, 480, 30, 0&#125;,</span><br><span class="line">	&#123;7, 800, 480, 30, 0&#125;,</span><br><span class="line">	&#123;8, 864, 480, 30, 0&#125;,</span><br><span class="line">	&#123;9, 800, 600, 30, 0&#125;,</span><br><span class="line">	&#123;10, 1280, 720, 30, 0&#125;,</span><br><span class="line">	&#123;11, 1920, 1080, 30, 0&#125;,</span><br><span class="line">	&#123;12, 1600, 1200, 30, 0&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">static struct uvc_frame_info_st h264_frame_info[] = &#123;</span><br><span class="line">    &#123;1, 800, 600, 30, 0&#125;,</span><br><span class="line">    &#123;2, 1280, 720, 30, 0&#125;,</span><br><span class="line">    &#123;3, 640, 480, 30, 0&#125;,</span><br><span class="line">    &#123;4, 400, 300, 30, 0&#125;,</span><br><span class="line">    &#123;5, 1920, 1080, 30, 0&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>格式为：<code>&#123;序号，宽，高，帧率，是否旋转&#125;</code>。</p>
<h3 id="支持高分辨率"><a href="#支持高分辨率" class="headerlink" title="支持高分辨率"></a>支持高分辨率</h3><p>视频流处理过程中，会用到一些中间变量来存放图像数据，目前该变量的大小是预先确定的，即 <code>DEFAULT_FRAME_SIZE</code>。默认分配的大小是1920x1080x1.5。</p>
<p>在大多数情况下，MJEPG&#x2F;H264&#x2F;H265 等需要存放的都是编码后的数据，即使是 2560x1440 经过编码后也完全能存放下，但我们还支持未压缩的 YUY2 格式，若需要输出 1920x1080 的 YUY2 格式，则上述空间就不够用了。需要设置为 1920x1080x2，另外，处理过程中还需要再原始图像数据的基础上，每1012字节加上12字节的header，所以还需额外分配 些空间。目前建议设置  1920x1120x2</p>
<p><strong>配置位置</strong>：<code>components/cvi_platform/protocol/usb_devices/usbd_class/usbd_uvc/src/usbd_uvc.c</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WIDTH  (unsigned int)(1920)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEIGHT (unsigned int)(1080)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAM_FPS        (30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERVAL       (unsigned long)(10000000 / CAM_FPS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 3 / 2)</span></span><br></pre></td></tr></table></figure>

<p>修改为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WIDTH  (unsigned int)(1920)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HEIGHT (unsigned int)(1120)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CAM_FPS        (30)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERVAL       (unsigned long)(10000000 / CAM_FPS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 2)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_FRAME_SIZE (unsigned long)(WIDTH * HEIGHT * 2)</span></span><br></pre></td></tr></table></figure>

<h3 id="支持-2880x1440-等高分辨率"><a href="#支持-2880x1440-等高分辨率" class="headerlink" title="支持 2880x1440 等高分辨率"></a>支持 2880x1440 等高分辨率</h3><p>参考 《Cvitek Debug SOP》</p>
<p>这个问题是由vpss各scaler硬件性能差异导致的，这种情况下需要使用最强的scaler-1进行所需图像处理。具体的，对于single mode，需要设置vpss chn的chn号为1，<strong>对于dual mode，需要设置 grp 属性中的u8VpssDev为1且设置vpss chn的chn号为0</strong>。</p>
<p><strong>推荐解决办法：即使单个设备也使用dual mode</strong>。</p>
<p>备选方案：使用 single mode 并设置通道为1的话，目前还会启用通道0，会占用额外的VB，也可以合入这笔代码 <a target="_blank" rel="noopener" href="https://gerrit-ai.sophgo.vip:8443/#/c/114453/%EF%BC%8C%E4%B8%8D%E5%90%AF%E7%94%A8chn0%E3%80%82%E8%BF%99%E6%A0%B7%E8%BF%98%E9%9C%80%E4%BF%AE%E6%94%B9uvc">https://gerrit-ai.sophgo.vip:8443/#/c/114453/，不启用chn0。这样还需修改uvc</a> 使用的通道号为1.  VPSS 和venc的绑定关系在：<code>components/cvi_platform/protocol/usb_devices/usbd_class/usbd_uvc/src/usbd_uvc.c</code> 中<code>uvc</code>这个全局变量下配置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">static struct uvc_device_info uvc[USBD_UVC_MAX_NUM] = &#123;</span><br><span class="line">  &#123;</span><br><span class="line">    // .ep = 0x81,</span><br><span class="line">    .format_info = uvc_format_info,</span><br><span class="line">    .formats = ARRAY_SIZE(uvc_format_info),</span><br><span class="line">    .video = &#123;0, 0, 1&#125;, // &#123;venc chn, vpss grp, vpss chn&#125;</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="USBcamera通用功能"><a href="#USBcamera通用功能" class="headerlink" title="USBcamera通用功能"></a>USBcamera通用功能</h3><blockquote>
<p>其他项目也会用到 usbcamera，但并不需要调整色调等功能，所以目前 SDK 默认并未启用这些功能。</p>
<p>如需启用，需要通过配置 <code>CONFIG_UVC_COMM_FUNC:1</code>，则将目前支持的功能都启用。</p>
</blockquote>
<p><strong>配置选项</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_COMM_FUNC:</span> <span class="number">0</span>                  <span class="comment"># USB camera 使能亮度、色调、对比度等调整功能</span></span><br></pre></td></tr></table></figure>

<p><strong>默认配置</strong>：<code>0</code> 未启用。</p>
<p><strong>组件配置位置（默认配置）</strong>：<code>components/cvi_platform/package.yaml</code></p>
<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/package.xxx.yaml</code></p>
<p><strong>注意</strong>：由于有多目 sensor 的场景，在特定摄像头下进行配置的时候，会区分设备的。设备需要与对应的 VPSS GRP, VI_PIPE 绑定，必须满足以下关系：</p>
<p>SENSOR0 -&gt; VI_PIPE0 -&gt; GRP0</p>
<p>SENSOR1 -&gt; VI_PIPE1 -&gt; GRP1</p>
<p>否则设置无法生效。</p>
<p><strong>VI 绑定 VPSS</strong> 是在 <code>solutions/usb_cam/customization/&#123;xxx&#125;/param/custom_vpssparam.c</code> 中，Group 配置中有如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.bBindMode = CVI_TRUE,</span><br><span class="line">.astChn[<span class="number">0</span>] = &#123;</span><br><span class="line">    .enModId = CVI_ID_VI,</span><br><span class="line">    .s32DevId = <span class="number">0</span>,</span><br><span class="line">    .s32ChnId = <span class="number">1</span>,  <span class="comment">// VI CHN ID</span></span><br><span class="line">&#125;,</span><br><span class="line">.astChn[<span class="number">1</span>] = &#123;</span><br><span class="line">    .enModId = CVI_ID_VPSS,</span><br><span class="line">    .s32DevId = <span class="number">1</span>,  <span class="comment">// group ID</span></span><br><span class="line">    .s32ChnId = <span class="number">0</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>目前支持的功能有：</p>
<ul>
<li><input disabled="" type="checkbox"> PROCESSING UNIT<ul>
<li><input checked="" disabled="" type="checkbox"> 亮度</li>
<li><input checked="" disabled="" type="checkbox"> 对比度</li>
<li><input checked="" disabled="" type="checkbox"> 色调</li>
<li><input checked="" disabled="" type="checkbox"> 饱和度</li>
<li><input checked="" disabled="" type="checkbox"> 锐度</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> INPUT TERMINAL(CAMERA TERMINAL)<ul>
<li><input checked="" disabled="" type="checkbox"> PANTILE上下左右移动(绝对)</li>
</ul>
</li>
<li><input disabled="" type="checkbox"> EXTENSION UNIT<ul>
<li><input checked="" disabled="" type="checkbox"> REBOOT（发送 reboot 会重启，无插拔烧录时用）</li>
</ul>
</li>
</ul>
<h3 id="保持输出长宽比"><a href="#保持输出长宽比" class="headerlink" title="保持输出长宽比"></a>保持输出长宽比</h3><p>当sensor的输入图像为 16:9 时，若输出的分辨率为 4:3 ，会看到输出的图像明显发生畸变 &#x2F; 或者说有黑边（<strong>取决于 vpss 通道的 ASPECT_RATIO_S 参数设置</strong>）。可以使能该配置 <code>CONFIG_UVC_CROP_BEFORE_SCALE:1</code>，在进行缩放前先进行裁剪，使裁剪后的大小与输出的长宽比一致，并且尽可能提供更大的视野。这样经过缩放就不会发生畸变。</p>
<p><strong>配置选项</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_UVC_CROP_BEFORE_SCALE:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><strong>默认配置</strong>：<code>1</code></p>
<p><strong>组件配置位置（默认配置）</strong>：<code>components/cvi_platform/package.yaml</code></p>
<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/package.xxx.yaml</code></p>
<h3 id="保持输出长宽比2–是否插黑边"><a href="#保持输出长宽比2–是否插黑边" class="headerlink" title="保持输出长宽比2–是否插黑边"></a>保持输出长宽比2–是否插黑边</h3><p>VPSS 在缩放处理时，可以指定参数是否保存长宽比。</p>
<p>如 1280x720的屏幕，如果输出的画面是 800x400，</p>
<ul>
<li>AUTO 保持比例的话就会拉伸为960x720，左右两边就会有黑边。</li>
<li>NONE 不进行处理，原始大小输出。（画面可能会变形，比如16:9的输入，输出为4:3时）</li>
<li>MANUAL 手动指定显示的位置，以及显示画面的宽、高。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">ASPECT_RATIO_S</span> &#123;</span></span><br><span class="line">    ASPECT_RATIO_E enMode;      <span class="comment">// 是否固定长宽比：NONE, AUTO, MANUAL</span></span><br><span class="line">    CVI_BOOL bEnableBgColor;    <span class="comment">// 是否要让画面以外以背景色覆盖。</span></span><br><span class="line">    CVI_U32 u32BgColor;         <span class="comment">// 填充背景颜色，RGB 888，可通过宏 RGB_8BIT(0, 0, 0xFF) 来指定。bit[7:0]為 B，bit[15:8]為 G，bit[23:16]為 R</span></span><br><span class="line">    RECT_S stVideoRect;         <span class="comment">// 在手动模式时才生效，这个 RECT</span></span><br><span class="line">&#125; ASPECT_RATIO_S;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> _<span class="title">ASPECT_RATIO_E</span> &#123;</span></span><br><span class="line">    ASPECT_RATIO_NONE = <span class="number">0</span>,      <span class="comment">// 无动作，满屏</span></span><br><span class="line">    ASPECT_RATIO_AUTO,          <span class="comment">// 视频保持比例，自动计算视频区域</span></span><br><span class="line">    ASPECT_RATIO_MANUAL,        <span class="comment">// 手动决定视频区域</span></span><br><span class="line">    ASPECT_RATIO_MAX</span><br><span class="line">&#125; ASPECT_RATIO_E;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">RECT_S</span> &#123;</span></span><br><span class="line">    CVI_S32 s32X;</span><br><span class="line">    CVI_S32 s32Y;</span><br><span class="line">    CVI_U32 u32Width;</span><br><span class="line">    CVI_U32 u32Height;</span><br><span class="line">&#125; RECT_S;</span><br></pre></td></tr></table></figure>

<p><strong>用户（特定项目）配置位置</strong>：<code>solutions/usb_cam/customization/&#123;项目xxx&#125;/param/custom_vpssparam.c</code> 为每个 vpss 通道单独配置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PARAM_CLASSDEFINE(PARAM_VPSS_CHN_CFG_S, CHNCFG, GRP0, CHN) [] =</span><br><span class="line">&#123;</span><br><span class="line">   &#123;.u8Rotation = ROTATION_0,</span><br><span class="line">    .stVpssChnAttr = &#123;</span><br><span class="line">            .u32Width = <span class="number">2880</span>,</span><br><span class="line">            .u32Height = <span class="number">1620</span>,</span><br><span class="line">            .enVideoFormat = VIDEO_FORMAT_LINEAR,</span><br><span class="line">            .enPixelFormat = PIXEL_FORMAT_NV21,</span><br><span class="line">            .stFrameRate.s32SrcFrameRate = <span class="number">-1</span>,</span><br><span class="line">            .stFrameRate.s32DstFrameRate = <span class="number">-1</span>,</span><br><span class="line">            .bFlip = CVI_FALSE,</span><br><span class="line">            .bMirror = CVI_FALSE,</span><br><span class="line">            .u32Depth = <span class="number">0</span>,</span><br><span class="line">            .stAspectRatio.enMode = ASPECT_RATIO_AUTO, <span class="comment">// 保持比例，会有黑边，未配置的话就是拉伸</span></span><br><span class="line">            .stAspectRatio.bEnableBgColor = CVI_TRUE,</span><br><span class="line">            .stAspectRatio.u32BgColor    = COLOR_RGB_BLACK,</span><br><span class="line">            .stNormalize.bEnable = CVI_FALSE,</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<h3 id="启用-pqtool-支持"><a href="#启用-pqtool-支持" class="headerlink" title="启用 pqtool 支持"></a>启用 pqtool 支持</h3><p>❗❗<strong>注意编译时要指定正确的 <code>CHIP_ARCH</code> ，否则会导致 pqtool 工具使用时报错</strong>。通过 <code>export CHIP_ARCH=cv181x; make usb_cam PROJECTS=&quot;XXXX&quot;</code>  编译。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">CONFIG_PQTOOL_SUPPORT:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">CONFIG_USBD_CDC_RNDIS:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">CONFIG_USBD_UVC:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">CONFIG_USB_DWC2_DMA_ENABLE:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">CONFIG_APP_RTSP_SUPPORT:</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>启用 pqtool_support 以及 rndis 网络才能让pc端工具连上。使用 UVC 出流效果比 rtsp 更好。<br>DMA 与 rndis 不兼容，所以要关闭。不过目前不开 DMA 会有概率屏闪，所以仅推荐在调试时关闭DMA。<br>RTSP 与 UVC 不兼容，所以要关闭。</p>
<p><strong>目前 RNDIS  有概率出错，发现连不上的话在设备管理器中，禁用 rndis 对应的设备再启用。</strong></p>
<p>板端默认的 IP 地址是 <code>192.168.11.10</code>，PC端对应的 rndis 网卡的 IP 也需要手动设置到相同网段，才能使用 Pqtool 工具进行连接。</p>
<h3 id="快启说明"><a href="#快启说明" class="headerlink" title="快启说明"></a>快启说明</h3><p>为了能使用USB烧录，在rom阶段会等待1s检测usb连接，还有uart烧录的引脚被占用，也会等待1s。</p>
<ul>
<li><p>快启1：通过写 efuse 跳过 rom 阶段的烧录检测。</p>
<ul>
<li>配置：<code>CONFIG_ENABLE_FASTBOOT=1</code>，启用后，app_main 中会调用 <code>CVI_EFUSE_EnableFastBoot</code> 去烧写 efuse 使能快启。</li>
<li>收益：1s整或2s整。</li>
</ul>
</li>
<li><p>快启2：boot0 阶段通过拉高 SPI 的速率加速从flash load固件的过程。来提升启动速度。</p>
<ul>
<li>配置：<code>CONFIG_QUICK_STARTUP_SUPPORT</code>。启用后 boot0 中会拉高 spi 的时钟。</li>
<li>收益：看yoc.bin，或者是否需要从flash加载模型吧，收益不大，可能就几十ms。</li>
</ul>
</li>
</ul>
<h3 id="AE-快速收敛"><a href="#AE-快速收敛" class="headerlink" title="AE 快速收敛"></a>AE 快速收敛</h3><p>若 sensor 的自动曝光调整较慢，在刚打开sensor时，可能会看到明显的画面亮度调整的过程。可以调整pq参数，调大自动曝光的调整速率。</p>
<h3 id="摄像头开启关闭时进行额外处理"><a href="#摄像头开启关闭时进行额外处理" class="headerlink" title="摄像头开启关闭时进行额外处理"></a>摄像头开启关闭时进行额外处理</h3><p>目前是为每个摄像头建立了一个处理线程，完成 UVC 推流。该线程中每一次调用<code>vedio_streaming_send</code>发送一帧，通过检查stream_on的变化情况，确定当前的状态。stream_on 由 0-&gt;1 时表示打开了设备。反之关闭摄像头。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> *<span class="title function_">send_to_uvc</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">	<span class="type">int64_t</span> dev_index = (<span class="type">int64_t</span>)arg;</span><br><span class="line">	<span class="type">bool</span> last_stream_on = <span class="literal">false</span>;</span><br><span class="line">	<span class="type">bool</span> cur_stream_on = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (av_session_init_flag) &#123;</span><br><span class="line">		cur_stream_on = uvc[dev_index].streaming_on;</span><br><span class="line">		<span class="keyword">if</span> (cur_stream_on != last_stream_on) &#123;</span><br><span class="line">			last_stream_on = cur_stream_on;</span><br><span class="line">			<span class="keyword">if</span> (last_stream_on) &#123; <span class="comment">// 开始推流</span></span><br><span class="line">				<span class="comment">// led gpio up, restart sensor, etc.</span></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123; <span class="comment">// 停止推流</span></span><br><span class="line">				<span class="comment">// led gpio down, standby sensor, etc.</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(cur_stream_on) &#123;</span><br><span class="line">			vedio_streaming_send(&amp;uvc[dev_index], dev_index);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			aos_msleep(<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="灯光控制"><a href="#灯光控制" class="headerlink" title="灯光控制"></a>灯光控制</h4><p>推流时开灯，停止推流时关灯。简单的开关可直接在上面的流程中实现，有些场景可考虑使用UVC 处理单元中的 backlight， 通过pwm去控制灯光。</p>
<h4 id="standby-sensor-降低功耗"><a href="#standby-sensor-降低功耗" class="headerlink" title="standby sensor 降低功耗"></a>standby sensor 降低功耗</h4><p>在不出流的时候（待机状态），将 sensor standby，以降低整机功耗。standby 一般有两中方式：</p>
<ul>
<li>软件standby：通过I2C发送指令，让sensor进入standby模式（仍会有较低的功耗，以确保能接受I2C的唤醒指令）</li>
<li>硬件standby：拉低sensor的powerdown引脚，进行standby。功耗比软件更低。</li>
</ul>
<h3 id="超频"><a href="#超频" class="headerlink" title="超频"></a>超频</h3><p>clkstat 命令可以看时钟。</p>
<h3 id="带宽控制"><a href="#带宽控制" class="headerlink" title="带宽控制"></a>带宽控制</h3><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 初始化计数器</span></span><br><span class="line"><span class="variable">$counter</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="variable">$true</span>) &#123;</span><br><span class="line">    <span class="comment"># 增加计数器</span></span><br><span class="line">    <span class="variable">$counter</span>++</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出当前次数</span></span><br><span class="line">    <span class="built_in">Write-Output</span> <span class="string">&quot;当前次数: <span class="variable">$counter</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启动名为 &#x27;xxx.exe&#x27; 的程序</span></span><br><span class="line">    <span class="variable">$process</span> = <span class="built_in">Start-Process</span> <span class="string">&quot;C:\Program Files (x86)\Noël Danjou\AMCap\amcap.exe&quot;</span> <span class="literal">-PassThru</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待3秒</span></span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 杀死进程</span></span><br><span class="line">    <span class="built_in">Stop-Process</span> <span class="literal">-Id</span> <span class="variable">$process</span>.Id <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 等待1秒</span></span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://yo-gurts.github.io">(ง'̀-'́)ง</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://yo-gurts.github.io/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/">https://yo-gurts.github.io/2024/06/04/Cvitek-usbcamera%E9%9C%80%E6%B1%82/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://yo-gurts.github.io" target="_blank">(╯°□°）╯︵ ┻━┻ </a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Cvitek/">Cvitek</a><a class="post-meta__tags" href="/tags/Alios/">Alios</a><a class="post-meta__tags" href="/tags/USB/">USB</a></div><div class="post-share"><div class="social-share" data-image="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2024/05/15/USB-UVC_extension/" title="UVC 扩展单元"><img class="cover" src="https://s2.loli.net/2022/11/17/hF7KodYmE6iPWqg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">UVC 扩展单元</div></div><div class="info-2"><div class="info-item-1">常见问题   UVC 扩展单元的作用是啥？  《UVC 1.5 Class specification》 的 2.7, 3.7.2 中介绍了 UVC 的控制接口包含：输入终端、输出终端、相机终端、选择器单元、处理单元、编码单元、扩展单元。前几个都是类标准中有指定应该实现什么功能的，扩展单元就是专门给厂商实现自定义的一些功能。 比如我们这里客户需要能给设备发送重启指令。     和 UVC 的关系是啥？  UVC 扩展单元是 UVC 的一个可选的小功能。     如何实现与测试？  测试可使用：  Bus Hound，可给设备发送任意命令。分免费版和付费版，我们这里只用来发指令，免费版就够用了。官方网址：https://www.perisoft.net/bushound/index.htm UVCXU摄像头扩展单元调试工具UVCXU-USB中文网官方版，需要加QQ群下载。 wireshark 抓包分析。   BusHound 是直接转到驱动去发的，没有通过 windows 视频类驱动，而UVCXU调试工具时调用了  windows 视频类驱动，就会受到 windows...</div></div></div></a><a class="pagination-related" href="/2024/08/11/Scripts-git_tools/" title="Scripts-管理多个 git 仓库"><img class="cover" src="https://s2.loli.net/2022/11/17/UeWP8jCq6dJZSGD.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">Scripts-管理多个 git 仓库</div></div><div class="info-2"><div class="info-item-1">脚本12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879#!/bin/bash# ANSI颜色码RED=&#x27;\033[0;31m&#x27;GREEN=&#x27;\033[0;32m&#x27;YELLOW=&#x27;\033[0;33m&#x27;BLUE=&#x27;\033[0;34m&#x27;NC=&#x27;\033[0m&#x27; # 恢复默认颜色# Define special charactersOK_STATUS=$&#x27;\u2714&#x27;   # ✅FAIL_STATUS=$&#x27;\u274C&#x27; # ❌# 保存当前目录current_dir=$(pwd)command_to_execute=&quot;\$1&quot;# git logfunction git_log...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK 编译环境"><img class="cover" src="https://s2.loli.net/2022/11/17/nuDZ3dsB6z4bfVJ.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-06</div><div class="info-item-2">Cvitek SDK 编译环境</div></div><div class="info-2"><div class="info-item-1">SDK 下载利用 sophpi 中的脚本下载 SDK 到当前目录。 1git clone -b sg200x-evb git@github.com:sophgo/sophpi.git  sophpi 中的脚本是将需要的仓库拉取到当前目录，为了区分，专门新建 v4.1.x 目录： 123mkdir v4.1.x &amp;&amp; cd v4.1.x../sophpi/scripts/repo_clone.sh --gitclone ../sophpi/scripts/subtree.xml  如需使用双系统快启分支，则： 123mkdir v4.2.x &amp;&amp; cd v4.2.x../sophpi/scripts/repo_clone.sh --gitclone ../sophpi/scripts/subtree_cv18xx-v4.2.x.xml   🙃可能遇到的问题：  没有权限拉取仓库。sophpi 的脚本中是用的 git clone ssh@xxx 走的 ssh，需要配置好 ssh key，否则会报错。可以替换 xml 中的...</div></div></div></a><a class="pagination-related" href="/2023/11/16/Cvitek-buildroot/" title="buildroot 打包 rootfs"><img class="cover" src="https://s2.loli.net/2022/11/17/UeWP8jCq6dJZSGD.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-16</div><div class="info-item-2">buildroot 打包 rootfs</div></div><div class="info-2"><div class="info-item-1">Cvitek buildroot 打包 rootfs 流程介绍 基于 https://github.com/sophgo/cvi_mmf_sdk&#x2F;tree&#x2F;v4.1.0 的实现。  概述在 cvi_mmf_sdk 中，支持两种生成 rootfs 的方式：  基于 ramdisk 目录下的文件系统。 基于 buildroot 打包生成文件系统。  前者仅保留了常用的一些工具，因此生成的文件系统较小，不过新增工具比较麻烦。后者方便用户自己控制需要打包哪些工具。 默认使用第一种方式来生成文件系统，可通过在板子的配置文件中加上 CONFIG_BUILDROOT_FS=y （如 cv1812cp_sophpi_duo_sd_defconfig#L30 中的例子），以启用 buildroot 来生成文件系统。 rootfs 打包流程说明在 source cvisetup.sh 之后，就可以使用 pack_rootfs 命令来打包文件系统了。它本质上是定义在 common_functions.sh 中的一个 shell 函数，在设置必要的环境变量后，通过 make...</div></div></div></a><a class="pagination-related" href="/2024/09/11/Cvitek-reboot/" title="Busybox init&#x2F;reboot&#x2F;poweroff"><img class="cover" src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-11</div><div class="info-item-2">Busybox init&#x2F;reboot&#x2F;poweroff</div></div><div class="info-2"><div class="info-item-1">reboot&#x2F;poweroffboards/default/dts/cv181x/cv181x_base.dtsi 中定义了 restart-controller 设备。 1234restart: restart-controller &#123;	compatible = &quot;cvitek,restart&quot;;	reg = &lt;0x0 0x05025000 0x0 0x2000&gt;;&#125;;  drivers/power/reset/cvi-reboot.c 中实现了对应的一个平台驱动： 123456789101112static const struct of_device_id cvi_reboot_of_match[] = &#123;	&#123; .compatible = &quot;cvitek,restart&quot; &#125;,	&#123;&#125;&#125;;static struct platform_driver cvi_reboot_driver = &#123;	.probe =...</div></div></div></a><a class="pagination-related" href="/2023/08/03/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/" title="Cvitek-安全启动"><img class="cover" src="https://s2.loli.net/2022/11/17/ljOdg6ZMc8H9Y5r.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-03</div><div class="info-item-2">Cvitek-安全启动</div></div><div class="info-2"><div class="info-item-1">Cvitek-安全启动 注：仅考虑 cv181x  安全启动的意义：  防止用户烧录未经授权的固件。（签名） 防止通过固件拷贝，来抄袭产品。（签名+加密）  原理介绍加密算法介绍  盘点五种最常见加密算法！ 密码学基本概念   算法整体上可以分为**不可逆加密，以及可逆加密，可逆加密又可以分为对称加密和非对称加密**。  不可逆这部分称为 消息摘要 更好，摘要算法就是我们常说的散列函数、哈希函数（Hash Function），它能够把任意长度的数据“压缩”成固定长度、而且独一无二的“摘要”字符串，就好像是给这段数据生成了一个数字“指纹”。   消息摘要散列算法，就是一种不可逆算法，无法从散列结果中反推出明文。可以用来检验数据是否被更改。 散列算法中，明文通过散列算法生成散列值，散列值是长度固定的数据，和明文长度无关。  散列算法的具体实现有很多种，常见的包括 MD5、SHA1、SHA-224、SHA-256 等等。 散列算法常用于数字签名、消息认证、密码存储等场景。  本文中，对 kernel、rootfs 的签名就是基于 sha256 实现（不过还用到了下面的...</div></div></div></a><a class="pagination-related" href="/2024/09/22/Linux-USBconfigfs/" title="Linux USB gadget_configfs"><img class="cover" src="https://s2.loli.net/2022/11/17/UeWP8jCq6dJZSGD.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-22</div><div class="info-item-2">Linux USB gadget_configfs</div></div><div class="info-2"><div class="info-item-1">Linux USB gadget 通过 configfs 配置  先阅读 Linux configfs，再看此内容  usb 只有在作为从设备时，才会用到 configfs 去配置功能。 更新日期：2013年4月25日 概述USB Linux Gadget 是一种设备，它具有一个 UDC（USB 设备控制器），并且可以连接到 USB 主机，通过添加功能扩展主机，如串行端口或大容量存储功能。 123A USB Linux Gadget is a device which has a UDC (USB Device Controller)and can be connected to a USB Host to extend it with additional functionslike a serial port or a mass storage capability.  从主机的角度来看，一个 Gadget 是一组配置的集合，每个配置包含若干接口，而从 Gadget 的角度看，这些接口被称为功能（function），每个功能代表一个如串行连接或 SCSI...</div></div></div></a><a class="pagination-related" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs"><img class="cover" src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-22</div><div class="info-item-2">Linux USB functionfs</div></div><div class="info-2"><div class="info-item-1"> translate from https://www.kernel.org/doc/html/v6.1/usb/functionfs.html  FunctionFS 如何工作从内核的角度来看，它只是一个具有一些独特行为的复合功能。只有在用户空间驱动程序通过写入描述符和字符串注册后，它才能被添加到 USB 配置中（用户空间程序必须提供与内核级复合功能在添加到配置中时提供的相同信息）。 123456From kernel point of view it is just a composite function with someunique behaviour.  It may be added to an USB configuration only afterthe user space driver has registered by writing descriptors andstrings (the user space program has to provide the same informationthat kernel level composite...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="https://s2.loli.net/2024/09/17/3NdhvxIcPRVpufD.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">(ง'̀-'́)ง</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">44</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">51</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">10</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/yo-gurts"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/yo-gurts" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:yusong1117.u@gmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E8%AF%B4%E6%98%8E"><span class="toc-number">1.</span> <span class="toc-text">配置说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">组件配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Solution-%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">Solution 配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%B8%B8%E7%94%A8%E6%94%B9%E5%8A%A8"><span class="toc-number">2.</span> <span class="toc-text">用户常用改动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%BF%E5%8D%A1%E5%86%85%E5%AD%98%E5%A4%A7%E5%B0%8F"><span class="toc-number">2.1.</span> <span class="toc-text">板卡内存大小</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UVC-%E6%95%B0%E9%87%8F"><span class="toc-number">2.2.</span> <span class="toc-text">UVC 数量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PID-x2F-VID-%E4%BF%AE%E6%94%B9"><span class="toc-number">2.3.</span> <span class="toc-text">PID&#x2F;VID 修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E5%BA%8F%E5%88%97%E5%8F%B7"><span class="toc-number">2.4.</span> <span class="toc-text">修改序列号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%BA%8F%E5%88%97%E5%8F%B7%E2%9C%A8"><span class="toc-number">2.5.</span> <span class="toc-text">动态修改序列号✨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-PRODUCT-ID"><span class="toc-number">2.6.</span> <span class="toc-text">修改 PRODUCT ID</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E5%90%8D%E7%A7%B0%E4%BF%AE%E6%94%B9"><span class="toc-number">2.7.</span> <span class="toc-text">设备名称修改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E7%A0%81%E7%8E%87%E6%8E%A7%E5%88%B6"><span class="toc-number">2.8.</span> <span class="toc-text">视频码率控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%86%E9%A2%91%E6%A0%BC%E5%BC%8F%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.9.</span> <span class="toc-text">视频格式设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E8%BE%A8%E7%8E%87%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.10.</span> <span class="toc-text">分辨率设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E9%AB%98%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">2.11.</span> <span class="toc-text">支持高分辨率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%AF%E6%8C%81-2880x1440-%E7%AD%89%E9%AB%98%E5%88%86%E8%BE%A8%E7%8E%87"><span class="toc-number">2.12.</span> <span class="toc-text">支持 2880x1440 等高分辨率</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#USBcamera%E9%80%9A%E7%94%A8%E5%8A%9F%E8%83%BD"><span class="toc-number">2.13.</span> <span class="toc-text">USBcamera通用功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8C%81%E8%BE%93%E5%87%BA%E9%95%BF%E5%AE%BD%E6%AF%94"><span class="toc-number">2.14.</span> <span class="toc-text">保持输出长宽比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%9D%E6%8C%81%E8%BE%93%E5%87%BA%E9%95%BF%E5%AE%BD%E6%AF%942%E2%80%93%E6%98%AF%E5%90%A6%E6%8F%92%E9%BB%91%E8%BE%B9"><span class="toc-number">2.15.</span> <span class="toc-text">保持输出长宽比2–是否插黑边</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8-pqtool-%E6%94%AF%E6%8C%81"><span class="toc-number">2.16.</span> <span class="toc-text">启用 pqtool 支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E5%90%AF%E8%AF%B4%E6%98%8E"><span class="toc-number">2.17.</span> <span class="toc-text">快启说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AE-%E5%BF%AB%E9%80%9F%E6%94%B6%E6%95%9B"><span class="toc-number">2.18.</span> <span class="toc-text">AE 快速收敛</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%91%84%E5%83%8F%E5%A4%B4%E5%BC%80%E5%90%AF%E5%85%B3%E9%97%AD%E6%97%B6%E8%BF%9B%E8%A1%8C%E9%A2%9D%E5%A4%96%E5%A4%84%E7%90%86"><span class="toc-number">2.19.</span> <span class="toc-text">摄像头开启关闭时进行额外处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%81%AF%E5%85%89%E6%8E%A7%E5%88%B6"><span class="toc-number">2.19.1.</span> <span class="toc-text">灯光控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#standby-sensor-%E9%99%8D%E4%BD%8E%E5%8A%9F%E8%80%97"><span class="toc-number">2.19.2.</span> <span class="toc-text">standby sensor 降低功耗</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%85%E9%A2%91"><span class="toc-number">2.20.</span> <span class="toc-text">超频</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%A6%E5%AE%BD%E6%8E%A7%E5%88%B6"><span class="toc-number">2.21.</span> <span class="toc-text">带宽控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">2.22.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/10/17/GNUToolchain/" title="Embedded Programming with the GNU Toolchain"><img src="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Embedded Programming with the GNU Toolchain"/></a><div class="content"><a class="title" href="/2024/10/17/GNUToolchain/" title="Embedded Programming with the GNU Toolchain">Embedded Programming with the GNU Toolchain</a><time datetime="2024-10-17T14:00:06.000Z" title="发表于 2024-10-17 22:00:06">2024-10-17</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 编译流程"><img src="https://s2.loli.net/2022/11/17/HCU2TbOi7a1nqLl.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cvitek-v4.2.0 编译流程"/></a><div class="content"><a class="title" href="/2024/10/09/Cvitek-%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B/" title="Cvitek-v4.2.0 编译流程">Cvitek-v4.2.0 编译流程</a><time datetime="2024-10-09T14:25:10.000Z" title="发表于 2024-10-09 22:25:10">2024-10-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK 编译环境"><img src="https://s2.loli.net/2022/11/17/nuDZ3dsB6z4bfVJ.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Cvitek SDK 编译环境"/></a><div class="content"><a class="title" href="/2024/10/06/Cvitek-SDK%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/" title="Cvitek SDK 编译环境">Cvitek SDK 编译环境</a><time datetime="2024-10-06T06:02:04.000Z" title="发表于 2024-10-06 14:02:04">2024-10-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/24/Linux-sysfs/" title="Linux sysfs"><img src="https://s2.loli.net/2022/11/17/NGf2mpwasOYzVIA.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux sysfs"/></a><div class="content"><a class="title" href="/2024/09/24/Linux-sysfs/" title="Linux sysfs">Linux sysfs</a><time datetime="2024-09-24T14:37:59.000Z" title="发表于 2024-09-24 22:37:59">2024-09-24</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs"><img src="https://s2.loli.net/2022/11/17/jypq1GDmIVfl8WM.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux USB functionfs"/></a><div class="content"><a class="title" href="/2024/09/22/Linux-USBfunctionfs/" title="Linux USB functionfs">Linux USB functionfs</a><time datetime="2024-09-22T14:31:05.000Z" title="发表于 2024-09-22 22:31:05">2024-09-22</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent;"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By (ง'̀-'́)ง</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }
      
      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: 'b740056c42e9eadf273e',
      clientSecret: 'e5f185fa9a6e27927f7a2672469435c68a288c95',
      repo: 'Yo-gurts.github.io',
      owner: 'yo-gurts',
      admin: ['yo-gurts'],
      id: '63974d6ab9506a065a3325a98b9ed3c4',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await btf.getCSS('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css')
      await btf.getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !false) {
    if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/fireworks.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>