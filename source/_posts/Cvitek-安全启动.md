---
title: Cvitek-å®‰å…¨å¯åŠ¨
date: 2023-08-03 17:55:02
updated: 2024-05-12 00:13:02
tags:
  - Cvitek
  - å¯åŠ¨æµç¨‹
  - sha256
  - rsa
  - aes
  - uboot
  - openssl
categories: Cvitek
keywords:
description:
top_img: transparent
---

## Cvitek-å®‰å…¨å¯åŠ¨

> æ³¨ï¼šä»…è€ƒè™‘ `cv181x`

å®‰å…¨å¯åŠ¨çš„æ„ä¹‰ï¼š

- é˜²æ­¢ç”¨æˆ·çƒ§å½•æœªç»æˆæƒçš„å›ºä»¶ã€‚ï¼ˆç­¾åï¼‰
- é˜²æ­¢é€šè¿‡å›ºä»¶æ‹·è´ï¼Œæ¥æŠ„è¢­äº§å“ã€‚ï¼ˆç­¾å+åŠ å¯†ï¼‰

## åŸç†ä»‹ç»

### åŠ å¯†ç®—æ³•ä»‹ç»

> - [ç›˜ç‚¹äº”ç§æœ€å¸¸è§åŠ å¯†ç®—æ³•ï¼](https://mp.weixin.qq.com/s/XBYJFZ2jRF2slrlym3svQw)
> - [å¯†ç å­¦åŸºæœ¬æ¦‚å¿µ](https://mp.weixin.qq.com/s/Hu1VBMSHh82n6bujWxr9nw)

ç®—æ³•æ•´ä½“ä¸Šå¯ä»¥åˆ†ä¸º**~~ä¸å¯é€†åŠ å¯†~~**ï¼Œä»¥åŠ**å¯é€†åŠ å¯†**ï¼Œå¯é€†åŠ å¯†åˆå¯ä»¥åˆ†ä¸º**å¯¹ç§°åŠ å¯†**å’Œ**éå¯¹ç§°åŠ å¯†**ã€‚

> ä¸å¯é€†è¿™éƒ¨åˆ†ç§°ä¸º **æ¶ˆæ¯æ‘˜è¦** æ›´å¥½ï¼Œ**æ‘˜è¦ç®—æ³•**å°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„æ•£åˆ—å‡½æ•°ã€å“ˆå¸Œå‡½æ•°ï¼ˆHash Functionï¼‰ï¼Œå®ƒèƒ½å¤ŸæŠŠä»»æ„é•¿åº¦çš„æ•°æ®â€œå‹ç¼©â€æˆå›ºå®šé•¿åº¦ã€è€Œä¸”ç‹¬ä¸€æ— äºŒçš„â€œæ‘˜è¦â€å­—ç¬¦ä¸²ï¼Œå°±å¥½åƒæ˜¯ç»™è¿™æ®µæ•°æ®ç”Ÿæˆäº†ä¸€ä¸ªæ•°å­—â€œæŒ‡çº¹â€ã€‚

![å›¾ç‰‡](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640.png)

#### æ¶ˆæ¯æ‘˜è¦

æ•£åˆ—ç®—æ³•ï¼Œå°±æ˜¯ä¸€ç§ä¸å¯é€†ç®—æ³•ï¼Œæ— æ³•ä»æ•£åˆ—ç»“æœä¸­åæ¨å‡ºæ˜æ–‡ã€‚**å¯ä»¥ç”¨æ¥æ£€éªŒæ•°æ®æ˜¯å¦è¢«æ›´æ”¹**ã€‚

æ•£åˆ—ç®—æ³•ä¸­ï¼Œæ˜æ–‡é€šè¿‡æ•£åˆ—ç®—æ³•ç”Ÿæˆæ•£åˆ—å€¼ï¼Œ**æ•£åˆ—å€¼æ˜¯é•¿åº¦å›ºå®šçš„æ•°æ®ï¼Œå’Œæ˜æ–‡é•¿åº¦æ— å…³**ã€‚

![å›¾ç‰‡](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640-1694590307639-3.png)

æ•£åˆ—ç®—æ³•çš„å…·ä½“å®ç°æœ‰å¾ˆå¤šç§ï¼Œå¸¸è§çš„åŒ…æ‹¬ `MD5`ã€`SHA1`ã€`SHA-224`ã€`SHA-256` ç­‰ç­‰ã€‚

æ•£åˆ—ç®—æ³•å¸¸ç”¨äº**æ•°å­—ç­¾å**ã€æ¶ˆæ¯è®¤è¯ã€å¯†ç å­˜å‚¨ç­‰åœºæ™¯ã€‚

> æœ¬æ–‡ä¸­ï¼Œå¯¹ `kernel`ã€`rootfs` çš„ç­¾åå°±æ˜¯åŸºäº `sha256` å®ç°ï¼ˆä¸è¿‡è¿˜ç”¨åˆ°äº†ä¸‹é¢çš„ `RSA`ï¼‰ã€‚

| åç§°   | ä»‹ç»ï¼šéƒ½æ˜¯ç”¨äºå°†ä»»æ„é•¿åº¦çš„æ•°æ®æ˜ å°„ä¸ºå›ºå®šé•¿åº¦çš„æ•£åˆ—å€¼ï¼Œåªæ˜¯æ˜ å°„é•¿åº¦å’Œå®ç°ç®—æ³•ä¸åŒ                                                                           |
| ------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `MD5`  | `MD5`ï¼ˆMessage-Digest Algorithm 5ï¼‰ï¼Œ`MD5` ç®—æ³•çš„è¾“å‡ºé•¿åº¦ä¸º `128` ä½ï¼Œé€šå¸¸ç”¨ `32` ä¸ª `16` è¿›åˆ¶æ•°è¡¨ç¤ºã€‚                                                     |
| `SHA1` | `SHA-1` ç³»åˆ—å­˜åœ¨ç¼ºé™·ï¼Œå·²ç»ä¸å†è¢«æ¨èä½¿ç”¨                                                                                                                   |
| `SHA2` | `SHA-2` ç®—æ³•åŒ…æ‹¬`SHA-224`ã€`SHA-256`ã€`SHA-384`å’Œ`SHA-512`å››ç§æ•£åˆ—å‡½æ•°ï¼Œ<br />åˆ†åˆ«å°†ä»»æ„é•¿åº¦çš„æ•°æ®æ˜ å°„ä¸º `224` ä½ã€`256` ä½ã€`384` ä½å’Œ `512` ä½çš„æ•£åˆ—å€¼ã€‚ |

#### å¯¹ç§°åŠ å¯† -- AES ç®—æ³•

å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚

![å›¾ç‰‡](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640-1694591480328-6.png)

åŠ å¯†å’Œè§£å¯†è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„å¯†é’¥ï¼Œå› æ­¤å¯†é’¥çš„å®‰å…¨æ€§è‡³å…³é‡è¦ã€‚å¦‚æœå¯†é’¥æ³„éœ²ï¼Œæ”»å‡»è€…å¯ä»¥è½»æ˜“åœ°ç ´è§£åŠ å¯†æ•°æ®ã€‚

å¸¸è§çš„å¯¹ç§°åŠ å¯†ç®—æ³•åŒ…æ‹¬ `DES`ã€`3DES`ã€`AES` ç­‰ã€‚å…¶ä¸­ï¼Œ**`AES` ç®—æ³•æ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„å¯¹ç§°åŠ å¯†ç®—æ³•ä¹‹ä¸€ï¼Œå…·æœ‰æ¯”è¾ƒé«˜çš„å®‰å…¨æ€§å’ŒåŠ å¯†æ•ˆç‡**ã€‚**`AES` ç®—æ³•ä½¿ç”¨çš„å¯†é’¥é•¿åº¦ä¸º `128` ä½ã€`192` ä½æˆ– `256` ä½**ï¼ˆè¿™é‡Œçš„ä½æ˜¯ `bit`ï¼‰

> æˆ‘ä»¬ä½¿ç”¨çš„ `AES` ç§˜é’¥æ˜¯ 128 ä½ã€‚

#### éå¯¹ç§°åŠ å¯† -- RSA ç®—æ³•

éå¯¹ç§°åŠ å¯†ç®—æ³•éœ€è¦ä¸¤ä¸ªå¯†é’¥ï¼Œè¿™ä¸¤ä¸ªå¯†é’¥äº’ä¸ç›¸åŒï¼Œä½†æ˜¯ç›¸äº’åŒ¹é…ï¼Œä¸€ä¸ªç§°ä¸º**å…¬é’¥**ï¼Œå¦ä¸€ä¸ªç§°ä¸º**ç§é’¥**ã€‚

**ä½¿ç”¨å…¶ä¸­çš„ä¸€ä¸ªåŠ å¯†ï¼Œåˆ™ä½¿ç”¨å¦ä¸€ä¸ªè¿›è¡Œè§£å¯†**ã€‚ä¾‹å¦‚ä½¿ç”¨å…¬é’¥åŠ å¯†ï¼Œåˆ™éœ€è¦ä½¿ç”¨ç§é’¥è§£å¯†ã€‚

![å›¾ç‰‡](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/640-1694591564320-9.png)

`RSA` ç®—æ³•çš„**ä¼˜ç‚¹æ˜¯å®‰å…¨æ€§é«˜**ï¼Œå…¬é’¥å¯ä»¥å…¬å¼€ï¼Œç§é’¥å¿…é¡»ä¿å¯†ï¼Œä¿è¯äº†æ•°æ®çš„å®‰å…¨æ€§ï¼›å¯ç”¨äºæ•°å­—ç­¾åã€å¯†é’¥åå•†ç­‰å¤šç§åº”ç”¨åœºæ™¯ã€‚

**ç¼ºç‚¹æ˜¯åŠ å¯†ã€è§£å¯†é€Ÿåº¦è¾ƒæ…¢**ï¼Œå¯†é’¥é•¿åº¦è¶Šé•¿ï¼ŒåŠ å¯†ã€è§£å¯†æ—¶é—´è¶Šé•¿ï¼›å¯†é’¥é•¿åº¦è¿‡çŸ­å®¹æ˜“è¢«æš´åŠ›ç ´è§£ï¼Œå¯†é’¥é•¿åº¦è¿‡é•¿åˆ™ä¼šå¢åŠ è®¡ç®—é‡å’Œå­˜å‚¨ç©ºé—´çš„å¼€é”€ã€‚

`RSA` çš„ç§˜é’¥ï¼ˆåŒ…æ‹¬å…¬é’¥å’Œç§é’¥ï¼‰ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šæ¨¡æ•°å’ŒæŒ‡æ•°

- **å…¬é’¥**ï¼šåŒ…æ‹¬æ¨¡æ•° `N` å’Œ**å…¬é’¥æŒ‡æ•°** `E`ã€‚å…¬é’¥ç”¨äº**éªŒè¯æ•°å­—ç­¾å**ã€‚

- **ç§é’¥**ï¼šåŒ…æ‹¬æ¨¡æ•° `N` å’Œ**ç§é’¥æŒ‡æ•°** `D`ã€‚ç§é’¥ç”¨äº**ç”Ÿæˆæ•°å­—ç­¾å**ã€‚

  > å…·ä½“æ¥è¯´ï¼Œæ•°å­—ç­¾åè¿‡ç¨‹é€šå¸¸æ¶‰åŠä»¥ä¸‹æ­¥éª¤ï¼š
  >
  > 1. **ä½¿ç”¨å“ˆå¸Œå‡½æ•°å¯¹è¦ç­¾åçš„æ•°æ®è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç”Ÿæˆæ¶ˆæ¯æ‘˜è¦ã€‚**
  > 2. **ä½¿ç”¨ç§é’¥å¯¹æ¶ˆæ¯æ‘˜è¦è¿›è¡ŒåŠ å¯†ï¼Œç”Ÿæˆæ•°å­—ç­¾åã€‚**
  > 3. å°†åŸå§‹æ•°æ®ã€æ•°å­—ç­¾åå’Œå…¬é’¥å‘é€ç»™æ¥æ”¶æ–¹ã€‚
  >
  > éªŒè¯æ•°å­—ç­¾åçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š
  >
  > 1. **ä½¿ç”¨å…¬é’¥å¯¹æ•°å­—ç­¾åè¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°æ¶ˆæ¯æ‘˜è¦ã€‚**
  > 2. **ä½¿ç”¨ç›¸åŒçš„å“ˆå¸Œå‡½æ•°å¯¹åŸå§‹æ•°æ®è¿›è¡Œå“ˆå¸Œå¤„ç†ï¼Œç”Ÿæˆå¦ä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦ã€‚**
  > 3. æ¯”è¾ƒè¿™ä¸¤ä¸ªæ¶ˆæ¯æ‘˜è¦ï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è¡¨ç¤ºç­¾åæœ‰æ•ˆï¼Œå¦åˆ™è¡¨ç¤ºç­¾åæ— æ•ˆã€‚
  >
  > å› æ­¤ï¼Œå…¬é’¥é€šå¸¸ç”¨äºéªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§ï¼Œè€Œä¸æ˜¯ç”¨äºç”Ÿæˆæ•°å­—ç­¾åã€‚

åœ¨ä¸€ä¸ªæ ‡å‡†çš„ `RSA` å¯†é’¥å¯¹ä¸­ï¼Œå…¬é’¥çš„ `E`å’Œ `N` é€šå¸¸ä¹ŸåŒ…å«åœ¨ç§é’¥ä¸­ï¼Œ**æ¨¡æ•° `N` æ˜¯ `RSA` å¯†é’¥å¯¹çš„å…³é”®éƒ¨åˆ†ï¼Œå®ƒåœ¨å…¬é’¥å’Œç§é’¥ä¸­éƒ½æ˜¯ç›¸åŒçš„**ã€‚`E` å’Œ `D` æ˜¯æŒ‡æ•°ï¼Œå®ƒä»¬é€šå¸¸ä¸åŒï¼Œå› ä¸ºå®ƒä»¬åœ¨ä¸åŒçš„æ•°å­¦è¿ç®—ä¸­ä½¿ç”¨ã€‚

- `E` é€šå¸¸è¢«è®¾ç½®ä¸ºå¸¸æ•°å€¼ 65537ï¼ˆ0x10001ï¼‰ï¼Œå› ä¸ºè¿™ä¸ªå€¼åœ¨äºŒè¿›åˆ¶ä¸­æœ‰å¾ˆå¤š 1ï¼Œä½¿å¾—åŠ å¯†æ“ä½œæ›´åŠ é«˜æ•ˆã€‚
- `N` æ˜¯ä¸€ä¸ªå¤§æ•´æ•°ï¼Œå®ƒæ˜¯ä¸¤ä¸ªå¤§è´¨æ•°çš„ä¹˜ç§¯ï¼Œ**å®ƒå†³å®šäº† `RSA` å¯†é’¥çš„é•¿åº¦å’Œå¼ºåº¦**ã€‚

åœ¨ RSA ç®—æ³•ä¸­ï¼Œå…¬é’¥å’Œç§é’¥éƒ½åŒ…å«æ¨¡æ•° `N`ï¼Œè€Œ `N` æ˜¯ä¸¤ä¸ªå¤§è´¨æ•° `p` å’Œ `q` çš„ä¹˜ç§¯ã€‚å…¬é’¥è¿˜åŒ…å«ä¸€ä¸ªæŒ‡æ•° `e`ï¼Œè€Œç§é’¥åŒ…å«å¦ä¸€ä¸ªæŒ‡æ•° `d`ã€‚è¿™ä¸¤ä¸ªæŒ‡æ•° `e` å’Œ `d` çš„é€‰æ‹©è¦æ»¡è¶³ä¸€ä¸ªç‰¹å®šçš„æ¡ä»¶ï¼Œä¹Ÿå°±æ˜¯æ»¡è¶³ `e*d â‰¡ 1 (mod Ï†(N))` çš„å…³ç³»ã€‚åœ¨è¿™é‡Œï¼Œ`Ï†(N)` æ˜¯ Euler's totient å‡½æ•°ï¼Œå®ƒå¯¹äº `N=p*q`ï¼Œå€¼ä¸º`Ï†(N)=(p-1)(q-1)`ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶ä¸¤å¯¹å¯†é’¥ï¼ˆå…¬é’¥å’Œç§é’¥ï¼‰æœ‰ä¸åŒçš„æŒ‡æ•° `e` å’Œ dï¼Œä½† `e` å’Œ `d` æ˜¯æ»¡è¶³ç›¸åº”æ•°å­¦å…³ç³»çš„ã€‚ä½¿å¾—ç”¨å…¬é’¥è¿›è¡ŒåŠ å¯†çš„å¯†æ–‡ç”¨ç§é’¥èƒ½è§£å¯†ï¼Œç”¨ç§é’¥è¿›è¡ŒåŠ å¯†çš„å¯†æ–‡ç”¨å…¬é’¥èƒ½è§£å¯†ã€‚åœ¨è¿™é‡Œï¼Œ"æ¨¡ N" æ˜¯æŒ‡åœ¨æ‰€æœ‰çš„åŠ å¯†å’Œè§£å¯†æ“ä½œéƒ½åœ¨æ¨¡ N çš„æ„ä¹‰ä¸‹è¿›è¡Œã€‚å®åˆ™ï¼Œ"äº’é€†"æ˜¯åœ¨æŒ‡ `e` å’Œ `d` ç›¸å¯¹äº `Ï†(N)` æ¨¡é€†çš„å…³ç³»ã€‚

> `e*d â‰¡ 1(mod Ï†(N))` æ˜¯ä¸€ä¸ªåŒä½™æ–¹ç¨‹ï¼Œæè¿°çš„æ˜¯ `e` å’Œ `d` åœ¨æ¨¡ `Ï†(N)` ä¸‹çš„ä¹˜ç§¯åŒä½™äº 1ã€‚
>
> åœ¨æ•°å­¦ä¸­ï¼Œ"åŒä½™"æ˜¯ä¸€ç§ç­‰ä»·å…³ç³»ï¼Œa å’Œ b "æ¨¡ m åŒä½™"ï¼Œå¦‚æœå®ƒä»¬é™¤ä»¥ m å¾—åˆ°çš„ä½™æ•°ç›¸åŒã€‚åœ¨æ­¤å¤„çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™æ„å‘³ç€å½“ä½ å°† e*d é™¤ä»¥ Ï†(N)ï¼Œå¾—åˆ°çš„ä½™æ•°æ˜¯ 1ã€‚
> è¿™ä¸ªå…³ç³»ç¡®ä¿äº†å…¬é’¥ï¼ˆNï¼Œeï¼‰å’Œç§é’¥ï¼ˆNï¼Œdï¼‰å½¼æ­¤äº’é€†ã€‚å³ï¼Œå¦‚æœä½ ä½¿ç”¨å…¬é’¥åŠ å¯†æ¶ˆæ¯ mï¼Œå¾—åˆ° `c=m^e (mod N)`ï¼Œé‚£ä¹ˆä½ å¯ä»¥ç”¨ç§é’¥è§£å¯†æ¶ˆæ¯ cï¼Œå¾—åˆ° `m=c^d (mod N)`ï¼Œåä¹‹äº¦ç„¶ã€‚
> è¿™æ ·è®¾è®¡çš„åŸå› åœ¨äºï¼Œå¦‚æœç¬¬ä¸‰æ–¹åªçŸ¥é“å…¬é’¥ï¼ˆNï¼Œeï¼‰ï¼Œä»–ä»¬æ— æ³•è®¡ç®—å‡ºç›¸åº”çš„ç§é’¥ dï¼Œé™¤éä»–ä»¬èƒ½å› æ•°åˆ†è§£ Nï¼Œè¿™åœ¨å®é™…ä¸­æ˜¯éå¸¸å›°éš¾çš„ï¼Œä½¿å¾—è¿™ä¸€åŠ å¯†ç³»ç»Ÿå…·æœ‰å¾ˆé«˜çš„å®‰å…¨æ€§ã€‚
>
> N åªæ˜¯å…¬é’¥å’Œç§é’¥å…±æœ‰çš„æ¨¡æ•°è€Œå·²ï¼Œå®ƒæ˜¯ä¸¤ä¸ªå¤§è´¨æ•°çš„ä¹˜ç§¯ã€‚è¦æ¨å¯¼å‡ºç§é’¥ï¼Œé™¤äº†éœ€è¦çŸ¥é“ N å€¼å¤–ï¼Œè¿˜éœ€è¦çŸ¥é“è¿™ä¸¤ä¸ªè´¨æ•°ï¼Œç„¶è€Œï¼Œå½“ N æ˜¯ä¸€ä¸ªè¶³å¤Ÿå¤§çš„æ•°æ—¶ï¼Œè¦åˆ†è§£ Nï¼Œæ‰¾åˆ°è¿™ä¸¤ä¸ªè´¨æ•°ï¼ŒåŸºæœ¬ä¸Šæ˜¯ä¸å¯èƒ½çš„ï¼ˆå¯¹äºä¸€ä¸ª N å€¼ï¼Œæœ‰ä¸”åªæœ‰ä¸€å¯¹è´¨æ•°çš„ä¹˜ç§¯ç­‰äº Nï¼‰ã€‚
>
> 2048 ä½çš„ RSA å¯†é’¥ä¸­çš„ N å€¼ï¼Œæ˜¯ç”±ä¸¤ä¸ª 1024 ä½çš„è´¨æ•°ç›¸ä¹˜å¾—åˆ°çš„ï¼Œæ‰€ä»¥å®ƒçš„é•¿åº¦å¤§çº¦åœ¨ 616 åˆ° 617 ä½ä¹‹é—´ã€‚åœ¨åè¿›åˆ¶ä¸‹ï¼Œå®ƒçš„å€¼å¤§çº¦åœ¨ 2 çš„ 2048 æ¬¡æ–¹åˆ° 2 çš„ 2049 æ¬¡æ–¹ä¹‹é—´ï¼Œå³å¤§çº¦åœ¨ 10 çš„ 617 æ¬¡æ–¹åˆ° 10 çš„ 618 æ¬¡æ–¹ä¹‹é—´ï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸éå¸¸å¤§çš„æ•°ã€‚

#### RSA ç¤ºä¾‹

ä½¿ç”¨ OpenSSL å‘½ä»¤è¡Œå·¥å…·ï¼Œä½ å¯ä»¥æ‰§è¡Œ RSA æ•°å­—ç­¾åå’ŒéªŒè¯æ“ä½œã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ç”Ÿæˆ RSA å¯†é’¥å¯¹ï¼Œä½¿ç”¨ç§é’¥å¯¹æ–‡ä»¶è¿›è¡Œæ•°å­—ç­¾åï¼Œç„¶åä½¿ç”¨å…¬é’¥éªŒè¯ç­¾åã€‚

```bash
# ç”Ÿæˆç§é’¥
openssl genrsa -out private.pem 2048
# ä»ç§é’¥ä¸­æå–å…¬é’¥
openssl rsa -in private.pem -pubout -out public.pem

echo 123456789 > test.txt
# ä½¿ç”¨ç§é’¥å¯¹æ–‡ä»¶è¿›è¡Œç­¾å
openssl dgst -sha256 -sign private.pem -out signature.bin test.txt
# ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
openssl dgst -sha256 -verify public.pem -signature signature.bin test.txt
## è¾“å‡º Verified OK
```

åœ¨è¿™ä¸ªç¤ºä¾‹ä¸­ï¼š

- `private.pem`æ˜¯ç”Ÿæˆçš„ç§é’¥æ–‡ä»¶
- `public.pem`æ˜¯ä»ç§é’¥ä¸­æå–çš„å…¬é’¥æ–‡ä»¶
- `test.txt`æ˜¯è¦ç­¾åå’ŒéªŒè¯çš„æ–‡ä»¶
- `signature.bin`æ˜¯ä½¿ç”¨ç§é’¥å¯¹æ–‡ä»¶ç”Ÿæˆçš„ç­¾åæ–‡ä»¶

ä¸‹é¢æ˜¯ä¸€ä¸ª python ç¤ºä¾‹ï¼Œç­¾åçš„æµç¨‹å’Œ `fipsign.py` ä¸­ç±»ä¼¼ã€‚

```python
from Crypto.PublicKey import RSA
from Crypto.Signature import pkcs1_15
from Crypto.Hash import SHA256
from Crypto import Random

# ç”Ÿæˆ RSA å¯†é’¥å¯¹
random_generator = Random.new().read
key = RSA.generate(2048, random_generator)
public_key = key.publickey()

# åŸå§‹æ•°æ®
message = b"This is a test message."

# è®¡ç®—å“ˆå¸Œå€¼
h = SHA256.new(message)

# ä½¿ç”¨ç§é’¥å¯¹åŸå§‹æ•°æ®çš„å“ˆå¸Œå€¼è¿›è¡Œç­¾å
signature = pkcs1_15.new(key).sign(h)

# ä½¿ç”¨å…¬é’¥éªŒè¯ç­¾å
verifier = pkcs1_15.new(public_key)
try:
    verifier.verify(h, signature)
    print("The signature is valid.")
except (ValueError, TypeError):
    print("The signature is not valid.")

# æ³¨æ„ï¼šåœ¨çœŸå®åº”ç”¨ä¸­ï¼Œä½ ä¸åº”è¯¥ç›´æ¥åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥ï¼Œè€Œåº”è¯¥ä½¿ç”¨å®‰å…¨çš„æ–¹å¼æ¥å­˜å‚¨å’Œè®¿é—®å®ƒä»¬ã€‚
```

**é—®é¢˜ï¼šä¸ºä»€ä¹ˆè¦å…ˆhashï¼Œå†å¯¹hash è¿›è¡Œç­¾åï¼Ÿ**

åœ¨æ•°å­—ç­¾åä¸­ï¼Œé€šå¸¸å…ˆå¯¹æ¶ˆæ¯è¿›è¡Œå“ˆå¸Œï¼ˆhashingï¼‰ï¼Œç„¶åå†å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œè€Œä¸æ˜¯ç›´æ¥å¯¹åŸå§‹æ¶ˆæ¯è¿›è¡Œç­¾åã€‚è¿™æ ·åšæœ‰å‡ ä¸ªé‡è¦çš„åŸå› ï¼š

1. **æ€§èƒ½**ï¼šå“ˆå¸Œå‡½æ•°æ¯”ç­¾åç®—æ³•å¿«å¾—å¤šã€‚å“ˆå¸Œå‡½æ•°å¯ä»¥å°†ä»»æ„é•¿åº¦çš„æ•°æ®å‹ç¼©æˆä¸€ä¸ªå›ºå®šé•¿åº¦çš„å“ˆå¸Œå€¼ï¼Œè€Œç­¾åç®—æ³•åˆ™éœ€è¦å¯¹æ•´ä¸ªæ¶ˆæ¯ï¼ˆæˆ–å“ˆå¸Œå€¼ï¼‰è¿›è¡Œå¤æ‚çš„æ•°å­¦è¿ç®—ã€‚ç”±äºå“ˆå¸Œå‡½æ•°çš„å¿«é€Ÿæ€§ï¼Œå³ä½¿å¯¹äºéå¸¸å¤§çš„æ¶ˆæ¯ï¼Œä¹Ÿå¯ä»¥å¿«é€Ÿç”Ÿæˆå“ˆå¸Œå€¼ï¼Œç„¶åå†å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œä»è€Œå¤§å¤§**æé«˜äº†ç­¾åçš„æ•ˆç‡**ã€‚

2. **å®‰å…¨æ€§**ï¼šå“ˆå¸Œå‡½æ•°è¢«è®¾è®¡ä¸ºå…·æœ‰â€œé›ªå´©æ•ˆåº”â€ï¼ˆavalanche effectï¼‰ï¼Œè¿™æ„å‘³ç€å³ä½¿åŸå§‹æ¶ˆæ¯ä¸­åªæœ‰ä¸€ä¸ªå¾®å°çš„å˜åŒ–ï¼Œä¹Ÿä¼šå¯¼è‡´å“ˆå¸Œå€¼å‘ç”Ÿæ˜¾è‘—çš„å˜åŒ–ã€‚è¿™ç§æ€§è´¨ä½¿å¾—å“ˆå¸Œå€¼å¯¹ç¯¡æ”¹éå¸¸æ•æ„Ÿã€‚å¦‚æœç›´æ¥å¯¹åŸå§‹æ¶ˆæ¯è¿›è¡Œç­¾åï¼Œé‚£ä¹ˆä»»ä½•å¯¹æ¶ˆæ¯çš„å¾®å°ç¯¡æ”¹éƒ½å¯èƒ½éœ€è¦é‡æ–°è¿›è¡Œæ•´ä¸ªç­¾åè¿‡ç¨‹ï¼Œè¿™æ—¢è€—æ—¶åˆå®¹æ˜“æš´éœ²ç»™æ”»å‡»è€…æ›´å¤šçš„ä¿¡æ¯ã€‚é€šè¿‡å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œå¯ä»¥ç¡®ä¿å³ä½¿åŸå§‹æ¶ˆæ¯è¢«ç¯¡æ”¹ï¼Œç­¾åä¹Ÿä¼šç«‹å³å¤±æ•ˆï¼Œä»è€Œ**æé«˜äº†å®‰å…¨æ€§**ã€‚

3. **å¯éªŒè¯æ€§**ï¼šå“ˆå¸Œå‡½æ•°æ˜¯å•å‘çš„ï¼Œè¿™æ„å‘³ç€ä»å“ˆå¸Œå€¼ä¸èƒ½æ¢å¤å‡ºåŸå§‹æ¶ˆæ¯ï¼ˆæˆ–è€…è¯´æ¢å¤åŸå§‹æ¶ˆæ¯æ˜¯éå¸¸å›°éš¾çš„ï¼‰ã€‚ä½†æ˜¯ï¼Œç»™å®šç›¸åŒçš„æ¶ˆæ¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¡ç®—å‡ºç›¸åŒçš„å“ˆå¸Œå€¼ã€‚å› æ­¤ï¼Œå½“æ¥æ”¶è€…æ”¶åˆ°ä¸€ä¸ªç­¾åå’Œç›¸åº”çš„æ¶ˆæ¯æ—¶ï¼Œä»–ä»¬å¯ä»¥è‡ªå·±è®¡ç®—æ¶ˆæ¯çš„å“ˆå¸Œå€¼ï¼Œå¹¶ä½¿ç”¨ç­¾åè€…çš„å…¬é’¥æ¥éªŒè¯ç­¾åæ˜¯å¦æœ‰æ•ˆã€‚è¿™ç§æ–¹å¼å…è®¸ä»»ä½•äººéªŒè¯ç­¾åçš„çœŸå®æ€§ï¼Œè€Œä¸éœ€è¦ä¸ç­¾åè€…è¿›è¡Œé€šä¿¡æˆ–äº¤æ¢ä»»ä½•é¢å¤–çš„ä¿¡æ¯ã€‚

4. **ç­¾åé•¿åº¦**ï¼š**ç›´æ¥å¯¹é•¿æ¶ˆæ¯è¿›è¡Œç­¾åå¯èƒ½ä¼šå¯¼è‡´ç”Ÿæˆçš„ç­¾åéå¸¸é•¿**ï¼Œä»è€Œå¢åŠ äº†å­˜å‚¨å’Œä¼ è¾“çš„è´Ÿæ‹…ã€‚é€šè¿‡å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åï¼Œå¯ä»¥ç¡®ä¿ç­¾åé•¿åº¦å§‹ç»ˆå›ºå®šä¸”ç›¸å¯¹è¾ƒçŸ­ï¼Œè¿™æœ‰åˆ©äºèŠ‚çœç©ºé—´å’Œå¸¦å®½ã€‚

ç»¼ä¸Šæ‰€è¿°ï¼Œå…ˆå¯¹æ¶ˆæ¯è¿›è¡Œå“ˆå¸Œï¼Œå†å¯¹å“ˆå¸Œå€¼è¿›è¡Œç­¾åæ˜¯ä¸€ç§å¸¸è§çš„åšæ³•ï¼Œå®ƒç»“åˆäº†å“ˆå¸Œå‡½æ•°å’Œç­¾åç®—æ³•çš„ä¼˜ç‚¹ï¼Œæä¾›äº†é«˜æ•ˆã€å®‰å…¨å’Œå¯éªŒè¯çš„æ•°å­—ç­¾åæ–¹æ¡ˆã€‚

### å¯åŠ¨æµç¨‹ç®€ä»‹

![image-20230913160851943](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/image-20230913160851943.png)

æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ç¬¬ä¸‰ä¸ªï¼Œ**ä¸€ä¸ªå®Œæ•´çš„å¯åŠ¨æµç¨‹**ä¸ºï¼šç”±æ¿ç«¯å›ºå®šçš„ `ROM` ä¸­çš„ä»£ç ï¼ˆ`ZSBL`ï¼‰åˆå§‹åŒ–ç¯å¢ƒåï¼Œè°ƒç”¨ `FSBL`ï¼Œç„¶å `FSBL` è°ƒç”¨ `OpenSBI`ï¼Œè¿›è€Œè°ƒç”¨ `U-Boot`ï¼Œç”± `U-Boot` æ¥å¯åŠ¨å†…æ ¸ã€‚**çƒ§å½•æµç¨‹**ï¼ˆ`update`ï¼‰åªæ˜¯æ²¡æœ‰ `U-Boot` æ¥å¯åŠ¨å†…æ ¸è¿™ä¸€æ­¥éª¤ã€‚

> åˆ° `uboot` ä¹‹åï¼Œå°±ä¸»è¦æ˜¯ç”± `CONFIG_BOOTCOMMAND` æ¥æ§åˆ¶åç»­æ“ä½œï¼Œå¯ä»¥çœ‹åˆ°å…ˆå°è¯•æ˜¾ç¤º `LOGO`ï¼Œç„¶åæ£€æµ‹æ˜¯å¦éœ€è¦å‡çº§ï¼Œ`cvi_update` å®ƒä¼šæ£€æŸ¥æ˜¯å¦æœ‰ `SD` å¡ä¸­æœ‰æ²¡æœ‰ `fip.bin` æˆ– `USB` å‡çº§ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ `||` ï¼Œå°±æ„å‘³ç€å‰é¢æ‰§è¡ŒæˆåŠŸï¼Œå°±ä¸ä¼šæ‰§è¡Œåç»­çš„ã€‚å‡çº§ä¹‹åï¼Œä¸ä¼šè‡ªåŠ¨è¿›å…¥å†…æ ¸å°±æ˜¯è¿™ä¸ªåŸå› ã€‚
>
> ```c
> // u-boot-2021.10/include/configs/cv181x-asic.h:302
> #define CONFIG_BOOTCOMMAND    SHOWLOGOCMD "cvi_update || run norboot || run nandboot || run emmcboot"
> ```

æ•´ä¸ªå¯åŠ¨æµç¨‹æˆ‘ä»¬ç”¨åˆ°çš„ç¡¬ä»¶å­˜å‚¨è®¾å¤‡æœ‰ï¼š`eFuse`ã€`flash(nor/emmc/nand)`ã€`SD`ã€`ddr` è¿™ 4 ä¸ªã€‚

#### ç¼–è¯‘æµç¨‹

è¿™é‡Œåªå…³æ³¨ä¼šç”Ÿæˆå“ªäº›æ–‡ä»¶ï¼Œä»¥åŠæ¯ä¸ªæ–‡ä»¶å¯¹åº”çš„æ¨¡å—ã€‚

| æ¨¡å—    | ç”Ÿæˆæ–‡ä»¶                                                                                     |
| ------- | -------------------------------------------------------------------------------------------- |
| fsbl    | bl2.binï¼Œç¼–è¯‘ fsbl ä¹‹åä¼šåˆ›å»º fip.bin ï¼ˆè¯¥æ–‡ä»¶æ‰“åŒ…äº† bl2.bin fw_dynamic.bin u-boot-raw.binï¼‰ |
| opensbi | fw_dynamic.bin                                                                               |
| uboot   | u-boot-raw.bin                                                                               |
| kernel  | boot.spinor                                                                                  |
| ramdisk | rootfs.spinor                                                                                |

#### çƒ§å½•æµç¨‹

å…ˆè¯´å‡çº§ï¼ˆçƒ§å½•æµç¨‹ï¼‰ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°† `opensbi`ã€`uboot`ã€`kernel` ç­‰äºŒè¿›åˆ¶æ–‡ä»¶çƒ§å½•åˆ° `flash` ä¸Šï¼Œæ¯ä¸ªæ–‡ä»¶åœ¨ `flash` ä¸Šçš„å†™å…¥åœ°å€éƒ½æ˜¯é€šè¿‡æ–‡ä»¶ `partition.xml` æŒ‡å®šï¼Œå¦‚ï¼š

> ä¸æ˜¯æŒ‡å®šå†™å…¥åœ°å€ï¼Œè€Œæ˜¯æŒ‡å®šæ–‡ä»¶çš„å¤§å°ï¼Œä»–ä»¬åœ¨ `flash` ä¸Šç´§æŒ¨ç€æ’åˆ—ï¼Œæ¯”å¦‚ç¬¬ `0-1024`å­˜å‚¨ç€ `fip.bin`ï¼Œ`1024-4096` å­˜å‚¨ç€ `boot.spinor`ã€‚å³ä½¿ `fip.bin` çš„å®é™…å¤§å°æ²¡æœ‰ 1024ï¼Œ`boot.spinor` ä»ç„¶æ˜¯ä»ç¬¬ 1024 å¼€å§‹ã€‚**è¦æ³¨æ„ `flash` çš„å¤§å°é™åˆ¶ï¼Œä¸è¦è¶…å‡ºäº† `flash` çš„å¤§å°**ã€‚

```xml
<physical_partition type="spinor">
    <partition label="fip" size_in_kb="1024" readonly="false" file="fip.bin"/>
    <partition label="BOOT" size_in_kb="3072" readonly="false" file="boot.spinor"/>
    <partition label="APPCFG" size_in_kb="64" readonly="false" file="app_cfg.bin"/>
    <partition label="APPCFGDEF" size_in_kb="64" readonly="false" file="app_cfg_def.bin"/>
    <partition label="sig" size_in_kb="64" file="sig.bin" />
    <partition label="ENV" size_in_kb="64" file="" />
    <partition label="ENV_BAK" size_in_kb="64" file="" />
    <partition label="ROOTFS" size_in_kb="8192" readonly="false" file="rootfs.spinor" />
    <partition label="MISC" size_in_kb="512" file="logo.jpg" />
    <partition label="DATA"  readonly="false" file="" mountpoint="/mnt/data" type="jffs2" />
</physical_partition>
```

> å†™ `partition` æ—¶è¿˜è¦æ³¨æ„å¯¹é½é—®é¢˜ï¼Œè¿™ä¸ªä¸ `flash` æœ‰å…³ï¼Œæ¯”å¦‚åœ¨ `1812h_nand` ä½¿ç”¨çš„ `flash` æ˜¯ `W25N02KVxxIR/U`ï¼ŒæŸ¥çœ‹å…¶æ•°æ®æ‰‹å†Œå¯ä»¥çœ‹åˆ°ï¼Œæœ€å°çš„å—åº”è¯¥æ˜¯ `128KB`ï¼Œå¦‚æœä»ç„¶å°† `sig.bin` çš„å¤§å°è®¾ç½®ä¸º `size_in_kb="64"` ï¼Œçƒ§å½•çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼
>
> å¦å¤–ï¼Œä¹Ÿè¦æ³¨æ„ `parititon` ä¸­çš„å¤§å°è¦å’Œ `cv181x-asic.h` ä¸­è®¾ç½®çš„ `CONFIG_NANDBOOTCOMMAND` ä¸­ä¸€è‡´ã€‚
>
> ```bash
> Flexible Architecture with 128KB blocks
> â€“ Uniform 128K-Byte Block Erase
> â€“ Flexible page data load methods
> ```

ç”±äº `fw_dynamic.bin u-boot-raw.bin` æ”¾å…¥äº† `fip.bin` æ–‡ä»¶ä¸­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬è¿›è¡Œ `update` çš„æ—¶å€™åªéœ€è¦å‡†å¤‡ 3 ä¸ªæ–‡ä»¶ï¼š

```bash
fip.bin
boot.spinor
rootfs.spinor
```

è™½ç„¶ `upgrade.zip` è§£å‹åï¼Œèƒ½çœ‹åˆ° `partition.xml` ï¼Œä¸è¿‡è¿™ç©æ„å¯ä»¥ä¸è¦ï¼Œå› ä¸ºç¼–è¯‘è¿‡ç¨‹ä¸­ï¼Œå·²ç»ä»è¯¥æ–‡ä»¶ç”Ÿæˆäº†åˆ†åŒºçš„ `.h` å¤´æ–‡ä»¶åµŒå…¥åˆ°çš„ä»£ç ä¸­ï¼Œå®é™…çƒ§å½•æ—¶å¹¶ä¸ä¼šç”¨åˆ°ã€‚

å¦å¤–ï¼Œç”±äº `partition` çš„åˆ†åŒºåˆ’åˆ†ï¼Œä¸åŒåŒºåŸŸå›ºå®šèµ·å§‹åœ°å€å¹¶ä¸”ä¸ä¼šé‡å ï¼Œå› æ­¤å‡çº§è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åªçƒ§å½•ä¸€éƒ¨åˆ†ï¼Œæ¯”å¦‚ä¸ä¸Šä¸€æ¬¡çƒ§å½•ç›¸æ¯”ï¼Œåªæœ‰ `u-boot` å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ `SD` å¡ä¸­åªéœ€è¦å‡†å¤‡ `fip.bin` å°±è¡Œã€‚å¦‚æœ `kernel` å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±éœ€è¦ `fip.bin` å’Œ `boot.spinor`ï¼Œé¿å…é‡å¤çƒ§å½• `rootfs.spinor` å¯ä»¥åŠ å¿«ä¸€ç‚¹ç‚¹æ•ˆç‡ã€‚

![sd å¡å‡çº§](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/sd%E5%8D%A1%E5%8D%87%E7%BA%A7.png)

å‡çº§æµç¨‹ä¸ºï¼š

1. `rom` ä¸­ `bl1` ä»£ç å°† `bld.bin`ï¼ˆ`BL2` ä»£ç ï¼‰æ¬ç§»åˆ° `SRAM` ä¸­ï¼›
2. æ‰§è¡Œ `BL2` ä»£ç ï¼Œåˆå§‹åŒ– `ddr`ï¼Œå°† `bldp.bin` å’Œ `u-boot.bin` æ¬ç§»åˆ° `ddr` ä¸­ï¼›
3. æ‰§è¡Œ `bldp.bin`ï¼ˆ`BL31` ä»£ç ï¼‰ï¼›
4. æ‰§è¡Œ `ubootï¼ˆBL33ï¼‰`ä»£ç ï¼Œå°† `boot.xxx`ã€`rootfs.xxx`ã€`fip.bin` æ‹·è´åˆ° `spinor(nand/emmc)`ï¼ˆä¸­é—´éœ€è¦ç»è¿‡ `ddr`ï¼Œä¸Šå›¾ä¸­æ²¡æœ‰å±•ç¤ºè¯¥è¿‡ç¨‹ï¼‰ï¼›
5. ç»§ç»­æ‰§è¡Œ `uboot` ä»£ç ï¼Œå°† `boot.xxx` ä» `spinor(nand/emmc)` è¯»å…¥ `ddr`ï¼Œå¼€å§‹å¯åŠ¨ `kernel`ï¼›

**4ã€5 ä¸¤æ­¥ç”± `uboot` ä¸‹ `cvi_update` å’Œ ` run norboot/nandboot/emmcboot` æŒ‡ä»¤å®Œæˆ**ï¼Œå…·ä½“æ¥è¯´ï¼Œ`cvi_update` ä¸»è¦å®Œæˆçš„äº‹æƒ…æœ‰ï¼š

1. ä»å‡çº§çš„æºå¤´ä¸Šæ‹·è´ `boot.xxxã€rootfs.xxxã€fip.bin` åˆ° `ddr`ï¼›ï¼ˆè¿™é‡Œæºå¤´å¯ä»¥æ˜¯ `uart`ã€`sd` å¡ã€`usb` ç”šè‡³æ˜¯ `ethernet`ï¼‰
2. å°†ä»¥ä¸Šæ–‡ä»¶å†™å…¥å­˜å‚¨ä»‹è´¨ï¼ˆ`spinorã€spinandã€emmc`ï¼‰ï¼›åç»­å°±å¯ä»¥ç›´æ¥ä» `flash` å¯åŠ¨ã€‚

#### å¯åŠ¨æµç¨‹

å¯åŠ¨æµç¨‹çš„å‰ä¸‰çº§ `fsbl, opensbi, uboot` å’Œçƒ§å½•æµç¨‹æ˜¯ä¸€è‡´çš„ï¼Œåªæœ‰åˆ° `uboot` è¿™é‡Œæ‰§è¡Œçš„å†…å®¹ä¸åŒã€‚

å†è¯´å¯åŠ¨æµç¨‹ï¼Œåœ¨ `uboot` å¯åŠ¨å†…æ ¸æ—¶ï¼Œ`nor flash` ä¸ `emmc/nand` æœ‰ç‚¹åŒºåˆ«ï¼Œå› ä¸º `nor` å¯ä»¥ç›´æ¥è¿è¡Œä»£ç ï¼Œè€Œ `emmc/nand` éœ€è¦å…ˆå°† `kernel` ä» `flash` ä¸­åŠ è½½åˆ° `ddr`ï¼Œç„¶åå†è¿è¡Œã€‚ä¸è¿‡ï¼Œä¸‹é¢æˆ‘ä»¬ä½¿ç”¨å®‰å…¨å¯åŠ¨æ—¶ï¼Œç”±äºéœ€è¦æ ¡éªŒ `kernel` çš„ç­¾åï¼Œæ‰€ä»¥å³ä½¿æ˜¯ `nor` ä¹Ÿéœ€è¦å°† `kernel` åŠ è½½åˆ° `ddr`ã€‚

### ç­¾ååŠ å¯†æµç¨‹ä»‹ç»

ä»ä¸Šé¢çš„çƒ§å½•æµç¨‹å¯ä»¥çœ‹åˆ°ï¼Œå‰æœŸåˆ° `uboot` è¿è¡Œé˜¶æ®µéƒ½ä¸ `fip.bin` æœ‰å…³ï¼Œå› æ­¤é¦–å…ˆæˆ‘ä»¬è¦ä¿è¯ `fip.bin` çš„å®‰å…¨æ€§ï¼Œè¦ä¿è¯å®ƒä¸è¢«ç¯¡æ”¹ã€‚ä¸è¿‡è¿™é‡Œå¹¶æ²¡æœ‰é‡‡ç”¨ç›´æ¥å¯¹ `fip.bin` è¿™æ•´ä¸ªæ–‡ä»¶è¿›è¡ŒåŠ å¯†ï¼Œè€Œæ˜¯å¯¹ `fip.bin` ä¸­æ¯ä¸ªå°æ¨¡å—é€ä¸ªåŠ å¯†ã€ç­¾åã€‚ä¸€ä¸ª `fip.bin` æ–‡ä»¶çš„æ„æˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![_images/image1.jpg](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/image1.jpg)

ä¸»è¦ä¹Ÿå°±æ˜¯å‰é¢è¯´çš„ `fsbl, opensbi, u-boot`ï¼Œä¸è¿‡è¿˜é¢å¤–å¢åŠ äº†å„çº§çš„ç­¾åï¼ˆå¯é€‰çš„ï¼‰ã€‚ç”Ÿæˆ `fip.bin` çš„è„šæœ¬æ˜¯`fsbl/plat/cv181x/ fiptool.py `ï¼Œå¯¹ `fip.bin` è¿›è¡Œç­¾åå’ŒåŠ å¯†çš„è„šæœ¬ä¹Ÿåœ¨è¯¥ç›®å½•ä¸‹ã€‚

> å…·ä½“çš„ `fip` æ„æˆå¯ä»¥çœ‹ `fsbl/plat/cv181x/fiptool.py:143` `FIP` è¿™ä¸ªç±»çš„å®šä¹‰ï¼Œ`FIP` å°±æ˜¯æŒ‰è¿™é‡Œå®šä¹‰çš„é¡ºåºï¼Œç”±äº”ä¸ªéƒ¨åˆ†ç»„æˆï¼š`param1, body1, param2, body2, ldr_2nd_hdr`ã€‚ä¸‹é¢æ˜¯ç”Ÿæˆ `fip` çš„ç¼–è¯‘æ—¥å¿—ï¼š
>
> ```bash
> fsbl/plat/cv181x/fiptool.py -v genfip \
>         '/data/song.yu/cvi_mmf_sdk-intl/fsbl/build/cv1811h_wevb_0007a_spinor/fip.bin' \
>         --MONITOR_RUNADDR="${MONITOR_RUNADDR}" \
>         --BLCP_2ND_RUNADDR="${BLCP_2ND_RUNADDR}" \
>         --CHIP_CONF='/data/song.yu/cvi_mmf_sdk-intl/fsbl/build/cv1811h_wevb_0007a_spinor/chip_conf.bin' \
>         --NOR_INFO='FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF' \
>         --NAND_INFO='00000000'\
>         --BL2='/data/song.yu/cvi_mmf_sdk-intl/fsbl/build/cv1811h_wevb_0007a_spinor/bl2.bin' \
>         --BLCP_IMG_RUNADDR=0x05200200 \
>         --BLCP_PARAM_LOADADDR=0 \
>         --BLCP=test/empty.bin \
>         --DDR_PARAM='test/cv181x/ddr_param.bin' \
>         --BLCP_2ND='/data/song.yu/cvi_mmf_sdk-intl/freertos/cvitek/install/bin/cvirtos.bin' \
>         --MONITOR='../opensbi/build/platform/generic/firmware/fw_dynamic.bin' \
>         --LOADER_2ND='/data/song.yu/cvi_mmf_sdk-intl/u-boot-2021.10/build/cv1811h_wevb_0007a_spinor/u-boot-raw.bin' \
>         --compress='lzma'
> ```

#### å‡†å¤‡ç§˜é’¥

é¦–å…ˆæˆ‘ä»¬éœ€è¦å‡†å¤‡å¥½ç§˜é’¥ï¼Œä»ç§˜é’¥çš„åç¼€å¯ä»¥çœ‹å‡ºå…¶ç±»å‹ï¼Œ`.key` ä¸º `AES` åŠ å¯†ä½¿ç”¨çš„ï¼Œ`.pem` ä¸º `RSA` ç®—æ³•ä½¿ç”¨çš„ã€‚

| æ–‡ä»¶          | ä½œç”¨                                                         | ä½¿ç”¨ä½ç½®   |
| ------------- | ------------------------------------------------------------ | ---------- |
| rsa_hash0.pem | ç”¨äºç»™ `bl_priv.pem` ç­¾åçš„ `RSA` ç§é’¥ï¼Œå…¬é’¥ï¼ˆçš„ `hash` å€¼ï¼‰è¢«çƒ§åˆ° `HASH0_PUBLIC` | `rom code` |
| bl_priv.pem   | ç”¨äºç»™ `fsbl/opensbi/u-boot` ç”Ÿæˆç­¾åçš„ `RSA` ç§é’¥           | `fsbl`     |
| loader_ek.key | ç”¨äºç»™ `bl_ek.key` åŠ ã€è§£å¯†çš„ `AES` ç§˜é’¥ï¼Œä¹Ÿä¼šè¢«çƒ§å†™åˆ° `eFuse` | `rom code` |
| bl_ek.key     | ç”¨äºç»™ `fsbl/opensbi/u-boot` åŠ ã€è§£å¯†çš„ `AES` ç§˜é’¥           | `fsbl`     |

`RSA` å¯†é’¥ä½¿ç”¨ `2048 bits` å’Œç¬¬ 4 è´¹é©¬æ•°ï¼Œ**ç”¨äºç­¾å**ï¼š

> **è™½ç„¶è¿™é‡Œè¯´â€œç­¾åâ€ï¼Œ~~ä½†å’Œå‰é¢æ‰€è¯´çš„â€œæ¶ˆæ¯æ‘˜è¦â€å¹¶ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œéœ€è¦æ³¨æ„~~ï¼ğŸ™„ğŸ™„æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œä½†ç­¾åä¼šç”¨åˆ°ç§é’¥ï¼Œè€Œä¸ä»…ä»…æ˜¯ç›´æ¥ä½¿ç”¨ sha256 ç®—æ³•ä¹‹ç±»çš„ã€‚**ç§é’¥ç­¾åï¼Œå…¬é’¥éªŒè¯ã€‚
>
> `PKCS#1 v1.5` æ˜¯ä¸€ç§å…¬é’¥å¯†ç å­¦æ ‡å‡†ï¼Œç”¨äºæ•°å­—ç­¾åå’ŒéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚å®ƒé€šå¸¸ä¸ `RSA` å¯†é’¥å¯¹ä¸€èµ·ä½¿ç”¨ã€‚
>
> 1. **æ•°å­—ç­¾å**ï¼šç­¾åè¿‡ç¨‹ä¼šä½¿ç”¨**ç§é’¥**ç”Ÿæˆä¸€ä¸ªä¸æ¶ˆæ¯ç›¸å…³è”çš„**æ•°å­—ç­¾å**ï¼Œä»¥ä¾¿åœ¨ä»¥åéªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§å’ŒçœŸå®æ€§ã€‚
> 2. **æ•°å­—ç­¾åéªŒè¯**ï¼šéªŒè¯è¿‡ç¨‹ä¼šä½¿ç”¨ä¸ç­¾åç›¸å…³çš„**å…¬é’¥**æ¥éªŒè¯æ¶ˆæ¯çš„å®Œæ•´æ€§ï¼Œä»¥ç¡®ä¿æ¶ˆæ¯æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¹¶ä¸”ç¡®å®æ˜¯ç”±ç§é’¥æŒæœ‰è€…ç­¾åçš„ã€‚

```bash
host$ openssl genrsa -out rsa_hash0.pem -F4 2048
host$ openssl genrsa -out bl_priv.pem -F4 2048
```

> ä¸ºä»€ä¹ˆè¿™é‡Œä¸¤ä¸ª `rsa` ç§˜é’¥éƒ½æ˜¯ç§é’¥â“å…¬é’¥åœ¨å“ªå‘¢â“
>
> ç­”ï¼š`RSA` ç®—æ³•çš„ç§é’¥ä¸­å®é™…ä¸ŠåŒ…å«äº†å…¬é’¥çš„ä¸€éƒ¨åˆ†ä¿¡æ¯ï¼Œå…·ä½“æ¥è¯´ï¼ŒåŒ…æ‹¬äº†**æ¨¡æ•°**å’Œ**å…¬é’¥æŒ‡æ•°**ï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå‚æ•°å°±å¯ä»¥æ¨å‡ºå…¬é’¥ğŸ˜®ã€‚ä¸è¿‡å…¬é’¥æ˜¯æ— æ³•æ¨å‡ºç§é’¥çš„ï¼Œè¿™æ˜¯ `rsa` ç®—æ³•çš„å®‰å…¨ä¿éšœã€‚

`AES` çš„ç§˜é’¥**ä½¿ç”¨é•¿åº¦ 16 çš„éšæœºæ•°**ï¼ˆ`AES-128`ï¼‰ï¼Œ**ç”¨äºåŠ å¯†**ï¼šï¼ˆåªç­¾åä¸åŠ å¯†å°±ç”¨ä¸åˆ°è¿™ä¸ªï¼‰

```bash
host$ head -c 16 /dev/random > loader_ek.key
host$ head -c 16 /dev/random > bl_ek.key
```

#### fip ç»„æˆç»“æ„

è¿™é‡Œå¾—çœ‹ä¸€ä¸‹ `fip.bin` çš„æ„æˆï¼Œåœ¨ `fsbl/plat/cv181x/fiptool.py:143` ä¸­å®šä¹‰ï¼Œä¸‹é¢æœ‰çœç•¥ï¼š

```python
class FIP:
    # FIP å°±æ˜¯æŒ‰è¿™é‡Œå®šä¹‰çš„é¡ºåºï¼šparam1, body1, param2, body2, ldr_2nd_hdr
    param1 = OrderedDict(
        [
            Entry.make("MAGIC1", 8, int, b"CVBL01\n\0"),
            Entry.make("MAGIC2", 4, int),
            Entry.make("BL2_IMG_CKSUM", 4, int),
            Entry.make("BL2_IMG_SIZE", 4, int),
            Entry.make("BLD_IMG_SIZE", 4, int),
            Entry.make("BL_EK", 32, bytes),             # å­˜å‚¨ bl_ek ï¼Ÿ
            Entry.make("ROOT_PK", 512, bytes),          # å­˜å‚¨ rsa_hash0.pem ? 512 å­—èŠ‚åªæ˜¯æœ€å¤§é•¿åº¦å§
            Entry.make("BL_PK", 512, bytes),            # å­˜å‚¨ bl_priv.pem ?
            Entry.make("BL_PK_SIG", 512, bytes),        # å­˜å‚¨ bl_priv.pem çš„ç­¾å
            Entry.make("CHIP_CONF_SIG", 512, bytes),
            Entry.make("BL2_IMG_SIG", 512, bytes),      # å­˜å‚¨ bl2(fsbl) é•œåƒçš„ç­¾å
            Entry.make("BLCP_IMG_SIG", 512, bytes),     # å­˜å‚¨ blcp é•œåƒçš„ç­¾å
        ]
    )

    body1 = OrderedDict(
        [
            Entry.make("BLCP", None, bytes),            # å¡«å…… blcp
            Entry.make("BL2", None, bytes),             # å¡«å…… bl2
        ]
    )
```

å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ `param1` ä¸­å­˜å‚¨ç€ `BL2` ï¼ˆä¹Ÿå°±æ˜¯ `fsbl` é•œåƒï¼‰çš„ç­¾åã€‚ä» `fsbl/plat/cv181x/fipsign.py:sign` ä¸­å¯ä»¥çœ‹åˆ°å…·ä½“çš„èµ‹å€¼è¿‡ç¨‹ï¼š

```python
    # ç­¾åçš„ä¸»å‡½æ•°
    def sign(self):
        logging.info("sign fip.bin")

        # å¤„ç† fip çš„ param1 éƒ¨åˆ†
        self.param1["FIP_FLAGS"].content = self.FIP_FLAGS_SCS_MASK | self.param1["FIP_FLAGS"].toint()
        self.sign_bl_pk()
        cc = self.param1["CHIP_CONF"].content
        cc_size = unpack("<I", self.param1["CHIP_CONF_SIZE"].content)[0]
        logging.debug("CHIP_CONF_SIZE=%#x", cc_size)
        cc = cc[:cc_size]

        # ä¸»è¦å…³æ³¨è¿™é‡Œ 3 ä¸ª sign_by_bl_priv
        self.param1["CHIP_CONF_SIG"].content = self.sign_by_bl_priv(cc)
        self.param1["BL2_IMG_SIG"].content = self.sign_by_bl_priv(self.body1["BL2"].content)

        if self.body1["BLCP"].content:
            logging.debug("sign blcp")
            self.param1["BLCP_IMG_SIG"].content = self.sign_by_bl_priv(self.body1["BLCP"].content)

        self.sign_fip2()
```

ä¸»è¦å…³æ³¨è¿™é‡Œ 3 ä¸ª `sign_by_bl_priv`ï¼Œå°† `BL2` é•œåƒé€šè¿‡ `bl_priv.pem` ç§é’¥è¿›è¡Œç­¾åï¼Œç„¶åå°†ç­¾åç»“æœæ”¾åœ¨ `param1["BL2_IMG_SIG"]`ã€‚æ¿ç«¯é€šè¿‡å†™åœ¨ `efuse` çš„å…¬é’¥ï¼Œå¯¹ `BL2` åˆè®¡ç®—ä¸€æ¬¡ç­¾åï¼Œå’Œ `fip` ä¸­çš„ç­¾åå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´åˆ™è¯´æ˜è¯¥ `fip` ç¡®å®æ˜¯ç§é’¥æŒæœ‰è€…æä¾›çš„ã€‚

ä¸Šé¢åªæ˜¯å¯¹ `bl2` è¿›è¡Œäº†ç­¾åï¼Œ`FIP` çš„ååŠéƒ¨åˆ†è¿˜æœ‰ `opensbi`ï¼Œ `uboot`ï¼ˆåŒæ ·æœ‰çœç•¥ï¼‰ï¼š

```python
    param2 = OrderedDict(
        [
            Entry.make("MAGIC1", 8, int, b"CVLD02\n\0"),
            Entry.make("MONITOR_CKSUM", 4, int),                # ATF-BL31 or OpenSBI
            Entry.make("MONITOR_LOADADDR", 4, int),
            Entry.make("LOADER_2ND_RESERVED0", 4, int),         # uboot
            Entry.make("LOADER_2ND_LOADADDR", 4, int),          # Reserved
            Entry.make("RESERVED_LAST", 4096 - 16 * 5, bytes),
        ]
    )

    body2 = OrderedDict(
        [
            Entry.make("MONITOR", None, bytes),     # å¡«å…… opensbi é•œåƒ
            Entry.make("LOADER_2ND", None, bytes),  # å¡«å…… uboot é•œåƒ
        ]
    )

    ldr_2nd_hdr = OrderedDict(
        [
            Entry.make("MAGIC", 4, int),
            Entry.make("CKSUM", 4, int),
            Entry.make("SIZE", 4, int),
        ]
    )
```

ä¸ `param1` ä¸åŒï¼Œè¿™é‡Œ `param2` ä¸­å¹¶æ²¡æœ‰æˆå‘˜ä¸“é—¨è®°å½• `uboot` çš„ç­¾åï¼Œè€Œæ˜¯ç›´æ¥æ”¾åœ¨äº†é•œåƒçš„æœ«å°¾ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¯¹ `opensbi` è¿›è¡Œç­¾åã€‚

```python
e = self.body2["LOADER_2ND"] # e å°±æ˜¯ uboot çš„é•œåƒ
# åœ¨æœ«å°¾é¢„ç•™ç­¾åçš„ç©ºé—´ï¼Œå†å¡«å…… \0 æŒ‰ IMAGE_ALIGN å¯¹é½
e.content = self.pad(e.content + b"\xCE" * sig_size, IMAGE_ALIGN)
# SIZE is after CKSUM, update it before signing
self._update_ldr_2nd_hdr()

image = bytearray(e.content)
# è®¡ç®—ç­¾åï¼Œä¸åŒ…å«æœ€åé¢„ç•™ç»™å­˜å‚¨â€ç­¾åâ€œçš„å†…å®¹ã€‚
sig = self.sign_by_bl_priv(image[self.ldr_2nd_hdr["CKSUM"].end : -sig_size])
assert sig_size == len(sig)
image[-sig_size:] = sig

e.content = image
```

#### efuse ä»‹ç»

`eFuse` ä¹Ÿå°±æ˜¯**å¯ç¼–ç¨‹ç”µå­ç†”ä¸**ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒå­˜å‚¨çš„æ•°æ®åªèƒ½å†™ `1` ä¸èƒ½å†™ `0`ï¼Œæœ€åˆå…¨ä¸º 0ï¼Œä¸€æ—¦å†™å…¥å°±æ— æ³•æ›´æ”¹ã€‚å…·æœ‰ä»¥ä¸‹ä¸»è¦ç‰¹ç‚¹ï¼š

1. **ä¸å¯é€†æ€§**ï¼šä¸€æ—¦é…ç½®ï¼Œ`eFuse` é€šå¸¸æ— æ³•è¢«æ“¦é™¤æˆ–é‡ç½®ã€‚è¿™æ„å‘³ç€ä¸€æ—¦ä¿¡æ¯è¢«å†™å…¥ `eFuse`ï¼Œå®ƒå°†æ°¸ä¹…å­˜å‚¨åœ¨å…¶ä¸­ï¼Œä¸èƒ½å†æ¬¡ä¿®æ”¹æˆ–æ¸…é™¤ã€‚è¿™ç§ä¸å¯é€†æ€§å¢å¼ºäº†å­˜å‚¨åœ¨ `eFuse` ä¸­çš„ä¿¡æ¯çš„å®‰å…¨æ€§ã€‚ï¼ˆä¸å¯æ“¦é™¤ï¼‰
2. **ç”µæ°”å¯ç¼–ç¨‹**ï¼š`eFuse` å¯ä»¥é€šè¿‡ç”µæ°”ç¼–ç¨‹æ–¹å¼è¿›è¡Œé…ç½®ï¼Œè€Œä¸éœ€è¦ä½¿ç”¨é¢å¤–çš„è®¾å¤‡æˆ–å·¥å…·ã€‚è¿™ç§å¯ç¼–ç¨‹æ€§ä½¿å¾—å®ƒåœ¨åˆ¶é€ è¿‡ç¨‹ä¸­æˆ–è®¾å¤‡çš„ç”Ÿå‘½å‘¨æœŸä¸­å¯ä»¥æ ¹æ®éœ€è¦è¿›è¡Œé…ç½®ã€‚ï¼ˆå¯å†™å…¥ï¼‰
3. **é«˜å¯é æ€§**ï¼š`eFuse` é€šå¸¸å…·æœ‰é«˜åº¦çš„å¯é æ€§å’Œç¨³å®šæ€§ï¼Œå¯ä»¥åœ¨å¹¿æ³›çš„æ¸©åº¦èŒƒå›´å’Œç¯å¢ƒæ¡ä»¶ä¸‹æ­£å¸¸å·¥ä½œã€‚è¿™ä½¿å¾—å®ƒé€‚ç”¨äºå„ç§åº”ç”¨ï¼ŒåŒ…æ‹¬æç«¯ç¯å¢ƒä¸‹çš„ç”¨é€”ã€‚
4. **ç‰©ç†å®‰å…¨**ï¼š`eFuse` **é€šå¸¸é›†æˆåœ¨èŠ¯ç‰‡å†…éƒ¨**ï¼Œéš¾ä»¥ç‰©ç†ä¸Šè®¿é—®æˆ–ç ´åã€‚è¿™å¢å¼ºäº†å­˜å‚¨åœ¨å…¶ä¸­çš„æ•æ„Ÿä¿¡æ¯çš„ç‰©ç†å®‰å…¨æ€§ï¼Œé˜²æ­¢äº†ç¡¬ä»¶çº§åˆ«çš„æ”»å‡»ã€‚

`eFuse` çš„ä¸Šè¿°ç‰¹ç‚¹ï¼Œå¾ˆé€‚åˆç”¨æ¥å­˜å‚¨æ¿ç«¯çš„ç§˜é’¥ã€‚

#### fip ç­¾åæµç¨‹

> ç›´æ¥ä½¿ç”¨ `fipsign.py` è¿™ä¸ªè„šæœ¬ï¼Œ`fip.bin` ä¸ºåŸå§‹é•œåƒï¼Œ`fip_sign.bin` ä¸ºç­¾ååçš„é•œåƒã€‚æ³¨æ„è¿™é‡Œä»…ä½¿ç”¨äº† `RSA` ç§˜é’¥ã€‚
>
> ```bash
> $ ./fipsign.py sign \
>       --root-priv=rsa_hash0.pem \
>       --bl-priv=bl_priv.pem \
>       fip.bin fip_sign.bin
> ```
>

![å®‰å…¨å¯åŠ¨.drawio](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8.drawio.png)

> å›¾ä¸­ `PK` è¡¨ç¤ºå…¬é’¥çš„ `N` å€¼ï¼Œ`_SIG/sign` è¡¨ç¤ºæ•°å­—ç­¾åã€‚

1. ä¿®æ”¹ `FIP_FLAGS` è¡¨æ˜è¿™ä¸ª `fip.bin` ä¸­æœ‰ç­¾åï¼Œéœ€è¦éªŒè¯ã€‚

2. ä»ç§é’¥ `rsa_hash0.pem` ä¸­æå– `N` å€¼å¹¶å†™åˆ° `fip.bin` ä¸­ï¼Œè¯¥ `N` å€¼å’Œ `rom` ä¸­å›ºåŒ–çš„ `E=0x10001` å¯ç»„æˆå…¬é’¥ï¼Œç”¨äºç­¾åéªŒè¯ã€‚

3. `N` å€¼çš„ `sha256` æ•£åˆ—å€¼ä¼šè¢«å†™å…¥åˆ° `efuse` çš„ `LOCK_HASH0_PUBLIC `ï¼ŒéªŒè¯æ—¶å…ˆè®¡ç®— `fip.bin` ä¸­çš„ `N` å€¼çš„æ•£åˆ—å€¼ï¼Œä¸ `efuse` ä¸­å­˜å‚¨çš„æ•£åˆ—å€¼æ¯”è¾ƒï¼Œæ¥ç¡®è®¤ `N` å€¼ï¼ˆæˆ–è€…è¯´å…¬é’¥ï¼‰æ˜¯å¦ä¸æœ€åˆçš„ä¸€è‡´ã€‚

4. æå– `bl_priv.pem` çš„ `N` å€¼å†™å…¥åˆ° `fip.bin` ä¸­ã€‚

5. è®¡ç®— `bl_priv.pem` çš„ `N` å€¼çš„æ•°å­—ç­¾åï¼Œå¹¶å†™å…¥åˆ° `fip.bin` ä¸­ã€‚è¯¥ç­¾åæ˜¯é€šè¿‡ `rsa_hash0.pem` è¿™ä¸ªç§é’¥è®¡ç®— ï¼Œå¯ç”¨ `rsa_hash0.pem` çš„å…¬é’¥éªŒè¯ã€‚

    > å®é™…æ˜¯ `bl_priv.pem` çš„ `N` å€¼çš„ SHA256 æ•£åˆ—å€¼çš„æ•°å­—ç­¾åï¼Œè¿™é‡Œç®€å•ç‚¹è¯´æ–¹ä¾¿ç†è§£ã€‚

6. è®¡ç®— `bl2.bin(fsbl)` çš„æ•°å­—ç­¾åï¼Œè¯¥ç­¾åé€šè¿‡ `bl_priv.pem` è¿™ä¸ªç§é’¥è®¡ç®—ï¼Œç”¨ `BL_PK` éªŒè¯ã€‚

7. è®¡ç®— `fw_dynamic.bin(opensbi)` çš„æ•°å­—ç­¾åï¼Œè¯¥ç­¾åé€šè¿‡ `bl_priv.pem` è¿™ä¸ªç§é’¥è®¡ç®—ï¼Œç”¨ `BL_PK` éªŒè¯ã€‚

8. è®¡ç®— `u-boot-raw.bin(uboot)` çš„æ•°å­—ç­¾åï¼Œè¯¥ç­¾åé€šè¿‡ `bl_priv.pem` è¿™ä¸ªç§é’¥è®¡ç®—ï¼Œç”¨ `BL_PK` éªŒè¯ã€‚

#### fip ç­¾å+åŠ å¯†æµç¨‹

> ç›´æ¥ä½¿ç”¨ `fipsign.py` è¿™ä¸ªè„šæœ¬ï¼Œ`fip.bin` ä¸ºåŸå§‹é•œåƒï¼Œ`fip_enc.bin` ä¸ºç­¾å+åŠ å¯†åçš„é•œåƒã€‚è¿™é‡Œä½¿ç”¨äº† `RSA` å’Œ `AES` ç§˜é’¥ã€‚
>
> ```bash
> $ ./fipsign.py sign-enc \
>          --root-priv=rsa_hash0.pem \
>          --bl-priv=bl_priv.pem \
>          --ldr-ek=loader_ek.key \
>          --bl-ek=bl_ek.key \
>          fip.bin fip_enc.bin
> ```

`fip` çš„ç­¾åå¹¶åŠ å¯†ä¹Ÿå°±æ˜¯åœ¨ä¸Šé¢ç­¾åçš„åŸºç¡€ä¸Šï¼Œå†å¯¹å„ä¸ª `bin` æ–‡ä»¶è¿›è¡ŒåŠ å¯†ã€‚åŠ å¯†ä¸»è¦ä¾èµ–ä¸¤ä¸ª `AES` ç§˜é’¥ï¼Œ`loader_ek` å’Œ `bl_ek`ã€‚å‰è€…ä¼šè¢«å†™å…¥ `efuse`ï¼Œå¹¶ç”¨äºå¯¹ `bl_ek` çš„åŠ ã€è§£å¯†ã€‚`bl_ek` åŠ å¯†åæ”¾å…¥ `fip.bin` ä¸­ï¼Œ`bl_ek` ç”¨äºå¯¹å„ä¸ª `bin` æ–‡ä»¶è¿›è¡ŒåŠ å¯†ã€‚éªŒè¯æ—¶å…ˆé€šè¿‡ `efuse` ä¸­çš„æ˜æ–‡çš„ `loader_ek` ç§˜é’¥å¯¹ fip.bin ä¸­åŠ å¯†åçš„ `bl_ek` è¿›è¡Œè§£å¯†å¾—åˆ° `bl_ek`ã€‚ç„¶åç”¨å®ƒå¯¹å„ä¸ª `bin` æ–‡ä»¶è¿›è¡Œè§£å¯†ã€‚

éªŒè¯çš„æµç¨‹ç›¸åï¼Œå…ˆè§£å¯†åå†éªŒè¯ç­¾åã€‚

![å®‰å…¨å¯åŠ¨-sign-enc-fip.drawio](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-enc-fip.drawio.png)

1. å°† `loader_ek.key` æ˜æ–‡å†™å…¥ `efuse`ã€‚
2. ç”¨ `loader_ek.key` åŠ å¯† `bl_ek.key` åå†™å…¥ `fip.bin`ã€‚
3. ç”¨ `bl_ek.key` å¯¹ `bl2.bin` è¿›è¡ŒåŠ å¯†ã€‚
4. ç”¨ `bl_ek.key` å¯¹ `fw_dynamic.bin` è¿›è¡ŒåŠ å¯†ã€‚
5. ç”¨ `bl_ek.key` å¯¹ `u-boot-raw.bin` è¿›è¡ŒåŠ å¯†ã€‚

å…·ä½“ç­¾åçš„å®ç°æ¶‰åŠåˆ° `fsbl/plat/cv181x/` ç›®å½•ä¸‹çš„ `fipsign.py` å’Œ `fiptool.py`ã€‚å‰é¢ [fip ç»„æˆç»“æ„](#fip ç»„æˆç»“æ„) ä¹Ÿæåˆ°äº†éƒ¨åˆ†å®ç°ã€‚

> `param2/ldr_2nd_hdr` ä¸­è®°å½•çš„ä¿¡æ¯ä¹Ÿä¼šéšç€ç­¾åã€åŠ å¯†æ›´æ–°ï¼Œè¿™é‡Œå¹¶ä¸å…³æ³¨è¿™äº›ç»†èŠ‚ã€‚

```asciiarmor
encrypt_fip
  â”œâ”€â–ºread_fip
  â”œâ”€â–ºsign
  â”‚   â”œâ”€â–ºsign_bl_pk
  â”‚   â”œâ”€â–ºsign_by_bl_priv(BL2
  â”‚   â”œâ”€â–ºsign_by_bl_priv(MONITOR
  â”‚   â””â”€â–ºsign_by_bl_priv(LOADER_2ND_LOADADDR
  â””â”€â–ºencrypt
      â”œâ”€â–º_aes_encrypt(LOADER_EK, BL_EK)  # (ç§˜é’¥ï¼Œå¾…åŠ å¯†å†…å®¹)
      â”œâ”€â–º_aes_encrypt(BL_EK, BL2)
      â”œâ”€â–º_aes_encrypt(BL_EK, MONITOR)
      â””â”€â–º_aes_encrypt(BL_EK, LOADER_2ND_LOADADDR)
```

------

#### fip æ ¡éªŒæµç¨‹

`fip.bin`  çš„æ ¡éªŒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†ä»£ç æ˜¯ä½äº `ROM` ä¸­ï¼ˆæ²¡æœ‰æƒé™æŸ¥çœ‹ï¼Œåªèƒ½åˆç†çŒœæµ‹ `fsbl` ä¸­ç¼ºå°‘çš„å°±æ˜¯åœ¨ `rom` ä¸­å®Œæˆçš„ï¼‰ï¼šä¸ç”¨çŒœæµ‹ï¼Œæµ‹è¯•å°±è¡Œï¼Œ`ROOT_PK`ï¼Œ`BL_PK`ï¼Œ`BL2`çš„ç­¾åæ ¡éªŒéƒ½æ˜¯åœ¨ `rom code` ä¸­å®Œæˆã€‚~~ä» `efuse` è¯»å– AES ç§˜é’¥ `LOADER_EK`~~ã€‚æ ¡éªŒä¸é€šè¿‡åˆ™ä¸è¿›è¡Œçƒ§å½•ï¼Œç›´æ¥ä» `flash` åŠ è½½ `fsbl`ï¼Œæ—¥å¿—ä¿¡æ¯å¦‚ä¸‹ï¼š

```
C.SCS/3/3.URPL.SDI/25000000/6000000.BS/SD.PS.SD/0x0/0x1000/0x1000/0.VRK4. E:verify root (-14)
 W:DL cancelled. Load flash. (1).
BS/NOR.PS.VRK4.VBK.DK4.VCC.PE.BS.DB2.VB2.BE.J.
FSBL Jb2829:ga05fb6172-dirty:2023-09-19T10:28:45+08:00

C.SCS/3/3.URPL.SDI/25000000/6000000.BS/SD.PS.SD/0x0/0x1000/0x1000/0.VRK4. E:verify bl_pk (-14)
C.SCS/3/3.URPL.SDI/25000000/6000000.BS/SD.PS.SD/0x0/0x1000/0x1000/0.VRK4. E:verify BL2 (-14)
```

è€Œ `FSBL` ä¸­çš„è§£å¯†ã€éªŒç­¾çš„æµç¨‹å¦‚ä¸‹ï¼šåŠ è½½æ—¶ï¼Œæ‰å»è§£å¯† + æ ¡éªŒã€‚

```asciiarmor
 bl2_main
    â”‚
    â””â”€â–ºload_rest
          â”‚
          â”œâ”€â”€â–ºload_blcp_2nd â”€â”€â”€â”
          â”‚                    â”‚
          â”œâ”€â”€â–ºload_monitor â”€â”€â”€â”€â”¼â”€â”€â–ºdec_verify_image
          â”‚                    â”‚       â”‚
          â””â”€â”€â–ºload_loader_2nd â”€â”˜       â”œâ”€â”€â–ºsecurity_is_tee_encrypted
                                       â”‚         â”‚
                                       â”‚         â””â”€â”€â”€â–ºcryptodma_aes_decrypt
                                       â””â”€â”€â–ºverify_rsa
```

### kernel / rootfs çš„ç­¾å

é™¤ `fip.bin` å¤–ï¼Œè¿˜æœ‰ `kernel` çš„äº§ç‰© `boot.xxx` å’Œæ–‡ä»¶ç³»ç»Ÿçš„äº§ç‰© `rootfs.xxx`ã€‚

#### å‡†å¤‡ç§˜é’¥

> 1ï¸âƒ£è¿™é‡Œçš„ç§˜é’¥çš„åç§°ä¸ä¸Šé¢ä¸ä¸€æ ·ï¼Œå› ä¸ºæ˜¯ä¸åŒæ—¶æœŸé’ˆå¯¹ä¸åŒæ¿å­å†™çš„ï¼Œä¸è¿‡é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œåé¢å†è€ƒè™‘ç»Ÿä¸€åç§°ã€‚
> 2ï¸âƒ£è¿™é‡Œæ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼Œæ‰€ä»¥ä¸éœ€è¦ç”Ÿæˆ `AES` ç§˜é’¥ã€‚

| æ–‡ä»¶           | ä½œç”¨                                                                     |
| -------------- | ------------------------------------------------------------------------ |
| NTKC_PRIV.pem  | ç”¨äºç»™ `REE_OS_PK` ç­¾åçš„ç§é’¥ã€‚å…¬é’¥ï¼ˆçš„ `hash` å€¼ï¼‰è¢«çƒ§åˆ° `HASH0_PUBLIC` |
| REEOS_PRIV.pem | ç”¨äºç»™ `boot, rootfs` ç­¾åçš„ç§é’¥                                         |
| boot.crl       | é»‘åå•ï¼Œ`REEOS_PK.pem` ä¸èƒ½æ˜¯ `boot.crl` ä¸­çš„å€¼                          |

å’Œä¸Šé¢ä¸€æ ·ï¼Œä½¿ç”¨ `openssl` ç”Ÿæˆ `2048` ä½çš„ç§˜é’¥ï¼š

```bash
host$ openssl genrsa -out NTKC_PRIV.pem -F4 2048
host$ openssl genrsa -out REEOS_PRIV.pem -F4 2048
```

#### ç­¾åæµç¨‹

ä¸å‰é¢ç›´æ¥å°†ç­¾åä¿¡æ¯ç›´æ¥å†™å…¥åˆ° `fip.bin` ä¸åŒï¼Œå¯¹ `kernel` å’Œ `rootfs` çš„ç­¾åä¸“é—¨ç”Ÿæˆäº†ä¸€ä¸ª `sig.bin` æ–‡ä»¶æ¥å­˜å‚¨ã€‚å…¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå…¬é’¥ã€ç­¾åã€æ–‡ä»¶å¤§å°ä¿¡æ¯ã€‚

> 1ï¸âƒ£åœ¨è¿™é‡Œçš„è®¾è®¡ä¸­ï¼Œæ–‡ä»¶ç³»ç»Ÿ `rootfs` æœ‰ä¸¤ä»½ï¼Œä¸€ä»½å°±æ˜¯æ­£å¸¸å¤§å°çš„ `upgrade`ï¼Œå¦ä¸€ä»½ä¸ºåˆ å‡äº†ä¸€äº›éå¿…è¦æ–‡ä»¶çš„ `minerfs`ã€‚ä¸è¿‡åœ¨åç»­çš„æµç¨‹ä¸­ï¼Œæˆ‘å¹¶æ²¡æœ‰å¯¹ `rootfs` è¿›è¡Œè£å‰ªï¼Œä¹Ÿå°±æ˜¯è¯´ `upgrade == minerfs == rootfs.spinor` ï¼Œå…ˆèµ°é€šæµç¨‹ï¼Œåç»­å†è€ƒè™‘æ˜¯å¦ç²¾ç®€ã€‚
>2ï¸âƒ£åªè¿›è¡Œäº†ç­¾åæ“ä½œï¼Œæ²¡æœ‰è¿›è¡ŒåŠ å¯†ï¼
> 3ï¸âƒ£æ–‡ä»¶å¤§å°ä¿¡æ¯æ˜¯æ¿ç«¯é‡æ–°å¯¹ `kernel/rootfs` è®¡ç®—ç­¾åçš„æ—¶å€™ç”¨åˆ°çš„ã€‚

![å®‰å…¨å¯åŠ¨-sign-boot-rootfs.drawio](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-boot-rootfs.drawio.png)

1. ç”± `NTKC_PRIV.pem` ç§é’¥å¾—åˆ°å…¬é’¥ã€‚ `NTKC_PRIV.pem` çš„å…¬é’¥éœ€è¦è®°å½•åœ¨ `efuse` é‡Œé¢ï¼Œè€Œ `efuse` ç©ºé—´æœ‰é™ï¼Œç­¾å `rsa_hash0.pem` å·²ç»ç”¨äº†ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªå¿…é¡»ç›¸ç­‰ `NTKC_PRIV.pem == rsa_hash0.pem` ã€‚
2. ç”± `REEOS_PRIV.pem` ç§é’¥å¾—åˆ°å…¬é’¥ã€‚è¯¥ç§é’¥æ„Ÿè§‰ä¹Ÿå¯ä»¥ä¸å‰é¢çš„ `bl_priv.pem` ç›¸åŒã€‚
3. ç”¨ `NTKC_PRIV.pem` è®¡ç®— `REEOS_PK.pem` çš„æ•°å­—ç­¾å
4. ç”¨ `NTKC_PRIV.pem` è®¡ç®—æ•°å­—ç­¾åã€‚`boot.crl` æ˜¯ä½œä¸ºé»‘åå•ä½¿ç”¨çš„ï¼Œå³ `REEOS_PK.pem` ä¸èƒ½æ˜¯ `boot.crl` ä¸­çš„å€¼ï¼ˆè¿™é‡Œé¢çš„å€¼æ˜¯å·²ç»æ³„æ¼çš„ç§˜é’¥ï¼‰ã€‚
5. ç”¨ `REEOS_PRIV.pem` è®¡ç®—æ•°å­—ç­¾åã€‚
6. ç”¨ `REEOS_PRIV.pem` è®¡ç®—æ•°å­—ç­¾åã€‚è¿™é‡Œä¸åŒºåˆ† `minerfs/upgrade` ï¼Œéƒ½è®°å½•ä¸º `rootfs` çš„ç­¾åã€‚

å¯¹ `kernel` å’Œ `rootfs` çš„ç­¾åçš„å®ç°æ˜¯åœ¨ `make_sig_img.sh` è¿™ä¸ªè„šæœ¬ä¸­ï¼š

```bash
#!/bin/bash

set -e -o pipefail

SIG_TMP_PATH="${BUILD_PATH}/tools/common/sign_tools/sig_files"
NTKC_PRIV_PATH="${BUILD_PATH}/tools/common/sign_tools/NTKC_PRIV.pem"
REEOS_PRIV_PATH="${BUILD_PATH}/tools/common/sign_tools/REEOS_PRIV.pem"
BOOT_CRL_PATH="${BUILD_PATH}/tools/common/sign_tools/boot.crl"

# sig.bin ä¸­ä¸åŒéƒ¨åˆ†çš„åˆ†å‰²ç¬¦
SIG_IMG_SEP=$(printf '\xe8\x6c\xdc\x26\x7b\xcb\xf6\x4b\x8d\xd8\xa2\x2c\x86\xa6\x58\x73\xf9\x42\xbc\x3a\x70\x58\x02\x43\xbe\x79\x56\x66\x23\x2a\x0a\x7e')

function int_to_bytes()
{
    python3 -c 'import sys; sys.stdout.buffer.write(int(sys.argv[1]).to_bytes(4, "little"))' $1
}

# create sig.bin
function make_sig_img()
(
    # è¿™é‡Œé¡ºåºè¦å’Œ u-boot ä¸­ cvi_verify.c ä¸­å¯¹åº”
    echo "${FUNCNAME[0]}()"
    {
        cat $SIG_TMP_PATH/NTKC_PK.pem
        printf '%s' "$SIG_IMG_SEP"
        cat $SIG_TMP_PATH/REEOS_PK.pem
        printf '%s' "$SIG_IMG_SEP"
        cat "${BOOT_CRL_PATH}"
        printf '%s' "$SIG_IMG_SEP"
        cat $SIG_TMP_PATH/REEOS_PK.pem.sig
        printf '%s' "$SIG_IMG_SEP"
        cat $SIG_TMP_PATH/boot.crl.sig
        printf '%s' "$SIG_IMG_SEP"
        cat $SIG_TMP_PATH/boot.$STORAGE_TYPE.sig
        printf '%s' "$SIG_IMG_SEP"
        cat $SIG_TMP_PATH/minerfs.sig
        printf '%s' "$SIG_IMG_SEP"
        cat $SIG_TMP_PATH/upgrade.sig
        printf '%s' "$SIG_IMG_SEP"
        int_to_bytes "$(stat -c '%s' $OUTPUT_DIR/rawimages/boot.$STORAGE_TYPE)"
        int_to_bytes "$(stat -c '%s' $OUTPUT_DIR/rawimages/rootfs.$STORAGE_TYPE)"
        int_to_bytes "$(stat -c '%s' $OUTPUT_DIR/rawimages/rootfs.$STORAGE_TYPE)"
        printf '%s' "$SIG_IMG_SEP"
    } > "$OUTPUT_DIR/rawimages/sig.bin"

    # åœ¨æ–‡ä»¶ sig.bin å‰é¢åŠ ä¸Šä¸€æ®µå‰ç¼€å­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæ˜¯ cvitek çš„é•œåƒ
    python3 "$BUILD_PATH/tools/common/image_tool/raw2cimg.py" "$OUTPUT_DIR/rawimages/sig.bin" "$OUTPUT_DIR" "$FLASH_PARTITION_XML"
    echo "Save to $OUTPUT_DIR/sig.bin"
)

# å¯¹é•œåƒç”¨ç§é’¥è¿›è¡ŒåŠ å¯†ã€ç­¾å
function sign_image()
(
    echo "${FUNCNAME[0]}()"
    # ç”±ç§é’¥å¾—åˆ°å…¬é’¥
    openssl rsa -in ${NTKC_PRIV_PATH} -pubout -out "$SIG_TMP_PATH/NTKC_PK.pem"
    openssl rsa -in ${NTKC_PRIV_PATH} -pubout -outform DER | sha256sum > "$SIG_TMP_PATH/NTKC_PK.der.sha256"
    openssl rsa -in "${REEOS_PRIV_PATH}" -pubout -out "$SIG_TMP_PATH/REEOS_PK.pem"

    # ç”Ÿæˆæ•°å­—ç­¾å
    openssl dgst -sha256 -sign ${NTKC_PRIV_PATH} -out "$SIG_TMP_PATH/REEOS_PK.pem.sig" "$SIG_TMP_PATH/REEOS_PK.pem"
    openssl dgst -sha256 -sign ${NTKC_PRIV_PATH} -out "$SIG_TMP_PATH/boot.crl.sig" ${BOOT_CRL_PATH}

    openssl dgst -sha256 -sign "${REEOS_PRIV_PATH}" -out "$SIG_TMP_PATH/boot.$STORAGE_TYPE.sig" "$OUTPUT_DIR/rawimages/boot.$STORAGE_TYPE"
    # è¿™é‡Œæ²¡æœ‰åŒºåˆ† upgrade/minerfsï¼Œæš‚æ—¶ä¸ç¡®å®šæ˜¯å¦éœ€è¦åŒºåˆ†ï¼Œæ‰€ä»¥ä¿ç•™ä¸¤ä¸ª
    openssl dgst -sha256 -sign "${REEOS_PRIV_PATH}" -out "$SIG_TMP_PATH/minerfs.sig" "$OUTPUT_DIR/rawimages/rootfs.$STORAGE_TYPE"
    openssl dgst -sha256 -sign "${REEOS_PRIV_PATH}" -out "$SIG_TMP_PATH/upgrade.sig" "$OUTPUT_DIR/rawimages/rootfs.$STORAGE_TYPE"
    echo "sign_image done!"
)

mkdir -p "$SIG_TMP_PATH"
(
    cd "$SIG_TMP_PATH"
    echo "Clear $SIG_TMP_PATH"
    rm -f ./*
)

echo "start sign"
sign_image
make_sig_img
```

#### æ ¡éªŒæµç¨‹

1. è®¡ç®— `sig.bin` ä¸­ `NTKC_PK.pem` çš„æ•£åˆ—å€¼ï¼Œä¸ `efuse` ä¸­å­˜å‚¨çš„æ•£åˆ—å€¼å¯¹æ¯”ï¼Œå¦‚æœç›¸åŒåˆ™è¯´æ˜ `NTKC_PK.pem` å¯ä¿¡ã€‚
2. åˆ©ç”¨ `NTKC_PK.pem` è®¡ç®— `REEOS_PK.pem` çš„æ•°å­—ç­¾åï¼Œå’Œ `REEOS_PK.pem.sig` å¯¹æ¯”ï¼Œç›¸åŒåˆ™è¯´æ˜ `REEOS_PK.pem` å¯ä¿¡ã€‚
3. åˆ©ç”¨ `REEOS_PK.pem` ä¸º `boot / rootfs` è®¡ç®—æ•°å­—ç­¾åï¼Œå¹¶ä¸å¯¹åº”çš„ `.sig` å¯¹æ¯”ï¼Œç›¸åŒåˆ™è¯´æ˜å¯¹åº”çš„æ–‡ä»¶æ²¡æœ‰è¢«ç¯¡æ”¹ï¼Œå¯ä¿¡ã€‚
4. æ ¡éªŒå®Œæ¯•ï¼Œå¯ä»¥æ­£å¸¸å¯åŠ¨ `kernel` äº†ã€‚

## æ³¨æ„äº‹é¡¹

### 1ï¸âƒ£ä½¿ç”¨æ³¨æ„

1. **é…ç½®å‚æ•°**ï¼Œ`fip.bin` çš„åŠ å¯†é€šè¿‡è®¾ç½®é…ç½®é€‰é¡¹ `CONFIG_FSBL_SECURE_BOOT_SUPPORT=y` å¯ç”¨ï¼Œè€Œ `kernel` å’Œ `rootfs` åˆ™æ˜¯é€šè¿‡ç¯å¢ƒå˜é‡ `UBOOT_VBOOT=1` æ¥å¯ç”¨ã€‚åˆ†å¼€é…ç½®æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºç¬¬ä¸€æ¬¡éœ€è¦æœªåŠ å¯†çš„ `fip.bin` æ¥å®ç°çƒ§å†™ `efuse`ï¼Œåœ¨ `efuse` è¿˜æœªçƒ§å†™çš„æƒ…å†µä¸‹ï¼ŒåŠ å¯†äº†çš„ `fip.bin` æ— æ³•åŠ è½½ã€‚
2. **ä¿®æ”¹** `partition.xml`ï¼Œå…¶å®å°±æ˜¯å¢åŠ ä¸€é¡¹ `sig.bin`ï¼Œéœ€è¦æ³¨æ„å…¶å¤§å°å¯¹é½ï¼Œå…·ä½“å¤§å°è¦çœ‹å¯¹åº” `flash` æ•°æ®æ‰‹å†Œï¼Œä¸è¿‡ä¸€èˆ¬ä¸º `64k/128k`ã€‚
3. **ä¿®æ”¹** `cv18xx-asic.h`ï¼Œåœ¨ `uboot`å¯åŠ¨ `kernel` ä¹‹å‰ï¼Œéœ€è¦å…ˆå¯¹ `kernel` å’Œ `rootfs` è¿›è¡Œç­¾åæ ¡éªŒï¼Œè€Œè¿™ä¸€è¿‡ç¨‹éœ€è¦å…ˆå°†å¯¹åº”çš„å†…å®¹ä» `flash` è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç›®å‰åªæµ‹è¯•äº† `spinor/spinand`ï¼Œ`emmc` è¿˜æœªæµ‹è¯•ã€‚**å¦å¤–æ³¨æ„**ï¼šè¯»å–æ—¶å„ä¸ªåˆ†åŒºå æ®çš„å†…å­˜ä¸è¦é‡å ï¼Œåˆ†åŒºçš„å¤§å°æœ€å¥½ä¸ `partition.xml` ä¸­ä¸€è‡´ã€‚

### 2ï¸âƒ£raw2cimg.py

åœ¨æˆ‘ä»¬çš„ç¼–è¯‘æµç¨‹ä¸­ï¼Œç¼–è¯‘å¾—åˆ°çš„åŸå§‹æ–‡ä»¶æ¯”å¦‚ `boot.spinand`ï¼Œ `rootfs.spinor` ç­‰æ˜¯æ”¾åœ¨ `$OUTPUT_DIR/rawimages` ç›®å½•ä¸‹çš„ï¼Œä¸è¿‡ç¼–è¯‘æµç¨‹ä¸­è¿˜ä¼šè°ƒç”¨ `raw2cimg.py` å¯¹è¿™äº›äºŒè¿›åˆ¶æ–‡ä»¶åŠ ä¸Šä¸€æ®µå‰ç¼€`Header`ï¼Œ`upgrade.zip` ä¸­æ‰“åŒ…çš„ä¹Ÿæ˜¯è¿™äº›æ·»åŠ "`header`"åçš„æ–‡ä»¶ã€‚

```bash
$ hexdump sig.bin
0000000 4943 474d 0001 0000 0040 0000 0001 0000
0000010 0bb5 0000 6973 0067 0000 0000 0000 0000
0000020 0000 0000 0000 0000 0000 0000 0000 0000
*
0000040 0001 0000 0b75 0000 0000 00b2 0000 0002
0000050 dd1b 0ee4 0000 0000 0000 0000 0000 0000
0000060 0000 0000 0000 0000 0000 0000 0000 0000
*
0000080 2d2d 2d2d 422d 4745 4e49 5020 4255 494c # è¿™ä¸€è¡Œå¼€å§‹æ˜¯æ­£å¼å†…å®¹
0000090 2043 454b 2d59 2d2d 2d2d 4d0a 4949 4942
```

~~é—®é¢˜åœ¨äºğŸ’¢ï¼šå‰é¢ `sig.bin` ä¸­ä½¿ç”¨çš„æ˜¯ `rawimages` ä¸‹çš„æ–‡ä»¶ç”Ÿæˆçš„ç­¾åï¼Œè€Œçƒ§å†™åˆ° `flash` çš„æ˜¯å¢åŠ äº†ä¸€æ®µå‰ç¼€åçš„æ–‡ä»¶ï¼Œä¸¤ä¸ªæ–‡ä»¶æœ‰å·®å¼‚ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œ `kernel` å’Œ `rootfs` ç­¾åæ ¡éªŒçš„æ—¶å€™ï¼Œåº”è¯¥æ— æ³•é€šè¿‡æ‰å¯¹â—ğŸ’¢ğŸ’¢ä½†å®ƒç¡®å®èƒ½é€šè¿‡æ ¡éªŒï¼Œå¹¶ä¸”ä½¿ç”¨ `rawimages` ä¸‹çš„æ–‡ä»¶åè€Œæ— æ³•é€šè¿‡ğŸ¤¦â€â™‚ï¸ä¹Ÿæ²¡æœ‰æ‰¾åˆ°å“ªé‡Œæœ‰å¯¹å‰ç¼€è¿›è¡Œè£å‰ªä¹‹ç±»çš„ä»£ç ğŸ¤¦â€â™‚ï¸ğŸ¤¦â€â™‚ï¸ğŸ¤¦â€â™‚ï¸~~ã€‚

**æ˜¯åœ¨çƒ§å½•çš„è¿‡ç¨‹ä¸­å°±è¿›è¡Œäº†è£å‰ª**ã€‚åœ¨ `cvi_update` è¿‡ç¨‹ä¸­ï¼Œä¼šæ£€æŸ¥å„ä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨ `Header`ï¼Œå¦‚æœä¸å­˜åœ¨æˆ–è€…ä¸ä¸€è‡´ï¼Œä¼šæ— æ³•çƒ§å½•åˆ° `flash`ã€‚æ­¤å¤–ï¼Œåœ¨å®é™…çƒ§å½•æ—¶ä¹Ÿä¼šè£å‰ªæ‰ `header`ã€‚

```asciiarmor
 do_cvi_update
     â”‚
     â””â–º_storage_update
          â”‚
          â””â”€â–º_checkHeader
               â”‚
               â”œâ”€â”€â–ºuint32_t pos = HEADER_SIZE;
               â””â”€â”€â–ºsnprintf(cmd, 255, "fatload %s %p %s 0x%x 0x%x;", strStorage,
                   			 (void *)UPDATE_ADDR, file, load_size, pos);
```

ä½¿ç”¨æœªæ·»åŠ  `Header` çš„ `sig.bin`ï¼Œ`boot.spinor`ï¼Œ`rootfs.spinor` çƒ§å½•çš„æ—¶å€™ï¼Œä¼šæç¤ºä¸‹é¢çš„é”™è¯¯ï¼š

```
File:sig.bin Magic number is wrong, skip it
File:rootfs.spinor Magic number is wrong, skip it
```

### 3ï¸âƒ£çƒ§å½• efuse

ç›®å‰æ˜¯å°†çƒ§å½• `efuse` çš„æµç¨‹æ˜¯ç»‘å®šåœ¨å¯¹ `kernel` ç­¾åçš„ã€‚åªè¦å¯ç”¨äº† `UBOOT_VBOOT=1`ï¼Œå¯åŠ¨è¿‡ç¨‹ä¸­å°±ä¼šæ£€æŸ¥æ˜¯å¦è®¾ç½®äº†å®‰å…¨å¯åŠ¨ï¼ˆé€šè¿‡è¯»å– `efuse` çš„æ•°æ®åˆ¤æ–­ï¼‰ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®å°±ä¼šçƒ§å†™ `efuse`ï¼ŒåŒ…æ‹¬ `HASH0_PUBLIC` å’Œ `loader_ek`ã€‚

å¦‚æœæ¯æ¬¡ç¼–è¯‘çš„ `boot.xxx` éƒ½å¸¦æœ‰è¿™äº›ä¿¡æ¯ï¼Œå®¹æ˜“å¯¼è‡´ç§˜é’¥æ³„æ¼ã€‚å‰è€…æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºçƒ§å†™åˆ° `efuse` çš„æ˜¯å…¬é’¥ï¼Œå³ä½¿çŸ¥é“å…¬é’¥ä¹Ÿæ¨ä¸å‡ºç§é’¥ã€‚ä¸è¿‡åè€…æ˜¯ `AES` æ˜æ–‡çš„ç§˜é’¥ï¼Œå­˜åœ¨éšæ‚£ã€‚~~æ‰€ä»¥ï¼Œåœ¨éå¿…è¦çš„æ—¶å€™åº”è¯¥æ³¨é‡Šæ‰ç›¸å…³å†…å®¹~~ã€‚å·²å¢åŠ é…ç½®ç¯å¢ƒå˜é‡ `UBOOT_WRITE_EFUSE=1` æ¥æ§åˆ¶ã€‚

### â­æ›´æ–°

ç”±äºå®¢æˆ·è¦æ±‚ï¼Œåªç­¾åï¼Œä¸å¯¹ `fip.bin` è¿›è¡ŒåŠ å¯†ï¼Œå¸Œæœ›èƒ½ä»¥å®è¿›è¡Œæ§åˆ¶ï¼Œå› æ­¤éœ€è¦å¯¹éƒ¨åˆ†ä»£ç è¿›è¡Œæ›´æ–°ã€‚

1. ä½¿ç”¨ç¯å¢ƒå˜é‡ `ONLY_SIGN_FIP=1` æ¥è¡¨ç¤ºä»…å¯¹ `fip.bin` è¿›è¡Œç­¾åï¼Œæœªè®¾ç½®æˆ–è®¾ç½®ä¸º0è¡¨ç¤ºç­¾å+åŠ å¯†ã€‚
2. ä»£ç ä¸»è¦æ›´æ–°ï¼š
    1. ç¼–è¯‘æµç¨‹ä¸­ `fip_v2.mk` è°ƒç”¨ `fipsign.py` ä¹‹å‰æ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚
    2. ç¼–è¯‘æµç¨‹ä¸­ `build/Makefile` å°† `loader_ek` å¤åˆ¶åˆ° `uboot` ç›®å½•ä¸‹çš„è¿‡ç¨‹ï¼Œéœ€è¦å…ˆæ£€æŸ¥ç¯å¢ƒå˜é‡ã€‚
    3. `efuse.c` ä¸­çƒ§å†™ `efuse` æ—¶ï¼Œæ£€æŸ¥ç¯å¢ƒå˜é‡ï¼Œä¸çƒ§å†™ `loader_ek`ã€‚
    4. åœ¨ `uboot/*/cvitek.mk` ä¸­è¿˜è¦å¢åŠ  `-DONLY_SIGN_FIP`ï¼Œè¿™æ ·æ‰èƒ½å½±å“åˆ° `efuse.c` ä¸­çš„ä»£ç ã€‚

### 4ï¸âƒ£ä½¿ç”¨æ–¹æ³•

1. å‡†å¤‡ä»¥ä¸‹å‡ ä¸ªç§˜é’¥æ–‡ä»¶ï¼Œå¦‚ä½•ç”Ÿæˆç§˜é’¥å¯ä»¥çœ‹å‰é¢çš„ä»‹ç»ã€‚

    | fip.bin       | kernel/rootfs  |                                                                                   |
    | ------------- | -------------- | --------------------------------------------------------------------------------- |
    | rsa_hash0.pem | NTKC_PRIV.pem  | ç”¨äºç»™ `bl_priv.pem` ç­¾åçš„ `RSA` ç§é’¥ï¼Œå…¬é’¥ï¼ˆçš„ `hash` å€¼ï¼‰è¢«çƒ§åˆ° `HASH0_PUBLIC` |
    | bl_priv.pem   |                | ç”¨äºç»™ `fsbl/opensbi/u-boot` ç”Ÿæˆç­¾åçš„ `RSA` ç§é’¥                                |
    | loader_ek.key |                | ç”¨äºç»™ `bl_ek.key` åŠ ã€è§£å¯†çš„ `AES` ç§˜é’¥ï¼Œä¹Ÿä¼šè¢«çƒ§å†™åˆ° `eFuse`                    |
    | bl_ek.key     |                | ç”¨äºç»™ `fsbl/opensbi/u-boot` åŠ ã€è§£å¯†çš„ `AES` ç§˜é’¥                                |
    |               | REEOS_PRIV.pem | ç”¨äºç»™ `boot, rootfs` ç­¾åçš„ç§é’¥                                                  |
    |               | boot.crl       | é»‘åå•ï¼Œ`REEOS_PK.pem` ä¸èƒ½æ˜¯ `boot.crl` ä¸­çš„å€¼ï¼Œ**ä¸èƒ½ä¸ºç©ºæ–‡ä»¶**                 |

2. åœ¨ä¸€ä¸ªç©ºç™½çš„æ¿å­ä¸Šï¼Œæ­¤æ—¶æ¿å­çš„ `efuse` è¿˜æ²¡æœ‰å†™è¿‡ï¼Œé¦–å…ˆéœ€è¦çƒ§å†™ `efuse`ï¼Œæ­¤æ—¶ä¸èƒ½åŠ å¯† `fip.bin`ã€‚

    `export UBOOT_VBOOT=1 UBOOT_WRITE_EFUSE=1; source build/xxx`

3. **å®Œæˆçƒ§å½•åï¼Œæ‹”å¡ï¼Œé‡æ–°ä¸Šç”µ**ï¼Œæ‰ä¼šè¿›è¡Œ `efuse` çš„çƒ§å†™ã€‚

4. çƒ§å†™å®Œæ¯•ï¼Œåç»­ç¼–è¯‘çš„é•œåƒå°±å¿…é¡»å¯¹ `fip.bin` è¿›è¡ŒåŠ å¯†äº†ï¼Œå¦åˆ™æ— æ³•çƒ§å½•ã€‚
    å®Œæˆçƒ§å½•åï¼Œä¹Ÿä¸è¦å†ä½¿ç”¨ `UBOOT_WRITE_EFUSE=1`ï¼Œå¦åˆ™ `boot.xxx` ä¸­ä¼šå¸¦æœ‰ `loader_ek.key` çš„æ˜æ–‡ï¼Œå®¹æ˜“å¯¼è‡´ç§˜é’¥æ³„æ¼ã€‚

    `export UBOOT_VBOOT=1; source build/xxx`ï¼Œå†é€šè¿‡ `menuconfig` å¯ç”¨ `CONFIG_FSBL_SECURE_BOOT_SUPPORT`(è¿™ä¸ªå¯ä»¥å†™åœ¨å¯¹åº”æ¿å¡ç›®å½•ä¸‹çš„ xxx_defconfig æ–‡ä»¶ä¸­ )

## å¸¸è§é—®é¢˜

1. ç§˜é’¥éƒ½æ˜¯å†™åœ¨ efuse ä¸­çš„ï¼Œé‚£åˆ«äººå²‚ä¸æ˜¯å¯ä»¥ç›´æ¥è¯» efuse è·å–åˆ°ç§˜é’¥ï¼Ÿè¿™æ ·ä¸å¾ˆå®¹æ˜“ç ´è§£å—ï¼Ÿ

   > efuse ä¸­å­˜äº†ä¸¤ä¸ªç§˜é’¥ï¼š
   >
   > 1. HASH0_PUBLIC åŒºå­˜æ”¾çš„ RSA ç®—æ³•çš„å…¬é’¥çš„ sha256 å“ˆå¸Œå€¼ã€‚
   > 2. LOADER_EK åŒºå­˜æ”¾çš„ AES çš„ç§˜é’¥ã€‚
   >
   > æ­£å¸¸æƒ…å†µä¸‹æ˜¯å¯è¯»å†™çš„ï¼Œä¸è¿‡çƒ§å†™ä¸‹é¢ä¸¤ä¸ªå­—æ®µï¼Œå°±å¯ä»¥ç¦ç”¨å¯¹åº”åŒºåŸŸçš„è¯»å†™ã€‚[see doc](https://doc.sophgo.com/cvitek-develop-docs/master/docs_latest_release/CV180x_CV181x/zh/01.software/BSP/eFuse_User_Guide/build/html/2_eFuse_User_Guide/eFuse_Overview.html)
   >
   > | LOCK_LOADER_EK | é”å®šå®‰å…¨å¯åŠ¨AESåŠ å¯†å¯†é’¥åŒºåŸŸï¼Œè®©æ­¤åŒºåŸŸæ— æ³•è¯»å†™ |
   > | -------------- | --------------------------------------------- |
   > | LOCK_DEVICE_EK | é”å®šDEVICE_EKï¼Œè®©æ­¤åŒºåŸŸæ— æ³•è¯»å†™               |
   >
   > **é‚£å¦‚æœä¸èƒ½è¯»å†™ï¼Ÿå¯åŠ¨è¿‡ç¨‹åˆæ˜¯æ€ä¹ˆéªŒç­¾å’Œè§£å¯†çš„å‘¢ï¼Ÿ**
   >
   > è¿™ä¸¤ä¸ªç§˜é’¥çš„å†…å®¹æ˜¯åœ¨ rom code ä¸­è¯»å–çš„ï¼Œrom code æœ‰ç‰¹æƒå§ã€‚efuse åŒºåˆ†å®‰å…¨ä»‹é¢å’Œéå®‰å…¨ä»‹é¢ï¼Œé”è¯»å†™åªæ˜¯éå®‰å…¨ç•Œé¢çš„è¯»å†™ï¼Œå®‰å…¨ç•Œé¢è‡³å°‘èƒ½è¯»ã€‚

2. ~~fip çš„ç­¾åæ ¡éªŒéƒ½æ˜¯åœ¨ fsbl ä¸­å®Œæˆ~~ï¼Œå¦‚æœèƒ½è·å¾— fsbl çš„æºç ï¼Œä¿®æ”¹åèƒ½è·³è¿‡ç­¾åæ ¡éªŒè¿‡ç¨‹å—ï¼Ÿ

   > çœ‹ [fip æ ¡éªŒæµç¨‹](#fip æ ¡éªŒæµç¨‹) ï¼Œåœ¨ rom code ä¸­ä¼šé¦–å…ˆå¯¹ fip è¿›è¡Œæ ¡éªŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä½ èƒ½ä¿®æ”¹ fsbl çš„æµç¨‹ï¼Œä½†æ²¡æœ‰ RSA ç§˜é’¥ï¼Œæ— æ³•å¯¹ fip è¿›è¡Œç­¾åï¼Œé‚£ä¹ˆåœ¨ rom code é˜¶æ®µå°±è¢«å¡ä½äº†ã€‚
   >
   > å¦‚æœç§˜é’¥éƒ½æ³„æ¼äº†ï¼Œé‚£æ”¹ä¸æ”¹ fsbl çš„æµç¨‹éƒ½ä¸€æ ·äº†ã€‚

3. å…¬é’¥ä¸å°å¿ƒæ³„æ¼äº†ï¼Œèƒ½è¢«äººåˆ©ç”¨å—ï¼Ÿå‰é¢ä»‹ç»çš„å…¬é’¥æ˜¯ç›´æ¥å­˜æ”¾åœ¨ fip.bin ä¸­çš„ï¼Œfip.bin æœ¬èº«åˆä¸å¤§ï¼ŒçŸ¥é“å…¬é’¥çš„ä½æ•°ï¼Œæ€»èƒ½ç©·ä¸¾å‡ºæ¥å§ã€‚

   > é™¤äº†ç©·ä¸¾ï¼Œè¿˜å¯ä»¥éšä¾¿åˆ›å»ºä¸€ä¸ªå…¬é’¥ç§é’¥ï¼Œç”¨ç§é’¥ç­¾å `fip.bin` ç„¶åæŸ¥çœ‹å…¬é’¥å¯¹åº” `fip.bin` ä¸­çš„åç§»é‡ã€‚ä¸å°±å¯ä»¥çŸ¥é“ä»»æ„ä¸€ä¸ª `fip.bin` ä¸­çš„å…¬é’¥äº†å—ï¼Ÿ
   >
   > å‡è®¾å·²ç»çŸ¥é“äº†å…¬é’¥ï¼Œrom code é‡Œé¢å¦‚æœä»…ä»…å¯¹å…¬é’¥æœ¬èº«è¿›è¡Œäº†æ ¡éªŒï¼Œé‚£ä¹Ÿå°±æ˜¯è¯´æˆ‘å¯ä»¥ä½¿ç”¨è‡ªå·±ç¼–è¯‘çš„ä¸€ä¸ª fip.binï¼Œæ›¿æ¢é‡Œé¢çš„å…¬é’¥ï¼Œå°±å¯ä»¥è¿›å…¥ fsbl é˜¶æ®µäº†ã€‚é‚£æˆ‘å²‚ä¸æ˜¯å¯ä»¥ä¿®æ”¹ fsblï¼Œè·³è¿‡ç­¾åã€è§£å¯†çš„è¿‡ç¨‹ï¼Ÿè¿™ä¸å°±ç ´è§£äº†ï¼Ÿï¼Ÿï¼Ÿubootå°±å¯ä»¥çƒ§å½•ä»»ä½•å›ºä»¶äº†.... ï¼Ÿï¼Ÿï¼Ÿ
   >
   > ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡ğŸ‘‡
   >
   > å…¬é’¥ç¡®å®å®¹æ˜“è·å–ï¼ŒæŸ¥çœ‹ `fiptool.py` å¯ä»¥çœ‹åˆ° `ROOT_PK` åœ¨ `fip.bin` ä¸­çš„åç§»é‡ä¸º `0X400`ã€‚ä¸è¿‡è¿™å¹¶æ²¡æœ‰å®‰å…¨é£é™©ã€‚å› ä¸ºç›®å‰æ˜¯ä¸€çº§ä¸€çº§æ ¡éªŒçš„ã€‚
   >
   > - `rom code` ä¸­ä¼šæ ¡éªŒ `BL2(FSBL)` çš„ç­¾åï¼Œä¿è¯äº† `FSBL` æ— æ³•è¢«ç¯¡æ”¹ã€‚æˆ–è€…è¯´ç¯¡æ”¹åçš„ `FSBL` æ— æ³•é€šè¿‡ `ROM` çš„æ ¡éªŒã€‚*å¯¹åº”ä¸‹å›¾ä¸­çš„ 2,4,5,6 æ­¥*ã€‚
   > - `FSBL` ä¸­æ ¡éªŒ `UBOOT`ï¼Œä¹Ÿå°±ä¿è¯äº† `uboot` æ— æ³•è¢«ç¯¡æ”¹ã€‚*å¯¹åº”ä¸‹å›¾ä¸­çš„ 7,8 æ­¥*ã€‚
   > - `uboot` æ ¡éªŒ `kernel/rootfs`ï¼Œä¿è¯äº†å®ƒä»¬æ— æ³•è¢«ç¯¡æ”¹ã€‚
   >
   > ![å®‰å…¨å¯åŠ¨-sign-enc-fip.drawio](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-enc-fip.drawio.png)
   >
   > å›åˆ°ä¸Šé¢çš„é—®é¢˜ï¼Œ`rom` ä¸­å¹¶ä¸æ˜¯åªæ ¡éªŒäº† `ROOT_PK`ï¼Œè€Œæ˜¯æ ¡éªŒäº† `bl2` çš„ç­¾åã€‚å³ä½¿ `root pk` æ³„éœ²äº†ï¼Œä¹Ÿä¸ä¼šå½±å“ `bl2` çš„ç­¾åæ ¡éªŒï¼ˆè¿™éœ€è¦ root å’Œ bl çš„ç§é’¥ï¼‰ã€‚ä¸å­˜åœ¨å®‰å…¨é£é™©ã€‚
   >
   > å¦ä¸€æ–¹é¢ï¼Œç›®å‰ `kernel` å’Œ `rootfs` çš„æ ¡éªŒåšçš„ä¸å¤ªå¥½ï¼Œç†è®ºä¸Š `uboot` é˜¶æ®µå»æ ¡éªŒ `kernel` å’Œ `rootfs` çš„ç­¾åæ—¶ï¼Œåº”è¯¥ä½¿ç”¨æ–°çš„ç§˜é’¥ï¼Œè€Œä¸æ˜¯ `root pk`ã€‚ä¹Ÿå°±æ˜¯ `NTKC_PRIV.pem` çš„å…¬é’¥ä¹Ÿå¯ä»¥è®°å½•åœ¨ `fip.bin` ä¸­ï¼Œ`fsbl` ä¸­å¯¹ `uboot` éªŒç­¾çš„æ—¶å€™ï¼Œç”¨ `bl_pk` å¯¹ `sig.bin` è¿›è¡ŒéªŒç­¾ï¼Œä¹Ÿå°±æ˜¯å°† `sig.bin` ä¸­çš„ `NTKC_PK.pem` æ¢ä¸º `bl_pk`ï¼Œè¿™æ ·å°±æ˜¯ä¸€å±‚ä¸€å±‚çš„ä¾èµ–å…³ç³»ã€‚è€Œä¸æ˜¯ç°åœ¨ `uboot` ç›´æ¥ç”¨ `root` çš„å…¬é’¥ã€‚ã€‚ä¸è¿‡ä¹Ÿè¿˜å¥½ï¼Œå½±å“ä¸å¤§ã€‚
   >
   > ![å®‰å…¨å¯åŠ¨-sign-boot-rootfs.drawio](../images/Cvitek-%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8/%E5%AE%89%E5%85%A8%E5%90%AF%E5%8A%A8-sign-boot-rootfs.drawio.png)

4. **å®‰å…¨å¯åŠ¨çš„æ„ä¹‰**

   > - é˜²æ­¢ç”¨æˆ·çƒ§å½•æœªç»æˆæƒçš„å›ºä»¶ã€‚ï¼ˆç­¾åï¼‰
   >
   >     > å¯ç”¨å®‰å…¨å¯åŠ¨ä¹‹åï¼Œåªèƒ½çƒ§å½•ç­¾ååçš„å›ºä»¶ã€‚
   >
   > - é˜²æ­¢é€šè¿‡å›ºä»¶æ‹·è´ï¼Œæ¥æŠ„è¢­äº§å“ã€‚ï¼ˆç­¾å+åŠ å¯†ï¼‰
   >
   >     > A å–èŠ¯ç‰‡ï¼Œæä¾› SDKã€‚
   >     >
   >     > B ä¹°èŠ¯ç‰‡ï¼Œç”»æ¿å­ï¼Œç”¨ A æä¾›çš„ èŠ¯ç‰‡ + SDK åšäº§å“å–ã€‚
   >     >
   >     > C æŠ„ B çš„æ¿å­ï¼Œå¹¶ç›´æ¥æ‹· B `flash` ä¸­çš„å›ºä»¶ï¼Œå†ä¹° A çš„åŒæ¬¾èŠ¯ç‰‡ã€‚ç†è®ºä¸Šç”¨å¾ˆä½çš„æˆæœ¬å°±å®Œæˆäº†å¯¹ B äº§å“çš„å®Œå…¨å¤åˆ¶ã€‚
   >     >
   >     > å¦‚ä½•é¿å…å‘¢ï¼Ÿ
   >     >
   >     > 1. å®‰å…¨å¯åŠ¨ï¼ˆä»…ç­¾åï¼‰ï¼ŒC çš„è§†è§’æ¥çœ‹ï¼Œå›ºä»¶æœ‰äº†ï¼Œé—®é¢˜åœ¨äºèŠ¯ç‰‡ä¸Šçš„ `efuse` çƒ§å†™ã€‚ä¸è¿‡ä»…ç­¾åçš„è¯ï¼Œåªä¼šç”¨åˆ° `root_pk`ï¼Œè€Œè¿™æ˜¯å¯ä»¥ä»å›ºä»¶ `fip.bin` ä¸­è·å¾—çš„ã€‚å› æ­¤ `C` è¿˜æ˜¯å¯ä»¥æŠ„è¢­ã€‚
   >     > 2. å®‰å…¨å¯åŠ¨ï¼ˆç­¾å + åŠ å¯†ï¼‰ï¼ŒC çš„è§†è§’æ¥çœ‹ï¼Œå›ºä»¶æœ‰äº†ï¼Œè¿˜å·® `LOADER_EK`ï¼Œè€Œè¿™æ— æ³•è¯»å–ã€‚å› æ­¤ï¼Œæ— æ³•æŠ„è¢­ã€‚

5. ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œè¿˜æœ‰ä¸€ä¸ªå…³é”®åœ¨äº `efuse` ä¸­çš„ `AES` ç§˜é’¥ï¼Œç»ä¸èƒ½è¢«çªƒå–ã€‚å¦‚ä½•å®ç°å‘¢ï¼Ÿå®‰å…¨ä»‹é¢å’Œéå®‰å…¨ä»‹é¢

   >

## ç›¸å…³èµ„æ–™

- [å®‰å…¨å¯åŠ¨ä½¿ç”¨æŒ‡å—](https://doc.sophgo.com/cvitek-develop-docs/master/docs_latest_release/CV180x_CV181x/zh/01.software/BSP/Secure_Boot_User_Guide/build/html/3_Secure_Image_Generation.html)
- [eFuse ä½¿ç”¨æŒ‡å—](https://doc.sophgo.com/cvitek-develop-docs/master/docs_latest_release/CV180x_CV181x/zh/01.software/BSP/eFuse_User_Guide/build/html/index.html)
- [å›¾è§£|ä»€ä¹ˆæ˜¯ RSA ç®—æ³•](https://cloud.tencent.com/developer/article/1693368)
- [ç›˜ç‚¹äº”ç§æœ€å¸¸è§åŠ å¯†ç®—æ³•ï¼](https://mp.weixin.qq.com/s/XBYJFZ2jRF2slrlym3svQw)
- [å¯†ç å­¦åŸºæœ¬æ¦‚å¿µ](https://mp.weixin.qq.com/s/Hu1VBMSHh82n6bujWxr9nw)
