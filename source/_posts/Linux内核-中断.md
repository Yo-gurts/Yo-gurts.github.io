---
title: Linux å†…æ ¸-ä¸­æ–­
top_img: transparent
date: 2023-08-29 14:49:35
updated: 2023-08-29 14:49:35
tags:
  - Linux
categories: Linux
keywords:
description:
---

## Linux å†…æ ¸ â€” ä¸­æ–­

## ä»€ä¹ˆæ˜¯ä¸­æ–­

> æœ¬èŠ‚æ›´å¤šçš„æ˜¯å¯¹ä¸­æ–­æ¶‰åŠçš„å†…å®¹è¿›è¡Œç®€å•ä»‹ç»ï¼ŒåŽç»­æ‰ä¼šå¯¹å„ä¸ªå†…å®¹è¯¦ç»†ä»‹ç»ã€‚

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œä¸­æ–­ï¼ˆ`Interrupt`ï¼‰æ˜¯ä¸€ç§ç¡¬ä»¶æˆ–è½¯ä»¶äº‹ä»¶ï¼Œ**å®ƒå¯ä»¥æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„ `CPU` æŒ‡ä»¤åºåˆ—ï¼Œä½¿ `CPU` è½¬è€Œå¤„ç†æŸä¸ªç‰¹å®šäº‹ä»¶**ã€‚ä¸­æ–­æœºåˆ¶å…è®¸å¤–éƒ¨è®¾å¤‡æˆ–ç³»ç»Ÿç»„ä»¶é€šè¿‡å‘é€ä¿¡å·æ¥é€šçŸ¥ `CPU` æŸç§äº‹ä»¶çš„å‘ç”Ÿï¼Œè¿™å¯ä»¥æ˜¯æ¥è‡ªç¡¬ä»¶è®¾å¤‡ï¼ˆå¦‚é”®ç›˜ã€é¼ æ ‡ã€ç¡¬ç›˜ç­‰ï¼‰çš„è¾“å…¥ã€å®šæ—¶å™¨åˆ°æœŸã€ç½‘ç»œæ•°æ®åŒ…åˆ°è¾¾ç­‰ç­‰ã€‚

ä¸­æ–­çš„ä¸»è¦ç›®çš„æ˜¯æä¾›ä¸€ç§å¼‚æ­¥é€šä¿¡çš„æ–¹å¼ï¼Œè®© CPU èƒ½å¤ŸåŠæ—¶å“åº”å¤–éƒ¨äº‹ä»¶ï¼Œè€Œä¸éœ€è¦æŒç»­åœ°è½®è¯¢æ£€æŸ¥äº‹ä»¶æ˜¯å¦å‘ç”Ÿã€‚è¿™æ ·å¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿçš„æ•ˆçŽ‡å’Œå“åº”é€Ÿåº¦ã€‚

> ä½†**ä¸­æ–­è¿‡å¤šåè€Œä¼šé™ä½Žç³»ç»Ÿçš„æ•ˆçŽ‡**ï¼åœ¨ç½‘ç»œæ”¶åŒ…å¤„ç†ä¸­ï¼Œå¾€å¾€é‡‡ç”¨ä¸­æ–­+è½®è¯¢çš„æ–¹å¼ã€‚

åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œ**æ¯ç§ç±»åž‹çš„ä¸­æ–­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†å·ï¼Œè¢«ç§°ä¸ºä¸­æ–­å·**ã€‚å½“ä¸€ä¸ªä¸­æ–­äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒCPU ä¼šç«‹å³æš‚åœå½“å‰æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¿å­˜å½“å‰ä¸Šä¸‹æ–‡ï¼Œç„¶åŽè·³è½¬åˆ°ä¸Žä¸­æ–­å·ç›¸å…³è”çš„ä¸­æ–­å¤„ç†ç¨‹åºã€‚ä¸­æ–­å¤„ç†ç¨‹åºæ˜¯ä¸€æ®µé¢„å…ˆç¼–å†™å¥½çš„ä»£ç ï¼Œè´Ÿè´£å¤„ç†ç‰¹å®šç±»åž‹çš„ä¸­æ–­äº‹ä»¶ã€‚å¤„ç†å®Œä¸­æ–­äº‹ä»¶åŽï¼ŒCPU ä¼šæ¢å¤ä¹‹å‰ä¿å­˜çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶ç»§ç»­æ‰§è¡Œè¢«ä¸­æ–­çš„æŒ‡ä»¤ã€‚

> 1. ä¸­æ–­å·çš„åˆ†é…æ–¹å¼ã€‚
> 2. å¤§é‡ä¸­æ–­è§¦å‘æ—¶ï¼Œä¸Šä¸‹æ–‡ä¿å­˜`_raw_spin_unlock_irq`ä¸Žæ¢å¤`_raw_spin_unlock_irqrestore`å¾€å¾€ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚

Linux å†…æ ¸æœ‰ä¸€ä¸ª**ä¸­æ–­æŽ§åˆ¶å™¨**ï¼ˆ`Interrupt Controller`ï¼‰ï¼Œå®ƒç®¡ç†ç€æ‰€æœ‰ä¸­æ–­å¹¶å†³å®šå®ƒä»¬çš„ä¼˜å…ˆçº§å’Œå¤„ç†é¡ºåºã€‚ä¸­æ–­å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š**ç¡¬ä»¶ä¸­æ–­**å’Œ**è½¯ä»¶ä¸­æ–­**ã€‚ç¡¬ä»¶ä¸­æ–­æ˜¯ç”±å¤–éƒ¨è®¾å¤‡å¼•å‘çš„ï¼Œä¾‹å¦‚ï¼Œå½“é”®ç›˜æŒ‰é”®è¢«æŒ‰ä¸‹æ—¶ä¼šè§¦å‘ä¸€ä¸ªç¡¬ä»¶ä¸­æ–­ã€‚è½¯ä»¶ä¸­æ–­æ˜¯é€šè¿‡ç‰¹æ®Šçš„æŒ‡ä»¤æ¥è§¦å‘çš„ï¼Œé€šå¸¸ç”¨äºŽæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æˆ–ä¸Žå†…æ ¸è¿›è¡Œé€šä¿¡ã€‚

> 1. ä¸­æ–­æœ‰ä¼˜å…ˆçº§ã€‚
> 2. è½¯ä»¶ä¹Ÿå¯ä»¥è§¦å‘ä¸­æ–­ã€‚

æ€»è€Œè¨€ä¹‹ï¼Œä¸­æ–­åœ¨ Linux ç³»ç»Ÿä¸­æ˜¯ä¸€ç§é‡è¦çš„æœºåˆ¶ï¼Œå®ƒå…è®¸å¤–éƒ¨äº‹ä»¶ä»¥å¼‚æ­¥çš„æ–¹å¼é€šçŸ¥ CPUï¼Œä»Žè€Œä½¿ç³»ç»Ÿèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°å“åº”å„ç§äº‹ä»¶ã€‚

### ç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­

ç¡¬ä¸­æ–­å°±æ˜¯ç”±**å¤–éƒ¨**ç¡¬ä»¶è®¾å¤‡è§¦å‘çš„ï¼Œæœ¬è´¨ä¸Šæ¥è¯´ï¼Œå°±æ˜¯æ”¹å˜æŸä¸ªå¼•è„šçš„ç”µåŽ‹ç”µå¹³ï¼Œæ¯”å¦‚å¼•è„šè¾“å…¥ç”±é«˜ç”µå¹³å˜ä¸ºä½Žç”µå¹³ï¼ˆä¸‹é™æ²¿è§¦å‘ï¼‰ï¼Œè¯¥å˜åŒ–ä¼šè¢«å¤„ç†å™¨çš„**ä¸­æ–­æŽ§åˆ¶å™¨**æ£€æµ‹åˆ°ï¼Œä»Žè€Œè·³è½¬åˆ°ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œã€‚ä¹Ÿæœ‰ä¸€äº›è®¾å¤‡æ”¯æŒä¸Šå‡æ²¿è§¦å‘ã€æˆ–è€…**ç”µå¹³è§¦å‘**ï¼Œå…·ä½“çš„è§¦å‘æ–¹å¼éœ€è¦å‚è€ƒè®¾å¤‡çš„æŠ€æœ¯è§„æ ¼æˆ–æ–‡æ¡£ã€‚

> 1. ä¸­æ–­æŽ§åˆ¶å™¨çš„åŽŸç†ã€‚
> 2. ä¸­æ–­å¤„ç†ç¨‹åºå’Œä¸­æ–­å¦‚ä½•å…³è”ï¼Œå¦‚ä½•åˆ‡æ¢åˆ°ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œã€‚
> 3. â€œå¤–éƒ¨â€ï¼šè¿™é‡Œæ‰€è¯´çš„å¤–éƒ¨æ˜¯é’ˆå¯¹ `CPU` è€Œè¨€çš„ï¼Œé™¤äº†ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„å¤–è®¾ç¡¬ç›˜ã€é”®ç›˜ã€é¼ æ ‡ã€ç½‘ç»œæŽ¥å£å¡ç­‰ï¼Œ`TLB`ã€`DMA` ç­‰æ¨¡å—ä¹Ÿèƒ½å‘èµ·ç¡¬ä»¶ä¸­æ–­ã€‚

æ“ä½œç³»ç»Ÿæ”¶åˆ°äº†ä¸­æ–­è¯·æ±‚ï¼Œä¼šæ‰“æ–­å…¶ä»–è¿›ç¨‹çš„è¿è¡Œï¼Œæ‰€ä»¥**ä¸­æ–­è¯·æ±‚çš„å“åº”ç¨‹åºï¼Œä¹Ÿå°±æ˜¯ä¸­æ–­å¤„ç†ç¨‹åºï¼Œè¦å°½å¯èƒ½å¿«çš„æ‰§è¡Œå®Œï¼Œè¿™æ ·å¯ä»¥å‡å°‘å¯¹æ­£å¸¸è¿›ç¨‹è¿è¡Œè°ƒåº¦åœ°å½±å“**ã€‚è€Œä¸”ä¸­æ–­å¤„ç†ç¨‹åºå¯èƒ½ä¼šæš‚æ—¶å…³é—­ä¸­æ–­ï¼Œè¿™æ—¶å¦‚æžœä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¯èƒ½åœ¨è¿˜æœªæ‰§è¡Œå®Œä¸­æ–­å¤„ç†ç¨‹åºå‰ï¼Œä¼šä¸¢å¤±å½“å‰å…¶ä»–è®¾å¤‡çš„ä¸­æ–­è¯·æ±‚

Linux ç³»ç»Ÿä¸ºäº†è§£å†³ä¸­æ–­å¤„ç†ç¨‹åºæ‰§è¡Œè¿‡é•¿å’Œä¸­æ–­ä¸¢å¤±çš„é—®é¢˜ï¼Œå°†**ä¸­æ–­è¿‡ç¨‹åˆ†æˆäº†ä¸¤ä¸ªé˜¶æ®µ**ï¼Œåˆ†åˆ«æ˜¯**ã€Œä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨åˆ†ã€**ã€‚

- ä¸ŠåŠéƒ¨ç”¨æ¥**å¿«é€Ÿå¤„ç†ä¸­æ–­**ï¼Œä¸€èˆ¬ä¼šæš‚æ—¶å…³é—­ä¸­æ–­è¯·æ±‚ï¼Œä¸»è¦è´Ÿè´£å¤„ç†è·Ÿç¡¬ä»¶ç´§å¯†ç›¸å…³æˆ–è€…æ—¶é—´æ•æ„Ÿçš„äº‹æƒ…ã€‚
- ä¸‹åŠéƒ¨ç”¨æ¥**å»¶è¿Ÿå¤„ç†**ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œï¼Œä¸€èˆ¬ä»¥**ã€Œå†…æ ¸çº¿ç¨‹ã€**çš„æ–¹å¼è¿è¡Œã€‚

> å‚è€ƒè¿™é‡Œçš„ä¾‹å­ï¼š[ä»€ä¹ˆæ˜¯è½¯ä¸­æ–­](https://www.xiaolincoding.com/os/1_hardware/soft_interrupt.html#%E4%B8%AD%E6%96%AD%E6%98%AF%E4%BB%80%E4%B9%88)

- **ä¸ŠåŠéƒ¨ç›´æŽ¥å¤„ç†ç¡¬ä»¶è¯·æ±‚ï¼Œä¹Ÿå°±æ˜¯ç¡¬ä¸­æ–­**ï¼Œä¸»è¦æ˜¯è´Ÿè´£è€—æ—¶çŸ­çš„å·¥ä½œï¼Œç‰¹ç‚¹æ˜¯å¿«é€Ÿæ‰§è¡Œï¼›
- **ä¸‹åŠéƒ¨æ˜¯ç”±å†…æ ¸è§¦å‘ï¼Œä¹Ÿå°±è¯´è½¯ä¸­æ–­**ï¼Œä¸»è¦æ˜¯è´Ÿè´£ä¸ŠåŠéƒ¨æœªå®Œæˆçš„å·¥ä½œï¼Œé€šå¸¸éƒ½æ˜¯è€—æ—¶æ¯”è¾ƒé•¿çš„äº‹æƒ…ï¼Œç‰¹ç‚¹æ˜¯å»¶è¿Ÿæ‰§è¡Œï¼›

> ~~æ³¨æ„è¿™é‡Œå°†ä¸‹åŠéƒ¨è¯´ä¸ºæ˜¯è½¯ä¸­æ–­æ„Ÿè§‰å¹¶ä¸å¤ªå‡†ç¡®ï¼Œåº”è¯¥æ˜¯ `tasklet`~~ã€‚
>
> è½¯ä¸­æ–­è¿™ä¸ªæœ¯è¯­å­˜åœ¨ä¸€å®šçš„æ­§ä¹‰ï¼Œè¿™é‡Œä»–æ˜¯ä½œä¸º**å¯å»¶è¿Ÿå‡½æ•°**çš„æ€»ç§°ï¼Œæ—¢åŒ…æ‹¬äº† `softirq`ï¼Œä¹ŸåŒ…æ‹¬ `tasklet`ã€‚éœ€è¦æ ¹æ®ä¸Šä¸‹æ–‡æŽ¨æ–­å…¶æ„æ€ã€‚

è¿˜æœ‰ä¸€ä¸ªåŒºåˆ«ï¼Œç¡¬ä¸­æ–­ï¼ˆä¸ŠåŠéƒ¨ï¼‰æ˜¯ä¼šæ‰“æ–­ CPU æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç„¶åŽç«‹å³æ‰§è¡Œä¸­æ–­å¤„ç†ç¨‹åºï¼Œè€Œè½¯ä¸­æ–­ï¼ˆä¸‹åŠéƒ¨ï¼‰æ˜¯ä»¥å†…æ ¸çº¿ç¨‹çš„æ–¹å¼æ‰§è¡Œï¼Œå¹¶ä¸”æ¯ä¸€ä¸ª CPU éƒ½å¯¹åº”ä¸€ä¸ª**è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹**ï¼Œåå­—é€šå¸¸ä¸º**ã€Œ`ksoftirqd/CPU` ç¼–å·ã€**ï¼Œæ¯”å¦‚ `0` å· CPU å¯¹åº”çš„è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„åå­—æ˜¯ `ksoftirqd/0`

> 1. è½¯ä¸­æ–­å†…æ ¸çº¿ç¨‹çš„ä½œç”¨ï¼Œä¸Žå®žçŽ°
> 2. ä¸­æ–­æ˜¯ä¸Ž `CPU` ç»‘å®šçš„ï¼

ä¸è¿‡ï¼Œ**è½¯ä¸­æ–­ä¸åªæ˜¯åŒ…æ‹¬ç¡¬ä»¶è®¾å¤‡ä¸­æ–­å¤„ç†ç¨‹åºçš„ä¸‹åŠéƒ¨ï¼Œä¸€äº›å†…æ ¸è‡ªå®šä¹‰äº‹ä»¶ä¹Ÿå±žäºŽè½¯ä¸­æ–­**ï¼Œæ¯”å¦‚**å†…æ ¸è°ƒåº¦**ç­‰ã€RCU é”ï¼ˆå†…æ ¸é‡Œå¸¸ç”¨çš„ä¸€ç§é”ï¼‰ç­‰ã€‚

> 1. ç³»ç»Ÿè°ƒç”¨ä¹Ÿå¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§è½¯ä¸­æ–­å§ï¼Œæ¶‰åŠåˆ°ç‰¹æƒçº§åˆ«çš„åˆ‡æ¢å’Œä¸Šä¸‹æ–‡çš„ä¿å­˜ä¸Žæ¢å¤ã€‚
> 2. æˆ‘çš„ç†è§£æ˜¯åªè¦æ¶‰åŠåˆ°ä¸Šä¸‹æ–‡çš„ä¿å­˜ä¸Žæ¢å¤ï¼Œå°±å¯ä»¥çœ‹ä½œæ˜¯ä¸€ç§ä¸­æ–­ã€‚
> 3. å†…æ ¸è°ƒåº¦è¿™é‡Œæ˜¯æŒ‡çº¿ç¨‹åˆ‡æ¢çš„è¿‡ç¨‹è¿˜æ˜¯è°ƒåº¦ç³»ç»Ÿæœ¬èº«å‘¢ï¼Ÿ

### åŒæ­¥ä¸­æ–­ä¸Žå¼‚æ­¥ä¸­æ–­

å°†ä¸­æ–­å¯ä»¥æŒ‰è§¦å‘æºåˆ†ä¸ºç¡¬ä»¶ä¸­æ–­å’Œè½¯ä»¶ä¸­æ–­ï¼Œå¦ä¸€ç§å«æ³•ä¸º**åŒæ­¥ä¸­æ–­ä¸Žå¼‚æ­¥ä¸­æ–­**ï¼š

- **åŒæ­¥ä¸­æ–­å’Œå¼‚å¸¸**ï¼šè¿™äº›ç”± CPU è‡ªèº«äº§ç”Ÿï¼Œé’ˆå¯¹å½“å‰æ‰§è¡Œçš„ç¨‹åºã€‚å¼‚å¸¸å¯èƒ½å› ç§ç§åŽŸå› è§¦å‘ï¼šç”±äºŽè¿è¡Œæ—¶å‘ç”Ÿçš„ç¨‹åºè®¾è®¡é”™è¯¯ï¼ˆå…¸åž‹çš„ä¾‹å­æ˜¯é™¤ 0ï¼‰ï¼Œæˆ–ç”±äºŽå‡ºçŽ°äº†å¼‚å¸¸çš„æƒ…å†µæˆ–æ¡ä»¶ï¼Œè‡´ä½¿å¤„ç†å™¨éœ€è¦â€œå¤–éƒ¨â€çš„å¸®åŠ©æ‰èƒ½å¤„ç†ã€‚
    å¼‚å¸¸æƒ…å†µä¸è§å¾—æ˜¯ç”±è¿›ç¨‹ç›´æŽ¥å¯¼è‡´çš„ï¼Œä½†å¿…é¡»å€ŸåŠ©äºŽå†…æ ¸æ‰èƒ½ä¿®å¤ã€‚ä¸€ä¸ªå¯èƒ½çš„ä¾‹å­æ˜¯ç¼ºé¡µå¼‚å¸¸ï¼Œåœ¨è¿›ç¨‹è¯•å›¾è®¿é—®è™šæ‹Ÿåœ°å€ç©ºé—´çš„ä¸€é¡µï¼Œè€Œè¯¥é¡µä¸åœ¨ç‰©ç†å†…å­˜ä¸­æ—¶ï¼Œæ‰ä¼šå‘ç”Ÿæ­¤ç±»å¼‚å¸¸ã€‚æ ¹æ®ç¬¬ 4 ç« çš„è®¨è®ºï¼Œå†…æ ¸å¿…é¡»ä¸Ž CPU äº¤äº’ï¼Œç¡®ä¿å°†é¢„æœŸçš„æ•°æ®å–å…¥ç‰©ç†å†…å­˜ã€‚æŽ¥ä¸‹æ¥ï¼Œè¿›ç¨‹å¯ä»¥åœ¨å‘ç”Ÿå¼‚å¸¸çš„ä½ç½®æ¢å¤æ‰§è¡Œã€‚ç”±äºŽå†…æ ¸è‡ªåŠ¨æ¢å¤äº†è¿™ç§æƒ…å†µï¼Œè¿›ç¨‹ç”šè‡³ä¸ä¼šæ³¨æ„åˆ°ç¼ºé¡µå¼‚å¸¸çš„å­˜åœ¨ã€‚
- **å¼‚æ­¥ä¸­æ–­**ã€‚è¿™æ˜¯ç»å…¸çš„ä¸­æ–­ç±»åž‹ï¼Œç”±å¤–éƒ¨è®¾å¤‡äº§ç”Ÿï¼Œå¯èƒ½å‘ç”Ÿåœ¨ä»»æ„æ—¶é—´ã€‚ä¸åŒäºŽåŒæ­¥ä¸­æ–­ï¼Œå¼‚æ­¥ä¸­æ–­å¹¶ä¸ä¸Žç‰¹å®šè¿›ç¨‹å…³è”ã€‚å®ƒä»¬å¯èƒ½å‘ç”Ÿåœ¨ä»»ä½•æ—¶é—´ï¼Œè€Œä¸ç‰µæ¶‰ç³»ç»Ÿå½“å‰æ‰§è¡Œçš„æ´»åŠ¨ã€‚ç½‘å¡é€šè¿‡å‘å‡ºä¸€ä¸ªç›¸å…³çš„ä¸­æ–­æ¥æŠ¥å‘Šæ–°åˆ†ç»„çš„åˆ°è¾¾ã€‚å› ä¸ºæ•°æ®å¯èƒ½åœ¨ä»»æ„æ—¶åˆ»åˆ°è¾¾ç³»ç»Ÿï¼Œæ‰€ä»¥å½“å‰æ‰§è¡Œçš„å¾ˆå¯èƒ½æ˜¯ä¸Žæ•°æ®æ— å…³çš„æŸä¸ªè¿›ç¨‹æˆ–å…¶ä»–ä¸œè¥¿ã€‚ä¸ºé¿å…æŸå®³è¯¥è¿›ç¨‹ï¼Œå†…æ ¸å¿…é¡»ç¡®ä¿ä¸­æ–­èƒ½å¤Ÿå°½å¿«å¤„ç†å®Œæ¯•ï¼ˆé€šè¿‡ç¼“å†²æ•°æ®ï¼‰ï¼Œä½¿å¾— CPU æ—¶é—´èƒ½å¤Ÿè¿”è¿˜ç»™å½“å‰è¿›ç¨‹ã€‚è¿™ä¹Ÿæ˜¯å†…æ ¸éœ€è¦å»¶æœŸæ“ä½œæœºåˆ¶çš„åŽŸå› ã€‚

> ä»Žä»‹ç»å¯ä»¥çœ‹å‡ºï¼ŒåŒæ­¥ä¸­æ–­å…¶å®žå°±æ˜¯è½¯ä»¶ä¸­æ–­ï¼Œå¼‚æ­¥ä¸­æ–­ä¸ºç¡¬ä»¶ä¸­æ–­ï¼Œåªæ˜¯è¯´æ³•ä¸åŒã€‚

ä¸¤ç±»ä¸­æ–­çš„å…±åŒç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æžœ CPU å½“å‰ä¸å¤„äºŽæ ¸å¿ƒæ€ï¼Œåˆ™å‘èµ·ä»Žç”¨æˆ·æ€åˆ°æ ¸å¿ƒæ€çš„åˆ‡æ¢ã€‚æŽ¥ä¸‹æ¥ï¼Œåœ¨å†…æ ¸ä¸­æ‰§è¡Œä¸€ä¸ªä¸“é—¨çš„ä¾‹ç¨‹ï¼Œç§°ä¸ºä¸­æ–­æœåŠ¡ä¾‹ç¨‹ï¼ˆ`interrupt service routine`ï¼Œç®€ç§° **ISR**ï¼‰æˆ–ä¸­æ–­å¤„ç†ç¨‹åºï¼ˆ`interrupt handler`ï¼‰ã€‚

### IRQ ç¼–å·ä¸Žä¸­æ–­å·

æ¯ä¸ªä¸­æ–­éƒ½æœ‰ä¸€ä¸ªç¼–å·ã€‚å¦‚æžœä¸­æ–­å· `n` åˆ†é…ç»™ä¸€ä¸ªç½‘å¡è€Œ `mâ‰  n` åˆ†é…ç»™ `SCSI` æŽ§åˆ¶å™¨ï¼Œé‚£ä¹ˆå†…æ ¸å³å¯åŒºåˆ†ä¸¤ä¸ªè®¾å¤‡ï¼Œå¹¶åœ¨ä¸­æ–­å‘ç”Ÿæ—¶è°ƒç”¨å¯¹åº”çš„ `ISR` æ¥æ‰§è¡Œç‰¹å®šäºŽè®¾å¤‡çš„æ“ä½œã€‚å½“ç„¶ï¼ŒåŒæ ·çš„åŽŸåˆ™ä¹Ÿé€‚åº”äºŽå¼‚å¸¸ï¼Œä¸åŒçš„å¼‚å¸¸æŒ‡æ´¾äº†ä¸åŒçš„ç¼–å·ã€‚

é—æ†¾çš„æ˜¯ï¼Œç”±äºŽç‰¹åˆ«è®¾è®¡ï¼ˆé€šå¸¸æ˜¯åŽ†å²ä¸Šçš„ï¼‰çš„â€œç‰¹æ€§â€ï¼ˆ`IA-32` ä½“ç³»ç»“æž„å°±æ˜¯ä¸€ä¸ªæ°å½“çš„ç‰¹ä¾‹ï¼‰ï¼Œæƒ…å†µå¹¶ä¸æ€»æ˜¯åƒæè¿°çš„é‚£æ ·ç®€å•ã€‚å› ä¸º**åªæœ‰å¾ˆå°‘çš„ç¼–å·å¯ç”¨äºŽç¡¬ä»¶ä¸­æ–­ï¼Œæ‰€ä»¥å¿…é¡»ç”±å‡ ä¸ªè®¾å¤‡å…±äº«ä¸€ä¸ªç¼–å·**ã€‚åœ¨ `IA-32` å¤„ç†å™¨ä¸Šï¼Œç¡¬ä»¶ä¸­æ–­çš„æœ€å¤§æ•°ç›®é€šå¸¸æ˜¯ 15ï¼Œè¿™ä¸ªå€¼å¯ä¸æ€Žä¹ˆå¤§ï¼Œè¿˜æœ‰è€ƒè™‘åˆ°æœ‰äº›ä¸­æ–­ç¼–å·å·²ç»æ°¸ä¹…æ€§åœ°åˆ†é…ç»™äº†æ ‡å‡†çš„ç³»ç»Ÿç»„ä»¶ï¼ˆé”®ç›˜ã€å®šæ—¶å™¨ï¼Œç­‰ç­‰ï¼‰ï¼Œå› è€Œé™åˆ¶äº†å¯ç”¨äºŽå…¶ä»–å¤–éƒ¨è®¾å¤‡çš„ä¸­æ–­ç¼–å·æ•°ç›®ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º**ä¸­æ–­å…±äº«**ï¼ˆ`interrupt sharing`ï¼‰ã€‚ä½†å¿…é¡»ç¡¬ä»¶å’Œå†…æ ¸åŒæ—¶æ”¯æŒæ‰èƒ½ä½¿ç”¨è¯¥æŠ€æœ¯ï¼Œå› ä¸ºå¿…é¡»è¦è¯†åˆ«å‡ºä¸­æ–­æ¥æºäºŽå“ªä¸ªè®¾å¤‡ã€‚

> å¾ˆè‡ªç„¶ï¼Œç²¾å·§è®¾è®¡çš„æ€»çº¿ç³»ç»Ÿæ— éœ€è¯¥æ–¹æ¡ˆã€‚è¿™ç§ç³»ç»Ÿä¸ºç¡¬ä»¶è®¾å¤‡æä¾›äº†å¾ˆå¤šä¸­æ–­ï¼Œæ ¹æœ¬ä¸éœ€è¦å…±äº«ã€‚

ä¸­æ–­ä¸èƒ½ç”±å¤„ç†å™¨å¤–éƒ¨çš„å¤–è®¾ç›´æŽ¥äº§ç”Ÿï¼Œè€Œå¿…é¡»å€ŸåŠ©äºŽä¸€ä¸ªç§°ä¸º**ä¸­æ–­æŽ§åˆ¶å™¨** (`interrupt controller`) çš„æ ‡å‡†ç»„ä»¶æ¥**è¯·æ±‚**ï¼Œè¯¥ç»„ä»¶å­˜åœ¨äºŽæ¯ä¸ªç³»ç»Ÿä¸­ã€‚

å¤–éƒ¨è®¾å¤‡ï¼ˆæˆ–å…¶æ§½ä½ï¼‰ï¼Œä¼šæœ‰ç”µè·¯è¿žæŽ¥åˆ°ç”¨äºŽå‘ä¸­æ–­æŽ§åˆ¶å™¨å‘é€ä¸­æ–­è¯·æ±‚çš„ç»„ä»¶ã€‚æŽ§åˆ¶å™¨åœ¨æ‰§è¡Œäº†å„ç§ç”µå·¥ä»»åŠ¡ï¼ˆæˆ‘ä»¬å¯¹æ­¤æ²¡æœ‰æ›´å¤šå…´è¶£ï¼‰ä¹‹åŽï¼Œ**å°†ä¸­æ–­è¯·æ±‚è½¬å‘åˆ° CPU çš„ä¸­æ–­è¾“å…¥**ã€‚å› ä¸ºå¤–éƒ¨è®¾å¤‡ä¸èƒ½ç›´æŽ¥å‘å‡ºä¸­æ–­ï¼Œè€Œå¿…é¡»é€šè¿‡ä¸Šè¿°ç»„ä»¶è¯·æ±‚ä¸­æ–­ï¼Œæ‰€ä»¥è¿™ç§è¯·æ±‚æ›´æ­£ç¡®çš„å«æ³•æ˜¯**IRQ**ï¼Œæˆ–**ä¸­æ–­è¯·æ±‚ï¼ˆinterrupt requestï¼‰**ã€‚å› ä¸ºå°±è½¯ä»¶è€Œè¨€ï¼ŒIRQ å’Œä¸­æ–­ä¹‹é—´çš„å·®åˆ«ä¸æ˜¯é‚£ä¹ˆå¤§ï¼Œè¿™ä¸¤ä¸ªæœ¯è¯­é€šå¸¸å¯æ›¿æ¢ä½¿ç”¨ã€‚

å¯¹å¤§å¤šæ•° `CPU` æ¥è¯´ï¼Œéƒ½åªæ˜¯ä»Žå¯ç”¨äºŽå¤„ç†ç¡¬ä»¶ä¸­æ–­çš„æ•´ä¸ªä¸­æ–­å·èŒƒå›´æŠ½å–ä¸€å°éƒ¨åˆ†ä½¿ç”¨ã€‚æŠ½å–å‡ºçš„èŒƒå›´é€šå¸¸ä½äºŽæ‰€æœ‰ä¸­æ–­å·åºåˆ—çš„ä¸­éƒ¨ï¼Œä¾‹å¦‚ï¼Œ`IA-32 CPU` æ€»å…±æä¾›äº† 16 ä¸ªä¸­æ–­å·ï¼Œä»Ž 32 åˆ° 47ã€‚

å¦‚æžœè¯»è€…æ›¾ç»åœ¨ IA-32 ç³»ç»Ÿä¸Šé…ç½®è¿‡ I/O æ‰©å±•å¡ï¼Œæˆ–ç ”ç©¶è¿‡ `/proc/interrupts` çš„å†…å®¹ï¼Œé‚£ä¹ˆå°±ä¼šäº†è§£åˆ°ï¼Œæ‰©å±•å¡çš„ `IRQ` ç¼–å·ä»Ž 0 å¼€å§‹ï¼Œåˆ° 15 ç»“æŸï¼Œå½“ç„¶ï¼Œå‰ææ˜¯ä½¿ç”¨äº†å…¸åž‹çš„ä¸­æ–­æŽ§åˆ¶å™¨ `8256A`ã€‚è¿™æ„å‘³ç€è¿™é‡ŒåŒæ ·æœ‰ 16 ä¸ªä¸åŒçš„é€‰é¡¹ï¼Œä½†æ•°å€¼ä¸åŒã€‚ä¸­**æ–­æŽ§åˆ¶å™¨é™¤äº†è´Ÿè´£ `IRQ` ä¿¡å·çš„ç”µå·¥å¤„ç†ä¹‹å¤–ï¼Œè¿˜ä¼šå¯¹ `IRQ` ç¼–å·å’Œä¸­æ–­å·è¿›è¡Œä¸€ä¸ªâ€œè½¬æ¢â€**ã€‚åœ¨ IA-32 ç³»ç»Ÿä¸Šï¼ŒåŠ  32 å³å¯ã€‚å¦‚æžœè®¾å¤‡å‘å‡º `IRQ` 9ï¼Œ`CPU` å°†äº§ç”Ÿä¸­æ–­ 41ï¼Œåœ¨å®‰è£…ä¸­æ–­å¤„ç†ç¨‹åºæ—¶å¿…é¡»è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ã€‚å…¶ä»–ä½“ç³»ç»“æž„åœ¨ä¸­æ–­å·å’Œ `IRQ` ç¼–å·ä¹‹é—´é‡‡ç”¨å…¶ä»–æ˜ å°„æ–¹å¼ï¼Œè¿™é‡Œä¸ä¼šè¯¦ç»†é˜è¿°ã€‚

> æ³¨æ„ä¸Šé¢è¿™ä¸ªä¾‹å­æ¥ç†è§£ `IRQ` ç¼–å·ä¸Žä¸­æ–­å·çš„åŒºåˆ«ï¼`IRQ` **å·ä¸»è¦ç”¨äºŽç¡¬ä»¶ä¸­æ–­çš„æ ‡è¯†ï¼Œè€Œè½¯ä»¶ä¸­æ–­åˆ™ä½¿ç”¨å…¶ä»–æœºåˆ¶æ¥è¿›è¡Œæ ‡è¯†å’Œå¤„ç†**ã€‚

### ä¸­æ–­å¤„ç†ç¨‹åº

åœ¨ `CPU` å¾—çŸ¥å‘ç”Ÿä¸­æ–­åŽï¼Œå®ƒå°†è¿›ä¸€æ­¥çš„å¤„ç†å§”æ‰˜ç»™ä¸€ä¸ªè½¯ä»¶ä¾‹ç¨‹ï¼Œè¯¥ä¾‹ç¨‹å¯èƒ½ä¼šä¿®å¤æ•…éšœã€æä¾›ä¸“é—¨çš„å¤„ç†æˆ–å°†å¤–éƒ¨äº‹ä»¶é€šçŸ¥ç”¨æˆ·è¿›ç¨‹ã€‚ç”±äºŽæ¯ä¸ªä¸­æ–­å’Œå¼‚å¸¸éƒ½æœ‰å”¯ä¸€çš„ç¼–å·ï¼Œå†…æ ¸ä½¿ç”¨ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„é¡¹æ˜¯æŒ‡å‘å¤„ç†ç¨‹åºå‡½æ•°çš„æŒ‡é’ˆã€‚ç›¸å…³çš„ä¸­æ–­å·æ ¹æ®æ•°ç»„é¡¹åœ¨æ•°ç»„ä¸­çš„ä½ç½®åˆ¤æ–­ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚

![image-20230829210639960](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230829210639960.png)

1. **è¿›å…¥å’Œé€€å‡ºä»»åŠ¡**ï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¸­æ–­å¤„ç†åˆ’åˆ†ä¸º 3 éƒ¨åˆ†ã€‚é¦–å…ˆï¼Œå¿…é¡»å»ºç«‹ä¸€ä¸ªé€‚å½“çš„çŽ¯å¢ƒï¼Œä½¿å¾—å¤„ç†ç¨‹åºå‡½æ•°èƒ½å¤Ÿåœ¨å…¶ä¸­æ‰§è¡Œï¼ŒæŽ¥ä¸‹æ¥è°ƒç”¨å¤„ç†ç¨‹åºè‡ªèº«ï¼Œæœ€åŽå°†ç³»ç»Ÿå¤åŽŸï¼ˆåœ¨å½“å‰ç¨‹åºçœ‹æ¥ï¼‰åˆ°ä¸­æ–­ä¹‹å‰çš„çŠ¶æ€ã€‚è°ƒç”¨ä¸­æ–­å¤„ç†ç¨‹åºå‰åŽçš„ä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ç§°ä¸º**è¿›å…¥è·¯å¾„**ï¼ˆå·¦è¾¹æ–¹æ¡†ï¼‰å’Œ**é€€å‡ºè·¯å¾„**ï¼ˆå³è¾¹æ–¹æ¡†ï¼‰ã€‚

    ![image-20230829211951196](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230829211951196.png)

    è¿›å…¥å’Œé€€å‡ºä»»åŠ¡è¿˜è´Ÿè´£ç¡®ä¿å¤„ç†å™¨ä»Žç”¨æˆ·æ€åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ã€‚è¿›å…¥è·¯å¾„çš„ä¸€ä¸ªå…³é”®ä»»åŠ¡æ˜¯ï¼Œä»Žç”¨æˆ·æ€æ ˆåˆ‡æ¢åˆ°æ ¸å¿ƒæ€æ ˆã€‚ä½†æ˜¯ï¼Œåªæœ‰è¿™ä¸€ç‚¹è¿˜ä¸å¤Ÿã€‚å› ä¸ºå†…æ ¸è¿˜è¦ä½¿ç”¨ CPU èµ„æºæ‰§è¡Œå…¶ä»£ç ï¼Œ**è¿›å…¥è·¯å¾„å¿…é¡»ä¿å­˜ç”¨æˆ·åº”ç”¨ç¨‹åºå½“å‰çš„å¯„å­˜å™¨çŠ¶æ€**ï¼Œä»¥ä¾¿åœ¨ä¸­æ–­æ´»åŠ¨ç»“æŸåŽæ¢å¤ã€‚è¿™ä¸Žè°ƒåº¦æœŸé—´ç”¨äºŽä¸Šä¸‹æ–‡åˆ‡æ¢çš„æœºåˆ¶æ˜¯ç›¸åŒçš„ã€‚

    > åœ¨ä»Žç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€æ—¶ï¼Œå·²ç»ä¿å­˜äº†ä¸€éƒ¨åˆ†å†…æ ¸ä¼šç”¨åˆ°çš„å¯„å­˜å™¨çš„çŠ¶æ€ã€‚ä½†å†…æ ¸æ²¡ç”¨åˆ°çš„ï¼ˆæ¯”å¦‚æµ®ç‚¹æ•°å¯„å­˜å™¨ï¼‰ï¼Œå¹¶ä¸ä¿å­˜ã€‚åœ¨è¿›å…¥ä¸­æ–­å¤„ç†ç¨‹åºå‰ï¼Œéœ€è¦ä¿å­˜è¿™éƒ¨åˆ†å¯„å­˜å™¨çŠ¶æ€ã€‚
    >
    > ä¸­æ–­åˆ°è¾¾æ—¶ï¼Œå¤„ç†å™¨å¯èƒ½æ­£å¤„äºŽå†…æ ¸æ€ï¼Œå› è€Œæ— éœ€ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ç­‰ï¼Œæ€»ä¹‹ï¼Œè¿›å…¥è·¯å¾„ä¹Ÿä¼šè¿›è¡Œä¸€ç³»åˆ—æ£€æŸ¥ã€‚

2. **ä¸­æ–­å¤„ç†ç¨‹åº**ï¼šä¸­æ–­å¤„ç†ç¨‹åºå¯èƒ½ä¼šé‡åˆ°å›°éš¾ï¼Œç‰¹åˆ«æ˜¯ï¼Œåœ¨å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œå‘ç”Ÿäº†å…¶ä»–ä¸­æ–­ã€‚å°½ç®¡å¯ä»¥é€šè¿‡åœ¨å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´ç¦ç”¨ä¸­æ–­æ¥é˜²æ­¢ï¼Œä½†è¿™ä¼šå¼•èµ·å…¶ä»–é—®é¢˜ï¼Œå¦‚é—æ¼é‡è¦çš„ä¸­æ–­ã€‚**å±è”½**ï¼ˆMaskingï¼Œè¿™ä¸ªæœ¯è¯­ç”¨äºŽè¡¨ç¤ºé€‰æ‹©æ€§åœ°ç¦ç”¨ä¸€ä¸ªæˆ–å¤šä¸ªä¸­æ–­ï¼‰å› è€Œ**åªèƒ½çŸ­æ—¶é—´ä½¿ç”¨**ã€‚

   å› æ­¤ ISR å¿…é¡»æ»¡è¶³å¦‚ä¸‹ä¸¤ä¸ªè¦æ±‚ã€‚

   1. å®žçŽ°ï¼ˆç‰¹åˆ«æ˜¯åœ¨ç¦ç”¨å…¶ä»–ä¸­æ–­æ—¶ï¼‰å¿…é¡»åŒ…å«å°½å¯èƒ½å°‘çš„ä»£ç ï¼Œä»¥æ”¯æŒå¿«é€Ÿå¤„ç†ã€‚
   2. å¯ä»¥åœ¨å…¶ä»– ISR æ‰§è¡ŒæœŸé—´è°ƒç”¨çš„ä¸­æ–­å¤„ç†ç¨‹åºä¾‹ç¨‹ï¼Œä¸èƒ½å½¼æ­¤å¹²æ‰°ã€‚

   å°½ç®¡åŽä¸€ä¸ªè¦æ±‚å¯ä»¥é€šè¿‡é«˜è¶…çš„ç¼–ç¨‹å’Œç²¾å·§çš„ ISR è®¾è®¡æ¥æ»¡è¶³ï¼Œç„¶è€Œå‰ä¸€ä¸ªè¦æ±‚æ›´éš¾æ»¡è¶³ã€‚æ ¹æ®å…·ä½“çš„ä¸­æ–­ï¼Œå¿…é¡»è¿è¡ŒæŸä¸ªç¨‹åºï¼Œæ¥æ»¡è¶³ä¸­æ–­å¤„ç†çš„æœ€ä½Žè¦æ±‚ã€‚å› è€Œä»£ç é•¿åº¦æ— æ³•ä»»æ„ç¼©å‡ã€‚

   å†…æ ¸å¦‚ä½•è§£å†³è¿™ç§ä¸¤éš¾é—®é¢˜å‘¢ï¼Ÿå¹¶éž ISR çš„æ¯ä¸ªéƒ¨åˆ†éƒ½åŒç­‰é‡è¦ã€‚é€šå¸¸ï¼Œæ¯ä¸ªå¤„ç†ç¨‹åºä¾‹ç¨‹éƒ½å¯ä»¥åˆ’åˆ†ä¸º 3 ä¸ªéƒ¨åˆ†ï¼Œå…·æœ‰ä¸åŒçš„æ„ä¹‰ã€‚

   1. **å…³é”®æ“ä½œå¿…é¡»åœ¨ä¸­æ–­å‘ç”ŸåŽç«‹å³æ‰§è¡Œ**ã€‚å¦åˆ™ï¼Œæ— æ³•ç»´æŒç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œæˆ–è®¡ç®—æœºçš„æ­£ç¡®è¿ä½œã€‚åœ¨æ‰§è¡Œæ­¤ç±»æ“ä½œæœŸé—´ï¼Œ**å¿…é¡»ç¦ç”¨å…¶ä»–ä¸­æ–­**ã€‚
   2. éžå…³é”®æ“ä½œä¹Ÿåº”è¯¥å°½å¿«æ‰§è¡Œï¼Œä½†**å…è®¸å¯ç”¨ä¸­æ–­**ï¼ˆå› è€Œå¯èƒ½è¢«å…¶ä»–ç³»ç»Ÿäº‹ä»¶ä¸­æ–­ï¼‰ã€‚
   3. **å¯å»¶æœŸæ“ä½œä¸æ˜¯ç‰¹åˆ«é‡è¦**ï¼Œä¸å¿…åœ¨ä¸­æ–­å¤„ç†ç¨‹åºä¸­å®žçŽ°ã€‚å†…æ ¸å¯ä»¥å»¶è¿Ÿè¿™äº›æ“ä½œï¼Œåœ¨æ—¶é—´å……è£•æ—¶è¿›è¡Œã€‚**å†…æ ¸æä¾›äº† `tasklet`ï¼Œç”¨äºŽåœ¨ç¨åŽæ‰§è¡Œå¯å»¶æœŸæ“ä½œ**ã€‚

> 1. è¿™é‡Œè¿›ä¸€æ­¥è¯´æ˜Žäº†ä¸­æ–­çš„ä¸ŠåŠéƒ¨ã€ä¸‹åŠéƒ¨ã€‚ä½†ä¸Žå‰é¢æœ‰ç‚¹çŸ›ç›¾äº†ï¼Œå‰é¢è¯´çš„ä¸‹åŠéƒ¨å°±æ˜¯è½¯ä¸­æ–­ï¼Œè¿™é‡Œè¯´çš„ `tasklet`ï¼ŒåŽè€…å¹¶ä¸ç­‰åŒä¸Žè½¯ä¸­æ–­ã€‚
> 2. å…³äºŽ `tasklet`ï¼Œå…ˆç®€å•ç†è§£ä¸ºä¸€ç§â€œå†…æ ¸çº¿ç¨‹â€ã€‚åœ¨ç¡¬ä¸­æ–­çš„å¤„ç†å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªâ€œçº¿ç¨‹ `tasklet`â€åŽ»æ‰§è¡Œè¾ƒå¤æ‚çš„å¤„ç†ä»£ç ï¼Œå®Œæˆçº¿ç¨‹åˆ›å»ºåŽï¼Œä¸­æ–­å¤„ç†ç¨‹åºå°±å¯ä»¥é€€å‡ºï¼Œè¿›è€Œæ¢å¤åŽŸç³»ç»Ÿçš„è¿›ç¨‹å¤„ç†ã€‚è€Œæˆ‘ä»¬åˆ›å»ºçš„ â€œçº¿ç¨‹`tasklet`â€ åˆ™è¿›å…¥å†…æ ¸çš„è°ƒåº¦ç³»ç»Ÿï¼Œå°±åƒæ™®é€šçš„çº¿ç¨‹é‚£æ ·ï¼Œç”±å†…æ ¸è°ƒåº¦ç³»ç»Ÿæ¥å®‰æŽ’æ—¶é—´ç‰‡è¿›è¡Œå¤„ç†ã€‚ï¼ˆä»…ä»…æ˜¯è¿™æ ·çŒœæµ‹ï¼Œå…·ä½“æƒ…å†µçœ‹ä¸‹é¢ï¼‰ã€‚

### å¤šæ ¸ç³»ç»Ÿä¸­æ–­å¤„ç†

ç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­äº¤ç»™å“ªä¸€ä¸ªæ ¸è¿›è¡Œå¤„ç†çš„é—®é¢˜ï¼

todo...

### ä¸­æ–­ç»Ÿè®¡ä¿¡æ¯

åœ¨ `/proc` ç›®å½•ä¸‹ï¼Œæœ‰ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«è®°å½•äº†ç¡¬ä¸­æ–­å’Œè½¯ä¸­æ–­çš„æ¬¡æ•°ï¼š`/proc/interrupts`ã€`/proc/softirqs`ã€‚åœ¨å¤šæ ¸ç³»ç»Ÿä¸Šï¼Œä¼šæ˜¾ç¤ºå‡ºæ¯ä¸€ä¸ªæ ¸å¤„ç†çš„å¯¹åº”ä¸­æ–­çš„æ•°é‡ï¼Œè¿™é‡Œåªæœ‰å•æ ¸ã€‚

```bash
[root@cvitek]~# cat /proc/softirqs
                    CPU0
          HI:          0
       TIMER:      37049
      NET_TX:       1398
      NET_RX:       2344
       BLOCK:        139
    IRQ_POLL:          0
     TASKLET:         19
       SCHED:          0
     HRTIMER:          0
         RCU:      11288
```

è½¯ä¸­æ–­çš„æ•°é‡æ˜¯å†…æ ¸ä»£ç ä¸­å›ºå®šçš„ï¼Œè€Œç¡¬ä¸­æ–­åˆ™ä¸Žå¤–è®¾æ•°é‡æœ‰å…³ï¼š

```bash
[root@cvitek]~# cat /proc/interrupts
           CPU0
  2:          0  T-Head PLIC  76  cvi-tpu-tdma
  5:      61141  RISC-V INTC   5  riscv-timer
 11:          0  T-Head PLIC  29  dw_dmac
 16:         60  T-Head PLIC  44  ttyS0
 21:          0  T-Head PLIC  49  4000000.i2c
 22:          0  T-Head PLIC  51  4020000.i2c
 23:          0  T-Head PLIC  52  4030000.i2c
 24:          0  T-Head PLIC  53  4040000.i2c
 25:       1443  T-Head PLIC  31  eth0
 26:       4296  T-Head PLIC  34  mmc0
 27:          0  T-Head PLIC  36  mmc1
 28:          0  T-Head PLIC  40  4100000.i2s
 29:          0  T-Head PLIC  43  4130000.i2s
 30:          0  T-Head PLIC  26  cif-irq0
 31:          0  T-Head PLIC  27  cif-irq1
 32:          0  T-Head PLIC  24  a000000.vi
 33:          0  T-Head PLIC  25  CVI_VIP_SCL
 34:          3  T-Head PLIC  97  a0a0000.ive
 35:          0  T-Head PLIC  28  CVI_VIP_DWA
 36:          0  T-Head PLIC  22  h265
 37:          0  T-Head PLIC  21  h264
 39:          0  T-Head PLIC  20  JPU_CODEC_IRQ
 40:          1  T-Head PLIC 101  mailbox
 49:          0  gpio-dwapb  13  cd-gpio-irq
```

## ç¡¬ä¸­æ–­

> ä¸»è¦å…³æ³¨ï¼š
>
> 1. æ€Žä¹ˆä¸ºæŸä¸ªå¤–è®¾æ³¨å†Œä¸­æ–­ï¼ŒåŒ…æ‹¬ä¸­æ–­å·çš„åˆ†é…ï¼Œä¸­æ–­å¤„ç†ç¨‹åºçš„æ³¨å†Œã€‚
> 2. è¿™ä¸ªè¿‡ç¨‹å°±ä¼šæ¶‰åŠåˆ°ä¸­æ–­çš„å®žçŽ°åŽŸç†ï¼Œä¸­æ–­çš„ä¼˜å…ˆçº§ï¼Œå¦‚ä½•åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šçœ‹åˆ°ä¸­æ–­çš„ç›¸å…³ç»Ÿè®¡ä¿¡æ¯ `cat /proc/interrupts` è¿™ç§ã€‚

### æ•°æ®ç»“æž„

ä¸­æ–­æŠ€æœ¯ä¸Šçš„å®žçŽ°æœ‰ä¸¤æ–¹é¢ï¼š

- **æ±‡ç¼–è¯­è¨€ä»£ç **ï¼Œä¸Žå¤„ç†å™¨é«˜åº¦ç›¸å…³ï¼Œç”¨äºŽå¤„ç†ç‰¹å®šå¹³å°ä¸Šç›¸å…³çš„åº•å±‚ç»†èŠ‚ï¼›
- **æŠ½è±¡æŽ¥å£**ï¼Œæ˜¯è®¾å¤‡é©±åŠ¨ç¨‹åºåŠå…¶ä»–å†…æ ¸ä»£ç å®‰è£…å’Œç®¡ç† `IRQ` å¤„ç†ç¨‹åºæ‰€éœ€çš„ã€‚

æœ¬èŠ‚ä¸»è¦å…³æ³¨ç¬¬äºŒæ–¹é¢ã€‚

![image-20230830114231632](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830114231632.png)

#### irq_desc

> æ¯ä¸€ä¸ªä¸­æ–­éƒ½å¯¹åº”ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦ `irq_desc`ã€‚

ä¸ºå“åº”å¤–éƒ¨è®¾å¤‡çš„ `IRQ`ï¼Œå†…æ ¸å¿…é¡»ä¸ºæ¯ä¸ªæ½œåœ¨çš„ `IRQ` æä¾›ä¸€ä¸ªå‡½æ•°ã€‚**è¯¥å‡½æ•°å¿…é¡»èƒ½å¤ŸåŠ¨æ€æ³¨å†Œå’Œæ³¨**é”€ã€‚`IRQ` ç›¸å…³ä¿¡æ¯ç®¡ç†çš„å…³é”®ç‚¹æ˜¯ä¸€ä¸ª**å…¨å±€æ•°ç»„**ï¼Œæ¯ä¸ªæ•°ç»„é¡¹å¯¹åº”ä¸€ä¸ª `IRQ` ç¼–å·ã€‚å› ä¸ºæ•°ç»„ä½ç½®å’Œä¸­æ–­å·æ˜¯ç›¸åŒçš„ï¼Œå¾ˆå®¹æ˜“å®šä½ä¸Žç‰¹å®šçš„ `IRQ` ç›¸å…³çš„æ•°ç»„é¡¹ï¼š`IRQ` 0 åœ¨ä½ç½® 0ï¼Œ`IRQ` 15 åœ¨ä½ç½® 15ï¼Œç­‰ç­‰ã€‚ä¸è¿‡ `IRQ` æœ€ç»ˆæ˜ å°„åˆ°å“ªä¸ªå¤„ç†å™¨ä¸­æ–­ï¼Œåœ¨è¿™é‡Œæ˜¯ä¸ç›¸å…³çš„ã€‚

> å¦‚å‰é¢æ‰€è¯´çš„ `IRQ` å·ä¸Žä¸­æ–­å·çš„åŒºåˆ«ã€‚`/proc/interrupts` ä¸­å±•ç¤ºçš„æ˜¯ `IRQ` å·è€Œä¸æ˜¯ä¸­æ–­å·ã€‚
>
> é¡ºä¾¿æä¸€å˜´ï¼Œå†…æ ¸ä»£ç éƒ½æ˜¯é‡‡ç”¨çš„ `tab` ç¼©å‡ï¼Œå¹¶ä¸”ä¸€ä¸ª`1tab = 8space`ï¼Œæ‰€ä»¥å‘çŽ°å†…æ ¸ä»£ç å¯¹é½æœ‰é—®é¢˜æ—¶ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯ä½ çš„`tab`è®¾ç½®ä¸å¯¹ã€‚
>
> æœ¬æ–‡å‚è€ƒçš„æ˜¯å†…æ ¸ç‰ˆæœ¬æ˜¯ `v5.10.186` ã€‚ä¸Žã€Šæ·±å…¥ Linux å†…æ ¸æž¶æž„ã€‹ä½¿ç”¨çš„ç•¥æœ‰åŒºåˆ«ã€‚

```c
// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/irq/irqdesc.c#L554
struct irq_desc irq_desc[NR_IRQS] __cacheline_aligned_in_smp = {
        [0 ... NR_IRQS-1] = {
                .handle_irq     = handle_bad_irq,
                .depth          = 1,
                .lock           = __RAW_SPIN_LOCK_UNLOCKED(irq_desc->lock),
        }
};
```

1. `struct irq_desc irq_desc[NR_IRQS]`: è¿™æ˜¯ä¸€ä¸ªä¸­æ–­æè¿°ç¬¦æ•°ç»„ï¼Œç”¨äºŽå­˜å‚¨ç³»ç»Ÿä¸­æ‰€æœ‰å¯èƒ½çš„ä¸­æ–­çš„æè¿°ä¿¡æ¯ã€‚**`NR_IRQS` è¡¨ç¤ºä¸­æ–­æ€»æ•°**ï¼Œåœ¨ä¸åŒçš„ä½“ç³»ç»“æž„ä¸Šï¼Œæ”¯æŒçš„ä¸­æ–­æ•°å¹¶ä¸ç›¸åŒï¼Œ32ã€64ã€128ã€512 ç­‰ç­‰ã€‚**æ¯ä¸ªä¸­æ–­éƒ½å¯¹åº”ä¸€ä¸ª [`struct irq_desc`](https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/irqdesc.h#L55) çš„å®žä¾‹**ï¼ˆå³ä¸­æ–­æè¿°ç¬¦ï¼‰ã€‚
2. `__cacheline_aligned_in_smp`: è¿™ä¸ªæ ‡å¿—è¡¨æ˜Žè¿™ä¸ªæ•°ç»„ä¼šè¢«åœ¨å¤šæ ¸ç³»ç»Ÿä¸­**æŒ‰ç¼“å­˜è¡Œå¯¹é½**ï¼ˆä¸€èˆ¬ä¸º `64 byte`ï¼‰ï¼Œä»¥æé«˜æ•ˆçŽ‡ã€‚
3. `[0 ... NR_IRQS-1]`: è¿™æ˜¯ä¸€ç§åˆå§‹åŒ–æ•°ç»„çš„è¯­æ³•ï¼Œè¡¨ç¤ºå¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ è¿›è¡Œåˆå§‹åŒ–ã€‚
4. `.handle_irq = handle_bad_irq`: è¿™å°†æ¯ä¸ªä¸­æ–­æè¿°ç¬¦çš„ `handle_irq` æˆå‘˜åˆå§‹åŒ–ä¸º `handle_bad_irq`ã€‚`handle_irq` æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸­æ–­å¤„ç†å‡½æ•°ï¼Œä½†åœ¨è¿™é‡Œå®ƒè¢«åˆå§‹åŒ–ä¸º `handle_bad_irq`ï¼Œå³å¤„ç†â€œåâ€ä¸­æ–­çš„å‡½æ•°ã€‚è¿™é€šå¸¸æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œè¡¨æ˜Žé»˜è®¤æƒ…å†µä¸‹æ‰€æœ‰ä¸­æ–­éƒ½å°†ä½¿ç”¨ç›¸åŒçš„å¤„ç†å‡½æ•°ã€‚
5. `.depth = 1`: è¿™å°†æ¯ä¸ªä¸­æ–­æè¿°ç¬¦çš„ `depth` æˆå‘˜åˆå§‹åŒ–ä¸º 1ã€‚**`depth` è¡¨ç¤ºä¸­æ–­åµŒå¥—çš„æ·±åº¦**ï¼Œå³åœ¨å¤„ç†ä¸­æ–­æ—¶ï¼Œå¦‚æžœå‘ç”Ÿå¦ä¸€ä¸ªä¸­æ–­ï¼Œç³»ç»Ÿå¯ä»¥è·Ÿè¸ªä¸­æ–­çš„åµŒå¥—çº§åˆ«ã€‚`depth` æœ‰ä¸¤ä¸ªä»»åŠ¡ã€‚å®ƒå¯ç”¨äºŽç¡®å®š IRQ ç”µè·¯æ˜¯å¯ç”¨çš„è¿˜æ˜¯ç¦ç”¨çš„ã€‚æ­£å€¼è¡¨ç¤ºç¦ç”¨ï¼Œè€Œ 0 è¡¨ç¤ºå¯ç”¨ã€‚ä¸ºä»€ä¹ˆç”¨æ­£å€¼è¡¨ç¤ºç¦ç”¨çš„ `IRQ` å‘¢ï¼Ÿå› ä¸ºè¿™ä½¿å¾—å†…æ ¸èƒ½å¤ŸåŒºåˆ†å¯ç”¨å’Œç¦ç”¨çš„ `IRQ` ç”µè·¯ï¼Œä»¥åŠé‡å¤ç¦ç”¨åŒä¸€ä¸­æ–­çš„æƒ…å½¢ã€‚è¿™ä¸ªå€¼ç›¸å½“äºŽä¸€ä¸ªè®¡æ•°å™¨ï¼Œå†…æ ¸å…¶ä½™éƒ¨åˆ†çš„ä»£ç æ¯æ¬¡ç¦ç”¨æŸä¸ªä¸­æ–­ï¼Œåˆ™å°†å¯¹åº”çš„è®¡æ•°å™¨åŠ  1ï¼›æ¯æ¬¡ä¸­æ–­è¢«å†æ¬¡å¯ç”¨ï¼Œåˆ™å°†è®¡æ•°å™¨å‡ 1ã€‚åœ¨ `depth` å½’ 0 æ—¶ï¼Œç¡¬ä»¶æ‰èƒ½å†æ¬¡ä½¿ç”¨å¯¹åº”çš„ `IRQ`ã€‚è¿™ç§æ–¹æ³•èƒ½å¤Ÿæ”¯æŒå¯¹åµŒå¥—ç¦ç”¨ä¸­æ–­çš„æ­£ç¡®å¤„ç†ã€‚
6. `.lock = __RAW_SPIN_LOCK_UNLOCKED(irq_desc->lock)`: è¿™å°†æ¯ä¸ªä¸­æ–­æè¿°ç¬¦çš„ `lock` æˆå‘˜åˆå§‹åŒ–ä¸ºæœªé”å®šçš„è‡ªæ—‹é”ã€‚è‡ªæ—‹é”æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œ**ç”¨äºŽä¿æŠ¤å¯¹ä¸­æ–­æè¿°ç¬¦çš„è®¿é—®**ã€‚`__RAW_SPIN_LOCK_UNLOCKED` å®ç”¨äºŽåˆå§‹åŒ–è‡ªæ—‹é”ã€‚

ä¸‹é¢æ˜¯ `irq_desc` çš„ç»“æž„ï¼ˆæœ‰çœç•¥ï¼‰ï¼š

```c
struct irq_desc {
        struct irq_common_data  irq_common_data;
        struct irq_data         irq_data;
        /* struct irq_data {
                u32                     mask;
                unsigned int            irq;   // å“ªä¸€ä¸ªæ˜¯ç”±è®¾å¤‡æ ‘æŒ‡å®šçš„å‘¢ï¼Ÿ
                unsigned long           hwirq; // è¿™
                struct irq_common_data  *common;
                struct irq_chip         *chip;
                struct irq_domain       *domain;
                void                    *chip_data;
        }; */
        unsigned int __percpu   *kstat_irqs;
        irq_flow_handler_t      handle_irq;
        struct irqaction        *action;        /* IRQ action list */
        unsigned int            status_use_accessors;
        unsigned int            depth;          /* nested irq disables */
        unsigned int            irq_count;      /* For detecting broken IRQs */
        unsigned int            irqs_unhandled;
        raw_spinlock_t          lock;
        int                     parent_irq;
        struct module           *owner;
        const char              *name;
} ____cacheline_internodealigned_in_smp;
```

- `action`ï¼šæä¾›äº†ä¸€ä¸ªæ“ä½œé“¾ï¼Œéœ€è¦åœ¨ä¸­æ–­å‘ç”Ÿæ—¶æ‰§è¡Œã€‚ç”±ä¸­æ–­é€šçŸ¥çš„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå¯ä»¥å°†ä¸Žä¹‹ç›¸å…³çš„å¤„ç†ç¨‹åºå‡½æ•°æ”¾ç½®åœ¨æ­¤å¤„ã€‚æœ‰ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æž„ç”¨äºŽè¡¨ç¤ºè¿™äº›æ“ä½œã€‚
- `irq_data->chip`ï¼šç”µæµå¤„ç†å’ŒèŠ¯ç‰‡ç›¸å…³æ“ä½œè¢«å°è£…åœ¨ `chip` ä¸­ã€‚ä¸ºæ­¤å¼•å…¥äº†ä¸€ä¸ªä¸“é—¨çš„æ•°æ®ç»“æž„ã€‚
- `name`ï¼šæŒ‡å®šäº†ç”µæµå±‚å¤„ç†ç¨‹åºçš„åç§°ï¼Œå¯¹è¾¹æ²¿è§¦å‘ä¸­æ–­ï¼Œé€šå¸¸æ˜¯ `edge`ï¼Œå¯¹ç”µå¹³è§¦å‘ä¸­æ–­ï¼Œé€šå¸¸æ˜¯ `level`ã€‚
- `status_use_accessors`ï¼š
  - `IRQ_DISABLED` ç”¨äºŽè¡¨ç¤ºè¢«è®¾å¤‡é©±åŠ¨ç¨‹åºç¦ç”¨çš„ IRQ ç”µè·¯ã€‚è¯¥æ ‡å¿—é€šçŸ¥å†…æ ¸ä¸è¦è¿›å…¥å¤„ç†ç¨‹åºã€‚
  - åœ¨ IRQ å¤„ç†ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼ŒçŠ¶æ€è®¾ç½®ä¸º `IRQ_INPROGRESS`ã€‚ä¸Ž `IRQ_DISABLED` ç±»ä¼¼ï¼Œè¿™ä¼šé˜»æ­¢å…¶ä½™çš„å†…æ ¸ä»£ç æ‰§è¡Œè¯¥å¤„ç†ç¨‹åºã€‚
  - åœ¨ CPU æ³¨æ„åˆ°ä¸€ä¸ªä¸­æ–­ä½†å°šæœªæ‰§è¡Œå¯¹åº”çš„å¤„ç†ç¨‹åºæ—¶ï¼Œ`IRQ_PENDING` æ ‡å¿—ä½ç½®ä½ã€‚
  - ä¸ºæ­£ç¡®å¤„ç†å‘ç”Ÿåœ¨ä¸­æ–­å¤„ç†æœŸé—´çš„ä¸­æ–­ï¼Œéœ€è¦ `IRQ_MASKED` æ ‡å¿—ã€‚å…·ä½“å‚è§ 14.1.4 èŠ‚ã€‚
  - åœ¨æŸä¸ª IRQ åªèƒ½å‘ç”Ÿåœ¨ä¸€ä¸ª CPU ä¸Šæ—¶ï¼Œå°†è®¾ç½® `IRQ_PER_CPU` æ ‡å¿—ä½ã€‚ï¼ˆåœ¨ SMP ç³»ç»Ÿä¸­ï¼Œè¯¥æ ‡å¿—ä½¿å‡ ä¸ªç”¨äºŽé˜²æ­¢å¹¶å‘è®¿é—®çš„ä¿æŠ¤æœºåˆ¶å˜å¾—å¤šä½™ï¼‰ã€‚
  - `IRQ_LEVEL` ç”¨äºŽ Alpha å’Œ PowerPC ç³»ç»Ÿï¼Œç”¨äºŽåŒºåˆ†ç”µå¹³è§¦å‘å’Œè¾¹æ²¿è§¦å‘çš„ IRQã€‚
  - `IRQ_REPLAY` æ„å‘³ç€è¯¥ IRQ å·²ç»ç¦ç”¨ï¼Œä½†æ­¤å‰å°šæœ‰ä¸€ä¸ªæœªç¡®è®¤çš„ä¸­æ–­ã€‚
  - `IRQ_AUTODETECT` å’Œ `IRQ_WAITING` ç”¨äºŽ IRQ çš„è‡ªåŠ¨æ£€æµ‹å’Œé…ç½®ã€‚

#### IRQ æŽ§åˆ¶å™¨æŠ½è±¡

### æ³¨å†Œå’Œåˆ†é… IRQ

1. **æ³¨å†Œ IRQ**

    ç”±è®¾å¤‡é©±åŠ¨ç¨‹åºåŠ¨æ€æ³¨å†Œ ISR çš„å·¥ä½œï¼Œå¯ä»¥ä½¿æ‰€è¿°çš„æ•°æ®ç»“æž„éžå¸¸ç®€å•åœ°è¿›è¡Œã€‚

    ```c
    /**
    * request_irq - Add a handler for an interrupt line
    * @irq:     The interrupt line to allocate
    * @handler: Function to be called when the IRQ occurs.
    *           Primary handler for threaded interrupts
    *           If NULL, the default primary handler is installed
    * @flags:   Handling flags
    * @name:    Name of the device generating this interrupt
    * @dev:     A cookie passed to the handler function
    *
    * This call allocates an interrupt and establishes a handler; see
    * the documentation for request_threaded_irq() for details.
    */
    static inline int __must_check
    request_irq(unsigned int irq, irq_handler_t handler, unsigned long flags,
            const char *name, void *dev)
    {
            return request_threaded_irq(irq, handler, NULL, flags, name, dev);
    }
    ```

    ![image-20230830155455169](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830155455169.png)

2. **é‡Šæ”¾ IRQ**
3. **æ³¨å†Œä¸­æ–­**

### å¤„ç† IRQ

#### 1. åˆ‡æ¢åˆ°æ ¸å¿ƒæ€ï¼š

åˆ°æ ¸å¿ƒæ€çš„åˆ‡æ¢ï¼Œæ˜¯åŸºäºŽæ¯ä¸ªä¸­æ–­ä¹‹åŽç”±å¤„ç†å™¨è‡ªåŠ¨æ‰§è¡Œçš„æ±‡ç¼–è¯­è¨€ä»£ç çš„ã€‚åªæœ‰é‚£äº›æœ€ä¸ºå¿…è¦çš„æ“ä½œç›´æŽ¥åœ¨æ±‡ç¼–è¯­è¨€ä»£ç ä¸­æ‰§è¡Œã€‚å†…æ ¸è¯•å›¾å°½å¿«åœ°è¿”å›žåˆ°å¸¸è§„çš„ C ä»£ç ï¼Œå› ä¸º C ä»£ç æ›´å®¹æ˜“å¤„ç†ã€‚

åœ¨ C è¯­è¨€ä¸­è°ƒç”¨å‡½æ•°æ—¶ï¼Œéœ€è¦å°†æ‰€éœ€çš„æ•°æ®ï¼ˆè¿”å›žåœ°å€å’Œå‚æ•°ï¼‰æŒ‰ä¸€å®šçš„é¡ºåºæ”¾åˆ°æ ˆä¸Šã€‚åœ¨ç”¨æˆ·æ€å’Œæ ¸å¿ƒæ€ä¹‹é—´åˆ‡æ¢æ—¶ï¼Œè¿˜éœ€è¦å°†æœ€é‡è¦çš„å¯„å­˜å™¨ä¿å­˜åˆ°æ ˆä¸Šï¼Œä»¥ä¾¿ä»¥åŽæ¢å¤ã€‚è¿™ä¸¤ä¸ªæ“ä½œç”±å¹³å°ç›¸å…³çš„æ±‡ç¼–è¯­è¨€ä»£ç æ‰§è¡Œã€‚åœ¨å¤§å¤šæ•°å¹³å°ä¸Šï¼ŒæŽ§åˆ¶æµæŽ¥ä¸‹æ¥ä¼ é€’åˆ° `C` å‡½æ•° `do_IRQ`ï¼Œå…¶å®žçŽ°ä¹Ÿæ˜¯å¹³å°ç›¸å…³çš„ï¼Œä½†æƒ…å†µä»ç„¶å¾—åˆ°äº†å¾ˆå¤§çš„ç®€åŒ–ã€‚ æ ¹æ®å¹³å°ä¸åŒï¼Œè¯¥å‡½æ•°çš„å‚æ•°æˆ–è€…æ˜¯**å¤„ç†å™¨å¯„å­˜å™¨é›†åˆ**ã€æˆ–æ˜¯ä¸­æ–­å·å’ŒæŒ‡å‘å¤„ç†å™¨å¯„å­˜å™¨é›†åˆçš„æŒ‡é’ˆã€‚

![image-20230831095645760](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230831095645760.png)

> è¿™é‡Œç†è§£ä¸€ä¸‹å¦‚ä½•ä¿å­˜å¯„å­˜å™¨å€¼çš„ï¼Œå°±æ˜¯ç›´æŽ¥è¯»å–å¯„å­˜å™¨çš„å€¼ï¼Œç„¶åŽå­˜æ”¾åœ¨ `struct pt_regs` è¿™ä¸ªç»“æž„ä½“ä¸­ã€‚å¹¶ä¸”æ˜¯å­˜æ”¾åœ¨æ ˆåº•çš„ï¼Œä¸è¿‡å¯„å­˜å™¨é›†åˆä¹Ÿå¯ä»¥è¢«å¤åˆ¶åˆ°åœ°å€ç©ºé—´ä¸­æ ˆä»¥å¤–çš„å…¶ä»–ä½ç½®ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ`do_IRQ` çš„ä¸€ä¸ªå‚æ•°æ˜¯æŒ‡å‘ `pt_regs` çš„æŒ‡é’ˆï¼Œä½†è¿™å¹¶æ²¡æœ‰æ”¹å˜ä»¥ä¸‹äº‹å®žï¼šå¯„å­˜å™¨çš„å†…å­˜å·²ç»è¢«ä¿å­˜ï¼Œå¯ä»¥ç”± C ä»£ç è¯»å–ã€‚ä¸åŒä½“ç³»ç»“æž„ä¸‹ï¼Œè¯¥ç»“æž„ä½“ `pt_regs` çš„å®šä¹‰æœ‰åŒºåˆ«ã€‚[x86_32](https://elixir.bootlin.com/linux/v5.10.186/source/arch/x86/include/asm/ptrace.h#L12)

#### 2. IRQ æ ˆ

1. è°ƒç”¨ç”µæµå¤„ç†ç¨‹åºä¾‹ç¨‹

    ![image-20230830160703773](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830160703773.png)

2. è°ƒç”¨é«˜å±‚ ISR

3. å®žçŽ°å¤„ç†ç¨‹åºä¾‹ç¨‹

## è½¯ä¸­æ–­

> æœ¬èŠ‚è¯­å¢ƒä¸‹çš„è½¯ä¸­æ–­ä¸å†æ˜¯å»¶è¿Ÿæ‰§è¡Œçš„æ€»ç§°ï¼Œè€Œæ˜¯ç‰¹æŒ‡ `softirq`ï¼

### è½¯ä¸­æ–­ç±»åž‹

ä¸åŒäºŽç¡¬ä»¶ä¸­æ–­ï¼ˆæ¯ä¸ªè®¾å¤‡ä½¿ç”¨çš„å¤–è®¾æ•°é‡å’Œç±»åž‹ä¸åŒï¼‰éœ€è¦æ”¯æŒåŠ¨æ€åœ°æ³¨å†Œï¼Œè½¯ä»¶ä¸­æ–­çš„ç±»åž‹æ˜¯å·²çŸ¥çš„ï¼Œå› æ­¤æ˜¯ä»¥é™æ€çš„å½¢å¼å›ºåŒ–åœ¨å†…æ ¸ä»£ç ä¸­ã€‚å„ä¸ªè½¯ä¸­æ–­éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–å·ï¼Œè¿™è¡¨æ˜Žè½¯ä¸­æ–­æ˜¯ç›¸å¯¹ç¨€ç¼ºçš„èµ„æºï¼Œä½¿ç”¨å…¶å¿…é¡»è°¨æ…Žï¼Œä¸èƒ½ç”±å„ç§è®¾å¤‡é©±åŠ¨ç¨‹åºå’Œå†…æ ¸ç»„ä»¶éšæ„ä½¿ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¸Šåªèƒ½ä½¿ç”¨ `32` ä¸ªè½¯ä¸­æ–­ã€‚è™½ç„¶çœ‹èµ·æ¥å¾ˆæœ‰é™ï¼Œä½†åœ¨ç›®å‰çš„å†…æ ¸ä¸­ï¼Œä»…ä»…ç”¨åˆ°äº† 10 ä¸ªè½¯ä¸­æ–­ðŸ›«ã€‚

```c
https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L545
enum
{
        HI_SOFTIRQ=0,     // ä¸Ž TASKLET_SOFTIRQ ç±»ä¼¼ï¼Œç”¨äºŽéœ€è¦ä¼˜å…ˆå¤„ç†çš„ tasklet
        TIMER_SOFTIRQ,
        NET_TX_SOFTIRQ,
        NET_RX_SOFTIRQ,
        BLOCK_SOFTIRQ,    // ä¸Žå—è®¾å¤‡ï¼ˆå¦‚ç¡¬ç›˜ï¼‰ç›¸å…³çš„è½¯ä¸­æ–­ï¼Œç”¨äºŽå¤„ç†å—è®¾å¤‡çš„æ•°æ®ä¼ è¾“å’Œ IO æ“ä½œ
        IRQ_POLL_SOFTIRQ, // ç”¨äºŽè½®è¯¢å¤„ç†ä¸­æ–­è¯·æ±‚ï¼ˆIRQï¼‰ï¼Œé€šå¸¸ç”¨äºŽä¸€äº›ç‰¹æ®Šçš„æƒ…å†µ
        TASKLET_SOFTIRQ,  // ç”¨äºŽå¤„ç†ä¸€äº›éœ€è¦å»¶è¿Ÿæ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¢«ç§°ä¸º taskletï¼Œåœ¨è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œ
        SCHED_SOFTIRQ,    // ä¸Žè°ƒåº¦å™¨ç›¸å…³çš„è½¯ä¸­æ–­ï¼Œç”¨äºŽå¤„ç†è¿›ç¨‹å’Œçº¿ç¨‹çš„è°ƒåº¦æ“ä½œ
        HRTIMER_SOFTIRQ,  // ç”¨äºŽé«˜ç²¾åº¦å®šæ—¶å™¨çš„å¤„ç†ï¼Œè¿™äº›å®šæ—¶å™¨ç”¨äºŽå®žçŽ°é«˜åˆ†è¾¨çŽ‡çš„æ—¶é—´é—´éš”
        RCU_SOFTIRQ,    /* Preferable RCU(Read-Copy-Update) should always be the last softirq */

        NR_SOFTIRQS
};

// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L645
const char * const softirq_to_name[NR_SOFTIRQS] = {
        "HI", "TIMER", "NET_TX", "NET_RX", "BLOCK", "IRQ_POLL",
        "TASKLET", "SCHED", "HRTIMER", "RCU"
};
```

### æ•°æ®ç»“æž„

å†…æ ¸å€ŸåŠ©äºŽè½¯ä¸­æ–­æ¥èŽ·çŸ¥å¼‚å¸¸æƒ…å†µçš„å‘ç”Ÿï¼Œè€Œè¯¥æƒ…å†µå°†åœ¨ç¨åŽç”±ä¸“é—¨çš„å¤„ç†ç¨‹åºä¾‹ç¨‹è§£å†³ã€‚å¦‚ä¸Šæ‰€è¿°ï¼Œå†…æ ¸åœ¨ `do_IRQ` æœ«å°¾å¤„ç†æ‰€æœ‰å¾…å†³è½¯ä¸­æ–­ï¼Œå› è€Œå¯ä»¥ç¡®ä¿è½¯ä¸­æ–­èƒ½å¤Ÿå®šæœŸå¾—åˆ°å¤„ç†ã€‚

è½¯ä¸­æ–­æœºåˆ¶çš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯ä¸€ä¸ªè¡¨ï¼ŒåŒ…å« `NR_SOFTIRQS` ä¸ª `softirq_action` ç±»åž‹çš„æ•°æ®é¡¹ã€‚è¯¥æ•°æ®ç±»åž‹ç»“æž„éžå¸¸ç®€å•ï¼ŒåªåŒ…å«ä¸€ä¸ªæŒ‡å‘å¤„ç†ç¨‹åºä¾‹ç¨‹çš„æŒ‡é’ˆï¼Œåœ¨è½¯ä¸­æ–­å‘ç”Ÿæ—¶ç”±å†…æ ¸æ‰§è¡Œè¯¥å¤„ç†ç¨‹åºä¾‹ç¨‹ã€‚

> è½¯ä¸­æ–­æ˜¯å·²çŸ¥çš„ï¼Œè¿™äº›ä¸­æ–­çš„å¤„ç†ç¨‹åºä¹Ÿæ˜¯å†…æ ¸ä¸­å·²ç»å®žçŽ°å¥½äº†çš„ã€‚æœç´¢ [`open_softirq`](https://elixir.bootlin.com/linux/v5.10.186/C/ident/open_softirq) å°±å¯ä»¥çœ‹åˆ° `timer`ã€`RCU` ç­‰åœ¨å„è‡ªçš„ `.c` æ–‡ä»¶ä¸­**é™æ€æ³¨å†Œ**äº†å¯¹åº”ä¸­æ–­çš„å¤„ç†ç¨‹åºã€‚

```c
static struct softirq_action softirq_vec[NR_SOFTIRQS] __cacheline_aligned_in_smp;

// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L559
struct softirq_action
{
        void    (*action)(struct softirq_action *);
};

void open_softirq(int nr, void (*action)(struct softirq_action *))
{
        softirq_vec[nr].action = action;
}

// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L636
open_softirq(TASKLET_SOFTIRQ, tasklet_action);
open_softirq(HI_SOFTIRQ, tasklet_hi_action);
```

> ðŸ‘€è¿™ä¸ª `action` å‡½æ•°æŒ‡é’ˆï¼Œå®ƒçš„ä¼ å…¥å‚æ•°ä¹Ÿæ˜¯ `softirq_action`ðŸ‘»ï¼ˆä»ŽåŽé¢ `tasklet_action` çš„ä¾‹å­æ¥çœ‹æ ¹æœ¬æ²¡ç”¨åˆ°è¿™ä¸ªå‚æ•°ðŸ‘€ï¼‰

### è§¦å‘è½¯ä¸­æ–­

> è§¦å‘è½¯ä¸­æ–­ä»…ä»…æ˜¯å‘èµ·äº†ä¸­æ–­è¯·æ±‚ï¼Œä¼šå¤„ç†ï¼Œä½†ä¸ä¸€å®šä¼šé©¬ä¸Šå¤„ç†ï¼Œè€Œæ˜¯è¦ç­‰è°ƒåº¦å™¨å®‰æŽ’ã€‚

ä¸åŒäºŽç¡¬ä»¶ä¸­æ–­ç›´æŽ¥ç”±å¤–è®¾å‘èµ·è¯·æ±‚ï¼ˆç»è¿‡ä¸­æ–­æŽ§åˆ¶å™¨å‘èµ·ï¼‰ï¼Œè½¯ä¸­æ–­åˆ™æ˜¯é€šè¿‡è°ƒç”¨ `raise_softirq(int nr)` æ¥å¼•å‘ä¸€ä¸ªè½¯ä¸­æ–­ï¼ˆç±»ä¼¼æ™®é€šä¸­æ–­ï¼‰ã€‚è½¯ä¸­æ–­çš„ç¼–å·é€šè¿‡å‚æ•°æŒ‡å®šã€‚

```c
void raise_softirq(unsigned int nr)
{
        unsigned long flags;

        local_irq_save(flags); // ç¦ç”¨æœ¬åœ° CPU çš„ç¡¬ä»¶ä¸­æ–­ï¼ŒåŒæ—¶å°†å½“å‰ä¸­æ–­çŠ¶æ€ä¿å­˜åœ¨ flags å˜é‡ä¸­
        raise_softirq_irqoff(nr); // è§¦å‘æŒ‡å®šçš„è½¯ä¸­æ–­ï¼Œä»…ä»…æ˜¯æ ‡å¿—ä¸ºéœ€è¦å¤„ç†ï¼Œéœ€è¦ç­‰å¾…è°ƒåº¦ç³»ç»Ÿå®‰æŽ’ CPU cycle
        local_irq_restore(flags); // åœ¨è½¯ä¸­æ–­è§¦å‘å®Œæ¯•åŽï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„ä¸­æ–­çŠ¶æ€ï¼Œå³å°†ä¸­æ–­é‡æ–°æ‰“å¼€
}
```

> è§¦å‘è½¯ä¸­æ–­ä»…ä»…æ˜¯è®¾ç½®å¯¹åº”ä¸­æ–­çš„æ ‡å¿—ä½ï¼Œå¹¶ä¸ä¼šåƒç¡¬ä»¶ä¸­æ–­é‚£æ ·ç«‹åˆ»æ‰§è¡Œï¼éœ€è¦ç­‰å¾…è°ƒåº¦ç³»ç»Ÿå®‰æŽ’ CPU cycleã€‚
> æ‰€ä»¥è¿™é‡Œè™½ç„¶ç¦ç”¨äº†æœ¬åœ° CPU ç¡¬ä»¶ä¸­æ–­ï¼Œä½†è®¾ç½®æ ‡å¿—ä½ä¹‹åŽå°±ç«‹é©¬æ¢å¤ï¼Œç¦ç”¨çš„æ—¶é—´å¾ˆçŸ­ã€‚
>
> å¦å¤–ï¼Œè¿™é‡Œç¦ç”¨çš„æ˜¯ç¡¬ä»¶ä¸­æ–­ï¼è½¯ä»¶ä¸­æ–­çš„æ‰§è¡Œæ˜¯é€šè¿‡å†…æ ¸è°ƒåº¦æœºåˆ¶æ¥è§¦å‘å’Œè°ƒåº¦çš„ï¼Œé€šå¸¸æ˜¯ä¸ºäº†åœ¨ä¸é˜»å¡žå…¶ä»–æ“ä½œçš„æƒ…å†µä¸‹æ‰§è¡Œä¸€äº›å»¶è¿Ÿæ•æ„Ÿçš„ä»»åŠ¡ï¼Œå› æ­¤åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå®ƒä»¬ä¸éœ€è¦è¢«æ˜¾å¼ç¦ç”¨ã€‚

è¯¥å‡½æ•°è®¾ç½®å„ CPU å˜é‡ `irq_stat[smp_processor_id].__softirq_pending` ä¸­çš„å¯¹åº”æ¯”ç‰¹ä½ã€‚è¯¥å‡½æ•°å°†ç›¸åº”çš„è½¯ä¸­æ–­æ ‡è®°ä¸ºæ‰§è¡Œï¼Œä½†è¿™ä¸ªæ‰§è¡Œæ˜¯å»¶æœŸæ‰§è¡Œã€‚é€šè¿‡ä½¿ç”¨ç‰¹å®šäºŽå¤„ç†å™¨çš„ä½å›¾ï¼Œå†…æ ¸ç¡®ä¿å‡ ä¸ªè½¯ä¸­æ–­ï¼ˆç”šè‡³æ˜¯ç›¸åŒçš„ï¼‰å¯ä»¥åŒæ—¶åœ¨ä¸åŒçš„ CPU ä¸Šæ‰§è¡Œã€‚

> è¿™ä¸ªå˜é‡å¥½åƒå’Œå‰é¢çš„æ²¡å…³ç³»å•Šï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚
>
> todo...

### ä¼˜å…ˆçº§

**è½¯ä¸­æ–­çš„ç¼–å·å½¢æˆäº†ä¸€ä¸ªä¼˜å…ˆé¡ºåº**ï¼Œè¿™å¹¶ä¸å½±å“å„ä¸ªå¤„ç†ç¨‹åºä¾‹ç¨‹æ‰§è¡Œçš„é¢‘çŽ‡æˆ–å®ƒä»¬ç›¸å½“äºŽå…¶ä»–ç³»ç»Ÿæ´»åŠ¨çš„ä¼˜å…ˆçº§ï¼Œä½†å®šä¹‰äº†å¤šä¸ªè½¯ä¸­æ–­åŒæ—¶æ´»åŠ¨æˆ–å¾…å†³æ—¶å¤„ç†ä¾‹ç¨‹æ‰§è¡Œçš„æ¬¡åºã€‚

> ä¸å½±å“é¢‘çŽ‡æ˜¯å› ä¸ºåœ¨ä¸€æ¬¡ `do_IRQ` æ‰§è¡Œä¸­ï¼Œæ¯ä¸ªè½¯ä¸­æ–­éƒ½ä¼šè¢«éåŽ†ã€æ‰§è¡Œï¼Œåªæ˜¯æŒ‰ç…§â€œä¼˜å…ˆçº§â€ï¼ˆé¡ºåºï¼‰æ‰§è¡Œè€Œå·²ã€‚
>
> çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„ä»£ç   [`__do_softirq`](https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L282) ï¼ŒéåŽ† `softirq_vec` çš„ `actions`ã€‚

### å¼€å¯è½¯ä¸­æ–­å¤„ç†

æœ‰å‡ ç§æ–¹æ³•å¯å¼€å¯è½¯ä¸­æ–­å¤„ç†ï¼Œä½†è¿™äº›éƒ½å½’ç»“ä¸ºè°ƒç”¨ `do_softirq` å‡½æ•°ã€‚

```c
// è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¯è§çš„ã€ç”¨äºŽåœ¨æ±‡ç¼–è¯­è¨€ä¸­è°ƒç”¨çš„å‡½æ•°ï¼Œç”¨äºŽæ‰§è¡Œè½¯ä¸­æ–­çš„å¤„ç†
asmlinkage __visible void do_softirq(void)
{
        __u32 pending;
        unsigned long flags;

        // æ£€æŸ¥å½“å‰ä»£ç æ˜¯å¦åœ¨ä¸€ä¸ªä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œå³ä¸æ¶‰åŠç¡¬ä»¶ä¸­æ–­ï¼Œå› ä¸ºè½¯ä¸­æ–­ç”¨äºŽæ‰§è¡Œ ISR ä¸­éžæ—¶é—´å…³é”®éƒ¨åˆ†ï¼Œ
        // æ‰€ä»¥å…¶ä»£ç æœ¬èº«ä¸€å®šä¸èƒ½åœ¨ä¸­æ–­å¤„ç†ç¨‹åºå†…è°ƒç”¨ã€‚
        if (in_interrupt())
                return;

        local_irq_save(flags); // ç¦ç”¨æœ¬åœ° CPU çš„ç¡¬ä»¶ä¸­æ–­ï¼Œä»¥ç¡®ä¿åœ¨æ‰§è¡Œè½¯ä¸­æ–­å¤„ç†æ—¶ä¸ä¼šè¢«å…¶ä»–ç¡¬ä»¶ä¸­æ–­æ‰“æ–­

        // èŽ·å–å½“å‰å¾…å¤„ç†çš„è½¯ä¸­æ–­æ ‡å¿—ï¼Œå³æ£€æŸ¥å“ªäº›è½¯ä¸­æ–­éœ€è¦è¢«æ‰§è¡Œ.
        // è¯¥å‡½æ•°è¿˜å°†åŽŸæ¥çš„ä½å›¾é‡ç½®ä¸º 0ã€‚æ¢å¥è¯è¯´ï¼Œæ¸…é™¤æ‰€æœ‰è½¯ä¸­æ–­ã€‚
        pending = local_softirq_pending();

        // é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¾…å¤„ç†çš„è½¯ä¸­æ–­ï¼Œå¹¶ä¸”è¿˜ä¼šæ£€æŸ¥æ˜¯å¦æœ‰ä¸“é—¨çš„å†…æ ¸çº¿ç¨‹ï¼ˆå¦‚ ksoftirqdï¼‰
        // æ­£åœ¨è¿è¡Œæ¥å¤„ç†è¿™äº›è½¯ä¸­æ–­ã€‚å¦‚æžœæ¡ä»¶æ»¡è¶³ï¼Œå°±è°ƒç”¨
        if (pending && !ksoftirqd_running(pending))
                // æ‰§è¡Œè½¯ä¸­æ–­çš„å®žé™…å¤„ç†ã€‚è¿™ä¸ªå‡½æ•°ä¼šå°†è½¯ä¸­æ–­æ”¾åœ¨å½“å‰çº¿ç¨‹çš„æ ˆä¸Šè¿›è¡Œå¤„ç†ï¼Œ
                // ä»¥é¿å…ä¸Žå…¶ä»–ä¸Šä¸‹æ–‡ä¹‹é—´çš„å¹²æ‰°ã€‚è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ __do_softirq();
                do_softirq_own_stack();

        local_irq_restore(flags);
}
```

![image-20230831101758366](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230831101758366.png)

**`softirq_vec` ä¸­çš„ `action` å‡½æ•°åœ¨ä¸€ä¸ª `while` å¾ªçŽ¯ä¸­é’ˆå¯¹å„ä¸ªå¾…å†³çš„è½¯ä¸­æ–­è¢«è°ƒç”¨**ã€‚ä¹Ÿå°±æ˜¯æŒ‰ç…§é¡ºåºï¼ˆä¼˜å…ˆçº§ï¼‰éåŽ†æ‰€æœ‰éœ€è¦å¤„ç†çš„ä¸­æ–­ï¼Œä¾æ¬¡å¤„ç†ã€‚

> `__do_softirq` è¿™é‡Œä¼šè°ƒç”¨è½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ï¼Œä¸€èˆ¬æ¥è¯´è€—æ—¶æ˜¯æ¯”è¾ƒé•¿çš„ï¼Œä¸ç†è§£è°ƒç”¨è¯¥å‡½æ•°æ—¶ä¸ºä»€ä¹ˆç¦ç”¨ç¡¬ä»¶ä¸­æ–­ã€‚
>
> è¿™é‡Œéœ€è¦è¿›å…¥ [`__do_softirq`](https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L282) å†…éƒ¨æŸ¥çœ‹ï¼Œåœ¨æ­£å¼æ‰§è¡Œå¤„ç†å‡½æ•°ä¹‹å‰ï¼Œç¡¬ä»¶ä¸­æ–­å®žé™…ä¸Šä¼šè¢«é‡æ–° `enable`ã€‚
>
> ~~ä¸å¤ªæ¸…æ¥šï¼Œä¸è¿‡æ€»ä¹‹äº‹å®žå°±æ˜¯è¿™æ ·ï¼Œè¿™ä¹Ÿæ˜¯è½¯ä¸­æ–­çš„ä¸€ä¸ªâ€œç¼ºé™·â€ï¼ŒåŸºäºŽè½¯ä¸­æ–­çš„ `tasklet` æ‰§è¡ŒæœŸé—´åŒæ ·ç¦ç”¨äº†ç¡¬ä»¶ä¸­æ–­ã€‚å› æ­¤ä»–ä»¬çš„å¤„ç†å‡½æ•°æ‰§è¡Œæ—¶é—´ä»ç„¶éœ€è¦å°½é‡çŸ­ï¼Œä»¥ä¿æŒç³»ç»Ÿçš„å“åº”æ€§èƒ½ã€‚å¦‚æžœéœ€è¦æ‰§è¡Œè€—æ—¶è¾ƒé•¿çš„æ“ä½œï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨**å·¥ä½œé˜Ÿåˆ—**ç­‰å…¶ä»–æœºåˆ¶ï¼Œå°†è¿™äº›æ“ä½œä»Ž `Tasklet` ä¸­ç§»å‡ºï¼Œä»¥é¿å…é˜»å¡žè½¯ä¸­æ–­çš„æ‰§è¡Œã€‚~~ï¼ˆ`chatgpt` ðŸ¤®ï¼‰

åœ¨å¤„ç†äº†æ‰€æœ‰æ ‡è®°å‡ºçš„è½¯ä¸­æ–­ä¹‹åŽï¼Œå†…æ ¸æ£€æŸ¥åœ¨æ­¤æœŸé—´æ˜¯å¦æœ‰æ–°çš„è½¯ä¸­æ–­æ ‡è®°åˆ°ä½å›¾ä¸­ã€‚è¦æ±‚åœ¨å‰ä¸€è½®å¾ªçŽ¯ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæ²¡æœ‰å¤„ç†çš„è½¯ä¸­æ–­ï¼Œè€Œé‡å¯çš„æ¬¡æ•°æ²¡æœ‰è¶…è¿‡ `MAX_SOFTIRQ_RESTART`ï¼ˆé€šå¸¸è®¾ç½®ä¸º 10ï¼‰ã€‚å¦‚æžœæ˜¯è¿™æ ·ï¼Œåˆ™å†æ¬¡æŒ‰åºå¤„ç†æ ‡è®°çš„è½¯ä¸­æ–­ã€‚è¿™æ“ä½œä¼šä¸€ç›´é‡å¤ä¸‹åŽ»ï¼Œç›´è‡³åœ¨æ‰§è¡Œæ‰€æœ‰å¤„ç†ç¨‹åºä¹‹åŽæ²¡æœ‰æ–°çš„æœªå¤„ç†è½¯ä¸­æ–­ä¸ºæ­¢ã€‚

å¦‚æžœåœ¨ `MAX_SOFTIRQ_RESTART` æ¬¡é‡å¯å¤„ç†è¿‡ç¨‹ä¹‹åŽï¼Œä»ç„¶æœ‰æœªå¤„ç†çš„è½¯ä¸­æ–­ï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•ï¼Ÿå†…æ ¸å°†è°ƒç”¨ `wakeup_softirqd` å”¤é†’è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹ã€‚

> ä¸Šé¢æè¿°çš„æ˜¯åœ¨ [`__do_softirq(void)`](https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L255) ä¸­ï¼Œé‡å¯ä¸ä»…æœ‰æ¬¡æ•°é™åˆ¶ï¼Œè¿˜æœ‰æ—¶é—´é™åˆ¶ã€‚

### è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹

è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹çš„ä»»åŠ¡æ˜¯ï¼Œä¸Žå…¶ä½™å†…æ ¸ä»£ç å¼‚æ­¥æ‰§è¡Œè½¯ä¸­æ–­ã€‚ä¸ºæ­¤ï¼Œç³»ç»Ÿä¸­çš„æ¯ä¸ªå¤„ç†å™¨éƒ½åˆ†é…äº†è‡ªèº«çš„å®ˆæŠ¤è¿›ç¨‹ï¼Œåä¸º `ksoftirqd`ã€‚

å†…æ ¸ä¸­æœ‰ä¸¤å¤„è°ƒç”¨ `wakeup_softirqd` å”¤é†’äº†è¯¥å®ˆæŠ¤è¿›ç¨‹ï¼š

- åœ¨ `do_softirq` ä¸­
- ç”± `raise_softirq` åœ¨å†…éƒ¨è°ƒç”¨

å”¤é†’å‡½æ•°æœ¬èº«åªéœ€è¦å‡ è¡Œä»£ç ã€‚é¦–å…ˆï¼Œå€ŸåŠ©äºŽä¸€äº›å®ï¼Œä»Žä¸€ä¸ªå„ `CPU` å˜é‡è¯»å–æŒ‡å‘å½“å‰ `CPU` è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹çš„ `task_struct` çš„æŒ‡é’ˆã€‚å¦‚æžœè¯¥è¿›ç¨‹å½“å‰çš„çŠ¶æ€ä¸æ˜¯ `TASK_RUNNING`ï¼Œåˆ™é€šè¿‡ `wake_up_process` å°†å…¶æ”¾ç½®åˆ°**å°±ç»ªè¿›ç¨‹çš„åˆ—è¡¨æœ«å°¾**ï¼ˆå‚è§ç¬¬ 2 ç« ï¼‰ã€‚å°½ç®¡è¿™å¹¶ä¸ä¼šç«‹å³å¼€å§‹å¤„ç†æ‰€æœ‰å¾…å†³è½¯ä¸­æ–­ï¼Œä½†åªè¦è°ƒåº¦å™¨æ²¡æœ‰æ›´å¥½çš„é€‰æ‹©ï¼Œå°±ä¼šé€‰æ‹©è¯¥å®ˆæŠ¤è¿›ç¨‹ï¼ˆä¼˜å…ˆçº§ä¸º `19`ï¼‰æ¥æ‰§è¡Œã€‚

> è½¯ä¸­æ–­çš„å®ˆæŠ¤è¿›ç¨‹åœ¨å†…æ ¸ä¸­ï¼Œä¸Žå…¶ä½™çº¿ç¨‹ä¸€èµ·é€šè¿‡è°ƒåº¦å™¨æ¥åˆ†é… CPU cycleï¼Œä¸è¿‡ç”±äºŽ `ksoftirqd` çš„ä¼˜å…ˆçº§è¾ƒä½Žï¼Œemmmï¼Œè½¯ä¸­æ–­çš„ä¼˜å…ˆçº§è¿™ä¹ˆä½Žï¼Ÿï¼Ÿä¸ºä»€ä¹ˆï¼Ÿé‚£å¦‚æžœç³»ç»Ÿæ¯”è¾ƒç¹å¿™çš„æ—¶å€™ï¼Œè¿™äº›ä¸­æ–­å²‚ä¸æ˜¯å¾ˆéš¾å¾—åˆ°å¤„ç†ï¼Ÿï¼ˆè™½ç„¶ä¹Ÿå’Œè°ƒåº¦ç®—æ³•æœ‰å…³ï¼Œlinux é»˜è®¤çš„è°ƒåº¦ç®—æ³•ä¹Ÿå§‹ç»ˆèƒ½ä¿è¯çº¿ç¨‹ä¸ä¼šé¥¿æ­»ï¼Œæ˜¯ç›¸å¯¹å…¬å¹³çš„ç®—æ³•ã€‚ï¼‰
>
> è¿™ä¹Ÿæ˜¯è½¯ä¸­æ–­çš„ç‰¹ç‚¹å§ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼Œè·Ÿç¡¬ä»¶ä¸­æ–­ç«‹åˆ»æ‰§è¡Œæ¯”ä¸äº†çš„ã€‚

åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ç”¨ `initcall` æœºåˆ¶ï¼ˆè§é™„å½• Dï¼‰è°ƒç”¨ `init` ä¸ä¹…ï¼Œå³åˆ›å»ºäº†ç³»ç»Ÿä¸­çš„è½¯ä¸­æ–­å®ˆæŠ¤è¿›ç¨‹ã€‚åœ¨åˆå§‹åŒ–ä¹‹åŽï¼Œå„ä¸ªå®ˆæŠ¤è¿›ç¨‹éƒ½æ‰§è¡Œä»¥ä¸‹æ— é™å¾ªçŽ¯ï¼š

![image-20230830162923014](../images/Linux%E5%86%85%E6%A0%B8-%E4%B8%AD%E6%96%AD/image-20230830162923014.png)

> ä½†æ–°ç‰ˆå†…æ ¸ä¼¼ä¹Žå·²ç»æ¢äº†ä¸€ç§å®žçŽ°æ–¹å¼äº†ã€‚

```c
static void run_ksoftirqd(unsigned int cpu)
{
        local_irq_disable();
        if (local_softirq_pending()) {
                /*
                 * We can safely run softirq on inline stack, as we are not deep
                 * in the task stack here.
                 */
                __do_softirq(); // è°ƒç”¨ __do_softirq() å¤„ç†
                local_irq_enable();
                cond_resched();
                return;
        }
        local_irq_enable();
}

// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L734
static struct smp_hotplug_thread softirq_threads = {
        .store                  = &ksoftirqd,
        .thread_should_run      = ksoftirqd_should_run,
        .thread_fn              = run_ksoftirqd,
        .thread_comm            = "ksoftirqd/%u",
};

static __init int spawn_ksoftirqd(void)
{
        cpuhp_setup_state_nocalls(CPUHP_SOFTIRQ_DEAD, "softirq:dead", NULL,
                                  takeover_tasklets);
        BUG_ON(smpboot_register_percpu_thread(&softirq_threads));

        return 0;
}
early_initcall(spawn_ksoftirqd);
```

æ¯ä¸€ä¸ª `core` ä¸Šéƒ½ä¼šå¯åŠ¨ä¸€ä¸ª `ksoftirqd` å®ˆæŠ¤è¿›ç¨‹ã€‚

```c
song.yu@WORKSTATION-PAD3:~$ ps aux | grep softirq
root           9  0.0  0.0      0     0 ?        S    4 æœˆ 17  16:58 [ksoftirqd/0]
root          18  0.0  0.0      0     0 ?        S    4 æœˆ 17  14:43 [ksoftirqd/1]
root          24  0.0  0.0      0     0 ?        S    4 æœˆ 17  13:40 [ksoftirqd/2]
root          30  0.0  0.0      0     0 ?        S    4 æœˆ 17  10:04 [ksoftirqd/3]
root          36  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:21 [ksoftirqd/4]
root          42  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:29 [ksoftirqd/5]
root          48  0.0  0.0      0     0 ?        S    4 æœˆ 17  11:24 [ksoftirqd/6]
root          54  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:39 [ksoftirqd/7]
root          60  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:55 [ksoftirqd/8]
root          66  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:12 [ksoftirqd/9]
root          72  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:51 [ksoftirqd/10]
root          78  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:24 [ksoftirqd/11]
root          84  0.0  0.0      0     0 ?        S    4 æœˆ 17   7:59 [ksoftirqd/12]
root          90  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:01 [ksoftirqd/13]
root          96  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:08 [ksoftirqd/14]
root         102  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:30 [ksoftirqd/15]
root         108  0.0  0.0      0     0 ?        S    4 æœˆ 17   7:49 [ksoftirqd/16]
root         114  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:00 [ksoftirqd/17]
root         120  0.0  0.0      0     0 ?        S    4 æœˆ 17   9:33 [ksoftirqd/18]
root         126  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:20 [ksoftirqd/19]
root         132  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:05 [ksoftirqd/20]
root         138  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:28 [ksoftirqd/21]
root         144  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:16 [ksoftirqd/22]
root         150  0.0  0.0      0     0 ?        S    4 æœˆ 17   8:27 [ksoftirqd/23]
```

### å°ç»“

- è½¯ä¸­æ–­ç±»åž‹æ˜¯æœ‰é™çš„ï¼Œå°± 10 æ¥ç§ï¼Œè½¯ä¸­æ–­çš„å¤„ç†å‡½æ•°ä¹Ÿæ˜¯å†™æ­»äº†çš„ï¼Œä¸æ”¯æŒåŠ¨æ€æ³¨å†Œã€‚
- è½¯ä¸­æ–­æ˜¯é€šè¿‡ `do_softirq` è¿™ä¸ªå‡½æ•°è°ƒç”¨å¼€å§‹æ‰§è¡Œçš„ï¼Œè¯¥å‡½æ•°ä¸€èˆ¬ç”± `ksoftirqd` å®ˆæŠ¤è¿›ç¨‹æ¥è°ƒç”¨æ‰§è¡Œï¼ˆå¥½åƒå…¶ä»–ä½ç½®ä¹Ÿå¯ä»¥è°ƒç”¨ï¼Œä¸è¿‡ä¸æ¸…æ¥šä¾‹å­ï¼‰ï¼Œè¯¥è¿›ç¨‹çš„ä¼˜å…ˆçº§å¾ˆä½Ž `19`ï¼Œæ‰€ä»¥**è½¯ä¸­æ–­ä¸€èˆ¬ä¸èƒ½åŠæ—¶å¤„ç†**ã€‚
- è½¯ä¸­æ–­å¯ä»¥å¹¶å‘è¿è¡Œåœ¨å¤šä¸ª CPU ä¸Šï¼ˆå³ä½¿åŒä¸€ç±»åž‹çš„ä¹Ÿå¯ä»¥ï¼‰ï¼Œæ‰€ä»¥è½¯ä¸­æ–­çš„**å¤„ç†å‡½æ•°å¿…é¡»è®¾è®¡ä¸ºå¯é‡å…¥çš„å‡½æ•°**ã€‚
- è½¯ä¸­æ–­å¤„ç†å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œç¡¬ä»¶ä¸­æ–­æ²¡æœ‰è¢«ç¦ç”¨ï¼

> âœ¨âœ¨âœ¨âœ¨
>
> å…³äºŽä¸­æ–­çš„æ—¶åºï¼š
>
> - ç¡¬ä¸­æ–­ä¼šæ‰“æ–­ç¡¬ä¸­æ–­ï¼ˆå½“ç„¶æ˜¯ä¸åŒç±»åž‹çš„ï¼Œä»¥åŠæ²¡æœ‰è¢«ç¦ç”¨ï¼‰ï¼›
> - ç¡¬ä¸­æ–­ä¼šæ‰“æ–­è½¯ä¸­æ–­ï¼›
> - è½¯ä¸­æ–­ä¸ä¼šæ‰“æ–­ç¡¬ä¸­æ–­ï¼Œè½¯ä¸­æ–­ä¹Ÿä¸ä¼šæ‰“æ–­è½¯ä¸­æ–­ã€‚

## tasklet

è½¯ä¸­æ–­æ˜¯å°†æ“ä½œæŽ¨è¿Ÿåˆ°æœªæ¥æ—¶åˆ»æ‰§è¡Œçš„æœ€æœ‰æ•ˆçš„æ–¹æ³•ã€‚ä½†è¯¥å»¶æœŸæœºåˆ¶å¤„ç†èµ·æ¥éžå¸¸å¤æ‚ã€‚å› ä¸ºå¤šä¸ªå¤„ç†å™¨å¯ä»¥åŒæ—¶ä¸”ç‹¬ç«‹åœ°å¤„ç†è½¯ä¸­æ–­ï¼Œ**åŒä¸€ä¸ªè½¯ä¸­æ–­çš„å¤„ç†ç¨‹åºä¾‹ç¨‹å¯ä»¥åœ¨å‡ ä¸ª `CPU` ä¸ŠåŒæ—¶è¿è¡Œ**ã€‚å¯¹è½¯ä¸­æ–­çš„æ•ˆçŽ‡æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³é”®ï¼Œå¤šå¤„ç†å™¨ç³»ç»Ÿä¸Šçš„ç½‘ç»œå®žçŽ°æ˜¾ç„¶å—æƒ äºŽæ­¤ã€‚ä½†**å¤„ç†ç¨‹åºä¾‹ç¨‹çš„è®¾è®¡å¿…é¡»æ˜¯å®Œå…¨å¯é‡å…¥ä¸”çº¿ç¨‹å®‰å…¨çš„**ã€‚å¦å¤–ï¼Œä¸´ç•ŒåŒºå¿…é¡»ç”¨è‡ªæ—‹é”ä¿æŠ¤ï¼ˆæˆ–å…¶ä»– IPC æœºåˆ¶ï¼Œå‚è§ç¬¬ 5 ç« ï¼‰ï¼Œè€Œè¿™éœ€è¦å¤§é‡å®¡æ…Žçš„è€ƒè™‘ã€‚

`tasklet` å’Œå·¥ä½œé˜Ÿåˆ—æ˜¯å»¶æœŸæ‰§è¡Œå·¥ä½œçš„æœºåˆ¶ï¼Œå…¶å®žçŽ°åŸºäºŽè½¯ä¸­æ–­ï¼Œä½†å®ƒä»¬æ›´æ˜“äºŽä½¿ç”¨ï¼Œå› è€Œæ›´é€‚åˆäºŽè®¾å¤‡é©±åŠ¨ç¨‹åºï¼ˆä»¥åŠå…¶ä»–ä¸€èˆ¬æ€§çš„å†…æ ¸ä»£ç ï¼‰ã€‚

> æœ‰ç‚¹ç±»ä¼¼ä¸Žçº¿ç¨‹æ± çš„æ¦‚å¿µâœ¨ï¼Œçº¿ç¨‹æ± çš„å¤§å°å°±æ˜¯ `ksoftirqd` çš„æ•°é‡ï¼Œä»»åŠ¡å°±æ˜¯ `tasklet` æˆ–è€… **å·¥ä½œé˜Ÿåˆ—**ï¼Œå•ä¸ªä»»åŠ¡ `tasklet` å¯èƒ½åœ¨ä»»æ„ä¸€ä¸ª `ksoftirqd` ä¸Šè¿è¡Œï¼Œä½†æ˜¯ä¸€ä¸ª `tasklet` åªèƒ½åœ¨ä¸€ä¸ª `ksoftirqd` ä¸Šè¿è¡Œã€‚`tasklet` ä¹Ÿä¼šç”¨ä¸€ä¸ªå•å‘é“¾è¡¨ `tasklet_vec` æ¥ç®¡ç†ï¼Œ~~æ¯æ¬¡ `ksoftirqd` å–ä»»åŠ¡æ—¶éƒ½éœ€è¦å¯¹è¯¥é˜Ÿåˆ—è¿›è¡ŒåŠ é”ä¿æŠ¤ã€‚~~

### æ•°æ®ç»“æž„

#### tasklet_struct

```c
// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L613
/* Tasklets --- multithreaded analogue of BHs.
   Properties:
   * If tasklet_schedule() is called, then tasklet is guaranteed
     to be executed on some cpu at least once after this.
   * If the tasklet is already scheduled, but its execution is still not
     started, it will be executed only once.
   * If this tasklet is already running on another CPU (or schedule is called
     from tasklet itself), it is rescheduled for later.
   * Tasklet is strictly serialized wrt itself, but not
     wrt another tasklets. If client needs some intertask synchronization,
     he makes it with spinlocks.
 */
struct tasklet_struct
{
        struct tasklet_struct *next;
        unsigned long state;
        atomic_t count;
        bool use_callback;
        union {
                void (*func)(unsigned long data);
                void (*callback)(struct tasklet_struct *t);
        };
        unsigned long data;
};
```

- `next` æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œç”¨äºŽå»ºç«‹ `tasklet_struct` å®žä¾‹çš„é“¾è¡¨ã€‚è¿™å®¹è®¸å‡ ä¸ªä»»åŠ¡æŽ’é˜Ÿæ‰§è¡Œã€‚

- `func` æŒ‡å‘ä¸€ä¸ªå‡½æ•°çš„åœ°å€ï¼Œè¯¥å‡½æ•°çš„æ‰§è¡Œå°†è¢«å»¶æœŸã€‚`data` ç”¨ä½œè¯¥å‡½æ•°æ‰§è¡Œæ—¶çš„å‚æ•°ã€‚

    >  `data` æ˜¯ `unsigned long` ç±»åž‹çš„ï¼Œæ‰€ä»¥æ³¨æ„å®ƒå¯èƒ½æ˜¯ä½œä¸ºæŒ‡é’ˆï¼ˆå€¼ä¸ºå†…å­˜åœ°å€ï¼‰æ¥ç”¨ï¼Œè€Œä¸æ˜¯å•çº¯çš„æ•°å­—ã€‚å†…æ ¸ä¸­ç»å¸¸è¿™æ ·ç”¨ã€‚

- `state` è¡¨ç¤ºä»»åŠ¡çš„å½“å‰çŠ¶æ€ï¼Œç±»ä¼¼äºŽçœŸæ­£çš„è¿›ç¨‹ã€‚ä½†åªæœ‰ä¸¤ä¸ªé€‰é¡¹ï¼Œåˆ†åˆ«ç”± `state` ä¸­çš„ä¸€ä¸ªæ¯”ç‰¹ä½è¡¨ç¤ºï¼Œè¿™ä¹Ÿæ˜¯äºŒè€…å¯ä»¥ç‹¬ç«‹è®¾ç½®/æ¸…é™¤çš„åŽŸå› ã€‚
    - åœ¨ `tasklet` æ³¨å†Œåˆ°å†…æ ¸ï¼Œç­‰å¾…è°ƒåº¦æ‰§è¡Œæ—¶ï¼Œå°†è®¾ç½® `TASKLET_STATE_SCHED`ã€‚
    - `TASKLET_STATE_RUN` è¡¨ç¤º `tasklet` å½“å‰æ­£åœ¨æ‰§è¡Œã€‚ç¬¬äºŒä¸ªçŠ¶æ€åªåœ¨ `SMP` ç³»ç»Ÿä¸Šæœ‰ç”¨ã€‚ç”¨äºŽä¿æŠ¤ `tasklet` åœ¨å¤šä¸ªå¤„ç†å™¨ä¸Šå¹¶è¡Œæ‰§è¡Œã€‚

- åŽŸå­è®¡æ•°å™¨ `count` ç”¨äºŽç¦ç”¨å·²ç»è°ƒåº¦çš„ `tasklet`ã€‚å¦‚æžœå…¶å€¼ä¸ç­‰äºŽ 0ï¼Œåœ¨æŽ¥ä¸‹æ¥æ‰§è¡Œæ‰€æœ‰å¾…å†³çš„ `tasklet` æ—¶ï¼Œå°†å¿½ç•¥å¯¹åº”çš„ `tasklet`ã€‚

è¿™ä¸ª `satat` ç”¨äºŽå¯¹ `tasklet` åŠ é”ã€‚

```c
// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L678
static inline int tasklet_trylock(struct tasklet_struct *t)
{
        return !test_and_set_bit(TASKLET_STATE_RUN, &(t)->state);
}

static inline void tasklet_unlock(struct tasklet_struct *t)
{
        smp_mb__before_atomic();
        clear_bit(TASKLET_STATE_RUN, &(t)->state);
}
```

### æ³¨å†Œ tasklet

`tasklet_schedule` å°†ä¸€ä¸ª `tasklet` æ³¨å†Œåˆ°ç³»ç»Ÿä¸­ã€‚æ›´å‡†ç¡®åœ°æ¥è¯´ï¼Œæ˜¯æ³¨å†Œåˆ°è°ƒç”¨ `tasklet_schedule` è¿™ä¸ªå‡½æ•°çš„ `core` ä¸­ã€‚æ¯ä¸ªæ ¸ä¼šç»´æŠ¤ä¸€ä¸ªé“¾è¡¨ `tasklet_vec`ï¼Œå®ƒçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª `tasklet_struct` å®žä¾‹ï¼Œè¡¨ç¤ºè¦æ‰§è¡Œçš„ä»»åŠ¡ `tasklet`ã€‚

`tasklet_schedule` ç”¨äºŽå°†æŒ‡å®šçš„ `tasklet` æ·»åŠ åˆ°é“¾è¡¨ `tasklet_vec` æœ«å°¾ã€‚

```c
// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L502
static DEFINE_PER_CPU(struct tasklet_head, tasklet_vec);
static DEFINE_PER_CPU(struct tasklet_head, tasklet_hi_vec);

// https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L685
static inline void tasklet_schedule(struct tasklet_struct *t)
{
        if (!test_and_set_bit(TASKLET_STATE_SCHED, &t->state))
                __tasklet_schedule(t);
}

// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L521
void __tasklet_schedule(struct tasklet_struct *t)
{
        __tasklet_schedule_common(t, &tasklet_vec,
                                  TASKLET_SOFTIRQ);
}

static void __tasklet_schedule_common(struct tasklet_struct *t,
                                      struct tasklet_head __percpu *headp,
                                      unsigned int softirq_nr)
{
        struct tasklet_head *head;
        unsigned long flags;

        local_irq_save(flags);
        head = this_cpu_ptr(headp);
        t->next = NULL;
        *head->tail = t;
        head->tail = &(t->next);
        raise_softirq_irqoff(softirq_nr); // å¼•èµ·ä¸€æ¬¡ TASKLET_SOFTIRQ è½¯ä¸­æ–­ï¼Œä»¥ä¾¿æ‰§è¡Œ tasklet
        local_irq_restore(flags);
}
```

> å…³äºŽ `tasklet_vec` å˜é‡ï¼Œé¦–å…ˆå®ƒæ˜¯ä¸€ä¸ª `per_cpu` å˜é‡ï¼Œæ¯ä¸ªæ ¸éƒ½ä¼šç»´æŠ¤è‡ªå·±çš„é“¾è¡¨ã€‚å…¶æ¬¡ï¼Œæ¯ä¸ªæ ¸ä¸Šçš„ä»»åŠ¡ `tasklet` åªèƒ½ç”±å®ƒè‡ªå·±å¤„ç†ï¼Œå…¶ä»–æ ¸ä¸ä¼šå¸®å¿™å¤„ç†ï¼Œå› æ­¤å¯èƒ½å°±ä¼šæ¶‰åŠåˆ°å¦‚ä½•åˆç†çš„åˆ†é… `tasklet`ã€‚
>
> æ­¤å¤–ï¼Œ`tasklet` æ‰§è¡Œå®Œæ¯•åŽæ˜¯å¦ä¼šä»Ž `tasklet_vec` ä¸Šç§»é™¤ï¼Ÿ

### æ‰§è¡Œ tasklet

`tasklet` çš„ç”Ÿå‘½å‘¨æœŸä¸­æœ€é‡è¦çš„éƒ¨åˆ†å°±æ˜¯å…¶æ‰§è¡Œã€‚å› ä¸º `tasklet` åŸºäºŽè½¯ä¸­æ–­å®žçŽ°ï¼Œå®ƒä»¬æ€»æ˜¯åœ¨å¤„ç†è½¯ä¸­æ–­æ—¶æ‰§è¡Œã€‚

`tasklet` å…³è”åˆ° `TASKLET_SOFTIRQ` è½¯ä¸­æ–­ã€‚å› è€Œï¼Œè°ƒç”¨ `raise_softirq(TASKLET_SOFTIRQ)`ï¼Œå³å¯åœ¨ä¸‹ä¸€ä¸ªé€‚å½“çš„æ—¶æœºæ‰§è¡Œå½“å‰å¤„ç†å™¨çš„ `tasklet`ã€‚å†…æ ¸ä½¿ç”¨ `tasklet_action` ä½œä¸ºè¯¥è½¯ä¸­æ–­çš„ `action` å‡½æ•°ã€‚

> è¿™ä¸ªå‡½æ•°ä¼šå– `tasklet_vec` é“¾è¡¨ä¸­çš„ `tasklet` ä¾æ¬¡æ‰§è¡Œ

```c
// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L636
open_softirq(TASKLET_SOFTIRQ, tasklet_action);
open_softirq(HI_SOFTIRQ, tasklet_hi_action);

// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L576
static __latent_entropy void tasklet_action(struct softirq_action *a)
{
        tasklet_action_common(a, this_cpu_ptr(&tasklet_vec), TASKLET_SOFTIRQ);
}

static void tasklet_action_common(struct softirq_action *a,
                                  struct tasklet_head *tl_head,
                                  unsigned int softirq_nr)
{
        struct tasklet_struct *list;

        // è¿™é‡Œæ¸…ç©ºäº† tasklet_vec é“¾è¡¨çš„ï¼Œç”¨ä¸´æ—¶å˜é‡ list æ¥è®¿é—® âœ¨
        // å› ä¸ºé¢„æœŸæ˜¯ä¼šå°†æ‰€æœ‰ tasklet æ‰§è¡Œçš„ï¼Œå¦‚æžœå‡ºçŽ°äº†æ„å¤–æƒ…å†µï¼Œå†æ·»åŠ å›žæ¥
        local_irq_disable();
        list = tl_head->head;
        tl_head->head = NULL;
        tl_head->tail = &tl_head->head;
        local_irq_enable();

        while (list) {
                // éåŽ†å•å‘é“¾è¡¨ï¼Œä¾æ¬¡æ‰§è¡Œ
                struct tasklet_struct *t = list;

                list = list->next;

                // è¿™ä¸ªåŠ é”ã€è§£é”ï¼Œå°±æ˜¯å‰é¢æåˆ°çš„ state æ ‡å¿—ä½çš„å¤„ç†
                // https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/interrupt.h#L678
                if (tasklet_trylock(t)) {
                        // åªæœ‰è¿™ä¸ªåŽŸå­è®¡æ•°ä¸º 0 æ—¶æ‰ä¼šç»§ç»­æ‰§è¡Œè¯¥ tasklet
                        if (!atomic_read(&t->count)) {
                                if (!test_and_clear_bit(TASKLET_STATE_SCHED,
                                                        &t->state))
                                        BUG();
                                // è°ƒç”¨ tasklet å¯¹åº”çš„å‡½æ•°æŒ‡é’ˆ
                                if (t->use_callback)
                                        t->callback(t);
                                else
                                        t->func(t->data);
                                tasklet_unlock(t);
                                // å¤„ç†å®Œå°±ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª tasklet
                                continue;
                        }
                        tasklet_unlock(t);
                }

                // åªæœ‰å½“ tasklet å·²ç»åœ¨å…¶ä»–æ ¸å¤„ç†äº†æ—¶ï¼ŒåŠ é”å¤±è´¥æ‰ä¼šåˆ°è¿™é‡Œã€‚
                local_irq_disable();
                t->next = NULL;
                *tl_head->tail = t;
                tl_head->tail = &t->next;
                __raise_softirq_irqoff(softirq_nr);
                local_irq_enable();
        }
}
```

**å› ä¸ºä¸€ä¸ª `tasklet` åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šæ‰§è¡Œä¸€æ¬¡ï¼Œä½†å…¶ä»–çš„ `tasklet` å¯ä»¥å¹¶è¡Œè¿è¡Œï¼Œæ‰€ä»¥éœ€è¦ç‰¹å®šäºŽ `tasklet` çš„é”**ã€‚ `state` çŠ¶æ€ç”¨ä½œé”å˜é‡ã€‚åœ¨æ‰§è¡Œä¸€ä¸ª `tasklet` çš„å¤„ç†ç¨‹åºå‡½æ•°ä¹‹å‰ï¼Œå†…æ ¸ä½¿ç”¨ `tasklet_trylock` æ£€æŸ¥ `tasklet` çš„çŠ¶æ€æ˜¯å¦ä¸º `TASKLET_STATE_RUN`ã€‚æ¢å¥è¯è¯´ï¼Œå®ƒæ˜¯å¦å·²ç»åœ¨ç³»ç»Ÿçš„å¦ä¸€ä¸ªå¤„ç†å™¨ä¸Šè¿è¡Œ

> ðŸ§ ðŸ§ è¿™é‡Œ `tasklet` ç”¨å®Œä¹‹åŽï¼Œæ²¡æœ‰é”€æ¯ `free` è¯¶ï¼Ÿä¸æ€•å†…å­˜æ³„æ¼å—ï¼Ÿ
>
> `tasklet` ä¸æ˜¯æ¯ä¸€ä¸ªæ ¸æ‰§è¡Œå®ƒè‡ªå·±çš„å—ï¼Ÿä¸ºä»€ä¹ˆä¼šæœ‰ä¸€ä¸ª `tasklet` å¯èƒ½åœ¨å…¶ä»–æ ¸ä¸Šé¢æ‰§è¡Œï¼Ÿ

### HI_SOFTIRQ

é™¤äº†æ™®é€šçš„ `tasklet` ä¹‹å¤–ï¼Œå†…æ ¸è¿˜ä½¿ç”¨äº†å¦ä¸€ç§ `tasklet`ï¼Œå®ƒå…·æœ‰â€œè¾ƒé«˜â€çš„ä¼˜å…ˆçº§ã€‚é™¤ä»¥ä¸‹ä¿®æ”¹ä¹‹å¤–ï¼Œå…¶å®žçŽ°ä¸Žæ™®é€šçš„ `tasklet` å®Œå…¨ç›¸åŒã€‚

1. ä½¿ç”¨ `HI_SOFTIRQ` ä½œä¸ºè½¯ä¸­æ–­ï¼Œè€Œä¸æ˜¯ `TASKLET_SOFTIRQ`ï¼Œç›¸å…³çš„ `action` å‡½æ•°æ˜¯ `tasklet_hi_action`ã€‚

2. æ³¨å†Œçš„ `tasklet` åœ¨ CPU ç›¸å…³çš„å˜é‡ `tasklet_hi_vec` ä¸­æŽ’é˜Ÿã€‚è¿™æ˜¯ä½¿ç”¨ `tasklet_hi_schedule` å®Œæˆçš„ã€‚

åœ¨è¿™é‡Œï¼Œâ€œè¾ƒé«˜ä¼˜å…ˆçº§â€æ˜¯æŒ‡è¯¥è½¯ä¸­æ–­çš„å¤„ç†ç¨‹åº `HI_SOFTIRQ` åœ¨æ‰€æœ‰å…¶ä»–å¤„ç†ç¨‹åºä¹‹å‰æ‰§è¡Œï¼Œ**å°¤å…¶æ˜¯åœ¨æž„æˆäº†è½¯ä¸­æ–­æ´»åŠ¨ä¸»ä½“çš„ç½‘ç»œå¤„ç†ç¨‹åºä¹‹å‰æ‰§è¡Œ**ã€‚

> æ‰€æœ‰è½¯ä¸­æ–­å…¶å®žæœ¬è´¨ä¸Šéƒ½æ˜¯ç”± `ksoftirqd` å†³å®šçš„è¾ƒä½Žä¼˜å…ˆçº§ï¼Œåªä¸è¿‡ä¸åŒç±»åž‹çš„è½¯ä¸­æ–­ä¹‹é—´ï¼Œä¼˜å…ˆçº§ç•¥æœ‰åŒºåˆ«ï¼ŒæŒ‰é¡ºåºæ‰§è¡Œè€Œå·²ã€‚è¿™é‡Œè¯´çš„è¾ƒé«˜ä¼˜å…ˆçº§ä¹Ÿä»…ä»…æ˜¯è¿™ä¸ªæ„æ€ã€‚æ¯•ç«Ÿ `HI_SOFTIRQ` æ˜¯æ‰€æœ‰è½¯ä¸­æ–­ä¸­ä¼˜å…ˆçº§æœ€é«˜çš„äº†ã€‚ðŸ›«ðŸ›«è€Œä¸”è½¯ä¸­æ–­çš„ä¸»è¦å¼€é”€å°±æ˜¯å¤„ç†ç½‘ç»œæ”¶å‘åŒ…ï¼Œåªè¦ä¼˜å…ˆçº§æ¯”ç½‘ç»œæ”¶å‘åŒ…é«˜ï¼Œå°±èƒ½å¤Ÿå¾ˆå¿«åœ°æ‰§è¡Œäº†ã€‚

å½“å‰ï¼Œå¤§éƒ¨åˆ†å£°å¡é©±åŠ¨ç¨‹åºéƒ½åˆ©ç”¨äº†è¿™ä¸€é€‰é¡¹ï¼Œå› ä¸ºæ“ä½œå»¶è¿Ÿæ—¶é—´å¤ªé•¿å¯èƒ½æŸå®³éŸ³é¢‘è¾“å‡ºçš„éŸ³è´¨ã€‚**è€Œç”¨äºŽé«˜é€Ÿä¼ è¾“çš„ç½‘å¡ä¹Ÿå¯ä»¥å¾—ç›ŠäºŽè¯¥æœºåˆ¶**ã€‚

> ðŸ˜®ðŸ˜®ä¸§å¿ƒç—…ç‹‚äº†å§ï¼Œç½‘ç»œæ”¶å‘åŒ…çš„ä¼˜å…ˆçº§æœ¬æ¥å°±ä»…æ¬¡äºŽ `HI`ã€`TIMER`ï¼Œè¿™éƒ½è¿˜è¦æ¥æŠ¢ `HI` ï¼Ÿ

ç®€å•çœ‹çœ‹ä»£ç ï¼Œåªèƒ½å’Œä¸Šé¢è¯´ä¸€æ¨¡ä¸€æ ·âœ¨âœ¨å°±ä¼˜å…ˆå¤„ç†äº†è€Œå·²ã€‚

```c
// https://elixir.bootlin.com/linux/v5.10.186/source/kernel/softirq.c#L581
static __latent_entropy void tasklet_hi_action(struct softirq_action *a)
{
        tasklet_action_common(a, this_cpu_ptr(&tasklet_hi_vec), HI_SOFTIRQ);
}
```

### å°ç»“

- ä¸€ç§ç‰¹å®šç±»åž‹çš„ `tasklet` åªèƒ½è¿è¡Œåœ¨ä¸€ä¸ª `CPU` ä¸Šï¼Œä¸èƒ½å¹¶è¡Œï¼Œåªèƒ½ä¸²è¡Œæ‰§è¡Œã€‚
- å¤šä¸ªä¸åŒç±»åž‹çš„ `tasklet` å¯ä»¥å¹¶è¡Œåœ¨å¤šä¸ª `CPU` ä¸Šã€‚
- è½¯ä¸­æ–­æ˜¯é™æ€åˆ†é…çš„ï¼Œåœ¨å†…æ ¸ç¼–è¯‘å¥½ä¹‹åŽï¼Œå°±ä¸èƒ½æ”¹å˜ã€‚ä½† `tasklet` å°±çµæ´»è®¸å¤šï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶æ”¹å˜ï¼ˆæ¯”å¦‚æ·»åŠ æ¨¡å—æ—¶ï¼‰ã€‚
- è½¯ä¸­æ–­ä¸­ä¸å…è®¸ç¡çœ ï¼Œè€Œ `tasklet` åŒæ ·æ˜¯åœ¨è½¯ä¸­æ–­ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œçš„ï¼Œå› æ­¤åŒæ ·ä¸å…è®¸ç¡çœ ã€‚è€Œä¸‹æ–‡æ‰€æåˆ°çš„**å·¥ä½œé˜Ÿåˆ—**æ˜¯å…è®¸ç¡çœ çš„ã€‚

## å®Œæˆé‡

å®Œæˆé‡ä¸Žä¿¡å·é‡æœ‰äº›ç›¸ä¼¼ï¼Œä½†æ˜¯åŸºäºŽç­‰å¾…é˜Ÿåˆ—å®žçŽ°çš„ã€‚

## å·¥ä½œé˜Ÿåˆ—

> å·¥ä½œé˜Ÿåˆ—å…¶å®žå’Œ `ksoftirqd + tasklet` ç±»ä¼¼ï¼Œä¸è¿‡å®ƒä¸æ˜¯å·¥ä½œåœ¨è½¯ä¸­æ–­çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè€Œæ˜¯æ™®é€šçš„å†…æ ¸çº¿ç¨‹ã€‚æ­¤å¤–è¿›ç¨‹çš„æ•°é‡ä¹Ÿä¸åœ¨å±€é™äºŽ `core` çš„æ•°é‡ï¼Œå‡ ä¹Žå¯ä»¥ä»»æ„åˆ›å»ºã€‚è¿›ç¨‹åä»¥ `kworker` ä¸ºå‰ç¼€ï¼
>
> å…¶å®žè¿˜æ˜¯å’Œçº¿ç¨‹æ± çš„åŽŸç†ç›¸ä¼¼çš„ã€‚

å·¥ä½œé˜Ÿåˆ—æ˜¯å¦å¤–ä¸€ä¸ªå¤„ç†å»¶åŽå‡½æ•°çš„æ¦‚å¿µï¼Œå®ƒå¤§ä½“ä¸Šå’Œ `tasklets` ç±»ä¼¼ã€‚å·¥ä½œé˜Ÿåˆ—è¿è¡ŒäºŽå†…æ ¸è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œè€Œ `tasklets` è¿è¡ŒäºŽè½¯ä¸­æ–­ä¸Šä¸‹æ–‡ã€‚è¿™æ„å‘³ç€å·¥ä½œé˜Ÿåˆ—å‡½æ•°ä¸å¿…åƒ `tasklets` ä¸€æ ·å¿…é¡»æ˜¯åŽŸå­æ€§çš„ã€‚`Tasklets` æ€»æ˜¯è¿è¡ŒäºŽå®ƒæäº¤è‡ªçš„é‚£ä¸ªå¤„ç†å™¨ï¼Œå·¥ä½œé˜Ÿåˆ—åœ¨é»˜è®¤æƒ…å†µä¸‹ä¹Ÿæ˜¯è¿™æ ·ã€‚å·¥ä½œé˜Ÿåˆ—åœ¨ `Linux` å†…æ ¸ä»£ç  [kernel/workqueue.c](https://elixir.bootlin.com/linux/v5.10.186/source/kernel/workqueue.c#L200) ä¸­ç”±å¦‚ä¸‹çš„æ•°æ®ç»“æž„è¡¨ç¤ºï¼š

```c
struct pool_workqueue {
        struct worker_pool      *pool;          /* I: the associated pool */
        struct workqueue_struct *wq;            /* I: the owning workqueue */
        int                     work_color;     /* L: current color */
        int                     flush_color;    /* L: flushing color */
        int                     refcnt;         /* L: reference count */
        int                     nr_in_flight[WORK_NR_COLORS];
                                                /* L: nr of in_flight works */
        int                     nr_active;      /* L: nr of active works */
        int                     max_active;     /* L: max active works */
        struct list_head        inactive_works; /* L: inactive works */
        struct list_head        pwqs_node;      /* WR: node on wq->pwqs */
        struct list_head        mayday_node;    /* MD: node on wq->maydays */

        /*
         * Release of unbound pwq is punted to system_wq.  See put_pwq()
         * and pwq_unbound_release_workfn() for details.  pool_workqueue
         * itself is also RCU protected so that the first pwq can be
         * determined without grabbing wq->mutex.
         */
        struct work_struct      unbound_release_work;
        struct rcu_head         rcu;
} __aligned(1 << WORK_STRUCT_FLAG_BITS);
```

å·¥ä½œé˜Ÿåˆ—æœ€åŸºç¡€çš„ç”¨æ³•ï¼Œæ˜¯ä½œä¸ºåˆ›å»ºå†…æ ¸çº¿ç¨‹çš„æŽ¥å£æ¥å¤„ç†æäº¤åˆ°é˜Ÿåˆ—é‡Œçš„å·¥ä½œä»»åŠ¡ã€‚æ‰€æœ‰è¿™äº›å†…æ ¸çº¿ç¨‹ç§°ä¹‹ä¸º `worker thread`ã€‚å·¥ä½œé˜Ÿåˆ—å†…çš„ä»»åŠ¡æ˜¯ç”±ä»£ç  [include/linux/workqueue.h](https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/workqueue.h#L102) ä¸­å®šä¹‰çš„ `work_struct` è¡¨ç¤ºçš„ï¼Œå…¶å®šä¹‰å¦‚ä¸‹ï¼š

```c
struct work_struct {
        atomic_long_t data;
        struct list_head entry;
        work_func_t func;
#ifdef CONFIG_LOCKDEP
        struct lockdep_map lockdep_map;
#endif
};
```

è¿™é‡Œæœ‰ä¸¤ä¸ªå­—æ®µæ¯”è¾ƒæœ‰æ„æ€ï¼š`func` --å°†è¢«å·¥ä½œé˜Ÿåˆ—è°ƒåº¦æ‰§è¡Œçš„å‡½æ•°ï¼Œ`data` --è¿™ä¸ªå‡½æ•°çš„å‚æ•°ã€‚

> ä¸ºä»€ä¹ˆå†…æ ¸ä½¿ç”¨ `atomic_long_t` ä½œä¸ºæŒ‡å‘ä»»æ„æ•°æ®çš„æŒ‡é’ˆçš„æ•°æ®ç±»åž‹ï¼Œè€Œä¸æ˜¯é€šå¸¸çš„ `void *`ï¼Ÿ
>
> è¿™é‡Œå†…æ ¸ä½¿ç”¨äº†ä¸€ç‚¹å°æŠ€å·§ï¼Œæ˜¾ç„¶æœ‰ç‚¹è¿‘ä¹ŽäºŽâ€œè‚®è„â€ï¼Œä»¥ä¾¿å°†æ›´å¤šä¿¡æ¯æ”¾å…¥è¯¥ç»“æž„ï¼Œè€Œåˆä¸ä»˜å‡ºæ›´å¤šä»£ä»·ã€‚å› ä¸ºæŒ‡é’ˆåœ¨æ‰€æœ‰æ”¯æŒçš„ä½“ç³»ç»“æž„ä¸Šéƒ½å¯¹é½åˆ° 4 å­—èŠ‚è¾¹ç•Œï¼Œè€Œå‰ä¸¤ä¸ªæ¯”ç‰¹ä½ä¿è¯ä¸º 0ã€‚å› è€Œå¯ä»¥â€œæ»¥ç”¨â€è¿™ä¸¤ä¸ªæ¯”ç‰¹ä½ï¼Œå°†å…¶ç”¨ä½œæ ‡å¿—ä½ã€‚å‰©ä½™çš„æ¯”ç‰¹ä½ç…§æ—§ä¿å­˜æŒ‡é’ˆçš„ä¿¡æ¯ã€‚ä»¥ä¸‹çš„å®ç”¨äºŽå±è”½æ ‡å¿—ä½ï¼š
>
> ```c
> // https://elixir.bootlin.com/linux/v5.10.186/source/include/linux/workqueue.h#L90
> WORK_STRUCT_FLAG_MASK = (1UL << WORK_STRUCT_FLAG_BITS) - 1,
> WORK_STRUCT_WQ_DATA_MASK = ~WORK_STRUCT_FLAG_MASK,
> ```
>
> å½“å‰åªå®šä¹‰äº†ä¸€ä¸ªæ ‡å¿—ï¼š`WORK_STRUCT_PENDING` ç”¨æ¥æŸ¥æ‰¾å½“å‰æ˜¯å¦æœ‰å¾…å†³ï¼ˆè¯¥æ ‡å¿—ä½ç½®ä½ï¼‰çš„å¯å»¶è¿Ÿå·¥ä½œé¡¹ã€‚è¾…åŠ©å® `work_pending(work)`ç”¨æ¥æ£€æŸ¥è¯¥æ ‡å¿—ä½ã€‚è¯·æ³¨æ„ï¼Œå°† `data` è®¾ç½®ä¸ºåŽŸå­æ•°æ®ç±»åž‹ï¼Œç¡®ä¿å¯¹è¯¥æ¯”ç‰¹ä½çš„ä¿®æ”¹ä¸ä¼šå¸¦æ¥å¹¶å‘é—®é¢˜ã€‚

### å°ç»“



## å‚è€ƒèµ„æ–™

- â­â­ðŸ”¥ðŸ”¥ã€Šæ·±å…¥ Linux å†…æ ¸æž¶æž„ã€‹ç¬¬ 14 ç« ï¼Œä¹¦è®²å¾—æ›´å¥½ä¸€äº›ï¼Œä¸‹é¢çš„å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚
- â­â­ðŸ”¥ðŸ”¥[ã€ŠLinux å†…æ ¸æ­ç§˜ã€‹](https://github.com/MintCN/linux-insides-zh/blob/master/Interrupts/README.md) è¿™æœ¬ä¹¦è®²å¾—ä¹Ÿå¾ˆå¥½ï¼Œè€Œä¸”æ›´è´´è¿‘ä»£ç è®²è§£ã€‚
- [ä»€ä¹ˆæ˜¯è½¯ä¸­æ–­](https://www.xiaolincoding.com/os/1_hardware/soft_interrupt.html#%E4%B8%AD%E6%96%AD%E6%98%AF%E4%BB%80%E4%B9%88)
- [Linux å†…æ ¸ä¸­çš„è½¯ä¸­æ–­ã€tasklet å’Œå·¥ä½œé˜Ÿåˆ—è¯¦è§£](https://zhuanlan.zhihu.com/p/265705850)
- [ç†è§£å†…æ ¸çš„ç¡¬è½¯ä¸­æ–­ï¼ˆè¯¦ç»†è®²è§£~ï¼‰](https://www.toutiao.com/article/7153606983776731651/?wid=1693292862137)
